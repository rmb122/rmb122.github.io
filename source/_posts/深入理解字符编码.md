---
title: æ·±å…¥ç†è§£å­—ç¬¦ç¼–ç 
date: 2019-08-06 16:13:47
tags: [misc]
---

ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾.  

<!--more-->

## unicode

å…¶å®è¿™æ˜¯æœ€ç®€å•çš„, unicode å°±æ˜¯ä¸€å¥—æ ‡å‡†, æŠŠä¸–ç•Œä¸Šæ¯ä¸ªå­˜åœ¨çš„å­—ç¬¦ (ç”šè‡³åŒ…æ‹¬ emoji) éƒ½ç¼–ä¸€ä¸ªå·, å¯ä»¥åœ¨ https://unicode-table.com/cn/ çœ‹åˆ°å…¨éƒ¨çš„ç¼–ç ,  
æŠŠè¿™ä¸ªç¼–çš„å·, ä¸€èˆ¬å«åš code point, ä¹Ÿå°±æ˜¯ç ç‚¹. åŒæ—¶ä¹Ÿè®¾å®šäº†å‡ ä¸ªç¼–ç çš„æ ‡å‡†, ä¹Ÿå°±æ˜¯ UTF-8, UTF-16 ç­‰ç­‰, æ¯•ç«Ÿç›´æ¥æŠŠç ç‚¹è½¬äºŒè¿›åˆ¶å¤ªæµªè´¹ç©ºé—´äº†.  

è€Œè¿™äº›ç¼–ç , å°±æ˜¯æŠŠè¿™äº›ç ç‚¹ä¿å­˜ä¸ºè®¡ç®—æœºå¯ä»¥è¯†åˆ«çš„äºŒè¿›åˆ¶å½¢å¼.  

## UTF-8

UTF-8 å°±æ˜¯è¿™äº›ç¼–ç çš„ä¸€ç§, è¯¦ç»†å¯ä»¥å‚è€ƒ[ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/UTF-8), ç®€å•æ¥è¯´, å°±æ˜¯æŠŠç ç‚¹è½¬ä¸ºäºŒè¿›åˆ¶å,  
ç„¶åä¸ºäº†èŠ‚çœç©ºé—´, æŠŠä¸åŒå¤§å°çš„ç ç‚¹è½¬ä¸ºä¸åŒé•¿åº¦çš„å­—èŠ‚åºåˆ—, è¿™å°±æ˜¯ä»–å¤©æ‰çš„åœ°æ–¹, ç”¨å˜é•¿ç¼–ç æ¥èŠ‚çœé•¿åº¦.  

è¿™é‡Œä»¥ `å•Š` ä¸ºä¾‹, å®ƒçš„ç ç‚¹æ˜¯ `0x554a`, åœ¨ `U+0800~U+FFFF` çš„èŒƒå›´å†…, äºŒè¿›åˆ¶æ˜¯ `0b101010101001010`,  
é‚£ä¹ˆæ ¹æ®å®šä¹‰, ä»–çš„ä¿å­˜æ–¹å¼æ˜¯ `1110xxxx 10xxxxxx 10xxxxxx`, æˆ‘ä»¬å°†è¿™ä¸ªç ç‚¹çš„äºŒè¿›åˆ¶ä»¥å¤§ç«¯çš„æ–¹å¼å¡«å…¥å…¶ä¸­,  
å¾—åˆ° `1110|0101 10|010101 10|001010`, ä¹Ÿå°±æ˜¯ `b'\xe5\x95\x8a'`, å¯ä»¥å°è¯•åœ¨ python è§£ç , å¾—åˆ°çš„å°±æ˜¯ `å•Š`.  

è€Œåœ¨ `0x00 ~ 0xFF` èŒƒå›´å†…, UTF-8 å…¶å®å°±è¢«é€€åŒ–ä¸º ASCII äº†, ä¸€æ˜¯ä¸ºäº†å…¼å®¹æ€§, äºŒæ˜¯ç¡®å® ASCII æ‰€æ¶µç›–çš„ç¬¦å·, ç¡®å®ç”¨çš„éå¸¸å¤š.  
è¿™é‡Œå¯ä»¥æ‰‹åŠ¨å†™ä¸€äº› UTF-8 çš„å‡½æ•°æ¥åŠ æ·±å­¦ä¹ , å› ä¸ºæ˜¯å˜é•¿çš„, æ‰€ä»¥æ¥ç®—é•¿åº¦, ä»¥åŠæˆªå–ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦.  
è¿™é‡Œç”¨æˆ‘ç”¨ c å†™, æ„Ÿè§‰éå¸¸çš„çˆ½, å°±åƒåœ¨é«˜é€Ÿå…¬è·¯ä¸Šé£™è½¦, æ§åˆ¶ä¸å¥½å°±ä¼šç¿»è½¦ (Segment fault) 233, ä½†æ˜¯ç¡®å®æ˜¯æœ€æ¥è¿‘è¿™äº›å­—ç¬¦ç¼–ç æœ¬æ¥çš„æ ·å­.  
æ²¡æœ‰äº† python ä¸Šå„ç§çš„åŒ…è£….  

```c
#include <stdio.h>
#include <stdlib.h>
#include <memory.h>

char* read_file(char *filename) {
    FILE *fd = fopen(filename, "r");

    fseek(fd, 0, SEEK_END);
    long sz = ftell(fd);
    fseek(fd, 0, SEEK_SET);

    char *content = malloc(sizeof(char) * sz);
    fread(content, sizeof(char), sz, fd);

    fclose(fd);
    return content;
}

int utf8_strlen(char *s) {
    int length = 0;

    while (*s) {
        if ((*s & 0b11000000) != 0b10000000) {
            length += 1;
        }
        s++;
    }
    return length;
}

char* codepoint_to_utf8(unsigned int codepoint, int *sz) {
    char *s;
    if (codepoint < 0x80) {
        *sz = 1;
        s = malloc(sizeof(char));
        *s = codepoint;
    } else if (codepoint < 0x800) {
        *sz = 2;
        s = malloc(sizeof(char) * 2);
        *(s + 1) = 0b10000000 | (codepoint & 0b00111111);
        *s = 0b11000000 | ((codepoint >> 6) & 0b00011111);
    } else if (codepoint < 0x10000) {
        *sz = 3;
        s = malloc(sizeof(char) * 3);
        *(s + 2) = 0b10000000 | (codepoint & 0b00111111);
        *(s + 1) = 0b10000000 | ((codepoint >> 6) & 0b00111111);
        *s = 0b11100000 | ((codepoint >> 12) & 0b00001111);
    } else {
        *sz = 4;
        s = malloc(sizeof(char) * 4);
        *(s + 3) = 0b10000000 | (codepoint & 0b00111111);
        *(s + 2) = 0b10000000 | ((codepoint >> 6) & 0b00111111);
        *(s + 1) = 0b10000000 | ((codepoint >> 12) & 0b00111111);
        *s = 0b11110000 | ((codepoint >> 18) & 0b00000111);
    }
    return s;
}

int get_tail_length(char c) {
    int length = 0;
    if ((c & 0b11111000) == 0b11110000) {
        length = 3;
    } else if ((c & 0b11110000) == 0b11100000) {
        length = 2;
    } else if ((c & 0b11100000) == 0b11000000) {
        length = 1;
    }
    return length;
}

char* utf8_substr(char* s, int start, int length) {
    int curr_pos = 0;
    int byte_count = 0;
    int offset = 0;
    char *new_s;

    while (curr_pos < start && *s) {
        if ((*s & 0b11000000) != 0b10000000) {
            curr_pos += 1;
        }
        s += (get_tail_length(*s) + 1);
    }

    curr_pos = 0;
    while (curr_pos < length && *s) {
        if ((*s & 0b11000000) != 0b10000000) {
            curr_pos += 1;
        }
        s++;
        byte_count++;
    }

    if (curr_pos > 0) {
        offset = get_tail_length(*(s - 1));

        new_s = malloc(sizeof(char) * (byte_count + offset + 1));
        memcpy(new_s, s - byte_count, byte_count + offset);
        new_s[byte_count + offset] = '\0';
    } else {
        new_s = NULL;
    }
    return new_s;
}

int utf8_to_codepoint(char *s) {
    int length = 0;
    int codepoint = 0;

    if ((*s & 0b11111000) == 0b11110000) {
        length = 4;
        codepoint = *s & 0b111;
    } else if ((*s & 0b11110000) == 0b11100000) {
        length = 3;
        codepoint = *s & 0b1111;
    } else if ((*s & 0b11100000) == 0b11000000) {
        length = 2;
        codepoint = *s & 0b11111;
    } else {
        length = 1;
        codepoint = *s;
    }
    for (int i = 1; i < length; i++) {
        s++;
        codepoint <<= 6;
        codepoint = codepoint | (*s & 0b00111111);
    }
    return codepoint;
}

int main() {
    /*
    char *content = read_file("/home/rmb122/temp/example.txt");
    printf("%d", utf8_strlen(content));

    free(content);
     */

    printf("%d\n", utf8_strlen("ä¸€äºŒä¸‰å››äº”å…­ä¸€äºŒä¸‰å››äº”å…­1234"));

    char *s;
    int sz;

    s = codepoint_to_utf8(21834, &sz);
    printf("%.*s\n", sz, s);
    free(s);

    s = utf8_substr("ä¸€2ä¸‰å››5å…­7å…«9", 1, 1);
    if (s) {
        printf("%s\n", s);
    } else {
        printf("%s", "null");
    }
    free(s);

    printf("%d\n", utf8_to_codepoint("äº”"));
    return 0;
}
```

## UTF-16

è¯´å®è¯, æˆ‘è§‰å¾— UTF-16 å·²ç»å¯ä»¥è¢«æ‰”è¿›å†å²çš„åƒåœ¾æ¡¶, ç„¶è€Œ `Windows` è¿˜ä¾ç„¶ä½¿ç”¨ 233.  
ä»–æœ¬èº«æ˜¯ä¸ºäº†ä¿è¯å›ºå®šé•¿åº¦è€Œè®¾è®¡çš„, å› ä¸ºä¸¤ä¸ªå­—èŠ‚ 256*256, å¯ä»¥è¡¨ç¤º 65536 ç§å­—ç¬¦,  
åœ¨ä»¥å‰ unicode æ”¶å½•å­—ç¬¦æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹æ˜¯å®Œå…¨å¤Ÿçš„, è¿™æ ·æ¯ä¸ªå­—ç¬¦éƒ½ä¿å­˜ä¸ºä¸¤ä¸ªå­—èŠ‚é•¿,  
å¯ä»¥èŠ‚çœè¿ç®—, è™½ç„¶æµªè´¹äº†æŒºå¤šçš„ç©ºé—´, ä½†æ˜¯ç¡®å®å¾ˆæ–¹ä¾¿.  

ç„¶è€Œç°åœ¨ä¸Šé¢çš„ç½‘ç«™ä¸Šçœ‹åˆ°,  unicode æ”¶å½•çš„å­—ç¬¦æ—©å·²è¶…è¿‡äº† 65536 ä¸ª, ä¹Ÿå°±æ„å‘³ç€ç ç‚¹è¶…è¿‡äº† `0xFFFF`.  
è¿™é‡Œä»¥ `ğ ` è¿™ä¸ªå­—ç¬¦ä¸ºä¾‹  
```python
>>> "å•Š".encode('utf-16be')
b'UJ'
>>> "ğ ".encode('utf-16be')
b'\xd8\x00\xdf\xa0'
```
å¯ä»¥çœ‹åˆ°, å®é™…ä¸Šä¿å­˜è¿™ä¸ªå­—ç¬¦ç”¨äº† 4 ä¸ªå­—èŠ‚. å†å²çš„å‘å±•ä½¿å¾— UTF-16 å”¯ä¸€çš„å¥½å¤„å·²ç»è¡ç„¶æ— å­˜.  
è€Œä¸”ä¸ºäº†ä¿å­˜å¤§ç«¯å°ç«¯çš„é¢å¤–ä¿¡æ¯, è¿˜ç”¨äº† `BOM` è¿™ç§ä¸‘é™‹çš„è®¾è®¡, å¸Œæœ› `Windows` ä¹Ÿèƒ½æ—©ç‚¹æ·˜æ±°æ‰ UTF-16 æŠŠ 233

## GBK

è¿™ä¸ªæ˜¯æˆ‘å›½è‡ªåˆ›çš„ç¼–ç æ ‡å‡†, ä¼˜ç‚¹éå¸¸æ˜æ˜¾, èŠ‚çœç©ºé—´, ç›¸å½“äºç¼©å°ç‰ˆçš„ UTF-8 (å½“ç„¶ç”¨çš„ç ç‚¹è¡¨å’Œå…·ä½“å®ç°è·Ÿ unicode ä¸åŒ),  
å› ä¸ºå®ƒåªéœ€è¦è¡¨è¾¾ ASCII + æ±‰å­—çš„å­—ç¬¦ç©ºé—´å°±å¤Ÿäº†. å½“ç„¶ç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾, ä¸èƒ½è¡¨è¾¾ ASCII + æ±‰å­—ä¹‹å¤–çš„å­—ç¬¦, ä¹Ÿå°±æ³¨å®šåªèƒ½åœ¨ä¸­å›½ä½¿ç”¨,  
æ— æ³•å›½é™…åŒ–, è€Œä¸”å®é™…ä¸Šå¾ˆå¤šå›½å®¶éƒ½æœ‰ä¸€å¥—è‡ªåˆ›å­—ç¬¦é›†, è¿™æ›´ä¿ƒè¿›äº† unicode çš„è¯ç”Ÿ. 
