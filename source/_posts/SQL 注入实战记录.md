---
title: "SQL 注入实战记录"
date: 2018-11-07 21:35:26
tags: [web]
---

第一次算是独立完完整整用 SQL 注入搞下来一个站, 过程还是非常曲折的, 从希望到绝望到希望, 最后用比较猥琐的方式注入进去.  

<!-- more -->

所以来写个记录吧 233 一开始自然先是扫描器伺候, 毕竟要是万一找到一个备份就会轻松很多, 当然最后结果是啥都没有 233 剩下的因为没有账号密码登录进去, 任意文件下载, 上传等等自然也是不存在的, 于是剩下的只有 SQL 注入了, 先从最明显的开始  

![](https://i.loli.net/2019/03/08/5c827ce5927f7.jpg)  

fuzz 了一下, 居然直接返回了错误的 SQL 语句, 这对我们接下来的注入有非常的帮助,  

![](https://i.loli.net/2019/03/08/5c827ceab5aaa.jpg)  

同时也可以看出来, `username` 是开了 `addslashes` 的, 但是 `ix_select` 并没有开引号过滤, 所以我们下一个目标就是他了, 尝试用 `' or 1=1 %23`  来尝试一下能否布尔注入, 但是  

![](https://i.loli.net/2019/03/08/5c827cefa5720.jpg)  

等待我们的却依然是一个错误, 当时我的表情  

![](https://i.loli.net/2019/03/08/5c827cf63a52c.jpg)  

缓过神来发现, `FROM` 后面是空的, 怪不得出现错误, 猜测后台是用 `ix_select` 从一个数组里面取出一个表名后再运行 sql 语句, 所以用 `ix_select` 注入是不行的, 会导致原本的语句出错. 继续寻找下一个目标, 发现一个搜索页   

![](https://i.loli.net/2019/03/08/5c827cfa55678.jpg)  

尝试注入  

![](https://i.loli.net/2019/03/08/5c827cfe30b29.jpg)  

又是没有过滤, 惊了, 这个居然都不过滤, 尝试用 `sqlmap` 直接布尔注入, 如果注入结果为真, 将会返回 `7条记录`, 为假, 返回 `0条记录`  

![](https://i.loli.net/2019/03/08/5c827d05985ae.jpg)  

注入成功, 能读取数据库名和版本号~ 但是正当我兴奋以为拿下一血时, 现实却打了我一个狠狠的脸, 不能正常 `SELECT` 数据, 连 `SELECT` 一个 `1` 也不行, 肿么肥事! 赶紧打开 `wireshark` 看看出了啥幺蛾子  

![](https://i.loli.net/2019/03/08/5c827d09a8e41.jpg)  

SQL 语句居然是错误的, 然而仔细看看, 明明没有错误(毕竟工具自动生成的), 而且除了 `SELECT` 以外, 其他的函数都可以用, 比如 `rand()`, 都能正常输出结果. 我突然想起来, 看了下版本  

![](https://i.loli.net/2019/03/08/5c827d0e83875.jpg)  

卧槽... `4.0.15`, 我马上去官网上翻了一下  

![](https://i.loli.net/2019/03/08/5c827d12d36f4.jpg)  

连归档中的最远古版本都是 `5.0.15`... 可想而知这个 `4.0.15` 是多老的版本, 估计不支持这种多重 `SELECT`  查询, 看来不能用布尔注入了 尝试了下 `UNION SELECT`, 居然能用, 看来还有希望, 但是上面和这个都无法使用, 因为要满足 `count(*)`, 只能有一列, 而下面从数据库中查表依然用的同一个参数, 查出来肯定不止一列. 所以只能满足 `count(*)` 和查信息这两个语句中的一个, 无法同时满足, 只能寻找下一个可能的注入点.  

![](https://i.loli.net/2019/03/08/5c827d185e8e3.jpg)  

中间经历了很多尝试, 发现很多很上面一样的地方, 要么不能注入, 要么就是不能布尔注入. 最后找了半天, 终于在一个猥琐的地方找到一个注入点  

![](https://i.loli.net/2019/03/08/5c827d1b7bd2b.jpg)  
![](https://i.loli.net/2019/03/08/5c827d22bff4b.jpg)  

先看看 SQL 语句, 因为不能多重 `SELECT` 的关系, 所以我们只能用 `UNION SELECT` 了 这里猜测后台从表中读取数据, 并比对数据库中的问题和答案是否与提交的相同, 所以这里可以用 `UNION SELECT` 伪造数据来找回密码, 先爆破列长度  

![](https://i.loli.net/2019/03/08/5c827d281f1aa.jpg)  

这里其实已经通过后台的逻辑了, 但是 `gbk` 真是太蛋疼了...  

![](https://i.loli.net/2019/03/08/5c827d2cf267a.jpg)  

因为从数据库取出的答案密码是我们伪造的 1 和 1 , 与我们提交的相同, 所以取回了密码 (而且居然真的是取回而不是重置密码), 但是我们同时我们得到的密码也是我们伪造 的 1, 所以我们要先确定回显的位置  

![](https://i.loli.net/2019/03/08/5c827d327d87f.jpg)  

然后测试一下从表中取出数据,  

![](https://i.loli.net/2019/03/08/5c827d379338a.jpg)  

Nice! 但是比较蛋疼的是 `Mysql` 版本太老连 `information_schema` 都没有, 密码列名只好稍微手工爆破一下, 最后测出来是 `userpass`, 还好算是比较常见的... 不然就凉了  

![](https://i.loli.net/2019/03/08/5c827d3c538f4.jpg)  

然后我们得到了... 密码的明文, 太真实了, 居然没有 `hash`, 也算节省一点工作量, 不管怎样管理员密码 GET DAZE~ 这就是注入全过程, 之后登录后台上传 `webshell`(还是师傅找到地方传的 233)、脱裤, 都是老套路不说了 233