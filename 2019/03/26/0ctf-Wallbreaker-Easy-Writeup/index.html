<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>0ctf Wallbreaker Easy Writeup - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文首发于先知
周末打了两天, 自闭 web 狗就做出来这一题, 另一题不知道调用啥 mbean 能拿 shell. 总之题目质量真的是非常高, 学到了很多.
描述
1Imagick is a awesome library for hackers to break `disable_functions`.
2So I installed php-imagick in the server, opened a `backdoor` for you.
3Let's try to execute `/readflag` to get the flag.
4Open basedir: /var/www/html:/tmp/949c1400c8390865cb5939a106fec0b6
5Hint: eval($_POST[&#34;backdoor&#34;]);
"><meta property="og:image" content><meta property="og:title" content="0ctf Wallbreaker Easy Writeup"><meta property="og:description" content="本文首发于先知
周末打了两天, 自闭 web 狗就做出来这一题, 另一题不知道调用啥 mbean 能拿 shell. 总之题目质量真的是非常高, 学到了很多.
描述
1Imagick is a awesome library for hackers to break `disable_functions`.
2So I installed php-imagick in the server, opened a `backdoor` for you.
3Let's try to execute `/readflag` to get the flag.
4Open basedir: /var/www/html:/tmp/949c1400c8390865cb5939a106fec0b6
5Hint: eval($_POST[&#34;backdoor&#34;]);
"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/03/26/0ctf-Wallbreaker-Easy-Writeup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-26T16:06:31+00:00"><meta property="article:modified_time" content="2019-03-26T16:06:31+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="0ctf Wallbreaker Easy Writeup"><meta name=twitter:description content="本文首发于先知
周末打了两天, 自闭 web 狗就做出来这一题, 另一题不知道调用啥 mbean 能拿 shell. 总之题目质量真的是非常高, 学到了很多.
描述
1Imagick is a awesome library for hackers to break `disable_functions`.
2So I installed php-imagick in the server, opened a `backdoor` for you.
3Let's try to execute `/readflag` to get the flag.
4Open basedir: /var/www/html:/tmp/949c1400c8390865cb5939a106fec0b6
5Hint: eval($_POST[&#34;backdoor&#34;]);
"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.5b5e050832b288704bce65ec4977762acc7f14087e0eaec463f2723f9bb3e9a4.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.cefce3efc3d1673a12499d1730c46db6951ef16bde19558cdb583fa050acc62e.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>0ctf Wallbreaker Easy Writeup</h1><div class=meta>发表于 2019 年 3 月 26 日</div></div><section class=body><p>本文首发于<a href=https://xz.aliyun.com/t/4589>先知</a></p><p>周末打了两天, 自闭 web 狗就做出来这一题, 另一题不知道调用啥 mbean 能拿 shell. 总之题目质量真的是非常高, 学到了很多.</p><h2 id=描述>描述</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Imagick <span style=color:#ff79c6>is</span> a awesome library <span style=color:#ff79c6>for</span> hackers <span style=color:#ff79c6>to</span> break <span style=color:#ff79c6>`</span>disable_functions<span style=color:#ff79c6>`</span>.
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>So I installed php<span style=color:#ff79c6>-</span>imagick <span style=color:#ff79c6>in</span> the server, opened a <span style=color:#ff79c6>`</span>backdoor<span style=color:#ff79c6>`</span> <span style=color:#ff79c6>for</span> you.
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Let<span style=color:#f1fa8c>&#39;s try to execute `/readflag` to get the flag.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>Open basedir: /var/www/html:/tmp/949c1400c8390865cb5939a106fec0b6
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#f1fa8c>Hint: eval($_POST[&#34;backdoor&#34;]);
</span></span></span></code></pre></div><h2 id=提示>提示</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>WALLBREAKER EASY
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>Ubuntu 18.04 / apt install php php-fpm php-imagick
</span></span></code></pre></div><p>第一眼看上去, 直接给了 webshell, 要求是执行根目录下的 <code>/readflag</code>,<br>先执行一波 <code>phpinfo()</code> 看看信息.
<img src=https://i.loli.net/2019/03/25/5c98caa8c8e93.png#center alt><br><img src=https://i.loli.net/2019/03/25/5c98caa8cc2e2.png#center alt><br><img src=https://i.loli.net/2019/03/25/5c98caa90a2f7.png#center alt></p><p>可以看到是 lnp 64 位环境, disable_function 如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail
</span></span></code></pre></div><p>Imagick 信息如下<br><img src=https://i.loli.net/2019/03/25/5c98caa92f03a.png#center alt></p><h2 id=题解>题解</h2><p>可以看到禁用了全部能直接执行程序的函数, 顺便还禁用了 mail, 不然的话可以直接用 <code>LD_PRELOAD</code> 来执行系统命令. 具体可以看这个<a href=https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD#center>项目</a>.</p><p>接下来第一反应是通过 ghostscript 的 0day 打一波试试, 但尝试了几次全部都没有反应&mldr; 好吧没有报错太蛋疼了, 我们还是照着提示搭一波环境吧.</p><p>然后发现这里其实就真的跟提示一样, 全是最新的环境, 所以肯定是不存在已知的严重 0day 的&mldr;<br>同时, 可以看到在默认的配置文件中, 已经禁用了 ghostscript 的使用, 不能通过 gs 来命令执行.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ cat /etc/ImageMagick-6/policy.xml 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>&lt;!DOCTYPE policymap [
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>&lt;!ELEMENT policymap (policy)+&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>&lt;!ELEMENT policy (#PCDATA)&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>&lt;!ATTLIST policy domain (delegate|coder|filter|path|resource) #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>&lt;!ATTLIST policy name CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>&lt;!ATTLIST policy rights CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>&lt;!ATTLIST policy pattern CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>&lt;!ATTLIST policy value CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>]&gt;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>&lt;policymap&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#6272a4>&lt;!-- &lt;policy domain=&#34;resource&#34; name=&#34;temporary-path&#34; value=&#34;/tmp&#34;/&gt; --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;resource&#34;</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;memory&#34;</span> <span style=color:#50fa7b>value=</span><span style=color:#f1fa8c>&#34;256MiB&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;resource&#34;</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;map&#34;</span> <span style=color:#50fa7b>value=</span><span style=color:#f1fa8c>&#34;512MiB&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;resource&#34;</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;width&#34;</span> <span style=color:#50fa7b>value=</span><span style=color:#f1fa8c>&#34;16KP&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;resource&#34;</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;height&#34;</span> <span style=color:#50fa7b>value=</span><span style=color:#f1fa8c>&#34;16KP&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;resource&#34;</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;area&#34;</span> <span style=color:#50fa7b>value=</span><span style=color:#f1fa8c>&#34;128MB&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;resource&#34;</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;disk&#34;</span> <span style=color:#50fa7b>value=</span><span style=color:#f1fa8c>&#34;1GiB&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;delegate&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;URL&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;delegate&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;HTTPS&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;delegate&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;HTTP&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#6272a4>&lt;!-- in order to avoid to get image with password text --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;path&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;@*&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;cache&#34;</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;shared-secret&#34;</span> <span style=color:#50fa7b>value=</span><span style=color:#f1fa8c>&#34;passphrase&#34;</span> <span style=color:#50fa7b>stealth=</span><span style=color:#f1fa8c>&#34;true&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#6272a4>&lt;!-- disable ghostscript format types --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;coder&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;PS&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;coder&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;EPI&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;coder&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;PDF&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  <span style=color:#ff79c6>&lt;policy</span> <span style=color:#50fa7b>domain=</span><span style=color:#f1fa8c>&#34;coder&#34;</span> <span style=color:#50fa7b>rights=</span><span style=color:#f1fa8c>&#34;none&#34;</span> <span style=color:#50fa7b>pattern=</span><span style=color:#f1fa8c>&#34;XPS&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>&lt;/policymap&gt;</span>
</span></span></code></pre></div><p>看起来好像一切的都没了希望, 但这时突然想起, 有没有可能通过 <code>Imagick</code> 来达到 <code>mail</code> 函数类似的效果呢? 上面的 <code>LD_PRELOAD</code> 其实是劫持了启动进程这一行为, 也就是说, 如果我们能让 <code>Imagick</code> 调用外部进程, 我们完全可以不通过 <code>mail</code> 来执行系统命令.</p><p><code>Imagick</code> 的底层是 <code>ImageMagick</code>, 这里就要说 <code>ImageMagick</code> 的 <code>delegate</code> 问题, <code>ImageMagick</code> 其实并没有实现所有文件格式的转换, 而是启动外部程序来进行转换, 就像上面的 ghostscript, 如果要将图片转换为 pdf, 就需要调用 ghostscript 来转换, 而这就会启动新的进程, 触发 <code>LD_PRELAOD</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ cat /etc/ImageMagick-6/delegates.xml 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>&lt;!DOCTYPE delegatemap [
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>&lt;!ELEMENT delegatemap (delegate)+&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>&lt;!ELEMENT delegate (#PCDATA)&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>&lt;!ATTLIST delegate decode CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>&lt;!ATTLIST delegate encode CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>&lt;!ATTLIST delegate mode CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>&lt;!ATTLIST delegate spawn CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>&lt;!ATTLIST delegate stealth CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>&lt;!ATTLIST delegate thread-support CDATA #IMPLIED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>&lt;!ATTLIST delegate command CDATA #REQUIRED&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>]&gt;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>&lt;delegatemap&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>&lt;!-- 省略很多行 --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#ff79c6>&lt;delegate</span> <span style=color:#50fa7b>decode=</span><span style=color:#f1fa8c>&#34;bmp&#34;</span> <span style=color:#50fa7b>encode=</span><span style=color:#f1fa8c>&#34;wdp&#34;</span> <span style=color:#50fa7b>command=</span><span style=color:#f1fa8c>&#34;/bin/mv &amp;quot;%i&amp;quot; &amp;quot;%i.bmp&amp;quot;; &amp;quot;JxrEncApp&amp;quot; -i &amp;quot;%i.bmp&amp;quot; -o &amp;quot;%o.jxr&amp;quot;; /bin/mv &amp;quot;%i.bmp&amp;quot; &amp;quot;%i&amp;quot;; /bin/mv &amp;quot;%o.jxr&amp;quot; &amp;quot;%o&amp;quot;&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#ff79c6>&lt;delegate</span> <span style=color:#50fa7b>decode=</span><span style=color:#f1fa8c>&#34;ppt&#34;</span> <span style=color:#50fa7b>command=</span><span style=color:#f1fa8c>&#34;&amp;quot;soffice&amp;quot; --convert-to pdf -outdir `dirname &amp;quot;%i&amp;quot;` &amp;quot;%i&amp;quot; 2&amp;gt; &amp;quot;%u&amp;quot;; /bin/mv &amp;quot;%i.pdf&amp;quot; &amp;quot;%o&amp;quot;&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#ff79c6>&lt;delegate</span> <span style=color:#50fa7b>decode=</span><span style=color:#f1fa8c>&#34;pptx&#34;</span> <span style=color:#50fa7b>command=</span><span style=color:#f1fa8c>&#34;&amp;quot;soffice&amp;quot; --convert-to pdf -outdir `dirname &amp;quot;%i&amp;quot;` &amp;quot;%i&amp;quot; 2&amp;gt; &amp;quot;%u&amp;quot;; /bin/mv &amp;quot;%i.pdf&amp;quot; &amp;quot;%o&amp;quot;&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>&lt;delegate</span> <span style=color:#50fa7b>decode=</span><span style=color:#f1fa8c>&#34;ps:alpha&#34;</span> <span style=color:#50fa7b>stealth=</span><span style=color:#f1fa8c>&#34;True&#34;</span> <span style=color:#50fa7b>command=</span><span style=color:#f1fa8c>&#34;&amp;quot;gs&amp;quot; -sstdout=%%stderr -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pngalpha&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#ff79c6>&lt;delegate</span> <span style=color:#50fa7b>decode=</span><span style=color:#f1fa8c>&#34;ps:cmyk&#34;</span> <span style=color:#50fa7b>stealth=</span><span style=color:#f1fa8c>&#34;True&#34;</span> <span style=color:#50fa7b>command=</span><span style=color:#f1fa8c>&#34;&amp;quot;gs&amp;quot; -sstdout=%%stderr -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pamcmyk32&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4>&lt;!-- 省略很多行 --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>&lt;/delegatemap&gt;</span>
</span></span></code></pre></div><p>可以看到有很多的 delegate, 在进行这些格式的编码以及解码时, <code>ImageMagick</code> 会调用这些外部程序. 但是这些外部程序大部分其实都不自带, 得自己安装, 不会起新的进程, 但是可以注意到这个特殊的格式,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&lt;delegate</span> <span style=color:#50fa7b>decode=</span><span style=color:#f1fa8c>&#34;bmp&#34;</span> <span style=color:#50fa7b>encode=</span><span style=color:#f1fa8c>&#34;wdp&#34;</span> <span style=color:#50fa7b>command=</span><span style=color:#f1fa8c>&#34;/bin/mv &amp;quot;%i&amp;quot; &amp;quot;%i.bmp&amp;quot;; &amp;quot;JxrEncApp&amp;quot; -i &amp;quot;%i.bmp&amp;quot; -o &amp;quot;%o.jxr&amp;quot;; /bin/mv &amp;quot;%i.bmp&amp;quot; &amp;quot;%i&amp;quot;; /bin/mv &amp;quot;%o.jxr&amp;quot; &amp;quot;%o&amp;quot;&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span></code></pre></div><p>其中有系统自带的 mv, 这肯定是能执行成功的, 我们只要通过转换格式就能调用这个 delegate.<br>通过 strace 也可以发现确实调用了 mv, 即使因为 JxrEncApp 不存在导致图片转换失败, 但只要因为 mv 调起了新进程, 我们就能执行任意命令.</p><p><img src=https://i.loli.net/2019/03/25/5c98d6280c9a5.png#center alt><br><img src=https://i.loli.net/2019/03/25/5c98d627f3530.png#center alt></p><p>这样, 就可以通过 <code>ImageMagick</code> 来触发新进程的产生, 并通过修改 <code>LD_PRELOAD</code> 的方式来执行任意系统命令.</p><p>最后 exp 如下, 写入so文件<br><img src=https://i.loli.net/2019/03/25/5c98caa992bb6.png#center alt><br>修改 <code>LD_PRELOAD</code> 并转换图片格式, 最终执行系统变量 <code>EVIL_CMDLINE</code> 里的命令.<br><img src=https://i.loli.net/2019/03/25/5c98caa98b8aa.png#center alt></p><p>PS. 写入 so 文件的时候记得把 base64 里的 <code>+</code> 给编码, 不然会被当成空格.</p><p>还有一种思路是修改 <code>PATH</code> 环境变量, 修改为 <code>/tmp/xxx/</code>, 然后新建一个名为 <code>JxrEncApp</code> 之类的的恶意文件,<br><code>ImageMagick</code> 在 <code>delegete</code> 的时候将会调用这个, 从而执行命令.</p><p>不得不说题目质量是真的高, 膜 rr.</p><h2 id=总结>总结</h2><p>除了这种 <code>LD_PRELOAD</code> 的方式之外, 还有其他一些骚操作, 可以看 <a href=https://github.com/l3m0n/Bypass_Disable_functions_Shell>l3m0n</a> 师傅总结的.<br>在遇到这种困境时, 不防想想有没有什么其他办法能 bypass 掉当前的限制, 开辟新的方法.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/writeup>writeup</a></li><li><a href=/tags/0ctf>0ctf</a></li><li><a href=/tags/web>web</a></li></ul></nav></div></article></main><footer><div class=footer-info>© 2017 - 2022, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script>
<script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>