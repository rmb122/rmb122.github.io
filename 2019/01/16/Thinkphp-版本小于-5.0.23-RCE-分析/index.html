<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Thinkphp >= 5.0.23 RCE 分析 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="起因是刚出来那天刚好有个站是 5.0.23 但是分析文章没给完整的截图, 打了码. 干脆自己分析一波写写 poc.
"><meta property="og:image" content><meta property="og:url" content="https://rmb122.com/2019/01/16/Thinkphp-%E7%89%88%E6%9C%AC%E5%B0%8F%E4%BA%8E-5.0.23-RCE-%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="rmb122's notebook"><meta property="og:title" content="Thinkphp >= 5.0.23 RCE 分析"><meta property="og:description" content="起因是刚出来那天刚好有个站是 5.0.23 但是分析文章没给完整的截图, 打了码. 干脆自己分析一波写写 poc."><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-01-16T19:03:53+00:00"><meta property="article:modified_time" content="2019-01-16T19:03:53+00:00"><meta property="article:tag" content="Web"><meta property="article:tag" content="Audit"><meta property="article:tag" content="Php"><meta name=twitter:card content="summary"><meta name=twitter:title content="Thinkphp >= 5.0.23 RCE 分析"><meta name=twitter:description content="起因是刚出来那天刚好有个站是 5.0.23 但是分析文章没给完整的截图, 打了码. 干脆自己分析一波写写 poc."><script src=https://rmb122.com/js/feather.min.js></script><link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.e9aac7e7a771269044e258ce034f7420b431b95683d4aef0faa4d381efbb16d3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.4d342f24ad49bb75f14c3b92c9454fe693d293fb7474ecc40a101a8ad6af9d71.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a><script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Thinkphp >= 5.0.23 RCE 分析</h1><div class=meta>发表于 2019 年 1 月 16 日</div></div><section class=body><p>起因是刚出来那天刚好有个站是 5.0.23 但是分析文章没给完整的截图, 打了码. 干脆自己分析一波写写 poc.</p><p><img src=https://i.loli.net/2019/03/08/5c827b967b058.jpg#center alt referrerpolicy=no-referrer></p><p>先切换到 v5.0.23</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>git clone git@github.com:top-think/framework.git
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>git checkout v5.0.23
</span></span></code></pre></div><p>主要问题出在 <code>library/think/Request.php</code> 中的 <code>method</code>, 其中的 Config::get(&lsquo;var_method&rsquo;) 默认值是 _method, 而其没有任何过滤就被传进 $this->{$this->method}($_POST) 中, 导致可以调用本类的任何单参数函数.</p><p><img src=https://i.loli.net/2019/03/08/5c827b9b6fbef.jpg#center alt referrerpolicy=no-referrer></p><p>官方的补丁也是增加过滤措施</p><p><img src=https://i.loli.net/2019/03/08/5c827ba0aa16d.jpg#center alt referrerpolicy=no-referrer></p><p>这里我反着来, 从利用链末端的危险函数 <code>filterValue</code> 开始分析,</p><p><img src=https://i.loli.net/2019/03/08/5c827ba5b5cb0.jpg#center alt referrerpolicy=no-referrer></p><p>可以看到其中调用了 call_user_func, 只要我们能控制 filters 和 value, 就能调用任意函数</p><p>这里查找这个方法的引用, 找到 cookie 和 input, 这里我偷懒, 直接加上 echo, 找找看是否有启用</p><p><img src=https://i.loli.net/2019/03/08/5c827baa8eac6.jpg#center alt referrerpolicy=no-referrer></p><p><img src=https://i.loli.net/2019/03/08/5c827bb04e7d4.jpg#center alt referrerpolicy=no-referrer></p><p><img src=https://i.loli.net/2019/03/08/5c827bb3c3fe5.jpg#center alt referrerpolicy=no-referrer></p><p>这里可以看到 cookie 方法并未被在框架中直接使用, 所以我们从 input 上下手</p><p><img src=https://i.loli.net/2019/03/08/5c827bb7efec3.jpg#center alt referrerpolicy=no-referrer></p><p>可以看到找到一个调用了 input 且 <code>name = ''</code> 的方法就行了, data 将会被作为 filterValue 中的 value.</p><p>继续查找引用, 这里我随便找了一个 get, var_dump 了一下确认了 <code>name =''</code>. $_GET 数组将会被当做 value 传进 input.</p><p><img src=https://i.loli.net/2019/03/08/5c827bbc2120b.jpg#center alt referrerpolicy=no-referrer></p><p>这样 filterValue 中的 value 已经构造完成, 接下来只要构造 filter 即可, 这个比较简单, 在构造函数中可以看到</p><p><img src=https://i.loli.net/2019/03/08/5c827bbf258ed.jpg#center alt referrerpolicy=no-referrer></p><p>只要抢先在底下对 $this->filter 赋值之前给他赋值就行了.</p><p>最后需要添加一个 method=GET, 不然没有路由信息</p><p><img src=https://i.loli.net/2019/03/08/5c827bc64c589.jpg#center alt referrerpolicy=no-referrer></p><p>比较遗憾的是, 在比较后面的版本中必须打开 App::debug 或者有 captcha 模块才能利用.</p><p>因为有很多地方都调用了 input 方法, 所以 payload 有很多种, 不过本质都是通过类的构造函数来覆盖变量导致 filterValue 被错误的执行.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/web>web</a></li><li><a href=/tags/audit>audit</a></li><li><a href=/tags/php>php</a></li></ul></nav></div></article></main><footer><div class=footer-info>© 2017 - 2024, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5")}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script><script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>