<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>自制一个简单的 Hashpump - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在学完 MD5/SHA1 之后, 很快就能搞懂 hashpump 的原理, 本质是因为类 MD 哈希函数
包括 MD5, SHA1, SHA2 都是将信息填充为一个 Block 长度的倍数以后分 Block 一轮轮计算的,
最后输出的是寄存器拼接在一起的值, 所以假设用以下公式计算签名"><meta property="og:image" content><meta property="og:title" content="自制一个简单的 Hashpump"><meta property="og:description" content="在学完 MD5/SHA1 之后, 很快就能搞懂 hashpump 的原理, 本质是因为类 MD 哈希函数
包括 MD5, SHA1, SHA2 都是将信息填充为一个 Block 长度的倍数以后分 Block 一轮轮计算的,
最后输出的是寄存器拼接在一起的值, 所以假设用以下公式计算签名"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/05/11/%E8%87%AA%E5%88%B6%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-Hashpump/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-11T00:02:02+00:00"><meta property="article:modified_time" content="2019-05-11T00:02:02+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="自制一个简单的 Hashpump"><meta name=twitter:description content="在学完 MD5/SHA1 之后, 很快就能搞懂 hashpump 的原理, 本质是因为类 MD 哈希函数
包括 MD5, SHA1, SHA2 都是将信息填充为一个 Block 长度的倍数以后分 Block 一轮轮计算的,
最后输出的是寄存器拼接在一起的值, 所以假设用以下公式计算签名"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.156ea4f9c8c3d7072fb0ea9460063a78eceb89a501e4444cfab3783b79985a3a.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.4d342f24ad49bb75f14c3b92c9454fe693d293fb7474ecc40a101a8ad6af9d71.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>自制一个简单的 Hashpump</h1><div class=meta>发表于 2019 年 5 月 11 日</div></div><section class=body><p>在学完 MD5/SHA1 之后, 很快就能搞懂 <code>hashpump</code> 的原理, 本质是因为类 <code>MD</code> 哈希函数<br>包括 MD5, SHA1, SHA2 都是将信息填充为一个 <code>Block</code> 长度的倍数以后分 <code>Block</code> 一轮轮计算的,<br>最后输出的是寄存器拼接在一起的值, 所以假设用以下公式计算签名</p><p>$$ hash(key + msg) = signature $$</p><p>假如已经知道了 <code>signature</code>, <code>msg</code> 以及 <code>key</code> 的长度(在实战中可以爆破), 那么完全是可以将所有 <code>Block</code> 里面除了<br>一开始的 key 之外的的内容算出来. 自然而然可以想到, 我们将计算出 <code>signature</code> 时<br>的状态作为我们的起始状态, 也就是将寄存器的值换成哈希函数的输出, 然后就可以在新的 <code>Block</code><br>的里面伪造任意消息, 因为这时候前面 <code>Block</code> 的内容实际上只是为了 <code>padding</code> 最后的消息长度的正确,<br>所以可以在并在不知道 <code>key</code> 的情况下得到 <code>signature</code>. 这时 <code>msg</code> 就变成了<br><code>原来的 msg + padding + 伪造的 msg</code>.</p><p>限制就是必须是 <code>key + msg</code> 的顺序, 如果是 <code>msg + key</code> 的顺序, 伪造的 <code>msg</code> 就必须是<br><code>原来的 msg + key + padding + 伪造的 msg</code>, 出现了 key, 而如果我们有 key 了, 还伪造什么呢 233<br>所以局限还是比较大的, 但漏洞总是存在在哪里, 说不定就有开发者用了呢, 对吧. 所以有专门的 <code>HMAC</code> 算法<br>来生成签名, 抛开 opad 和 ipad 啥的, 原理很简单, 就是用</p><p>$$ hash(key + hash(key + msg)) = signature $$</p><p>这样嵌套的方式来计算签名, 拿到的签名值是外层的 <code>hash</code> 的结果, 而内层的 <code>hash(key + msg)</code> 的值长度是不可控的,<br>显然就不能长度扩展了.</p><p>了解这些思路, 写脚本就非常的 ez 了. 简单的对 <code>SHA1</code> 的哈希长度扩展的脚本如下.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>from</span> sha1 <span style=color:#ff79c6>import</span> SHA1
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>from</span> struct <span style=color:#ff79c6>import</span> unpack
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>from</span> binascii <span style=color:#ff79c6>import</span> unhexlify
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>padding</span>(msg):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    length <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>len</span>(msg)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    pad <span style=color:#ff79c6>=</span> length <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> pad <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>56</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        pad <span style=color:#ff79c6>=</span> (<span style=color:#bd93f9>64</span> <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>56</span>) <span style=color:#ff79c6>-</span> pad
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        pad <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>56</span> <span style=color:#ff79c6>-</span> pad
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>if</span> pad <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        msg<span style=color:#ff79c6>.</span>extend([<span style=color:#bd93f9>0x80</span>] <span style=color:#ff79c6>+</span> [<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>*</span> (pad <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    length <span style=color:#ff79c6>*=</span> <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    length <span style=color:#ff79c6>=</span> length <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>0x10000000000000000</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>for</span> _ <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>range</span>(<span style=color:#bd93f9>8</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        b <span style=color:#ff79c6>=</span> (length <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xff00000000000000</span>) <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>56</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        length <span style=color:#ff79c6>=</span> length <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        msg<span style=color:#ff79c6>.</span>append(b)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>return</span> msg
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>pump</span>(orghash, orgmsg, keylen, addmsg):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>type</span>(orgmsg) <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>str</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        orgmsg <span style=color:#ff79c6>=</span> orgmsg<span style=color:#ff79c6>.</span>encode()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>type</span>(addmsg) <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>str</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        addmsg <span style=color:#ff79c6>=</span> addmsg<span style=color:#ff79c6>.</span>encode()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#ff79c6>assert</span> <span style=color:#8be9fd;font-style:italic>len</span>(orghash) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>40</span>  <span style=color:#6272a4># sha1 20 字节用 16 进制表示为 40 个字符长度</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    regs <span style=color:#ff79c6>=</span> unpack(<span style=color:#f1fa8c>&#39;&gt;5I&#39;</span>, unhexlify(orghash))  <span style=color:#6272a4># 算出之前轮结束的寄存器值, SHA1 是大端存储</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    sha1 <span style=color:#ff79c6>=</span> SHA1(<span style=color:#f1fa8c>&#39;&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    sha1<span style=color:#ff79c6>.</span>ra, sha1<span style=color:#ff79c6>.</span>rb, sha1<span style=color:#ff79c6>.</span>rc, sha1<span style=color:#ff79c6>.</span>rd, sha1<span style=color:#ff79c6>.</span>re <span style=color:#ff79c6>=</span> regs
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    newmsg <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    newmsg <span style=color:#ff79c6>+=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>([<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>*</span> keylen)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    newmsg <span style=color:#ff79c6>+=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(orgmsg)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    newmsg <span style=color:#ff79c6>=</span> padding(newmsg) <span style=color:#6272a4># 还原 orghash 的区块, key 用 0 来填充</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    retmsg <span style=color:#ff79c6>=</span> newmsg[keylen:] <span style=color:#6272a4># 返回的 msg</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    retmsg <span style=color:#ff79c6>+=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(addmsg)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    newmsg <span style=color:#ff79c6>+=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(addmsg)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    newmsg <span style=color:#ff79c6>=</span> padding(newmsg) <span style=color:#6272a4># 因为最后 8 位是长度信息, 所以得将之前的区块一并来 padding</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    newmsg <span style=color:#ff79c6>=</span> newmsg[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>64</span>:] <span style=color:#6272a4># 但最后计算时只需要最后一块就行, 因为已经将寄存器设为之前的算出来的结果</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    sha1<span style=color:#ff79c6>.</span>msg <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>(newmsg)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    <span style=color:#ff79c6>return</span> (retmsg, sha1<span style=color:#ff79c6>.</span>hexdigest())
</span></span></code></pre></div><p><code>SHA1</code> 基本来自于<a href=https://github.com/rmb122/Cryptography/blob/master/SHA1.py title rel="noopener nofollow noreferrer" target=_blank>密码学作业</a>, 稍微修改一下, 因为这里需要我们自己控制一个 <code>Block</code>, 是已经 <code>padding</code> 过的了,<br>不用重复, 所以把算结果之前的 <code>padding</code> 给跳过.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>138c138
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>&lt;         # self.__padding()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f55>---
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f55></span>&gt;         self.__padding()
</span></span></code></pre></div><p>最后当然是能实验成功的~</p><p><img src=https://i.loli.net/2019/05/11/5cd5a7015838e.png#center alt referrerpolicy=no-referrer></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/crypto>crypto</a></li></ul></nav></div></article></main><footer><div class=footer-info>© 2017 - 2022, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script>
<script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>