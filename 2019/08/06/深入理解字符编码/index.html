<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>深入理解字符编码以及 GBK 注入 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难."><meta property="og:image" content><meta property="og:title" content="深入理解字符编码以及 GBK 注入"><meta property="og:description" content="以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难."><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/08/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-06T16:13:47+00:00"><meta property="article:modified_time" content="2019-08-06T16:13:47+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解字符编码以及 GBK 注入"><meta name=twitter:description content="以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难."><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.156ea4f9c8c3d7072fb0ea9460063a78eceb89a501e4444cfab3783b79985a3a.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.4d342f24ad49bb75f14c3b92c9454fe693d293fb7474ecc40a101a8ad6af9d71.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>深入理解字符编码以及 GBK 注入</h1><div class=meta>发表于 2019 年 8 月 6 日</div></div><section class=body><p>以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难.</p><h2 id=unicode>unicode</h2><p>其实这是最简单的, unicode 就是一套标准, 把世界上每个存在的字符 (甚至包括 emoji) 都编一个号, 可以在 <a href=https://unicode-table.com/cn/ title rel="noopener nofollow noreferrer" target=_blank>https://unicode-table.com/cn/</a> 看到全部的编码. 而这个编的号, 一般叫做 code point, 也就是码点, 还有一些诸如平面 (Plane) 的概念, 就不在本文的叙述范围内了, 可以自行了解.</p><p>同时目前也存在几个不同的编码标准, 也就是 UTF-8, UTF-16 等等, 毕竟直接把码点转二进制太浪费空间了, 也可能存在歧义. 这些编码的功能就是把码点保存为计算机可以识别的二进制形式.</p><h2 id=utf-8>UTF-8</h2><p>UTF-8 就是这些编码的一种, 详细可以参考<a href=https://zh.wikipedia.org/wiki/UTF-8 title rel="noopener nofollow noreferrer" target=_blank>维基百科</a>, 简单来说, 就是把码点转为二进制后,<br>然后为了节省空间, 把不同大小的码点转为不同长度的字节序列, 这就是他天才的地方, 用变长编码来节省长度.</p><p>这里以 <code>啊</code> 为例, 它的码点是 <code>0x554a</code>, 在 <code>U+0800~U+FFFF</code> 的范围内, 二进制是 <code>0b101010101001010</code>,<br>那么根据定义, 他的保存方式是 <code>1110xxxx 10xxxxxx 10xxxxxx</code>, 我们将这个码点的二进制以大端的方式填入其中,<br>得到 <code>1110|0101 10|010101 10|001010</code>, 也就是 <code>b'\xe5\x95\x8a'</code>, 可以尝试在 python 解码, 得到的就是 <code>啊</code>.</p><p>而在 <code>0x00 ~ 0xFF</code> 范围内, UTF-8 其实就被退化为 ASCII 了, 一是为了兼容性, 二是确实 ASCII 所涵盖的符号, 确实用的非常多.<br>这里可以手动写一些 UTF-8 的函数来加深学习, 因为是变长的, 所以来算长度, 以及截取相对比较麻烦.<br>这里用我用 c 写, 感觉非常的爽, 就像在高速公路上飙车, 控制不好就会翻车 (Segment fault) 233, 但是确实是最接近这些字符编码本来的样子.<br>没有了 python 上各种的包装.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdio.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdlib.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;memory.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>read_file</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>filename) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>    FILE <span style=color:#ff79c6>*</span>fd <span style=color:#ff79c6>=</span> fopen(filename, <span style=color:#f1fa8c>&#34;r&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>    fseek(fd, <span style=color:#bd93f9>0</span>, SEEK_END);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>    <span style=color:#8be9fd>long</span> sz <span style=color:#ff79c6>=</span> ftell(fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>    fseek(fd, <span style=color:#bd93f9>0</span>, SEEK_SET);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>content <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> sz);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>    fread(content, <span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>), sz, fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>    fclose(fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>    <span style=color:#ff79c6>return</span> content;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>utf8_strlen</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>    <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>            length <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>    <span style=color:#ff79c6>return</span> length;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>codepoint_to_utf8</span>(<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>int</span> codepoint, <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>sz) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>    <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x80</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> codepoint;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x800</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00011111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x10000</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11100000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>12</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00001111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>4</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>12</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11110000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>18</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00000111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>    <span style=color:#ff79c6>return</span> s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>get_tail_length</span>(<span style=color:#8be9fd>char</span> c) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>    <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11110000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11110000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11100000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11100000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>    <span style=color:#ff79c6>return</span> length;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>utf8_substr</span>(<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> s, <span style=color:#8be9fd>int</span> start, <span style=color:#8be9fd>int</span> length) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>    <span style=color:#8be9fd>int</span> curr_pos <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>    <span style=color:#8be9fd>int</span> byte_count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>    <span style=color:#8be9fd>int</span> offset <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>new_s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>    <span style=color:#ff79c6>while</span> (curr_pos <span style=color:#ff79c6>&lt;</span> start <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>            curr_pos <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>        s <span style=color:#ff79c6>+=</span> (get_tail_length(<span style=color:#ff79c6>*</span>s) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>    curr_pos <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>    <span style=color:#ff79c6>while</span> (curr_pos <span style=color:#ff79c6>&lt;</span> length <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>            curr_pos <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>        byte_count<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>    <span style=color:#ff79c6>if</span> (curr_pos <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>        offset <span style=color:#ff79c6>=</span> get_tail_length(<span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>        new_s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> (byte_count <span style=color:#ff79c6>+</span> offset <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>        memcpy(new_s, s <span style=color:#ff79c6>-</span> byte_count, byte_count <span style=color:#ff79c6>+</span> offset);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>        new_s[byte_count <span style=color:#ff79c6>+</span> offset] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>        new_s <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>    <span style=color:#ff79c6>return</span> new_s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>utf8_to_codepoint</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>    <span style=color:#8be9fd>int</span> codepoint <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>    <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11110000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b111;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11110000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11100000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b1111;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11100000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;</span> length; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>        codepoint <span style=color:#ff79c6>&lt;&lt;=</span> <span style=color:#bd93f9>6</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>        codepoint <span style=color:#ff79c6>=</span> codepoint <span style=color:#ff79c6>|</span> (<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>    <span style=color:#ff79c6>return</span> codepoint;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>    <span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span><span style=color:#6272a4>    char *content = read_file(&#34;/home/rmb122/temp/example.txt&#34;);
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span><span style=color:#6272a4>    printf(&#34;%d&#34;, utf8_strlen(content));
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span><span style=color:#6272a4>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span><span style=color:#6272a4>    free(content);
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>    printf(<span style=color:#f1fa8c>&#34;%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, utf8_strlen(<span style=color:#f1fa8c>&#34;一二三四五六一二三四五六1234&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>    <span style=color:#8be9fd>int</span> sz;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>    s <span style=color:#ff79c6>=</span> codepoint_to_utf8(<span style=color:#bd93f9>21834</span>, <span style=color:#ff79c6>&amp;</span>sz);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>    printf(<span style=color:#f1fa8c>&#34;%.*s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, sz, s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>    free(s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>    s <span style=color:#ff79c6>=</span> utf8_substr(<span style=color:#f1fa8c>&#34;一2三四5六7八9&#34;</span>, <span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>    <span style=color:#ff79c6>if</span> (s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>        printf(<span style=color:#f1fa8c>&#34;%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>        printf(<span style=color:#f1fa8c>&#34;%s&#34;</span>, <span style=color:#f1fa8c>&#34;null&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>    free(s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>    printf(<span style=color:#f1fa8c>&#34;%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, utf8_to_codepoint(<span style=color:#f1fa8c>&#34;五&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>}
</span></span></code></pre></div><h2 id=utf-16>UTF-16</h2><p>说实话, 我觉得 UTF-16 已经可以被扔进历史的垃圾桶, 然而 <code>Windows</code> 还依然使用 233.<br>他本身是为了保证固定长度而设计的, 因为两个字节 256*256, 可以表示 65536 种字符,<br>在以前 unicode 收录字符比较少的情况下是完全够的, 这样每个字符都保存为两个字节长,<br>可以节省运算, 虽然浪费了挺多的空间, 但是确实很方便.</p><p>然而现在上面的网站上看到, unicode 收录的字符早已超过了 65536 个, 也就意味着码点超过了 <code>0xFFFF</code>.<br>这里以 <code>𐎠</code> 这个字符为例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>&#34;啊&#34;</span><span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-16be&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;UJ&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>&#34;𐎠&#34;</span><span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-16be&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\xd8\x00\xdf\xa0</span><span style=color:#f1fa8c>&#39;</span>
</span></span></code></pre></div><p>可以看到, 实际上保存这个字符用了四个字节, 而不是两个. 历史的发展使得 UTF-16 唯一的好处已经荡然无存.<br>而且为了保存大端小端的额外信息, 还用了 <code>BOM</code> 这种丑陋的设计, 希望 <code>Windows</code> 也能早点淘汰掉 UTF-16 把 233.<br>基于以上原因, 真正的 UTF-<strong>16</strong> 应该是 <a href=https://en.wikipedia.org/wiki/Universal_Coded_Character_Set#Encoding_forms title rel="noopener nofollow noreferrer" target=_blank>UCS-2</a>, 现在的 UTF-16 反而有点不伦不类, 既然已经是变长编码了, 为什么不用更节省空间的 UTF-8 呢?</p><h2 id=gbk>GBK</h2><p>这个是我国自创的编码标准, 优点非常明显, 节省空间, 相当于缩小版的 UTF-8 (当然用的码点表和具体实现跟 unicode 不同),<br>因为它只需要表达 ASCII + 汉字的字符空间就够了. 当然缺点也非常明显, 不能表达 ASCII + 汉字之外的字符, 也就注定只能在中国使用,<br>无法国际化, 而且实际上很多国家都有一套自创字符集, 例如 big5, shift-jis 等等, 这更促进了 unicode 的诞生.</p><h2 id=gbk-宽字节注入>GBK 宽字节注入</h2><p>说到 gbk, 那就不能不提到经典的 gbk 宽字节注入, 它可以将 php addslashes 函数转义后引号前的反斜杠<strong>吃掉</strong>, 导致本该转义掉的单引号又被暴露出来.<br>而反斜杠能被吃掉的原因来自于部分字符集 (比如 gbk), 的多字节编码表示中是允许存在 0x00 - 0x7f 存在的, 这导致例如经典 payload <code>運</code> 这个字在 gbk 编码下为 <code>b"\xdf\\"</code>, 可以看到第二个字节正是反斜杠.<br>这种情况在 utf8 中就不存在, 因为 utf8 标准已经规定了在多字节编码的情况下, 除了第一位的字节在二进制下都是以 10 开头的, 也就是在 [0x80, 0xbf] 之中, 保证了只要出现了二进制下非 10 开头的字节, 一定是新的字符.</p><p>如上面所说, 因为部分字符集的多字节编码中允许 0x00 - 0x7f 存在, mysql 实际上会对客户端传入的字符串进行解码 (对应 <code>SET NAMES charset</code>) 后再编码存储来避免解析语法时的混淆.<br>例如以 <code>CREATE TABLE test_gbk (id int AUTO_INCREMENT PRIMARY KEY, note VARCHAR(1024)) CHARACTER SET gbk</code> 创建一个表</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>import pymysql
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>mysql <span style=color:#ff79c6>=</span> pymysql.<span style=color:#50fa7b>connect</span>(host<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#ff79c6>user</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;root&#39;</span>, password<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#ff79c6>database</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;data&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>mysql.<span style=color:#50fa7b>set_charset</span>(<span style=color:#f1fa8c>&#39;gbk&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>cursor</span> <span style=color:#ff79c6>=</span> mysql.<span style=color:#ff79c6>cursor</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#39;CREATE TABLE test_gbk (id int AUTO_INCREMENT PRIMARY KEY, note VARCHAR(1024)) CHARACTER SET gbk&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#34;insert into test_gbk(`note`) values (&#39;你好&#39;);&#34;</span>.<span style=color:#50fa7b>encode</span>(<span style=color:#f1fa8c>&#39;gbk&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#34;insert into test_gbk(`note`) values (&#39;你好&#39;);&#34;</span>.<span style=color:#50fa7b>encode</span>(<span style=color:#f1fa8c>&#39;utf8&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>close</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>mysql.<span style=color:#50fa7b>commit</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>mysql.<span style=color:#50fa7b>set_charset</span>(<span style=color:#f1fa8c>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>cursor</span> <span style=color:#ff79c6>=</span> mysql.<span style=color:#ff79c6>cursor</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#34;insert into test_gbk(`note`) values (&#39;你好&#39;);&#34;</span>.<span style=color:#50fa7b>encode</span>(<span style=color:#f1fa8c>&#39;utf8&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>close</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>mysql.<span style=color:#50fa7b>commit</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>cursor</span> <span style=color:#ff79c6>=</span> mysql.<span style=color:#ff79c6>cursor</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#39;select * from test_gbk&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>ret <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>fetchall</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#50fa7b>print</span>(ret)
</span></span></code></pre></div><p>第一次在指定 gbk 编码下分别以 gbk, utf8 编码写入 <code>你好</code>, 第二次在指定 utf8 编码下以 utf8 编码写入 <code>你好</code>, 最后查询表里的数据. 查询返回的结果为 <code>((1, '你好'), (2, '浣犲ソ'), (3, '你好'))</code>. 第一行和第三行的 <code>你好</code> 不出意外, 第二行出现 <code>浣犲ソ</code> 的原因就来自于上面提到的 mysql 的编解码过程.<br>可以在 python 中输入 <code>'你好'.encode('utf8').decode('gbk')</code>, 返回的结果正是 <code>浣犲ソ</code>, 可以说明 mysql 服务端实际上是以 gbk 解码了 utf8 编码后的二进制表示 <code>\xe4\xbd\xa0\xe5\xa5\xbd</code>, 而这又恰好在 gbk 中为 <code>浣犲ソ</code>.
另外, 也可以通过流量来证明, 客户端并没有做多余的步骤, 是按照 encode 后结果直接发送的<br><img src=https://s2.loli.net/2022/08/13/Nz5HLrZfGUPIYge.png#center alt referrerpolicy=no-referrer></p><p>而对于存储, 我们可以直接对数据库文件进行 xxd 来确认<br><img src=https://s2.loli.net/2022/08/13/Z6FLKQyPaJGfzV1.png#center alt referrerpolicy=no-referrer>
可以看到出现了两次 <code>你好</code> 一次 <code>浣犲ソ</code>, 可以确定不管客户端的编码是如何, mysql 仍然是按照创建表时所指定的 gbk 存储的, 这也导致了 gbk 注入其实只与客户端编码有关, 而与 mysql 表中的编码设置是无关的, 就算是 <code>utf8mb4</code> 也一样可以注入.</p><p>说回注入, php 常见的 <code>addslashes</code> 在这种情况下当然无能为了, 这个函数没有考虑也无法对 gbk 编码的这种特殊情况进行处理, 它在设计之初就是逐字节搜索特殊字符并转义的.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>echo</span> bin2hex(addslashes(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#39;&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>df5c27
</span></span></code></pre></div><p>在这种情况下, 正确的转义应该是将两个字符都转义或者都不转义, 因为 <code>b"\xdf'"</code> 本身就是一个无效的 gbk 编码, 是没有对应的字符的, 加入反斜杠反而让它变成了一个合法的字符, 还让多出来的引号产生了注入, <code>addslashes</code> 可以说是帮了倒忙.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 464 41"><g transform="translate(8,16)"><path d="M72 16H176" fill="none" stroke="currentcolor"/><path d="M280 16H408" fill="none" stroke="currentcolor"/><polygon points="184.000000,16.000000 172.000000,10.400000 172.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 176.000000, 16.000000)"/><polygon points="416.000000,16.000000 404.000000,10.400000 404.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 408.000000, 16.000000)"/><text text-anchor="middle" x="0" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="8" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="144" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="152" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="200" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="208" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="216" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="224" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="232" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="240" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="248" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="256" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="264" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="296" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="304" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="320" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="328" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="336" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="4" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="352" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="360" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="368" y="4" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="376" y="4" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="384" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="392" y="4" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="424" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="432" y="20" fill="currentcolor" style="font-size:1em">運</text><text text-anchor="middle" x="440" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="448" y="20" fill="currentcolor" style="font-size:1em">"</text></g></svg></div><p>而对编程者来说, 可以使用 <code>mysqli::set_charset</code> + <code>mysqli::real_escape_string</code> 来对付这种情况 (当然预编译更好), 例子如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>set_charset</span>(<span style=color:#f1fa8c>&#39;gbk&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>echo</span> bin2hex(<span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#39;&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bd93f9>5</span>cdf5c27
</span></span></code></pre></div><p>注意 <code>$conn->query("SET NAMES 'gbk'");</code> 是不能让 <code>mysqli::real_escape_string</code> 正常工作的, 必须使用 <code>mysqli::set_charset</code> 才行. 而转义方面 mysqli 选择了更保险的做法, 将两个字符都进行了转义, 而且比起不转义在编程上应该也更容易实现吧, 可以看到就算是单个 <code>\xdf</code> 也进行了转义.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>echo</span> bin2hex(<span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bd93f9>5</span>cdf
</span></span></code></pre></div><p>而漏洞的产生条件必须是这样</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SET NAMES &#39;gbk&#39;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;id&#39;</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span></code></pre></div><p>而且如果没有使用 <code>mysqli::set_charset</code> 就算是 <code>mysqli::real_escape_string</code> 也是无法避免注入的, <code>addslashes</code> 就更不用说了. 但是需要注意的是 <code>$conn->query("SET NAMES 'gbk'");</code> 也是必须的, 否则在 mysql 侧, 会认为 <code>"\xdf"</code> 会认为是一个字符而不是 <code>"\xdf\\"</code>, 导致反斜杠又生效了.
最后, 同样的漏洞在 big5 和 shiftjis 上也是存在的, 在 big5 下 <code>"\xdf\\"</code> 对应的字符为 <code>綅</code>, 但是在 shiftjis 就不能直接照搬了, <code>"\xdf"</code> 在 shiftjis 下对应 <code>ﾟ</code>, 因此第一个字符需要稍微 fuzz 一下 <code>[(bytes([i]) + b'\\').decode('gbk','ignore') for i in range(256)]</code>, 这里随便挑出来一个 <code>"\x97\\"</code>, 在 <code>shiftjis</code> 下对应 <code>予</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\xdf\\</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>decode(<span style=color:#f1fa8c>&#39;big5&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>&#39;綅&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\xdf\&#39;</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>decode(<span style=color:#f1fa8c>&#39;shiftjis&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>&#34;ﾟ&#39;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\x97\\</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>decode(<span style=color:#f1fa8c>&#39;shiftjis&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>&#39;予&#39;</span>
</span></span></code></pre></div><p>测试也是能成功的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ php <span style=color:#ff79c6>-</span>a
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>Interactive shell
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SET NAMES &#39;big5&#39;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#39; or 1=1 -- 1&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    string(<span style=color:#bd93f9>1</span>) <span style=color:#f1fa8c>&#34;1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    string(<span style=color:#bd93f9>4</span>) <span style=color:#f1fa8c>&#34;An&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>....</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SET NAMES &#39;sjis&#39;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x97</span><span style=color:#f1fa8c>&#39; or 1=1 -- 1&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    string(<span style=color:#bd93f9>1</span>) <span style=color:#f1fa8c>&#34;1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    string(<span style=color:#bd93f9>3</span>) <span style=color:#f1fa8c>&#34;?D&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>  [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>....</span>
</span></span></code></pre></div><h2 id=错误使用-iconv-导致的注入>错误使用 iconv 导致的注入</h2><p>最早出处应该是 <a href=https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html title rel="noopener nofollow noreferrer" target=_blank>https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html</a> 发现, 文中给出了两种例子, 分别是 <code>iconv('utf-8', 'gbk', $input)</code> 和 <code>iconv('gbk', 'utf-8', $input)</code></p><p>先来看 <code>iconv('utf-8', 'gbk', $input)</code>,
在这种情况下, 与普通 gbk 注入不同, 不能设置 <code>$conn->query("SET NAMES 'gbk'");</code>. 而是要 <code>$conn->query("SET NAMES 'binary'");</code>, 因为我测试使用的是 docker, 默认是 latin1 字符集, 跟 binary 没有太大差别, 就不设置了.<br>代码例子如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> iconv(<span style=color:#f1fa8c>&#39;utf-8&#39;</span>, <span style=color:#f1fa8c>&#39;gbk&#39;</span>, addslashes(<span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;id&#39;</span>]));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span></code></pre></div><p>可以看到会将输入 <code>addslashes</code> 后 <code>iconv</code>, 这里能注入的原因恰好与上面相反, 这里 gbk 造成的结果是<strong>吐</strong>出来一个反斜杠而不是<strong>吃</strong>掉, 整个流程如下:</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 704 89"><g transform="translate(8,16)"><path d="M104 16h8" fill="none" stroke="currentcolor"/><path d="M152 16H296" fill="none" stroke="currentcolor"/><path d="M496 16h8" fill="none" stroke="currentcolor"/><path d="M544 16H672" fill="none" stroke="currentcolor"/><path d="M152 64h8" fill="none" stroke="currentcolor"/><path d="M2e2 64H384" fill="none" stroke="currentcolor"/><path d="M6e2 64h8" fill="none" stroke="currentcolor"/><path d="M648 64h24" fill="none" stroke="currentcolor"/><path d="M688 32V48" fill="none" stroke="currentcolor"/><polygon points="208.000000,64.000000 196.000000,58.400002 196.000000,69.599998" fill="currentcolor" transform="rotate(180.000000, 200.000000, 64.000000)"/><polygon points="304.000000,16.000000 292.000000,10.400000 292.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 296.000000, 16.000000)"/><polygon points="656.000000,64.000000 644.000000,58.400002 644.000000,69.599998" fill="currentcolor" transform="rotate(180.000000, 648.000000, 64.000000)"/><path d="M672 16a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M688 48A16 16 0 01672 64" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="8" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="16" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">運</text><text text-anchor="middle" x="24" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="32" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="40" y="68" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="48" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="56" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="64" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="72" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="80" y="68" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="96" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="104" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="128" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="136" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="176" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="184" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="192" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="216" y="52" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="224" y="4" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="224" y="52" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="232" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="232" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="240" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="248" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="248" y="52" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="256" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="256" y="52" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="264" y="4" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="264" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="272" y="52" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="280" y="4" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="280" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="288" y="52" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="296" y="52" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="304" y="52" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="312" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="312" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="320" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="320" y="52" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="328" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="336" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="336" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="344" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="52" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="352" y="20" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="352" y="52" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="360" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="360" y="52" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="368" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="368" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="376" y="20" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="376" y="52" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="384" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="392" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="400" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="400" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="408" y="20" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="408" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="416" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="416" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="424" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="424" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="432" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="440" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="440" y="68" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="448" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="448" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="456" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="464" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="464" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="472" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="472" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="480" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="480" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="488" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="496" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="504" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="512" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="520" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="520" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="528" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="528" y="68" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="544" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="552" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="568" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="576" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="576" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="584" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="584" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="592" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="600" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="608" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="616" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="624" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="624" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="632" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="632" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="640" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="648" y="4" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><p>比较重要的是在 iconv 过程中 <code>運</code> 从 utf8 转换到 gbk 的情况下, 由于其第二个字节为反斜杠. 而在 mysql 的 binary 编码下 <code>"\xdf"</code> 被认为是一个字符,这 <code>運</code> 的第二个字节的反斜杠实际上转义了 addslashes 引入的反斜杠, 导致了注入. 另外这里不能设置 <code>$conn->query("SET NAMES 'gbk'");</code> 或者 <code>$conn->set_charset('gbk');</code> 的原因是在设置之后 mysql 会以 gbk 解码, 导致 <code>"\xdf\\"</code> 被认为是一个字符, 从而无法用反斜杠转义反斜杠.</p><p>然后是 <code>iconv('gbk', 'utf-8', $input)</code>, 这种情况其实不用太多介绍 2333, 其实跟一开始<strong>吃</strong>字符的情况差不多, 不过是把本来应该由 mysql 吃掉的字符提早在 iconv 时就被吃掉了.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> iconv(<span style=color:#f1fa8c>&#39;gbk&#39;</span>, <span style=color:#f1fa8c>&#39;utf-8&#39;</span>, addslashes(<span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;id&#39;</span>]));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span></code></pre></div><p>整个流程如下:</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 696 89"><g transform="translate(8,16)"><path d="M136 16h8" fill="none" stroke="currentcolor"/><path d="M184 16H288" fill="none" stroke="currentcolor"/><path d="M440 16h8" fill="none" stroke="currentcolor"/><path d="M488 16H664" fill="none" stroke="currentcolor"/><path d="M592 64h8" fill="none" stroke="currentcolor"/><path d="M640 64h24" fill="none" stroke="currentcolor"/><path d="M680 32V48" fill="none" stroke="currentcolor"/><polygon points="296.000000,16.000000 284.000000,10.400000 284.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 288.000000, 16.000000)"/><polygon points="648.000000,64.000000 636.000000,58.400002 636.000000,69.599998" fill="currentcolor" transform="rotate(180.000000, 640.000000, 64.000000)"/><path d="M664 16a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M680 48A16 16 0 01664 64" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="160" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="168" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="224" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="232" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="248" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="256" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="264" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="304" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="312" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="320" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="328" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="336" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="352" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="360" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="368" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="384" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="392" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="408" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="408" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="416" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="416" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="424" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="424" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="432" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="440" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="448" y="68" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="456" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="464" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="464" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="472" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="472" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="480" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="488" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="496" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="496" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="504" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="504" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="512" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="512" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="520" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="520" y="68" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="528" y="4" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="536" y="4" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="536" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="544" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="544" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="552" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="560" y="4" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="560" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="568" y="4" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="568" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="576" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="576" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="584" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="600" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="608" y="4" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="616" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="616" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="624" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="624" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="632" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="640" y="4" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="648" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="656" y="4" fill="currentcolor" style="font-size:1em">)</text></g></svg></div><p>而且 mysql 的解码鲁棒性非常强, 如果设置了 <code>$conn->query("SET NAMES 'gbk'");</code>, 前两个字节会被解码为 <code>b'\xe9\x81'.decode('gbk') -> '閬'</code>, 而后面两个字节中, 会认为 <code>"x8b'"</code> 中的 <code>"\x8b"</code> 是无效的, 直接跳过并使用后面的单引号闭合字符串. 看了下 gbk, big5, shiftjis 的编码规范, 实际上第二字节的编码范围都是从 0x40 开始的, 而单引号是 0x27, 双引号是 0x22, 自然都可以直接确定不会是一个合法字符. 所以在这种情况下 <code>$conn->query("SET NAMES 'gbk'");</code> 或者 <code>$conn->set_charset('gbk');</code> 设不设置就无所谓了, 都是一样的.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/misc>misc</a></li></ul></nav></div></article></main><footer><div class=footer-info>© 2017 - 2022, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script>
<script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>