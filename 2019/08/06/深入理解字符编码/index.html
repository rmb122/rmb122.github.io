<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>æ·±å…¥ç†è§£å­—ç¬¦ç¼–ç ä»¥åŠ GBK æ³¨å…¥ - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾."><meta property="og:image" content><meta property="og:title" content="æ·±å…¥ç†è§£å­—ç¬¦ç¼–ç ä»¥åŠ GBK æ³¨å…¥"><meta property="og:description" content="ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾."><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/08/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-06T16:13:47+00:00"><meta property="article:modified_time" content="2019-08-06T16:13:47+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="æ·±å…¥ç†è§£å­—ç¬¦ç¼–ç ä»¥åŠ GBK æ³¨å…¥"><meta name=twitter:description content="ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾."><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.156ea4f9c8c3d7072fb0ea9460063a78eceb89a501e4444cfab3783b79985a3a.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.4d342f24ad49bb75f14c3b92c9454fe693d293fb7474ecc40a101a8ad6af9d71.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>é¦–é¡µ</a>&nbsp;
<a href=/posts>å½’æ¡£</a>&nbsp;
<a href=/tags>æ ‡ç­¾</a>&nbsp;
<a href=/links>å‹é“¾</a>&nbsp;
<a href=/about>å…³äº</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>æ·±å…¥ç†è§£å­—ç¬¦ç¼–ç ä»¥åŠ GBK æ³¨å…¥</h1><div class=meta>å‘è¡¨äº 2019 å¹´ 8 æœˆ 6 æ—¥</div></div><section class=body><p>ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾.</p><h2 id=unicode>unicode</h2><p>å…¶å®è¿™æ˜¯æœ€ç®€å•çš„, unicode å°±æ˜¯ä¸€å¥—æ ‡å‡†, æŠŠä¸–ç•Œä¸Šæ¯ä¸ªå­˜åœ¨çš„å­—ç¬¦ (ç”šè‡³åŒ…æ‹¬ emoji) éƒ½ç¼–ä¸€ä¸ªå·, å¯ä»¥åœ¨ <a href=https://unicode-table.com/cn/ title rel="noopener nofollow noreferrer" target=_blank>https://unicode-table.com/cn/</a> çœ‹åˆ°å…¨éƒ¨çš„ç¼–ç . è€Œè¿™ä¸ªç¼–çš„å·, ä¸€èˆ¬å«åš code point, ä¹Ÿå°±æ˜¯ç ç‚¹, è¿˜æœ‰ä¸€äº›è¯¸å¦‚å¹³é¢ (Plane) çš„æ¦‚å¿µ, å°±ä¸åœ¨æœ¬æ–‡çš„å™è¿°èŒƒå›´å†…äº†, å¯ä»¥è‡ªè¡Œäº†è§£.</p><p>åŒæ—¶ç›®å‰ä¹Ÿå­˜åœ¨å‡ ä¸ªä¸åŒçš„ç¼–ç æ ‡å‡†, ä¹Ÿå°±æ˜¯ UTF-8, UTF-16 ç­‰ç­‰, æ¯•ç«Ÿç›´æ¥æŠŠç ç‚¹è½¬äºŒè¿›åˆ¶å¤ªæµªè´¹ç©ºé—´äº†, ä¹Ÿå¯èƒ½å­˜åœ¨æ­§ä¹‰. è¿™äº›ç¼–ç çš„åŠŸèƒ½å°±æ˜¯æŠŠç ç‚¹ä¿å­˜ä¸ºè®¡ç®—æœºå¯ä»¥è¯†åˆ«çš„äºŒè¿›åˆ¶å½¢å¼.</p><h2 id=utf-8>UTF-8</h2><p>UTF-8 å°±æ˜¯è¿™äº›ç¼–ç çš„ä¸€ç§, è¯¦ç»†å¯ä»¥å‚è€ƒ<a href=https://zh.wikipedia.org/wiki/UTF-8 title rel="noopener nofollow noreferrer" target=_blank>ç»´åŸºç™¾ç§‘</a>, ç®€å•æ¥è¯´, å°±æ˜¯æŠŠç ç‚¹è½¬ä¸ºäºŒè¿›åˆ¶å,<br>ç„¶åä¸ºäº†èŠ‚çœç©ºé—´, æŠŠä¸åŒå¤§å°çš„ç ç‚¹è½¬ä¸ºä¸åŒé•¿åº¦çš„å­—èŠ‚åºåˆ—, è¿™å°±æ˜¯ä»–å¤©æ‰çš„åœ°æ–¹, ç”¨å˜é•¿ç¼–ç æ¥èŠ‚çœé•¿åº¦.</p><p>è¿™é‡Œä»¥ <code>å•Š</code> ä¸ºä¾‹, å®ƒçš„ç ç‚¹æ˜¯ <code>0x554a</code>, åœ¨ <code>U+0800~U+FFFF</code> çš„èŒƒå›´å†…, äºŒè¿›åˆ¶æ˜¯ <code>0b101010101001010</code>,<br>é‚£ä¹ˆæ ¹æ®å®šä¹‰, ä»–çš„ä¿å­˜æ–¹å¼æ˜¯ <code>1110xxxx 10xxxxxx 10xxxxxx</code>, æˆ‘ä»¬å°†è¿™ä¸ªç ç‚¹çš„äºŒè¿›åˆ¶ä»¥å¤§ç«¯çš„æ–¹å¼å¡«å…¥å…¶ä¸­,<br>å¾—åˆ° <code>1110|0101 10|010101 10|001010</code>, ä¹Ÿå°±æ˜¯ <code>b'\xe5\x95\x8a'</code>, å¯ä»¥å°è¯•åœ¨ python è§£ç , å¾—åˆ°çš„å°±æ˜¯ <code>å•Š</code>.</p><p>è€Œåœ¨ <code>0x00 ~ 0xFF</code> èŒƒå›´å†…, UTF-8 å…¶å®å°±è¢«é€€åŒ–ä¸º ASCII äº†, ä¸€æ˜¯ä¸ºäº†å…¼å®¹æ€§, äºŒæ˜¯ç¡®å® ASCII æ‰€æ¶µç›–çš„ç¬¦å·, ç¡®å®ç”¨çš„éå¸¸å¤š.<br>è¿™é‡Œå¯ä»¥æ‰‹åŠ¨å†™ä¸€äº› UTF-8 çš„å‡½æ•°æ¥åŠ æ·±å­¦ä¹ , å› ä¸ºæ˜¯å˜é•¿çš„, æ‰€ä»¥æ¥ç®—é•¿åº¦, ä»¥åŠæˆªå–ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦.<br>è¿™é‡Œç”¨æˆ‘ç”¨ c å†™, æ„Ÿè§‰éå¸¸çš„çˆ½, å°±åƒåœ¨é«˜é€Ÿå…¬è·¯ä¸Šé£™è½¦, æ§åˆ¶ä¸å¥½å°±ä¼šç¿»è½¦ (Segment fault) 233, ä½†æ˜¯ç¡®å®æ˜¯æœ€æ¥è¿‘è¿™äº›å­—ç¬¦ç¼–ç æœ¬æ¥çš„æ ·å­.<br>æ²¡æœ‰äº† python ä¸Šå„ç§çš„åŒ…è£….</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdio.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdlib.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;memory.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>read_file</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>filename) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>    FILE <span style=color:#ff79c6>*</span>fd <span style=color:#ff79c6>=</span> fopen(filename, <span style=color:#f1fa8c>&#34;r&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>    fseek(fd, <span style=color:#bd93f9>0</span>, SEEK_END);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>    <span style=color:#8be9fd>long</span> sz <span style=color:#ff79c6>=</span> ftell(fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>    fseek(fd, <span style=color:#bd93f9>0</span>, SEEK_SET);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>content <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> sz);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>    fread(content, <span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>), sz, fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>    fclose(fd);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>    <span style=color:#ff79c6>return</span> content;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>utf8_strlen</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>    <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>            length <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>    <span style=color:#ff79c6>return</span> length;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>codepoint_to_utf8</span>(<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>int</span> codepoint, <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>sz) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>    <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x80</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> codepoint;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x800</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00011111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x10000</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11100000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>12</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00001111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>4</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>12</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11110000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>18</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00000111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>    <span style=color:#ff79c6>return</span> s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>get_tail_length</span>(<span style=color:#8be9fd>char</span> c) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>    <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11110000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11110000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11100000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11100000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>    <span style=color:#ff79c6>return</span> length;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>utf8_substr</span>(<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> s, <span style=color:#8be9fd>int</span> start, <span style=color:#8be9fd>int</span> length) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>    <span style=color:#8be9fd>int</span> curr_pos <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>    <span style=color:#8be9fd>int</span> byte_count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>    <span style=color:#8be9fd>int</span> offset <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>new_s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>    <span style=color:#ff79c6>while</span> (curr_pos <span style=color:#ff79c6>&lt;</span> start <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>            curr_pos <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>        s <span style=color:#ff79c6>+=</span> (get_tail_length(<span style=color:#ff79c6>*</span>s) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>    curr_pos <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>    <span style=color:#ff79c6>while</span> (curr_pos <span style=color:#ff79c6>&lt;</span> length <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>            curr_pos <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>        byte_count<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>    <span style=color:#ff79c6>if</span> (curr_pos <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>        offset <span style=color:#ff79c6>=</span> get_tail_length(<span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>        new_s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> (byte_count <span style=color:#ff79c6>+</span> offset <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>        memcpy(new_s, s <span style=color:#ff79c6>-</span> byte_count, byte_count <span style=color:#ff79c6>+</span> offset);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>        new_s[byte_count <span style=color:#ff79c6>+</span> offset] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>        new_s <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>    <span style=color:#ff79c6>return</span> new_s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>utf8_to_codepoint</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>    <span style=color:#8be9fd>int</span> codepoint <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>    <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11110000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b111;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11110000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11100000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b1111;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11100000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11000000) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;</span> length; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>        codepoint <span style=color:#ff79c6>&lt;&lt;=</span> <span style=color:#bd93f9>6</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>        codepoint <span style=color:#ff79c6>=</span> codepoint <span style=color:#ff79c6>|</span> (<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>    <span style=color:#ff79c6>return</span> codepoint;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>    <span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span><span style=color:#6272a4>    char *content = read_file(&#34;/home/rmb122/temp/example.txt&#34;);
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span><span style=color:#6272a4>    printf(&#34;%d&#34;, utf8_strlen(content));
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span><span style=color:#6272a4>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span><span style=color:#6272a4>    free(content);
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>    printf(<span style=color:#f1fa8c>&#34;%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, utf8_strlen(<span style=color:#f1fa8c>&#34;ä¸€äºŒä¸‰å››äº”å…­ä¸€äºŒä¸‰å››äº”å…­1234&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>    <span style=color:#8be9fd>int</span> sz;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>    s <span style=color:#ff79c6>=</span> codepoint_to_utf8(<span style=color:#bd93f9>21834</span>, <span style=color:#ff79c6>&amp;</span>sz);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>    printf(<span style=color:#f1fa8c>&#34;%.*s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, sz, s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>    free(s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>    s <span style=color:#ff79c6>=</span> utf8_substr(<span style=color:#f1fa8c>&#34;ä¸€2ä¸‰å››5å…­7å…«9&#34;</span>, <span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>    <span style=color:#ff79c6>if</span> (s) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>        printf(<span style=color:#f1fa8c>&#34;%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>        printf(<span style=color:#f1fa8c>&#34;%s&#34;</span>, <span style=color:#f1fa8c>&#34;null&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>    free(s);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>    printf(<span style=color:#f1fa8c>&#34;%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, utf8_to_codepoint(<span style=color:#f1fa8c>&#34;äº”&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>}
</span></span></code></pre></div><h2 id=utf-16>UTF-16</h2><p>è¯´å®è¯, æˆ‘è§‰å¾— UTF-16 å·²ç»å¯ä»¥è¢«æ‰”è¿›å†å²çš„åƒåœ¾æ¡¶, ç„¶è€Œ <code>Windows</code> è¿˜ä¾ç„¶ä½¿ç”¨ 233.<br>ä»–æœ¬èº«æ˜¯ä¸ºäº†ä¿è¯å›ºå®šé•¿åº¦è€Œè®¾è®¡çš„, å› ä¸ºä¸¤ä¸ªå­—èŠ‚ 256*256, å¯ä»¥è¡¨ç¤º 65536 ç§å­—ç¬¦,<br>åœ¨ä»¥å‰ unicode æ”¶å½•å­—ç¬¦æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹æ˜¯å®Œå…¨å¤Ÿçš„, è¿™æ ·æ¯ä¸ªå­—ç¬¦éƒ½ä¿å­˜ä¸ºä¸¤ä¸ªå­—èŠ‚é•¿,<br>å¯ä»¥èŠ‚çœè¿ç®—, è™½ç„¶æµªè´¹äº†æŒºå¤šçš„ç©ºé—´, ä½†æ˜¯ç¡®å®å¾ˆæ–¹ä¾¿.</p><p>ç„¶è€Œç°åœ¨ä¸Šé¢çš„ç½‘ç«™ä¸Šçœ‹åˆ°, unicode æ”¶å½•çš„å­—ç¬¦æ—©å·²è¶…è¿‡äº† 65536 ä¸ª, ä¹Ÿå°±æ„å‘³ç€ç ç‚¹è¶…è¿‡äº† <code>0xFFFF</code>.<br>è¿™é‡Œä»¥ <code>ğ </code> è¿™ä¸ªå­—ç¬¦ä¸ºä¾‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>&#34;å•Š&#34;</span><span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-16be&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;UJ&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>&#34;ğ &#34;</span><span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-16be&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\xd8\x00\xdf\xa0</span><span style=color:#f1fa8c>&#39;</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°, å®é™…ä¸Šä¿å­˜è¿™ä¸ªå­—ç¬¦ç”¨äº†å››ä¸ªå­—èŠ‚, è€Œä¸æ˜¯ä¸¤ä¸ª. å†å²çš„å‘å±•ä½¿å¾— UTF-16 å”¯ä¸€çš„å¥½å¤„å·²ç»è¡ç„¶æ— å­˜.<br>è€Œä¸”ä¸ºäº†ä¿å­˜å¤§ç«¯å°ç«¯çš„é¢å¤–ä¿¡æ¯, è¿˜ç”¨äº† <code>BOM</code> è¿™ç§ä¸‘é™‹çš„è®¾è®¡, å¸Œæœ› <code>Windows</code> ä¹Ÿèƒ½æ—©ç‚¹æ·˜æ±°æ‰ UTF-16 æŠŠ 233.<br>åŸºäºä»¥ä¸ŠåŸå› , çœŸæ­£çš„ UTF-<strong>16</strong> åº”è¯¥æ˜¯ <a href=https://en.wikipedia.org/wiki/Universal_Coded_Character_Set#Encoding_forms title rel="noopener nofollow noreferrer" target=_blank>UCS-2</a>, ç°åœ¨çš„ UTF-16 åè€Œæœ‰ç‚¹ä¸ä¼¦ä¸ç±», æ—¢ç„¶å·²ç»æ˜¯å˜é•¿ç¼–ç äº†, ä¸ºä»€ä¹ˆä¸ç”¨æ›´èŠ‚çœç©ºé—´çš„ UTF-8 å‘¢?</p><h2 id=gbk>GBK</h2><p>è¿™ä¸ªæ˜¯æˆ‘å›½è‡ªåˆ›çš„ç¼–ç æ ‡å‡†, ä¼˜ç‚¹éå¸¸æ˜æ˜¾, èŠ‚çœç©ºé—´, ç›¸å½“äºç¼©å°ç‰ˆçš„ UTF-8 (å½“ç„¶ç”¨çš„ç ç‚¹è¡¨å’Œå…·ä½“å®ç°è·Ÿ unicode ä¸åŒ),<br>å› ä¸ºå®ƒåªéœ€è¦è¡¨è¾¾ ASCII + æ±‰å­—çš„å­—ç¬¦ç©ºé—´å°±å¤Ÿäº†. å½“ç„¶ç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾, ä¸èƒ½è¡¨è¾¾ ASCII + æ±‰å­—ä¹‹å¤–çš„å­—ç¬¦, ä¹Ÿå°±æ³¨å®šåªèƒ½åœ¨ä¸­å›½ä½¿ç”¨,<br>æ— æ³•å›½é™…åŒ–, è€Œä¸”å®é™…ä¸Šå¾ˆå¤šå›½å®¶éƒ½æœ‰ä¸€å¥—è‡ªåˆ›å­—ç¬¦é›†, ä¾‹å¦‚ big5, shift-jis ç­‰ç­‰, è¿™æ›´ä¿ƒè¿›äº† unicode çš„è¯ç”Ÿ.</p><h2 id=gbk-å®½å­—èŠ‚æ³¨å…¥>GBK å®½å­—èŠ‚æ³¨å…¥</h2><p>è¯´åˆ° gbk, é‚£å°±ä¸èƒ½ä¸æåˆ°ç»å…¸çš„ gbk å®½å­—èŠ‚æ³¨å…¥, å®ƒå¯ä»¥å°† php addslashes å‡½æ•°è½¬ä¹‰åå¼•å·å‰çš„åæ–œæ <strong>åƒæ‰</strong>, å¯¼è‡´æœ¬è¯¥è½¬ä¹‰æ‰çš„å•å¼•å·åˆè¢«æš´éœ²å‡ºæ¥.<br>è€Œåæ–œæ èƒ½è¢«åƒæ‰çš„åŸå› æ¥è‡ªäºéƒ¨åˆ†å­—ç¬¦é›† (æ¯”å¦‚ gbk), çš„å¤šå­—èŠ‚ç¼–ç è¡¨ç¤ºä¸­æ˜¯å…è®¸å­˜åœ¨ 0x00 - 0x7f å­˜åœ¨çš„, è¿™å¯¼è‡´ä¾‹å¦‚ç»å…¸ payload <code>é‹</code> è¿™ä¸ªå­—åœ¨ gbk ç¼–ç ä¸‹ä¸º <code>b"\xdf\\"</code>, å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªå­—èŠ‚æ­£æ˜¯åæ–œæ .<br>è¿™ç§æƒ…å†µåœ¨ utf8 ä¸­å°±ä¸å­˜åœ¨, å› ä¸º utf8 æ ‡å‡†å·²ç»è§„å®šäº†åœ¨å¤šå­—èŠ‚ç¼–ç çš„æƒ…å†µä¸‹, é™¤äº†ç¬¬ä¸€ä½çš„å­—èŠ‚åœ¨äºŒè¿›åˆ¶ä¸‹éƒ½æ˜¯ä»¥ 10 å¼€å¤´çš„, ä¹Ÿå°±æ˜¯åœ¨ [0x80, 0xbf] ä¹‹ä¸­, ä¿è¯äº†åªè¦å‡ºç°äº†äºŒè¿›åˆ¶ä¸‹é 10 å¼€å¤´çš„å­—èŠ‚, ä¸€å®šæ˜¯æ–°çš„å­—ç¬¦.</p><p>å¦‚ä¸Šé¢æ‰€è¯´, å› ä¸ºéƒ¨åˆ†å­—ç¬¦é›†çš„å¤šå­—èŠ‚ç¼–ç ä¸­å…è®¸ 0x00 - 0x7f å­˜åœ¨, mysql å®é™…ä¸Šä¼šå¯¹å®¢æˆ·ç«¯ä¼ å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œè§£ç  (å¯¹åº” <code>SET NAMES charset</code>) åå†ç¼–ç å­˜å‚¨æ¥é¿å…è§£æè¯­æ³•æ—¶çš„æ··æ·†.<br>ä¾‹å¦‚ä»¥ <code>CREATE TABLE test_gbk (id int AUTO_INCREMENT PRIMARY KEY, note VARCHAR(1024)) CHARACTER SET gbk</code> åˆ›å»ºä¸€ä¸ªè¡¨</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>import pymysql
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>mysql <span style=color:#ff79c6>=</span> pymysql.<span style=color:#50fa7b>connect</span>(host<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#ff79c6>user</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;root&#39;</span>, password<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#ff79c6>database</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;data&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>mysql.<span style=color:#50fa7b>set_charset</span>(<span style=color:#f1fa8c>&#39;gbk&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>cursor</span> <span style=color:#ff79c6>=</span> mysql.<span style=color:#ff79c6>cursor</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#39;CREATE TABLE test_gbk (id int AUTO_INCREMENT PRIMARY KEY, note VARCHAR(1024)) CHARACTER SET gbk&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#34;insert into test_gbk(`note`) values (&#39;ä½ å¥½&#39;);&#34;</span>.<span style=color:#50fa7b>encode</span>(<span style=color:#f1fa8c>&#39;gbk&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#34;insert into test_gbk(`note`) values (&#39;ä½ å¥½&#39;);&#34;</span>.<span style=color:#50fa7b>encode</span>(<span style=color:#f1fa8c>&#39;utf8&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>close</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>mysql.<span style=color:#50fa7b>commit</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>mysql.<span style=color:#50fa7b>set_charset</span>(<span style=color:#f1fa8c>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>cursor</span> <span style=color:#ff79c6>=</span> mysql.<span style=color:#ff79c6>cursor</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#34;insert into test_gbk(`note`) values (&#39;ä½ å¥½&#39;);&#34;</span>.<span style=color:#50fa7b>encode</span>(<span style=color:#f1fa8c>&#39;utf8&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>close</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>mysql.<span style=color:#50fa7b>commit</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>cursor</span> <span style=color:#ff79c6>=</span> mysql.<span style=color:#ff79c6>cursor</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>execute</span>(<span style=color:#f1fa8c>&#39;select * from test_gbk&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>ret <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>cursor</span>.<span style=color:#50fa7b>fetchall</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#50fa7b>print</span>(ret)
</span></span></code></pre></div><p>ç¬¬ä¸€æ¬¡åœ¨æŒ‡å®š gbk ç¼–ç ä¸‹åˆ†åˆ«ä»¥ gbk, utf8 ç¼–ç å†™å…¥ <code>ä½ å¥½</code>, ç¬¬äºŒæ¬¡åœ¨æŒ‡å®š utf8 ç¼–ç ä¸‹ä»¥ utf8 ç¼–ç å†™å…¥ <code>ä½ å¥½</code>, æœ€åæŸ¥è¯¢è¡¨é‡Œçš„æ•°æ®. æŸ¥è¯¢è¿”å›çš„ç»“æœä¸º <code>((1, 'ä½ å¥½'), (2, 'æµ£çŠ²ã‚½'), (3, 'ä½ å¥½'))</code>. ç¬¬ä¸€è¡Œå’Œç¬¬ä¸‰è¡Œçš„ <code>ä½ å¥½</code> ä¸å‡ºæ„å¤–, ç¬¬äºŒè¡Œå‡ºç° <code>æµ£çŠ²ã‚½</code> çš„åŸå› å°±æ¥è‡ªäºä¸Šé¢æåˆ°çš„ mysql çš„ç¼–è§£ç è¿‡ç¨‹.<br>å¯ä»¥åœ¨ python ä¸­è¾“å…¥ <code>'ä½ å¥½'.encode('utf8').decode('gbk')</code>, è¿”å›çš„ç»“æœæ­£æ˜¯ <code>æµ£çŠ²ã‚½</code>, å¯ä»¥è¯´æ˜ mysql æœåŠ¡ç«¯å®é™…ä¸Šæ˜¯ä»¥ gbk è§£ç äº† utf8 ç¼–ç åçš„äºŒè¿›åˆ¶è¡¨ç¤º <code>\xe4\xbd\xa0\xe5\xa5\xbd</code>, è€Œè¿™åˆæ°å¥½åœ¨ gbk ä¸­ä¸º <code>æµ£çŠ²ã‚½</code>.
å¦å¤–, ä¹Ÿå¯ä»¥é€šè¿‡æµé‡æ¥è¯æ˜, å®¢æˆ·ç«¯å¹¶æ²¡æœ‰åšå¤šä½™çš„æ­¥éª¤, æ˜¯æŒ‰ç…§ encode åç»“æœç›´æ¥å‘é€çš„<br><img src=https://s2.loli.net/2022/08/13/Nz5HLrZfGUPIYge.png#center alt referrerpolicy=no-referrer></p><p>è€Œå¯¹äºå­˜å‚¨, æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹æ•°æ®åº“æ–‡ä»¶è¿›è¡Œ xxd æ¥ç¡®è®¤<br><img src=https://s2.loli.net/2022/08/13/Z6FLKQyPaJGfzV1.png#center alt referrerpolicy=no-referrer>
å¯ä»¥çœ‹åˆ°å‡ºç°äº†ä¸¤æ¬¡ <code>ä½ å¥½</code> ä¸€æ¬¡ <code>æµ£çŠ²ã‚½</code>, å¯ä»¥ç¡®å®šä¸ç®¡å®¢æˆ·ç«¯çš„ç¼–ç æ˜¯å¦‚ä½•, mysql ä»ç„¶æ˜¯æŒ‰ç…§åˆ›å»ºè¡¨æ—¶æ‰€æŒ‡å®šçš„ gbk å­˜å‚¨çš„, è¿™ä¹Ÿå¯¼è‡´äº† gbk æ³¨å…¥å…¶å®åªä¸å®¢æˆ·ç«¯ç¼–ç æœ‰å…³, è€Œä¸ mysql è¡¨ä¸­çš„ç¼–ç è®¾ç½®æ˜¯æ— å…³çš„, å°±ç®—æ˜¯ <code>utf8mb4</code> ä¹Ÿä¸€æ ·å¯ä»¥æ³¨å…¥.</p><p>è¯´å›æ³¨å…¥, php å¸¸è§çš„ <code>addslashes</code> åœ¨è¿™ç§æƒ…å†µä¸‹å½“ç„¶æ— èƒ½ä¸ºäº†, è¿™ä¸ªå‡½æ•°æ²¡æœ‰è€ƒè™‘ä¹Ÿæ— æ³•å¯¹ gbk ç¼–ç çš„è¿™ç§ç‰¹æ®Šæƒ…å†µè¿›è¡Œå¤„ç†, å®ƒåœ¨è®¾è®¡ä¹‹åˆå°±æ˜¯é€å­—èŠ‚æœç´¢ç‰¹æ®Šå­—ç¬¦å¹¶è½¬ä¹‰çš„.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>echo</span> bin2hex(addslashes(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#39;&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>df5c27
</span></span></code></pre></div><p>åœ¨è¿™ç§æƒ…å†µä¸‹, æ­£ç¡®çš„è½¬ä¹‰åº”è¯¥æ˜¯å°†ä¸¤ä¸ªå­—ç¬¦éƒ½è½¬ä¹‰æˆ–è€…éƒ½ä¸è½¬ä¹‰, å› ä¸º <code>b"\xdf'"</code> æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ— æ•ˆçš„ gbk ç¼–ç , æ˜¯æ²¡æœ‰å¯¹åº”çš„å­—ç¬¦çš„, åŠ å…¥åæ–œæ åè€Œè®©å®ƒå˜æˆäº†ä¸€ä¸ªåˆæ³•çš„å­—ç¬¦, è¿˜è®©å¤šå‡ºæ¥çš„å¼•å·äº§ç”Ÿäº†æ³¨å…¥, <code>addslashes</code> å¯ä»¥è¯´æ˜¯å¸®äº†å€’å¿™.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 464 41"><g transform="translate(8,16)"><path d="M72 16H176" fill="none" stroke="currentcolor"/><path d="M280 16H408" fill="none" stroke="currentcolor"/><polygon points="184.000000,16.000000 172.000000,10.400000 172.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 176.000000, 16.000000)"/><polygon points="416.000000,16.000000 404.000000,10.400000 404.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 408.000000, 16.000000)"/><text text-anchor="middle" x="0" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="8" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="144" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="152" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="200" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="208" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="216" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="224" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="232" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="240" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="248" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="256" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="264" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="296" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="304" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="320" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="328" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="336" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="4" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="352" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="360" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="368" y="4" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="376" y="4" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="384" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="392" y="4" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="424" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="432" y="20" fill="currentcolor" style="font-size:1em">é‹</text><text text-anchor="middle" x="440" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="448" y="20" fill="currentcolor" style="font-size:1em">"</text></g></svg></div><p>è€Œå¯¹ç¼–ç¨‹è€…æ¥è¯´, å¯ä»¥ä½¿ç”¨ <code>mysqli::set_charset</code> + <code>mysqli::real_escape_string</code> æ¥å¯¹ä»˜è¿™ç§æƒ…å†µ (å½“ç„¶é¢„ç¼–è¯‘æ›´å¥½), ä¾‹å­å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>set_charset</span>(<span style=color:#f1fa8c>&#39;gbk&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>echo</span> bin2hex(<span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#39;&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bd93f9>5</span>cdf5c27
</span></span></code></pre></div><p>æ³¨æ„ <code>$conn->query("SET NAMES 'gbk'");</code> æ˜¯ä¸èƒ½è®© <code>mysqli::real_escape_string</code> æ­£å¸¸å·¥ä½œçš„, å¿…é¡»ä½¿ç”¨ <code>mysqli::set_charset</code> æ‰è¡Œ. è€Œè½¬ä¹‰æ–¹é¢ mysqli é€‰æ‹©äº†æ›´ä¿é™©çš„åšæ³•, å°†ä¸¤ä¸ªå­—ç¬¦éƒ½è¿›è¡Œäº†è½¬ä¹‰, è€Œä¸”æ¯”èµ·ä¸è½¬ä¹‰åœ¨ç¼–ç¨‹ä¸Šåº”è¯¥ä¹Ÿæ›´å®¹æ˜“å®ç°å§, å¯ä»¥çœ‹åˆ°å°±ç®—æ˜¯å•ä¸ª <code>\xdf</code> ä¹Ÿè¿›è¡Œäº†è½¬ä¹‰.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>echo</span> bin2hex(<span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bd93f9>5</span>cdf
</span></span></code></pre></div><p>è€Œæ¼æ´çš„äº§ç”Ÿæ¡ä»¶å¿…é¡»æ˜¯è¿™æ ·</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SET NAMES &#39;gbk&#39;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;id&#39;</span>]);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span></code></pre></div><p>è€Œä¸”å¦‚æœæ²¡æœ‰ä½¿ç”¨ <code>mysqli::set_charset</code> å°±ç®—æ˜¯ <code>mysqli::real_escape_string</code> ä¹Ÿæ˜¯æ— æ³•é¿å…æ³¨å…¥çš„, <code>addslashes</code> å°±æ›´ä¸ç”¨è¯´äº†. ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ <code>$conn->query("SET NAMES 'gbk'");</code> ä¹Ÿæ˜¯å¿…é¡»çš„, å¦åˆ™åœ¨ mysql ä¾§, ä¼šè®¤ä¸º <code>"\xdf"</code> ä¼šè®¤ä¸ºæ˜¯ä¸€ä¸ªå­—ç¬¦è€Œä¸æ˜¯ <code>"\xdf\\"</code>, å¯¼è‡´åæ–œæ åˆç”Ÿæ•ˆäº†.
æœ€å, åŒæ ·çš„æ¼æ´åœ¨ big5 å’Œ shiftjis ä¸Šä¹Ÿæ˜¯å­˜åœ¨çš„, åœ¨ big5 ä¸‹ <code>"\xdf\\"</code> å¯¹åº”çš„å­—ç¬¦ä¸º <code>ç¶…</code>, ä½†æ˜¯åœ¨ shiftjis å°±ä¸èƒ½ç›´æ¥ç…§æ¬äº†, <code>"\xdf"</code> åœ¨ shiftjis ä¸‹å¯¹åº” <code>ï¾Ÿ</code>, å› æ­¤ç¬¬ä¸€ä¸ªå­—ç¬¦éœ€è¦ç¨å¾® fuzz ä¸€ä¸‹ <code>[(bytes([i]) + b'\\').decode('gbk','ignore') for i in range(256)]</code>, è¿™é‡Œéšä¾¿æŒ‘å‡ºæ¥ä¸€ä¸ª <code>"\x97\\"</code>, åœ¨ <code>shiftjis</code> ä¸‹å¯¹åº” <code>äºˆ</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\xdf\\</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>decode(<span style=color:#f1fa8c>&#39;big5&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c>&#39;ç¶…&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\xdf\&#39;</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>decode(<span style=color:#f1fa8c>&#39;shiftjis&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>&#34;ï¾Ÿ&#39;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\x97\\</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>decode(<span style=color:#f1fa8c>&#39;shiftjis&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c>&#39;äºˆ&#39;</span>
</span></span></code></pre></div><p>æµ‹è¯•ä¹Ÿæ˜¯èƒ½æˆåŠŸçš„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ php <span style=color:#ff79c6>-</span>a
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>Interactive shell
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SET NAMES &#39;big5&#39;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xdf</span><span style=color:#f1fa8c>&#39; or 1=1 -- 1&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    string(<span style=color:#bd93f9>1</span>) <span style=color:#f1fa8c>&#34;1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    string(<span style=color:#bd93f9>4</span>) <span style=color:#f1fa8c>&#34;An&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>....</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>php <span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SET NAMES &#39;sjis&#39;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>real_escape_string</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x97</span><span style=color:#f1fa8c>&#39; or 1=1 -- 1&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>7</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    [<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    string(<span style=color:#bd93f9>1</span>) <span style=color:#f1fa8c>&#34;1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    string(<span style=color:#bd93f9>3</span>) <span style=color:#f1fa8c>&#34;?D&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>  [<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>  <span style=color:#ff79c6>array</span>(<span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>....</span>
</span></span></code></pre></div><h2 id=é”™è¯¯ä½¿ç”¨-iconv-å¯¼è‡´çš„æ³¨å…¥>é”™è¯¯ä½¿ç”¨ iconv å¯¼è‡´çš„æ³¨å…¥</h2><p>æœ€æ—©å‡ºå¤„åº”è¯¥æ˜¯ <a href=https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html title rel="noopener nofollow noreferrer" target=_blank>https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html</a> å‘ç°, æ–‡ä¸­ç»™å‡ºäº†ä¸¤ç§ä¾‹å­, åˆ†åˆ«æ˜¯ <code>iconv('utf-8', 'gbk', $input)</code> å’Œ <code>iconv('gbk', 'utf-8', $input)</code></p><p>å…ˆæ¥çœ‹ <code>iconv('utf-8', 'gbk', $input)</code>,
åœ¨è¿™ç§æƒ…å†µä¸‹, ä¸æ™®é€š gbk æ³¨å…¥ä¸åŒ, ä¸èƒ½è®¾ç½® <code>$conn->query("SET NAMES 'gbk'");</code>. è€Œæ˜¯è¦ <code>$conn->query("SET NAMES 'binary'");</code>, å› ä¸ºæˆ‘æµ‹è¯•ä½¿ç”¨çš„æ˜¯ docker, é»˜è®¤æ˜¯ latin1 å­—ç¬¦é›†, è·Ÿ binary æ²¡æœ‰å¤ªå¤§å·®åˆ«, å°±ä¸è®¾ç½®äº†.<br>ä»£ç ä¾‹å­å¦‚ä¸‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> iconv(<span style=color:#f1fa8c>&#39;utf-8&#39;</span>, <span style=color:#f1fa8c>&#39;gbk&#39;</span>, addslashes(<span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;id&#39;</span>]));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ä¼šå°†è¾“å…¥ <code>addslashes</code> å <code>iconv</code>, è¿™é‡Œèƒ½æ³¨å…¥çš„åŸå› æ°å¥½ä¸ä¸Šé¢ç›¸å, è¿™é‡Œ gbk é€ æˆçš„ç»“æœæ˜¯<strong>å</strong>å‡ºæ¥ä¸€ä¸ªåæ–œæ è€Œä¸æ˜¯<strong>åƒ</strong>æ‰, æ•´ä¸ªæµç¨‹å¦‚ä¸‹:</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 704 89"><g transform="translate(8,16)"><path d="M104 16h8" fill="none" stroke="currentcolor"/><path d="M152 16H296" fill="none" stroke="currentcolor"/><path d="M496 16h8" fill="none" stroke="currentcolor"/><path d="M544 16H672" fill="none" stroke="currentcolor"/><path d="M152 64h8" fill="none" stroke="currentcolor"/><path d="M2e2 64H384" fill="none" stroke="currentcolor"/><path d="M6e2 64h8" fill="none" stroke="currentcolor"/><path d="M648 64h24" fill="none" stroke="currentcolor"/><path d="M688 32V48" fill="none" stroke="currentcolor"/><polygon points="208.000000,64.000000 196.000000,58.400002 196.000000,69.599998" fill="currentcolor" transform="rotate(180.000000, 200.000000, 64.000000)"/><polygon points="304.000000,16.000000 292.000000,10.400000 292.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 296.000000, 16.000000)"/><polygon points="656.000000,64.000000 644.000000,58.400002 644.000000,69.599998" fill="currentcolor" transform="rotate(180.000000, 648.000000, 64.000000)"/><path d="M672 16a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M688 48A16 16 0 01672 64" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="8" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="16" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">é‹</text><text text-anchor="middle" x="24" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="32" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="40" y="68" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="48" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="56" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="64" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="72" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="80" y="68" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="96" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="104" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="128" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="136" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="176" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="184" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="192" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="216" y="52" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="224" y="4" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="224" y="52" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="232" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="232" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="240" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="248" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="248" y="52" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="256" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="256" y="52" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="264" y="4" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="264" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="272" y="52" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="280" y="4" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="280" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="288" y="52" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="296" y="52" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="304" y="52" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="312" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="312" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="320" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="320" y="52" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="328" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="336" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="336" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="344" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="344" y="52" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="352" y="20" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="352" y="52" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="360" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="360" y="52" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="368" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="368" y="52" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="376" y="20" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="376" y="52" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="384" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="392" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="400" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="400" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="408" y="20" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="408" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="416" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="416" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="424" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="424" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="432" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="440" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="440" y="68" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="448" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="448" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="456" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="464" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="464" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="472" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="472" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="480" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="480" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="488" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="496" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="504" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="512" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="520" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="520" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="528" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="528" y="68" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="544" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="552" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="568" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="576" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="576" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="584" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="584" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="592" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="600" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="608" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="616" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="624" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="624" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="632" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="632" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="640" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="648" y="4" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><p>æ¯”è¾ƒé‡è¦çš„æ˜¯åœ¨ iconv è¿‡ç¨‹ä¸­ <code>é‹</code> ä» utf8 è½¬æ¢åˆ° gbk çš„æƒ…å†µä¸‹, ç”±äºå…¶ç¬¬äºŒä¸ªå­—èŠ‚ä¸ºåæ–œæ . è€Œåœ¨ mysql çš„ binary ç¼–ç ä¸‹ <code>"\xdf"</code> è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå­—ç¬¦,è¿™ <code>é‹</code> çš„ç¬¬äºŒä¸ªå­—èŠ‚çš„åæ–œæ å®é™…ä¸Šè½¬ä¹‰äº† addslashes å¼•å…¥çš„åæ–œæ , å¯¼è‡´äº†æ³¨å…¥. å¦å¤–è¿™é‡Œä¸èƒ½è®¾ç½® <code>$conn->query("SET NAMES 'gbk'");</code> æˆ–è€… <code>$conn->set_charset('gbk');</code> çš„åŸå› æ˜¯åœ¨è®¾ç½®ä¹‹å mysql ä¼šä»¥ gbk è§£ç , å¯¼è‡´ <code>"\xdf\\"</code> è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå­—ç¬¦, ä»è€Œæ— æ³•ç”¨åæ–œæ è½¬ä¹‰åæ–œæ .</p><p>ç„¶åæ˜¯ <code>iconv('gbk', 'utf-8', $input)</code>, è¿™ç§æƒ…å†µå…¶å®ä¸ç”¨å¤ªå¤šä»‹ç» 2333, å…¶å®è·Ÿä¸€å¼€å§‹<strong>åƒ</strong>å­—ç¬¦çš„æƒ…å†µå·®ä¸å¤š, ä¸è¿‡æ˜¯æŠŠæœ¬æ¥åº”è¯¥ç”± mysql åƒæ‰çš„å­—ç¬¦ææ—©åœ¨ iconv æ—¶å°±è¢«åƒæ‰äº†.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>$conn</span> <span style=color:#ff79c6>=</span> mysqli_connect(<span style=color:#f1fa8c>&#39;172.17.0.2&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>, <span style=color:#f1fa8c>&#39;root&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$id</span> <span style=color:#ff79c6>=</span> iconv(<span style=color:#f1fa8c>&#39;gbk&#39;</span>, <span style=color:#f1fa8c>&#39;utf-8&#39;</span>, addslashes(<span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;id&#39;</span>]));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>$ret</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$conn</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>query</span>(<span style=color:#f1fa8c>&#34;SELECT * FROM data.test_gbk WHERE id=&#39;</span><span style=color:#f1fa8c>$id</span><span style=color:#f1fa8c>&#39;;&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ret</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>fetch_all</span>());
</span></span></code></pre></div><p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹:</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 696 89"><g transform="translate(8,16)"><path d="M136 16h8" fill="none" stroke="currentcolor"/><path d="M184 16H288" fill="none" stroke="currentcolor"/><path d="M440 16h8" fill="none" stroke="currentcolor"/><path d="M488 16H664" fill="none" stroke="currentcolor"/><path d="M592 64h8" fill="none" stroke="currentcolor"/><path d="M640 64h24" fill="none" stroke="currentcolor"/><path d="M680 32V48" fill="none" stroke="currentcolor"/><polygon points="296.000000,16.000000 284.000000,10.400000 284.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 288.000000, 16.000000)"/><polygon points="648.000000,64.000000 636.000000,58.400002 636.000000,69.599998" fill="currentcolor" transform="rotate(180.000000, 640.000000, 64.000000)"/><path d="M664 16a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M680 48A16 16 0 01664 64" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="160" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="168" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="224" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="232" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="248" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="256" y="4" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="264" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="304" y="20" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="312" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="320" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="328" y="20" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="336" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="20" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="352" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="360" y="20" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="368" y="20" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="384" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="392" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="408" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="408" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="416" y="20" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="416" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="424" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="424" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="432" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="440" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="448" y="68" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="456" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="464" y="20" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="464" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="472" y="20" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="472" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="480" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="488" y="68" fill="currentcolor" style="font-size:1em">\</text><text text-anchor="middle" x="496" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="496" y="68" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="504" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="504" y="68" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="512" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="512" y="68" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="520" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="520" y="68" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="528" y="4" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="536" y="4" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="536" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="544" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="544" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="552" y="4" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="560" y="4" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="560" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="568" y="4" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="568" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="576" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="576" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="584" y="4" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="600" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="608" y="4" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="616" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="616" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="624" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="624" y="68" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="632" y="4" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="640" y="4" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="648" y="4" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="656" y="4" fill="currentcolor" style="font-size:1em">)</text></g></svg></div><p>è€Œä¸” mysql çš„è§£ç é²æ£’æ€§éå¸¸å¼º, å¦‚æœè®¾ç½®äº† <code>$conn->query("SET NAMES 'gbk'");</code>, å‰ä¸¤ä¸ªå­—èŠ‚ä¼šè¢«è§£ç ä¸º <code>b'\xe9\x81'.decode('gbk') -> 'é–¬'</code>, è€Œåé¢ä¸¤ä¸ªå­—èŠ‚ä¸­, ä¼šè®¤ä¸º <code>"x8b'"</code> ä¸­çš„ <code>"\x8b"</code> æ˜¯æ— æ•ˆçš„, ç›´æ¥è·³è¿‡å¹¶ä½¿ç”¨åé¢çš„å•å¼•å·é—­åˆå­—ç¬¦ä¸². çœ‹äº†ä¸‹ gbk, big5, shiftjis çš„ç¼–ç è§„èŒƒ, å®é™…ä¸Šç¬¬äºŒå­—èŠ‚çš„ç¼–ç èŒƒå›´éƒ½æ˜¯ä» 0x40 å¼€å§‹çš„, è€Œå•å¼•å·æ˜¯ 0x27, åŒå¼•å·æ˜¯ 0x22, è‡ªç„¶éƒ½å¯ä»¥ç›´æ¥ç¡®å®šä¸ä¼šæ˜¯ä¸€ä¸ªåˆæ³•å­—ç¬¦. æ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ <code>$conn->query("SET NAMES 'gbk'");</code> æˆ–è€… <code>$conn->set_charset('gbk');</code> è®¾ä¸è®¾ç½®å°±æ— æ‰€è°“äº†, éƒ½æ˜¯ä¸€æ ·çš„.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/misc>misc</a></li></ul></nav></div></article></main><footer><div class=footer-info>Â© 2017 - 2022, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script>
<script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>