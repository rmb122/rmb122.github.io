<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>深入理解字符编码 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难."><meta property="og:image" content><meta property="og:title" content="深入理解字符编码"><meta property="og:description" content="以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难."><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/08/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-06T16:13:47+00:00"><meta property="article:modified_time" content="2019-08-06T16:13:47+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解字符编码"><meta name=twitter:description content="以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难."><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.21410c161c7e5bcadc5a4eccf49ce5a024e0e8fc19babbd534cfe87972f5ee51.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/about>关于</a>&nbsp;
<a href=/links>友链</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>深入理解字符编码</h1><div class=meta>发表于 2019 年 8 月 6 日</div></div><section class=body><p>以前对 UTF-8, UTF-16, unicode, GBK, ASCII 之类的都是一知半解, 其实深入之后了解这些并不困难.</p><h2 id=unicode>unicode</h2><p>其实这是最简单的, unicode 就是一套标准, 把世界上每个存在的字符 (甚至包括 emoji) 都编一个号, 可以在 <a href=https://unicode-table.com/cn/>https://unicode-table.com/cn/</a> 看到全部的编码,<br>把这个编的号, 一般叫做 code point, 也就是码点. 同时也设定了几个编码的标准, 也就是 UTF-8, UTF-16 等等, 毕竟直接把码点转二进制太浪费空间了.</p><p>而这些编码, 就是把这些码点保存为计算机可以识别的二进制形式.</p><h2 id=utf-8>UTF-8</h2><p>UTF-8 就是这些编码的一种, 详细可以参考<a href=https://zh.wikipedia.org/wiki/UTF-8>维基百科</a>, 简单来说, 就是把码点转为二进制后,<br>然后为了节省空间, 把不同大小的码点转为不同长度的字节序列, 这就是他天才的地方, 用变长编码来节省长度.</p><p>这里以 <code>啊</code> 为例, 它的码点是 <code>0x554a</code>, 在 <code>U+0800~U+FFFF</code> 的范围内, 二进制是 <code>0b101010101001010</code>,<br>那么根据定义, 他的保存方式是 <code>1110xxxx 10xxxxxx 10xxxxxx</code>, 我们将这个码点的二进制以大端的方式填入其中,<br>得到 <code>1110|0101 10|010101 10|001010</code>, 也就是 <code>b'\xe5\x95\x8a'</code>, 可以尝试在 python 解码, 得到的就是 <code>啊</code>.</p><p>而在 <code>0x00 ~ 0xFF</code> 范围内, UTF-8 其实就被退化为 ASCII 了, 一是为了兼容性, 二是确实 ASCII 所涵盖的符号, 确实用的非常多.<br>这里可以手动写一些 UTF-8 的函数来加深学习, 因为是变长的, 所以来算长度, 以及截取相对比较麻烦.<br>这里用我用 c 写, 感觉非常的爽, 就像在高速公路上飙车, 控制不好就会翻车 (Segment fault) 233, 但是确实是最接近这些字符编码本来的样子.<br>没有了 python 上各种的包装.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdio.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdlib.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;memory.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>read_file</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>filename) {
</span></span><span style=display:flex><span>    FILE <span style=color:#ff79c6>*</span>fd <span style=color:#ff79c6>=</span> fopen(filename, <span style=color:#f1fa8c>&#34;r&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fseek(fd, <span style=color:#bd93f9>0</span>, SEEK_END);
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> sz <span style=color:#ff79c6>=</span> ftell(fd);
</span></span><span style=display:flex><span>    fseek(fd, <span style=color:#bd93f9>0</span>, SEEK_SET);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>content <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> sz);
</span></span><span style=display:flex><span>    fread(content, <span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>), sz, fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fclose(fd);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> content;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>utf8_strlen</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span>            length <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> length;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>codepoint_to_utf8</span>(<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>int</span> codepoint, <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>sz) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x80</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>));
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> codepoint;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x800</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00011111);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (codepoint <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x10000</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>3</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11100000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>12</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00001111);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>sz <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span>        s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>4</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>3</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> (codepoint <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>6</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b10000000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>12</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>b11110000 <span style=color:#ff79c6>|</span> ((codepoint <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>18</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00000111);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> s;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>get_tail_length</span>(<span style=color:#8be9fd>char</span> c) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11110000) {
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11110000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11100000) {
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((c <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11100000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11000000) {
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> length;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> <span style=color:#50fa7b>utf8_substr</span>(<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> s, <span style=color:#8be9fd>int</span> start, <span style=color:#8be9fd>int</span> length) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> curr_pos <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> byte_count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> offset <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>new_s;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> (curr_pos <span style=color:#ff79c6>&lt;</span> start <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span>            curr_pos <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        s <span style=color:#ff79c6>+=</span> (get_tail_length(<span style=color:#ff79c6>*</span>s) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    curr_pos <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> (curr_pos <span style=color:#ff79c6>&lt;</span> length <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11000000) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>b10000000) {
</span></span><span style=display:flex><span>            curr_pos <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>        byte_count<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (curr_pos <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        offset <span style=color:#ff79c6>=</span> get_tail_length(<span style=color:#ff79c6>*</span>(s <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        new_s <span style=color:#ff79c6>=</span> malloc(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>char</span>) <span style=color:#ff79c6>*</span> (byte_count <span style=color:#ff79c6>+</span> offset <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>        memcpy(new_s, s <span style=color:#ff79c6>-</span> byte_count, byte_count <span style=color:#ff79c6>+</span> offset);
</span></span><span style=display:flex><span>        new_s[byte_count <span style=color:#ff79c6>+</span> offset] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        new_s <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> new_s;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>utf8_to_codepoint</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> codepoint <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11110000) {
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b111;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11110000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11100000) {
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b1111;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11100000) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>b11000000) {
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b11111;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        codepoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;</span> length; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>        s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>        codepoint <span style=color:#ff79c6>&lt;&lt;=</span> <span style=color:#bd93f9>6</span>;
</span></span><span style=display:flex><span>        codepoint <span style=color:#ff79c6>=</span> codepoint <span style=color:#ff79c6>|</span> (<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0</span>b00111111);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> codepoint;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/*
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    char *content = read_file(&#34;/home/rmb122/temp/example.txt&#34;);
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    printf(&#34;%d&#34;, utf8_strlen(content));
</span></span></span><span style=display:flex><span><span style=color:#6272a4>
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    free(content);
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    printf(<span style=color:#f1fa8c>&#34;%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, utf8_strlen(<span style=color:#f1fa8c>&#34;一二三四五六一二三四五六1234&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> sz;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    s <span style=color:#ff79c6>=</span> codepoint_to_utf8(<span style=color:#bd93f9>21834</span>, <span style=color:#ff79c6>&amp;</span>sz);
</span></span><span style=display:flex><span>    printf(<span style=color:#f1fa8c>&#34;%.*s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, sz, s);
</span></span><span style=display:flex><span>    free(s);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    s <span style=color:#ff79c6>=</span> utf8_substr(<span style=color:#f1fa8c>&#34;一2三四5六7八9&#34;</span>, <span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (s) {
</span></span><span style=display:flex><span>        printf(<span style=color:#f1fa8c>&#34;%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, s);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        printf(<span style=color:#f1fa8c>&#34;%s&#34;</span>, <span style=color:#f1fa8c>&#34;null&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    free(s);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    printf(<span style=color:#f1fa8c>&#34;%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, utf8_to_codepoint(<span style=color:#f1fa8c>&#34;五&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=utf-16>UTF-16</h2><p>说实话, 我觉得 UTF-16 已经可以被扔进历史的垃圾桶, 然而 <code>Windows</code> 还依然使用 233.<br>他本身是为了保证固定长度而设计的, 因为两个字节 256*256, 可以表示 65536 种字符,<br>在以前 unicode 收录字符比较少的情况下是完全够的, 这样每个字符都保存为两个字节长,<br>可以节省运算, 虽然浪费了挺多的空间, 但是确实很方便.</p><p>然而现在上面的网站上看到, unicode 收录的字符早已超过了 65536 个, 也就意味着码点超过了 <code>0xFFFF</code>.<br>这里以 <code>𐎠</code> 这个字符为例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>&#34;啊&#34;</span><span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-16be&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;UJ&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#f1fa8c>&#34;𐎠&#34;</span><span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-16be&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\xd8\x00\xdf\xa0</span><span style=color:#f1fa8c>&#39;</span>
</span></span></code></pre></div><p>可以看到, 实际上保存这个字符用了 4 个字节. 历史的发展使得 UTF-16 唯一的好处已经荡然无存.<br>而且为了保存大端小端的额外信息, 还用了 <code>BOM</code> 这种丑陋的设计, 希望 <code>Windows</code> 也能早点淘汰掉 UTF-16 把 233</p><h2 id=gbk>GBK</h2><p>这个是我国自创的编码标准, 优点非常明显, 节省空间, 相当于缩小版的 UTF-8 (当然用的码点表和具体实现跟 unicode 不同),<br>因为它只需要表达 ASCII + 汉字的字符空间就够了. 当然缺点也非常明显, 不能表达 ASCII + 汉字之外的字符, 也就注定只能在中国使用,<br>无法国际化, 而且实际上很多国家都有一套自创字符集, 这更促进了 unicode 的诞生.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/misc>misc</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 @rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>