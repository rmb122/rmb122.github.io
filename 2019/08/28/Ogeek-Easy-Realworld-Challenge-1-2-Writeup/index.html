<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Ogeek Easy Realworld Challenge 1&2 Writeup - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="这次 Ogeek 的 web 都挺有意思. 这两题偏向代码审计, 而且如题目名 Easy Realworld, 都是审计应用本身的漏洞, 差不多就是找 0day 了, 在这里分享给大家."><meta property="og:image" content><meta property="og:title" content="Ogeek Easy Realworld Challenge 1&2 Writeup"><meta property="og:description" content="这次 Ogeek 的 web 都挺有意思. 这两题偏向代码审计, 而且如题目名 Easy Realworld, 都是审计应用本身的漏洞, 差不多就是找 0day 了, 在这里分享给大家."><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2019/08/28/Ogeek-Easy-Realworld-Challenge-1-2-Writeup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-28T09:58:59+00:00"><meta property="article:modified_time" content="2019-08-28T09:58:59+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ogeek Easy Realworld Challenge 1&2 Writeup"><meta name=twitter:description content="这次 Ogeek 的 web 都挺有意思. 这两题偏向代码审计, 而且如题目名 Easy Realworld, 都是审计应用本身的漏洞, 差不多就是找 0day 了, 在这里分享给大家."><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.156ea4f9c8c3d7072fb0ea9460063a78eceb89a501e4444cfab3783b79985a3a.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.4d342f24ad49bb75f14c3b92c9454fe693d293fb7474ecc40a101a8ad6af9d71.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Ogeek Easy Realworld Challenge 1&2 Writeup</h1><div class=meta>发表于 2019 年 8 月 28 日</div></div><section class=body><p>这次 Ogeek 的 web 都挺有意思. 这两题偏向代码审计, 而且如题目名 <code>Easy Realworld</code>, 都是审计应用本身的漏洞, 差不多就是找 0day 了, 在这里分享给大家.</p><h2 id=ogeek-easy-realworld-challenge-1>Ogeek Easy Realworld Challenge 1</h2><p>打开网页, 发现是个在线 ssh 连接器, 根据写的大大 <code>Gateone</code>, 在 github 上找到 <code>https://github.com/liftoff/GateOne</code>, 而且上次更新是 2017 年, 很可能存在未修复漏洞. 先 fuzz 了一波没有什么收获, 而且几乎是刚开箱的状态, 于是尝试代码审计.</p><p>根据 <code>run_gateone.py</code> 里面的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>from</span> gateone.core.server <span style=color:#ff79c6>import</span> main
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>main(installed<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>)
</span></span></code></pre></div><p>找到 web 服务 <code>gateone/core/server.py</code>,<br>在 3692 行可以找到 设置 Handler 的地方,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>handlers <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>            (index_regex, MainHandler),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>            (<span style=color:#f1fa8c>r</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>ws&#34;</span> <span style=color:#ff79c6>%</span> url_prefix,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>                ApplicationWebSocket, <span style=color:#8be9fd;font-style:italic>dict</span>(apps<span style=color:#ff79c6>=</span>APPLICATIONS)),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            (<span style=color:#f1fa8c>r</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>auth&#34;</span> <span style=color:#ff79c6>%</span> url_prefix, AuthHandler),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            (<span style=color:#f1fa8c>r</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>downloads/(.*)&#34;</span> <span style=color:#ff79c6>%</span> url_prefix, DownloadHandler),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            (<span style=color:#f1fa8c>r</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>docs/(.*)&#34;</span> <span style=color:#ff79c6>%</span> url_prefix, tornado<span style=color:#ff79c6>.</span>web<span style=color:#ff79c6>.</span>StaticFileHandler, {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                <span style=color:#f1fa8c>&#34;path&#34;</span>: docs_path,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                <span style=color:#f1fa8c>&#34;default_filename&#34;</span>: <span style=color:#f1fa8c>&#34;index.html&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        ]
</span></span></code></pre></div><p>可以发现 <code>downloads/</code> 用的不是 tornado 自带的 StaticFileHandler, 而是作者自己造的轮子, 可能存在漏洞.<br>在 924 行可以找到 get 方法的定义</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get</span>(self, path, include_body<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        session_dir <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>settings[<span style=color:#f1fa8c>&#39;session_dir&#39;</span>]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        user <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>current_user
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>if</span> user <span style=color:#ff79c6>and</span> <span style=color:#f1fa8c>&#39;session&#39;</span> <span style=color:#ff79c6>in</span> user:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            session <span style=color:#ff79c6>=</span> user[<span style=color:#f1fa8c>&#39;session&#39;</span>]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            logger<span style=color:#ff79c6>.</span>error(_(<span style=color:#f1fa8c>&#34;DownloadHandler: Could not determine use session&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#6272a4># Something is wrong</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        filepath <span style=color:#ff79c6>=</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>join(session_dir, session, <span style=color:#f1fa8c>&#39;downloads&#39;</span>, path)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        abspath <span style=color:#ff79c6>=</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>abspath(filepath)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>exists(abspath):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            self<span style=color:#ff79c6>.</span>set_status(<span style=color:#bd93f9>404</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            self<span style=color:#ff79c6>.</span>write(self<span style=color:#ff79c6>.</span>get_error_html(<span style=color:#bd93f9>404</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>isfile(abspath):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            <span style=color:#ff79c6>raise</span> tornado<span style=color:#ff79c6>.</span>web<span style=color:#ff79c6>.</span>HTTPError(<span style=color:#bd93f9>403</span>, <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c> is not a file&#34;</span>, path)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#ff79c6>import</span> stat<span style=color:#ff79c6>,</span> mimetypes
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        stat_result <span style=color:#ff79c6>=</span> os<span style=color:#ff79c6>.</span>stat(abspath)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        modified <span style=color:#ff79c6>=</span> datetime<span style=color:#ff79c6>.</span>fromtimestamp(stat_result[stat<span style=color:#ff79c6>.</span>ST_MTIME])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        self<span style=color:#ff79c6>.</span>set_header(<span style=color:#f1fa8c>&#34;Last-Modified&#34;</span>, modified)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        mime_type, encoding <span style=color:#ff79c6>=</span> mimetypes<span style=color:#ff79c6>.</span>guess_type(abspath)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#ff79c6>if</span> mime_type:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            self<span style=color:#ff79c6>.</span>set_header(<span style=color:#f1fa8c>&#34;Content-Type&#34;</span>, mime_type)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#6272a4># Set the Cache-Control header to private since this file is not meant</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#6272a4># to be public.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        self<span style=color:#ff79c6>.</span>set_header(<span style=color:#f1fa8c>&#34;Cache-Control&#34;</span>, <span style=color:#f1fa8c>&#34;private&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#6272a4># Add some additional headers</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        self<span style=color:#ff79c6>.</span>set_header(<span style=color:#f1fa8c>&#39;Access-Control-Allow-Origin&#39;</span>, <span style=color:#f1fa8c>&#39;*&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#6272a4># Check the If-Modified-Since, and don&#39;t send the result if the</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#6272a4># content has not been modified</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        ims_value <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>headers<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;If-Modified-Since&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        <span style=color:#ff79c6>if</span> ims_value <span style=color:#ff79c6>is</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>None</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#ff79c6>import</span> email.utils
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            date_tuple <span style=color:#ff79c6>=</span> email<span style=color:#ff79c6>.</span>utils<span style=color:#ff79c6>.</span>parsedate(ims_value)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            if_since <span style=color:#ff79c6>=</span> datetime<span style=color:#ff79c6>.</span>fromtimestamp(time<span style=color:#ff79c6>.</span>mktime(date_tuple))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>            <span style=color:#ff79c6>if</span> if_since <span style=color:#ff79c6>&gt;=</span> modified:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>                self<span style=color:#ff79c6>.</span>set_status(<span style=color:#bd93f9>304</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>                <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        <span style=color:#6272a4># Finally, deliver the file</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>        <span style=color:#ff79c6>with</span> io<span style=color:#ff79c6>.</span>open(abspath, <span style=color:#f1fa8c>&#34;rb&#34;</span>) <span style=color:#ff79c6>as</span> file:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>            data <span style=color:#ff79c6>=</span> file<span style=color:#ff79c6>.</span>read()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            hasher <span style=color:#ff79c6>=</span> hashlib<span style=color:#ff79c6>.</span>sha1()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>            hasher<span style=color:#ff79c6>.</span>update(data)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>            self<span style=color:#ff79c6>.</span>set_header(<span style=color:#f1fa8c>&#34;Etag&#34;</span>, <span style=color:#f1fa8c>&#39;&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>&#34;&#39;</span> <span style=color:#ff79c6>%</span> hasher<span style=color:#ff79c6>.</span>hexdigest())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>            <span style=color:#ff79c6>if</span> include_body:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>                self<span style=color:#ff79c6>.</span>write(data)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>            <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>                <span style=color:#ff79c6>assert</span> self<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>method <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;HEAD&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                self<span style=color:#ff79c6>.</span>set_header(<span style=color:#f1fa8c>&#34;Content-Length&#34;</span>, <span style=color:#8be9fd;font-style:italic>len</span>(data))
</span></span></code></pre></div><p>注意关键部分,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>filepath <span style=color:#ff79c6>=</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>join(session_dir, session, <span style=color:#f1fa8c>&#39;downloads&#39;</span>, path)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>abspath <span style=color:#ff79c6>=</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>abspath(filepath)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>exists(abspath):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    self<span style=color:#ff79c6>.</span>set_status(<span style=color:#bd93f9>404</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    self<span style=color:#ff79c6>.</span>write(self<span style=color:#ff79c6>.</span>get_error_html(<span style=color:#bd93f9>404</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>isfile(abspath):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    <span style=color:#ff79c6>raise</span> tornado<span style=color:#ff79c6>.</span>web<span style=color:#ff79c6>.</span>HTTPError(<span style=color:#bd93f9>403</span>, <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c> is not a file&#34;</span>, path)
</span></span></code></pre></div><p>可以看到没有任何的过滤, 就把 <code>path</code> 拼进了 <code>filepath</code>, 存在目录穿越, 可以任意文件读.</p><p><img src=https://i.loli.net/2019/08/26/JbZuMYALTe7ivFn.png#center alt></p><p>读 <code>/etc/passwd</code> 找到用户 ctf, 继续 fuzz 一些常用文件, 可以读到 <code>/home/ctf/.bash_history</code>,</p><p><img src=https://i.loli.net/2019/08/26/5Ay41drtXPIopGT.png#center alt></p><p>给了 <code>ftp niconiconi</code> 这应该就是题目描述里的内网机器了, 但是我们此时并没有连接 ftp 服务的能力.<br>继续审计源码, 可以发现 <code>gateone/applications/terminal/plugins/ssh/scripts/ssh_connect.py</code> 里的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>elif</span> protocol <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;telnet&#39;</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> user:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#8be9fd;font-style:italic>print</span>(_(<span style=color:#f1fa8c>&#39;Connecting to telnet://</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>@</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>&#39;</span> <span style=color:#ff79c6>%</span> (user, host, port)))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#6272a4># Set title</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x1b</span><span style=color:#f1fa8c>]0;telnet://</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>@</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>\007</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>%</span> (user, host))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#8be9fd;font-style:italic>print</span>(_(<span style=color:#f1fa8c>&#39;Connecting to telnet://</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>&#39;</span> <span style=color:#ff79c6>%</span> (host, port)))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#6272a4># Set title</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x1b</span><span style=color:#f1fa8c>]0;telnet://</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>\007</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>%</span> host)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    telnet_connect(user, host, port)
</span></span></code></pre></div><p>可以发现其实支持 <code>telnet</code>, 只是没有写出来&mldr;, 而 <code>telnet</code> 基本上跟 <code>nc</code> 差不多, 我们可以手敲 ftp 命令来获取 flag<br>随便试一下, 发现 <code>ctf</code>, <code>ctf</code> 就是账号密码</p><p><img src=https://i.loli.net/2019/08/26/mhANxTvoCfXYMaQ.png#center alt></p><p><img src=https://i.loli.net/2019/08/26/OqzgWR47sx3NED9.png#center alt></p><p>这里注意 ftp 传输文件还需要开另一个链接, 可以选择客户端链接服务器 (PASV) 或者 服务器链接客户端 (PORT), 这里当然是客户端链接服务器.<br>服务器会返回一个 (ip1, ip2, ip3, ip4, p1, p2), p1 * 256 + p2 就是我们需要链接的端口, 然后用 RERT 命令就能读取文件了.</p><p>这里还有个小插曲, 这个应用还自带回放功能, 于是可以偷看别人的 flag&mldr;</p><p><img src=https://i.loli.net/2019/08/26/7tXZLBCm8nVlvuU.png#center alt></p><p>所以我猜后面改题目, 把 flag 设成一半在本机 <code>/flag</code> 上, 一半在内网 ftp 的原因就是这个 2333<br>而且后面又改了一次, 还加了一题 <code>Easy Realworld Challenge 2</code>, 可能就是某位大佬发现的 RCE 导致了非预期</p><h2 id=ogeek-easy-realworld-challenge-2>Ogeek Easy Realworld Challenge 2</h2><p>到我们目前的能力是任意文件读取 + SSRF, 根据题目描述, 应该是得拿到 shell 才能读 flag 了. 于是只能继续审计源码 233</p><p>可以看到在 ssh 链接时, 是直接拼的命令, 然后放到一个文件里面调用 execvpe 执行 /bin/sh 来跑这个命令, 但是过滤还是很严格的, 没办法注入命令,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>bad_chars</span>(chars):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>import</span> re
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    bad_chars <span style=color:#ff79c6>=</span> re<span style=color:#ff79c6>.</span>compile(<span style=color:#f1fa8c>&#39;.*[\$</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>\!\;&amp;` |&lt;&gt;].*&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> bad_chars<span style=color:#ff79c6>.</span>match(chars):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>False</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>#...</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>while</span> <span style=color:#ff79c6>not</span> validated:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> url:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        url <span style=color:#ff79c6>=</span> raw_input(_(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#f1fa8c>&#34;[Press Shift-F1 for help]</span><span style=color:#f1fa8c>\n\n</span><span style=color:#f1fa8c>Host/IP or ssh:// URL</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>: &#34;</span> <span style=color:#ff79c6>%</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            default_host_str))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>if</span> bad_chars(url):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        raw_input(invalid_hostname_err)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        url <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>None</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>continue</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> url:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#ff79c6>if</span> options<span style=color:#ff79c6>.</span>default_host:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            host <span style=color:#ff79c6>=</span> options<span style=color:#ff79c6>.</span>default_host
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            protocol <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ssh&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            validated <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            raw_input(invalid_hostname_err)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#ff79c6>continue</span>
</span></span></code></pre></div><p>但是这个不仅仅有个 ssh 链接的功能, 还能生成 ssh 秘钥,</p><p><img src=https://i.loli.net/2019/08/26/s7pjlYCm6RLKhPV.png#center alt></p><p>我们仔细来看这个 <code>gateone/applications/terminal/plugins/ssh/ssh.py</code> 第 615 行 <code>generate_new_keypair</code>,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>if</span> which(<span style=color:#f1fa8c>&#39;ssh-keygen&#39;</span>): <span style=color:#6272a4># Prefer OpenSSH</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    openssh_generate_new_keypair(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        self,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        name, <span style=color:#6272a4># Name to use when generating the keypair</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        users_ssh_dir, <span style=color:#6272a4># Path to save it</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        keytype<span style=color:#ff79c6>=</span>keytype,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        passphrase<span style=color:#ff79c6>=</span>passphrase,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        bits<span style=color:#ff79c6>=</span>bits,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        comment<span style=color:#ff79c6>=</span>comment
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    )
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>elif</span> which(<span style=color:#f1fa8c>&#39;dropbearkey&#39;</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    dropbear_generate_new_keypair(self,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        name, <span style=color:#6272a4># Name to use when generating the keypair</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        users_ssh_dir, <span style=color:#6272a4># Path to save it</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        keytype<span style=color:#ff79c6>=</span>keytype,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        passphrase<span style=color:#ff79c6>=</span>passphrase,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        bits<span style=color:#ff79c6>=</span>bits,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        comment<span style=color:#ff79c6>=</span>comment)
</span></span></code></pre></div><p>会判断用的是 openssh 或者 dropbear 来调用对应的秘钥生成命令, 这里肯定是 openssh, 来到 699 行 <code>openssh_generate_new_keypair</code>, 可以看到</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>openssh_generate_new_keypair</span>(self, name, path,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        keytype<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>, passphrase<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>, bits<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>, comment<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    self<span style=color:#ff79c6>.</span>ssh_log<span style=color:#ff79c6>.</span>debug(<span style=color:#f1fa8c>&#39;openssh_generate_new_keypair()&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    openssh_version <span style=color:#ff79c6>=</span> shell_command(<span style=color:#f1fa8c>&#39;ssh -V&#39;</span>)[<span style=color:#bd93f9>1</span>]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ssh_major_version <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>int</span>(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        openssh_version<span style=color:#ff79c6>.</span>split()[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;_&#39;</span>)[<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;.&#39;</span>)[<span style=color:#bd93f9>0</span>])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    key_path <span style=color:#ff79c6>=</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>join(path, name)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    ssh_keygen_path <span style=color:#ff79c6>=</span> which(<span style=color:#f1fa8c>&#39;ssh-keygen&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    command <span style=color:#ff79c6>=</span> (
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c> &#34;</span>       <span style=color:#6272a4># Path to ssh-keygen</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#f1fa8c>&#34;-b </span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c> &#34;</span>    <span style=color:#6272a4># bits</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#f1fa8c>&#34;-t </span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c> &#34;</span>    <span style=color:#6272a4># keytype</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#f1fa8c>&#34;-C &#39;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>&#39; &#34;</span>  <span style=color:#6272a4># comment</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#f1fa8c>&#34;-f &#39;</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>&#39;&#34;</span>   <span style=color:#6272a4># Key path</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#ff79c6>%</span> (ssh_keygen_path, bits, keytype, comment, key_path)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    )
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    self<span style=color:#ff79c6>.</span>ssh_log<span style=color:#ff79c6>.</span>debug(<span style=color:#f1fa8c>&#34;Keygen command: </span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>%</span> command)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    m <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>new_multiplex(command, <span style=color:#f1fa8c>&#34;gen_ssh_keypair&#34;</span>)
</span></span></code></pre></div><p>同样是拼的命令, 不同的是没有了过滤. 因为 name 可控, 最后导致 keypath 可控, 我们只需要注入一个 <code>';some cmd;'</code> 就能注入我们自己的命令了.</p><p>这里可以用 Burpsuite 来改 websocket 的内容</p><p><img src=https://i.loli.net/2019/08/26/wPzJEIvnuGDHyqj.png#center alt></p><p>然后结合之前的任意文件读取来读命令执行的结果</p><p><img src=https://i.loli.net/2019/08/26/PctX1T9qjbD7KM2.png#center alt></p><p>然后就可以发现 flag 啦, 可以直接读. 另外, 除了这个地方还有其他地方也有同样的问题, 这里不再一一举出.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/web>web</a></li><li><a href=/tags/audit>audit</a></li></ul></nav></div></article></main><footer><div class=footer-info>© 2017 - 2022, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script>
<script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>