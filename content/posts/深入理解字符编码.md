---
title: æ·±å…¥ç†è§£å­—ç¬¦ç¼–ç ä»¥åŠ GBK æ³¨å…¥
date: 2019-08-06 16:13:47
tags: [misc]
---

ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾.  

<!--more-->

## unicode

å…¶å®è¿™æ˜¯æœ€ç®€å•çš„, unicode å°±æ˜¯ä¸€å¥—æ ‡å‡†, æŠŠä¸–ç•Œä¸Šæ¯ä¸ªå­˜åœ¨çš„å­—ç¬¦ (ç”šè‡³åŒ…æ‹¬ emoji) éƒ½ç¼–ä¸€ä¸ªå·, å¯ä»¥åœ¨ https://unicode-table.com/cn/ çœ‹åˆ°å…¨éƒ¨çš„ç¼–ç . è€Œè¿™ä¸ªç¼–çš„å·, ä¸€èˆ¬å«åš code point, ä¹Ÿå°±æ˜¯ç ç‚¹, è¿˜æœ‰ä¸€äº›è¯¸å¦‚å¹³é¢ (Plane) çš„æ¦‚å¿µ, å°±ä¸åœ¨æœ¬æ–‡çš„å™è¿°èŒƒå›´å†…äº†, å¯ä»¥è‡ªè¡Œäº†è§£.  

åŒæ—¶ç›®å‰ä¹Ÿå­˜åœ¨å‡ ä¸ªä¸åŒçš„ç¼–ç æ ‡å‡†, ä¹Ÿå°±æ˜¯ UTF-8, UTF-16 ç­‰ç­‰, æ¯•ç«Ÿç›´æ¥æŠŠç ç‚¹è½¬äºŒè¿›åˆ¶å¤ªæµªè´¹ç©ºé—´äº†, ä¹Ÿå¯èƒ½å­˜åœ¨æ­§ä¹‰. è¿™äº›ç¼–ç çš„åŠŸèƒ½å°±æ˜¯æŠŠç ç‚¹ä¿å­˜ä¸ºè®¡ç®—æœºå¯ä»¥è¯†åˆ«çš„äºŒè¿›åˆ¶å½¢å¼.  

## UTF-8

UTF-8 å°±æ˜¯è¿™äº›ç¼–ç çš„ä¸€ç§, è¯¦ç»†å¯ä»¥å‚è€ƒ[ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/UTF-8), ç®€å•æ¥è¯´, å°±æ˜¯æŠŠç ç‚¹è½¬ä¸ºäºŒè¿›åˆ¶å,  
ç„¶åä¸ºäº†èŠ‚çœç©ºé—´, æŠŠä¸åŒå¤§å°çš„ç ç‚¹è½¬ä¸ºä¸åŒé•¿åº¦çš„å­—èŠ‚åºåˆ—, è¿™å°±æ˜¯ä»–å¤©æ‰çš„åœ°æ–¹, ç”¨å˜é•¿ç¼–ç æ¥èŠ‚çœé•¿åº¦.  

è¿™é‡Œä»¥ `å•Š` ä¸ºä¾‹, å®ƒçš„ç ç‚¹æ˜¯ `0x554a`, åœ¨ `U+0800~U+FFFF` çš„èŒƒå›´å†…, äºŒè¿›åˆ¶æ˜¯ `0b101010101001010`,  
é‚£ä¹ˆæ ¹æ®å®šä¹‰, ä»–çš„ä¿å­˜æ–¹å¼æ˜¯ `1110xxxx 10xxxxxx 10xxxxxx`, æˆ‘ä»¬å°†è¿™ä¸ªç ç‚¹çš„äºŒè¿›åˆ¶ä»¥å¤§ç«¯çš„æ–¹å¼å¡«å…¥å…¶ä¸­,  
å¾—åˆ° `1110|0101 10|010101 10|001010`, ä¹Ÿå°±æ˜¯ `b'\xe5\x95\x8a'`, å¯ä»¥å°è¯•åœ¨ python è§£ç , å¾—åˆ°çš„å°±æ˜¯ `å•Š`.  

è€Œåœ¨ `0x00 ~ 0xFF` èŒƒå›´å†…, UTF-8 å…¶å®å°±è¢«é€€åŒ–ä¸º ASCII äº†, ä¸€æ˜¯ä¸ºäº†å…¼å®¹æ€§, äºŒæ˜¯ç¡®å® ASCII æ‰€æ¶µç›–çš„ç¬¦å·, ç¡®å®ç”¨çš„éå¸¸å¤š.  
è¿™é‡Œå¯ä»¥æ‰‹åŠ¨å†™ä¸€äº› UTF-8 çš„å‡½æ•°æ¥åŠ æ·±å­¦ä¹ , å› ä¸ºæ˜¯å˜é•¿çš„, æ‰€ä»¥æ¥ç®—é•¿åº¦, ä»¥åŠæˆªå–ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦.  
è¿™é‡Œç”¨æˆ‘ç”¨ c å†™, æ„Ÿè§‰éå¸¸çš„çˆ½, å°±åƒåœ¨é«˜é€Ÿå…¬è·¯ä¸Šé£™è½¦, æ§åˆ¶ä¸å¥½å°±ä¼šç¿»è½¦ (Segment fault) 233, ä½†æ˜¯ç¡®å®æ˜¯æœ€æ¥è¿‘è¿™äº›å­—ç¬¦ç¼–ç æœ¬æ¥çš„æ ·å­.  
æ²¡æœ‰äº† python ä¸Šå„ç§çš„åŒ…è£….  

```c
#include <stdio.h>
#include <stdlib.h>
#include <memory.h>

char* read_file(char *filename) {
    FILE *fd = fopen(filename, "r");

    fseek(fd, 0, SEEK_END);
    long sz = ftell(fd);
    fseek(fd, 0, SEEK_SET);

    char *content = malloc(sizeof(char) * sz);
    fread(content, sizeof(char), sz, fd);

    fclose(fd);
    return content;
}

int utf8_strlen(char *s) {
    int length = 0;

    while (*s) {
        if ((*s & 0b11000000) != 0b10000000) {
            length += 1;
        }
        s++;
    }
    return length;
}

char* codepoint_to_utf8(unsigned int codepoint, int *sz) {
    char *s;
    if (codepoint < 0x80) {
        *sz = 1;
        s = malloc(sizeof(char));
        *s = codepoint;
    } else if (codepoint < 0x800) {
        *sz = 2;
        s = malloc(sizeof(char) * 2);
        *(s + 1) = 0b10000000 | (codepoint & 0b00111111);
        *s = 0b11000000 | ((codepoint >> 6) & 0b00011111);
    } else if (codepoint < 0x10000) {
        *sz = 3;
        s = malloc(sizeof(char) * 3);
        *(s + 2) = 0b10000000 | (codepoint & 0b00111111);
        *(s + 1) = 0b10000000 | ((codepoint >> 6) & 0b00111111);
        *s = 0b11100000 | ((codepoint >> 12) & 0b00001111);
    } else {
        *sz = 4;
        s = malloc(sizeof(char) * 4);
        *(s + 3) = 0b10000000 | (codepoint & 0b00111111);
        *(s + 2) = 0b10000000 | ((codepoint >> 6) & 0b00111111);
        *(s + 1) = 0b10000000 | ((codepoint >> 12) & 0b00111111);
        *s = 0b11110000 | ((codepoint >> 18) & 0b00000111);
    }
    return s;
}

int get_tail_length(char c) {
    int length = 0;
    if ((c & 0b11111000) == 0b11110000) {
        length = 3;
    } else if ((c & 0b11110000) == 0b11100000) {
        length = 2;
    } else if ((c & 0b11100000) == 0b11000000) {
        length = 1;
    }
    return length;
}

char* utf8_substr(char* s, int start, int length) {
    int curr_pos = 0;
    int byte_count = 0;
    int offset = 0;
    char *new_s;

    while (curr_pos < start && *s) {
        if ((*s & 0b11000000) != 0b10000000) {
            curr_pos += 1;
        }
        s += (get_tail_length(*s) + 1);
    }

    curr_pos = 0;
    while (curr_pos < length && *s) {
        if ((*s & 0b11000000) != 0b10000000) {
            curr_pos += 1;
        }
        s++;
        byte_count++;
    }

    if (curr_pos > 0) {
        offset = get_tail_length(*(s - 1));

        new_s = malloc(sizeof(char) * (byte_count + offset + 1));
        memcpy(new_s, s - byte_count, byte_count + offset);
        new_s[byte_count + offset] = '\0';
    } else {
        new_s = NULL;
    }
    return new_s;
}

int utf8_to_codepoint(char *s) {
    int length = 0;
    int codepoint = 0;

    if ((*s & 0b11111000) == 0b11110000) {
        length = 4;
        codepoint = *s & 0b111;
    } else if ((*s & 0b11110000) == 0b11100000) {
        length = 3;
        codepoint = *s & 0b1111;
    } else if ((*s & 0b11100000) == 0b11000000) {
        length = 2;
        codepoint = *s & 0b11111;
    } else {
        length = 1;
        codepoint = *s;
    }
    for (int i = 1; i < length; i++) {
        s++;
        codepoint <<= 6;
        codepoint = codepoint | (*s & 0b00111111);
    }
    return codepoint;
}

int main() {
    /*
    char *content = read_file("/home/rmb122/temp/example.txt");
    printf("%d", utf8_strlen(content));

    free(content);
     */

    printf("%d\n", utf8_strlen("ä¸€äºŒä¸‰å››äº”å…­ä¸€äºŒä¸‰å››äº”å…­1234"));

    char *s;
    int sz;

    s = codepoint_to_utf8(21834, &sz);
    printf("%.*s\n", sz, s);
    free(s);

    s = utf8_substr("ä¸€2ä¸‰å››5å…­7å…«9", 1, 1);
    if (s) {
        printf("%s\n", s);
    } else {
        printf("%s", "null");
    }
    free(s);

    printf("%d\n", utf8_to_codepoint("äº”"));
    return 0;
}
```

## UTF-16

è¯´å®è¯, æˆ‘è§‰å¾— UTF-16 å·²ç»å¯ä»¥è¢«æ‰”è¿›å†å²çš„åƒåœ¾æ¡¶, ç„¶è€Œ `Windows` è¿˜ä¾ç„¶ä½¿ç”¨ 233.  
ä»–æœ¬èº«æ˜¯ä¸ºäº†ä¿è¯å›ºå®šé•¿åº¦è€Œè®¾è®¡çš„, å› ä¸ºä¸¤ä¸ªå­—èŠ‚ 256*256, å¯ä»¥è¡¨ç¤º 65536 ç§å­—ç¬¦,  
åœ¨ä»¥å‰ unicode æ”¶å½•å­—ç¬¦æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹æ˜¯å®Œå…¨å¤Ÿçš„, è¿™æ ·æ¯ä¸ªå­—ç¬¦éƒ½ä¿å­˜ä¸ºä¸¤ä¸ªå­—èŠ‚é•¿,  
å¯ä»¥èŠ‚çœè¿ç®—, è™½ç„¶æµªè´¹äº†æŒºå¤šçš„ç©ºé—´, ä½†æ˜¯ç¡®å®å¾ˆæ–¹ä¾¿.  

ç„¶è€Œç°åœ¨ä¸Šé¢çš„ç½‘ç«™ä¸Šçœ‹åˆ°,  unicode æ”¶å½•çš„å­—ç¬¦æ—©å·²è¶…è¿‡äº† 65536 ä¸ª, ä¹Ÿå°±æ„å‘³ç€ç ç‚¹è¶…è¿‡äº† `0xFFFF`.  
è¿™é‡Œä»¥ `ğ ` è¿™ä¸ªå­—ç¬¦ä¸ºä¾‹  
```python
>>> "å•Š".encode('utf-16be')
b'UJ'
>>> "ğ ".encode('utf-16be')
b'\xd8\x00\xdf\xa0'
```
å¯ä»¥çœ‹åˆ°, å®é™…ä¸Šä¿å­˜è¿™ä¸ªå­—ç¬¦ç”¨äº†å››ä¸ªå­—èŠ‚, è€Œä¸æ˜¯ä¸¤ä¸ª. å†å²çš„å‘å±•ä½¿å¾— UTF-16 å”¯ä¸€çš„å¥½å¤„å·²ç»è¡ç„¶æ— å­˜.  
è€Œä¸”ä¸ºäº†ä¿å­˜å¤§ç«¯å°ç«¯çš„é¢å¤–ä¿¡æ¯, è¿˜ç”¨äº† `BOM` è¿™ç§ä¸‘é™‹çš„è®¾è®¡, å¸Œæœ› `Windows` ä¹Ÿèƒ½æ—©ç‚¹æ·˜æ±°æ‰ UTF-16 æŠŠ 233.  
åŸºäºä»¥ä¸ŠåŸå› , çœŸæ­£çš„ UTF-**16** åº”è¯¥æ˜¯ [UCS-2](https://en.wikipedia.org/wiki/Universal_Coded_Character_Set#Encoding_forms), ç°åœ¨çš„ UTF-16 åè€Œæœ‰ç‚¹ä¸ä¼¦ä¸ç±», æ—¢ç„¶å·²ç»æ˜¯å˜é•¿ç¼–ç äº†, ä¸ºä»€ä¹ˆä¸ç”¨æ›´èŠ‚çœç©ºé—´çš„ UTF-8 å‘¢?

## GBK

è¿™ä¸ªæ˜¯æˆ‘å›½è‡ªåˆ›çš„ç¼–ç æ ‡å‡†, ä¼˜ç‚¹éå¸¸æ˜æ˜¾, èŠ‚çœç©ºé—´, ç›¸å½“äºç¼©å°ç‰ˆçš„ UTF-8 (å½“ç„¶ç”¨çš„ç ç‚¹è¡¨å’Œå…·ä½“å®ç°è·Ÿ unicode ä¸åŒ),  
å› ä¸ºå®ƒåªéœ€è¦è¡¨è¾¾ ASCII + æ±‰å­—çš„å­—ç¬¦ç©ºé—´å°±å¤Ÿäº†. å½“ç„¶ç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾, ä¸èƒ½è¡¨è¾¾ ASCII + æ±‰å­—ä¹‹å¤–çš„å­—ç¬¦, ä¹Ÿå°±æ³¨å®šåªèƒ½åœ¨ä¸­å›½ä½¿ç”¨,  
æ— æ³•å›½é™…åŒ–, è€Œä¸”å®é™…ä¸Šå¾ˆå¤šå›½å®¶éƒ½æœ‰ä¸€å¥—è‡ªåˆ›å­—ç¬¦é›†, ä¾‹å¦‚ big5, shift-jis ç­‰ç­‰, è¿™æ›´ä¿ƒè¿›äº† unicode çš„è¯ç”Ÿ. 

## GBK å®½å­—èŠ‚æ³¨å…¥

è¯´åˆ° gbk, é‚£å°±ä¸èƒ½ä¸æåˆ°ç»å…¸çš„ gbk å®½å­—èŠ‚æ³¨å…¥, å®ƒå¯ä»¥å°† php addslashes å‡½æ•°è½¬ä¹‰åå¼•å·å‰çš„åæ–œæ **åƒæ‰**, å¯¼è‡´æœ¬è¯¥è½¬ä¹‰æ‰çš„å•å¼•å·åˆè¢«æš´éœ²å‡ºæ¥.  
è€Œåæ–œæ èƒ½è¢«åƒæ‰çš„åŸå› æ¥è‡ªäºéƒ¨åˆ†å­—ç¬¦é›† (æ¯”å¦‚ gbk), çš„å¤šå­—èŠ‚ç¼–ç è¡¨ç¤ºä¸­æ˜¯å…è®¸å­˜åœ¨ 0x00 - 0x7f å­˜åœ¨çš„, è¿™å¯¼è‡´ä¾‹å¦‚ç»å…¸ payload `é‹` è¿™ä¸ªå­—åœ¨ gbk ç¼–ç ä¸‹ä¸º `b"\xdf\\"`, å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªå­—èŠ‚æ­£æ˜¯åæ–œæ .  
è¿™ç§æƒ…å†µåœ¨ utf8 ä¸­å°±ä¸å­˜åœ¨, å› ä¸º utf8 æ ‡å‡†å·²ç»è§„å®šäº†åœ¨å¤šå­—èŠ‚ç¼–ç çš„æƒ…å†µä¸‹, é™¤äº†ç¬¬ä¸€ä½çš„å­—èŠ‚åœ¨äºŒè¿›åˆ¶ä¸‹éƒ½æ˜¯ä»¥ 10 å¼€å¤´çš„, ä¹Ÿå°±æ˜¯åœ¨ [0x80, 0xbf] ä¹‹ä¸­, ä¿è¯äº†åªè¦å‡ºç°äº†äºŒè¿›åˆ¶ä¸‹é 10 å¼€å¤´çš„å­—èŠ‚, ä¸€å®šæ˜¯æ–°çš„å­—ç¬¦.  

å¦‚ä¸Šé¢æ‰€è¯´, å› ä¸ºéƒ¨åˆ†å­—ç¬¦é›†çš„å¤šå­—èŠ‚ç¼–ç ä¸­å…è®¸ 0x00 - 0x7f å­˜åœ¨, mysql å®é™…ä¸Šä¼šå¯¹å®¢æˆ·ç«¯ä¼ å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œè§£ç  (å¯¹åº” `SET NAMES charset`) åå†ç¼–ç å­˜å‚¨æ¥é¿å…è§£æè¯­æ³•æ—¶çš„æ··æ·†.  
ä¾‹å¦‚ä»¥ `CREATE TABLE test_gbk (id int AUTO_INCREMENT PRIMARY KEY, note VARCHAR(1024)) CHARACTER SET gbk` åˆ›å»ºä¸€ä¸ªè¡¨  

```
import pymysql

mysql = pymysql.connect(host='172.17.0.2', user='root', password='root', database='data')

mysql.set_charset('gbk')
cursor = mysql.cursor()
cursor.execute('CREATE TABLE test_gbk (id int AUTO_INCREMENT PRIMARY KEY, note VARCHAR(1024)) CHARACTER SET gbk')
cursor.execute("insert into test_gbk(`note`) values ('ä½ å¥½');".encode('gbk'))
cursor.execute("insert into test_gbk(`note`) values ('ä½ å¥½');".encode('utf8'))
cursor.close()
mysql.commit()

mysql.set_charset('utf8')
cursor = mysql.cursor()
cursor.execute("insert into test_gbk(`note`) values ('ä½ å¥½');".encode('utf8'))
cursor.close()
mysql.commit()

cursor = mysql.cursor()
cursor.execute('select * from test_gbk');
ret = cursor.fetchall()
print(ret)
```

ç¬¬ä¸€æ¬¡åœ¨æŒ‡å®š gbk ç¼–ç ä¸‹åˆ†åˆ«ä»¥ gbk, utf8 ç¼–ç å†™å…¥ `ä½ å¥½`, ç¬¬äºŒæ¬¡åœ¨æŒ‡å®š utf8 ç¼–ç ä¸‹ä»¥ utf8 ç¼–ç å†™å…¥ `ä½ å¥½`, æœ€åæŸ¥è¯¢è¡¨é‡Œçš„æ•°æ®. æŸ¥è¯¢è¿”å›çš„ç»“æœä¸º `((1, 'ä½ å¥½'), (2, 'æµ£çŠ²ã‚½'), (3, 'ä½ å¥½'))`. ç¬¬ä¸€è¡Œå’Œç¬¬ä¸‰è¡Œçš„ `ä½ å¥½` ä¸å‡ºæ„å¤–, ç¬¬äºŒè¡Œå‡ºç° `æµ£çŠ²ã‚½` çš„åŸå› å°±æ¥è‡ªäºä¸Šé¢æåˆ°çš„ mysql çš„ç¼–è§£ç è¿‡ç¨‹.  
å¯ä»¥åœ¨ python ä¸­è¾“å…¥ `'ä½ å¥½'.encode('utf8').decode('gbk')`, è¿”å›çš„ç»“æœæ­£æ˜¯ `æµ£çŠ²ã‚½`, å¯ä»¥è¯´æ˜ mysql æœåŠ¡ç«¯å®é™…ä¸Šæ˜¯ä»¥ gbk è§£ç äº† utf8 ç¼–ç åçš„äºŒè¿›åˆ¶è¡¨ç¤º `\xe4\xbd\xa0\xe5\xa5\xbd`, è€Œè¿™åˆæ°å¥½åœ¨ gbk ä¸­ä¸º `æµ£çŠ²ã‚½`.
å¦å¤–, ä¹Ÿå¯ä»¥é€šè¿‡æµé‡æ¥è¯æ˜, å®¢æˆ·ç«¯å¹¶æ²¡æœ‰åšå¤šä½™çš„æ­¥éª¤, æ˜¯æŒ‰ç…§ encode åç»“æœç›´æ¥å‘é€çš„  
![](https://s2.loli.net/2022/08/13/Nz5HLrZfGUPIYge.png#center)

è€Œå¯¹äºå­˜å‚¨, æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹æ•°æ®åº“æ–‡ä»¶è¿›è¡Œ xxd æ¥ç¡®è®¤  
![](https://s2.loli.net/2022/08/13/Z6FLKQyPaJGfzV1.png#center)
å¯ä»¥çœ‹åˆ°å‡ºç°äº†ä¸¤æ¬¡ `ä½ å¥½` ä¸€æ¬¡ `æµ£çŠ²ã‚½`, å¯ä»¥ç¡®å®šä¸ç®¡å®¢æˆ·ç«¯çš„ç¼–ç æ˜¯å¦‚ä½•, mysql ä»ç„¶æ˜¯æŒ‰ç…§åˆ›å»ºè¡¨æ—¶æ‰€æŒ‡å®šçš„ gbk å­˜å‚¨çš„, è¿™ä¹Ÿå¯¼è‡´äº† gbk æ³¨å…¥å…¶å®åªä¸å®¢æˆ·ç«¯ç¼–ç æœ‰å…³, è€Œä¸ mysql è¡¨ä¸­çš„ç¼–ç è®¾ç½®æ˜¯æ— å…³çš„, å°±ç®—æ˜¯ `utf8mb4` ä¹Ÿä¸€æ ·å¯ä»¥æ³¨å…¥.  

è¯´å›æ³¨å…¥, php å¸¸è§çš„ `addslashes` åœ¨è¿™ç§æƒ…å†µä¸‹å½“ç„¶æ— èƒ½ä¸ºäº†, è¿™ä¸ªå‡½æ•°æ²¡æœ‰è€ƒè™‘ä¹Ÿæ— æ³•å¯¹ gbk ç¼–ç çš„è¿™ç§ç‰¹æ®Šæƒ…å†µè¿›è¡Œå¤„ç†, å®ƒåœ¨è®¾è®¡ä¹‹åˆå°±æ˜¯é€å­—èŠ‚æœç´¢ç‰¹æ®Šå­—ç¬¦å¹¶è½¬ä¹‰çš„.  
```php
php > echo bin2hex(addslashes("\xdf'"));
df5c27
```
åœ¨è¿™ç§æƒ…å†µä¸‹, æ­£ç¡®çš„è½¬ä¹‰åº”è¯¥æ˜¯å°†ä¸¤ä¸ªå­—ç¬¦éƒ½è½¬ä¹‰æˆ–è€…éƒ½ä¸è½¬ä¹‰, å› ä¸º `b"\xdf'"` æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ— æ•ˆçš„ gbk ç¼–ç , æ˜¯æ²¡æœ‰å¯¹åº”çš„å­—ç¬¦çš„, åŠ å…¥åæ–œæ åè€Œè®©å®ƒå˜æˆäº†ä¸€ä¸ªåˆæ³•çš„å­—ç¬¦, è¿˜è®©å¤šå‡ºæ¥çš„å¼•å·äº§ç”Ÿäº†æ³¨å…¥, `addslashes` å¯ä»¥è¯´æ˜¯å¸®äº†å€’å¿™.  
```goat
           addslashes                decode('gbk')
b"\xdf'" -------------> b"\xdf\\'" ----------------> "é‹'"
```

è€Œå¯¹ç¼–ç¨‹è€…æ¥è¯´, å¯ä»¥ä½¿ç”¨ `mysqli::set_charset` + `mysqli::real_escape_string` æ¥å¯¹ä»˜è¿™ç§æƒ…å†µ (å½“ç„¶é¢„ç¼–è¯‘æ›´å¥½), ä¾‹å­å¦‚ä¸‹  
```php
php > $conn = mysqli_connect('172.17.0.2', 'root', 'root');
php > $conn->set_charset('gbk');
php > echo bin2hex($conn->real_escape_string("\xdf'"));
5cdf5c27
```
æ³¨æ„ `$conn->query("SET NAMES 'gbk'");` æ˜¯ä¸èƒ½è®© `mysqli::real_escape_string` æ­£å¸¸å·¥ä½œçš„, å¿…é¡»ä½¿ç”¨ `mysqli::set_charset` æ‰è¡Œ. è€Œè½¬ä¹‰æ–¹é¢ mysqli é€‰æ‹©äº†æ›´ä¿é™©çš„åšæ³•, å°†ä¸¤ä¸ªå­—ç¬¦éƒ½è¿›è¡Œäº†è½¬ä¹‰, è€Œä¸”æ¯”èµ·ä¸è½¬ä¹‰åœ¨ç¼–ç¨‹ä¸Šåº”è¯¥ä¹Ÿæ›´å®¹æ˜“å®ç°å§, å¯ä»¥çœ‹åˆ°å°±ç®—æ˜¯å•ä¸ª `\xdf` ä¹Ÿè¿›è¡Œäº†è½¬ä¹‰.  
```php
php > echo bin2hex($conn->real_escape_string("\xdf"));
5cdf
```

è€Œæ¼æ´çš„äº§ç”Ÿæ¡ä»¶å¿…é¡»æ˜¯è¿™æ ·
```php
$conn = mysqli_connect('172.17.0.2', 'root', 'root');
$conn->query("SET NAMES 'gbk'");
$id = $conn->real_escape_string($_GET['id']);
$ret = $conn->query("SELECT * FROM data.test_gbk WHERE id='$id';");
var_dump($ret->fetch_all());
```
è€Œä¸”å¦‚æœæ²¡æœ‰ä½¿ç”¨ `mysqli::set_charset` å°±ç®—æ˜¯ `mysqli::real_escape_string` ä¹Ÿæ˜¯æ— æ³•é¿å…æ³¨å…¥çš„, `addslashes` å°±æ›´ä¸ç”¨è¯´äº†. ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ `$conn->query("SET NAMES 'gbk'");` ä¹Ÿæ˜¯å¿…é¡»çš„, å¦åˆ™åœ¨ mysql ä¾§, ä¼šè®¤ä¸º `"\xdf"` ä¼šè®¤ä¸ºæ˜¯ä¸€ä¸ªå­—ç¬¦è€Œä¸æ˜¯ `"\xdf\\"`, å¯¼è‡´åæ–œæ åˆç”Ÿæ•ˆäº†.
æœ€å, åŒæ ·çš„æ¼æ´åœ¨ big5 å’Œ shiftjis ä¸Šä¹Ÿæ˜¯å­˜åœ¨çš„, åœ¨ big5 ä¸‹ `"\xdf\\"` å¯¹åº”çš„å­—ç¬¦ä¸º `ç¶…`, ä½†æ˜¯åœ¨ shiftjis å°±ä¸èƒ½ç›´æ¥ç…§æ¬äº†, `"\xdf"` åœ¨ shiftjis ä¸‹å¯¹åº” `ï¾Ÿ`, å› æ­¤ç¬¬ä¸€ä¸ªå­—ç¬¦éœ€è¦ç¨å¾® fuzz ä¸€ä¸‹ `[(bytes([i]) + b'\\').decode('gbk','ignore') for i in range(256)]`, è¿™é‡Œéšä¾¿æŒ‘å‡ºæ¥ä¸€ä¸ª `"\x97\\"`, åœ¨ `shiftjis` ä¸‹å¯¹åº” `äºˆ`.
```python
>>> b'\xdf\\'.decode('big5')
'ç¶…'
>>> b'\xdf\''.decode('shiftjis')
"ï¾Ÿ'"
>>> b'\x97\\'.decode('shiftjis')
'äºˆ'
```

æµ‹è¯•ä¹Ÿæ˜¯èƒ½æˆåŠŸçš„
```php
$ php -a
Interactive shell

php > $conn = mysqli_connect('172.17.0.2', 'root', 'root');
$conn->query("SET NAMES 'big5'");
$id = $conn->real_escape_string("\xdf' or 1=1 -- 1");
$ret = $conn->query("SELECT * FROM data.test_gbk WHERE id='$id';");
var_dump($ret->fetch_all());
array(7) {
  [0]=>
  array(2) {
    [0]=>
    string(1) "1"
    [1]=>
    string(4) "An"
  }
  [1]=>
  array(2) {
....

php > $conn = mysqli_connect('172.17.0.2', 'root', 'root');
$conn->query("SET NAMES 'sjis'");
$id = $conn->real_escape_string("\x97' or 1=1 -- 1");
$ret = $conn->query("SELECT * FROM data.test_gbk WHERE id='$id';");
var_dump($ret->fetch_all());
array(7) {
  [0]=>
  array(2) {
    [0]=>
    string(1) "1"
    [1]=>
    string(3) "?D"
  }
  [1]=>
  array(2) {
....
```

## é”™è¯¯ä½¿ç”¨ iconv å¯¼è‡´çš„æ³¨å…¥

æœ€æ—©å‡ºå¤„åº”è¯¥æ˜¯ https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html å‘ç°, æ–‡ä¸­ç»™å‡ºäº†ä¸¤ç§ä¾‹å­, åˆ†åˆ«æ˜¯ `iconv('utf-8', 'gbk', $input)` å’Œ `iconv('gbk', 'utf-8', $input)`  

å…ˆæ¥çœ‹ `iconv('utf-8', 'gbk', $input)`,
åœ¨è¿™ç§æƒ…å†µä¸‹, ä¸æ™®é€š gbk æ³¨å…¥ä¸åŒ, ä¸èƒ½è®¾ç½® `$conn->query("SET NAMES 'gbk'");`. è€Œæ˜¯è¦ `$conn->query("SET NAMES 'binary'");`, å› ä¸ºæˆ‘æµ‹è¯•ä½¿ç”¨çš„æ˜¯ docker, é»˜è®¤æ˜¯ latin1 å­—ç¬¦é›†, è·Ÿ binary æ²¡æœ‰å¤ªå¤§å·®åˆ«, å°±ä¸è®¾ç½®äº†.  
ä»£ç ä¾‹å­å¦‚ä¸‹:
```php
$conn = mysqli_connect('172.17.0.2', 'root', 'root');
$id = iconv('utf-8', 'gbk', addslashes($_GET['id']));
$ret = $conn->query("SELECT * FROM data.test_gbk WHERE id='$id';");
var_dump($ret->fetch_all());
```
å¯ä»¥çœ‹åˆ°ä¼šå°†è¾“å…¥ `addslashes` å `iconv`, è¿™é‡Œèƒ½æ³¨å…¥çš„åŸå› æ°å¥½ä¸ä¸Šé¢ç›¸å, è¿™é‡Œ gbk é€ æˆçš„ç»“æœæ˜¯**å**å‡ºæ¥ä¸€ä¸ªåæ–œæ è€Œä¸æ˜¯**åƒ**æ‰, æ•´ä¸ªæµç¨‹å¦‚ä¸‹:

```goat
                      encode('utf8')                                    addslashes
  "é‹' or 1=1 -- 1" ------------------> b"\xe9\x81\x8b' or 1=1 -- 1" -----------------.
                                                                                      |
                           iconv('utf-8', 'gbk')                                      |
b"\xdf\\\\' or 1=1 -- 1" <----------------------- b"\xe9\x81\x8b\\' or 1=1 -- 1" <---'
```
æ¯”è¾ƒé‡è¦çš„æ˜¯åœ¨ iconv è¿‡ç¨‹ä¸­ `é‹` ä» utf8 è½¬æ¢åˆ° gbk çš„æƒ…å†µä¸‹, ç”±äºå…¶ç¬¬äºŒä¸ªå­—èŠ‚ä¸ºåæ–œæ . è€Œåœ¨ mysql çš„ binary ç¼–ç ä¸‹ `"\xdf"` è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå­—ç¬¦,è¿™ `é‹` çš„ç¬¬äºŒä¸ªå­—èŠ‚çš„åæ–œæ å®é™…ä¸Šè½¬ä¹‰äº† addslashes å¼•å…¥çš„åæ–œæ , å¯¼è‡´äº†æ³¨å…¥. å¦å¤–è¿™é‡Œä¸èƒ½è®¾ç½® `$conn->query("SET NAMES 'gbk'");` æˆ–è€… `$conn->set_charset('gbk');` çš„åŸå› æ˜¯åœ¨è®¾ç½®ä¹‹å mysql ä¼šä»¥ gbk è§£ç , å¯¼è‡´ `"\xdf\\"` è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå­—ç¬¦, ä»è€Œæ— æ³•ç”¨åæ–œæ è½¬ä¹‰åæ–œæ .

ç„¶åæ˜¯ `iconv('gbk', 'utf-8', $input)`, è¿™ç§æƒ…å†µå…¶å®ä¸ç”¨å¤ªå¤šä»‹ç» 2333, å…¶å®è·Ÿä¸€å¼€å§‹**åƒ**å­—ç¬¦çš„æƒ…å†µå·®ä¸å¤š, ä¸è¿‡æ˜¯æŠŠæœ¬æ¥åº”è¯¥ç”± mysql åƒæ‰çš„å­—ç¬¦ææ—©åœ¨ iconv æ—¶å°±è¢«åƒæ‰äº†.
```php
$conn = mysqli_connect('172.17.0.2', 'root', 'root');
$id = iconv('gbk', 'utf-8', addslashes($_GET['id']));
$ret = $conn->query("SELECT * FROM data.test_gbk WHERE id='$id';");
var_dump($ret->fetch_all());
```
æ•´ä¸ªæµç¨‹å¦‚ä¸‹:
```goat
                         addslashes                           iconv('gbk', 'utf-8')
  b"\xdf' or 1=1 -- 1" -------------> b"\xdf\\' or 1=1 -- 1" -----------------------.
                                                                                     |
                                                                                     |
                                                   b"\xe9\x81\x8b' or 1=1 -- 1" <---'
```

è€Œä¸” mysql çš„è§£ç é²æ£’æ€§éå¸¸å¼º, å¦‚æœè®¾ç½®äº† `$conn->query("SET NAMES 'gbk'");`, å‰ä¸¤ä¸ªå­—èŠ‚ä¼šè¢«è§£ç ä¸º `b'\xe9\x81'.decode('gbk') -> 'é–¬'`, è€Œåé¢ä¸¤ä¸ªå­—èŠ‚ä¸­, ä¼šè®¤ä¸º `"x8b'"` ä¸­çš„ `"\x8b"` æ˜¯æ— æ•ˆçš„, ç›´æ¥è·³è¿‡å¹¶ä½¿ç”¨åé¢çš„å•å¼•å·é—­åˆå­—ç¬¦ä¸². çœ‹äº†ä¸‹ gbk, big5, shiftjis çš„ç¼–ç è§„èŒƒ, å®é™…ä¸Šç¬¬äºŒå­—èŠ‚çš„ç¼–ç èŒƒå›´éƒ½æ˜¯ä» 0x40 å¼€å§‹çš„, è€Œå•å¼•å·æ˜¯ 0x27, åŒå¼•å·æ˜¯ 0x22, è‡ªç„¶éƒ½å¯ä»¥ç›´æ¥ç¡®å®šä¸ä¼šæ˜¯ä¸€ä¸ªåˆæ³•å­—ç¬¦. æ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ `$conn->query("SET NAMES 'gbk'");` æˆ–è€… `$conn->set_charset('gbk');` è®¾ä¸è®¾ç½®å°±æ— æ‰€è°“äº†, éƒ½æ˜¯ä¸€æ ·çš„.
