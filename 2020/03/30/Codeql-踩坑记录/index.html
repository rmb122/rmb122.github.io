<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Codeql 踩坑记录 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="安装
入口: https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html
下载地址: https://github.com/github/codeql-cli-binaries/releases
license: https://securitylab.github.com/tools/codeql/license"><meta property="og:image" content><meta property="og:title" content="Codeql 踩坑记录"><meta property="og:description" content="安装
入口: https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html
下载地址: https://github.com/github/codeql-cli-binaries/releases
license: https://securitylab.github.com/tools/codeql/license"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2020/03/30/Codeql-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-30T23:24:40+00:00"><meta property="article:modified_time" content="2020-03-30T23:24:40+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Codeql 踩坑记录"><meta name=twitter:description content="安装
入口: https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html
下载地址: https://github.com/github/codeql-cli-binaries/releases
license: https://securitylab.github.com/tools/codeql/license"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.21410c161c7e5bcadc5a4eccf49ce5a024e0e8fc19babbd534cfe87972f5ee51.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/about>关于</a>&nbsp;
<a href=/links>友链</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Codeql 踩坑记录</h1><div class=meta>发表于 2020 年 3 月 30 日</div></div><section class=body><h2 id=安装>安装</h2><p>入口: <a href=https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html>https://help.semmle.com/codeql/codeql-cli/procedures/get-started.html</a><br>下载地址: <a href=https://github.com/github/codeql-cli-binaries/releases>https://github.com/github/codeql-cli-binaries/releases</a><br>license: <a href=https://securitylab.github.com/tools/codeql/license>https://securitylab.github.com/tools/codeql/license</a></p><p>license 里面有写:</p><p>Further, except (and only to the extent) permitted by applicable law or applicable third-party license, you will not (and have no right to):</p><p>work around any technical limitations in the Software that only allow you to use it in certain ways;
<strong>reverse engineer</strong>, decompile or disassemble the Software;
remove, minimize, block, or modify any notices of GitHub or its suppliers in the Software;
use the Software in any way that is against the law; or
share, publish, distribute or lend the Software, provide or make available the Software as a hosted solution (whether on a standalone basis or combined, incorporated or integrated with other software or services) for others to use, or transfer the Software or these Terms to any third party.</p><p>GitHub CodeQL can only be used on codebases that are released under an OSI-approved open source license, or to perform academic research. It can&rsquo;t be used to generate CodeQL databases for or during automated analysis, continuous integration or continuous delivery, whether as part of normal software engineering processes or otherwise. For these uses, contact the sales team.</p><p>大概意思就是: 主程序是闭源的, 但是检测规则是开源的, 其中一些 <a href=https://github.com/github/codeql-go>extractor</a> 也开源了, 当然其实 java 写的未混淆, 跟开源差不多.<br>用于学术研究或者检测开源项目都随便使用, 但是拿来商业等操作, 就需要购买商业 license.</p><p>主程序就在 tools/codeql.jar, 也没做混淆啥的. 还是挺良心的.<br>安装包里面自带了运行环境和支持语言的 extractor (甚至自带 java 运行环境), 开箱即用.</p><h2 id=测试>测试</h2><p>先写个测试用例看看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4># $ cat flask-example/app.py</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> flask
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> subprocess
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app<span style=color:#ff79c6>.</span>run()
</span></span></code></pre></div><p>建立 database</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/home/rmb122/repos/codeql/codeql database create codeql-database --language<span style=color:#ff79c6>=</span>python --source-root flask-example
</span></span></code></pre></div><p>然后就喜闻乐见的出错了 233</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-v data-lang=v><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>00</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>8</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#ff79c6>module</span> <span style=color:#8be9fd;font-style:italic>_lzma</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>22</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>3</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>cryptography</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>hazmat</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>backends</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>openssl</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dsa</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>765</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>5</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>cryptography</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>hazmat</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>primitives</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>serialization</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>ssh</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>404</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>1</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>cryptography</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>hazmat</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>backends</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>openssl</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>encode_asn1</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>1572</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>ERROR</span>] [<span style=color:#bd93f9>1</span>] <span style=color:#50fa7b>Failed</span> <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>extract</span> <span style=color:#ff79c6>module</span> <span style=color:#8be9fd;font-style:italic>_decimal</span>: <span style=color:#8be9fd;font-style:italic>libmpdec</span>.<span style=color:#8be9fd;font-style:italic>so</span><span style=color:#bd93f9>.2</span>: <span style=color:#8be9fd;font-style:italic>cannot</span> <span style=color:#8be9fd;font-style:italic>open</span> <span style=color:#8be9fd;font-style:italic>shared</span> <span style=color:#8be9fd;font-style:italic>object</span> <span style=color:#8be9fd;font-style:italic>file</span>: <span style=color:#50fa7b>No</span> <span style=color:#8be9fd;font-style:italic>such</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>or</span> <span style=color:#8be9fd;font-style:italic>directory</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>TRACEBACK</span>] [<span style=color:#bd93f9>1</span>] <span style=color:#f1fa8c>&#34;semmle/worker.py&#34;</span>, <span style=color:#8be9fd;font-style:italic>line</span> <span style=color:#bd93f9>220</span>, <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>_extract_loop</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>TRACEBACK</span>] [<span style=color:#bd93f9>1</span>] <span style=color:#f1fa8c>&#34;semmle/extractors/super_extractor.py&#34;</span>, <span style=color:#8be9fd;font-style:italic>line</span> <span style=color:#bd93f9>47</span>, <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>process</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>TRACEBACK</span>] [<span style=color:#bd93f9>1</span>] <span style=color:#f1fa8c>&#34;semmle/extractors/builtin_extractor.py&#34;</span>, <span style=color:#8be9fd;font-style:italic>line</span> <span style=color:#bd93f9>14</span>, <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>process</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>5</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#ff79c6>module</span> <span style=color:#8be9fd;font-style:italic>_io</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>50</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>8</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>cryptography</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>hazmat</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>primitives</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>asymmetric</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dh</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>373</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>1</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>werkzeug</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>wrappers</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>cors</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>85</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>7</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>argparse</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>5850</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>2</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>tarfile</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>5602</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>3</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>werkzeug</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>debug</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>repr</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>611</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>01</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>INFO</span>] [<span style=color:#bd93f9>4</span>] <span style=color:#50fa7b>Extracted</span> <span style=color:#8be9fd;font-style:italic>file</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>jinja2</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>parser</span>.<span style=color:#8be9fd;font-style:italic>py</span> <span style=color:#ff79c6>in</span> <span style=color:#bd93f9>2626</span><span style=color:#8be9fd;font-style:italic>ms</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>03</span>] [<span style=color:#8be9fd;font-style:italic>build</span>] [<span style=color:#50fa7b>ERROR</span>] <span style=color:#50fa7b>Process</span> <span style=color:#bd93f9>6</span> <span style=color:#8be9fd;font-style:italic>timed</span> <span style=color:#8be9fd;font-style:italic>out</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#8be9fd;font-style:italic>build</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>err</span>] <span style=color:#50fa7b>Traceback</span> (<span style=color:#8be9fd;font-style:italic>most</span> <span style=color:#8be9fd;font-style:italic>recent</span> <span style=color:#8be9fd;font-style:italic>call</span> <span style=color:#8be9fd;font-style:italic>last</span>):
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#8be9fd;font-style:italic>build</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>err</span>]   <span style=color:#50fa7b>File</span> <span style=color:#f1fa8c>&#34;/home/rmb122/repos/codeql/python/tools/index.py&#34;</span>, <span style=color:#8be9fd;font-style:italic>line</span> <span style=color:#bd93f9>19</span>, <span style=color:#ff79c6>in</span> &lt;<span style=color:#ff79c6>module</span>&gt;
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#8be9fd;font-style:italic>build</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>err</span>]     <span style=color:#8be9fd;font-style:italic>buildtools</span>.<span style=color:#8be9fd;font-style:italic>index</span>.<span style=color:#50fa7b>main</span>()
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#8be9fd;font-style:italic>build</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>err</span>]   <span style=color:#50fa7b>File</span> <span style=color:#f1fa8c>&#34;/home/rmb122/repos/codeql/python/tools/python3src.zip/buildtools/index.py&#34;</span>, <span style=color:#8be9fd;font-style:italic>line</span> <span style=color:#bd93f9>110</span>, <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>main</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#8be9fd;font-style:italic>build</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>err</span>]   <span style=color:#50fa7b>File</span> <span style=color:#f1fa8c>&#34;/usr/lib/python3.8/subprocess.py&#34;</span>, <span style=color:#8be9fd;font-style:italic>line</span> <span style=color:#bd93f9>364</span>, <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>check_call</span>
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#8be9fd;font-style:italic>build</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>err</span>]     <span style=color:#8be9fd;font-style:italic>raise</span> <span style=color:#50fa7b>CalledProcessError</span>(<span style=color:#8be9fd;font-style:italic>retcode</span>, <span style=color:#8be9fd;font-style:italic>cmd</span>)
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#8be9fd;font-style:italic>build</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>err</span>] <span style=color:#8be9fd;font-style:italic>subprocess</span>.<span style=color:#50fa7b>CalledProcessError</span>: <span style=color:#50fa7b>Command</span> <span style=color:#f1fa8c>&#39;[&#39;</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>-</span><span style=color:#50fa7b>S</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>home</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>rmb122</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>repos</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>codeql</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>tools</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python_tracer</span>.<span style=color:#8be9fd;font-style:italic>py</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>v</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>z</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#8be9fd;font-style:italic>all</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>-</span><span style=color:#f1fa8c>c</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>home</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>rmb122</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>temp</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>codeql</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>codeql</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>database</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>working</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>trap_cache</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>p</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>usr</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>lib</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python3</span><span style=color:#bd93f9>.8</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>site</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>packages</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>-</span><span style=color:#50fa7b>R</span><span style=color:#f1fa8c>&#39;, &#39;</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>home</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>rmb122</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>temp</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>codeql</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>flask</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>example</span><span style=color:#f1fa8c>&#39;]&#39;</span> <span style=color:#8be9fd;font-style:italic>returned</span> <span style=color:#8be9fd;font-style:italic>non</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>zero</span> <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#8be9fd;font-style:italic>status</span> <span style=color:#bd93f9>1</span>.
</span></span><span style=display:flex><span>[<span style=color:#50fa7b>2020</span>-<span style=color:#50fa7b>03</span>-<span style=color:#50fa7b>30</span> <span style=color:#50fa7b>17</span>:<span style=color:#f1fa8c>45</span>:<span style=color:#f1fa8c>04</span>] [<span style=color:#50fa7b>ERROR</span>] <span style=color:#50fa7b>Spawned</span> <span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>exited</span> <span style=color:#8be9fd;font-style:italic>abnormally</span> (<span style=color:#8be9fd;font-style:italic>code</span> <span style=color:#bd93f9>1</span>; <span style=color:#8be9fd;font-style:italic>tried</span> <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>run</span>: [<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>home</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>rmb122</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>repos</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>codeql</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>tools</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>autobuild</span>.<span style=color:#8be9fd;font-style:italic>sh</span>])
</span></span><span style=display:flex><span><span style=color:#50fa7b>A</span> <span style=color:#8be9fd;font-style:italic>fatal</span> <span style=color:#8be9fd>error</span> <span style=color:#8be9fd;font-style:italic>occurred</span>: <span style=color:#50fa7b>Exit</span> <span style=color:#8be9fd;font-style:italic>status</span> <span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>from</span> <span style=color:#8be9fd;font-style:italic>command</span>: [<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>home</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>rmb122</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>repos</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>codeql</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>python</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>tools</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>autobuild</span>.<span style=color:#8be9fd;font-style:italic>sh</span>]
</span></span></code></pre></div><p>问题出在这<br>Failed to extract module _decimal: libmpdec.so.2: cannot open shared object file: No such file or directory</p><p>repl 里面运行一下, 果然也是如此</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ python
</span></span><span style=display:flex><span>Python 3.8.2 (default, Feb 26 2020, 22:21:03) 
</span></span><span style=display:flex><span>[GCC 9.2.1 20200130] on linux
</span></span><span style=display:flex><span>Type &#34;help&#34;, &#34;copyright&#34;, &#34;credits&#34; or &#34;license&#34; for more information.
</span></span><span style=display:flex><span>&gt;&gt;&gt; import _decimal
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span>  File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt;
</span></span><span style=display:flex><span>ImportError: libmpdec.so.2: cannot open shared object file: No such file or directory
</span></span><span style=display:flex><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>神奇的居然没有装, pacman -S mpdecimal 装一个就完事了.<br>这应该只扫了用到的库, 没有扫全部的库, 挺快的, 点个赞.</p><p>接下来真正开始写 ql<br>教程在这:<br><a href=https://help.semmle.com/QL/learn-ql/>https://help.semmle.com/QL/learn-ql/</a><br><a href=https://help.semmle.com/QL/ql-handbook/>https://help.semmle.com/QL/ql-handbook/</a><br><a href=https://help.semmle.com/qldoc/>https://help.semmle.com/qldoc/</a></p><p>官方的规则库:<br><a href=https://github.com/Semmle/ql.git>https://github.com/Semmle/ql.git</a><br>学习一哈.</p><p>官方自带的 ql 里面有预先定义好一些数据结构, 直接 import python 就能用了, .qll 是 library, .ql 是真正的查询语句.<br>正式运行还需要定义一个 qlpack.yml, 意义跟 pom.xml 差不多吧, 定义包名和依赖<br><a href=https://help.semmle.com/codeql/codeql-cli/reference/qlpack-overview.html>https://help.semmle.com/codeql/codeql-cli/reference/qlpack-overview.html</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>name</span>: com-rmb122-test
</span></span><span style=display:flex><span><span style=color:#ff79c6>version</span>: <span style=color:#bd93f9>0.0.1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>libraryPathDependencies</span>: codeql-python
</span></span><span style=display:flex><span><span style=color:#ff79c6>extractor</span>: python
</span></span></code></pre></div><p>在 <code>$HOME/.config/codeql/config</code> 里面设置 ql repo 的路径, 这样才能被 import, 感觉现在这种手动配置好蛋痛 =.= 感觉跟自己编译 cpp 一样链接一堆库<br>而且文档 u1s1, 挺乱的, 不过刚被 github 收购, 可以理解, 希望之后能更方便一点.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>--search-path &lt;path to ql repo&gt;
</span></span></code></pre></div><p>注意不要写成 <code>--search-path=&lt;path to ql repo></code>, 不然识别不了&mldr; 坑了我好久.</p><p>然后保存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import python
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>from Function f
</span></span><span style=display:flex><span>where f.getName().matches(&#34;index&#34;)
</span></span><span style=display:flex><span>select f, &#34;This is a function called get...&#34;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/home/rmb122/repos/codeql/codeql query run test.ql -d ../codeql-database/
</span></span></code></pre></div><p>就能运行了, 或者用 vscode 插件也行, 更方便一点. 可以找到我们写的 index 函数.</p><h2 id=简单的-taint-demo>简单的 Taint demo</h2><p>照着自带的示例, 可以依葫芦画瓢, 写出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import python
</span></span><span style=display:flex><span>import semmle.python.security.TaintTracking
</span></span><span style=display:flex><span>import semmle.python.web.flask.Request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class SystemCommandExecution extends TaintTracking::Configuration {
</span></span><span style=display:flex><span>    SystemCommandExecution() { this = &#34;SystemCommandExecution Tracking&#34; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override predicate isSource(DataFlow::Node src, TaintKind kind) {
</span></span><span style=display:flex><span>        exists(FlaskRequestArgs taintSrc |
</span></span><span style=display:flex><span>            src.asCfgNode() = taintSrc 
</span></span><span style=display:flex><span>            // and taintSrc.isSourceOf(kind) 这里示例用的 get, 不是 dickstring 这个 kind, 所以需要注释掉
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override predicate isSink(DataFlow::Node sink, TaintKind kind) {
</span></span><span style=display:flex><span>        exists(
</span></span><span style=display:flex><span>            CallNode call |
</span></span><span style=display:flex><span>            call.getFunction().pointsTo(Value::named(&#34;subprocess.check_output&#34;)) and
</span></span><span style=display:flex><span>            call.getArg(0) = sink.asCfgNode()
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>from SystemCommandExecution config, DataFlow::Node src, DataFlow::Node sink
</span></span><span style=display:flex><span>where config.hasSimpleFlow(src, sink)
</span></span><span style=display:flex><span>select sink, src
</span></span></code></pre></div><p>再检测一下威力加强版示例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> flask
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> subprocess
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> subprocess <span style=color:#ff79c6>import</span> check_output
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> flask <span style=color:#ff79c6>import</span> request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index2&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index2</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index3&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index3</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index4&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index4</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index5&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index5</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index6&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index6</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index7&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index7</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app<span style=color:#ff79c6>.</span>run()
</span></span></code></pre></div><p>结果是 index, index5-7 都能检测出来, 2-4 没检测出来. 原因应该是 spilt 的结果没被 taint 到.<br>将 isSink 替换成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>override predicate isSink(DataFlow::Node sink, TaintKind kind) {
</span></span><span style=display:flex><span>        &#34;1&#34; = &#34;1&#34;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也可以观察到 <code>tmp = tmp.split('|')</code> 的返回值是没被 select 到的. 也可以验证这一点.</p><p>这样测试下来, 感觉最大的问题还是编写起来测试太费劲了, 就算只更改一点内容, 编译和运行都要 1~2 分钟才能完成. 对 database 也是同理, 只能重新生成, 没有更新的选项, 浪费了大量的时间.<br>剩下的可能是自带的 taint tracking 不够给力, 还好官方给了相关的接口 (DataFlowExtension), 需要自己研究下添加额外 taint 的方法, 至少 split 肯定是得加进去的吧.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/codeql>codeql</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 @rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>