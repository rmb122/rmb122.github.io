<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>JEP-290 相关学习 - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="官网介绍: https://openjdk.java.net/jeps/290
JEP = JDK Enhancement Proposals
就是等于改进提案.  python 也有类似的, 就是大家喜闻乐见的 PEP (Python Enhancement Proposals)."><meta property="og:image" content><meta property="og:title" content="JEP-290 相关学习"><meta property="og:description" content="官网介绍: https://openjdk.java.net/jeps/290
JEP = JDK Enhancement Proposals
就是等于改进提案.  python 也有类似的, 就是大家喜闻乐见的 PEP (Python Enhancement Proposals)."><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2020/03/22/JEP-290-%E7%9B%B8%E5%85%B3%E5%AD%A6%E4%B9%A0/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-22T16:09:59+00:00"><meta property="article:modified_time" content="2020-03-22T16:09:59+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="JEP-290 相关学习"><meta name=twitter:description content="官网介绍: https://openjdk.java.net/jeps/290
JEP = JDK Enhancement Proposals
就是等于改进提案.  python 也有类似的, 就是大家喜闻乐见的 PEP (Python Enhancement Proposals)."><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.44723f0f128be8581db7d2296d67fc2ff9ac8798b7ab31fed9c48fabd3c611d2.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.1690097eb84906d3c2f59ea4d255ed949c48a3fcef56a7482d95a745048a8661.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>JEP-290 相关学习</h1><div class=meta>发表于 2020 年 3 月 22 日</div></div><section class=body><p>官网介绍: <a href=https://openjdk.java.net/jeps/290>https://openjdk.java.net/jeps/290</a></p><p>JEP = JDK Enhancement Proposals<br>就是等于改进提案. python 也有类似的, 就是大家喜闻乐见的 PEP (Python Enhancement Proposals).</p><p>在这个 290 里面, 干的事情就是新增一个自带的反序列化过滤器.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Security guidelines consistently require that input from external sources be validated before use. The filter mechanism will allow object-serialization clients to more easily validate their inputs, and exported RMI objects to validate invocation arguments.
</span></span></code></pre></div><p>jdk 源码里面可以看到</p><p>src/java.rmi/share/classes/sun/rmi/registry/RegistryImpl.java</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> ObjectInputFilter registryFilter <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>            AccessController<span style=color:#ff79c6>.</span><span style=color:#50fa7b>doPrivileged</span><span style=color:#ff79c6>((</span>PrivilegedAction<span style=color:#ff79c6>&lt;</span>ObjectInputFilter<span style=color:#ff79c6>&gt;)</span>RegistryImpl<span style=color:#ff79c6>::</span>initRegistryFilter<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>    * Initialize the registryFilter from the security properties or system property; if any
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>    * @return an ObjectInputFilter, or null
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>    */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>@SuppressWarnings<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;deprecation&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> ObjectInputFilter <span style=color:#50fa7b>initRegistryFilter</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ObjectInputFilter filter <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    String props <span style=color:#ff79c6>=</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getProperty</span><span style=color:#ff79c6>(</span>REGISTRY_FILTER_PROPNAME<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>props <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        props <span style=color:#ff79c6>=</span> Security<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getProperty</span><span style=color:#ff79c6>(</span>REGISTRY_FILTER_PROPNAME<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>props <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        filter <span style=color:#ff79c6>=</span> SharedSecrets<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getJavaObjectInputFilterAccess</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>createFilter2</span><span style=color:#ff79c6>(</span>props<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        Log regLog <span style=color:#ff79c6>=</span> Log<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getLog</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;sun.rmi.registry&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;registry&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>-</span>1<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>regLog<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isLoggable</span><span style=color:#ff79c6>(</span>Log<span style=color:#ff79c6>.</span><span style=color:#50fa7b>BRIEF</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            regLog<span style=color:#ff79c6>.</span><span style=color:#50fa7b>log</span><span style=color:#ff79c6>(</span>Log<span style=color:#ff79c6>.</span><span style=color:#50fa7b>BRIEF</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;registryFilter = &#34;</span> <span style=color:#ff79c6>+</span> filter<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>return</span> filter<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span> <span style=color:#50fa7b>registryFilter</span><span style=color:#ff79c6>(</span>ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>FilterInfo</span> filterInfo<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>registryFilter <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span> status <span style=color:#ff79c6>=</span> registryFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>checkInput</span><span style=color:#ff79c6>(</span>filterInfo<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>status <span style=color:#ff79c6>!=</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>UNDECIDED</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            <span style=color:#6272a4>// The Registry filter can override the built-in white-list
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>return</span> status<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>filterInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>depth</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;</span> REGISTRY_MAX_DEPTH<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        <span style=color:#ff79c6>return</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>REJECTED</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    Class<span style=color:#ff79c6>&lt;?&gt;</span> clazz <span style=color:#ff79c6>=</span> filterInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>serialClass</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isArray</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>            <span style=color:#6272a4>// Arrays are REJECTED only if they exceed the limit
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>filterInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>arrayLength</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;=</span> 0 <span style=color:#ff79c6>&amp;&amp;</span> filterInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>arrayLength</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;</span> REGISTRY_MAX_ARRAY_SIZE<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>                <span style=color:#ff79c6>?</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>REJECTED</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>                <span style=color:#ff79c6>:</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>UNDECIDED</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span> <span style=color:#ff79c6>==</span> clazz
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>                <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Number</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>                <span style=color:#ff79c6>||</span> Remote<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>                <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>reflect</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Proxy</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                <span style=color:#ff79c6>||</span> UnicastRef<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>                <span style=color:#ff79c6>||</span> RMIClientSocketFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>                <span style=color:#ff79c6>||</span> RMIServerSocketFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>                <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rmi</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>activation</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ActivationID</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>                <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rmi</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>server</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>UID</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>            <span style=color:#ff79c6>return</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ALLOWED</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>            <span style=color:#ff79c6>return</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>REJECTED</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#ff79c6>return</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>UNDECIDED</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>RegistryImpl</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> port<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>        <span style=color:#8be9fd;font-style:italic>throws</span> RemoteException
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>port <span style=color:#ff79c6>==</span> Registry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>REGISTRY_PORT</span> <span style=color:#ff79c6>&amp;&amp;</span> System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSecurityManager</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>        <span style=color:#6272a4>// grant permission for default port only.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>            AccessController<span style=color:#ff79c6>.</span><span style=color:#50fa7b>doPrivileged</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> PrivilegedExceptionAction<span style=color:#ff79c6>&lt;</span>Void<span style=color:#ff79c6>&gt;()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>                <span style=color:#8be9fd;font-style:italic>public</span> Void <span style=color:#50fa7b>run</span><span style=color:#ff79c6>()</span> <span style=color:#8be9fd;font-style:italic>throws</span> RemoteException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>                    LiveRef lref <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LiveRef<span style=color:#ff79c6>(</span>id<span style=color:#ff79c6>,</span> port<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>                    setup<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> UnicastServerRef<span style=color:#ff79c6>(</span>lref<span style=color:#ff79c6>,</span> RegistryImpl<span style=color:#ff79c6>::</span>registryFilter<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>                    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>            <span style=color:#ff79c6>},</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> SocketPermission<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;localhost:&#34;</span><span style=color:#ff79c6>+</span>port<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;listen,accept&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>PrivilegedActionException pae<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>(</span>RemoteException<span style=color:#ff79c6>)</span>pae<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getException</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>        LiveRef lref <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LiveRef<span style=color:#ff79c6>(</span>id<span style=color:#ff79c6>,</span> port<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>        setup<span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> UnicastServerRef<span style=color:#ff79c6>(</span>lref<span style=color:#ff79c6>,</span> RegistryImpl<span style=color:#ff79c6>::</span>registryFilter<span style=color:#ff79c6>));</span> <span style=color:#6272a4>// 这一行, 将过滤器传给了 UnicastServerRef
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>注意有两个 registryFilter, 一个是静态函数, 一个是静态对象.<br>静态对象在类定义时被赋值, registryFilter 静态函数在函数体里面调用了 registryFilter 对象来检查.</p><p>其中 registryFilter 对象来源应该就是从 JEP 290 加的属性 jdk.serialFilter 里面读取过滤规则. 因为 ObjectInputStream 里面只能设置一个 ObjectInputFilter. 如果要自定义, 就只能先读取原来的, 然后在自己新定义的 filter 中调用原来的. 否则原来的规则就没了, 所以底下的就是 RMI 真正新增的过滤.</p><p>可以看到过滤规则主要就是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span> <span style=color:#ff79c6>==</span> clazz
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Number</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#ff79c6>||</span> Remote<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>lang</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>reflect</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>Proxy</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>||</span> UnicastRef<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>||</span> RMIClientSocketFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ff79c6>||</span> RMIServerSocketFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rmi</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>activation</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ActivationID</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>||</span> java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rmi</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>server</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>UID</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>isAssignableFrom</span><span style=color:#ff79c6>(</span>clazz<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>return</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ALLOWED</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>return</span> ObjectInputFilter<span style=color:#ff79c6>.</span><span style=color:#50fa7b>Status</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>REJECTED</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>检查了反序列化对象是否是 <code>String</code> 或者是 <code>Number</code>, <code>Remote</code>, <code>Proxy</code>, <code>UnicastRef</code>, <code>RMIClientSocketFactory</code>, <code>RMIServerSocketFactory</code>, <code>ActivationID</code>, <code>UID</code> 的子类, 否则就拒绝反序列化, 可以看到是白名单, 还是挺靠谱的. 也确实效果挺好, 能 bypass 的也只有 JRMPClient.</p><p>不过这只对 bind 等操作生效. 因为在真正调用远程对象时, 处理函数调用的是 Service Provider 而不是 Registry. Registry 是 RegistryImpl, 而 Service Provider 得到的是 RegistryImpl_Stub. 其在默认情况下是没有 filter 的,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>RegistryImpl_Stub</span><span style=color:#ff79c6>(</span>java<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rmi</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>server</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>RemoteRef</span> ref<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#8be9fd;font-style:italic>super</span><span style=color:#ff79c6>(</span>ref<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这也是 JEP-290 能被绕过的原因. 其只对 Registry 做了防护, 而 Service Provider 也会进行反序列化, 却没有做反序列化的防护.<br>当然, Service Provider 确实无法进行白名单层面的防护, 因为函数的参数类型是各种各样的, 估计也是出于对兼容性和黑名单被绕过的考虑, 也没进行黑名单防护.</p><h2 id=参考链接>参考链接</h2><p>[1] <a href=https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/>https://mogwailabs.de/blog/2019/03/attacking-java-rmi-services-after-jep-290/</a><br>[2] <a href=http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/>http://www.codersec.net/2018/09/%E4%B8%80%E6%AC%A1%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91rmi%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B7%B1%E6%80%9D/</a></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/java>java</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 © rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>