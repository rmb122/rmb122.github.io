<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Codeql 踩坑记录 (二) - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="首先需要解决的就是上次留下的问题, 添加自定义的 taint track.
在自带的 tests 中就有示例, 可以参考 ql/python/ql/test/library-tests/taint/extensions/ExtensionsLib.qll"><meta property="og:image" content><meta property="og:title" content="Codeql 踩坑记录 (二)"><meta property="og:description" content="首先需要解决的就是上次留下的问题, 添加自定义的 taint track.
在自带的 tests 中就有示例, 可以参考 ql/python/ql/test/library-tests/taint/extensions/ExtensionsLib.qll"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2020/03/31/Codeql-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95-%E4%BA%8C/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-31T23:06:52+00:00"><meta property="article:modified_time" content="2020-03-31T23:06:52+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Codeql 踩坑记录 (二)"><meta name=twitter:description content="首先需要解决的就是上次留下的问题, 添加自定义的 taint track.
在自带的 tests 中就有示例, 可以参考 ql/python/ql/test/library-tests/taint/extensions/ExtensionsLib.qll"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.21410c161c7e5bcadc5a4eccf49ce5a024e0e8fc19babbd534cfe87972f5ee51.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/about>关于</a>&nbsp;
<a href=/links>友链</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Codeql 踩坑记录 (二)</h1><div class=meta>发表于 2020 年 3 月 31 日</div></div><section class=body><p>首先需要解决的就是上次留下的问题, 添加自定义的 taint track.<br>在自带的 tests 中就有示例, 可以参考 <code>ql/python/ql/test/library-tests/taint/extensions/ExtensionsLib.qll</code></p><p>最后大概是这样</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>class AnyCallFlow extends DataFlowExtension::DataFlowNode {
</span></span><span style=display:flex><span>     AnyCallFlow() {
</span></span><span style=display:flex><span>         exists(CallNode call |
</span></span><span style=display:flex><span>            call.getFunction().(AttrNode).getObject() = this
</span></span><span style=display:flex><span>         )
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>     override ControlFlowNode getASuccessorNode() {
</span></span><span style=display:flex><span>         result.(CallNode).getFunction().(AttrNode).getObject() = this
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>意思就是如果一个 funccall 中是 val.attr 类型的, 且 val 被 taint 了, 那么整个 CallNode 都将被 taint.<br>然后加到 Configuration 里面就可以了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>override predicate isExtension(TaintTracking::Extension extension) {
</span></span><span style=display:flex><span>    extension instanceof AnyCallFlow
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>此时就能够识别 split 等方法了, 不过这样的结果肯定是增加误报率了.<br>这里插一句, 最近在看南大开在 B 站上的软件分析课程, 讲的挺好, 这里其实就是 soundness completeness 问题, 在安全这一块还是 soundness 好一点, 所以最好还是牺牲虚警率来提高漏报率吧.</p><p>最后按照官方库的方法, 封装一下, 最后的结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import python
</span></span><span style=display:flex><span>import semmle.python.security.TaintTracking
</span></span><span style=display:flex><span>import semmle.python.web.flask.Request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class AnyCallFlow extends DataFlowExtension::DataFlowNode {
</span></span><span style=display:flex><span>     AnyCallFlow() {
</span></span><span style=display:flex><span>         exists(CallNode call |
</span></span><span style=display:flex><span>            call.getFunction().(AttrNode).getObject() = this
</span></span><span style=display:flex><span>         )
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>     override ControlFlowNode getASuccessorNode() {
</span></span><span style=display:flex><span>         result.(CallNode).getFunction().(AttrNode).getObject() = this
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class DangerousFunctionArg0 extends Value {
</span></span><span style=display:flex><span>    DangerousFunctionArg0() {
</span></span><span style=display:flex><span>        exists(Value val |
</span></span><span style=display:flex><span>            this = val and
</span></span><span style=display:flex><span>            (
</span></span><span style=display:flex><span>                val = Value::named(&#34;subprocess.check_output&#34;) or
</span></span><span style=display:flex><span>                val = Value::named(&#34;os.system&#34;) or 
</span></span><span style=display:flex><span>                val = Value::named(&#34;os.popen&#34;) or 
</span></span><span style=display:flex><span>                val = Value::named(&#34;eval&#34;) or 
</span></span><span style=display:flex><span>                val = Value::named(&#34;exec&#34;) or
</span></span><span style=display:flex><span>                val = Value::named(&#34;flask.render_template_string&#34;)
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class DangerousFunctionArg0Sink extends TaintSink {
</span></span><span style=display:flex><span>    DangerousFunctionArg0Sink() {
</span></span><span style=display:flex><span>        exists(
</span></span><span style=display:flex><span>            CallNode call, DangerousFunctionArg0 dangerous_func |
</span></span><span style=display:flex><span>            call.getFunction().pointsTo(dangerous_func) and
</span></span><span style=display:flex><span>            call.getArg(0) = this
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override predicate sinks(TaintKind taint) {
</span></span><span style=display:flex><span>        any()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class SystemCommandExecution extends TaintTracking::Configuration {
</span></span><span style=display:flex><span>    SystemCommandExecution() { this = &#34;SystemCommandExecution Tracking&#34; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override predicate isSource(DataFlow::Node src, TaintKind kind) {
</span></span><span style=display:flex><span>        src.asCfgNode() instanceof FlaskRequestArgs
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override predicate isSink(DataFlow::Node sink, TaintKind kind) {
</span></span><span style=display:flex><span>        sink.asCfgNode() instanceof DangerousFunctionArg0Sink
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override predicate isExtension(TaintTracking::Extension extension) {
</span></span><span style=display:flex><span>         extension instanceof AnyCallFlow
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>from SystemCommandExecution config, DataFlow::Node src, DataFlow::Node sink
</span></span><span style=display:flex><span>where config.hasSimpleFlow(src, sink)
</span></span><span style=display:flex><span>select sink, src
</span></span></code></pre></div><p>检测以下 sample, 一共 10 个漏洞, 都能找到, 还是不错的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> flask
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> subprocess
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> subprocess <span style=color:#ff79c6>import</span> check_output
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> flask <span style=color:#ff79c6>import</span> request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>passby</span>(i):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> i<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;123&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index2&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index2</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index3&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index3</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index4&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index4</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp<span style=color:#ff79c6>.</span>split(<span style=color:#f1fa8c>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index5&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index5</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> flask<span style=color:#ff79c6>.</span>request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index6&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index6</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> subprocess<span style=color:#ff79c6>.</span>check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index7&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index7</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> check_output(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index8&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index8</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> flask<span style=color:#ff79c6>.</span>render_template_string(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index9&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index9</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> flask<span style=color:#ff79c6>.</span>render_template_string(<span style=color:#f1fa8c>&#34;asd&#34;</span>, t<span style=color:#ff79c6>=</span>tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index10&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index10</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> passby(tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> flask<span style=color:#ff79c6>.</span>render_template_string(<span style=color:#f1fa8c>&#34;asd&#34;</span>, t<span style=color:#ff79c6>=</span>tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index11&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index11</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> passby(tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>eval</span>(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/index12&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>index12</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>args<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#39;c&#39;</span>, <span style=color:#f1fa8c>&#39;ls&#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#ff79c6>=</span> passby(tmp <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;i&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> flask<span style=color:#ff79c6>.</span>render_template_string(tmp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app<span style=color:#ff79c6>.</span>run()
</span></span></code></pre></div><p>最后, 其实感觉编写最大的难点还是需要思维的转换, 这种声明式的语言像 SQL 一样, 是告诉程序, 希望在 xx 地方是 xx, 且 xx 里面的 yy 是 zz 这样.<br>需要一点时间来转变思维吧, 之后是这个官方 python 接口库感觉本身写的就有点乱 (逃, 各种类似的对象, 又是 PythonFunctionCall, CallNode 的, 同样的目的可以由一万种不同的方式达成. 感觉对新手确实不太友好. 等后续文档跟上吧.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/codeql>codeql</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 @rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>